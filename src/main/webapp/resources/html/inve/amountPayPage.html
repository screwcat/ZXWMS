<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>业务管理>理财管理>金额管理>金额支付</title>

<link href="../../css/app.css" type="text/css" rel="stylesheet" />
<link href="../../css/zx-all.css" rel="stylesheet" type="text/css" />
<script language="Javascript" src="../../js/zx-all.js"> </script>
<style>
.textright{
text-align:right;
}
.textleft{
text-align:left;
}
/*input_tb css*/
.input_tb_new{
/*border:1px solid #dfdfdf;*/
width:100%;
margin-bottom:10px;
}
.input_tb_new a{
color:#056aff;
text-decoration:none;
font-weight:normal;
}
.input_tb_new td{
height:35px;
line-height:25px;
/*border-bottom:1px dashed #d5d5d5;*/
padding-top:3px;
}
.input_tb_new .tr_title td{
background-color:#f5f8ff;
padding-left:16px;
font-weight:bold;
height:30px;
line-height:30px;
/*border-bottom:1px solid #dfdfdf;*/
}
.input_tb_new .tr_last td{
border-bottom:0;
}
.input_tb_new .title{
text-align:right;
}
.input_tb_new .subtitle{
text-align:left;
background-color:#d2e1fd;
border-top:1px solid #fff;
/*border-left:1px solid #fff;*/
}

.input_tb_new .tr_btn_input td{
background-color:#fbfbfb;
/*border-top:1px solid #dbdbdb;*/
/*height:40px;*/

}

.title_tb{
background-color:#f5f8ff;
padding-left:16px;
font-weight:bold;
height:30px;
line-height:30px;
/*border:1px solid #dfdfdf;8/
border-bottom:0;
}
.title_tb .title_txt{
float:left;
}
.title_tb .title_btn{
float:right;
margin-top:2px;
font-weight:normal;
}
.input_tb_new td {
    /*border-bottom: 1px dashed #D5D5D5;*/
    height: 35px;
    line-height: 25px;
    padding-top: 3px;
}

.data_tb td{
height:30px;
line-height:24px;
padding-left:10px;
border-bottom:1px dashed #e3e4e6;
text-align:left;
}
</style>

<script type="text/javascript">
var wms_inve_transa_id='';//主键

var grid_divwt1;
var grid_divwt1_data={};

var grid_divwt2;
var grid_divwt2_data={};

var grid_divwt3;
var grid_divwt3_data={};

//添加表格的对象变量
var grid_divwt4;
var grid_divwt4_data={};
var selectBillDialog;

var this_inve_trance_data;//上单信息
var this_inve_trance_pro_data;//上单产品信息

var all_pos_data;//所有pos机

var json={};//获取收益卡信息

var fileArr = [];//上传附件列表

var cktype;//查看页面使用
var update="";//update=1  标识着是审核退回 上单修改页面 iframe 嵌套的页面 可以修改 在save方法中做了处理

var taskId;
var data_type_name=830;//上传附件 大类id
var filecheck=823;//上传附件 pos机小票必填

var remainTime;

var bankCardInfos;


$(function(){
	wms_inve_transa_id = $.query.get('wms_inve_transa_id');
	update = $.query.get('update');
	wms_inve_transa_prod_id=$.query.get('wms_inve_transa_prod_id');
	cktype=$.query.get('cktype');
	taskId=$.query.get('taskId');
	//上单审核退回修改页面使用-隐藏暂存提交取消按钮
	if(update=='1'){
		$(".pop-footer5").css("display","none");
	}
	var jezfTitle='';
    var resMap = globalUtil.syncGetJson('/inve/wmsinvetransainfo.do',{
        'wms_inve_transa_id':wms_inve_transa_id
        },'GET');
    this_inve_trance_data = resMap.wmsInveTransa;
    
    remainTime = resMap.remainTime;
    
    this_inve_trance_pro_data = globalUtil.syncGetJson('/inve/wmsinvetransaprodinfobypkforjegl.do',{
        'wms_inve_transa_id':wms_inve_transa_id
        },'GET');
    jezfTitle="客户：<font color='blue'>"+this_inve_trance_data.cus_name+"</font>，用于购买理财产品     &lt;<font color='blue'>"+this_inve_trance_pro_data.category_name+"</font>&gt;的投资金额(<font color='blue'>"+parseInt(this_inve_trance_pro_data.org_product_account)/10000+"万元</font>)已支付？";
    
    var remainHours;
    var remainMinutes;
    var remainSeconds;
    $("#divpart1").html($("#divpart1").html()+jezfTitle);
    if(cktype != 'ck' && this_inve_trance_data.data_status == 2) {
    		$("#divpart1").html($("#divpart1").html() + '<span id="countdownText"><font color=red>&nbsp;&nbsp;&nbsp;&nbsp;支付倒计时:</font></span><font color=blue><span id="countdown"></span></font>');
    	    //剩余时间为0或单据已作废
    	    if(remainTime <= 0) {
    	        $('#countdown').html('单据已作废');
    	        $("#tjbtn").css("display","none");
    	        $("#zcbtn").css("display","none");
    	        $("#countdownText").css("display","none");
    	        clearInterval(t);
    	    }else{
    	    	remainHours = Math.floor(remainTime / (1000 * 60 * 60));
    	        remainMinutes = Math.floor((remainTime - remainHours * 1000 * 60 * 60) / (1000 * 60));
    	        remainSeconds = Math.floor((remainTime - remainHours * 1000 * 60 * 60 - remainMinutes * 1000 * 60) / 1000);
    	        
    	        remainHours = remainHours >= 10 ? remainHours : '0' + remainHours;
    	        remainMinutes = remainMinutes >= 10 ? remainMinutes : '0' + remainMinutes;
    	        remainSeconds = remainSeconds >= 10 ? remainSeconds : '0' + remainSeconds;
    	        $('#countdown').html(remainHours + ':' + remainMinutes + ':' + remainSeconds);
                var t = setInterval(function(){
                remainHours = Math.floor(remainTime / (1000 * 60 * 60));
                remainMinutes = Math.floor((remainTime - remainHours * 1000 * 60 * 60) / (1000 * 60));
                remainSeconds = Math.floor((remainTime - remainHours * 1000 * 60 * 60 - remainMinutes * 1000 * 60) / 1000);
                
                remainHours = remainHours >= 10 ? remainHours : '0' + remainHours;
                remainMinutes = remainMinutes >= 10 ? remainMinutes : '0' + remainMinutes;
                remainSeconds = remainSeconds >= 10 ? remainSeconds : '0' + remainSeconds;
                $('#countdown').html(remainHours + ':' + remainMinutes + ':' + remainSeconds);
                remainTime = remainTime - 1000;
                if(remainTime <= 0) {
                	//判断单据是否已支付
                	var isPayMap = globalUtil.syncGetJson('/inve/wmsinvetransainfo.do',{
               				'wms_inve_transa_id':wms_inve_transa_id
           			},'GET'); 
                	var wmsInveTransaBean = isPayMap.wmsInveTransa;
                	if(wmsInveTransaBean.data_status == 2) {//待支付
                		$('#countdown').html('单据已作废');
                	} else {
                		$('#countdown').html('单据已支付');
                	}
                	$("#tjbtn").css("display","none");
                    $("#zcbtn").css("display","none");
                    $("#countdownText").css("display","none");
                    clearInterval(t);
    	                }
    	        }, 1000);
    	    }
    }else{
    	$("#btn_div").css("display","none");
    }
	    
    //获取pos机数据
    all_pos_data=globalUtil.syncGetJson('/inve/wmsinveposwithoutpaginglistEnable.do',{
        'sortname':'wms_inve_pos_id'
    },'GET');    
    
    //获取收益卡信息
    json = globalUtil.syncGetJson('/inve/getinvetransaprodbyid.do',{
        wms_inve_transa_prod_id: wms_inve_transa_prod_id,
        sortname: 'sort_order', // 排序列名
        sortorder: 'asc' // 排序方式
    },'POST');
    if(json!=null){
        initForm(json);
    }
    if(json.wmsInveTransaProd.card_owner_name==""||json.wmsInveTransaProd.card_owner_name==null){
    	$("#card_owner_name").val(this_inve_trance_data.cus_name);
    }
    //判断客户收益卡信息 初始化/有值不可编辑处理
    if(json.wmsInveTransaProd.bank_of_deposit_pro != null && json.wmsInveTransaProd.bank_of_deposit_city != null) {
            init_bank_of_deposit_pro(json.wmsInveTransaProd);
      } else {
            init_bank_of_deposit_pro();
      }
    //初始化支付方式
    if(this_inve_trance_data.pay_type !=null || this_inve_trance_data.pay_type !=''){
    	initGrid(this_inve_trance_data.pay_type);
    }else {
    	initGrid();
    }
    //初始化银行卡号自动四位加空格
    init_card_no();
	if(cktype !='ck'){
		//初始化附件信息
	    init_attr();
	    //添加列表的操作按钮
	    var toolbarItemData4 = [];
	    toolbarItemData4.push({
	        text : '新增',
	        click: addRowsKHZFXX,
	        icon : 'add'
	    });
	    toolbarItemData4.push({
	        line : true
	    });
	    toolbarItemData4.push({
	        text : '删除',
	        click: deleteRowKHZFXX,
	        icon : 'delete'
	    });
	    toolbarItemData4.push({
	        line : true
	    });
	    $("#toolbar-divwt4").ligerToolBar({
	        items : toolbarItemData4
	    });
	    if(update == '1'){
	    	$("#bank_info_title").hide();
	    }else{
	    	$("#bank_info_title").show();
	    }
	}else{
		$("#bank_info_title").hide();
		$('.pop-footer5').css('display','none');
		lookpage();
		//初始化附件信息
		init_attr(cktype);
	}
	//初始化收益卡信息
	init_bank_card_info();
	
	
	$('#bank_of_deposit_pro').bind('change',function(){
		getCityData1();
	});
	
});

//初始化银行卡按钮信息
function init_bank_card_info(){
	if(update != '1'){
		var params = {
			cus_name:this_inve_trance_data.cus_name,
			id_card:this_inve_trance_data.id_card
		}
		 
		$.post(globalUtil.getTimestampUrl("/inve/getHistoryCustomerBankInfo.do"),params,
				function(json,status){
			bankCardInfos = json;
			if(json != null && json != "" && json.length > 1){
				$("input[name='is_bank_card']").eq(0).removeAttr("checked","checked"); 
				$("input[name='is_bank_card']").eq(1).attr("checked","checked");
				
				
				$("#card_owner_name").attr("readonly","readonly");
				$("#card_no").attr("readonly","readonly");
	// 			$("#bank_of_deposit_pro").attr("readonly","readonly");
	// 			$("#bank_of_deposit_city").attr("readonly","readonly");
				$.ligerui.get("bank_of_deposit_pro").set('disabled', true);
				$.ligerui.get("bank_of_deposit_city").set('disabled', true);
				$("#bank_of_deposit").attr("readonly","readonly");
				$("#bank_branch").attr("readonly","readonly");
			}else{
				$("input[name='is_bank_card']").eq(0).attr("checked","checked");
				$("input[name='is_bank_card']").eq(1).removeAttr("checked","checked");
			}
			for(var i = 0; i < json.length; i++){
				$("#bank_info").append("<option value='" + json[i].wms_inve_transa_prod_id +"'>" +json[i].bank_card_info +"</option>");
			}
		},"json"); 
	}
}

//选择银行卡信息同时为收益卡信息赋值
function changeOption(obj){
	$("#bank_of_deposit_pro").unbind("change");
	
	for(var i = 0; i < bankCardInfos.length; i++){
		if(bankCardInfos[i].wms_inve_transa_prod_id == obj.value){
			$("#card_owner_name").val(bankCardInfos[i].card_owner_name);
			$("#card_no").val(bankCardInfos[i].card_no);
			global_ligerui_extend.setComboxVal("bank_of_deposit_pro", bankCardInfos[i].bank_of_deposit_pro);
			init_bank_of_deposit_city(bankCardInfos[i].bank_of_deposit_pro, true);
			global_ligerui_extend.setComboxVal("bank_of_deposit_city", bankCardInfos[i].bank_of_deposit_city);
			$("#bank_of_deposit").val(bankCardInfos[i].bank_of_deposit);
			$("#bank_branch").val(bankCardInfos[i].bank_branch);

			$("#card_owner_name").attr("readonly","readonly");
			$("#card_no").attr("readonly","readonly");
// 			$("#bank_of_deposit_pro").attr("readonly","readonly");
// 			$("#bank_of_deposit_city").attr("readonly","readonly");
			$.ligerui.get("bank_of_deposit_pro").set('disabled', true);
			$.ligerui.get("bank_of_deposit_city").set('disabled', true);
			$("#bank_of_deposit").attr("readonly","readonly");
			$("#bank_branch").attr("readonly","readonly");
		}
	}
	
	init_card_no();
	
	$('#bank_of_deposit_pro').bind('change',function(){
		getCityData1();
	});
}

//判断选择全新银行卡和已使用银行卡按钮
function changeRadio(obj){
	
	if(obj.value == 1){
		$("#card_owner_name").val("");
		$("#card_no").val("");
		global_ligerui_extend.setComboxVal("bank_of_deposit_pro", -1);
		init_bank_of_deposit_city(-1, true);
		global_ligerui_extend.setComboxVal("bank_of_deposit_city", -1);
		$("#bank_of_deposit").val("");
		$("#bank_branch").val("");
		$("#bank_info").val("-1");
		$("#bank_info").attr("disabled", "disabled");
		
		$("#card_owner_name").removeAttr("readonly");
		$("#card_no").removeAttr("readonly");
//			$("#bank_of_deposit_pro").attr("readonly","readonly");
//			$("#bank_of_deposit_city").attr("readonly","readonly");
		$.ligerui.get("bank_of_deposit_pro").set('disabled', false);
		$.ligerui.get("bank_of_deposit_city").set('disabled', false);
		$("#bank_of_deposit").removeAttr("readonly");
		$("#bank_branch").removeAttr("readonly");
	}
	if(obj.value==2){
		$("#bank_info").removeAttr("disabled");
		
		$("#card_owner_name").attr("readonly","readonly");
		$("#card_no").attr("readonly","readonly");
//			$("#bank_of_deposit_pro").attr("readonly","readonly");
//			$("#bank_of_deposit_city").attr("readonly","readonly");
		$.ligerui.get("bank_of_deposit_pro").set('disabled', true);
		$.ligerui.get("bank_of_deposit_city").set('disabled', true);
		$("#bank_of_deposit").attr("readonly","readonly");
		$("#bank_branch").attr("readonly","readonly");
	}
	
}

//获取省
function getProvinceData() {
	return globalUtil.syncGetJson('/sysmanage/wmssysdictdatabydictidempty.do',
			{'isEmpty' : true, 'wms_sys_dict_id' : '72'},'GET');
}

//获取市
function getCityData(p_wms_sys_dict_data_id){
	return globalUtil.syncGetJson('/sysmanage/wmssysdictdatabydictidemptyc.do',
			{'isEmpty' : true, 'wms_sys_dict_id' : '73', 'p_wms_sys_dict_data_id' : p_wms_sys_dict_data_id},'GET');
}

function initGrid(pay_type) {
	//POS机信息
	//var posArr=[{"wms_inve_pos_id":'-1',"pos_code":'请选择'}];
	var posArr=[];
	for(var i=0;i<parseInt(all_pos_data.Rows.length);i++){
	  	var thid=all_pos_data.Rows[i].wms_inve_pos_id;
	  	var thval=all_pos_data.Rows[i].pos_code;
	  	posArr.push({"wms_inve_pos_id":thid,"pos_code":thval})
	}
	
	var payTypeData = [{ value_code: 1, value_meaning: '现金' },{ value_code: 2, value_meaning: '银行卡' },{ value_code: 3, value_meaning: '续单本金' }];
	
	grid_divwt4_data=globalUtil.syncGetJson('/inve/wmsinvetransaforzfinfolist.do',{
        'wms_inve_transa_id':wms_inve_transa_id,
        'sortname':'wms_inve_transa_card_id'
    },'GET');
	var updateCellIndex = 0;
	//添加表格的默认行设置以及表格的设置
	var columns4 = [{
		display: '支付方式',
		name: 'pay_type',
		resizable: false,
		width: 80,
		minWidth: 80,
		editor: { 
			type: 'select', // 该列为可编辑状态
			data: payTypeData, 
			valueField:'value_code',   //下拉框value对应的值，默认为id
			textField:'value_meaning'
		},
		render: function (rowdata, nowRowIndex, value, column) {
			var payTypeValueStr = global_ligerui_extend.gridRenderSelectedValue2(rowdata, value, column);
			if(cktype != 'ck'){
				if(grid_divwt4_data.Rows.length != 0){
					if(updateCellIndex != 0){
						updateRowKHZFXX(nowRowIndex,rowdata, payTypeValueStr);	
					}
				}else{
					updateRowKHZFXX(nowRowIndex,rowdata, payTypeValueStr);
				}
			}
			return payTypeValueStr;
		}
	},{
		display: '关联单据',
		name: 'bill_code',
		width: 160,
		minWidth: 160,
		resizable: false,
		render: function (rowdata, nowRowIndex, value, column) {
			var varluStr = "<a href='javascript:selectBill();'><img src='../../../resources/images/icons/search.gif' style='float:right;'/></a>";
			if(cktype != 'ck'){
				if(value=='0' || value == undefined){
					return "----";
				}
				if(value != ''){
					return value;
				}else{
					return varluStr;
				}
			}else{
				if(value == null || value == ''){
					return "----"
				}else{
					return value;
				}
			}
			
		} 
	},{
		display: '卡主姓名',
		name: 'card_owner_name',
		resizable: false,
		width: 80,
		minWidth: 80,
		editor: {
			type: 'text'
		}
	},{
		display: '银行账号',
		name: 'card_no',
		resizable: false,
		width: 180,
		minWidth: 180,
		editor: {
			type: 'text'
		},
		render:function(rowdata, nowRowIndex,value,column){
			if(value == null || value == "")
			{
				return "----";	
			}
			return value;
		}
	},{
		display: '省',
		name: 'bank_of_deposit_pro',
		newline: false,
		width: 100,
		minWidth: 100,
		editor: { 
			type: 'select', // 该列为可编辑状态
			data: getProvinceData(), 
			valueField:'value_code',   //下拉框value对应的值，默认为id
			textField:'value_meaning'
		},
		render: function (rowdata, nowRowIndex, value, column) {
			if(cktype == 'ck'){
				if(value ==null || value == ''){
					return '----';
				}
			}
			if(value == 0 || value == undefined){
				return "----";
			}else{
				return global_ligerui_extend.gridRenderSelectedValue2(rowdata, value, column);
			}
		}
	},{
		display: '市',
		name: 'bank_of_deposit_city',
		newline: false,
		width: 100,
		minWidth: 100,
		editor: { 
			type: 'select', // 该列为可编辑状态
			valueField:'value_code',   //下拉框value对应的值，默认为id
			textField:'value_meaning',    //下拉框text对应的值，默认为text
			ext:function(obj){
				var options;
				if(obj.bank_of_deposit_pro != "-1" && obj.bank_of_deposit_pro != "") {
					options =  {
		                	data: getCityData(obj.bank_of_deposit_pro)
		                };
				}
                return options;
           }
		},
		render: function (rowdata, nowRowIndex, value, column) {
			if(cktype == 'ck'){
				if(value ==null || value == ''){
					return '----';
				}
			}
			if(value == 0 || value == undefined){
				return "----";
			}else{
				return global_ligerui_extend.gridRenderSelectedValue3(rowdata, value, column, getCityData(rowdata.bank_of_deposit_pro));
			}
		}
	},{
		display: '开户行名称',
		name: 'bank_of_deposit_name',
		resizable: false,
		width: 130,
		minWidth: 130,
		editor: {
			type: 'text'
		},
		render:function(rowdata, nowRowIndex, value, column){
			if(value == null || value == "")
			{
				return "----";	
			}
			return value;
		}
	},{
		display: 'POS机编号',
		name: 'wms_inve_pos_id',
		resizable: false,
		width: 100,
		minWidth: 100,
		editor: { 
			type: 'select', // 该列为可编辑状态
			data: posArr, 
			valueField: 'wms_inve_pos_id', 
			textField: 'pos_code' 
		},
		render: function (rowdata, nowRowIndex, value, column) {
			if(value == 0 || value == null || value == ""){
				return "----";
			}else{
				return global_ligerui_extend.gridRenderSelectedValue(rowdata, nowRowIndex, value, column);
			}
		}
	},{
		display: '实际支付金额（元）',
		name: 'pay_account',
		resizable: false,
		width: 120,
		minWidth: 120,
		editor: {
			type: 'text'
		},
		render:function(rowdata,nowRowIndex,value,column){
			return value;
		}
	},{
		display:'赎回信息id',
		name:'wms_inve_redeem_id',
		resizable:false,
		width:10,
		minWidth:10,
		hide:1,
		render:function(rowdata,nowRowIndex,value,column){
			return value;
		}
	},{
		display:'可用金额',
		name:'redeem_amount',
		resizable:false,
		width:10,
		minWidth:10,
		hide:1,
		render:function(rowdata,nowRowIndex,value,column){
			return value;
		}
	},{
		display:'赎回本金信息id',
		name:'wms_inve_redeem_principal_detail_id',
		resizable:false,
		width:10,
		minWidth:10,
		hide:1,
		render:function(rowdata,nowRowIndex,value,column){
			return value;
		}
	},{
		display:'赎回详细信息id',
		name:'wms_inve_redeem_detail_id',
		resizable:false,
		width:10,
		minWidth:10,
		hide:1,
		render:function(rowdata,nowRowIndex,value,column){
			return value;
		}
	}
	];
	
	if(cktype == 'ck'){
		
		columns4.push({
			display:'是否到账',
			name:'is_finish',
			resizable:false,
			width:120,
			minWidth:120,
			render:function(rowdata,nowRowIndex,value,column){
				if(value==0 || value == ''){
					return "未到账";
				}
				if(value == 1){
					return "已到账";
				}
			}
		});
	}
	
	/* if(update == 1){ */
		
		columns4.push({
			display:'已经保存的值',
			name:'act_account',
			resizable:false,
			hide:1,
			width:10,
			minWidth:10,
			render:function(rowdata,nowRowIndex,value,column){
				return value;
			}
		});
	/* } */
	
	
	grid_divwt4 = $("#grid-divwt4").ligerGrid({ // maingrid为表格div所在id
		columns: columns4,
		data:grid_divwt4_data,
		rownumbers: true,
		usePager: false, // 是否分页支持，默认为true
		enabledEdit: cktype =='ck' ? false : true,
		width: '100%',
		height:100,
		heightDiff: -4,
		enabledEdit: true,
		onAfterShowData:function(data){
			if(cktype != 'ck'){
				if(grid_divwt4_data.Rows.length != 0){
					updateCellIndex=1;
				}
			}
		}
	});
	if(cktype != 'ck'){
		if(grid_divwt4_data.Rows.length==0){
			addRowsKHZFXX();
		}
	}
	if(cktype == 'ck'){
		var datas = grid_divwt4.getData();
		for(var i = 0; i < datas.length; i++){
			for(var k = 0; k <10;k++ ){
				var s = grid_divwt4.getCellObj(i,k);         	
				$(s).bind("click",function(){return false;});				
			}
		}
	}
	
}
//选择单据
function selectBill(){
	 var url = globalUtil.getHtml("../inve/selectBill.html?wms_inve_customer_id="+this_inve_trance_data.wms_inve_customer_id + "&wms_inve_transa_id="+wms_inve_transa_id+"&gridDatas="+JSON.stringify(grid_divwt4.getData()));
	 selectBillDialog=$.ligerDialog.open({
		url:url,
		title: '单据选择',
     	width: 950,
     	height: globalUtil.setDialogHeight(600),
     	onHiddenOrClose: function(){
 	 	},
     	isResize: false
	 }); 
}

//将选择的单据信息添加到客户支付信息列表中
function setCusInfoGrid(obj){
	var rowSelected = grid_divwt4.getSelectedRow();
	grid_divwt4.updateCell('bill_code', obj[0].bill_code, rowSelected); 
	grid_divwt4.updateCell('card_no', '----', rowSelected);
	grid_divwt4.updateCell('bank_of_deposit_pro', 0, rowSelected);
	grid_divwt4.updateCell('bank_of_deposit_city', 0, rowSelected);
	grid_divwt4.updateCell('bank_of_deposit_name', '----', rowSelected);
	grid_divwt4.updateCell('wms_inve_pos_id', 0, rowSelected);
	grid_divwt4.updateCell('pay_account', obj[0].redeem_amount, rowSelected);
	grid_divwt4.updateCell('wms_inve_redeem_id', obj[0].wms_inve_redeem_id, rowSelected);
	grid_divwt4.updateCell('redeem_amount', obj[0].redeem_amount, rowSelected);
	grid_divwt4.updateCell('wms_inve_redeem_principal_detail_id', obj[0].wms_inve_redeem_principal_detail_id, rowSelected);
	grid_divwt4.updateCell('wms_inve_redeem_detail_id', obj[0].wms_inve_redeem_detail_id, rowSelected);
	for(var i = 1; i <= obj.length - 1; i++){
		var data = {'pay_type':3,'bill_code':obj[i].bill_code,'card_owner_name':this_inve_trance_data.cus_name,'card_no':'----','bank_of_deposit_pro':'0','bank_of_deposit_city':'0','bank_of_deposit_name':'----','bank_branch':'----','wms_inve_pos_id':0,'pay_account':obj[i].redeem_amount,'wms_inve_redeem_id':obj[i].wms_inve_redeem_id,'redeem_amount':obj[i].redeem_amount,'wms_inve_redeem_principal_detail_id':obj[i].wms_inve_redeem_principal_detail_id,'wms_inve_redeem_detail_id':obj[i].wms_inve_redeem_detail_id};
		grid_divwt4.addRow(data);
	} 
}

//向客户信息列表中添加一行
function addRowsKHZFXX(){
	var manager = $("#grid-divwt4").ligerGetGridManager();
	manager.appendRow({
			'pay_type':'1',
			'bill_code':'0',
			'card_owner_name':this_inve_trance_data.cus_name,
			'card_no':'----',
			'bank_of_deposit_pro':'0',
			'bank_of_deposit_city':'0',
			'bank_of_deposit_name':'----',
			'bank_branch':'----',
			'wms_inve_pos_id':'0',
			'pay_account':'',
			'wms_inve_redeem_id':'',
			'redeem_amount':'',
			'wms_inve_redeem_principal_detail_id':'',
			'wms_inve_redeem_detail_id':''
		});
}

//从客户支付信息列表中删除一行数据
function deleteRowKHZFXX(){
	var manager = $("#grid-divwt4").ligerGetGridManager();
    var row = manager.getSelectedRow();
    if (!row) {
        globalUtil.warnMsg(globalErrorMsg['100001']); //请选择一行记录进行删除
        return;
    }
    globalUtil.confirmMsg(globalErrorMsg['100016'],
    function(yes) { //确认删除
    	if(yes){
    		flaga=true;
    		global_ligerui_extend.deleteSelectedRow(manager);
    		if(update == 1){
    			globalUtil.syncGetJson('/inve/wmsinvetransaforfreedredeembill.do',{
    		        'wms_inve_transa_id':wms_inve_transa_id,
    		        'wms_inve_redeem_principal_detail_id':row.wms_inve_redeem_principal_detail_id
    		    },'GET');
    		}
    	}
    });
   
}
//更新客户支付的列表信息
function updateRowKHZFXX(nowRowIndex,row, payTypeValueStr){
	alert();
	if(payTypeValueStr != "请选择"){
		if(payTypeValueStr == "现金"){
			grid_divwt4.updateCell('bill_code', '0', row); 
			grid_divwt4.updateCell('card_no', '----', row);
			grid_divwt4.updateCell('bank_of_deposit_pro', 0, row);
			grid_divwt4.updateCell('bank_of_deposit_city', 0, row);
			grid_divwt4.updateCell('bank_of_deposit_name', '----', row);
			grid_divwt4.updateCell('wms_inve_pos_id', 0, row);
			if(row.pay_account == null){
				grid_divwt4.updateCell('pay_account','',row);
			}
			grid_divwt4.updateCell('wms_inve_redeem_id','',row);
			grid_divwt4.updateCell('wms_inve_redeem_principal_detail_id','',row);
			grid_divwt4.updateCell('wms_inve_redeem_detail_id', '',row);
		}
		if(payTypeValueStr == "银行卡"){
			grid_divwt4.updateCell('bill_code', '0', row); 
			if(row.card_no==null || row.card_no=='----'){
				grid_divwt4.updateCell('card_no', '', row);
			}
			if(row.bank_of_deposit_pro==0){
				grid_divwt4.updateCell('bank_of_deposit_pro', -1, row);	
			}
			if(row.bank_of_deposit_city==0){
				grid_divwt4.updateCell('bank_of_deposit_city', -1, row);
			}
			if(row.bank_of_deposit_name == null || row.bank_of_deposit_name=='----'){
				grid_divwt4.updateCell('bank_of_deposit_name', '', row);
			}
			if(row.wms_inve_pos_id==0){
				grid_divwt4.updateCell('wms_inve_pos_id', -1, row);
			}
			if(row.pay_account==null){
				grid_divwt4.updateCell('pay_account','',row);
			}
			grid_divwt4.updateCell('wms_inve_redeem_id','',row);
			grid_divwt4.updateCell('wms_inve_redeem_principal_detail_id','',row);
			grid_divwt4.updateCell('wms_inve_redeem_detail_id', '',row);
		}
	   if(payTypeValueStr == "续单本金"){
			if(row.bill_code == null || row.bill_code == '0'){
				grid_divwt4.updateCell('bill_code', '', row);
			}
			grid_divwt4.updateCell('card_no', '----', row);
			grid_divwt4.updateCell('bank_of_deposit_pro', 0, row);
			grid_divwt4.updateCell('bank_of_deposit_city', 0, row);
			grid_divwt4.updateCell('bank_of_deposit_name', '----', row);
			grid_divwt4.updateCell('wms_inve_pos_id', 0, row);
			if(row.pay_account == null){
				grid_divwt4.updateCell('pay_account','',row);
			}
			if(row.wms_inve_redeem_id == null){
				grid_divwt4.updateCell('wms_inve_redeem_id','',row);
			}
			if(row.pay_account != null && row.redeem_amount!=null){
				if(row.pay_account > row.redeem_amount){
					if(update == 1){
						if(row.redeem_amount != null && row.redeem_amount !=''){
							if(row.pay_account > row.redeem_amount){
								if(row.pay_account <= row.act_account){
									grid_divwt4.updateCell('pay_account',row.pay_account,row);	
								}else{
									if(row.act_account == undefined || row.act_account==null || row.act_account==''){
										grid_divwt4.updateCell('pay_account',row.redeem_amount,row);
									}else{
										if(row.pay_account > (row.act_account+row.redeem_amount)){
											grid_divwt4.updateCell('pay_account',row.act_account+row.redeem_amount,row);
										}else{
											grid_divwt4.updateCell('pay_account',row.pay_account,row);
										}
										//grid_divwt4.updateCell('pay_account',row.act_account+row.redeem_amount,row);
									}
								}
							}else{
								grid_divwt4.updateCell('pay_account',row.pay_account,row);
							}
						}else{
							if(row.pay_account > row.act_account){
								globalUtil.warnMsg(globalErrorMsg['1400003']);
								grid_divwt4.updateCell('pay_account',row.act_account,row);
							}
						}
					}else{
						if(row.pay_account != null && row.pay_account != '' && row.redeem_amount == '0'){
							if(row.act_account != undefined && row.act_account != null && row.act_account !=''){
								if(row.pay_account > row.act_account){
									grid_divwt4.updateCell('pay_account',row.act_account,row);
								}else{
									grid_divwt4.updateCell('pay_account',row.pay_account,row);
								}
							}
						}else{
							if(row.act_account != undefined && row.act_account != null && row.act_account !=''){
								var oldAccount = parseInt(row.act_account);
								var newAccount = parseInt(row.redeem_amount);
								var resultAccount = oldAccount + newAccount;
								grid_divwt4.updateCell('pay_account',resultAccount,row);	
							}else{
								globalUtil.warnMsg(globalErrorMsg['1400003']);
								grid_divwt4.updateCell('pay_account',row.redeem_amount,row);
							}
						}
					}
					return;
				}
			}
		}
	}
}
//获取初始化值
function initForm(json){
	 $("input[type='radio']").each(function(){
		 $(this).attr("checked")=="checked"
		 if(json.wmsInveTransa.pay_type==1 && $(this).val()=='xj'){
			 $(this).attr("checked","checked");
			 $("#divpart2_1").css("display","");
             $("#divpart2_2").css("display","none");
             $("#divpart2_3").css("display","none");
		 }else if(json.wmsInveTransa.pay_type==2 && $(this).val()=='yhk'){
			 $(this).attr("checked","checked");
			 $("#divpart2_2").css("display","");
             $("#divpart2_1").css("display","none");
             $("#divpart2_3").css("display","none");
		 }else if(json.wmsInveTransa.pay_type==3 && $(this).val()=='xj&yhk'){
			 $(this).attr("checked","checked");
			 $("#divpart2_3").css("display","");
             $("#divpart2_1").css("display","none");
             $("#divpart2_2").css("display","none");
		 }
    });
	
	globalUtil.setFormVal("main_s", json.wmsInveTransaProd);
	init_bank_of_deposit_city(json.wmsInveTransaProd.bank_of_deposit_pro, true);
	global_ligerui_extend.setComboxVal("bank_of_deposit_city", json.wmsInveTransaProd.bank_of_deposit_city);
	
	$("input[name=is_allopatry]").each(function(){
        if($(this).val()==json.wmsInveTransaProd.is_allopatry){
        	$(this).attr("checked","checked");
        }
   });
}

//使页面元素不可编辑
function lookpage(){
	var cktype = $.query.get('cktype');
	if(cktype=='ck'){
		//使全部的文本框不可编辑
        $("input[type=text]").attr({
            "disabled" : "disabled"
        });
        //使全部的单选按钮不可编辑
        $("input[type=radio]").attr({
            "disabled" : "disabled"
        });
        global_ligerui_extend.disabledCombox("bank_of_deposit_pro");
        global_ligerui_extend.disabledCombox("bank_of_deposit_city");
	}
}
    var saveIdentification=false;//标记保存是否返回
	//提交金额信息
	function save(flag){
		var jsonStr={};
		var checkFlag=true;
		var checkedFlag=false;
		var jedata=getGridData(grid_divwt4);
		var hjzfje=0;//合计支付金额
		for(var i = 0; i < jedata.length;i++){
				//现金
				if(jedata[i].pay_type == 1){
					if(flag == 1){
						if(jedata[i].card_owner_name=='' || jedata[i].pay_account==''){
					   		globalUtil.warnMsg(globalErrorMsg['800203']);
					   		checkFlag=false;
					   		return;
					   	}else{
					   		if(!globalUtil.isFloat(jedata[i].pay_account)){
					   			globalUtil.warnMsg(globalErrorMsg['800206']);
					   			checkFlag=false;
					    		return;
					   		}
					   		hjzfje+=parseFloat(jedata[i].pay_account);
					   	}
					}
				}
				jsonStr.wms_inve_transa_id=wms_inve_transa_id;
		    	jsonStr.pay_type=jedata[i].pay_type;
		    	//jsonStr.cash_pay_name=jedata[0].cash_pay_name;
		    	jsonStr.pay_account=jedata[i].pay_account;
		    	jsonStr.should_pay_account=jedata[i].pay_account;
		    	jsonStr.card_owner_name=jedata[i].card_owner_name;
		    	jsonStr.act_account=jedata[i].pay_account;
			
				//银行卡
				if(jedata[i].pay_type == 2){
					if(flag == 1){
						checkedFlag=true;
					    if(jedata.length==0){
					    	 globalUtil.warnMsg(globalErrorMsg['800204']);//请填全金额支付信息！
					    	 checkFlag=false;
					    	 return;
					    }
					    if(jedata[i].card_owner_name=='' || jedata[i].pay_account==''|| jedata[i].wms_inve_pos_id==''|| jedata[i].wms_inve_pos_id=='-1'){
				    	 	globalUtil.warnMsg(globalErrorMsg['800204']);//请填全金额支付信息！
				    	 	checkFlag=false;
							return;
				    	}else {
				    	    if(!globalUtil.isFloat(jedata[i].pay_account)||parseFloat(jedata[i].pay_account)<0){
						     	globalUtil.warnMsg(globalErrorMsg['800206']);//支付金额错误，请修改！
						    	checkFlag=false;
							   	return;
					    	 }
				    		 hjzfje+=parseFloat(jedata[i].pay_account);
						}
					}
			    	jsonStr.wms_inve_transa_id=wms_inve_transa_id;
			    	jsonStr.pay_type=jedata[i].pay_type;
		    		jsonStr.pay_account=hjzfje;
				}
				//续单本金
				if(jedata[i].pay_type == 3){
					checkedFlag=true;
				    if(jedata[i].card_owner_name=='' || jedata[i].pay_account=='' || jedata[i].bill_code == ''){
				    	 globalUtil.warnMsg(globalErrorMsg['800204']);//请填全金额支付信息！
				    	 checkFlag=false;
					   	 return;
				    }else {
				    	 if(!globalUtil.isFloat(jedata[i].pay_account)||parseFloat(jedata[i].pay_account)<0){
					   		globalUtil.warnMsg(globalErrorMsg['800206']);//支付金额错误，请修改！
					   		checkFlag=false;
					    	return;
					   	 }
				    	 hjzfje+=parseFloat(jedata[i].pay_account);
					}
			    	jsonStr.wms_inve_transa_id=wms_inve_transa_id;
			    	jsonStr.pay_type=jedata[i].pay_type;
		    		jsonStr.pay_account=hjzfje;
		    		jsonStr.wms_inve_redeem_principal_detail_id=jedata[i].wms_inve_redeem_principal_detail_id;
		    		jsonStr.wms_inve_redeem_detail_id=jedata[i].wms_inve_redeem_detail_id;
				}
		}
		if(flag == 1){
			if(hjzfje != this_inve_trance_data.product_total_count_lower){
				globalUtil.warnMsg(globalErrorMsg['800205']);//支付金额与投资金额不等，请修改！
		    	checkFlag=false;
			    return;
			}	
		}
		jsonStr.itcardJSON=JSON.stringify(jedata);
		if(!checkFlag){
			return;
		}
		/* if(!checkedFlag){
			globalUtil.warnMsg(globalErrorMsg['800214']);
			return;
		} */
		//实现对收益卡信息的校验
        var paramck  = globalUtil.getFormParam("main_s");
		if(flag=='1'){
			 //判断卡主姓名card_owner_name
	        if(paramck.card_owner_name =="" || paramck.card_owner_name =="-1"){
	            globalUtil.errorMsg(globalErrorMsg['800139']); 
	            return;
	        }
	        //判断银行卡号card_no
	        if(paramck.card_no =="" || paramck.card_no =="-1"){
	            globalUtil.errorMsg(globalErrorMsg['800140']); 
	            return;
	        }
	        //判断省
	        if(paramck.bank_of_deposit_pro == "" || paramck.bank_of_deposit_pro == "-1") {
	            globalUtil.errorMsg(globalErrorMsg['800133']); 
	                return;
	        }
	        //判断市
	        if(paramck.bank_of_deposit_city == "" || paramck.bank_of_deposit_city == "-1") {
	            globalUtil.errorMsg(globalErrorMsg['800134']); 
	            return;
	        }
	        //判断开户行bank_of_deposit
	        if(paramck.bank_of_deposit =="" || paramck.bank_of_depostit =="-1"){
	            globalUtil.errorMsg(globalErrorMsg['800141']); 
	            return;
	        }
	        //判断支行bank_branch
	        if(paramck.bank_branch == "" || paramck.bank_branch =="-1"){
	            globalUtil.errorMsg(globalErrorMsg['800142']); 
	            return;
	        }
	        //实现对债权匹配归属信息校验
	        if(checkIsallopatry()==false){
	        	return;
	        }
	        //实现校验附件上传情况
	        if(checkFileArr(fileArr,filecheck)){
	        	return;
	        }
		}
	    jsonStr.wms_inve_transa_prod_id=wms_inve_transa_prod_id;
	    jsonStr.card_owner_name=paramck.card_owner_name;
	    jsonStr.card_no= $("#card_no_copy").val();
	    jsonStr.bank_of_deposit_pro=paramck.bank_of_deposit_pro;
	    jsonStr.bank_of_deposit_city=paramck.bank_of_deposit_city;
	    jsonStr.bank_of_deposit=paramck.bank_of_deposit;
	    jsonStr.bank_branch=paramck.bank_branch;
	    jsonStr.flagKey=flag;//传入是暂存还是提交
	    jsonStr.fileArrpay = JSON.stringify(fileArr);//附件
	    jsonStr.taskId=taskId;
	    jsonStr.data_type_name=data_type_name;//附件大类id
	    jsonStr.product_total_count_lower=this_inve_trance_data.product_total_count_lower;
	    $("input[name=is_allopatry]").each(function(){
            if($(this).attr("checked") =="checked"){
               jsonStr.is_allopatry=$(this).val();
            }
       });
	    //如果是上单审核退回修改页面 需要把当前获取的数据传递到
	    if(update=='1'){
	    	window.parent.setInfo(jsonStr,0);
	    	return;
	    }
	    //判断是否可以点击（点击的提交或者保存的请求是否返回 ）
	    if(saveIdentification){
			globalUtil.warnMsg(globalErrorMsg['1111111']); //请不要连续点击！
			return;
		}
		saveIdentification=true;
		$.post(globalUtil.getTimestampUrl("/inve/wmsinvetransaupdateforjezf.do"),
				jsonStr, function(data) {
					saveIdentification=false;//标记保存是否返回
					if (data == 'success') {
						 globalUtil.successMsg(globalErrorMsg['100002'],//保存成功
									function() {
									 	closeTabAndRes();
									});
					}else if(data == 'error'){
						globalUtil.errorMsg(globalErrorMsg['100012']);//保存失败
					}
				});
	}
    
    function checkFileArr(fileArr,data_detail_name){
    	if(fileArr.length==0){
    		globalUtil.errorMsg(globalErrorMsg['800220']);//请上传收款凭证/Pos机小票!
    		return true;
    	}else{
	    	var flg=true;
	        for(var i=0;i<fileArr.length;i++){
	        	if(fileArr[i].data_detail_name ==data_detail_name){
	        		flg=false;
	        		break;
	        	}
	        }
	        if(flg){
	        	globalUtil.errorMsg(globalErrorMsg['800220']);//请上传收款凭证/Pos机小票!
	        }
	        return flg;
    	}
    }
	//客户收益卡信息-初始化省
	function init_bank_of_deposit_pro(json){
	        var bank_of_deposit_pro_params ={
	                dest_url:'/sysmanage/wmssysdictdatabydictidempty.do?isEmpty=true&wms_sys_dict_id=72',
	                t_col_name:'bank_of_deposit_pro',
	                valueField:'value_code',   //下拉框value对应的值，默认为id
	                textField:'value_meaning',    //下拉框text对应的值，默认为text
	                input_width:200,
	                def_val:'first'
	        };
	        global_ligerui_extend.initCombox("bank_of_deposit_pro",null,bank_of_deposit_pro_params);
	        if(json){
	            //把值装载设定
	            global_ligerui_extend.syncRequestInitComboxData(json,"bank_of_deposit_pro");
	            //让其不可编辑
	            //global_ligerui_extend.disabledCombox("bank_of_deposit_pro");
	        }else{          
	            global_ligerui_extend.initComboxDefVal("bank_of_deposit_pro");
	        }
	}
	
	//客户收益卡信息-当点击省的时候,加载市
	function getCityData1(){
	        var jsondata0;
	        if(json.wmsInveTransaProd.bank_of_deposit_pro != null && json.wmsInveTransaProd.bank_of_deposit_city != null) {
	            jsondata0 = json.wmsInveTransaProd;
	        }
	    init_bank_of_deposit_city($("#bank_of_deposit_pro_hidden").val(), jsondata0)
	}
	//客户收益卡信息-获取市
	function init_bank_of_deposit_city(p_wms_sys_dict_data_id, json){
		p_wms_sys_dict_data_id = p_wms_sys_dict_data_id == null || p_wms_sys_dict_data_id==""?-1:p_wms_sys_dict_data_id;
	    var bank_of_deposit_city_params ={
	            dest_url:'/sysmanage/wmssysdictdatabydictidemptyc.do?isEmpty=true&wms_sys_dict_id=73&p_wms_sys_dict_data_id='+p_wms_sys_dict_data_id,
	            t_col_name:'bank_of_deposit_city',
	            valueField:'value_code',   //下拉框value对应的值，默认为id
	            textField:'value_meaning',    //下拉框text对应的值，默认为text
	            input_width:200,//下拉框长度
	            def_val:'first'
	            };
	    global_ligerui_extend.initCombox("bank_of_deposit_city",null,bank_of_deposit_city_params);
	    
	    if(json){
	        //把值装载设定
	        global_ligerui_extend.syncRequestInitComboxData(json,"bank_of_deposit_city");
	        //让其不可编辑
	        //global_ligerui_extend.disabledCombox("bank_of_deposit_city");
	    }else{     
	        global_ligerui_extend.initComboxDefVal("bank_of_deposit_city");
	    }
	}
	//实现对债权匹配归属校验
	function checkIsallopatry(){
		var flag=false;
		$("input[name=is_allopatry]").each(function(){
			 if($(this).attr("checked") =="checked"){
				flag=true;
				return true;
             }
		});
		if(!flag){
			 globalUtil.errorMsg(globalErrorMsg['800143']);//债权匹配归属信息必须选择
             return false;
		}
	}
	/**
     *实现客户支付信息选择功能
     */
    function radioShowDiv(){
        $("input[type='radio']").each(function(){
               if($(this).attr("checked")=="checked"){
                 if($(this).val()=='xj'){
                     $("#divpart2_1").css("display","");
                     $("#divpart2_2").css("display","none");
                     $("#divpart2_3").css("display","none");
                 }
                 if($(this).val()=='yhk'){
                     $("#divpart2_2").css("display","");
                     $("#divpart2_1").css("display","none");
                     $("#divpart2_3").css("display","none");
                 }
                 if($(this).val()=='xj&yhk'){
                     $("#divpart2_3").css("display","");
                     $("#divpart2_1").css("display","none");
                     $("#divpart2_2").css("display","none");
                 }
             }
          });
    }
    /**
     *关闭窗口
     */
    function closeDialog() {
      window.parent.dialog.hide();
    }
    //获取上传附件内容
    function init_attr(cktype){
        $.getJSON(globalUtil.getTimestampUrl('/sysmanage/getdictdatatreebean.do?p_wms_sys_dict_id=88&wms_sys_dict_id=86'),
                {},
                function(att_json) {
                        $.getJSON(
                                globalUtil.getTimestampUrl('/inve/wmsinvetransaattwithoutpaginglist.do?sortName=wms_inve_transa_att_id'),
                                {'wms_inve_transa_id':wms_inve_transa_id,'data_type_name':data_type_name},
                                function (json){
                                   for(var i=0;i<att_json.length;i++){
                                        var data = att_json[i]
                                        var children = data.children;
                                        var row = document.getElementById("att_tb").insertRow(document.getElementById("att_tb").rows.length);
                                        var td1 = row.insertCell(0);
                                        td1.rowSpan = children.length;
                                        td1.className = 'title textright';
                                        td1.style.width = '100px';
                                        td1.innerHTML = data.text+":";
                                        var data0 = children[0];
                                        
                                        var td2 = row.insertCell(1);
                                        td2.className = 'textleft';
                                        td2.style.width = '100px';
                                        if(data0.id==filecheck){
                                        	td2.innerHTML = '<font style="color:red;">*</font>'+data0.text+":";   
                                        }else{
                                        	td2.innerHTML = data0.text+":";
                                        }           
                                        var td3 = row.insertCell(2);
                                        td3.className = 'textleft';
                                        td3.style.width = '30px';
                                        td3.innerHTML = '';
                                        if(cktype!='ck'){
                                        td3.innerHTML = '<input class="btn-uploadF" onmouseover="this.className=\'btn-uploadF-over\'" onmouseout="this.className=\'btn-uploadF\'" onmousedown="this.className=\'btn-uploadF-down\'" type="button" style="margin-right:7px;" onclick="openAddAttDialog('+data.id+','+data0.id+')" style="display:none"/>';                                        	
                                        }
                                        
                                        var td4 = row.insertCell(3);
                                        td4.className = 'textleft';
                                        td4.id = data0.id;
                                        td4.pid = data.id;
                                        td4.innerHTML=getdictAtt(data0.id,json.Rows,cktype);
                                        
                                        for(var j = 1;j < children.length;j++){
                                            var row_t = document.getElementById("att_tb").insertRow(document.getElementById("att_tb").rows.length);
                                            var td1_t = row_t.insertCell(0);
                                            td1_t.className = 'textleft';
                                            td1_t.style.width = '100px';
                                            td1_t.innerHTML = children[j].text+':'; 
                                            
                                            var td3_t = row_t.insertCell(1);
                                            td3_t.className = 'textleft';
                                            td3_t.style.width = '30px';
                                            td3_t.innerHTML = ''
                                            if(cktype!='ck'){
                                            td3_t.innerHTML = '<input class="btn-uploadF" onmouseover="this.className=\'btn-uploadF-over\'" onmouseout="this.className=\'btn-uploadF\'" onmousedown="this.className=\'btn-uploadF-down\'" type="button" style="margin-right:7px;" onclick="openAddAttDialog('+data.id+','+children[j].id+')" style="display:none"/>';                                            	
                                            }
                                            var td4_t = row_t.insertCell(2);
                                            td4_t.className = 'textleft';
                                            td4_t.id = children[j].id;
                                            td4_t.pid = data.id;
                                            td4_t.innerHTML=getdictAtt(children[j].id,json.Rows,cktype);
                                        }
                                    }
                                }
                            );
                });
                
    }
    
    //读取上传文件显示上传文件名称
    function getdictAtt(code,json,cktype){
        var htmlstr = "";
        for(var i = 0 ;i < json.length; i++){
            var data = json[i];
            var data_detail_name = data.data_detail_name;
            if(code == data.data_detail_name){
                fileArr = fileArr.concat(data);
                var nnme=data.attachment_new_name.replace('/','thxg1');
                nnme=nnme.replace('/','thxg2');
                htmlstr += '<div id="delUploadDivId'+nnme+'">';
                htmlstr += '<a  target="_blank"  href="'+global_param.upload_file_url+data.attachment_address+'">'+data.attachment_old_name+'</a>';
                if(cktype !='ck'){
                htmlstr += '<img src="../../images/icon/icon-close.gif" onclick="deleteFile(\''+nnme+'\')"/>';                	
                }
                htmlstr += '</div>'
            }
        }
        return htmlstr;
    }
    var checkedPicNms=['jpg','jpeg','bmp','png','gif','gif'];
    //检查是否为图片格式
    function findPicHZ(name) {
        for(var i = 0; i < checkedPicNms.length; i++) {
            if(checkedPicNms[i] == name) {
                return i;
            }
        }
        return -1;
    };
    var dialog_att;
    /*
        打开附件上传页面
    */
    function openAddAttDialog(data_type_name,data_detail_name){
        var url = globalUtil.getHtml("../creditManage/addFileForCre.html?data_type_name="+data_type_name+"&data_detail_name="+data_detail_name);
        dialog_att = $.ligerDialog.open({
            url: url,
            title: '上传附件',
            width: 650,
            height: globalUtil.setDialogHeight(250),
            onHiddenOrClose: function(){
                //alert('关闭或隐藏都调用的事件!');
            },
            isResize: false
        });
    }
    /**
    * 实现回显上传附件信息
    */
    function addAttFile(newfileArr,objid){
        fileArr = fileArr.concat(newfileArr);
        var filehtml = $("#"+objid).html();
        for(var i=0;i<newfileArr.length;i++){
            var nnme=newfileArr[i].attachment_new_name.replace('/','thxg1');
            nnme=nnme.replace('/','thxg2');
            filehtml += '<div id="delUploadDivId'+nnme+'">';
            filehtml += '<a  target="_blank"  href="'+global_param.upload_file_url+newfileArr[i].attachment_address+'">'+newfileArr[i].attachment_old_name+'</a>';
            filehtml += '<img src="../../images/icon/icon-close.gif" onclick="deleteFile(\''+nnme+'\')"/>';
            filehtml += '</div>'
        }
        $("#"+objid).html(filehtml);
    }
    /**
    * 删除附件信息
    */
    function deleteFile(filename){
        $.ligerDialog.confirm(globalErrorMsg['100016'],
        function(yes) {
            if (yes) {
                $("#delUploadDivId"+filename).remove();
                filename=filename.replace('thxg1','/');
                filename=filename.replace('thxg2','/');
                for(var i=0;i<fileArr.length;i++){
                    if(filename == fileArr[i].attachment_new_name){
                        fileArr.splice(i,1);
                        break;
                    }
                }
            }                                            
        });
    }
    /*
        获取表格数据，去除全部为空的记录
    */
    function getGridData(grid){
                grid.endEdit();
            var data_all = grid.getData();
            var griddata = [];
            for(var i=0;i<data_all.length;i++){
                var data = data_all[i];
                var isEmpty = true;
                if(data){
                    for(var key in data){
                        if($.trim(key) == '' || $.trim(key) == '__status'){continue;}
                        if(!globalUtil.isEmpty(data[key])){
                            if(data[key] instanceof Date){
                                data[key]= data[key].format('yyyy-MM-dd');//格式化日期类型数据
                            }
                            
                            isEmpty = false;
                        }
                    }
                }
                if(!isEmpty){
                    griddata.push(data);
                }
            }
        return griddata;
    }
    /** 
    *转换long值为日期字符串 
    * @param l long值 
    * @param isFull 是否为完整的日期数据, 
    * 为true时, 格式如"2000-03-05 01:05:04" 
    * 为false时, 格式如 "2000-03-05" 
    * @return 符合要求的日期字符串 
    */ 
    function getSmpFormatDateByLong(l, isFull) { 
    return getSmpFormatDate(new Date(l), isFull); 
    } 
    
    function closeTabAndRes(){
        parent.window.search();
        closeDialog();
    }
    /**
     *初始化银行卡号自动四位加空格
     */
    function init_card_no(){
        var val=$('#card_no').val();//获取用户输入
            val = val.replace(/\D/g,'');
            $("#card_no_copy").val(val);
            change();
    }
    /**
     *处理银行卡信息
     */
    function change(){
         var card = $('#card_no_copy').val();
         card = card.replace(/\D/g,'')
         var ncard='';
         for(var n=0;n<card.length;n=n+4){
             ncard += card.substring(n,n+4)+" ";
         }
         //console.log(ncard.replace(/(\s*$)/g,""));
         $('#card_no').val(ncard.replace(/(\s*$)/g,""));
     }
    
	//提交金额信息 --审核退回修改页面修改 使用此方法 baisong addFinanciaiManagement.html
	function saveupdate(flag){
		var jsonStr={};
		var checkFlag=true;
		var checkedFlag=false;
		var jedata=getGridData(grid_divwt4);
		var hjzfje=0;//合计支付金额
		for(var i = 0; i < jedata.length;i++){
				//现金
				if(jedata[i].pay_type == 1){
					if(flag == 1){
						if(jedata[i].card_owner_name=='' || jedata[i].pay_account==''){
					   		globalUtil.warnMsg(globalErrorMsg['800203']);
					   		checkFlag=false;
					   		return;
					   	}else{
					   		if(!globalUtil.isFloat(jedata[i].pay_account)){
					   			globalUtil.warnMsg(globalErrorMsg['800206']);
					   			checkFlag=false;
					    		return;
					   		}
					   		hjzfje+=parseFloat(jedata[i].pay_account);
					   	}
					}
				}
				jsonStr.wms_inve_transa_id=wms_inve_transa_id;
		    	jsonStr.pay_type=jedata[i].pay_type;
		    	//jsonStr.cash_pay_name=jedata[0].cash_pay_name;
		    	jsonStr.pay_account=jedata[i].pay_account;
		    	jsonStr.should_pay_account=jedata[i].pay_account;
		    	jsonStr.card_owner_name=jedata[i].card_owner_name;
		    	jsonStr.act_account=jedata[i].pay_account;
			
				//银行卡
				if(jedata[i].pay_type == 2){
					if(flag == 1){
						checkedFlag=true;
					    if(jedata.length==0){
					    	 globalUtil.warnMsg(globalErrorMsg['800204']);//请填全金额支付信息！
					    	 checkFlag=false;
					    	 return;
					    }
					    if(jedata[i].card_owner_name=='' || jedata[i].pay_account===''|| jedata[i].wms_inve_pos_id==''|| jedata[i].wms_inve_pos_id=='-1'){
				    	 	globalUtil.warnMsg(globalErrorMsg['800204']);//请填全金额支付信息！
				    	 	checkFlag=false;
							return;
				    	}else {
				    	    if(!globalUtil.isFloat(jedata[i].pay_account)||parseFloat(jedata[i].pay_account)<0){
						     	globalUtil.warnMsg(globalErrorMsg['800206']);//支付金额错误，请修改！
						    	checkFlag=false;
							   	return;
					    	 }
				    		 hjzfje+=parseFloat(jedata[i].pay_account);
						}
					}
			    	jsonStr.wms_inve_transa_id=wms_inve_transa_id;
			    	jsonStr.pay_type=jedata[i].pay_type;
		    		jsonStr.pay_account=hjzfje;
				}
				//续单本金
				if(jedata[i].pay_type == 3){
					checkedFlag=true;
				    if(jedata[i].card_owner_name=='' || jedata[i].pay_account=='' || jedata[i].bill_code == ''){
				    	 globalUtil.warnMsg(globalErrorMsg['800204']);//请填全金额支付信息！
				    	 checkFlag=false;
					   	 return;
				    }else {
				    	 if(!globalUtil.isFloat(jedata[i].pay_account)||parseFloat(jedata[i].pay_account)<0){
					   		globalUtil.warnMsg(globalErrorMsg['800206']);//支付金额错误，请修改！
					   		checkFlag=false;
					    	return;
					   	 }
				    	 hjzfje+=parseFloat(jedata[i].pay_account);
					}
			    	jsonStr.wms_inve_transa_id=wms_inve_transa_id;
			    	jsonStr.pay_type=jedata[i].pay_type;
		    		jsonStr.pay_account=hjzfje;
		    		jsonStr.wms_inve_redeem_principal_detail_id=jedata[i].wms_inve_redeem_principal_detail_id;
		    		jsonStr.wms_inve_redeem_detail_id=jedata[i].wms_inve_redeem_detail_id;
				}
		}
		if(flag == 1){
			if(hjzfje != this_inve_trance_data.product_total_count_lower){
				globalUtil.warnMsg(globalErrorMsg['800205']);//支付金额与投资金额不等，请修改！
		    	checkFlag=false;
			    return;
			}	
		}
		jsonStr.itcardJSON=JSON.stringify(jedata);
		if(!checkFlag){
			return;
		}
		/* if(!checkFlag){
			 return false;
		}
		if(!checkedFlag){
			globalUtil.warnMsg(globalErrorMsg['800214']);
			 return false;
		} */
		//实现对收益卡信息的校验
        var paramck  = globalUtil.getFormParam("main_s");
		if(flag=='1'){
			 //判断卡主姓名card_owner_name
	        if(paramck.card_owner_name =="" || paramck.card_owner_name =="-1"){
	            globalUtil.errorMsg(globalErrorMsg['800139']); 
	            return false;
	        }
	        //判断银行卡号card_no
	        if(paramck.card_no =="" || paramck.card_no =="-1"){
	            globalUtil.errorMsg(globalErrorMsg['800140']); 
	            return false;
	        }
	        //判断省
	        if(paramck.bank_of_deposit_pro == "" || paramck.bank_of_deposit_pro == "-1") {
	            globalUtil.errorMsg(globalErrorMsg['800133']); 
	            return false;
	        }
	        //判断市
	        if(paramck.bank_of_deposit_city == "" || paramck.bank_of_deposit_city == "-1") {
	            globalUtil.errorMsg(globalErrorMsg['800134']); 
	            return false;
	        }
	        //判断开户行bank_of_deposit
	        if(paramck.bank_of_deposit =="" || paramck.bank_of_depostit =="-1"){
	            globalUtil.errorMsg(globalErrorMsg['800141']); 
	            return false;
	        }
	        //判断支行bank_branch
	        if(paramck.bank_branch == "" || paramck.bank_branch =="-1"){
	            globalUtil.errorMsg(globalErrorMsg['800142']); 
	            return false;
	        }
	        //实现对债权匹配归属信息校验
	        if(checkIsallopatry()==false){
	        	return false;
	        }
	        //实现校验附件上传情况
	        if(checkFileArr(fileArr,filecheck)){
	        	return;
	        }
		}
	    jsonStr.wms_inve_transa_prod_id=wms_inve_transa_prod_id;
	    jsonStr.card_owner_name=paramck.card_owner_name;
	    jsonStr.card_no= $("#card_no_copy").val();
	    jsonStr.bank_of_deposit_pro=paramck.bank_of_deposit_pro;
	    jsonStr.bank_of_deposit_city=paramck.bank_of_deposit_city;
	    jsonStr.bank_of_deposit=paramck.bank_of_deposit;
	    jsonStr.bank_branch=paramck.bank_branch;
	    jsonStr.flagKey=flag;//传入是暂存还是提交
	    jsonStr.fileArr = JSON.stringify(fileArr);//附件
	    jsonStr.taskId=taskId;
	    jsonStr.data_type_name=data_type_name;//附件大类id
	    $("input[name=is_allopatry]").each(function(){
            if($(this).attr("checked") =="checked"){
               jsonStr.is_allopatry=$(this).val();
            }
       });
	    //如果是上单审核退回修改页面 需要把当前获取的数据传递到
	    if(update=='1'){
	    	window.parent.setInfo(jsonStr,0);
	    	return true;
	    }
	  }
	//给支付页面的投资金额初始化--上单审核退回 修改页面 使用
	function setVal(val){
		$("#divpart1").find("font").last().text(val+"万元");
	}
	
	
	//添加grid行
	function addRows() {
		var manager = $("#grid-divwt2").ligerGetGridManager();   
		manager.endEdit();
		if(json.wmsInveTransaCards !=''){
		 manager.addRow({'card_owner_name':json.wmsInveTransaCards[0].card_owner_name,'card_no':'','bank_of_deposit_pro':'','bank_of_deposit_city':'','bank_of_deposit_name':'','wms_inve_pos_id':'','pay_account':''});
		}else{
		 manager.addRow({'card_owner_name':this_inve_trance_data.cus_name,'card_no':'','bank_of_deposit_pro':'','bank_of_deposit_city':'','bank_of_deposit_name':'','wms_inve_pos_id':'','pay_account':''});
		}
	}

	function addRowsXJYHK() {
		var manager = $("#grid-divwt3").ligerGetGridManager();   
		manager.endEdit();
		if(json.wmsInveTransaCards !=''){
		  manager.addRow({'pay_type':'银行卡','card_owner_name':json.wmsInveTransaCards[0].card_owner_name,'card_no':'','bank_of_deposit_pro':'','bank_of_deposit_city':'','bank_of_deposit_name':'','wms_inve_pos_id':'','pay_account':''});
		}else{
		  manager.addRow({'pay_type':'银行卡','card_owner_name':this_inve_trance_data.cus_name,'card_no':'','bank_of_deposit_pro':'','bank_of_deposit_city':'','bank_of_deposit_name':'','wms_inve_pos_id':'','pay_account':''});
		}
		for (var i = 3; i < 8; i++) {
			var s = grid_divwt3.getCellObj(0,i);         	
			$(s).bind("click",function(){return false;})
		}
	}
	var flaga = false;
	function deleteRowXJYHK() {
	 	var manager = $("#grid-divwt3").ligerGetGridManager();
	    var row = manager.getSelectedRow();
	    var row0=manager.getRow(0);
	    var row1=manager.getRow(1);
	    if (row) {
	    	if(row==row0||row==row1){
	        	return;
	        }
	    }
	    if (!row) {
	        globalUtil.warnMsg(globalErrorMsg['100001']); //请选择一行记录进行删除
	        return;
	    }
	    globalUtil.confirmMsg(globalErrorMsg['100016'],
	    function(yes) { //确认删除
	    	if(yes){
	    		flaga=true;
	    		global_ligerui_extend.deleteSelectedRow(manager);
	    	}
	    });
	}
	//删除grid选中行
	function deleteRow() {
	 	var manager = $("#grid-divwt2").ligerGetGridManager();
	    var row = manager.getSelectedRow();
	    if (!row) {
	        globalUtil.warnMsg(globalErrorMsg['100001']); //请选择一行记录进行删除
	        return;
	    }
	    
	    globalUtil.confirmMsg(globalErrorMsg['100016'],
	    function(yes) { //确认删除
	    	if(yes){
	    		global_ligerui_extend.deleteSelectedRow(manager);
	    	}
	    });
	}
</script>
</head>
<body>
	<div class="pop-center overflow-au" id="myForm">
		<div id="divpart1" align="left" class="warningDiv askwaring"></div>
		<div id="divpart2" class="pop-formDiv clearfix" style="margin: 5px;height: 180px;">
			<div class="float-l clearboth" style="height: 10px;"></div>
			<div class="center-content clearboth" style="min-width: 700px;">
				<!-- 添加客户支付信息begin -->
				<div class="center-title">
					<font color="black">客户支付信息</font><!--(<font color="red">*为必填项</font>)  <input
						type="radio" name="zffsrad" value="xj" onchange="radioShowDiv()"
						class="radio3" style="margin-left: 8px;" />现金 <input type="radio"
						name="zffsrad" value="yhk" onchange="radioShowDiv()"
						class="radio3" />银行卡 <input type="radio" name="zffsrad"
						value="xj&yhk" onchange="radioShowDiv()" class="radio3" />现金+银行卡 -->
				</div>
				<!-- <div class="center-txt" style="margin-bottom: 15px; display: none;"
					id="divpart2_1">
					<div id="toolbar-divwt1" class="minwidth400"></div>
					<div id="grid-divwt1"></div>
				</div>
				<div class="center-txt" style="margin-bottom: 15px; display: none;"
					id="divpart2_2">
					<div id="toolbar-divwt2" class="minwidth400"></div>
					<div id="grid-divwt2"></div>
				</div>
				<div class="center-txt" style="margin-bottom: 15px; display: none;"
					id="divpart2_3">
					<div id="toolbar-divwt3" class="minwidth400"></div>
					<div id="grid-divwt3"></div>
				</div>
				 -->
				<!-- 新的客户支付信息 start -->
				<div class="center-txt" style="margin-bottom: 15px; display: '';" id="divpart2_4">
					<div id="toolbar-divwt4" class="minwidth400"></div>
					<div id="grid-divwt4"></div>
				</div>
				<!-- 新的客户支付信息 end -->
				
				<!-- 添加客户支付信息end -->
				<!-- 添加客户收益卡信息begin -->
		        <div class="center-title" style="margin-top: 20px;">
		                                        客户收益卡信息<span style="color: red;">(*为必填项)</span>
		                 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  
		                 <span id="bank_info_title">                
		            		<input type="radio" name="is_bank_card" value='1' class="radio5" onchange="changeRadio(this);">全新银行卡</input>
		            		&nbsp;&nbsp;&nbsp; 
		             		<input type="radio" name="is_bank_card" value='2' class="radio5" onchange="changeRadio(this);">已使用银行卡</input>
		             		&nbsp;
		             		<select id="bank_info" onchange="changeOption(this);" style="width: 200px;"></select>
		             	</span>
		        </div>
		        <div class="center-content2 clearboth" style="min-width: 500px;">
		            <div class="l-panel-search-cond clearfix" id='main_s'
		                style="padding-top: 2px; height: 100px;">
		                <div class="float-l clearboth">
		                    <div class="l-panel-search-title">
		                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span
		                            style="color: red;">*</span>卡主姓名:
		                    </div>
		                    <div class="l-panel-search-item">
		                        <input type="text" id="card_owner_name" style="width: 200px"
		                            isRequired="1" />
		                    </div>
		                </div>
		                <div class="float-l ">
		                    <div class="l-panel-search-title">
		                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span
		                            style="color: red;">*</span>银行卡号:
		                    </div>
		                    <div class="l-panel-search-item">
		                          <input type="hidden" id="card_no_copy" style="width: 200px"
                                    isRequired="1" />
		                        <input type="text" id="card_no" style="width: 200px"
		                            isRequired="1" onkeyup="init_card_no()"/>
		                    </div>
		                </div>
		                <div class="float-l clearboth">
		                    <div class="l-panel-search-title">
		                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span
		                            style="color: red;">*</span>省:
		                    </div>
		                    <div class="l-panel-search-item">
		                        <input type="text" id="bank_of_deposit_pro" style="width: 200px"
		                            isRequired="1" />
		                    </div>
		                </div>
		                <div class="float-l" style="margin-left: 66px">
		                    <div class="l-panel-search-title">
		                        <span style="color: red;">*</span>市:
		                    </div>
		                    <div class="l-panel-search-item">
		                        <input type="text" id="bank_of_deposit_city" style="width: 200px"
		                            isRequired="1" />
		                    </div>
		                </div>
		                <div class="float-l clearboth">
		                    <div class="l-panel-search-title">
		                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span
		                            style="color: red;">*</span>开户行:
		                    </div>
		                    <div class="l-panel-search-item">
		                        <input type="text" id="bank_of_deposit" style="width: 200px"
		                            isRequired="1" />
		                    </div>
		                </div>
		                <div class="float-l">
		                    <div class="l-panel-search-title">
		                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span
		                            style="color: red;">*</span>支行:
		                    </div>
		                    <div class="l-panel-search-item">
		                        <input type="text" id="bank_branch" style="width: 200px"
		                            isRequired="1" />
		                    </div>
		                </div>
		            </div>
		        </div>
		        <!-- 添加客户收益卡信息end -->
		        <!-- 添加债权匹配归属信息begin -->
		        <div class="center-title" style="margin-top: 20px;">债权匹配归属信息<span style="color: red;">(*为必填项)</span></div>
                <div class="center-content2 clearboth" style="min-width: 500px;">
                    <div class="l-panel-search-cond clearfix" style="padding-top: 2px; height: 15px;">
                        <div class="float-l ">
                            <div class="l-panel-search-title">
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span
                                    style="color: red;">*</span>是否给匹配异地债权:
                            </div>
                            <div class="l-panel-search-item">
                               &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" class="radio3" name="is_allopatry" id="is_allopatry1"  value="1"/>是
                               &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" class="radio3" name="is_allopatry" id="is_allopatry2"  value="0"/>否
                            </div>
                        </div>
                    </div>
                </div>
		        <!-- 添加债权匹配归属信息end -->
		        <!-- 添加附件信息begin -->
		        <div class="center-title" style="margin-top: 20px;">附件信息</div>
                <div class="center-content2 clearboth" style="min-width: 500px;">
		            <table cellspacing="1" cellpadding="1" class="input_tb" id="att_tb" >
		                <tr >
		                    
		                </tr>
		            </table>
                </div>
		        <!-- 添加附件信息end -->
			</div>
		</div>
    </div>
	
	<div class="pop-footer5" id="btn_div">
	    <input id="zcbtn" class="btn-saveZ" 
		    onmouseover="this.className='btn-saveZ-over'" 
		    onmouseout="this.className='btn-saveZ'" 
		    onmousedown="this.className='btn-saveZ-down'" 
		    type="button" style="margin-right:7px;" onclick="save(0)"/>   
		<input id="tjbtn" class="btn-saveT"
			onmouseover="this.className='btn-saveT-over'"
			onmouseout="this.className='btn-saveT'"
			onmousedown="this.className='btn-saveT-down'" type="button"
			style="margin-right: 7px;" onclick="save(1)" /> <input
			id="cancelBtnId" class="btn-cancel"
			onmouseover="this.className='btn-cancel-over'"
			onmouseout="this.className='btn-cancel'"
			onmousedown="this.className='btn-cancel-down'" type="button"
			onclick="closeDialog();" />
	</div>
</body>
</html>
