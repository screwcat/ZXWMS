<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>车贷放款申请</title>
<link href="../../css/app.css" type="text/css" rel="stylesheet" />
<link href="../../css/zx-all.css" rel="stylesheet" type="text/css" />
<script language="Javascript" src="../../js/zx-all.js"> </script>

<style type="text/css">
.textright {
	text-align: right;
}

.textleft {
	text-align: left;
}
/*input_tb css*/
.input_tb_new {
	/*border:1px solid #dfdfdf;*/
	width: 100%;
	margin-bottom: 10px;
}

.input_tb_new a {
	color: #056aff;
	text-decoration: none;
	font-weight: normal;
}

.input_tb_new td {
	height: 35px;
	line-height: 25px;
	/*border-bottom:1px dashed #d5d5d5;*/
	padding-top: 3px;
}

.input_tb_new .tr_title td {
	background-color: #f5f8ff;
	padding-left: 16px;
	font-weight: bold;
	height: 30px;
	line-height: 30px;
	/*border-bottom:1px solid #dfdfdf;*/
}

.input_tb_new .tr_last td {
	border-bottom: 0;
}

.input_tb_new .title {
	text-align: right;
}

.input_tb_new .subtitle {
	text-align: left;
	background-color: #d2e1fd;
	border-top: 1px solid #fff;
	/*border-left:1px solid #fff;*/
}

.input_tb_new .tr_btn_input td {
	background-color: #fbfbfb;
	/*border-top:1px solid #dbdbdb;*/
	/*height:40px;*/
}

.title_tb {
	background-color: #f5f8ff;
	padding-left: 16px;
	font-weight: bold;
	height: 30px;
	line-height: 30px;
	height: 35px;
	line-height: 25px;
	padding-top: 3px;
}

.data_tb td {
	height: 30px;
	line-height: 24px;
	padding-left: 10px;
	border-bottom: 1px dashed #e3e4e6;
	text-align: left;
}
</style>
</head>
<body>
	<div class="tab_titleT">
		<!--查询条件  begin-->
		<table width="100%" border="0" cellspacing="0" cellpadding="0">
			<tr valign="bottom" id='trtab1'>
				<td class="tabbody1" id="tabbody1" onclick="changeTab('transfer');"
					tabname='mytab' style="width: 33%">
					<div align="center">转账单</div>
				</td>
				<td class="tabbody2" id="tabbody2"
					onclick="changeTab('borrowList');" tabname='mytab'
					style="width: 33%">
					<div align="center">合同清单</div>
				</td>
			</tr>
		</table>
	</div>
	<div class="pop-center overflow-au" style="top: 30px;">
		<div id="transfer" class="pop-formDiv clearfix"
			style="margin: 5px; margin-top: 5px;">
			<div class="float-l">
				<div class="pop-form-title">客户姓名：</div>
				<div class="pop-form-item">
					<input type="text" id="debtor_name" style="width: 150px;"
						disabled="disabled" />
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">身份证号：</div>
				<div class="pop-form-item">
					<input type="text" id="debtor_identity_id" style="width: 150px;"
						disabled="disabled" />
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">申请日期：</div>
				<div class="pop-form-item">
					<input type="text" id="create_date" style="width: 150px;"
						readonly="readonly" />
				</div>
			</div>
			<div class="float-l clearboth">
				<div class="pop-form-title">合同编号：</div>
				<div class="pop-form-item">
					<input type="text" id="protocol_id_year_num" style="width: 150px;"
						disabled="disabled" />
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">合同金额：</div>
				<div class="pop-form-item">
					<input type="text" id="principal_lower" style="width: 134px;"
						disabled="disabled" />&nbsp;元
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">大写：</div>
				<div class="pop-form-item">
					<input type="text" id="principal_caps" style="width: 150px;"
						disabled="disabled" />
				</div>
			</div>
			<div class="float-l clearboth">
				<div class="pop-form-title">贷款产品：</div>
				<div class="pop-form-item">
					<input type="text" id="cre_type_name" style="width: 150px;"
						disabled="disabled" />
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">还款方式：</div>
				<div class="pop-form-item">
					<input type="text" id="protocol_type_name" style="width: 150px;"
						disabled="disabled" />
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">贷款期数：</div>
				<div class="pop-form-item">
					<input type="text" id="borrow_deadline" style="width: 150px;"
						disabled="disabled" />
				</div>
			</div>
			<div class="float-l clearboth">
				<div class="pop-form-title">每月还款：</div>
				<div class="pop-form-item">
					<input type="text" id="refund_limit_month" style="width: 134px;"
						disabled="disabled" />&nbsp;元
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">其中本金：</div>
				<div class="pop-form-item">
					<input type="text" id="org_repay_principal" style="width: 134px;"
						disabled="disabled" />&nbsp;元
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">其中利息：</div>
				<div class="pop-form-item">
					<input type="text" id="org_repay_interest" style="width: 134px;"
						disabled="disabled" />&nbsp;元
				</div>
			</div>
			
			<!--<div class="float-l ">
				<div class="pop-form-title">扣除利息：</div>
				<div class="pop-form-item">
					<input type="text" id="deduction_of_interest" style="width: 134px;"
						readonly="readonly" />&nbsp;元
				</div>
			</div>-->
			<div class="float-l clearboth">
				<div class="pop-form-title">平台费：</div>
				<div class="pop-form-item">
					<input type="text" id="platform_fee" style="width: 150px;"/>
				</div>
				&nbsp;&nbsp;&nbsp;&nbsp;
			</div>
		
			<div class="float-l">
				<div class="pop-form-title">
					GPS安装费：
				</div>
				<div class="pop-form-item">
					<input type="text" id="gps_installation_fee" value="0" style="width: 150px;"
						isRequired="1" onchange="initFL(platform_fee_value)"/>
				</div>
			</div>

			<div class="float-l clearboth">
				<div class="pop-form-title">转款余额：</div>
				<div class="pop-form-item">
					<input type="text" id="loan_amount" style="width: 134px;"
						disabled="disabled" />&nbsp;元
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">大写：</div>
				<div class="pop-form-item">
					<input type="text" id="loan_amount_caps" style="width: 150px;"
						disabled="disabled" />
				</div>
			</div>
			<!-- 添加的虚线 -->
			<div class="line clearboth" id="info_l3"></div>
			<div class="float-l clearboth">
				<div class="pop-form-title">
					银行：
				</div>
				<div class="pop-form-item">
					<input type="text" id="receive_bank" style="width: 150px;"
						isRequired="1" />
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">
					开户行：
				</div>
				<div class="pop-form-item">
					<input type="text" id="bank_of_deposit" style="width: 150px;"
						isRequired="1" />
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">
					<!--<span class="redstar">*</span>-->卡号：
				</div>
				<div class="pop-form-item">
					<input type="text" id="card_no" style="width: 150px;"
						isRequired="1" />
				</div>
			</div>
			<!-- 添加的虚线 -->
			<div class="line clearboth" id="info_l3"></div>
			<div class="float-l clearboth">
				<div class="pop-form-title">备注：</div>
				<div class="pop-form-item">
					<textarea id="remark" name="remark" rows="35" cols="110"
						style="width: 698px; height: 80px;" maxLen="250"></textarea>
				</div>
			</div>
			<div class="float-l  clearboth">
				<div class="pop-form-title"></div>
				<div class="pop-form-item"></div>
			</div>
			<div class="float-l  clearboth">
				<div class="pop-form-title"></div>
				<div class="pop-form-item"></div>
			</div>

			<!-- 添加的虚线 -->
			<div class="line clearboth" id="info_l3"></div>
			<div class="float-l">
				<div class="pop-form-title" align="right">身份证附件：</div>
				<div class="pop-form-item" align="right" style="width: 701px">
					<table>
						<tr>
							<td><div style="width: 550px" id="showIdImage"></div></td>
							<td id="upload_id"><button
									onclick="openAddAttDialog('1','showIdImage')" class="btn">上传附件</button></td>
						</tr>
					</table>
				</div>
			</div>
			<div class="float-l  clearboth">
				<div class="pop-form-title"></div>
				<div class="pop-form-item"></div>
			</div>
			<div class="float-l  clearboth">
				<div class="pop-form-title"></div>
				<div class="pop-form-item"></div>
			</div>
			<div class="float-l  clearboth">
				<div class="pop-form-title"></div>
			</div>
			<!-- 添加的虚线 -->
			<div class="line clearboth" id="info_l3"></div>
			<div class="float-l">
				<div class="pop-form-title">银行卡附件：</div>
				<div class="pop-form-item" align="right" style="width: 701px">
					<table>
						<tr>
							<td><div style="width: 550px" id="showAmountImage"></div></td>
							<td id="upload_amount"><button
									onclick="openAddAttDialog('2','showAmountImage')" class="btn">上传附件</button></td>
						</tr>
					</table>
				</div>
			</div>
		</div>

		<!-- //*********************************************转账单结束********************************** -->
		<!-- //*********************************************合同清单开始********************************** -->
		<div id="borrowList" class="pop-formDiv clearfix"
			style="margin: 5px; margin-top: 5px; display: none">
			<div class="center-txt" style="margin-bottom: 30px;">
				<div id="grid-borrow"></div>
			</div>
		</div>
		<!-- //*********************************************公正及它项开始********************************** -->
	</div>
	<!-- 提交功能按钮区 -->
	<div class="pop-footer5 clearboth" style="bottom: 1px;" id="tb_btn">
		<input id="tjbtn" onclick="saveYes();" class="btn-saveT"
			onmouseover="this.className='btn-saveT-over'"
			onmouseout="this.className='btn-saveT'"
			onmousedown="this.className='btn-saveT-down'" type="button"
			style="align: right" />
	</div>

	<script type="text/javascript">
	var wms_cre_credit_head_id = $.query.get("wms_cre_credit_head_id");
	var protocol_id_year_num = $.query.get("protocol_id_year_num");
	var debtor_name=$.query.get("debtor_name");
	var protocol_date=$.query.get("protocol_date");
	var principal_lower=$.query.get("principal_lower");
	var borrow_interest=$.query.get("borrow_interest");
	var refund_number=$.query.get("refund_number");
	var refund_bank=$.query.get("refund_bank");
	var cre_loan_type=$.query.get("cre_loan_type");
	
	var cre_type=$.query.get("cre_type");//贷款类型
	var protocol_type=$.query.get("protocol_type");//合同类型
	
	var loan_amount=document.getElementById("loan_amount"); 
	var fileArr = [];//上传附件列表
	var isCommit = false;//是否已经按过了提交按钮
	var smjJsonArray=[];
	var principal_lower = 0;
	var loan_amount_old = 0;
	var org_repay_interest_value = 0;//其中利息
	var payment_contract_type=0;//贷款类型
	var type_value=0;//合同种类
	$(function(){
		initForm();	//初始化表单数据	
		init_borrow(); //初始化合同清单
		initForm2();//回显数据
		init_platform_fee();
	});	
	//初始化表单数据
	function initForm(){
		$.getJSON(globalUtil.getTimestampUrl('/loanappro/wmssyspropertyobjforcar.do'),//初始化数据
				{
					"wms_cre_credit_head_id"  : wms_cre_credit_head_id
				},
				function(json) {
					doFloat(json);
					globalUtil.setFormVal("transfer", json);	
					initFormOtherVal(json.todayDate);
					principal_lower = json.principal_lower;
					loan_amount_old = json.appro_limit;
					org_repay_interest_value = json.org_repay_interest;//其中利息
					payment_contract_type=json.payment_contract_type;
					init_value_code(json.cre_loan_type);
		});
	}
	var platform_fee_value=0;//保存值
	//平台费
	function init_platform_fee(json){
		var params_val ={
				dest_url:'/sysmanage/wmssysdictdatabydictidempty.do?isEmpty=true&wms_sys_dict_id=77',
				t_col_name:'platform_fee',
				valueField:'value_code',   //下拉框value对应的值，默认为id
				textField:'value_meaning',    //下拉框text对应的值，默认为text
				def_val:'first'
				};
		global_ligerui_extend.initCombox("platform_fee",function(value){
			if(value!="-1"&&value!=""&&value!=null){
				platform_fee_value=value;
				initFL(value);
			}
		},params_val);
		if(json){
			//把值装载设定
			global_ligerui_extend.syncRequestInitComboxData(json,"platform_fee");
			//让其不可编辑
			//global_ligerui_extend.disabledCombox("platform_fee");
		}else{			
		    global_ligerui_extend.initComboxDefVal("platform_fee");
		}
	}
	//初始化贷款产品名称
	function init_value_code(value_code){
		type_value=value_code;
		$.getJSON(globalUtil.getTimestampUrl('/sysmanage/getDictDataCode.do?isEmpty=true&wms_sys_dict_id=75'),//初始化数据
				{
					"value_code"  : value_code
				},
				function(json) {	
					$("#cre_type_name").val(json.cre_type_name);
				
		});
	}
	//初始化费率
	function initFL(platform_fee) {
		//转账金额：先息后本-车开走：转账金额= 借款本金-1个月利息-平台费-GPS安装费
				//先息后本-押车：转账金额= 借款本金-1个月利息-平台费
				//等额本息：转账金额= 借款本金-平台费-GPS安装费
		var gps_installation_fee=parseInt($("#gps_installation_fee").val()|0);//gps安装费
		var loan_amount = "0";
		if(payment_contract_type != null) {
			if(payment_contract_type == "1") {//1代表等额本息	2代表先息后本
				loan_amount = (loan_amount_old - platform_fee - gps_installation_fee).toFixed(2);
			} else if(payment_contract_type == "2") {
				loan_amount = (principal_lower - platform_fee - gps_installation_fee- org_repay_interest_value).toFixed(2);
			} 
		} 
		$("#loan_amount").val(loan_amount);
		$('#loan_amount_caps').val(convertCurrency(loan_amount));
	}
	//初始化表单数据
	function initForm2(){
		$.getJSON(globalUtil.getTimestampUrl('/loanappro/wmssyspropertyobjforhouse.do'),////初始化数据
				{
					"wms_cre_credit_head_id"  : wms_cre_credit_head_id
				},
				function(json) {	
					$.getJSON(globalUtil.getTimestampUrl('/loanappro/getwmsfinacreloanappbyentity.do'),////初始化数据
					{
						"wms_cre_credit_head_id"  : wms_cre_credit_head_id
					},
					function(json2) {
						if(json2 != null){
							if(JSON.stringify(json2).split(",").length!=1){
								for(var item in json2){
									json[item]=json2[item];
								}
								doFloat(json);
								globalUtil.setFormVal("transfer", json);//初始化提前还款申请信息
								init_platform_fee(json);
								var fjList=globalUtil.syncGetJson('/loanfina/wmsfinacreloanappattwithoutpaginglist.do',{
								"wms_fina_cre_loan_app_id": json.wms_fina_cre_loan_app,//期还款台账id
						        },'POST');
								var idHtml='';
								var amountHtml='';
								for (var i = 0; i < fjList.Rows.length; i++) {
									fjList.Rows[i].create_timestamp = null;
									fileArr.push(fjList.Rows[i]);
									if(fjList.Rows[i].data_type==1){
										var nnme=fjList.Rows[i].attachment_new_name.replace('/','thxg1');
										nnme=nnme.replace('/','thxg2');
										idHtml +='<div style="margin-bottom:8px;" id="delUploadDivId'+nnme+'">';
										idHtml += '<a  target="_blank"  href="'+global_param.upload_file_url+fjList.Rows[i].attachment_address+'">'+fjList.Rows[i].attachment_old_name+'</a>';
										idHtml += '<img src="../../images/icon/icon-close.gif" onclick="deleteFile(\''+nnme+'\')"/>';
										idHtml += '</div>'
									}else if(fjList.Rows[i].data_type==2){
										var nnme=fjList.Rows[i].attachment_new_name.replace('/','thxg1');
										nnme=nnme.replace('/','thxg2');
										amountHtml +='<div style="margin-bottom:8px;" id="delUploadDivId'+nnme+'">';
										amountHtml +='<a  target="_blank"  href="'+global_param.upload_file_url+fjList.Rows[i].attachment_address+'">'+fjList.Rows[i].attachment_old_name+'</a>';
										amountHtml += '<img src="../../images/icon/icon-close.gif" onclick="deleteFile(\''+nnme+'\')"/>';
										amountHtml += '</div>'
									}
								}
								$("#showIdImage").html(idHtml);	
								$("#showAmountImage").html(amountHtml);
							}
						}						
					});
			});
	}
	//将小数四舍五入，如果长度过长保留两位小数
	function doFloat(json){
		var principal_lower_val = json.principal_lower;//合同金额
		var refund_limit_month_val = json.refund_limit_month;//每月还款
		var org_repay_interest_val = json.org_repay_interest;//其中利息		
		var org_repay_principal_val = json.org_repay_principal;//本金
		json.principal_lower = principal_lower_val.toFixed(2);
		json.refund_limit_month = refund_limit_month_val.toFixed(2);
		json.org_repay_interest = org_repay_interest_val.toFixed(2);
		if(globalUtil.isEmpty(json.org_repay_principal)){
			json.org_repay_principal = '0';
		}else{
			json.org_repay_principal = json.org_repay_principal.toFixed(2);
		}		
	}
	//初始化其他字段的值
	function initFormOtherVal(todayDate){
		var principal_lower = $('#principal_lower').val();//合同金额
		$('#create_date').val(todayDate);//申请日期	
		$('#deduction_of_interest').val('0');//扣除利息
		$('#gps_installation_fee').val('0');//gps
	}
	//验证卡号
	function valiCardno(){
		var flag = false;
		var card_no_val = $('#card_no').val();
		if(!/\d+/.test(card_no_val)){
			flag = true;
			$('#card_no').ligerTip({distanceX:-140,width:110,content: '此项仅为数字！'});	
			$('#card_no').bind('click',function(){
				$(inputElement).ligerHideTip();
			});
		}
		return flag;
	}
	//小写金额转大写金额
	function convertCurrency(currencyDigits) {  
		var MAXIMUM_NUMBER = 99999999999.99;   
		var CN_ZERO = "零";  
		var CN_ONE = "壹";  
		var CN_TWO = "贰";  
		var CN_THREE = "叁";  
		var CN_FOUR = "肆";  
		var CN_FIVE = "伍";  
		var CN_SIX = "陆";  
		var CN_SEVEN = "柒";  
		var CN_EIGHT = "捌";  
		var CN_NINE = "玖";  
		var CN_TEN = "拾";  
		var CN_HUNDRED = "佰";  
		var CN_THOUSAND = "仟";  
		var CN_TEN_THOUSAND = "万";  
		var CN_HUNDRED_MILLION = "亿";  
		var CN_SYMBOL = "";  
		var CN_DOLLAR = "元";  
		var CN_TEN_CENT = "角";  
		var CN_CENT = "分";  
		var CN_INTEGER = "整";  
		    
		var integral;   
		var decimal; 
		var outputCharacters; 
		var parts;  
		var digits, radices, bigRadices, decimals;  
		var zeroCount;  
		var i, p, d;  
		var quotient, modulus;  
		  
		currencyDigits = currencyDigits.toString();   
		  
		currencyDigits = currencyDigits.replace(/,/g, ""); 
		currencyDigits = currencyDigits.replace(/^0+/, ""); 
		
		if (Number(currencyDigits) > MAXIMUM_NUMBER) {  
		  globalUtil.errorMsg(globalErrorMsg['100404']);  
		  return "";  
		}		
		parts = currencyDigits.split(".");  
		if (parts.length > 1) {  
		  integral = parts[0];  
		  decimal = parts[1];  
		  decimal = decimal.substr(0, 2);  
		}  
		else {  
		  integral = parts[0];  
		  decimal = "";  
		}  
		digits = new Array(CN_ZERO, CN_ONE, CN_TWO, CN_THREE, CN_FOUR, CN_FIVE, CN_SIX, CN_SEVEN, CN_EIGHT, CN_NINE);  
		radices = new Array("", CN_TEN, CN_HUNDRED, CN_THOUSAND);  
		bigRadices = new Array("", CN_TEN_THOUSAND, CN_HUNDRED_MILLION);  
		decimals = new Array(CN_TEN_CENT, CN_CENT);  
		outputCharacters = "";  
		if (Number(integral) > 0) {  
		  zeroCount = 0;  
		  for (i = 0; i < integral.length; i++) {  
		   p = integral.length - i - 1;  
		   d = integral.substr(i, 1);  
		   quotient = p / 4;  
		   modulus = p % 4;  
		   if (d == "0") {  
		    zeroCount++;  
		   }  
		   else {  
		    if (zeroCount > 0)  
		    {  
		     outputCharacters += digits[0];  
		    }  
		    zeroCount = 0;  
		    outputCharacters += digits[Number(d)] + radices[modulus];  
		  }  
		   if (modulus == 0 && zeroCount < 4) {  
		    outputCharacters += bigRadices[quotient];  
		  }  
		  }  
		  outputCharacters += CN_DOLLAR;  
		}  
		if (decimal != "") {  
		  for (i = 0; i < decimal.length; i++) {  
		   d = decimal.substr(i, 1);  
		   if (d != "0") {  
		    outputCharacters += digits[Number(d)] + decimals[i];  
		   }  
		  }  
		}  
		if (outputCharacters == "") {  
		  outputCharacters = CN_ZERO + CN_DOLLAR;  
		}  
		if (decimal == "") {  
		  outputCharacters += CN_INTEGER;  
		}  
		outputCharacters = CN_SYMBOL + outputCharacters;  
		return outputCharacters;  
	}  

	
	//页面切换
    function changeTab(id) {
		var transfer = document.getElementById("transfer"); //转账单
		var borrowList = document.getElementById("borrowList"); //合同清单

		if (id == 'transfer') {
			document.getElementById("tabbody1").className = "tabbody1";
			document.getElementById("tabbody2").className = "tabbody2";
			transfer.style.display = '';
			borrowList.style.display = 'none';
			globalUtil.clearLigerTip("transfer");
			if(isCommit){
				globalVali.checkForm("transfer",true);
				valiCardno();
			}
		} else if (id == 'borrowList') {
			document.getElementById("tabbody1").className = "tabbody2";
			document.getElementById("tabbody2").className = "tabbody1";
			transfer.style.display = 'none';
			borrowList.style.display = '';
			globalUtil.clearLigerTip("transfer");
		}
	}
	
 	//初始化合同清单
	function init_borrow(){
		var column2 = [{
			display: '合同名称',
			name: 'borrow_name',
			resizable: false,
			width: 200,
			minWidth: 200
		},{
			display: '电子版本合同',
			name: 'borrow_online',
			resizable: false,
			width: 200,
			minWidth: 200,
		    render: function (rowdata, rowindex, value) { 
       			return '<a href="javascript:showEachProtocol('+rowindex+');" style="color:#056AFF;text-decoration: none;">'+"查看"+'</a>';
            }
		},{
			display: '扫描件',
			name: 'borrow_scanning',
			resizable: false,
			width: 400,
			minWidth: 400,
			render: function (rowdata, rowindex, value) { 
				var result='';
				for(i=0;i<smjJsonArray.length;i++){
					result += '<a  target="_blank"  href="'+global_param.upload_file_url+smjJsonArray[i].attachment_address+'">'+smjJsonArray[i].attachment_old_name+'</a><br />';
				}
       			return result;
            }
		}];
		
		var grid_borrow_data={};
		grid_borrow_data.Rows=[{'borrow_name':'借款合同','borrow_online':'','borrow_scanning':''}];
		var fjList=globalUtil.syncGetJson('/loanreview/wmscrecarphousingattwithoutpaginglist.do',{
			wms_cre_credit_head_id: wms_cre_credit_head_id, // 贷款id'
			data_type:5
	        },'POST');
					smjJsonArray = fjList.Rows;
					var grid_borrow = $("#grid-borrow").ligerGrid({
						columns: column2,
						data:grid_borrow_data,
						usePager: false, 
						rownumbers: true,
						width: '100%',
						height:240,
						heightDiff: -4,
						enabledEdit: true
					});
			
	}
  	
	//打开合同页面
	function showEachProtocol(rowind){
		
    	if(cre_type=='1'){
    		var json=globalUtil.syncGetJson('/cremanage/wmscrecreditheadinfobypk.do',{
        		"wms_cre_credit_head_id": wms_cre_credit_head_id
    	    },'GET');
    		if(json.cre_loan_type==284){
    			window.open("../loanappro/loanApproBorrowProtocolTSDSearch.html?wms_cre_credit_head_id="+wms_cre_credit_head_id); 	
    		}else{
    			window.open("../loanappro/showloanApproBorrowProtocol.html?wms_cre_credit_head_id="+wms_cre_credit_head_id);  
    		} 
        }else if(cre_type=='2'){
   			if(protocol_type == '1'){
   				window.open("../loanappro/nowarrantagreeoneSearch.html?wms_cre_credit_head_id="+wms_cre_credit_head_id);
   			}else if(protocol_type == '2'){
   				window.open("../loanappro/warrantagreeoneSearch.html?wms_cre_credit_head_id="+wms_cre_credit_head_id);
   			}else if(protocol_type == '3'){
   				window.open("../loanappro/nowarrantagreeotwoSearch.html?wms_cre_credit_head_id="+wms_cre_credit_head_id);
   			}else if(protocol_type == '4'){
   				window.open("../loanappro/warrantagreetwoSearch.html?wms_cre_credit_head_id="+wms_cre_credit_head_id);   				
   			}else if(protocol_type == '6'){
   				window.open("../loanappro/returnBorrowProtocolSearch.html?wms_cre_credit_head_id="+wms_cre_credit_head_id);   				
			}else if(protocol_type == '7'){
				window.open("../loanappro/combineBorrowProtocolSearch.html?wms_cre_credit_head_id="+wms_cre_credit_head_id);   				
			}else if(protocol_type == '11'){
				window.open("../loanappro/houseLoanThreeSearch.html?wms_cre_credit_head_id="+wms_cre_credit_head_id);   				
			}else if(protocol_type == '12'){
				window.open("../loanappro/houseLoanThreeNoSearch.html?wms_cre_credit_head_id="+wms_cre_credit_head_id);   				
			}else if(protocol_type == '9'){
				window.open("../loanappro/houseLoanFourSearch.html?wms_cre_credit_head_id="+wms_cre_credit_head_id);   				
			}else if(protocol_type == '10'){
				window.open("../loanappro/houseLoanFourNoSearch.html?wms_cre_credit_head_id="+wms_cre_credit_head_id);   				
			}else if(protocol_type == '21'){//var protocol_type="21";//合同编号   先息后本 新房1号 保人担责    zxMortgageOne.html
   				window.open("../loanappro/zxMortgageOneSearch.html?wms_cre_credit_head_id="+wms_cre_credit_head_id);   				
			}else if(protocol_type == '22'){//var protocol_type="22";//合同编号   先息后本 新房1号 保人不担责  zxMortgageOneNo.html 
				window.open("../loanappro/zxMortgageOneNoSearch.html?wms_cre_credit_head_id="+wms_cre_credit_head_id);   				
			}else if(protocol_type == '23'){//var protocol_type="23";//合同编号   等额本息 新房2号 保人担责    zxMortgageTwoEq.html
   				window.open("../loanappro/zxMortgageTwoEqSearch.html?wms_cre_credit_head_id="+wms_cre_credit_head_id);   				
			}else if(protocol_type == '24'){//var protocol_type="24";//合同编号   等额本息 新房2号 保人不担责  zxMortgageTwoEqNo.html
				window.open("../loanappro/zxMortgageTwoEqNoSearch.html?wms_cre_credit_head_id="+wms_cre_credit_head_id);   				
			}else if(protocol_type == '25'){//var protocol_type="25";//合同编号   等额本息 新房2号 保人担责    zxMortgageTwoEq.html 长春
   				window.open("../loanappro/zxMortgageOneSearch0431.html?wms_cre_credit_head_id="+wms_cre_credit_head_id);   				
			}else if(protocol_type == '26'){//var protocol_type="26";//合同编号   等额本息 新房2号 保人不担责  zxMortgageTwoEqNo.html 长春
				window.open("../loanappro/zxMortgageTwoEqSearch0431.html?wms_cre_credit_head_id="+wms_cre_credit_head_id);   				
			}else if(protocol_type == '27'){//var protocol_type="25";//合同编号   等额本息 新房2号 保人担责    zxMortgageTwoEq.html 长春
   				window.open("../loanappro/zxMortgageOneNoSearch0431.html?wms_cre_credit_head_id="+wms_cre_credit_head_id);   				
			}else if(protocol_type == '28'){//var protocol_type="26";//合同编号   等额本息 新房2号 保人不担责  zxMortgageTwoEqNo.html 长春
				window.open("../loanappro/zxMortgageTwoEqNoSearch0431.html?wms_cre_credit_head_id="+wms_cre_credit_head_id);   				
			}
    	}else if(cre_type=='3'){//车贷
 		   if(protocol_type == '31'){
  				window.open("../loanappro/carLoanApproBorrowProtocolEqSearch.html?wms_cre_credit_head_id="+wms_cre_credit_head_id);
  			}else if(protocol_type == '32'){
  				window.open("../loanappro/carLoanApproBorrowProtocolNoSearch.html?wms_cre_credit_head_id="+wms_cre_credit_head_id);
  			}else if(protocol_type == '33'){
  				window.open("../loanappro/carLoanApproBorrowProtocolSearch.html?wms_cre_credit_head_id="+wms_cre_credit_head_id);
  			}
	  }
	}
	
	//读取上传文件显示上传文件名称
	function getdictAtt(code,json){
		var htmlstr = "";
		for(var i = 0 ;i < json.length; i++){
			var data = json[i];
			var data_detail_name = data.data_detail_name;
			if(code == data.data_detail_name){
				if(findPicHZ(data.attachment_type.toLowerCase())==-1){
					htmlstr += '<a  target="_blank"  href="'+global_param.upload_file_url+data.attachment_address+'">'+data.attachment_old_name+'</a>'
				}else{
					htmlstr += '<input type="checkbox" id=cb'+data.wms_cre_credit_line_customer_data_attachment_id+' class="radio3" onclick=onCheckCB('+data.wms_cre_credit_line_customer_data_attachment_id+') style="width: auto"/>&nbsp;&nbsp;<a  target="_blank"  href="'+global_param.upload_file_url+data.attachment_address+'">'+data.attachment_old_name+'</a>'
				}
			}
		}
		return htmlstr;
	}
    
	var dialog_att;
	/*
	打开附件上传页面
	*/
	function openAddAttDialog(data_type_name,data_detail_name){
		globalUtil.clearLigerTip("transfer");
		var url = globalUtil.getHtml("../creditManage/addFileForCre.html?data_type_name="+data_type_name+"&data_detail_name="+data_detail_name);
		dialog_att = $.ligerDialog.open({
	        url: url,
	        title: '上传附件',
	        width: 650,
	        height: globalUtil.setDialogHeight(250),
	        onHiddenOrClose: function(){
	        	//alert('关闭或隐藏都调用的事件!');
	    	},
	        isResize: false
		});
	}
	//上传文件之后显示文件
	function addAttFile(newfileArr,objid){
		fileArr = fileArr.concat(newfileArr);
		var filehtml = $("#"+objid).html();
		for(var i=0;i<newfileArr.length;i++){
			var nnme=newfileArr[i].attachment_new_name.replace('/','thxg1');
			nnme=nnme.replace('/','thxg2');
			filehtml += '<div id="delUploadDivId'+nnme+'">';
			filehtml += '<a  target="_blank"  href="'+global_param.upload_file_url+newfileArr[i].attachment_address+'">'+newfileArr[i].attachment_old_name+'</a>';
			filehtml += '<img src="../../images/icon/icon-close.gif" onclick="deleteFile(\''+nnme+'\')"/>';
			filehtml += '</div>'
		}
		$("#"+objid).html(filehtml);
	}
	//删除文件
	function deleteFile(filename){
       	$.ligerDialog.confirm(globalErrorMsg['100016'],
        function(yes) {
        	if (yes) {
        		$("#delUploadDivId"+filename).remove();
        		filename=filename.replace('thxg1','/');
        		filename=filename.replace('thxg2','/');
        		for(var i=0;i<fileArr.length;i++){
        			if(filename == fileArr[i].attachment_new_name){
        				fileArr.splice(i,1);
        				break;
        			}
        		}
	    	}                                            
   		});
    }
	
	var allCreditPicIDs=[];//所有图片Id 从上至下
	//读取上传文件显示上传文件名称
	function getdictAtt(code,json){
		var htmlstr = "";
		for(var i = 0 ;i < json.length; i++){
			var data = json[i];
			var data_detail_name = data.data_detail_name;
			if(code == data.data_detail_name){
				if(findPicHZ(data.attachment_type.toLowerCase())==-1){
					htmlstr += '<a  target="_blank"  href="'+global_param.upload_file_url+data.attachment_address+'">'+data.attachment_old_name+'</a>'
				}else{
					htmlstr += '<input type="checkbox" id=cb'+data.wms_cre_credit_line_customer_data_attachment_id+' class="radio3" onclick=onCheckCB('+data.wms_cre_credit_line_customer_data_attachment_id+') style="width: auto"/>&nbsp;&nbsp;<a  target="_blank"  href="'+global_param.upload_file_url+data.attachment_address+'">'+data.attachment_old_name+'</a>'
				}
				allCreditPicIDs.push(data.wms_cre_credit_line_customer_data_attachment_id);
			}
		}
		return htmlstr;
	}
	
	var checkedCreditIDs=[];
	function onCheckCB(id){
		if($("#cb"+id).is(':checked')){
			addCheckedCredit(id)
		}else{
			removeCheckedCredit(id)
		}
	}
	
	 // 向checkedCredit中添加id的方法
    function addCheckedCredit(id) {
    	if (findCheckedCredit(id) == -1) {
    		checkedCreditIDs.push(id);
    	}
    };
    // 从checkedCredit中移除id的方法
    function removeCheckedCredit(id) {
    	var i  = findCheckedCredit(id);
    	if (i == -1) {
    		return;
    	}
    	checkedCreditIDs.splice(i, 1);
    };
    
    // 在checkedCredit中查找是否已存在id的方法
    function findCheckedCredit(id) {
    	for(var i = 0; i < checkedCreditIDs.length; i++) {
    		if(checkedCreditIDs[i] == id) {
    			return i;
    		}
    	}
    	return -1;
    };
    
    var checkedPicNms=['jpg','jpeg','bmp','png','gif'];
    //检查是否为图片格式
    function findPicHZ(name) {
    	for(var i = 0; i < checkedPicNms.length; i++) {
    		if(checkedPicNms[i] == name) {
    			return i;
    		}
    	}
    	return -1;
    };  
    function saveYes(){
    	if(type_value=='1'){//押车合同类型
    		if($("#gps_installation_fee").val()!='0'){//gps安装费
    			 globalUtil.confirmMsg(globalErrorMsg['401002'],
  		  	    	    function(yes) { //确认删除
  		  	    	    	if(yes){
  		  	    	    		save();
  		  	    	    	}
    		  	 });
    		}else{
    			save();
    		}
    	}else{
    		save();
    	}
    }
  	//保存
    function save(){
    	isCommit = true;
    	globalUtil.clearLigerTip("transfer");
    	if($('#transfer').css('display')!='none' && (globalVali.checkForm("transfer",true) | valiCardno())){
			return;
		}else if($('#borrowList').css('display')!='none' && (globalVali.checkForm("transfer",true)||valiCardno())){//当在还款历史页面时，检查各表单的数据
			globalUtil.clearLigerTip("transfer");
			globalUtil.warnMsg(globalErrorMsg['100116']);
			return;
		}
    	var paramCtinfo = globalUtil.getFormParam("transfer");//获取申请信息
    	var taskId=$.query.get("taskId");
    	for(var i=0;i<fileArr.length;i++){
            fileArr[i].date_type=fileArr[i].data_type;
            delete fileArr[i].data_type;
            delete fileArr[i].last_update_timestamp;
            delete fileArr[i].wms_fina_cre_loan_app_att_id;
        }
    	paramCtinfo.fileArr = JSON.stringify(fileArr);//附件
		$.post(globalUtil.getTimestampUrl("/loanfina/wmsfinacrecarloanappsave.do?wms_cre_credit_head_id="+wms_cre_credit_head_id+"&taskId="+taskId), paramCtinfo,
		function(data) {
			 if (data === 'success') {
            	 globalUtil.successMsg(globalErrorMsg['100002'],
            	function(){            	
            				window.parent.search();	 		
            		 		closePage();
            	 });//保存成功
            	 
            }else {
                globalUtil.errorMsg(globalErrorMsg['100012']); //保存失败
            }
        });
    }
  
 	//关闭本页并刷新查询页面
    function refreshAndClosePage(){   
    	window.parent.location.reload();
    	closePage();
    }
 	//关闭页面
    function closePage(){
    	window.parent.dialog.hide();
    }
	</script>
</body>
</html>
