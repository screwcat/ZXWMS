<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>财富管理系统</title>
<link href="../../css/app.css" type="text/css" rel="stylesheet" />
<link href="../../css/zx-all.css" rel="stylesheet" type="text/css" />
<script src="../../js/zx-all.js" type="text/javascript"></script>
<style type="text/css">
/*input_tb css*/
.input_tb {
	border: 1px solid #dfdfdf;
	width: 100%;
	margin-bottom: 10px;
}

.input_tb a {
	color: #056aff;
	text-decoration: none;
	font-weight: normal;
}

.input_tb td {
	height: 35px;
	line-height: 25px;
	border-bottom: 1px dashed #d5d5d5;
	padding-top: 3px;
}

.input_tb .tr_title td {
	background-color: #f5f8ff;
	padding-left: 16px;
	font-weight: bold;
	height: 30px;
	line-height: 30px;
	border-bottom: 1px solid #dfdfdf;
}

.input_tb .tr_last td {
	border-bottom: 0;
}

.input_tb .title {
	text-align: right;
}

.input_tb .subtitle {
	text-align: left;
	background-color: #d2e1fd;
	border-top: 1px solid #fff;
	border-left: 1px solid #fff;
}

.input_tb .tr_btn_input td {
	background-color: #fbfbfb;
	/*border-top:1px solid #dbdbdb;*/
	height: 40px;
}
</style>
</head>
<body>
	<div class="tab_titleT">
		<table width="100%" border="0" cellspacing="0" cellpadding="0">
			<tr valign="bottom" id='trtab1'>
				<td width="50%" class="tabbody1" id="tabbody1"
					onclick="changeTab('yfdinfo');" tabname='mytab'><div
						align="center">贷款信息</div></td>
				<td width="50%" class="tabbody2" id="tabbody2"
					onclick="changeTab('yfpginfo');" tabname='mytab'><div
						align="center">验房评估信息</div></td>
			</tr>
		</table>
	</div>
	<div class="pop-center overflow-au" id="divId" style="top: 30px;">
		<div id="yfpginfo" class="pop-formDiv clearfix"
			style="margin: 5px; margin-top: 5px; display: none">
			<div>
				<table cellspacing="1" cellpadding="1" class="input_tb" id="att_tb">
					<tr>
						<td colspan="2" align="left">验房评估</td>
						<td align="right"><div id='plswpic'></div></td>
					</tr>
					<tr>
						<td align="left"><span style="color: #FF0000;">&nbsp;&nbsp;&nbsp;*</span><span
							style="color: #333333;">验房评估表：</span></td>
						<td id="YFshowPic"></td>
						<td id="tdupdPicBtn" class="textleft" align="left"><a
							href="#" onclick="openAddAttDialog('none','YFshowPic')"
							class="btn" style="display:" style="display:none">上传附件</a></td>
					</tr>
				</table>
			</div>
		</div>
		<div id="yfdinfo" class="pop-formDiv clearfix"
			style="margin: 25px; margin-top: 25px;">
			<div class="float-l">
				<div class="pop-form-title">客户姓名：</div>
				<div class="pop-form-item">
					<input type="text" id="customer_name" maxlength="20" />
				</div>
				<div class="float-l">
					<div class="pop-form-title">房屋地址：</div>
					<div class="pop-form-item">
						<input type="text" id="house_address" maxlength="250"
							style="width: 390px" />
					</div>
				</div>
				<div class="float-l clearboth">
					<div class="pop-form-title">房屋面积：</div>
					<div class="pop-form-item">
						<input type="text" id="house_building_area" maxlength="20"
							isFloat="1" minVal="0" maxVal="10000" style="width: 121px" />㎡
					</div>
				</div>
				<div class="float-l">
					<div class="pop-form-title">总楼层：</div>
					<div class="pop-form-item">
						<input type="text" id="total_floor" maxlength="20"
							isPositiveInteger="1" minVal="1" maxVal="1000" scope="a" />
					</div>
				</div>
				<div class="float-l">
					<div class="pop-form-title">所在楼层：</div>
					<div class="pop-form-item">
						<input type="text" id="house_layer" maxlength="20" isInteger="1"
							minVal="-1000" maxVal="1000" scope="a" />
					</div>
				</div>
				<div class="float-l clearboth">
					<div class="pop-form-title">小区名称：</div>
					<div class="pop-form-item">
						<input type="text" id="community_name" maxlength="20" />
					</div>
				</div>
				<div class="float-l">
					<div class="pop-form-title">房屋格局：</div>
					<div class="pop-form-item">
						<input type="text" id="housing_pattern" maxlength="20" />
					</div>
				</div>
				<div class="float-l">
					<div class="pop-form-title">房屋楼龄：</div>
					<div class="pop-form-item">
						<input type="text" id="building_age" maxlength="20" />
					</div>
				</div>
				<div class="float-l clearboth">
					<div class="pop-form-title">装修标准：</div>
					<div class="pop-form-item">
						<input type="text" id="decoration_Standard" maxlength="20" />
					</div>
				</div>
				<div class="float-l">
					<div class="pop-form-title">房屋用途：</div>
					<div class="pop-form-item">
						<input type="text" id="house_usage" maxlength="20" />
					</div>
				</div>
				<div class="float-l clearboth">
					<div class="pop-form-title">房屋网上均价：</div>
					<div class="pop-form-item">
						<input type="text" id="online_fold" maxlength="20" isFloat="1"
							minVal="0" maxVal="1000000000" scope="a" />
					</div>
				</div>
				<div class="float-l">
					<div class="pop-form-title">房屋成交价格：</div>
					<div class="pop-form-item">
						<input type="text" id="house_transaction_price" maxlength="20"
							isFloat="1" minVal="0" maxVal="1000000000" scope="a" />
					</div>
				</div>
				<div class="float-l clearboth">
					<div class="pop-form-title">成交率是否活跃：</div>
					<div class="pop-form-item">
						<input type="radio" name="is_active" value="1" class="radio3" />有成交
						<input type="radio" name="is_active" value="0" class="radio3" />无成交
					</div>
				</div>
				<div class="line clearboth sqrqkdiv" id="info_l3"></div>
				<div class="float-l">
					<div class="pop-form-title">房屋出租价格：</div>
					<div class="pop-form-item">
						<input type="text" id="rental_price" maxlength="18" isFloat="1"
							minVal="0" maxVal="1000000000" scope="a" />
					</div>
				</div>
				<div class="float-l clearboth" style="height: 73px;">
					<div class="pop-form-title"
						style="line-height: 15px; text-align: left">
						验房人对房屋评<br />价：
					</div>
					<div class="pop-form-item">
						<textarea id="house_people_review"
							style="width: 647px; height: 60px"></textarea>
					</div>
				</div>
				<div class="float-l clearboth">
					<div class="pop-form-title">朝向：</div>
					<div class="pop-form-item">
						<input type="checkbox" name="housing_towards" value="fm"
							class="radio3" />南北 <input type="checkbox" name="housing_towards"
							value="pozn" class="radio3" />东西 <input type="checkbox"
							name="housing_towards" value="py" class="radio3" />双阳 <input
							type="checkbox" name="housing_towards" value="dj" class="radio3" />顶楼
						<input type="checkbox" name="housing_towards" value="qt"
							class="radio3" />临街 <input type="checkbox"
							name="housing_towards" value="qt" class="radio3" />把山
					</div>
				</div>
				<div class="float-l clearboth">
					<div class="pop-form-title">居住情况：</div>
					<div class="pop-form-item">
						<input type="checkbox" name="common_occupants" value="fm"
							class="radio3" />老人 <input type="checkbox"
							name="common_occupants" value="pozn" class="radio3" />伤残 <input
							type="checkbox" name="common_occupants" value="py" class="radio3" />儿童
						<input type="checkbox" name="common_occupants" value="dj"
							class="radio3" />夫妻 <input type="checkbox"
							name="common_occupants" value="qt" class="radio3" />独居 <input
							type="checkbox" name="common_occupants" value="qt" class="radio3" />无
					</div>
				</div>
				<div class="float-l clearboth">
					<div class="pop-form-title">小区卫生：</div>
					<div class="pop-form-item">
						<input type="checkbox" name="residential_environ" value="fm"
							class="radio3" />优 <input type="checkbox"
							name="residential_environ" value="pozn" class="radio3" />一般 <input
							type="checkbox" name="residential_environ" value="py"
							class="radio3" />脏、乱、差
					</div>
				</div>
				<div class="float-l clearboth">
					<div class="pop-form-title">园区管理：</div>
					<div class="pop-form-item">
						<input type="checkbox" name="residential_manage" value="fm"
							class="radio3" />封闭式花园物业管理 <input type="checkbox"
							name="residential_manage" value="pozn" class="radio3" />开放式物业管理
						<input type="checkbox" name="residential_manage" value="py"
							class="radio3" />老旧及回迁小区
					</div>
				</div>
				<div class="float-l clearboth">
					<div class="pop-form-title">周围配套设施：</div>
					<div class="pop-form-item">
						<input type="checkbox" name="facilities" value="fm" class="radio3" />大型超市
						<input type="checkbox" name="facilities" value="pozn"
							class="radio3" />医院 <input type="checkbox" name="facilities"
							value="py" class="radio3" />餐饮娱乐 <input type="checkbox"
							name="facilities" value="dj" class="radio3" />银行 <input
							type="checkbox" name="facilities" value="qt" class="radio3" />学校
						<input type="checkbox" name="facilities" value="qt" class="radio3" />公交车便利
						<input type="checkbox" name="facilities" value="qt" class="radio3" />地铁
						<input type="checkbox" name="facilities" value="qt" class="radio3" />商场
					</div>
				</div>
				<div class="float-l clearboth" style="height: 73px;">
					<div class="pop-form-title">备注：</div>
					<div class="pop-form-item">
						<textarea id="remark" style="width: 647px; height: 60px"></textarea>
					</div>
				</div>
				<div class="float-l clearboth">
					<div class="pop-form-title">成交价格：</div>
					<div class="pop-form-item">
						<input type="text" id="transaction_price" maxlength="18"
							isFloat="1" minVal="0" maxVal="1000000000" scope="a" />
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="pop-footer5 clearboth" style="bottom: 1px;">
		<input id="tjbtn" class="btn-saveT"
			onmouseover="this.className='btn-saveT-over'"
			onmouseout="this.className='btn-saveT'"
			onmousedown="this.className='btn-saveT-down'" type="button"
			style="margin-right: 7px;" onclick="approval()" /> <input
			id="cancelBtnId" class="btn-cancel"
			onmouseover="this.className='btn-cancel-over'"
			onmouseout="this.className='btn-cancel'"
			onmousedown="this.className='btn-cancel-down'" type="button"
			onclick="closeDialog();" />
	</div>
	<script type="text/javascript">
	var wms_cre_credit_head_id;//贷款记录ID值
	var cktype;//查看状态
	var taskId;
	var fileArr = [];//上传附件列表
	$(function() {
		taskId=$.query.get("taskId");
		wms_cre_credit_head_id=$.query.get('wms_cre_credit_head_id');
		cktype=$.query.get('cktype');
		//globalUtil.clearLigerWhenScroll("divId");//当纵向滚动条滚动时，清除LigerTip以及LigerUI下拉框打开的部分
		if (cktype=='ck') {	//当是只读页面时
			$('#tjbtn').css('display','none');
			$("#tdupdPicBtn").html('');
			var fjList=globalUtil.syncGetJson('/cremanage/wmscrehousingattwithoutpaginglist.do',{
				wms_cre_credit_head_id: wms_cre_credit_head_id, // 贷款id'
		        },'POST');
	    	var YFHtml='';	    	
	    	for (var i = 0; i < fjList.Rows.length; i++) {
	    		if(fjList.Rows[i].data_type==4){
	    			YFHtml += '<div id="delUploadDivId'+fjList.Rows[i].attachment_new_name+'">';
	    			YFHtml += '<a  target="_blank"  href="'+global_param.upload_file_url+fjList.Rows[i].attachment_address+'">'+fjList.Rows[i].attachment_old_name+'</a>';
					YFHtml += '</div>'
	    		}
	    	}   	
	    	$("#YFshowPic").html(YFHtml);   
			$.getJSON(globalUtil.getTimestampUrl('/loancheck/wmscrehousingcheckinfo.do'),
			{
				"wms_cre_credit_head_id" : wms_cre_credit_head_id
			},
			function(json) {	
				globalUtil.setFormVal("yfdinfo", json);	
				init_Combox('housing_pattern',20, json);//初始化房屋格局下拉框
				init_Combox('building_age',21, json);//初始化房屋楼龄下拉框
				init_Combox('decoration_Standard',22, json);//初始化装修标准下拉框
				init_Combox('house_usage',23, json);//初始化房屋用途下拉框
				setotherVal(json);
				lookpage();
			});
		}else{
			init_Combox('housing_pattern',20);//初始化房屋格局下拉框
			init_Combox('building_age',21);//初始化房屋楼龄下拉框
			init_Combox('decoration_Standard',22);//初始化装修标准下拉框
			init_Combox('house_usage',23);//初始化房屋用途下拉框
		}		
	});
	//设置页面为只读页面
	function lookpage() {
		$("input[type=text]").attr({
			"disabled" : "disabled"
		});
		$("input[type=radio]").attr({
			"disabled" : "disabled"
		});		
		$("input[type=checkbox]").attr({
			"disabled" : "disabled"
		});
		$("textarea").attr({
			"disabled" : "disabled"
		});	
	}
	//设置单选钮，多选钮的值
	function setotherVal(json) {
		$('#house_people_review').val(json.infoMap.house_people_review);
		$("input[name='is_active']").each(function() {
			if ($(this).val() == json.is_active) {
				$(this).attr('checked', 'checked');
				return false;
			}
		});
		var housing_towards = json.housing_towards;
		if (housing_towards.length && housing_towards.length > 0) {
			var commarr = housing_towards.split(",");
			$("input[name='housing_towards']").each(function() {
				if (checkArr(commarr, $(this).val())) {
					$(this).attr('checked', 'checked');
				} else {
					$(this).removeAttr('checked');
				}
			});
		}
		var common_occupants = json.common_occupants;
		if (common_occupants.length && common_occupants.length > 0) {
			var commarr = common_occupants.split(",");
			$("input[name='common_occupants']").each(function() {
				if (checkArr(commarr, $(this).val())) {
					$(this).attr('checked', 'checked');
				} else {
					$(this).removeAttr('checked');
				}
			});
		}
		var residential_environ = json.residential_environ;
		if (residential_environ.length && residential_environ.length > 0) {
			var commarr = residential_environ.split(",");
			$("input[name='residential_environ']").each(function() {
				if (checkArr(commarr, $(this).val())) {
					$(this).attr('checked', 'checked');
				} else {
					$(this).removeAttr('checked');
				}
			});
		}
		var residential_manage = json.residential_manage;
		if (residential_manage.length && residential_manage.length > 0) {
			var commarr = residential_manage.split(",");
			$("input[name='residential_manage']").each(function() {
				if (checkArr(commarr, $(this).val())) {
					$(this).attr('checked', 'checked');
				} else {
					$(this).removeAttr('checked');
				}
			});
		}
		var facilities = json.facilities;
		if (facilities.length && facilities.length > 0) {
			var commarr = facilities.split(",");
			$("input[name='facilities']").each(function() {
				if (checkArr(commarr, $(this).val())) {
					$(this).attr('checked', 'checked');
				} else {
					$(this).removeAttr('checked');
				}
			});
		}

	}

	//关闭本对话框
	function closeDialog() {
		window.parent.dialog.hide();
	}
	//跳转到审批页面
	function approval(){
		if(globalVali.checkForm("yfdinfo", false)){
			return;
		}
		if(fileArr.length==0){
			globalUtil.errorMsg(globalErrorMsg['300113']);
			return;
		}
		var url = globalUtil.getHtml("../creditManage/houseApproval.html?wms_cre_credit_head_id="+wms_cre_credit_head_id);
		dialog=$.ligerDialog.open({
			url:url,
			title: '审批',
	        width: 1000,
	        height: globalUtil.setDialogHeight(500),
	        onHiddenOrClose: function(){
	    	},
	        isResize: false
		});  
	}
	//保存
	function save(pass,advice) {
		var jsonStr={};
		globalUtil.getFormParam('yfdinfo', jsonStr);
		getOtherVal(jsonStr);
		jsonStr.pass=pass;
		jsonStr.advice=advice;
		jsonStr.taskId=taskId;
		jsonStr.wms_cre_credit_head_id=wms_cre_credit_head_id;
		jsonStr.fileArr = JSON.stringify(fileArr);//附件
		$.post(globalUtil.getTimestampUrl("/loancheck/wmscrehousingchecksave.do"),
		   jsonStr, function(data) {
		   		if (data === 'success') {
           			globalUtil.successMsg(globalErrorMsg['100002'],
           				function(){            		 		
               				refreshAndClosePage();
           			});//保存成功           	 
           		}else if(data ==='error'){
           			globalUtil.errorMsg(globalErrorMsg['300109']); //请刷新页面,您当前审批的单据已经被审批过。
           		}else {
               		globalUtil.errorMsg(globalErrorMsg['100012']); //保存失败
           		}
		});
	}
	
	function checkArr(commarr, val) {
		for (var i = 0; i < commarr.length; i++) {
			if (val == commarr[i]) {
				return true;
			}
		}
		return false;
	}

	//关闭本页并刷新查询页面
    function refreshAndClosePage(){  
    	window.parent.search();    
    	closeDialog();
    }
	//获取单选钮、多选钮选择的值
	function getOtherVal(jsonStr) {
		$("input[name='is_active']").each(function() {
			if ($(this).is(':checked')) {
				jsonStr.is_active = $(this).val();
				return false;//退出each循环
			}
		});		
		var housing_towards = [];
		$("input[name='housing_towards']").each(function() {
			if ($(this).is(':checked')) {
				housing_towards.push($(this).val());
			}
		});
		jsonStr.housing_towards = housing_towards.join(",");
		var common_occupants = [];
		$("input[name='common_occupants']").each(function() {
			if ($(this).is(':checked')) {
				common_occupants.push($(this).val());
			}
		});
		jsonStr.common_occupants = common_occupants.join(",");
		var residential_environ = [];
		$("input[name='residential_environ']").each(function() {
			if ($(this).is(':checked')) {
				residential_environ.push($(this).val());
			}
		});
		jsonStr.residential_environ = residential_environ.join(",");
		var residential_manage = [];
		$("input[name='residential_manage']").each(function() {
			if ($(this).is(':checked')) {
				residential_manage.push($(this).val());
			}
		});
		jsonStr.residential_manage = residential_manage.join(",");
		var facilities = [];
		$("input[name='facilities']").each(function() {
			if ($(this).is(':checked')) {
				facilities.push($(this).val());
			}
		});
		jsonStr.facilities = facilities.join(",");
	}
	/*
	   初始化LigerUI combobox
	*/
	function init_Combox(id,wms_sys_dict_id,json){
		var params ={
				dest_url:'/sysmanage/wmssysdictdatabydictid.do?isEmpty=true&wms_sys_dict_id='+wms_sys_dict_id,
				t_col_name:id,
				valueField:'wms_sys_dict_data_id',   //下拉框value对应的值，默认为id
				textField:'value_meaning',    //下拉框text对应的值，默认为text
				def_val:'first',
				input_width:'133'
				};
		global_ligerui_extend.initCombox(id,null,params);
		if(json){
			//把值装载设定
			global_ligerui_extend.syncRequestInitComboxData(json,id);
			//让其不可编辑
			global_ligerui_extend.disabledCombox(id);
		}else{			
		    global_ligerui_extend.initComboxDefVal(id);
		}
	}
	function changeTab(id) {
		var yfdinfo = document.getElementById("yfdinfo"); //贷款信息tab
		var yfpginfo = document.getElementById("yfpginfo"); //初审评估表tab

		if (id == 'yfdinfo') {
			document.getElementById("tabbody1").className = "tabbody1";
			document.getElementById("tabbody2").className = "tabbody2";
			yfdinfo.style.display = '';
			yfpginfo.style.display = 'none';
		} else if (id == 'yfpginfo') {
			document.getElementById("tabbody1").className = "tabbody2";
			document.getElementById("tabbody2").className = "tabbody1";
			yfdinfo.style.display = 'none';
			yfpginfo.style.display = '';
		}
	};
	var dialog_att;
	/*
	打开附件上传页面
	*/
	function openAddAttDialog(data_type_name,data_detail_name){
		var url = globalUtil.getHtml("../creditManage/addFileForCre.html?data_type_name="+data_type_name+"&data_detail_name="+data_detail_name);
		dialog_att = $.ligerDialog.open({
	        url: url,
	        title: '上传附件',
	        width: 650,
	        height: globalUtil.setDialogHeight(250),
	        onHiddenOrClose: function(){
	        	//alert('关闭或隐藏都调用的事件!');
	    	},
	        isResize: false
		});
	}
	//添加上传文件的信息链接
	function addAttFile(newfileArr,objid){
		fileArr = fileArr.concat(newfileArr);
		var filehtml = $("#"+objid).html();
		for(var i=0;i<newfileArr.length;i++){
			var nnme=newfileArr[i].attachment_new_name.replace('/','thxg1');
			nnme=nnme.replace('/','thxg2');
			filehtml += '<div id="delUploadDivId'+nnme+'">';
			filehtml += '<a  target="_blank"  href="'+global_param.upload_file_url+newfileArr[i].attachment_address+'">'+newfileArr[i].attachment_old_name+'</a>';
			filehtml += '<img src="../../images/icon/icon-close.gif" onclick="deleteFile(\''+nnme+'\')"/>';
			filehtml += '</div>'
		}
		$("#"+objid).html(filehtml);
	}
	 //删除上传文件的信息链接
	 function deleteFile(filename){
	       	$.ligerDialog.confirm(globalErrorMsg['100016'],
	        function(yes) {
	        	if (yes) {
	        		$("#delUploadDivId"+filename).remove();
	        		filename=filename.replace('thxg1','/');
	        		filename=filename.replace('thxg2','/');
	        		for(var i=0;i<fileArr.length;i++){
	        			if(filename == fileArr[i].attachment_new_name){
	        				fileArr.splice(i,1);
	        				break;
	        			}
	        		}
		    	}                                            
	   		});
	    }
</script>
</body>
</html>
