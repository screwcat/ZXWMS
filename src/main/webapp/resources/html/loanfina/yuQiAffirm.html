<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>逾期还款确认</title>
<link href="../../css/app.css" type="text/css" rel="stylesheet" />
<link href="../../css/zx-all.css" rel="stylesheet" type="text/css" />
<script language="Javascript" src="../../js/zx-all.js"> </script>

<style type="text/css">
.textright {
	text-align: right;
}

.textleft {
	text-align: left;
}
/*input_tb css*/
.input_tb_new {
	/*border:1px solid #dfdfdf;*/
	width: 100%;
	margin-bottom: 10px;
}

.input_tb_new a {
	color: #056aff;
	text-decoration: none;
	font-weight: normal;
}

.input_tb_new td {
	height: 35px;
	line-height: 25px;
	/*border-bottom:1px dashed #d5d5d5;*/
	padding-top: 3px;
}

.input_tb_new .tr_title td {
	background-color: #f5f8ff;
	padding-left: 16px;
	font-weight: bold;
	height: 30px;
	line-height: 30px;
	/*border-bottom:1px solid #dfdfdf;*/
}

.input_tb_new .tr_last td {
	border-bottom: 0;
}

.input_tb_new .title {
	text-align: right;
}

.input_tb_new .subtitle {
	text-align: left;
	background-color: #d2e1fd;
	border-top: 1px solid #fff;
	/*border-left:1px solid #fff;*/
}

.input_tb_new .tr_btn_input td {
	background-color: #fbfbfb;
	/*border-top:1px solid #dbdbdb;*/
	/*height:40px;*/
}

.title_tb {
	background-color: #f5f8ff;
	padding-left: 16px;
	font-weight: bold;
	height: 30px;
	line-height: 30px;
	/*border:1px solid #dfdfdf;8/
border-bottom:0;
}
.title_tb .title_txt{
float:left;
}
.title_tb .title_btn{
float:right;
margin-top:2px;
font-weight:normal;
}
.input_tb_new td {
    /*border-bottom: 1px dashed #D5D5D5;*/
	height: 35px;
	line-height: 25px;
	padding-top: 3px;
}

.data_tb td {
	height: 30px;
	line-height: 24px;
	padding-left: 10px;
	border-bottom: 1px dashed #e3e4e6;
	text-align: left;
}

#huankuan {
	text-align: left;
}
</style>


</head>
<body>

	<div class="pop-center overflow-au">
		<!--查询条件  begin-->
		<table width="100%" border="0" cellspacing="0" cellpadding="0">
			<tr valign="bottom" id='trtab1'>
				<td class="tabbody1" id="tabbody1"
					onclick="changeTab('arbdocument');" tabname='mytab'
					style="width: 50%"><div align="center">逾期还款结算清单</div></td>
				<td class="tabbody2" id="tabbody2"
					onclick="changeTab('repayhistory');" tabname='mytab'><div
						align="center">还款历史</div></td>
			</tr>
		</table>
		<!-- -----------------------------------------------------------------客户信息 begin------------------------------------------------------------------ -->
		<div id="arbdocument" class="pop-formDiv clearfix"
			style="margin: 5px; margin-top: 5px;">
			<div>

				<div class="float-l">
					<div class="pop-form-title">客户名称：</div>
					<div class="pop-form-item">
						<input type="text" id="debtor_name" style="width: 200px;"
							maxlength="50" readonly="readonly" />
					</div>
				</div>
				<div class="float-l">
					<div class="pop-form-title">合同编号：</div>
					<div class="pop-form-item">
						<input type="text" id="protocol_code" style="width: 200px;"
							maxlength="50" readonly="readonly" />
					</div>
				</div>
				<div class="float-l">
					<div class="pop-form-title">合同日期：</div>
					<div class="pop-form-item">
						<input type="text" id="protocol_creat_date" style="width: 200px;"
							maxlength="50" />
					</div>
				</div>
				<div class="float-l">
					<div class="pop-form-title">合同金额：</div>
					<div class="pop-form-item">
						<input type="text" id="protocol_amount" style="width: 188px;"
							maxlength="50" readonly="readonly" />元
					</div>
				</div>

				<div class="float-l">
					<div class="pop-form-title">月还款金额：</div>
					<div class="pop-form-item">
						<input type="text" id="refund_limit_month" style="width: 188px;"
							maxlength="50" readonly="readonly" />元
					</div>
				</div>

				<div class="float-l">
					<div class="pop-form-title">已还期数：</div>
					<div class="pop-form-item">
						<input type="text" id="repay_period" style="width: 200px;"
							maxlength="50" readonly="readonly" />
					</div>
				</div>

				<div class="float-l">
					<div class="pop-form-title">已还本金：</div>
					<div class="pop-form-item">
						<input type="text" id="repay_principal" style="width: 188px;"
							maxlength="50" readonly="readonly" />元
					</div>
				</div>
				<div class="float-l">
					<div class="pop-form-title">已还利息：</div>
					<div class="pop-form-item">
						<input type="text" id="repay_interest" style="width: 188px;"
							maxlength="50" readonly="readonly" />元
					</div>
				</div>
				<div class="float-l">
					<div class="pop-form-title">未还期数：</div>
					<div class="pop-form-item">
						<input type="text" id="un_pay_period" style="width: 200px;"
							maxlength="50" readonly="readonly" />
					</div>
				</div>
				<div class="float-l">
					<div class="pop-form-title">剩余本金：</div>
					<div class="pop-form-item">
						<input type="text" id="un_pay_principal" style="width: 188px;"
							maxlength="50" readonly="readonly" />元
					</div>
				</div>
				<div class="float-l">
					<div class="pop-form-title">剩余利息：</div>
					<div class="pop-form-item">
						<input type="text" id="un_pay_interest" style="width: 188px;"
							maxlength="50" readonly="readonly" />元
					</div>
				</div>
				<div class="float-l">
					<div class="pop-form-title">逾期天数：</div>
					<div class="pop-form-item">
						<input type="text" id="cur_overdue_day" style="width: 188px;"
							maxlength="50" readonly="readonly" />天
					</div>
				</div>
				<div class="float-l">
					<div class="pop-form-title">滞纳金额：</div>
					<div class="pop-form-item">
						<input type="text" id="cur_late_fee" style="width: 188px;"
							maxlength="50" readonly="readonly" />元
					</div>
				</div>
				<div class="float-l">
					<div class="pop-form-title">减免额：</div>
					<div class="pop-form-item">
						<input type="text" id="total_derate" style="width: 188px;"
							maxlength="50" readonly="readonly" />元
					</div>

					<div class="float-l  clearboth">
						<div class="pop-form-title"></div>
						<div class="pop-form-item"></div>
					</div>
				</div>
			</div>


			<!-- 添加的虚线 -->
			<div class="line clearboth" id="info_l3"></div>
			<div class="float-l  clearboth">
				<div class="pop-form-title">本期还款总额：</div>
				<div class="pop-form-item">
					<input type="text" id="repay_total" value="" style="width: 188px;"
						readonly="readonly" />元
				</div>
			</div>

			<div class="float-l clearboth">
				<div class="pop-form-title">其中，本金：</div>
				<div class="pop-form-item">
					<input type="text" id="org_repay_principal" value=""
						style="width: 188px;" readonly="readonly" />元
				</div>
			</div>

			<div class="float-l">
				<div class="pop-form-title">利息：</div>
				<div class="pop-form-item">
					<input type="text" id="org_repay_interest" value=""
						style="width: 188px;" readonly="readonly" />元
				</div>
			</div>

			<div class="float-l">
				<div class="pop-form-title">滞纳金：</div>
				<div class="pop-form-item">
					<input type="text" id="cur_late_fee" value="" style="width: 188px;"
						readonly="readonly" />元
				</div>
			</div>
			<div id="der" class="float-l">
				<div class="pop-form-title">减免额：</div>
				<div class="pop-form-item">
					<input type="text" id="derate" value="" isFloat="1"
						maxVal="1000000" minVal="0" scope="a" onkeyup="init_repay_total()"
						style="width: 188px;" />元
				</div>
			</div>

			<!-- 添加的虚线 -->
			<div class="line clearboth" id="info_l3"></div>
		</div>
		<!-- ------------------------------------------------------------------客户信息 end------------------------------------------------------------------ -->
		<!-- ------------------------------------------------------------------还款历史 begin------------------------------------------------------------------ -->
		<div id="repayhistory" class="pop-formDiv clearfix"
			style="margin: 5px; margin-top: 5px; display: none;">
			<div class="float-l">
				<div class="pop-form-title">贷款类型：</div>
				<div class="pop-form-item">
					<input type="text" id="cre_type_name" style="width: 200px;"
						readonly="readonly" />
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">业务员：</div>
				<div class="pop-form-item">
					<input type="text" id="salesman_name" style="width: 200px;"
						readonly="readonly" />
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">客户专员：</div>
				<div class="pop-form-item">
					<input type="text" id="dunning_name" style="width: 200px;"
						readonly="readonly" />
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">合同签约日期：</div>
				<div class="pop-form-item">
					<input id="protocol_creat_date" class="Wdate" type="text"
						onclick="WdatePicker({dateFmt:'yyyy-MM-dd',isShowClear:true})"
						style="vertical-align: top; width: 200px;" readonly="readonly" />
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">放款日：</div>
				<div class="pop-form-item">
					<input id="loan_date" class="Wdate" type="text"
						style="width: 200px;" readonly="readonly" />
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">还款日：</div>
				<div class="pop-form-item">
					<input id="refund_day" type="text" style="width: 200px;"
						readonly="readonly" />
				</div>
			</div>
			<div class="float-l  clearboth">
				<div class="pop-form-title">合同金额：</div>
				<div class="pop-form-item">
					<input type="text" id="protocol_amount" style="width: 188px;"
						readonly="readonly" />元
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">贷款利率：</div>
				<div class="pop-form-item">
					<input type="text" id="borrow_interest" style="width: 188px;"
						readonly="readonly" /> %
				</div>
			</div>
			<!-- 合同表 -->
			<div class="float-l">
				<div class="pop-form-title">贷款期数：</div>
				<div class="pop-form-item">
					<input type="text" id="borrow_deadline" style="width: 200px;"
						readonly="readonly" />
				</div>
			</div>
			<!-- 合同表 -->
			<div class="float-l">
				<div class="pop-form-title">月还款金额：</div>
				<div class="pop-form-item">
					<input type="text" id="refund_limit_month" style="width: 188px;"
						readonly="readonly" />元
				</div>
			</div>
			<!-- 合同表 -->
			<div class="float-l">
				<div class="pop-form-title">已还期数：</div>
				<div class="pop-form-item">
					<input type="text" id="repay_period" style="width: 200px;"
						readonly="readonly" />
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">剩余本金：</div>
				<div class="pop-form-item">
					<input type="text" id="un_pay_principal" style="width: 188px;"
						readonly="readonly" />元
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">还款状态：</div>
				<div class="pop-form-item">
					<input type="text" id="repay_status_name" style="width: 200px;"
						readonly="readonly" />
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">逾期天数：</div>
				<div class="pop-form-item">
					<input type="text" id="cur_overdue_day" style="width: 188px;"
						readonly="readonly" />天
				</div>
			</div>
			<div class="float-l clearboth" style="height: 10px;"></div>
			<div class="center-content clearboth" style="min-width: 500px;">
				<div class="center-txt" style="margin-bottom: 10px;">
					<div id="grid-top"></div>
				</div>
			</div>
		</div>
		<!-- ------------------------------------------------------------------还款历史 end------------------------------------------------------------------ -->


	</div>
	<!-- 提交功能按钮区 -->
	<div class="pop-footer5 clearboth" style="bottom: 1px;" id="tb_btn">
		<input id="tjbtn" onclick="save();" class="btn-saveT"
			onmouseover="this.className='btn-saveT-over'"
			onmouseout="this.className='btn-saveT'"
			onmousedown="this.className='btn-saveT-down'" type="button"
			style="margin-right: 7px;" /> <input id="cancelBtnId"
			class="btn-cancel" onmouseover="this.className='btn-cancel-over'"
			onmouseout="this.className='btn-cancel'"
			onmousedown="this.className='btn-cancel-down'" type="button"
			onclick="closeDialog();" />
	</div>
	<script type="text/javascript">
	// wms_cre_credit_head_id = "101";//问题等待解决
	var wms_cre_credit_head_id = $.query.get("wms_cre_credit_head_id");//wms_cre_credit_head_id 为选择审批的记录id
	var credit_purpose = $.query.get("credit_purpose");//credit_purpose 信用贷款用途
	var taskId = $.query.get("taskId");//credit_purpose 信用贷款用途
	 var wms_fina_cre_pay_id = $.query.get('wms_fina_cre_pay_id');//贷款还款表debtor_name
	 var debtor_name = $.query.get('debtor_name');//贷款还款表客户名称
	var grid_top;
	var grid_top_data = {};
	var grid_state_data = {};
	var sun;//本期应滞纳金
	var wms_post_dunning_head_id=$.query.get('wms_post_dunning_head_id');
	$(function(){
		// 查询逾期确认信息的url arbdocument /loanfina/wmsfinacrerepayinfobyfk.do
			$.getJSON(globalUtil.getTimestampUrl('/loanfina/wmsfinacrerepayinfobyfk.do'),//ctinfo 查询客户信息
			{
				"wms_cre_credit_head_id" : wms_cre_credit_head_id
			},
			function(json) {	
				//逾期还款确认 赋值
				
				globalUtil.setFormVal("arbdocument", json);	
				//初始化客户名称
				init_debtor_name(debtor_name);
				//初始化减免额 设置为0
				init_derate();
				//初始化本期应还款总额
				init_repay_total();
				});
	//初始化贷款还款表中的数据
	$('#repayhistory :input').attr("disabled","disabled");
	initForm();
	//还款历史
	init_top_grid();
	});
	//初始化减免额 设置为0
	function init_derate(){
		 var derate =parseFloat($('#derate').val()||0); //减免额repay_total	
		 $('#derate').val(derate);
	}
	//初始化本期应还款总额
	 function init_repay_total() {
		 if(valiZnje()){
			 return;
			}else{
		 var org_repay_principal =parseFloat($('#org_repay_principal').val()||0)*1000000000000; //本金
		 var org_repay_interest =parseFloat($('#org_repay_interest').val()||0)*1000000000000; //利息
		 var cur_late_fee =parseFloat($('#cur_late_fee').val()||0)*1000000000000; //滞纳金
		 var derate =parseFloat($('#derate').val()||0)*1000000000000; //减免额repay_total
		 var sum=(org_repay_principal+org_repay_interest+cur_late_fee-derate)/1000000000000;
		 sun=(cur_late_fee-derate)/1000000000000;//滞纳金减去减免额
		 $('#repay_total').val(sum);

		 if(sun >= 0? false : true){
			 globalUtil.warnMsg(globalErrorMsg['600101']); //保存失败
		 }
		}
    }
	function valiZnje(){
			clearLigerTip("der");
			var result=false;
			var value = $('#derate').val();
			if(!globalUtil.isFloat(value)){
				result=true;
				$('#derate').ligerTip({distanceX:-140,width:110,content: '减免额不正确！'});
				$('#derate').bind('click',function(){
					$('#derate').ligerHideTip();
				});
			}
			return result;
	}
	//清理指定DIV下的所有LigerTip控件
	function clearLigerTip(divId){
		var elementArr = $("#"+divId+" *");
		jQuery.each(elementArr.get(), function(i, element) {
			$(element).ligerHideTip();
		});
	}
	/**
	*关闭窗口
	*/
    function closeDialog() {
    	//window.parent.search();
		window.parent.dialog.hide();
    }
  //初始化贷款还款表中的数据
	function initForm(){
		$.getJSON(globalUtil.getTimestampUrl('/loanfina/wmsfinacrerepayinfobypk.do'),
				{
					"wms_fina_cre_pay_id" : wms_fina_cre_pay_id
				},
				function(json) {					
					globalUtil.setFormVal("repayhistory", json);//初始化还款历史表单	
					/*initData(json.interest_limit_month);//初始化返利期数，返利金额，减免额
					$('#app_date').val(json.current_repay_date);//初始化申请还款日期
					countTotalAmmont();*/
		});
	}

  //设置text文本 radio 为不可编辑模式
	function lookpage() {			
		
		$("input[type=text]").attr({
			"disabled" : "disabled"
		});
		$("input[type=radio]").attr({
			"disabled" : "disabled"
		});
		//设置文本域不可编辑
		$("textarea[name='overdue_status']").attr({
			"disabled" : "disabled"
		});
		//设置文本域不可编辑
		$("textarea[name='info_update']").attr({
			"disabled" : "disabled"
		});
	}
	// 自动带出   赋值	
	//
	function init_debtor_name(debtor_name){
		var xhd_div = document.getElementById("debtor_name");
		xhd_div.value=debtor_name;
	}
	//还款历史
	function init_top_grid(){
		var columns = [{
			display: '还款期数',
	        name: 'repay_no',
	        resizable: false,
	        width: 21,
	        minWidth: 120
	    }, {
	        display: '还款日期',
	        name: 'repay_date',
	        resizable: false,
	        width: 21,
	        minWidth: 120	
	    }, {
	        display: '还款总额（元）',
	        name: 'repay_total',
	        resizable: false,
	        width: 21,
	        minWidth: 120
	    }, {
	        display: '其中，本金（元）',
	        name: 'repay_principal',
	        resizable: false,
	        width: 21,
	        minWidth: 120
	    },{
	        display: '利息（元）',
	        name: 'repay_interest',
	        resizable: false,
	        width: 21,
	        minWidth: 120
	    },{
	        display: '滞纳金（元）',
	        name: 'cur_late_fee',
	        resizable: false,
	        width: 21,
	        minWidth: 120
	    },{
        	display: '减免额（元）',
            name: 'derate',
            width: 100,
            minWidth: 120
	        }];
		
	    grid_top = $("#grid-top").ligerGrid({
	    	columns: columns,
	    	url: global_param.context_name + '/loanpost/wmsfinacreperiodrepaywithoutpaginglist.do?wms_cre_credit_head_id='+wms_cre_credit_head_id,
	    	sortName: 'create_timestamp', // 排序列名
			sortOrder: 'asc', // 排序方式
    		rownumbers: true,
    		allowUnSelectRow: true,
    		usePager: false,
    		width: '100%',
    		height: 180,
    		heightDiff: -4
	    });
	}

		
//************************************保存数据函数开始******************************************/

  //保存
    function save(approveWorkFlowVO){
		var paramCtinfo={};
		//判断减免额是否正确
    	if(valiZnje()){
			 return;
		}
		//判断减免额是否大于滞纳金
    	 if(sun >= 0? false : true){
			 globalUtil.warnMsg(globalErrorMsg['600101']); //保存失败
		 }else{
    		paramCtinfo = globalUtil.getFormParam("arbdocument");//确认信息
    		if(wms_post_dunning_head_id!=undefined){
    			paramCtinfo.wms_post_dunning_head_id=wms_post_dunning_head_id;
    		}
			$.post(globalUtil.getTimestampUrl("/loanfina/wmsfinacrerepayupdateInfo.do?wms_cre_credit_head_id="+wms_cre_credit_head_id), paramCtinfo,
				function(data) {
        			if (data === 'success') {
            	 		globalUtil.successMsg(globalErrorMsg['100002'],
            			 function(){            		 		
                			refreshAndClosePage();
            	 		});//保存成功
            	 
            		}else {
                		globalUtil.errorMsg(globalErrorMsg['100012']); //保存失败
           		 	}
		
        });}
    }
/************************************************保存数据函数结束****************************/
 	//关闭本页并刷新查询页面
    function refreshAndClosePage(){   
    	window.parent.location.reload();
    	closePage();
    }
 	//关闭页面
    function closePage(){
    	window.parent.dialog.hide();
    }
    

////****************************去掉空数据 并格式化日期****************************
    /*
    获取表格数据，去除全部为空的记录
*/
function getGrid(grid){
	grid.endEdit();
 var data_all = grid.getData();
 var griddata = [];
 for(var i=0;i<data_all.length;i++){
 	var data = data_all[i];
 	var isEmpty = true;
 	if(data){
			for(var key in data){
				if($.trim(key) == '' || $.trim(key) == '__status'){continue;}
				if(!globalUtil.isEmpty(data[key])){
					if(data[key] instanceof Date){
						data[key]= data[key].format('yyyy-MM-dd');//格式化日期类型数据
					}
					isEmpty = false;
				}
			}
		}
		if(!isEmpty){
			griddata.push(data);
		}
 }
 return griddata;
}

 
/////////////////****************************时间函数********************************/
			//页面切换
	        function changeTab(id) {
	    		var arbdocument = document.getElementById("arbdocument"); //提前还款结清单tab
	    		var repayhistory = document.getElementById("repayhistory"); //还款历史tab
	    		

	    		if (id == 'arbdocument') {
	    			document.getElementById("tabbody1").className = "tabbody1";
	    			document.getElementById("tabbody2").className = "tabbody2";
	    			
	    			arbdocument.style.display = '';
	    			repayhistory.style.display = 'none';
	    			
	    		} else if (id == 'repayhistory') {
	    			document.getElementById("tabbody1").className = "tabbody2";
	    			document.getElementById("tabbody2").className = "tabbody1";
	    		
	    			arbdocument.style.display = 'none';
	    			repayhistory.style.display = '';
	    			clearLigerTip("der");
	    		} 
	    	}
	    
</script>
</body>
</html>
