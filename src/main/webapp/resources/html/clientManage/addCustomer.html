<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>新增客户</title>
<link href="../../css/zx-all.css" rel="stylesheet" type="text/css"/>
<script src="../../js/zx-all.js" type="text/javascript"></script>
<style type="text/css">
/*input_tb css*/
.input_tb{
	border:1px solid #d5d5d5;
	width:100%;
	margin-bottom:10px;
}
.input_tb a{
	color:#056aff;
	text-decoration:none;
	font-weight:normal;
}
.input_tb td{
	height:35px;
	line-height:25px;
	border-bottom:1px dashed #dfdfdf;
	padding-top:3px;
}
.input_tb .tr_title td{
	background-color:#f5f8ff;
	padding-left:16px;
	font-weight:bold;
	height:30px;
	line-height:30px;
	border-bottom:1px solid #d5d5d5;
}
.input_tb .tr_last td{
    border-bottom:0;
}
.input_tb .title{
    text-align:right;
}
.input_tb .title1{
    text-align:right; border-top:1px solid #d5d5d5;
}
.input_tb .text1 {
    border-top:1px solid #d5d5d5;
}
.input_tb .subtitle{
	text-align:left;
	background-color:#d2e1fd;
	border-top:1px solid #fff;
	border-left:1px solid #fff;
}
.input_tb .tr_btn_input td{
    background-color:#fbfbfb;
    height:40px;
}
textarea {
	resize:none;
}
</style>

</head>
<body>
<div class="tab_titleT">
	<table width="100%" border="0" cellspacing="0" cellpadding="0">                                                                                                                                                                                                                    
		<tr valign="bottom" id='trtab1'>
			<td class="tabbody1" id="tabbody1" onclick="changeTab('khinfo');">
			    <div align="center" id="khinfo_div" class="tab_step tab_step101">客户资料</div>
			</td>
			<td class="tabbody3" id="tabbody3" onclick="changeTab('fcinfo');">
			    <div align="center" id="fcinfo_div" class="tab_step tab_step202">房产信息</div>
			</td>
			<td class="tabbody2" id="tabbody2" onclick="changeTab('gzinfo');">
			    <div align="center" id="gzinfo_div" class="tab_step tab_step302">工作信息</div>
			</td>
		</tr>
	</table>
</div>
<div class="pop-center overflow-au" style="top:30px;" id="main">
	<div id="khinfo" class="pop-formDiv clearfix" style="margin:5px;margin-top:25px;">
		<table width="100%" border="0" cellspacing="0" cellpadding="0">
			<tr>
				<td>
					<div class="float-l">
						<div class="pop-form-title">
						    <span class="redstar">*</span>客户姓名：</div>
						<div class="pop-form-item">
						    <input type="text" id="customer_name" maxlength="20" /></div>
					</div>
				</td>
				<td>
					<div class="float-l">
						<div class="pop-form-title">身份证号：</div>
						<div class="pop-form-item">
						    <input type="text" id="id_card" maxlength="18" onblur="checkIdCard()" />
						</div>
					</div> 
				</td>
				<td>
					<div class="float-l">
						<div class="pop-form-title">出生日期：</div>
						<div class="pop-form-item">
						    <input id="birthday" class="Wdate" type="text"
							  onclick="WdatePicker({dateFmt:'yyyy-MM-dd',isShowClear:true})"
							  style="vertical-align: top;" onchange="checkIdAndBirth()" />
					    </div>
						<div id="idcdiv"></div>
					</div>
				</td>
			</tr>
			<tr>
				<td>
					<div class="float-l">
						<div class="pop-form-title">性 别：</div>
						<div class="pop-form-item" style="line-height:22px;">
							<input type="radio" name="gender" value="1" class="radio3" />男
							<input type="radio" name="gender" value="0" class="radio3" />女
					    </div>
					</div>
				</td>
				<td>
                    <div class="float-l clearboth">
                        <div class="pop-form-title">婚姻状况：</div>
                        <div class="pop-form-item">
                        <select id="has_married" name="has_married" style="width: 135px;">
                            <option selected="selected" value="0">请选择</option>
                            <option value="yh">已婚</option>
                            <option value="wh">未婚</option>
                            <option value="ly">离异</option>
                            <option value="so">丧偶</option>
                        </select>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="float-l">
                        <div class="pop-form-title">手机号码1：
                        </div>
                        <div class="pop-form-item">
                            <input type="text" id="mobile_telephone1" maxlength="20" onchange="checkPhone1()" />
                        </div>
                    </div>
                </td>
			</tr>
			<tr>
			    <td>
                    <div class="float-l">
                        <div class="pop-form-title">手机号码2：</div>
                        <div class="pop-form-item">
                            <input type="text" id="mobile_telephone2" maxlength="20" onchange="checkPhone2()" />
                        </div>
                    </div>
                </td>
                <td>
                    <div class="float-l">
                        <div class="pop-form-title">居住地固话：</div>
                        <div class="pop-form-item">
                            <input type="text" id="fixed_telephone" maxlength="20" />
                        </div>
                    </div>
                </td>
                <td>
                    <div class="float-l">
                         <div class="pop-form-title">居住时间：</div>
                         <div class="pop-form-item"><input type="text" id="residence_time" maxlength="50" />年</div>
                    </div>
                </td>
			</tr>
			<tr>
                <td colspan="2">
                    <div class="float-l clearboth">
                        <div class="pop-form-title">共同居住者：</div>
                        <div class="pop-form-item" style="line-height:22px;">
                            <input type="checkbox" id="co1" name="common_occupants" value="fm" class="radio3" />父母 
                            <input type="checkbox" id="co2" name="common_occupants" value="po" class="radio3" />配偶
                            <input type="checkbox" id="co3" name="common_occupants" value="zn" class="radio3" />子女
                            <input type="checkbox" id="co4" name="common_occupants" value="py" class="radio3" />朋友
                            <input type="checkbox" id="co5" name="common_occupants" value="dj" class="radio3" />独居
                            <input type="checkbox" id="co6" name="common_occupants" value="qt" class="radio3" />其他
                        </div>
                    </div>
                </td>
            </tr>
            <tr>
                <td colspan="3">
                    <div class="float-l">
                        <div class="pop-form-title">现居地址：</div>
                        <div class="pop-form-item">
                            <input type="text" id="current_address_province" maxlength="20" />省
                            <input type="text" id="current_address_city" maxlength="20" />市
                            <input type="text" id="current_address_district" maxlength="20" />区（县）
                            <input type="text" id="current_address_more" maxlength="50" style="width: 200px" />
                        </div>
                    </div>
                </td>
            </tr>
			<tr>
				<td colspan="3">
					<div class="float-l clearboth">
						<div class="pop-form-title">户口地址：</div>
						<div class="pop-form-item">
							<input type="text" id="province" maxlength="20" />省
							<input type="text" id="city" maxlength="20" />市
							<input type="text" id="district" maxlength="20" />区（县）
							<input type="text" id="address_more" maxlength="50" style="width: 200px" />
						</div>
					</div>
				</td>
			</tr>
		</table>
		<div class="center-content clearboth" style="min-width:470px;">
	        <div class="center-title">子女信息</div>
				<div class="center-txt" style="margin-bottom:5px;">
		            <div id="centertoolbar" class="minwidth400"></div>
		            <div id="grid"></div>
	        	</div>
	        </div>
		</div>
	    <!-- 客户信息结束 -->
	    <!-- 房产信息开始 -->
        <div id="fcinfo" class="pop-formDiv clearfix" style="margin:5px;margin-top:25px;display:none">
            <table cellspacing="1" cellpadding="1" width="100%" class="input_tb">
                <tr>
                    <td width="10%" class="title1">购买时间：</td>
                    <td width="20%" align="left" class="text1">
                        <input type="hidden" id="wms_cus_customer_line_houseinfo_id" class="hidden" value="0" />
                        <input id="house_buy_date" name="house_buy_date" class="Wdate" type="text" onclick="WdatePicker({dateFmt:'yyyy-MM-dd',isShowClear:true})" style="width: 150px; vertical-align: top;" />
                    </td>
                    <td width="10%" class="title1">购买金额：</td>
                    <td width="20%" align="left" class="text1">
                        <input type="text" style="width: 150px; "id="house_buy_money" name="house_buy_money" maxlength="18" />万元
                    </td>
                    <td width="10%" class="title1">
                        <span class="redstar">*</span>建筑面积：
                    </td>
                    <td width="20%" align="left" class="text1">
                        <input type="text" style="width: 150px;" id="house_building_area" name="house_building_area" maxlength="18" />M²
                    </td>
                </tr>
                <tr>
                    <td width="10%" class="title1">名下房产：
                    </td>
                    <td width="20%" align="left" class="text1">
                        <input type="text" style="width: 150px;" id="houses_number" name="houses_number" />
                    </td>
                    <td width="10%" class="title">提供房证原件：</td>
                    <td width="20%" align="left">
                        <select id="is_supp_house_card" name="is_supp_house_card" name="is_supp_house_card" style="width: 152px;">
                            <option value="">请选择</option>
                            <option value="1">是</option>
                            <option value="2">否</option>
                        </select>
                    </td>
                    <td width="10%" class="title">房产类型：</td>
                    <td width="20%" align="left">
                        <input type="text" style="width: 150px;" id="house_type" name="house_type" maxlength="50" />
                    </td>
                </tr>
                <tr>
                    <td width="10%" class="title">房产证号：</td>
                    <td width="20%" align="left">
                        <input type="text" style="width: 150px;" id="house_no" name="house_no" maxlength="50" />
                    </td>
                    <td width="10%" class="title">房产卷号：</td>
                    <td width="20%" align="left">
                        <input type="text" style="width: 150px;" id="house_vol_no" name="house_vol_no" maxlength="50" />
                    </td>
                    <td width="10%" class="title">
                        <span class="redstar">*</span>小区名称：
                    </td>
                    <td width="20%" align="left">
                        <input type="text" style="width: 150px;" id="community_name" name="community_name" maxlength="100" />
                    </td>
                </tr>
                 <tr>
                    <td width="10%" class="title">是否复式：</td>
                    <td width="20%" align="left">
                        <select id="is_compound" name="is_compound"  style="width: 152px;">
                            <option value="0">否</option>
                            <option value="1">是</option>
                        </select>
                    </td>
                    <td width="10%" class="title">
                        	房屋房龄：
                    </td>
                    <td width="20%" align="left">
                        <input type="text" style="width: 150px;" id="house_age" name="house_age" maxlength="5" /> 年
                    </td>
                </tr>
                <tr>    
                    <td width="10%" class="title">
                        <span class="redstar">*</span>抵押房产地址：</td>
                    <td width="90%" colspan="5" align="left">
                        <input type="text" style="width: 439px;" id="house_address_more" name="house_address_more" maxlength="50" />
		                <input type="hidden" id="wms_cre_customer_change_line_houseinfo_id" name="wms_cre_customer_change_line_houseinfo_id" />
                    </td>
                </tr>
                <tr>    
                    <td width="10%" class="title">
                      	 备注：
                    </td>
                    <td width="90%" colspan="5" align="left">
                        <textarea id="house_remark" name="house_remark" style="width: 740px; height: 80px;" class="readonly" ></textarea>
                    </td>
                </tr>
            </table>
        </div>
        <!-- 房产信息结束 -->
        <!-- 工作信息开始 -->
		<div id="gzinfo" class="pop-formDiv clearfix" style="margin:25px 5px 5px; display:none">
			<table border="0" cellspacing="1" cellpadding="1" width="100%">
				<tr>
					<td colspan="2">
						<div class="float-l">
							<div class="pop-form-title">单位全称：</div>
							<div class="pop-form-item">
							    <input type="text" id="work_unit_full_name" maxlength="50" style="width: 411px" />
							</div>
						</div>
					</td>
					<td>
						<div class="float-l">
							<div class="pop-form-title">单位电话：</div>
							<div class="pop-form-item">
							    <input type="text" id="work_unit_telephone" maxlength="20" />
							</div>
						</div>
					</td>
				</tr>
				<tr>
					<td>
						<div class="float-l" style="width: 257px">
							<div class="pop-form-title">进入单位时间：</div>
							<div class="pop-form-item">
							    <input id="work_unit_entry_date" class="Wdate" type="text" onclick="WdatePicker({dateFmt:'yyyy-MM-dd',isShowClear:true})" />
						    </div>
						</div>
					</td>
					<td>
						<div class="float-l" style="margin-left: 20px">
							<div class="pop-form-title">所在部门/处室：</div>
							<div class="pop-form-item">
							    <input type="text" id="work_unit_department" maxlength="50" />
							</div>
						</div>
					</td>
					<td>
						<div class="float-l">
							<div class="pop-form-title">担任职务：</div>
							<div class="pop-form-item">
							    <input type="text" id="work_unit_duty" maxlength="50" />
							</div>
						</div>
					</td>
				</tr>
				<tr>
                    <td width="15%">
                        <div class="float-l">
                            <div class="pop-form-title">单位性质：</div>
                            <div class="pop-form-item">
                                <select id="work_unit_property" name="work_unit_property">
                                    <option selected="selected" value="0">请选择</option>
                                    <option value="gy">国营</option>
                                    <option value="my">民营</option>
                                    <option value="sy">私营</option>
                                    <option value="sz">三资</option>
                                    <option value="hh">合伙</option>
                                    <option value="gt">个体</option>
                                    <option value="qt">其他</option>
                                </select>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="float-l" style="margin-left: 20px">
                            <div class="pop-form-title">经营场所：</div>
                            <div class="pop-form-item">
                                <select name="place_of_comp" id="place_of_comp">
		                            <option value="">请选择</option>
		                            <option value="zy">自有</option>
		                            <option value="zl">租赁</option>
		                            <option value="qt">其他</option>
		                        </select>
                            </div>
                        </div>
                    </td>
                </tr>
				<tr>
					<td colspan="3">
                        <div class="float-l">
                            <div class="pop-form-title">所属行业：</div> 
                            <div class="trade" align="left" style="line-height:22px;">
                                <input type="checkbox" id="co1" name="comp_industry" value="ny" class="radio3" />农业
                                <input type="checkbox" id="co2" name="comp_industry" value="fwy" class="radio3" />服务业
                                <input type="checkbox" id="co3" name="comp_industry" value="jtysy" class="radio3" />交通运输业
                                <input type="checkbox" id="co4" name="comp_industry" value="pflsy" class="radio3" />批发零售业
                                <input type="checkbox" id="co5" name="comp_industry" value="jzy" class="radio3" />建筑业
                                <input type="checkbox" id="co5" name="comp_industry" value="qt" class="radio3" />其他
                            </div>
                        </div>
                    </td>
				</tr>
				<tr>    
                    <td colspan="3">
                        <div class="float-l">
                            <div class="pop-form-title">单位地址：</div> 
                            <div class="pop-form-item">
                                <input type="text" style="width: 120px;" id="compt_address_province" maxlength="20" />省
		                        <input type="text" style="width: 120px;" id="comp_address_city" maxlength="20" />市
		                        <input type="text" style="width: 120px;" id="comp_address_district" maxlength="50" />区（县）
		                        <input type="text" style="width: 275px;" id="comp_address_more" maxlength="50" />
                            </div>
                        </div>
                    </td>
                </tr>
			</table>
		</div>
	    <!-- 工作信息结束 -->
	</div>
	<div class="pop-footer5 clearboth">
	    <input id="save" class="btn-saveT" onmouseover="this.className='btn-saveT-over'" onmouseout="this.className='btn-saveT'" onmousedown="this.className='btn-saveT-down'" type="button" style="margin-right:7px;" />
        <input id="cancelBtnId" class="btn-cancel" onmouseover="this.className='btn-cancel-over'" onmouseout="this.className='btn-cancel'" onmousedown="this.className='btn-cancel-down'" type="button" />
	</div>
<script type="text/javascript">

var type = $.query.get('type');//0:新增 1:修改 2:查看
var wms_cre_credit_line_customer_change_head_id = $.query.get('wms_cre_credit_line_customer_change_head_id');
var wms_cre_credit_head_id = $.query.get('wms_cre_credit_head_id');
var is_major = $.query.get('is_major');
var customerInfo = {};//客户信息
var childInfo = {};//子女信息
var houseInfo = [];//房产信息
var workInfo = {};//工作信息
var companyInfo = {};//公司信息(与工作信息存在不同表里)

var prevIdCard;

var userProvince = '', userCity = '';

var deleteChildId = [];

var isCommit = false;//是否已经按过了提交按钮
var isZanCun = false;//是否已经按过了暂存按钮

var reqVO = {};//请求数据 
reqVO.type = type;

jQuery(function($){
	
	
	var userInfo = [];
	userInfoStr = globalUtil.syncGetJson('/cusmanage/wmscuscustomergetproandcity.do', {}, 'POST');
    userInfo = userInfoStr.split("@@@@");
    //获得省
    userProvince = userInfo[0];
    //获得市
    userCity = userInfo[1];

	if (type == 0) {//新增
		
	} else if (type == 1) {//修改
		var wms_cre_credit_line_customer_change_head_id = $.query.get('wms_cre_credit_line_customer_change_head_id');
		index = $.query.get('index');
	
		searchCustomerAllInfo(wms_cre_credit_line_customer_change_head_id);//查询客户所有信息

		setCustomerVal(customerInfo);//客户信息赋值
		
		if(houseInfo.length > 0) {
			setHouseVal(houseInfo[0]);//房产信息赋值
		} else {
			houseInfo = [];
		}
		
		if(typeof(workInfo) != 'undefined') {
			setWorkVal(workInfo);//工作信息赋值
		} else {
			workInfo = {};
        }
		
		if(typeof(companyInfo) != 'undefined') {
			setCompanyVal(companyInfo);//公司信息赋值
        } else {
        	companyInfo = {};
        }
		
		prevIdCard = customerInfo.id_card;
		
	} else if(type == 2) {//查看
		var wms_cre_credit_line_customer_change_head_id = $.query.get('wms_cre_credit_line_customer_change_head_id');
        searchCustomerAllInfo(wms_cre_credit_line_customer_change_head_id);//查询客户所有信息
        
        setCustomerVal(customerInfo);//客户信息赋值
        setHouseVal(houseInfo[0]);//房产信息赋值
        setWorkVal(workInfo);//工作信息赋值
        setCompanyVal(companyInfo);//公司信息赋值
        
        //不可编辑
        $('#main input[type=text]').attr('readonly', 'readonly');
        $('#main select').attr('disabled', 'disabled');
        $('#main input[type=radio],#main input[type=checkbox]').attr('disabled', 'disabled');
        $('#main textarea').attr('readonly', 'readonly');
        $("#house_buy_date").removeAttr("onclick");//购房时间去掉点击事件
        $("#birthday").removeAttr("onclick");//时间去掉点击事件
        $("#work_unit_entry_date").removeAttr("onclick");//时间去掉点击事件
        $('#centertoolbar').hide();//隐藏子女信息新增删除按钮
        //隐藏"提交" "暂存" 按钮
        $('#save').hide();
	}
	
	initGrid();//初始化子女信息列表
	
	//添加房产信息
	$('#addHouse').click(function(){
		addHouse();
	});
	
	//删除房产信息
	$(document).on('click', '.removeHouse', function(){
		$(this).closest('table').remove();
	});
	
	//保存
    $('#save').click(function() {
    	
    	var flag = true;
    	
    	houseInfo = [];//重置房产信息
    	
    	//获取客户信息
    	customerInfo.wms_cre_credit_head_id = wms_cre_credit_head_id;
    	customerInfo.is_major = is_major;
    	customerInfo.is_major_str = ((is_major == 1) ? '是' : '否');
    	customerInfo.customer_name = $('#customer_name').val();
    	customerInfo.id_card = $('#id_card').val();
    	customerInfo.birthday = $('#birthday').val() == '' ? null : $('#birthday').val();
    	customerInfo.gender = $('input[name=gender]:checked').val();
    	
    	var common_occupants = new Array();
    	$('input[name=common_occupants]:checked').each(function(){
    		common_occupants.push($(this).val());
    	});
    	customerInfo.common_occupants = common_occupants.join(",");
    	
    	customerInfo.has_married = $('#has_married').val();
    	customerInfo.mobile_telephone1 = $('#mobile_telephone1').val();
    	customerInfo.mobile_telephone2 = $('#mobile_telephone2').val();
    	customerInfo.fixed_telephone = $('#fixed_telephone').val();
    	customerInfo.residence_time = $('#residence_time').val();
    	customerInfo.current_address_province = $('#current_address_province').val();
    	customerInfo.current_address_city = $('#current_address_city').val();
    	customerInfo.current_address_district = $('#current_address_district').val();
    	customerInfo.current_address_more = $('#current_address_more').val();
    	customerInfo.province = $('#province').val();
    	customerInfo.city = $('#city').val();
    	customerInfo.district = $('#district').val();
    	customerInfo.address_more = $('#address_more').val();
    	
    	//获取子女信息
    	childInfo = grid.getData();
    	
    	//获取房产信息
    	var tempHouseInfo = {};
    	$('#fcinfo .input_tb').each(function(i, o){
    		tempHouseInfo = {};
    		tempHouseInfo.house_buy_date = $(o).find('input[name=house_buy_date]').val();
    		tempHouseInfo.house_buy_money = $(o).find('input[name=house_buy_money]').val();
    		tempHouseInfo.house_building_area = $(o).find('input[name=house_building_area]').val();
    		tempHouseInfo.houses_number = $(o).find('input[name=houses_number]').val();
    		tempHouseInfo.house_count = $(o).find('input[name=house_count]').val();
    		tempHouseInfo.is_supp_house_card = $(o).find('[name=is_supp_house_card]').val();
    		tempHouseInfo.house_type = $(o).find('input[name=house_type]').val();
    		tempHouseInfo.house_no = $(o).find('input[name=house_no]').val();
    		tempHouseInfo.house_vol_no = $(o).find('input[name=house_vol_no]').val();
    		tempHouseInfo.community_name = $(o).find('input[name=community_name]').val();
    		tempHouseInfo.house_address_more = $(o).find('input[name=house_address_more]').val();
    		
    		tempHouseInfo.is_compound = $(o).find('select[name=is_compound]').val();
    		tempHouseInfo.house_remark = $(o).find('textarea[name=house_remark]').val();
    		tempHouseInfo.house_age = $(o).find('input[name=house_age]').val();
    		if($(o).find('input[name=wms_cre_customer_change_line_houseinfo_id]').val() != '') {
	   			tempHouseInfo.wms_cre_customer_change_line_houseinfo_id = $(o).find('input[name=wms_cre_customer_change_line_houseinfo_id]').val();
    		}
    		houseInfo.push(tempHouseInfo);
    	});

    	//获取工作信息
    	workInfo.work_unit_full_name = $('#work_unit_full_name').val();
    	workInfo.work_unit_telephone = $('#work_unit_telephone').val();
    	workInfo.work_unit_entry_date = $('#work_unit_entry_date').val();
    	workInfo.work_unit_department = $('#work_unit_department').val();
    	workInfo.work_unit_duty = $('#work_unit_duty').val();
    	workInfo.work_unit_property = $('#work_unit_property').val();
    	
    	//获取公司信息
    	companyInfo.place_of_comp = $('#place_of_comp').val();//经营场所
    	
    	var comp_industry = new Array();
        $('input[name=comp_industry]:checked').each(function(){
        	comp_industry.push($(this).val());
        });
    	companyInfo.comp_industry = comp_industry.join(",");//所属行业
    	companyInfo.compt_address_province = $('#compt_address_province').val();
    	companyInfo.comp_address_city = $('#comp_address_city').val();
    	companyInfo.comp_address_district = $('#comp_address_district').val();
    	companyInfo.comp_address_more = $('#comp_address_more').val();
    	
    	if(reqVO.type == 1) {
            reqVO.deleteChildId = deleteChildId;
            
            //去除所有的时间(后台转换时会报错)
            customerInfo = removeDateDataForObj(customerInfo);
            childInfo = removeDateDataForArr(childInfo);
            houseInfo = removeDateDataForArr(houseInfo);
            workInfo = removeDateDataForObj(workInfo);
            companyInfo = removeDateDataForObj(companyInfo);
        }

    	//校验客户信息
    	flag = validCustomerInfo();
    	if(flag) {
	   		//校验房产信息
	        flag = validHouseInfo();
    		if(flag) {
		    	//校验工作信息
		        flag = validWorkInfo();
    		}
    	}
                
    	if (!flag) {
    		return false;
    	}
    	
    	//去除全为空的数据(客户、子女、房产、工作、公司)
   		reqVO.customerInfo = JSON.stringify(customerInfo);//客户信息
    	
    	if(isHaveNotNull(childInfo)) {
    		reqVO.childInfo = JSON.stringify(childInfo);//子女信息
        }
    	
    	for(var i = 0; i < houseInfo.length; i++) {
    		if(!isHaveNotNull(houseInfo[i])) {
    			houseInfo.remove(i);
    		}
    	}
    	if(houseInfo.length > 0) {
	    	reqVO.houseInfo = JSON.stringify(houseInfo);//房产信息
    	}
    	
    	reqVO.workInfo = JSON.stringify(workInfo);//工作信息
    	reqVO.companyInfo = JSON.stringify(companyInfo);//公司信息

    	$.ajax({ 
            type: "POST", 
            url: global_param.context_name + "/cusmanage/wmsCustomerSave.do",
            async: false,
            dataType: "json",
            data: reqVO, 
            traditional: true,
            success: function(data) {
                var result = data.result;
                if(result == 'success') {
                	customerInfo.wms_cre_credit_line_customer_change_head_id = data.wms_cre_credit_line_customer_change_head_id;
                	//保存成功
                	globalUtil.successMsg(globalErrorMsg['100002'], function() {
                		window.parent.saveCustomer(customerInfo, is_major, houseInfo, type);
                        window.parent.scfcDialog.close();
                    });
                } else if(result == 'error') {
                	//保存失败
                	globalUtil.errorMsg(globalErrorMsg['100012']);
                }
            }
        });
    	
    });
	
	//取消
	$('#cancelBtnId').click(function(){
		window.parent.scfcDialog.close();
	});
	
});

//查询客户信息(客户、子女、房产、工作、公司)
function searchCustomerAllInfo(wms_cre_credit_line_customer_change_head_id) {
	$.ajax({ 
        type: "POST", 
        url: global_param.context_name + "/cremanage/searchAllCustomerInfo.do",
        async: false,
        dataType: "json",
        data: { 
        	wms_cre_credit_line_customer_change_head_id : wms_cre_credit_line_customer_change_head_id 
        }, 
        success: function(data) {
        	customerInfo = data.customerInfo;//客户信息
        	childInfo.Rows = data.childInfo;//子女信息
        	houseInfo = data.houseInfo;//房产信息
        	workInfo = data.workInfo[0];//工作信息
        	companyInfo = data.companyInfo[0];//公司信息(与工作信息存在不同表里)
        }
    });
}

//客户信息赋值
function setCustomerVal(customerInfo) {
	if(customerInfo!=null&&customerInfo!=undefined){
		$('#customer_name').val(customerInfo.customer_name);
	    $('#id_card').val(customerInfo.id_card);
	    $('#birthday').val(customerInfo.birthday);
	    $('input[name=gender][value=' + customerInfo.gender + ']').attr('checked', 'checked');
	    
	    if(customerInfo.common_occupants != null && typeof(customerInfo.common_occupants) != 'undefined') {
	    	var common_occupants = customerInfo.common_occupants.split(",");
	        $('input[name=common_occupants]').each(function(i1, o1){
	            $(common_occupants).each(function(i2, o2) {
	                if($(o1).val() == o2) {
	                    $(o1).attr('checked', 'checked');
	                }
	            });
	        });
	    }
	    
	    $('#has_married').val(customerInfo.has_married);
	    $('#mobile_telephone1').val(customerInfo.mobile_telephone1);
	    $('#mobile_telephone2').val(customerInfo.mobile_telephone2);
	    $('#fixed_telephone').val(customerInfo.fixed_telephone);
	    $('#residence_time').val(customerInfo.residence_time);
	    $('#current_address_province').val(customerInfo.current_address_province);
	    $('#current_address_city').val(customerInfo.current_address_city);
	    $('#current_address_district').val(customerInfo.current_address_district);
	    $('#current_address_more').val(customerInfo.current_address_more);
	    $('#province').val(customerInfo.province);
	    $('#city').val(customerInfo.city);
	    $('#district').val(customerInfo.district);
	    $('#address_more').val(customerInfo.address_more);
	}
}

//房产信息赋值
function setHouseVal(houseInfo) {
	if(houseInfo!=null&&houseInfo!=undefined){
	    $('#house_buy_date').val(houseInfo.house_buy_date);
	    $('#house_buy_money').val(houseInfo.house_buy_money);
	    $('#house_building_area').val(houseInfo.house_building_area);
	    $('#houses_number').val(houseInfo.houses_number);
	    $('#house_count').val(houseInfo.house_count);
	    $('#is_supp_house_card').val(houseInfo.is_supp_house_card);
	    $('#house_type').val(houseInfo.house_type);
	    $('#house_no').val(houseInfo.house_no);
	    $('#house_vol_no').val(houseInfo.house_vol_no);
	    $('#community_name').val(houseInfo.community_name);
	    $('#house_address_more').val(houseInfo.house_address_more);
	    $('#wms_cre_customer_change_line_houseinfo_id').val(houseInfo.wms_cre_customer_change_line_houseinfo_id);
	    
	    $('#house_age').val(houseInfo.house_age);
	    $('#house_remark').val(houseInfo.house_remark);
	    $('#is_compound').val(houseInfo.is_compound);
	}
}

//工作信息赋值
function setWorkVal(workInfo) {
	if(workInfo!=null&&workInfo!=undefined){
		 $('#work_unit_full_name').val(workInfo.work_unit_full_name);
	     $('#work_unit_telephone').val(workInfo.work_unit_telephone);
	     $('#work_unit_entry_date').val(workInfo.work_unit_entry_date);
	     $('#work_unit_department').val(workInfo.work_unit_department);
	     $('#work_unit_duty').val(workInfo.work_unit_duty);
	     $('#work_unit_property').val(workInfo.work_unit_property);
	}
}

//公司信息赋值
function setCompanyVal(companyInfo) {
	if(companyInfo!=null&&companyInfo!=undefined){
		$('#place_of_comp').val(companyInfo.place_of_comp);//经营场所
		
		if(typeof(companyInfo.comp_industry) != 'undefined') {
			var comp_industry = companyInfo.comp_industry.split(",");//所属行业
		    $('input[name=comp_industry]').each(function(i1, o1){
		        $(comp_industry).each(function(i2, o2) {
		            if($(o1).val() == o2) {
		                $(o1).attr('checked', 'checked');
		            }
		        });
		    });
		}
		$('#compt_address_province').val(companyInfo.compt_address_province);
	    $('#comp_address_city').val(companyInfo.comp_address_city);
	    $('#comp_address_district').val(companyInfo.comp_address_district);
	    $('#comp_address_more').val(companyInfo.comp_address_more);
	}
}

function checkIdCard() {
    var idc = $("#id_card");
    if(idc.val() != '') {
        if(!globalUtil.isIdCard(idc.val())) {
            $(idc).parent().addClass("position-re");
            $(idc).ligerTip({isabsolute: true, absleft: 135, width: 120, content: "身份证号不正确！"});
            return false;
        }
        var idDat = globalUtil.syncGetJson('/cusmanage/wmscuscustomerheadwithoutpaginglist.do', {
            'id_card': idc.val(),// 身份证号
            'sortname':'wms_cus_customer_id',
            'sortorder':'asc'
        },'POST');
        if(idDat.Rows.length > 0) {
            if(wms_cus_customer_id != idDat.Rows[0].wms_cus_customer_id && (prevIdCard != idc.val())){
                $(idc).parent().addClass("position-re");
                var lf = $(idc).parent().width();
                $(idc).ligerTip({isabsolute: true, absleft: 135, width: 120, content: "身份证号已存在！"});
                $("#tjbtn").css("display","none");//隐藏按钮 
                $("#zcbtn").css("display","none");//隐藏按钮 
                return false;
            }
        } else {
            $(idc).ligerHideTip();
            $("#tjbtn").css("display", "");//显示按钮 
            $("#zcbtn").css("display", "");//显示按钮 
        }
    } else {
        if(!isCommit) {
            $(idc).ligerHideTip();
        }
        $("#tjbtn").css("display", "");//显示按钮 
        $("#zcbtn").css("display", "");//显示按钮 
    }
    //手动输入身份证号时自动计算生日和性别
    setBirthday();
    checkIdAndBirth();
    return true;
}

//手动输入身份证号时自动计算生日和性别
function setBirthday() {
    /* var idc = $("#id_card").val();
    var birstr = idc.substr(6, 4) + "-" + idc.substr(10, 2) + "-" + idc.substr(12, 2);
    $("#birthday").val(birstr); */
    /* var sex = idc.substr(16, 1);
    if(sex % 2 == 0) {
        $("input[name='gender'][value=0]").attr("checked", true); 
    }else{
        $("input[name='gender'][value=1]").attr("checked", true); 
    } */
}

//比较生日和身份证号
function checkIdAndBirth() {
    /* var bir = $("#birthday").val();
    var idc = $("#id_card").val();
    if(idc.length > 14 && bir != ""){
        var birstr = idc.substr(6, 4) + "-" + idc.substr(10, 2) + "-" + idc.substr(12, 2);
        if(bir != birstr) {
            $("#idcdiv").parent().addClass("position-re");
            var lf = $("#idcdiv").parent().width();
            $("#idcdiv").ligerTip({absleft: (lf - 80), isabsolute: true,width: 140, content: "出生日期与身份证不符！"});
        } else {
            $("#idcdiv").ligerHideTip();
        }
    } else {
        $("#idcdiv").ligerHideTip();
    } */
}

function checkPhone1() {
    var khphone1 = $("#mobile_telephone1").val();
    if(khphone1 != '') {
        if(!globalUtil.isPhone(khphone1)) {
            checkPh1Flag = true;
            if(checkPh1Flag) {
                $("#mobile_telephone1").parent().addClass("position-re");
                var lf = $("#mobile_telephone1").parent().width();
                $("#mobile_telephone1").ligerTip({isabsolute: true, absleft: 135, width:130, content: "提示：手机号不正确！"});
                $("#mobile_telephone1").bind('click',function() {
                    $("#mobile_telephone1").ligerHideTip();
                });
            }
        } else {
            checkPh1Flag = false;
        }
    }
}

function checkPhone2() {
	
}

//表格初始化
function initGrid() {
	var toolbarItemData = [];
    toolbarItemData.push({
        text : '新增',
        click: addRows,
        icon : 'add'
    });
    toolbarItemData.push({
        line : true
    });
    toolbarItemData.push({
        text : '删除',
        click: deleteRow,
        icon : 'delete'
    });
    toolbarItemData.push({
        line : true
    });
    $("#centertoolbar").ligerToolBar({
        items : toolbarItemData
    });
    columns = [ {
        display : '子女姓名',
        name : 'child_name',
        width : 80,
        minWidth : 80,
        editor: {type: 'text', maxlength: 50}
    }, {
        display: '学校/工作单位名称',
        name: 'school_work_name',
        width: 160,
        minWidth : 160,
        editor: {type: 'text', maxlength: 50}
    }, {
        display : '电话',
        name : 'child_telephone',
        width : 140,
        minWidth : 140,
        editor: {type: 'text', maxlength: 25}
    }, {
        display: '省',
        name: 'house_address_province',
        width: 80,
        minWidth: 80,
        editor: {type: 'text', maxlength: 25}
    }, {
        display: '市',
        name: 'house_address_city',
        width: 80,
        minWidth: 80,
        editor: {type: 'text', maxlength: 50}
    }, {
        display: '区（县）',
        name: 'house_address_district',
        width: 80,
        minWidth: 80,
        editor: {type: 'text', maxlength: 50}
    }, {
        display: '更详细',
        name: 'house_address_more',
        width: 180,
        minWidth: 180,
        editor: {type: 'text', maxlength: 125}
    } ];

    grid = $("#grid").ligerGrid({
        data : childInfo,
        columns : columns,
        rownumbers : true,
        allowUnSelectRow : true,
        enabledEdit: true,
        usePager : false,
        width : '100%',
        height : 160,
        heightDiff : -4,
        parms : {
            _filterParms : -1
        }
    });
}

//添加grid行
function addRows() {
    var manager = $("#grid").ligerGetGridManager();   
    manager.endEdit();
    manager.addRow({
        'child_name': '',
        'child_telephone': '',
        'school_work_name': '',
        'house_address_province': userProvince,
        'house_address_city': userCity,
        'house_address_district': '',
        'house_address_more': ''
    });
}

//删除grid选中行
function deleteRow() {
    var manager = $("#grid").ligerGetGridManager();
    var row = manager.getSelectedRow();
    if (!row) {
        globalUtil.warnMsg(globalErrorMsg['100001']);//请选择一行记录进行删除
        return;
    }
    globalUtil.confirmMsg(globalErrorMsg['100016'],
        function(yes) { //确认删除
            if(yes) {
                global_ligerui_extend.deleteSelectedRow(manager);
                deleteChildId.push(row.wms_cus_customer_change_child_id);//记录删除的子女信息id
            }
        }
    );
}

//添加房产信息
function addHouse() {
	$('#fcinfo').append(
		'<table cellspacing="1" cellpadding="1" width="100%" class="input_tb">' +
            '<tr>' +
                '<td width="10%" class="title1">购房时间：</td>' +
                '<td width="20%" align="left" class="text1">' +
                    '<input type="hidden" id="wms_cus_customer_line_houseinfo_id" class="hidden" value="0" />' +
                    '<input id="house_buy_date" name="house_buy_date" class="Wdate" type="text" onclick="WdatePicker({dateFmt:\'yyyy-MM-dd\',isShowClear:true})" style="width: 150px; vertical-align: top;" />' +
                '</td>' +
                '<td width="10%" class="title1">购买金额：</td>' +
                '<td width="20%" align="left" class="text1">' +
                    '<input type="text" style="width: 150px; "id="house_buy_money" name="house_buy_money" maxlength="18" />万元' +
                '</td>' +
                '<td width="10%" class="title1">' +
                    '<span class="redstar">*</span>建筑面积：' +
                '</td>' +
                '<td width="20%" align="left" class="text1">' +
                    '<input type="text" style="width: 150px;" id="house_building_area" name="house_building_area" maxlength="18" />M²' +
                '</td>' +
            '</tr>' +
            '<tr>' +
                '<td width="10%" class="title1">' +
                    '名下几处房产：' +
                '</td>' +
                '<td width="20%" align="left" class="text1">' +
                    '<input type="text" style="width: 150px;" id="houses_number" name="houses_number" />' +
                '</td>' +
                '<td width="10%" class="title">提供房证原件：</td>' +
                '<td width="20%" align="left">' +
                    '<select id="is_supp_house_card" name="is_supp_house_card" name="is_supp_house_card" style="width: 152px;">' +
                        '<option value="">请选择</option>' +
                        '<option value="1">是</option>' +
                        '<option value="2">否</option>' +
                    '</select>' +
                '</td>' +
                '<td width="10%" class="title">房产类型：</td>' +
                '<td width="20%" align="left">' +
                    '<input type="text" style="width: 150px;" id="house_type" name="house_type" maxlength="50" />' +
                '</td>' +
            '</tr>' +
            '<tr>' +
                '<td width="10%" class="title">房产证号：</td>' +
                '<td width="20%" align="left">' +
                    '<input type="text" style="width: 150px;" id="house_no" name="house_no" maxlength="50" />' +
                '</td>' +
                '<td width="10%" class="title">房产卷号：</td>' +
                '<td width="20%" align="left">' +
                    '<input type="text" style="width: 150px;" id="house_vol_no" name="house_vol_no" maxlength="50" />' +
                '</td>' +
                '<td width="10%" class="title">' +
                    '<span class="redstar">*</span>小区名称：' +
                '</td>' +
                '<td width="20%" align="left">' +
                    '<input type="text" style="width: 150px;" id="community_name" name="community_name" maxlength="100" />' +
                '</td>' +
            '</tr>' +
            '<tr>' +    
                '<td width="10%" class="title"><span class="redstar">*</span>房产地址：</td>' +
                '<td width="90%" colspan="5" align="left">' +
                    '<input type="text" style="width: 282px;" id="house_address_more" name="house_address_more" maxlength="50" />' +
                    '<a class="btn removeHouse" href="###">删除</a>' +
                '</td>' +
            '</tr>' +
        '</table>'		
	);
}

//校验客户信息
function validCustomerInfo() {
	var validFlag = true;
	if($('#customer_name').val() == '') {
		validLigerTip('tabbody1', 'customer_name');
		validFlag = false;
	}
	return validFlag;
}

//校验房产信息
function validHouseInfo() {
	var validFlag = true;
	if($('#house_building_area').val() == '') {
	    validLigerTip('tabbody3', 'house_building_area');
	    validFlag = false;
	}
    if($('#community_name').val() == '') {
        validLigerTip('tabbody3', 'community_name');
        validFlag = false;
    }
    if($('#house_address_more').val() == '') {
    	validLigerTip('tabbody3', 'house_address_more');
        validFlag = false;
    }
    if(!globalUtil.validHouseNo($('#house_no').val())) {
        validLigerTip('tabbody3', 'house_no', globalErrorMsg['500194']);
        return;
    }
    return validFlag;
}

//校验工作信息
function validWorkInfo() {
	var validFlag = true;
	
	return validFlag;
}

//弹出校验提示框
function validLigerTip(tabbodyid, id, content) {
	$('#' + tabbodyid).trigger('click');
    var top = $('#' + id).offset().top;
    var left = $('#' + id).offset().left + 60 + 'px';
    top = top - 45 + 'px';
    content = content || '此处不能为空！';
    
    $('#' + id).after('<div class="l-verify-tip-content-abs" style="position:absolute;z-index:9999;width:auto;top:' + top + ';left:' + left + '">' + content +'</div>');
    
    $(document).on('click', '#' + id, function(){
		$('#' + id).next().remove();
    });
}

//切换tab页
function changeTab(id) {
    tabScrollFlag = true;
    var khinfo = document.getElementById("khinfo"); //个人资料tab
    var gzinfo = document.getElementById("gzinfo"); //工作信息tab
    var fcinfo = document.getElementById("fcinfo"); //房产信息tab
    if (id == 'khinfo') {
        khinfo.style.display = '';
        gzinfo.style.display = 'none';
        fcinfo.style.display = 'none';

        document.getElementById("tabbody1").className = "tabbody1";
        document.getElementById("tabbody2").className = "tabbody2";
        document.getElementById("tabbody3").className = "tabbody2";

        document.getElementById("khinfo_div").className = "tab_step tab_step101";
        document.getElementById("fcinfo_div").className = "tab_step tab_step202";
        document.getElementById("gzinfo_div").className = "tab_step tab_step302";
    } else if (id == 'gzinfo') {
        khinfo.style.display = 'none';
        fcinfo.style.display = 'none';
        gzinfo.style.display = '';

        document.getElementById("tabbody1").className = "tabbody2";
        document.getElementById("tabbody2").className = "tabbody1";
        document.getElementById("tabbody3").className = "tabbody2";

        document.getElementById("khinfo_div").className = "tab_step tab_step102";
        document.getElementById("gzinfo_div").className = "tab_step tab_step301";
        document.getElementById("fcinfo_div").className = "tab_step tab_step202";
    } else if (id == 'fcinfo') {
        khinfo.style.display = 'none';
        gzinfo.style.display = 'none';
        fcinfo.style.display = '';

        document.getElementById("tabbody1").className = "tabbody2";
        document.getElementById("tabbody2").className = "tabbody2";
        document.getElementById("tabbody3").className = "tabbody1";

        document.getElementById("khinfo_div").className = "tab_step tab_step102";
        document.getElementById("gzinfo_div").className = "tab_step tab_step302";
        document.getElementById("fcinfo_div").className = "tab_step tab_step201";
    }
}

//判断对象里属性是否有不为空的
function isHaveNotNull(obj) {
    for(i in obj) {
        if(obj.i != '') {
            return true;
        }
    }
    return false;
}

//移除日期类型属性(对象)
function removeDateDataForObj(obj) {
   	for(var i in obj) {
   		if(i.indexOf('timestamp') > 0) {
   			obj[i] = undefined;
   		}
   	}
    return obj;
}

//移除日期类型属性(数组)
function removeDateDataForArr(arr) {
    for(var i = 0; i < arr.length; i++) {
        for(var j in arr[i]) {
            if(j.indexOf('timestamp') > 0) {
                arr[i][j] = undefined;
            }
        }
    }
    return arr;
}

</script>
</body>
</html>
