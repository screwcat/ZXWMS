<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- namespace必须指向Dao接口 -->
<mapper namespace="com.zx.emanage.reportmanage.persist.WmsInveAchievementReportDao">
	
	<select id="searchBaseAchievementPerList_currmonth" parameterType="map" resultType="java.util.HashMap">
		select 
			c.company_name,
			c.dept_id,
			c.dept_name,
			c.personnel_id,
			c.personnel_name_detail,
			truncate(ifnull(c.per_add_base,0),0) as per_add_base,
			truncate(ifnull(c.per_back_base,0),0) as per_back_base,
			truncate(ifnull(c.per_back_base_newpro,0),0) as per_back_base_newpro,
			truncate(ifnull(c.per_special_add,0),0) as per_special_add,
			truncate(ifnull(c.per_add_base,0)-ifnull(c.per_back_base,0),0) as per_sum_add,
			truncate(ifnull(c.per_add_deal,0)-ifnull(c.per_back_deal,0)+ifnull(c.per_special_add,0),0) as per_sum_add_deal,
			truncate(ifnull(c.per_add_deal,0)-ifnull(c.per_back_deal_newpro,0)+ifnull(c.per_special_add,0),0) as per_sum_newpro_add_deal,
			truncate(ifnull(c.per_redeem_base,0),0) as per_redeem_base,
			truncate(ifnull(c.per_clear_add,0),0) as per_clear_add,
			truncate(ifnull(c.per_stock_all,0),0) as per_stock_all,
			c.per_stock_lev,
			truncate(ifnull(c.per_stock_all_deal,0),0) as per_stock_all_deal,
			truncate(ifnull(c.per_stock_new,0),0) as per_stock_new,
			truncate(ifnull(c.per_stock_new_deal,0),0) as per_stock_new_deal,
			case when a.personnel_state='3' then '离职' when a.personnel_state ='7' then '兼职' 
					when a.personnel_state ='0' then '试用'  
					when a.personnel_state ='2' then '实习'
					when a.personnel_state ='1' then '在职'   else '未知' end as personnel_state,
			truncate(ifnull(c.reinve_mon,0),0) as reinve_mon
			
		from wms_personnel_achievement_daysta c,
		(
					SELECT
						a.personnel_deptid,a.personnel_id,a.personnel_name,a.personnel_shortcode,a.personnel_postid,a.personnel_postname,a.personnel_state
					FROM
						pm_personnel a
					UNION
						SELECT
							b.dept_id as personnel_deptid,a.personnel_id,a.personnel_name,a.personnel_shortcode,b.post_id as personnel_postid,a.personnel_postname,a.personnel_state
						FROM
							pm_personnel a,
							sys_concurrent_post b
						WHERE
							a.personnel_id = b.personnel_id
					)  a
		 where
		 	c.statics_personnel_id=#{statics_personnel_id}
		 and c.personnel_id=a.personnel_id
		 and c.dept_id=a.personnel_deptid
		  
		  <if test="deptNameList != null and deptNameList.size > 0">
			AND ( 1=2
			<foreach collection="deptNameList" item="dept_name">
				OR c.dept_name like CONCAT('%',#{dept_name },'%')
			</foreach>
			)
		</if>
			<if test="personnel_info != null and personnel_info != ''">
				and (a.personnel_name like '%${personnel_info}%' or a.personnel_shortCode like  '%${personnel_info}%')
			</if>
			
		  <if test="personnel_state == 1">
				and a.personnel_state not in ('3','7')
			</if>
			<if test="personnel_state == 2">
				and a.personnel_state in ('7')
			</if>
			
			 <if test="per_sum_add_deal_low != null and per_sum_add_deal_low != ''">
				and truncate(ifnull(c.per_add_deal,0)-ifnull(c.per_back_deal,0)+ifnull(c.per_special_add,0),0) >= #{per_sum_add_deal_low} 
			</if>
			 <if test="per_sum_add_deal_up != null and per_sum_add_deal_up != ''">
				and #{per_sum_add_deal_up} >= truncate(ifnull(c.per_add_deal,0)-ifnull(c.per_back_deal,0)+ifnull(c.per_special_add,0),0) 
			</if>
			<if test="per_clear_add_low != null and per_clear_add_low != ''">
				and truncate(ifnull(c.per_clear_add,0),0) >= #{per_clear_add_low}
			</if>
			
			<if test="per_clear_add_up != null and per_clear_add_up != ''">
				and #{per_clear_add_up} >= truncate(ifnull(c.per_clear_add,0),0) 
			</if>
			
			<if test="per_stock_all_low != null and per_stock_all_low != ''">
				and truncate(ifnull(c.per_stock_all,0),0) >= #{per_stock_all_low}
			</if>
			
			<if test="per_stock_all_up != null and per_stock_all_up != ''">
				and #{per_stock_all_up} >= truncate(ifnull(c.per_stock_all,0),0) 
			</if>
			
			<if test="per_stock_new_deal_low != null and per_stock_new_deal_low != ''">
				and truncate(ifnull(c.per_stock_new_deal,0),0) >= #{per_stock_new_deal_low}
			</if>
			
			<if test="per_stock_new_deal_up != null and per_stock_new_deal_up != ''">
				and #{per_stock_new_deal_up} >= truncate(ifnull(c.per_stock_new_deal,0),0) 
			</if>
			
		  
		<if test="sortname != '' and sortorder !=''">
			ORDER BY ${sortname} ${sortorder}
		</if>
		<if test="offset != null and pagesize !=null">
			LIMIT ${offset} , ${pagesize}
		</if>
	</select>
	
	
	<select id="searchBaseAchievementPerList" parameterType="map" resultType="java.util.HashMap">
		select 
			c.company_name,
			c.dept_id,
			c.dept_name,
			c.personnel_id,
			c.personnel_name_detail,
			truncate(ifnull(c.per_add_base,0),0) as per_add_base,
			truncate(ifnull(c.per_back_base,0),0) as per_back_base,
			truncate(ifnull(c.per_back_base_newpro,0),0) as per_back_base_newpro,
			truncate(ifnull(c.per_special_add,0),0) as per_special_add,
			truncate(ifnull(c.per_add_base,0)-ifnull(c.per_back_base,0),0) as per_sum_add,
			truncate(ifnull(c.per_add_deal,0)-ifnull(c.per_back_deal,0)+ifnull(c.per_special_add,0),0) as per_sum_add_deal,
			truncate(ifnull(c.per_add_deal,0)-ifnull(c.per_back_deal_newpro,0)+ifnull(c.per_special_add,0),0) as per_sum_newpro_add_deal,
			truncate(ifnull(c.per_redeem_base,0),0) as per_redeem_base,
			truncate(ifnull(c.per_clear_add,0),0) as per_clear_add,
			truncate(ifnull(c.per_stock_all,0),0) as per_stock_all,
			c.per_stock_lev,
			truncate(ifnull(c.per_stock_all_deal,0),0) as per_stock_all_deal,
			truncate(ifnull(c.per_stock_new,0),0) as per_stock_new,
			truncate(ifnull(c.per_stock_new_deal,0),0) as per_stock_new_deal,
			case when a.personnel_state='3' then '离职' when a.personnel_state ='7' then '兼职' 
					when a.personnel_state ='0' then '试用'  
					when a.personnel_state ='2' then '实习'
					when a.personnel_state ='1' then '在职'   else '未知' end as personnel_state,
			truncate(ifnull(c.reinve_mon,0),0) as reinve_mon
			
		from wms_personnel_achievement_his c,
		(
					SELECT
						a.personnel_deptid,a.personnel_id,a.personnel_name,a.personnel_shortcode,a.personnel_postid,a.personnel_postname,a.personnel_state
					FROM
						pm_personnel_maininfo_backup a
					WHERE
						 a.backup_month = #{end_date}
					UNION
						SELECT
							b.dept_id as personnel_deptid,a.personnel_id,a.personnel_name,a.personnel_shortcode,b.post_id as personnel_postid,a.personnel_postname,a.personnel_state
						FROM
							pm_personnel_maininfo_backup a,
							sys_concurrent_post_backup b
						WHERE
							a.personnel_id = b.personnel_id
						AND a.backup_month = #{end_date}
						AND b.backup_month = #{end_date}
					)
					 a
		 where
		 c.statics_month=#{end_date}
		 and c.personnel_id=a.personnel_id
		 and c.dept_id=a.personnel_deptid
		 
		  
		  <if test="deptNameList != null and deptNameList.size > 0">
			AND ( 1=2
			<foreach collection="deptNameList" item="dept_name">
				OR c.dept_name like CONCAT('%',#{dept_name },'%')
			</foreach>
			)
		</if>
			<if test="personnel_info != null and personnel_info != ''">
				and (a.personnel_name like '%${personnel_info}%' or a.personnel_shortCode like  '%${personnel_info}%')
			</if>
			
		  <if test="personnel_state == 1">
				and a.personnel_state not in ('3','7')
			</if>
			<if test="personnel_state == 2">
				and a.personnel_state in ('7')
			</if>
			
			 <if test="per_sum_add_deal_low != null and per_sum_add_deal_low != ''">
				and truncate(ifnull(c.per_add_deal,0)-ifnull(c.per_back_deal,0)+ifnull(c.per_special_add,0),0) >= #{per_sum_add_deal_low} 
			</if>
			 <if test="per_sum_add_deal_up != null and per_sum_add_deal_up != ''">
				and #{per_sum_add_deal_up} >= truncate(ifnull(c.per_add_deal,0)-ifnull(c.per_back_deal,0)+ifnull(c.per_special_add,0),0) 
			</if>
			<if test="per_clear_add_low != null and per_clear_add_low != ''">
				and truncate(ifnull(c.per_clear_add,0),0) >= #{per_clear_add_low}
			</if>
			
			<if test="per_clear_add_up != null and per_clear_add_up != ''">
				and #{per_clear_add_up} >= truncate(ifnull(c.per_clear_add,0),0) 
			</if>
			
			<if test="per_stock_all_low != null and per_stock_all_low != ''">
				and truncate(ifnull(c.per_stock_all,0),0) >= #{per_stock_all_low}
			</if>
			
			<if test="per_stock_all_up != null and per_stock_all_up != ''">
				and #{per_stock_all_up} >= truncate(ifnull(c.per_stock_all,0),0) 
			</if>
			
			<if test="per_stock_new_deal_low != null and per_stock_new_deal_low != ''">
				and truncate(ifnull(c.per_stock_new_deal,0),0) >= #{per_stock_new_deal_low}
			</if>
			
			<if test="per_stock_new_deal_up != null and per_stock_new_deal_up != ''">
				and #{per_stock_new_deal_up} >= truncate(ifnull(c.per_stock_new_deal,0),0) 
			</if>
			
		  
		<if test="sortname != '' and sortorder !=''">
			ORDER BY ${sortname} ${sortorder}
		</if>
		<if test="offset != null and pagesize !=null">
			LIMIT ${offset} , ${pagesize}
		</if>
	</select>

	
	<select id="findPerCount" parameterType="map" resultType="int">
		select 
			count(1)
		from wms_personnel_achievement_his c,
		(
					SELECT
						a.personnel_deptid,a.personnel_id,a.personnel_name,a.personnel_shortcode,a.personnel_postid,a.personnel_postname,a.personnel_state
					FROM
						pm_personnel_maininfo_backup a
					WHERE
						 a.backup_month = #{end_date}
					UNION
						SELECT
							b.dept_id as personnel_deptid,a.personnel_id,a.personnel_name,a.personnel_shortcode,b.post_id as personnel_postid,a.personnel_postname,a.personnel_state
						FROM
							pm_personnel_maininfo_backup a,
							sys_concurrent_post_backup b
						WHERE
							a.personnel_id = b.personnel_id
						AND a.backup_month = #{end_date}
						AND b.backup_month = #{end_date}
					)
					 a
		where
		  statics_month=#{end_date}
		and c.personnel_id=a.personnel_id
		and c.dept_id=a.personnel_deptid
		  
		<if test="deptNameList != null and deptNameList.size > 0">
			AND ( 1=2
			<foreach collection="deptNameList" item="dept_name">
				OR c.dept_name like CONCAT('%',#{dept_name },'%')
			</foreach>
			)
		</if>
			<if test="personnel_info != null and personnel_info != ''">
				and (a.personnel_name like '%${personnel_info}%' or a.personnel_shortCode like  '%${personnel_info}%')
			</if>
			
		  <if test="personnel_state == 1">
				and a.personnel_state not in ('3','7')
			</if>
			<if test="personnel_state == 2">
				and a.personnel_state in ('7')
			</if>
			
			 <if test="per_sum_add_deal_low != null and per_sum_add_deal_low != ''">
				and truncate(ifnull(c.per_add_deal,0)-ifnull(c.per_back_deal,0)+ifnull(c.per_special_add,0),0) >= #{per_sum_add_deal_low} 
			</if>
			 <if test="per_sum_add_deal_up != null and per_sum_add_deal_up != ''">
				and #{per_sum_add_deal_up} > truncate(ifnull(c.per_add_deal,0)-ifnull(c.per_back_deal,0)+ifnull(c.per_special_add,0),0) 
			</if>
			<if test="per_clear_add_low != null and per_clear_add_low != ''">
				and truncate(ifnull(c.per_clear_add,0),0) >= #{per_clear_add_low}
			</if>
			
			<if test="per_clear_add_up != null and per_clear_add_up != ''">
				and #{per_clear_add_up} > truncate(ifnull(c.per_clear_add,0),0) 
			</if>
			
			<if test="per_stock_all_low != null and per_stock_all_low != ''">
				and truncate(ifnull(c.per_stock_all,0),0) >= #{per_stock_all_low}
			</if>
			
			<if test="per_stock_all_up != null and per_stock_all_up != ''">
				and #{per_stock_all_up} > truncate(ifnull(c.per_stock_all,0),0) 
			</if>
			
			<if test="per_stock_new_deal_low != null and per_stock_new_deal_low != ''">
				and truncate(ifnull(c.per_stock_new_deal,0),0) >= #{per_stock_new_deal_low}
			</if>
			
			<if test="per_stock_new_deal_up != null and per_stock_new_deal_up != ''">
				and #{per_stock_new_deal_up} > truncate(ifnull(c.per_stock_new_deal,0),0) 
			</if>
			
	</select>
	
	<select id="getSpecialMonthPersonnelMap" parameterType="map" resultType="map">
		select 
			truncate(sum(ifnull(c.per_add_base,0)),0) as per_add_base,
			truncate(sum(ifnull(c.per_back_base,0)),0) as per_back_base,
			truncate(sum(ifnull(c.per_back_base_newpro,0)),0) as per_back_base_newpro,
			truncate(sum(ifnull(c.per_special_add,0)),0) as per_special_add,
			truncate(sum(ifnull(c.per_add_base,0))-sum(ifnull(c.per_back_base,0)),0) as per_sum_add,
			truncate(sum(ifnull(c.per_add_deal,0))-sum(ifnull(c.per_back_deal,0))+sum(ifnull(c.per_special_add,0)),0) as per_sum_add_deal,
			truncate(sum(ifnull(c.per_add_deal,0))-sum(ifnull(c.per_back_deal_newpro,0))+sum(ifnull(c.per_special_add,0)),0) as per_sum_newpro_add_deal,
			truncate(sum(ifnull(c.per_redeem_base,0)),0) as per_redeem_base,
			truncate(sum(ifnull(c.per_clear_add,0)),0) as per_clear_add,
			truncate(sum(ifnull(c.per_stock_all,0)),0) as per_stock_all,
			GROUP_CONCAT(c.per_stock_lev) as per_stock_lev,
			truncate(sum(ifnull(c.per_stock_all_deal,0)),0) as per_stock_all_deal,
			truncate(sum(ifnull(c.per_stock_new,0)),0) as per_stock_new,
			truncate(sum(ifnull(c.per_stock_new_deal,0)),0) as per_stock_new_deal,
			truncate(sum(ifnull(c.per_add_deal,0))-sum(ifnull(c.per_back_deal,0))+sum(ifnull(c.per_special_add,0)),0) as per_add_deal,
			truncate(sum(ifnull(c.reinve_mon,0)),0) as reinve_mon
			
		from wms_personnel_achievement_his  c
		where 
			c.statics_month=#{mon_sel} 
		and c.personnel_id=#{personnel_id}
		and TRIM(c.personnel_name_detail)=TRIM(#{personnel_name_detail})
	</select>

	
	<select id="searchBaseAchievementTeamList" parameterType="map" resultType="java.util.HashMap">
		select 
			c.company_name,
			c.dept_id,
			c.dept_name,
			c.personnel_id,
			c.personnel_name_detail,
			c.post_name,
			truncate(ifnull(c.team_add_base,0),0) as team_add_base,
			truncate(ifnull(c.team_redeem_all_base,0),0) as team_redeem_all_base,
			truncate(ifnull(c.team_exc_add_base,0),0) as team_exc_add_base,
			truncate(ifnull(c.team_exc_redeem_all_base,0),0) as team_exc_redeem_all_base,
			truncate(ifnull(c.team_clear_add,0),0) as team_clear_add,
			truncate(ifnull(c.team_exc_add_base_op,0),0) as team_exc_add_base_op,
			truncate(ifnull(c.team_exc_redeem_all_base_op,0),0) as team_exc_redeem_all_base_op,
			truncate(ifnull(c.team_clear_add_op,0),0) as team_clear_add_op,
			truncate(ifnull(c.team_staff_num,0),0) as team_staff_num,
			truncate(ifnull(c.team_per_increase,0),0) as team_per_increase,
			truncate(ifnull(c.team_stock_all,0),0) as team_stock_all,
			truncate(ifnull(c.team_stock_all_deal,0),0) as team_stock_all_deal,
			truncate(ifnull(c.team_stock_new,0),0) as team_stock_new,
			truncate(ifnull(c.team_stock_new_deal,0),0) as team_stock_new_deal,
			truncate(ifnull(b.team_sea_clear_add,0),0) as team_sea_clear_add,
			truncate(ifnull(b.team_sea_staff_num,0),0) as team_sea_staff_num,
			truncate(ifnull(b.team_sea_per_increase,0),0) as team_sea_per_increase,
			truncate(ifnull(b.team_sea_staff_num_regular,0),0) as team_sea_staff_num_regular,
			case when c.personnel_state='3' then '离职' when c.personnel_state ='7' then '兼职' 
					when c.personnel_state ='0' then '试用'  
					when c.personnel_state ='2' then '实习'
					when c.personnel_state ='1' then '在职'   else '' end as personnel_state,
			truncate(ifnull(c.team_reinve_mon,0),0) as team_reinve_mon,
			truncate(ifnull(c.team_gsalary_stock_all,0),0) as team_gsalary_stock_all,
			truncate(ifnull((select x.team_gsalary_stock_all from wms_personnel_achievement_his x where x.dept_id=c.dept_id and x.statics_month=#{last_statics_month} and x.is_team_handler='1'),0),0) as lastmonth_team_gsalary_stock_all,
			truncate(ifnull(c.team_gsalary_stock_all,0)-ifnull((select x.team_gsalary_stock_all from wms_personnel_achievement_his x where x.dept_id=c.dept_id and x.statics_month=#{last_statics_month} and x.is_team_handler='1'),0),0) as team_month_clear_stock
		from 
		wms_personnel_achievement_his c
		left join (select * from wms_personnel_achievement_his_seasta where statics_season=#{statics_season}) b 
			on c.dept_id=b.dept_id 
		 where
		  c.statics_month=#{end_date}
		 and c.team_stock_all is not null
		  
		  <if test="deptNameList != null and deptNameList.size > 0">
			AND ( 1=2
			<foreach collection="deptNameList" item="dept_name">
				OR c.dept_name like CONCAT('%',#{dept_name },'%')
			</foreach>
			)
		</if>
			<if test="personnel_info != null and personnel_info != ''">
				and c.personnel_name_detail like '%${personnel_info}%'
			</if>
		   <if test="personnel_state == 1">
				and c.personnel_state not in ('3','7')
			</if>
			<if test="personnel_state == 2">
				and c.personnel_state in ('7')
			</if>
			
			<if test="team_clear_add_low != null and team_clear_add_low != ''">
				and truncate(ifnull(c.team_clear_add,0),0)  >= #{team_clear_add_low} 
			</if>
			
			<if test="team_clear_add_up != null and team_clear_add_up != ''">
				and #{team_clear_add_up} >= truncate(ifnull(c.team_clear_add,0),0)
			</if>
			
			<if test="team_stock_all_low != null and team_stock_all_low != ''">
				and truncate(ifnull(c.team_stock_all,0),0)  >= #{team_stock_all_low} 
			</if>
			
			<if test="team_stock_all_up != null and team_stock_all_up != ''">
				and #{team_stock_all_up} >= truncate(ifnull(c.team_stock_all,0),0)
			</if>
			
		
		<if test="sortname != '' and sortorder !=''">
			ORDER BY ${sortname} ${sortorder}
		</if>
		<if test="offset != null and pagesize !=null">
			LIMIT ${offset} , ${pagesize}
		</if>
	</select>
	
	<select id="getSpecialMonthTeamMap" parameterType="map" resultType="map">
		select 
			truncate(ifnull(a.team_add_base,0),0) as team_add_base,
			truncate(ifnull(a.team_redeem_all_base,0),0) as team_redeem_all_base,
			truncate(ifnull(a.team_exc_add_base,0),0) as team_exc_add_base,
			truncate(ifnull(a.team_exc_redeem_all_base,0),0) as team_exc_redeem_all_base,
			truncate(ifnull(a.team_clear_add,0),0) as team_clear_add,
			truncate(ifnull(a.team_exc_add_base_op,0),0) as team_exc_add_base_op,
			truncate(ifnull(a.team_exc_redeem_all_base_op,0),0) as team_exc_redeem_all_base_op,
			truncate(ifnull(a.team_clear_add_op,0),0) as team_clear_add_op,
			truncate(ifnull(a.team_staff_num,0),0) as team_staff_num,
			truncate(ifnull(a.team_per_increase,0),0) as team_per_increase,
			truncate(ifnull(a.team_stock_all,0),0) as team_stock_all,
			truncate(ifnull(a.team_stock_all_deal,0),0) as team_stock_all_deal,
			truncate(ifnull(a.team_stock_new,0),0) as team_stock_new,
			truncate(ifnull(a.team_stock_new_deal,0),0) as team_stock_new_deal,
			truncate(ifnull(b.team_sea_clear_add,0),0) as team_sea_clear_add,
			truncate(ifnull(b.team_sea_staff_num,0),0) as team_sea_staff_num,
			truncate(ifnull(b.team_sea_per_increase,0),0) as team_sea_per_increase,
			truncate(ifnull(b.team_sea_staff_num_regular,0),0) as team_sea_staff_num_regular
			truncate(ifnull(a.team_reinve_mon,0),0) as team_reinve_mon,
			truncate(ifnull(c.team_gsalary_stock_all,0),0) as team_gsalary_stock_all,
			truncate(ifnull((select x.team_gsalary_stock_all from wms_personnel_achievement_his x where x.dept_id=a.dept_id and x.statics_month=#{last_statics_month} and x.is_team_handler='1'),0),0) as lastmonth_team_gsalary_stock_all,
			truncate(ifnull(c.team_gsalary_stock_all,0)-ifnull((select x.team_gsalary_stock_all from wms_personnel_achievement_his x where x.dept_id=a.dept_id and x.statics_month=#{last_statics_month} and x.is_team_handler='1'),0),0) as team_month_clear_stock
		from 
			wms_personnel_achievement_his a
			left join (select * from wms_personnel_achievement_his_seasta where statics_season=#{statics_season}) b 
			on a.dept_id=b.dept_id 
		where 
			a.statics_month=#{mon_sel} 
		and a.dept_id=#{dept_id} 
		<choose>
			<when test="personnel_id != null and team_stock_all_low != ''">
				and a.personnel_id=#{personnel_id}
				and TRIM(a.personnel_name_detail)=TRIM(#{personnel_name_detail})
			</when>
			<otherwise>
				and a.is_team_handler='1'
			</otherwise>
		</choose>
		and b.statics_season=#{statics_season}
	</select>
	
	<select id="findteamCount" parameterType="map" resultType="int">
		select 
			count(1)
		from wms_personnel_achievement_his c
		 where
		  statics_month=#{end_date}
		and c.team_stock_all is not null
		
		<if test="deptNameList != null and deptNameList.size > 0">
			AND ( 1=2
			<foreach collection="deptNameList" item="dept_name">
				OR c.dept_name like CONCAT('%',#{dept_name },'%')
			</foreach>
			)
		</if>
			<if test="personnel_info != null and personnel_info != ''">
				and c.personnel_name_detail like '%${personnel_info}%'
			</if>
		  <if test="personnel_state == 1">
				and c.personnel_state not in ('3','7')
			</if>
			<if test="personnel_state == 2">
				and c.personnel_state in ('7')
			</if>
			
			<if test="team_clear_add_low != null and team_clear_add_low != ''">
				and truncate(ifnull(c.team_clear_add,0),0)  >= #{team_clear_add_low} 
			</if>
			
			<if test="team_clear_add_up != null and team_clear_add_up != ''">
				and #{team_clear_add_up} >= truncate(ifnull(c.team_clear_add,0),0)
			</if>
			
			<if test="team_stock_all_low != null and team_stock_all_low != ''">
				and truncate(ifnull(c.team_stock_all,0),0)  >= #{team_stock_all_low} 
			</if>
			
			<if test="team_stock_all_up != null and team_stock_all_up != ''">
				and #{team_stock_all_up} >= truncate(ifnull(c.team_stock_all,0),0)
			</if>
	</select>
	
	<select id="getPerAddList" parameterType="map" resultType="map">
		select 
			company_name,
			personnel_name_detail,
			truncate(ifnull(per_add_base,0)-ifnull(per_back_base,0),0) as per_clear_add,
			truncate(ifnull(per_add_deal,0)-ifnull(per_back_deal,0)+ifnull(per_special_add,0),0) as per_clear_add_deal
		from
			${table_name}
		where
			per_clear_add is not null
		<if test="statics_personnel_id != '' and statics_personnel_id !=null ">
			and statics_personnel_id=#{statics_personnel_id}
		</if>
		<if test="statics_month != '' and statics_month !=null ">
			and statics_month=#{statics_month}
		</if>
		order by 4 desc
	</select>
	
	<select id="getPerStockList" parameterType="map" resultType="map">
		select 
			company_name,
			personnel_name_detail,
			per_stock_all,
			case when personnel_state='3' then '离职' when personnel_state ='7' then '兼职' 
					when personnel_state ='0' then '试用'  
					when personnel_state ='2' then '实习'
					when personnel_state ='1' then '在职'   else '未知' end as personnel_state,
			per_stock_lev
		from
			${table_name}
		where
			per_stock_all is not null
		<if test="statics_personnel_id != '' and statics_personnel_id !=null ">
			
			and statics_personnel_id=#{statics_personnel_id}
		</if>
		<if test="statics_month != '' and statics_month !=null ">
			and statics_month=#{statics_month}
		</if>
		order by per_stock_all desc
	</select>
	
	<select id="getHisPerStockList" parameterType="map" resultType="map">
		select 
			company_name,
			personnel_name_detail,
			per_stock_all,
			case when personnel_state='3' then '离职' when personnel_state ='7' then '兼职' 
					when personnel_state ='0' then '试用'  
					when personnel_state ='2' then '实习'
					when personnel_state ='1' then '在职'   else '未知' end as personnel_state,
			per_stock_lev,
			per_stock_all+ifnull(per_stock_shareholder, 0) as per_stock_contains_share_holder,
			per_stock_shareholder_lev
		from
			wms_personnel_achievement_his
		<where>
			ifnull(per_stock_all, 0) + ifnull(per_stock_shareholder, 0) != 0
			<if test="statics_personnel_id != '' and statics_personnel_id !=null ">
				and statics_personnel_id=#{statics_personnel_id}
			</if>
			<if test="statics_month != '' and statics_month !=null ">
				and statics_month=#{statics_month}
			</if>
		</where>
		order by per_stock_contains_share_holder desc
	</select>
	
	<select id="getDaystaPerStockList" parameterType="map" resultType="map">
		select 
			a.company_name,
			a.personnel_name_detail,
			a.per_stock_all,
			case when a.personnel_state='3' then '离职' when a.personnel_state ='7' then '兼职' 
					when a.personnel_state ='0' then '试用'  
					when a.personnel_state ='2' then '实习'
					when a.personnel_state ='1' then '在职'   else '未知' end as personnel_state,
			a.per_stock_lev,
			a.per_stock_all+ifnull(c.per_stock, 0) as per_stock_contains_share_holder,
			case 
				when (a.per_stock_all+ifnull(c.per_stock, 0))/10000 &lt; 100 THEN 'A'
				when (a.per_stock_all+ifnull(c.per_stock, 0))/10000>=100 and 300>(a.per_stock_all+ifnull(c.per_stock, 0))/10000 THEN 'B'
				when (a.per_stock_all+ifnull(c.per_stock, 0))/10000>=300 and 500>(a.per_stock_all+ifnull(c.per_stock, 0))/10000 THEN 'C'
				when (a.per_stock_all+ifnull(c.per_stock, 0))/10000>=500 and 700>(a.per_stock_all+ifnull(c.per_stock, 0))/10000 THEN 'D'
				when (a.per_stock_all+ifnull(c.per_stock, 0))/10000>=700 and 900>(a.per_stock_all+ifnull(c.per_stock, 0))/10000 THEN 'E'
				when (a.per_stock_all+ifnull(c.per_stock, 0))/10000>=900 and 1100>(a.per_stock_all+ifnull(c.per_stock, 0))/10000 THEN 'F'
				when (a.per_stock_all+ifnull(c.per_stock, 0))/10000>=1100 and 1300>(a.per_stock_all+ifnull(c.per_stock, 0))/10000 THEN 'G'
				when (a.per_stock_all+ifnull(c.per_stock, 0))/10000>=1300 and 1500>(a.per_stock_all+ifnull(c.per_stock, 0))/10000 THEN 'H'
				when (a.per_stock_all+ifnull(c.per_stock, 0))/10000>=1500 and 1700>(a.per_stock_all+ifnull(c.per_stock, 0))/10000 THEN 'I'
				when (a.per_stock_all+ifnull(c.per_stock, 0))/10000>=1700 and 1900>(a.per_stock_all+ifnull(c.per_stock, 0))/10000 THEN 'J'
				when (a.per_stock_all+ifnull(c.per_stock, 0))/10000>=1900 and 2100>(a.per_stock_all+ifnull(c.per_stock, 0))/10000 THEN 'K'
			END as per_stock_shareholder_lev
		from
			wms_personnel_achievement_daysta a left join wms_personnel_achievement_shareholder c
			on a.personnel_id=c.bel_salesman_id and a.dept_id=c.bel_salesman_dept_id AND a.personnel_name_detail != '冯涛 100006(转)'
		<where>
			ifnull(a.per_stock_all, 0) + ifnull(c.per_stock, 0) != 0
			<if test="statics_personnel_id != '' and statics_personnel_id !=null ">
				and a.statics_personnel_id=#{statics_personnel_id}
			</if>
			<if test="statics_month != '' and statics_month !=null ">
				and a.statics_month=#{statics_month}
			</if>
		</where>
		order by per_stock_contains_share_holder desc
	</select>
	
	<select id="getTeamAddList" parameterType="map" resultType="map">
		select 
			CONCAT(a.company_name,'/',a.dept_name) as company_name,
			ifnull(a.personnel_name_detail,'暂无') as personnel_name_detail,
			a.team_add_base,
			a.team_redeem_all_base as team_redeem_all,
			a.team_clear_add
		from
			${table_name} a
		where
		a.is_team_handler=1
		<if test="statics_personnel_id != '' and statics_personnel_id !=null ">
			and a.statics_personnel_id=#{statics_personnel_id}
		</if>
		<if test="statics_month != '' and statics_month !=null ">
			and a.statics_month=#{statics_month}
		</if>
		order by team_clear_add desc
	</select>
	
	<select id="getTeamStockList" parameterType="map" resultType="map">
		select 
			a.company_name,
			a.personnel_name_detail,
			a.team_stock_all
		from
			${table_name} a
		where
		exists (select 1 from sys_post b where a.post_number=b.post_id and  (b.post_number like '%PCFBMJL%' or  b.post_number like '%PCFJXBMJL%'))
		<if test="statics_personnel_id != '' and statics_personnel_id !=null ">
			and a.statics_personnel_id=#{statics_personnel_id}
		</if>
		<if test="statics_month != '' and statics_month !=null ">
			and a.statics_month=#{statics_month}
		</if>
		order by team_stock_all desc
	</select>
	
	
	
	<select id="getCenterAddList" parameterType="map" resultType="map">
		select 
			a.company_name,
			a.personnel_name_detail,
			a.team_add_base,
			a.team_redeem_all_base as team_redeem_all,
			a.team_clear_add
		from
			${table_name} a
		where
		exists (select 1 from sys_post b where a.post_number=b.post_id and b.post_number like '%PCFZXFGSZJL%')
		<if test="statics_month != '' and statics_month !=null ">
			and a.statics_month=#{statics_month}
		</if>
	</select>
	
	<select id="getCenterStockList" parameterType="map" resultType="map">
		select 
			a.company_name,
			a.personnel_name_detail,
			a.team_stock_all
		from
			${table_name} a
		where
		exists (select 1 from sys_post b where a.post_number=b.post_id and b.post_number like '%PCFZXFGSZJL%')
		<if test="statics_month != '' and statics_month !=null ">
			and a.statics_month=#{statics_month}
		</if>
	</select>
	
	
	<select id="getViceAddList" parameterType="map" resultType="map">
		select 
			a.company_name,
			a.personnel_name_detail,
			a.team_add_base,
			a.team_redeem_all_base as team_redeem_all,
			a.team_clear_add
		from
			${table_name} a
		where
		(
			a.personnel_id=#{general_manager_id}
			or exists (select 1 from sys_post b where a.post_number=b.post_id and (b.post_number like '%PCFZXFGSZJL%' or b.post_number like '%PCFZXFZJL%' or b.post_number like '%PCFJXZXFZJL%'))
			or exists (select 1 from wms_inve_transa_non_busi_leader c where a.personnel_id=c.leader_personnel_id)
		)
		and a.team_clear_add is not null
		<if test="statics_personnel_id != '' and statics_personnel_id !=null ">
			and a.statics_personnel_id=#{statics_personnel_id}
		</if>
		<if test="statics_month != '' and statics_month !=null ">
			and a.statics_month=#{statics_month}
		</if>
		order by a.team_clear_add desc
	</select>
	
	<select id="getViceStockList" parameterType="map" resultType="map">
		select 
			a.company_name,
			a.personnel_name_detail,
			a.team_stock_all
		from
			${table_name} a
		where
		(exists (select 1 from sys_post b where a.post_number=b.post_id and (b.post_number like '%PCFZXFZJL%' or b.post_number like '%PCFJXZXFZJL%' or b.post_number like '%PCFZXFGSZJL%'))
		or exists (select 1 from wms_inve_transa_non_busi_leader c where a.personnel_id=c.leader_personnel_id))
		and a.team_stock_all is not null
		<if test="statics_personnel_id != '' and statics_personnel_id !=null ">
			and a.statics_personnel_id=#{statics_personnel_id}
		</if>
		<if test="statics_month != '' and statics_month !=null ">
			and a.statics_month=#{statics_month}
		</if>
		union all
		select 
			a.company_name,
			a.personnel_name_detail,
			a.per_stock_all as team_stock_all
		from
			${table_name} a
		where
			a.personnel_id=#{general_manager_id}
		<if test="statics_personnel_id != '' and statics_personnel_id !=null ">
			and a.statics_personnel_id=#{statics_personnel_id}
		</if>
		<if test="statics_month != '' and statics_month !=null ">
			and a.statics_month=#{statics_month}
		</if>
		order by team_stock_all desc
			
	</select>
	
	<select id="getGenAddList" parameterType="map" resultType="map">
		select 
			a.company_name,
			a.personnel_name_detail,
			a.team_add_base,
			a.team_redeem_all_base as team_redeem_all,
			a.team_clear_add
		from
			${table_name} a
		where
		a.personnel_id=#{general_manager_id}
		<if test="statics_month != '' and statics_month !=null ">
			and a.statics_month=#{statics_month}
		</if>
	</select>
	
	<select id="getGenStockList" parameterType="map" resultType="map">
		select 
			a.company_name,
			a.personnel_name_detail,
			a.team_stock_all
		from
			${table_name} a
		where
		a.personnel_id=#{general_manager_id}
		<if test="statics_month != '' and statics_month !=null ">
			and a.statics_month=#{statics_month}
		</if>
	</select>
	<select id="getCurrMonthDetailInve1" parameterType="map" resultType="map">
	select 
		k.rea,
		case when h.bel_personnel_id is not null then CONCAT(k.reb,'(转)') else reb end as reb,
		k.bel_salesman_dept_id,
		k.rec,
		k.bel_department_manager_dept_id,
		k.red,
		k.bel_vice_general_manager_dept_id,
		k.ree,
		k.bel_general_manager_dept_id,
		k.ref,
		k.bel_center_manager_dept_id,
		k.reg,
		k.reh,
		k.rei,
		k.rej,
		k.rek,
		k.rel,
		k.rem,
		k.ren,
		k.reo,
		k.rep,
		k.req
		from (
		SELECT
			a.salesman_id,
			getL5DeptName(a.bel_salesman_dept_id) as rea,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=a.bel_salesman_id_id) as reb,
			a.bel_salesman_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=a.bel_department_manager_id) as rec,
			a.bel_department_manager_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=a.bel_vice_general_manager_id) as red,
			a.bel_vice_general_manager_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=a.bel_general_manager_id) as ree,
			a.bel_general_manager_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=a.bel_center_manager_id) as ref,
			a.bel_center_manager_dept_id,
			a.bill_code as reg,
			a.cus_name as reh,
			DATE_FORMAT(a.date_of_payment,'%Y/%m/%d') as rei,
			b.org_product_account as rej,
			(select x.category_name from wms_inve_pruduct_category x where x.wms_inve_pruduct_category_id=b.wms_inve_pruduct_category_id) as rek,
			b.product_deadline as rel,
			'' as rem,
			'' as ren,
			'' as reo,
			'' as rep,
			if(a.transa_type='2', 'PTP上单', if(ifnull(a.transa_type,'1')='1', if(a.bill_source='1','续期单据',''), '')) as req,
			a.date_of_payment,
			a.wms_inve_customer_id
		FROM
			wms_inve_transa a,
			wms_inve_transa_prod b
		WHERE
			a.date_of_payment >= #{sel_begin_date}
		AND #{sel_end_date} >= a.date_of_payment
		and b.wms_inve_pruduct_category_id not in (${reject_proid})
		and a.data_status in ('4','5','6')
		and a.wms_inve_transa_id=b.wms_inve_transa_id
		UNION ALL
		SELECT
			a.salesman_id,
			getL5DeptName(a.bel_salesman_dept_id) as rea,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=a.bel_salesman_id_id) as reb,
			a.bel_salesman_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=a.bel_department_manager_id) as rec,
			a.bel_department_manager_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=a.bel_vice_general_manager_id) as red,
			a.bel_vice_general_manager_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=a.bel_general_manager_id) as ree,
			a.bel_general_manager_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=a.bel_center_manager_id) as ref,
			a.bel_center_manager_dept_id,
			a.bill_code as reg,
			a.cus_name as reh,
			DATE_FORMAT(a.date_of_payment,'%Y/%m/%d') as rei,
			b.org_product_account as rej,
			(select x.category_name from wms_inve_pruduct_category x where x.wms_inve_pruduct_category_id=b.wms_inve_pruduct_category_id) as rek,
			b.product_deadline as rel,
			'' as rem,
			'' as ren,
			'' as reo,
			'' as rep,
			if(a.transa_type='2', 'PTP上单', if(ifnull(a.transa_type,'1')='1', if(a.bill_source='1','续期单据',''), '')) as req,
			a.date_of_payment,
			a.wms_inve_customer_id
		FROM
			wms_inve_transa a,
			wms_inve_transa_prod b,
			wms_inve_comm_release_mode f
		WHERE
			a.data_status IN ('4')
		and	#{sel_begin_date} > a.date_of_payment
		AND a.wms_inve_transa_id = b.wms_inve_transa_id
		and b.wms_inve_pruduct_category_id in (25,32,33)
		AND f.wms_inve_pruduct_category_ids = b.wms_inve_pruduct_category_id
		AND #{export_month} = DATE_FORMAT(DATE_ADD(a.date_of_payment,INTERVAL f.release_month - 1 MONTH),'%Y-%m')
		
		UNION ALL
		SELECT
			a.salesman_id,
			getL5DeptName(a.bel_salesman_dept_id) as rea,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=a.bel_salesman_id_id) as reb,
			a.bel_salesman_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=a.bel_department_manager_id) as rec,
			a.bel_department_manager_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=a.bel_vice_general_manager_id) as red,
			a.bel_vice_general_manager_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=a.bel_general_manager_id) as ree,
			a.bel_general_manager_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=a.bel_center_manager_id) as ref,
			a.bel_center_manager_dept_id,
			a.bill_code as reg,
			a.cus_name as reh,
			DATE_FORMAT(a.date_of_payment,'%Y/%m/%d') as rei,
			0 as rej,
			(select x.category_name from wms_inve_pruduct_category x where x.wms_inve_pruduct_category_id=b.wms_inve_pruduct_category_id) as  rek,
			b.product_deadline as rel,
			DATE_FORMAT(c.redeem_date,'%Y/%m/%d') as rem,
			d.redeem_amount as ren,
			case when c.redeem_company_reason='1' then '公司原因' when c.redeem_company_reason='2' then '个人原因' when  c.redeem_company_reason='3' then '协议到期' end  as reo,
			case when c.is_take_off_damages='0' then '未收取' else '收取' end as rep,
			if(a.transa_type='2', 'PTP赎回', if(ifnull(a.transa_type, '1')='1', if(c.redeem_type='2','续期赎回单据',''), '')) as req,
			a.date_of_payment,
			a.wms_inve_customer_id
		FROM
			wms_inve_transa a,
			wms_inve_transa_prod b,
			wms_inve_redeem c,
			wms_inve_redeem_detail d
		WHERE
			 a.wms_inve_transa_id=b.wms_inve_transa_id
		and c.wms_inve_redeem_id=d.wms_inve_redeem_id
		and d.wms_inve_transa_id=a.wms_inve_transa_id
		and c.redeem_date >=  #{sel_begin_date}
		AND  #{sel_end_date} >= c.redeem_date
		and b.wms_inve_pruduct_category_id not in (${reject_proid})
		and a.data_status in ('4','5','6')
		and c.data_status !='7'
		and c.redeem_type not IN ('3','5')	
		and c.data_status in ('6')
		) k 
		left join (select  wms_inve_customer_id,bel_personnel_id,max(end_of_date) as end_date   from wms_inve_customer_remove_his where data_type='1' group by wms_inve_customer_id,bel_personnel_id) h
		on k.wms_inve_customer_id=h.wms_inve_customer_id and h.end_date>=k.date_of_payment
	</select>
	<select id="getCurrMonthDetailInve2" parameterType="map" resultType="map">
		SELECT
			getL5DeptName(a.bel_salesman_dept_id) as rea,
			case when c.bel_personnel_id is not null then CONCAT((select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=a.bel_salesman_id_id),'(转)') else 
		  (select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=a.bel_salesman_id_id) end as reb,
			a.bel_salesman_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=a.bel_department_manager_id) as rec,
			a.bel_department_manager_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=a.bel_vice_general_manager_id) as red,
			a.bel_vice_general_manager_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=a.bel_general_manager_id) as ref,
			a.bel_general_manager_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=a.bel_center_manager_id) as reg,
			a.bel_center_manager_dept_id,
			a.bill_code as reh,
			a.cus_name as rei,
			DATE_FORMAT(a.date_of_payment,'%Y/%m/%d') as rej,
			b.product_account as rek,
			(select x.category_name from wms_inve_pruduct_category x where x.wms_inve_pruduct_category_id=b.wms_inve_pruduct_category_id) as rel,
			b.product_deadline as rem,
			if(a.transa_type = '2', 'PTP上单', '') as req
		FROM
			wms_inve_transa_prod b,
			wms_inve_transa a
		LEFT JOIN (select  wms_inve_customer_id,bel_personnel_id,max(end_of_date) as end_date   from wms_inve_customer_remove_his where data_type='1' group by wms_inve_customer_id,bel_personnel_id) c
		on a.wms_inve_customer_id=c.wms_inve_customer_id and c.end_date>=a.date_of_payment
		WHERE
			 a.data_status='4'
		and #{sel_end_date}>=a.date_of_payment
		and exists (select 1 from wms_inve_transa_protocol c where c.wms_inve_transa_id=a.wms_inve_transa_id and c.end_of_date>=#{sel_end_date} LIMIT 1) 
		and b.wms_inve_pruduct_category_id not in (${reject_proid})
		and a.wms_inve_transa_id=b.wms_inve_transa_id
		order by a.date_of_payment asc,a.salesman_name asc		
	</select>
	
	<select id="getCurrMonthDetailInve3" parameterType="map" resultType="map">
	    SELECT
			getL5DeptName (t1.bel_salesman_dept_id) AS rea, 
			CASE WHEN c.bel_personnel_id IS NOT NULL THEN CONCAT(( SELECT CONCAT( x.personnel_name, ' ', x.personnel_shortCode ) FROM pm_personnel x WHERE x.personnel_id = t1.bel_salesman_id_id ), '(转)' ) 
			ELSE ( SELECT CONCAT( x.personnel_name, ' ', x.personnel_shortCode ) FROM pm_personnel x WHERE x.personnel_id = t1.bel_salesman_id_id ) END AS reb, 
			t1.bel_salesman_dept_id, 
			( SELECT CONCAT( x.personnel_name, ' ', x.personnel_shortCode ) FROM pm_personnel x WHERE x.personnel_id = t1.bel_department_manager_id ) AS rec, 
			t1.bel_department_manager_dept_id, ( SELECT CONCAT( x.personnel_name, ' ', x.personnel_shortCode ) FROM pm_personnel x WHERE x.personnel_id = t1.bel_vice_general_manager_id ) AS red, 
			t1.bel_vice_general_manager_dept_id, ( SELECT CONCAT( x.personnel_name, ' ', x.personnel_shortCode ) FROM pm_personnel x WHERE x.personnel_id = t1.bel_general_manager_id ) AS ref, 
			t1.bel_general_manager_dept_id, ( SELECT CONCAT( x.personnel_name, ' ', x.personnel_shortCode ) FROM pm_personnel x WHERE x.personnel_id = t1.bel_center_manager_id ) AS reg,
			 t1.bel_center_manager_dept_id,
			 t1.bill_code AS reh,
			 t1.cus_name AS rei,
			 DATE_FORMAT(
				t1.date_of_payment,
				'%Y/%m/%d'
			) AS rej,
			 t3.act_account,
			 t2.product_account AS rek,
			 (
				SELECT
					x.category_name
				FROM
					wms_inve_pruduct_category x
				WHERE
					x.wms_inve_pruduct_category_id = t2.wms_inve_pruduct_category_id
			) AS rel,
			 t2.product_deadline AS rem
			FROM
				wms_inve_transa_prod t2,
				(
					SELECT
						t.wms_inve_transa_id,
						sum(t.act_account) AS act_account
					FROM
						wms_inve_transa_card t
					WHERE
						t.pay_type = '3'
					AND t.enable_flag = '1'
					GROUP BY
						t.wms_inve_transa_id
				) t3,
			wms_inve_transa t1
			LEFT JOIN (
				SELECT
					wms_inve_customer_id,
					bel_personnel_id,
					max(end_of_date) AS end_date
				FROM
					wms_inve_customer_remove_his
				WHERE
					data_type = '1'
				GROUP BY
					wms_inve_customer_id,
					bel_personnel_id
			) c ON t1.wms_inve_customer_id = c.wms_inve_customer_id
			AND c.end_date >= t1.date_of_payment
			WHERE
				t1.wms_inve_transa_id = t2.wms_inve_transa_id
			AND t1.wms_inve_transa_id = t3.wms_inve_transa_id
			AND t1.data_status IN ('4', '6','5')
			and t2.wms_inve_pruduct_category_id not in (${reject_proid})
			AND t1.date_of_payment >= #{sel_begin_date}
			AND t1.date_of_payment &lt;= #{sel_end_date}	
			order by t1.date_of_payment asc,t1.salesman_name asc	
	</select>
	<select id="getOtherMonthDetailInve1" parameterType="map" resultType="map">
		select 
		k.rea,
		case when h.bel_personnel_id is not null then CONCAT(k.reb,'(转)') else reb end as reb,
		k.bel_salesman_dept_id,
		k.rec,
		k.bel_department_manager_dept_id,
		k.red,
		k.bel_vice_general_manager_dept_id,
		k.ree,
		k.bel_general_manager_dept_id,
		k.ref,
		k.bel_center_manager_dept_id,
		k.reg,
		k.reh,
		k.rei,
		k.rej,
		k.rek,
		k.rel,
		k.rem,
		k.ren,
		k.reo,
		k.rep,
		k.req
		from (
		SELECT
			a.salesman_id,
			getL5DeptName(b.bel_salesman_dept_id) as rea,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=b.bel_salesman_id_id) as reb,
			b.bel_salesman_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=b.bel_department_manager_id) as rec,
			b.bel_department_manager_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=b.bel_vice_general_manager_id) as red,
			b.bel_vice_general_manager_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=b.bel_general_manager_id) as ree,
			b.bel_general_manager_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=b.bel_center_manager_id) as ref,
			b.bel_center_manager_dept_id,
			a.bill_code as reg,
			a.cus_name as reh,
			DATE_FORMAT(a.date_of_payment,'%Y/%m/%d') as rei,
			a.date_of_payment,
			b.org_product_account as rej,
			(select x.category_name from wms_inve_pruduct_category x where x.wms_inve_pruduct_category_id=b.wms_inve_pruduct_category_id) as rek,
			b.product_deadline as rel,
			'' as rem,
			'' as ren,
			'' as reo,
			'' as rep,
			if(a.transa_type='2', 'PTP上单', if(ifnull(a.transa_type,'1')='1', if(a.bill_source='1','续期单据',''), '')) as req
		FROM
			wms_inve_transa a,
			wms_inve_transa_backup b
		WHERE
			a.date_of_payment >= #{sel_begin_date}
		AND #{sel_end_date} >= a.date_of_payment
		and b.wms_inve_pruduct_category_id not in (${reject_proid})
		and b.data_status in ('4','5','6')
		and a.wms_inve_transa_id=b.wms_inve_transa_id
		and b.backup_month=#{statics_month}
		UNION ALL
		SELECT
			a.salesman_id,
			getL5DeptName(a.bel_salesman_dept_id) as rea,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=a.bel_salesman_id_id) as reb,
			a.bel_salesman_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=a.bel_department_manager_id) as rec,
			a.bel_department_manager_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=a.bel_vice_general_manager_id) as red,
			a.bel_vice_general_manager_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=a.bel_general_manager_id) as ree,
			a.bel_general_manager_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=a.bel_center_manager_id) as ref,
			a.bel_center_manager_dept_id,
			a.bill_code as reg,
			a.cus_name as reh,
			DATE_FORMAT(a.date_of_payment,'%Y/%m/%d') as rei,
			a.date_of_payment,
			b.org_product_account as rej,
			(select x.category_name from wms_inve_pruduct_category x where x.wms_inve_pruduct_category_id=b.wms_inve_pruduct_category_id) as rek,
			b.product_deadline as rel,
			'' as rem,
			'' as ren,
			'' as reo,
			'' as rep,
			if(a.transa_type='2', 'PTP上单', if(ifnull(a.transa_type,'1')='1', if(a.bill_source='1','续期单据',''), '')) as req
		FROM
			wms_inve_transa a,
			wms_inve_transa_backup b,
			wms_inve_comm_release_mode f
		WHERE
			b.data_status IN ('4')
		and	#{sel_begin_date} > a.date_of_payment
		AND a.wms_inve_transa_id = b.wms_inve_transa_id
		and b.wms_inve_pruduct_category_id in (25,32,33)
		and b.backup_month=#{statics_month}
		AND f.wms_inve_pruduct_category_ids = b.wms_inve_pruduct_category_id
		AND #{statics_month} = DATE_FORMAT(DATE_ADD(a.date_of_payment,INTERVAL f.release_month - 1 MONTH),'%Y-%m')
		
		UNION ALL
		SELECT
			a.salesman_id,
			getL5DeptName(b.bel_salesman_dept_id) as rea,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=b.bel_salesman_id_id) as reb,
			b.bel_salesman_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=b.bel_department_manager_id) as rec,
			b.bel_department_manager_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=b.bel_vice_general_manager_id) as red,
			b.bel_vice_general_manager_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=b.bel_general_manager_id) as ree,
			b.bel_general_manager_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=b.bel_center_manager_id) as ref,
			b.bel_center_manager_dept_id,
			a.bill_code as reg,
			a.cus_name as reh,
			DATE_FORMAT(a.date_of_payment,'%Y/%m/%d') as rei,
			a.date_of_payment,
			0 as rej,
			(select x.category_name from wms_inve_pruduct_category x where x.wms_inve_pruduct_category_id=b.wms_inve_pruduct_category_id) as  rek,
			b.product_deadline as rel,
			DATE_FORMAT(c.redeem_date,'%Y/%m/%d') as rem,
			d.redeem_amount as ren,
			case when c.redeem_company_reason='1' then '公司原因' when c.redeem_company_reason='2' then '个人原因' when  c.redeem_company_reason='3' then '协议到期' end  as reo,
			case when c.is_take_off_damages='0' then '未收取' else '收取' end as rep,
			if(a.transa_type='2', 'PTP赎回', if(ifnull(a.transa_type, '1')='1', if(c.redeem_type='2','续期赎回单据',''), '')) as req
		FROM
			wms_inve_transa a,
			wms_inve_transa_backup b,
			wms_inve_redeem c,
			wms_inve_redeem_detail d
		WHERE
			 a.wms_inve_transa_id=b.wms_inve_transa_id
		and c.wms_inve_redeem_id=d.wms_inve_redeem_id
		and b.backup_month=#{statics_month}
		and d.wms_inve_transa_id=a.wms_inve_transa_id
		and c.redeem_date >=  #{sel_begin_date}
		AND  #{sel_end_date} >= c.redeem_date
		and b.wms_inve_pruduct_category_id not in (${reject_proid})
		and b.data_status in ('4','5','6')
		and c.data_status !='7'
		and c.data_status in ('6')
		and c.redeem_type not IN ('3','5')
		
		) k 
		left join (select  wms_inve_customer_id,base_bel_personnel_id,bel_personnel_id,max(end_of_date) as end_date   from 
		wms_inve_customer_remove_his where data_type='1' 
		and change_date&lt;=(select t1.job_date from wms_inve_job_time t1 where t1.job_month=#{statics_month} and t1.job_type='1')
		 group by wms_inve_customer_id,base_bel_personnel_id,bel_personnel_id)  h 
		on k.salesman_id=h.base_bel_personnel_id and h.end_date>=k.date_of_payment
	</select>
	
	<select id="getOtherMonthDetailInve2" parameterType="map" resultType="map">
		SELECT
			getL5DeptName(b.bel_salesman_dept_id) as rea,
			case when c.bel_personnel_id is not null then CONCAT((select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=b.bel_salesman_id_id),'(转)') else 
		  (select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=b.bel_salesman_id_id) end as reb,
			b.bel_salesman_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=b.bel_department_manager_id) as rec,
			b.bel_department_manager_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=b.bel_vice_general_manager_id) as red,
			b.bel_vice_general_manager_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=b.bel_general_manager_id) as ref,
			b.bel_general_manager_dept_id,
			(select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=b.bel_center_manager_id) as reg,
			b.bel_center_manager_dept_id,
			a.bill_code as reh,
			a.cus_name as rei,
			DATE_FORMAT(a.date_of_payment,'%Y/%m/%d') as rej,
			b.product_account as rek,
			(select x.category_name from wms_inve_pruduct_category x where x.wms_inve_pruduct_category_id=b.wms_inve_pruduct_category_id) as rel,
			b.product_deadline as rem,
			if(a.transa_type = '2', 'PTP上单', '') as req
		FROM
			wms_inve_transa_backup b,
			wms_inve_transa a
		LEFT JOIN (select  wms_inve_customer_id,bel_personnel_id,max(end_of_date) as end_date   from 
		wms_inve_customer_remove_his where data_type='1' 
		and change_date&lt;=(select t1.job_date from wms_inve_job_time t1 where t1.job_month=#{statics_month} and t1.job_type='1')
		 group by wms_inve_customer_id) c
		on a.wms_inve_customer_id=c.wms_inve_customer_id and c.end_date>=a.date_of_payment
		WHERE
			 b.data_status='4'
		and b.backup_month=#{statics_month}
		and #{sel_end_date}>=a.date_of_payment
		and exists (select 1 from wms_inve_transa_protocol c where c.wms_inve_transa_id=a.wms_inve_transa_id and c.end_of_date>=#{sel_end_date} LIMIT 1) 
		and b.wms_inve_pruduct_category_id not in (${reject_proid})
		and a.wms_inve_transa_id=b.wms_inve_transa_id
		order by a.date_of_payment asc,a.salesman_name asc		
	</select>
	
	<select id="getOtherMonthDetailInve3" parameterType="map" resultType="map">
	    SELECT
			getL5DeptName (t4.bel_salesman_dept_id) AS rea, 
			CASE WHEN c.bel_personnel_id IS NOT NULL THEN CONCAT(( SELECT CONCAT( x.personnel_name, ' ', x.personnel_shortCode ) FROM pm_personnel x WHERE x.personnel_id = t4.bel_salesman_id_id ), '(转)' ) 
			ELSE ( SELECT CONCAT( x.personnel_name, ' ', x.personnel_shortCode ) FROM pm_personnel x WHERE x.personnel_id = t4.bel_salesman_id_id ) END AS reb, 
			t4.bel_salesman_dept_id, 
			( SELECT CONCAT( x.personnel_name, ' ', x.personnel_shortCode ) FROM pm_personnel x WHERE x.personnel_id = t4.bel_department_manager_id ) AS rec, 
			t4.bel_department_manager_dept_id, ( SELECT CONCAT( x.personnel_name, ' ', x.personnel_shortCode ) FROM pm_personnel x WHERE x.personnel_id = t4.bel_vice_general_manager_id ) AS red, 
			t4.bel_vice_general_manager_dept_id, ( SELECT CONCAT( x.personnel_name, ' ', x.personnel_shortCode ) FROM pm_personnel x WHERE x.personnel_id = t4.bel_general_manager_id ) AS ref, 
			t4.bel_general_manager_dept_id, ( SELECT CONCAT( x.personnel_name, ' ', x.personnel_shortCode ) FROM pm_personnel x WHERE x.personnel_id = t4.bel_center_manager_id ) AS reg,
			 t4.bel_center_manager_dept_id,
			 t1.bill_code AS reh,
			 t1.cus_name AS rei,
			 DATE_FORMAT(
				t4.date_of_payment,
				'%Y/%m/%d'
			) AS rej,
			 t3.act_account,
			 t2.product_account AS rek,
			 (
				SELECT
					x.category_name
				FROM
					wms_inve_pruduct_category x
				WHERE
					x.wms_inve_pruduct_category_id = t4.wms_inve_pruduct_category_id
			) AS rel,
			 t2.product_deadline AS rem
			FROM
				wms_inve_transa t1,
				wms_inve_transa_prod t2,
				(
					SELECT
						t.wms_inve_transa_id,
						sum(t.act_account) AS act_account
					FROM
						wms_inve_transa_card t
					WHERE
						t.pay_type = '3'
					AND t.enable_flag = '1'
					GROUP BY
						t.wms_inve_transa_id
				) t3,
				wms_inve_transa_backup t4
			LEFT JOIN (
				SELECT
					wms_inve_customer_id,
					bel_personnel_id,
					max(end_of_date) AS end_date
				FROM
					wms_inve_customer_remove_his
				WHERE
					data_type = '1'
				GROUP BY
					wms_inve_customer_id,
					bel_personnel_id
			) c ON t4.wms_inve_customer_id = c.wms_inve_customer_id
			AND c.end_date >= t4.date_of_payment
			WHERE
				t1.wms_inve_transa_id = t2.wms_inve_transa_id
			AND t1.wms_inve_transa_id = t4.wms_inve_transa_id
			AND t4.backup_month = #{statics_month}
			AND t1.wms_inve_transa_id = t3.wms_inve_transa_id
			AND t4.data_status IN ('4', '6','5')
			and t2.wms_inve_pruduct_category_id not in (${reject_proid})
			AND t4.date_of_payment >= #{sel_begin_date}
			AND t4.date_of_payment &lt;= #{sel_end_date}	
			order by t4.date_of_payment asc,t1.salesman_name asc		
	</select>
	
	
	<delete id="deleteExistsData">
		delete from wms_personnel_achievement_daysta where statics_personnel_id=#{statics_personnel_id}
	</delete>
	<insert id="insertPersonnelStockData_daySta_com" parameterType="map">
		insert into wms_personnel_achievement_daysta
		(
			statics_personnel_id,
			company_id,
			company_name,
			dept_id,
			dept_name,
			personnel_id,
			personnel_name_detail,
			post_number,
			post_name,
			personnel_state,
			per_stock_all,
			per_stock_all_deal,
			per_stock_new,
			per_stock_new_deal,
			per_stock_lev
			
		)
		select 
			#{statics_personnel_id},
			getParentDeptIdByDeptId(a.personnel_deptid),
			getParenetDeptNameByDeptId(a.personnel_deptid),
			a.personnel_deptid,
			(select x.dept_name from sys_dept x where x.dept_id=a.personnel_deptid ),
			a.personnel_id,
			CONCAT(a.personnel_name,' ',a.personnel_shortcode,'(转)'),
			a.personnel_postid,
			a.personnel_postname,
			a.personnel_state,
			product_account,
			product_account_deal,
			new_product_account,
			new_product_account_deal,
			case 
						when product_account/10000 &lt; 100 THEN 'A'
						when product_account/10000>=100 and 300>product_account/10000 THEN 'B'
						when product_account/10000>=300 and 500>product_account/10000 THEN 'C'
						when product_account/10000>=500 and 700>product_account/10000 THEN 'D'
						when product_account/10000>=700 and 900>product_account/10000 THEN 'E'
						when product_account/10000>=900 and 1100>product_account/10000 THEN 'F'
						when product_account/10000>=1100 and 1300>product_account/10000 THEN 'G'
						when product_account/10000>=1300 and 1500>product_account/10000 THEN 'H'
						when product_account/10000>=1500 and 1700>product_account/10000 THEN 'I'
						when product_account/10000>=1700 and 1900>product_account/10000 THEN 'J'
						when product_account/10000>=1900 and 2100>product_account/10000 THEN 'K'
					END
		from
					(
					SELECT
						a.personnel_deptid,a.personnel_id,a.personnel_name,a.personnel_shortcode,a.personnel_postid,a.personnel_postname,a.personnel_state
					FROM
						pm_personnel a
					UNION
						SELECT
							b.dept_id as personnel_deptid,a.personnel_id,a.personnel_name,a.personnel_shortcode,b.post_id as personnel_postid,a.personnel_postname,a.personnel_state
						FROM
							pm_personnel a,
							sys_concurrent_post b
						WHERE
							a.personnel_id = b.personnel_id
					) a
					left join (
								SELECT
									a.bel_salesman_id_id,
									a.bel_salesman_dept_id,
									sum(ifnull(b.product_account,0)) as product_account,
									sum(ifnull(b.product_account,0)*b.product_deadline/12) as product_account_deal,
									sum((case when ifnull(a.old_date_of_payment,a.date_of_payment) >= #{limit_date} and b.wms_inve_pruduct_category_id in (${new_pros})  then ifnull(b.product_account,0) else 0 end)) as new_product_account,
									sum((case when ifnull(a.old_date_of_payment,a.date_of_payment) >= #{limit_date} and b.wms_inve_pruduct_category_id in (${new_pros})  then ifnull(b.product_account,0) else 0 end)*b.product_deadline/12) as new_product_account_deal
								FROM
									wms_inve_transa a,
									wms_inve_transa_prod b
								WHERE
									a.data_status = '4'
								and exists (select 1 from wms_inve_transa_protocol c where c.wms_inve_transa_id=a.wms_inve_transa_id and c.end_of_date>=DATE_SUB(#{sta_end_date},INTERVAL 1 DAY) LIMIT 1) 
								and a.date_of_payment &lt; #{sta_end_date}
								and b.wms_inve_pruduct_category_id not in (${reject_proid})
								AND a.wms_inve_transa_id = b.wms_inve_transa_id
								and exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=a.wms_inve_customer_id
										and ifnull(a.old_date_of_payment,a.date_of_payment) &lt; x.end_of_date
										and x.data_type='1'
									)
								group by a.bel_salesman_id_id,a.bel_salesman_dept_id
							) c
			on a.personnel_id=c.bel_salesman_id_id and a.personnel_deptid=c.bel_salesman_dept_id
			where a.personnel_id=184
	</insert>
	<update id="updatePerAllAddData_daySta_com" parameterType="map">
		update wms_personnel_achievement_daysta a INNER JOIN
		(
		SELECT
				f.bel_salesman_id_id,
				f.bel_salesman_dept_id,
				sum(ifnull(f.all_add,0)) as who_all_add,
				sum(ifnull(f.deal_add,0)) as who_deal_add,
				sum(ifnull(f.per_redeem_base,0)) as per_redeem_base,
				sum(ifnull(f.per_redeem_deal,0)) as per_redeem_deal, 
				sum(per_back_base) as per_back_base, 
				sum(per_back_deal) as per_back_deal, 
				sum(f.clear_add) as who_clear_add,  
				sum(f.mon_deal_who) as who_clear_add_deal, 
				sum(per_back_base_newpro) as per_back_base_newpro, 
				sum(per_back_deal_newpro) as per_back_deal_newpro 
			FROM
				(
					SELECT
						c.bel_salesman_id_id,
						c.bel_salesman_dept_id,
						c.wms_inve_customer_id,
						ifnull(c.cus_all_inve,0) as all_add,
						ifnull(c.cus_deal_add,0) as deal_add,
						ifnull(e.sub_am, 0) as per_redeem_base,
						ifnull(e.sub_deal_am, 0) as per_redeem_deal,
						if(ifnull(c.cus_all_inve,0)>=ifnull(e.back_sub_am, 0),ifnull(e.back_sub_am, 0),c.cus_all_inve) as per_back_base,
						if(ifnull(c.cus_deal_add,0)>=ifnull(e.back_sub_deal_am, 0),ifnull(e.back_sub_deal_am, 0),c.cus_deal_add) as per_back_deal,
						if(ifnull(c.cus_all_inve,0)>=ifnull(e.back_newpro_subam, 0),ifnull(e.back_newpro_subam, 0),c.cus_all_inve) as per_back_base_newpro,
						if(ifnull(c.cus_deal_add,0)>=ifnull(e.back_newpro_subam_deal, 0),ifnull(e.back_newpro_subam_deal, 0),c.cus_deal_add) as per_back_deal_newpro,
						ifnull(c.cus_all_inve,0)-ifnull(e.sub_am, 0) AS clear_add,
						ifnull(c.cus_deal_add,0)-ifnull(e.sub_deal_am, 0) as mon_deal_who 
					FROM
						(
							SELECT
								b.bel_salesman_id_id,
								b.bel_salesman_dept_id,
								b.wms_inve_customer_id,
								sum(ifnull(b.act_account, 0)) as cus_all_inve,
								sum(ifnull(b.deal_account,0)) as cus_deal_add
							FROM
								(
									SELECT
										a.bel_salesman_id_id,
										a.bel_salesman_dept_id,
										a.wms_inve_customer_id,
										(w.org_product_account-ifnull(d.no_damage_am,0)) as act_account,
										(w.org_product_account-ifnull(d.no_damage_am,0))*w.product_deadline/12/(if(w.wms_inve_pruduct_category_id in (${specialpro}),4,1)) as deal_account
									FROM
										wms_inve_transa a,
										wms_inve_transa_prod w
										left join 
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												AND c.data_status != '7'
												group by b.wms_inve_transa_id
												)
												d
												on w.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										a.data_status IN ('4','5','6')
									and w.wms_inve_pruduct_category_id not in (${reject_proid})
									AND a.wms_inve_transa_id = w.wms_inve_transa_id
									AND a.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>a.date_of_payment
									and a.old_wms_inve_transa_id is null
									and exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=a.wms_inve_customer_id
										and x.end_of_date>ifnull(a.old_date_of_payment,a.date_of_payment)
										and x.data_type='1'
									)
								) b
							GROUP BY
								b.bel_salesman_id_id,
								b.wms_inve_customer_id,
								b.bel_salesman_dept_id
						) c
					LEFT JOIN (
						SELECT
				d.wms_inve_customer_id,
				d.bel_salesman_id_id,
				d.bel_salesman_dept_id,
				sum(ifnull(d.sub_am, 0)) AS sub_am,
				sum(ifnull(d.back_sub_am, 0)) AS back_sub_am,
				sum(ifnull(d.sub_deal_am, 0)) AS sub_deal_am,
				sum(ifnull(d.back_sub_deal_am, 0)) AS back_sub_deal_am,
				sum(ifnull(d.newpro_subam, 0)) AS newpro_subam,
				sum(ifnull(d.back_newpro_subam, 0)) AS back_newpro_subam,
				sum(ifnull(d.newpro_subam_deal, 0)) AS newpro_subam_deal,
				sum(ifnull(d.back_newpro_subam_deal, 0)) AS back_newpro_subam_deal
			FROM
				(
					SELECT
						d.wms_inve_customer_id,
						x.bel_salesman_id_id,
						x.bel_salesman_dept_id,
						v.redeem_amount AS sub_am,
						if(d.is_take_off_damages='0' and d.redeem_company_reason='2' and d.redeem_type in ('1','3'),v.redeem_amount,0) as back_sub_am,
						v.redeem_amount * u.product_deadline / 12 AS sub_deal_am,
						if(d.is_take_off_damages='0' and d.redeem_company_reason='2' and d.redeem_type in ('1','3'),v.redeem_amount,0)* u.product_deadline / 12 as back_sub_deal_am,
						if(u.wms_inve_pruduct_category_id in (${new_pros}),v.redeem_amount,0) as newpro_subam,
						if(d.is_take_off_damages='0' and d.redeem_company_reason='2' and d.redeem_type in ('1','3') and u.wms_inve_pruduct_category_id in (${new_pros}),v.redeem_amount,0) as back_newpro_subam,
						if(u.wms_inve_pruduct_category_id in (${new_pros}),v.redeem_amount * u.product_deadline / 12,0) as newpro_subam_deal,
						if(d.is_take_off_damages='0' and d.redeem_company_reason='2' and d.redeem_type in ('1','3') and u.wms_inve_pruduct_category_id in (${new_pros}),v.redeem_amount,0)* u.product_deadline / 12 as back_newpro_subam_deal
					FROM
						wms_inve_redeem d,
						wms_inve_redeem_detail v,
						wms_inve_transa_prod u,
						wms_inve_transa x
					WHERE
						d.redeem_date >= #{sta_begin_date}
					AND #{sta_end_date} > d.redeem_date
					AND d.redeem_type not IN ('2')
					AND d.data_status IN ('6')
					and x.data_status in ('4','5','6')
					and (#{sta_begin_date}>x.date_of_payment or (x.date_of_payment>=#{sta_begin_date} and d.is_take_off_damages = '1'))
					AND d.wms_inve_redeem_id = v.wms_inve_redeem_id
					AND v.wms_inve_transa_id = u.wms_inve_transa_id
					AND u.wms_inve_transa_id = x.wms_inve_transa_id
					and u.wms_inve_pruduct_category_id not in (${reject_proid})
					and u.wms_inve_pruduct_category_id not in (${specialpro})
					and exists (select 1 from wms_inve_customer_remove_his h where h.wms_inve_customer_id=x.wms_inve_customer_id
										and h.end_of_date>ifnull(x.old_date_of_payment,x.date_of_payment)
										and h.data_type='1'
									)
					UNION ALL
						SELECT
							d.wms_inve_customer_id,
							x.bel_salesman_id_id,
							x.bel_salesman_dept_id,
							v.redeem_amount  AS sub_am,
							if(d.is_take_off_damages='0'
								and d.redeem_company_reason='2' 
								and d.redeem_type in ('1','3') 
								and d.redeem_date >= x.date_of_payment
								AND DATE_ADD(x.date_of_payment,INTERVAL 3  MONTH) >= d.redeem_date
								,v.redeem_amount,0) as back_sub_am,
							v.redeem_amount * u.product_deadline / 12 /4 AS sub_deal_am,
							if(d.is_take_off_damages='0' 
								and d.redeem_company_reason='2'
								and d.redeem_type in ('1','3') 
								and d.redeem_date >= x.date_of_payment
								AND DATE_ADD(x.date_of_payment,INTERVAL 3  MONTH) >= d.redeem_date
								,v.redeem_amount,0)* u.product_deadline / 12 /4 as back_sub_deal_am,
							v.redeem_amount as newpro_subam,
							if(d.is_take_off_damages='0' 
								and d.redeem_company_reason='2'
								and d.redeem_type in ('1','3') 
								and d.redeem_date >= x.date_of_payment
								AND DATE_ADD(x.date_of_payment,INTERVAL 3  MONTH) >= d.redeem_date
								,v.redeem_amount,0) as back_newpro_subam,
							v.redeem_amount * u.product_deadline / 12 /4 as newpro_subam_deal,
							if(d.is_take_off_damages='0' 
								and d.redeem_company_reason='2'
								and d.redeem_type in ('1','3') 
								and d.redeem_date >= x.date_of_payment
								AND DATE_ADD(x.date_of_payment,INTERVAL 3  MONTH) >= d.redeem_date
								,v.redeem_amount,0)* u.product_deadline / 12 /4 as back_newpro_subam_deal
						FROM
							wms_inve_redeem d,
							wms_inve_redeem_detail v,
							wms_inve_transa_prod u,
							wms_inve_transa x
						WHERE
							d.redeem_date >= #{sta_begin_date}
						AND #{sta_end_date} > d.redeem_date
						AND d.redeem_type not IN ('2')
						AND d.data_status IN ('6')
						and x.data_status in ('4','5','6')
						and (#{sta_begin_date}>x.date_of_payment or (x.date_of_payment>=#{sta_begin_date} and d.is_take_off_damages = '1'))
						AND d.wms_inve_redeem_id = v.wms_inve_redeem_id
						AND v.wms_inve_transa_id = u.wms_inve_transa_id
						AND u.wms_inve_transa_id = x.wms_inve_transa_id
						and u.wms_inve_pruduct_category_id in (${specialpro})
						
						and exists (select 1 from wms_inve_customer_remove_his h where h.wms_inve_customer_id=x.wms_inve_customer_id
										and h.end_of_date>ifnull(x.old_date_of_payment,x.date_of_payment)
										and h.data_type='1'
									)
				) d
			GROUP BY
				d.wms_inve_customer_id,
				d.bel_salesman_id_id,
				d.bel_salesman_dept_id
					) e ON c.wms_inve_customer_id = e.wms_inve_customer_id and c.bel_salesman_id_id=e.bel_salesman_id_id and c.bel_salesman_dept_id=e.bel_salesman_dept_id
		UNION
					SELECT
						e.bel_salesman_id_id,
						e.bel_salesman_dept_id,
						c.wms_inve_customer_id,
						ifnull(c.cus_all_inve, 0) as all_add,
						ifnull(c.cus_deal_add, 0) as deal_add,
						ifnull(e.sub_am, 0) as per_redeem_base,
						ifnull(e.sub_deal_am, 0) as per_redeem_deal,
						if(ifnull(c.cus_all_inve, 0)>=ifnull(e.back_sub_am, 0),ifnull(e.back_sub_am, 0),ifnull(c.cus_all_inve, 0)) as per_back_base,
						if(ifnull(c.cus_deal_add, 0)>=ifnull(e.back_sub_deal_am, 0),ifnull(e.back_sub_deal_am, 0),ifnull(c.cus_deal_add, 0)) as per_back_deal,
						if(ifnull(c.cus_all_inve, 0)>=ifnull(e.back_newpro_subam, 0),ifnull(e.back_newpro_subam, 0),ifnull(c.cus_all_inve, 0)) as per_back_base_newpro,
						if(ifnull(c.cus_deal_add, 0)>=ifnull(e.back_newpro_subam_deal, 0),ifnull(e.back_newpro_subam_deal, 0),ifnull(c.cus_deal_add, 0)) as per_back_deal_newpro,
						ifnull(c.cus_all_inve, 0)-ifnull(e.sub_am, 0) AS clear_add,
						ifnull(c.cus_deal_add, 0)-ifnull(e.sub_deal_am, 0) as mon_deal_who 
					FROM
						(
						SELECT
				d.wms_inve_customer_id,
				d.bel_salesman_id_id,
				d.bel_salesman_dept_id,
				sum(ifnull(d.sub_am, 0)) AS sub_am,
				sum(ifnull(d.back_sub_am, 0)) AS back_sub_am,
				sum(ifnull(d.sub_deal_am, 0)) AS sub_deal_am,
				sum(ifnull(d.back_sub_deal_am, 0)) AS back_sub_deal_am,
				sum(ifnull(d.newpro_subam, 0)) AS newpro_subam,
				sum(ifnull(d.back_newpro_subam, 0)) AS back_newpro_subam,
				sum(ifnull(d.newpro_subam_deal, 0)) AS newpro_subam_deal,
				sum(ifnull(d.back_newpro_subam_deal, 0)) AS back_newpro_subam_deal
			FROM
				(
					SELECT
						d.wms_inve_customer_id,
						x.bel_salesman_id_id,
						x.bel_salesman_dept_id,
						v.redeem_amount AS sub_am,
						if(d.is_take_off_damages='0' and d.redeem_company_reason='2' and d.redeem_type in ('1','3'),v.redeem_amount,0) as back_sub_am,
						v.redeem_amount * u.product_deadline / 12 AS sub_deal_am,
						if(d.is_take_off_damages='0' and d.redeem_company_reason='2' and d.redeem_type in ('1','3'),v.redeem_amount,0)* u.product_deadline / 12 as back_sub_deal_am,
						if(u.wms_inve_pruduct_category_id in (${new_pros}),v.redeem_amount,0) as newpro_subam,
						if(d.is_take_off_damages='0' and d.redeem_company_reason='2' and d.redeem_type in ('1','3') and u.wms_inve_pruduct_category_id in (${new_pros}),v.redeem_amount,0) as back_newpro_subam,
						if(u.wms_inve_pruduct_category_id in (${new_pros}),v.redeem_amount * u.product_deadline / 12,0) as newpro_subam_deal,
						if(d.is_take_off_damages='0' and d.redeem_company_reason='2' and d.redeem_type in ('1','3') and u.wms_inve_pruduct_category_id in (${new_pros}),v.redeem_amount,0)* u.product_deadline / 12 as back_newpro_subam_deal
					FROM
						wms_inve_redeem d,
						wms_inve_redeem_detail v,
						wms_inve_transa_prod u,
						wms_inve_transa x
					WHERE
						d.redeem_date >= #{sta_begin_date}
					AND #{sta_end_date} > d.redeem_date
					AND d.redeem_type not IN ('2')
					AND d.data_status IN ('6')
					and x.data_status in ('4','5','6')
					and (#{sta_begin_date}>x.date_of_payment or (x.date_of_payment>=#{sta_begin_date} and d.is_take_off_damages = '1'))
					AND d.wms_inve_redeem_id = v.wms_inve_redeem_id
					AND v.wms_inve_transa_id = u.wms_inve_transa_id
					AND u.wms_inve_transa_id = x.wms_inve_transa_id
					and u.wms_inve_pruduct_category_id not in (${reject_proid})
					and u.wms_inve_pruduct_category_id not in (${specialpro})
					and exists (select 1 from wms_inve_customer_remove_his h where h.wms_inve_customer_id=x.wms_inve_customer_id
										and h.end_of_date>ifnull(x.old_date_of_payment,x.date_of_payment)
										and h.data_type='1'
									)
					UNION ALL
						SELECT
							d.wms_inve_customer_id,
							x.bel_salesman_id_id,
							x.bel_salesman_dept_id,
							v.redeem_amount  AS sub_am,
							if(d.is_take_off_damages='0' 
								and d.redeem_company_reason='2'
								and d.redeem_type in ('1','3') 
								and d.redeem_date >= x.date_of_payment
								AND DATE_ADD(x.date_of_payment,INTERVAL 3  MONTH) >= d.redeem_date
								,v.redeem_amount,0) as back_sub_am,
							v.redeem_amount * u.product_deadline / 12 /4 AS sub_deal_am,
							if(d.is_take_off_damages='0' 
								and d.redeem_company_reason='2'
								and d.redeem_type in ('1','3') 
								and d.redeem_date >= x.date_of_payment
								AND DATE_ADD(x.date_of_payment,INTERVAL 3  MONTH) >= d.redeem_date
								,v.redeem_amount,0)* u.product_deadline / 12 /4 as back_sub_deal_am,
							v.redeem_amount as newpro_subam,
							if(d.is_take_off_damages='0' 
								and d.redeem_company_reason='2'
								and d.redeem_type in ('1','3') 
								and d.redeem_date >= x.date_of_payment
								AND DATE_ADD(x.date_of_payment,INTERVAL 3  MONTH) >= d.redeem_date
								,v.redeem_amount,0) as back_newpro_subam,
							v.redeem_amount * u.product_deadline / 12 /4 as newpro_subam_deal,
							if(d.is_take_off_damages='0' 
								and d.redeem_company_reason='2'
								and d.redeem_type in ('1','3') 
								and d.redeem_date >= x.date_of_payment
								AND DATE_ADD(x.date_of_payment,INTERVAL 3  MONTH) >= d.redeem_date
								,v.redeem_amount,0)* u.product_deadline / 12 /4 as back_newpro_subam_deal
						FROM
							wms_inve_redeem d,
							wms_inve_redeem_detail v,
							wms_inve_transa_prod u,
							wms_inve_transa x
						WHERE
							d.redeem_date >= #{sta_begin_date}
						AND #{sta_end_date} > d.redeem_date
						AND d.redeem_type not IN ('2')
						AND d.data_status IN ('6')
						and x.data_status in ('4','5','6')
						and (#{sta_begin_date}>x.date_of_payment or (x.date_of_payment>=#{sta_begin_date} and d.is_take_off_damages = '1'))
						AND d.wms_inve_redeem_id = v.wms_inve_redeem_id
						AND v.wms_inve_transa_id = u.wms_inve_transa_id
						AND u.wms_inve_transa_id = x.wms_inve_transa_id
						and u.wms_inve_pruduct_category_id in (${specialpro})
						and exists (select 1 from wms_inve_customer_remove_his h where h.wms_inve_customer_id=x.wms_inve_customer_id
										and h.end_of_date>ifnull(x.old_date_of_payment,x.date_of_payment)
										and h.data_type='1'
									)
				) d
			GROUP BY
				d.wms_inve_customer_id,
				d.bel_salesman_id_id,
				d.bel_salesman_dept_id
					) e 
		LEFT JOIN
		(
							SELECT
								b.bel_salesman_id_id,
								b.bel_salesman_dept_id,
								b.wms_inve_customer_id,
								sum(ifnull(b.act_account, 0)) as cus_all_inve,
								sum(ifnull(b.deal_account,0)) as cus_deal_add
							FROM
								(
									SELECT
										a.bel_salesman_id_id,
										a.bel_salesman_dept_id,
										a.wms_inve_customer_id,
										(w.org_product_account-ifnull(d.no_damage_am,0)) as act_account,
										(w.org_product_account-ifnull(d.no_damage_am,0))*w.product_deadline/12/(if(w.wms_inve_pruduct_category_id in (${specialpro}),4,1)) as deal_account
									FROM
										wms_inve_transa a,
										wms_inve_transa_prod w
										left join 
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												AND c.data_status != '7'
												group by b.wms_inve_transa_id
												)
												d
												on w.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										a.data_status IN ('4','5','6')
									and w.wms_inve_pruduct_category_id not in (${reject_proid})
									AND a.wms_inve_transa_id = w.wms_inve_transa_id
									AND a.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>a.date_of_payment
									and a.old_wms_inve_transa_id is null
									and exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=a.wms_inve_customer_id
										and x.end_of_date>ifnull(a.old_date_of_payment,a.date_of_payment)
										and x.data_type='1'
									)
									
								) b
							GROUP BY
								b.bel_salesman_id_id,
								b.wms_inve_customer_id,
								b.bel_salesman_dept_id
						) c
		ON c.wms_inve_customer_id = e.wms_inve_customer_id and c.bel_salesman_id_id=e.bel_salesman_id_id and c.bel_salesman_dept_id=e.bel_salesman_dept_id
				) f
		
			GROUP BY
				f.bel_salesman_id_id,f.bel_salesman_dept_id
		) b
		on a.personnel_id = b.bel_salesman_id_id and a.dept_id=b.bel_salesman_dept_id
		set 
			a.per_add_base=b.who_all_add,
			a.per_add_deal=b.who_deal_add,
			a.per_redeem_base=b.per_redeem_base,
			a.per_redeem_deal=b.per_redeem_deal,
			a.per_back_base=b.per_back_base,
			a.per_back_deal=b.per_back_deal,
			a.per_clear_add=b.who_clear_add,
			a.per_clear_add_deal=b.who_clear_add_deal,
			a.per_back_base_newpro=b.per_back_base_newpro,
			a.per_back_deal_newpro=b.per_back_deal_newpro
		where a.personnel_name_detail='冯涛 100006(转)'
		and a.statics_personnel_id=#{statics_personnel_id}
	</update>
	<update id="updateTeamGelStockData_daySta_com" parameterType="map">
		update wms_personnel_achievement_daysta a inner join (
			SELECT
							a.bel_general_manager_id,
							a.bel_general_manager_dept_id,
							sum(ifnull(w.product_account, 0)) as allpro_stock,
							sum(ifnull(w.product_account*w.product_deadline/12, 0)) as allpro_stock_deal,
							sum(if(ifnull(a.old_date_of_payment,a.date_of_payment)>=#{limit_date} and w.wms_inve_pruduct_category_id in (${new_pros}) ,w.product_account,0)) as newpro_stock,
							sum(if(ifnull(a.old_date_of_payment,a.date_of_payment)>=#{limit_date} and w.wms_inve_pruduct_category_id in (${new_pros}) ,w.product_account*w.product_deadline/12,0)) as newpro_stock_deal
						FROM
							wms_inve_transa a,
							wms_inve_transa_prod w
						WHERE
							a.data_status = '4'
							and exists (select 1 from wms_inve_transa_protocol c where c.wms_inve_transa_id=a.wms_inve_transa_id and c.end_of_date>=DATE_SUB(#{sta_end_date},INTERVAL 1 DAY) LIMIT 1) 
							and #{sta_end_date}>a.date_of_payment
							and a.wms_inve_transa_id=w.wms_inve_transa_id
							and w.wms_inve_pruduct_category_id not in (${reject_proid})
							and exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=a.wms_inve_customer_id
										and x.end_of_date>ifnull(a.old_date_of_payment,a.date_of_payment)
										and x.data_type='1'
									)
							group by a.bel_general_manager_id,a.bel_general_manager_dept_id
			) c
			on a.personnel_id=c.bel_general_manager_id and a.dept_id=c.bel_general_manager_dept_id
			set a.team_stock_all=c.allpro_stock,
				a.team_stock_all_deal=c.allpro_stock_deal,
				a.team_stock_new=c.newpro_stock,
				a.team_stock_new_deal=c.newpro_stock_deal
			where a.statics_personnel_id=#{statics_personnel_id}
			and a.personnel_name_detail ='冯涛 100006(转)'
	</update>
	
	<insert id="insertPersonnelStockData_daySta" parameterType="map">
		insert into wms_personnel_achievement_daysta
		(
			statics_personnel_id,
			company_id,
			company_name,
			dept_id,
			dept_name,
			personnel_id,
			personnel_name_detail,
			post_number,
			post_name,
			personnel_state,
			per_stock_all,
			per_stock_all_deal,
			per_stock_new,
			per_stock_new_deal,
			per_stock_lev
		)
		select 
			#{statics_personnel_id},
			getParentDeptIdByDeptId(a.personnel_deptid),
			getParenetDeptNameByDeptId(a.personnel_deptid),
			a.personnel_deptid,
			(select x.dept_name from sys_dept x where x.dept_id=a.personnel_deptid ),
			a.personnel_id,
			CONCAT(a.personnel_name,' ',a.personnel_shortcode),
			a.personnel_postid,
			a.personnel_postname,
			a.personnel_state,
			product_account,
			product_account_deal,
			new_product_account,
			new_product_account_deal,
			case 
						when product_account/10000 &lt; 100 THEN 'A'
						when product_account/10000>=100 and 300>product_account/10000 THEN 'B'
						when product_account/10000>=300 and 500>product_account/10000 THEN 'C'
						when product_account/10000>=500 and 700>product_account/10000 THEN 'D'
						when product_account/10000>=700 and 900>product_account/10000 THEN 'E'
						when product_account/10000>=900 and 1100>product_account/10000 THEN 'F'
						when product_account/10000>=1100 and 1300>product_account/10000 THEN 'G'
						when product_account/10000>=1300 and 1500>product_account/10000 THEN 'H'
						when product_account/10000>=1500 and 1700>product_account/10000 THEN 'I'
						when product_account/10000>=1700 and 1900>product_account/10000 THEN 'J'
						when product_account/10000>=1900 and 2100>product_account/10000 THEN 'K'
					END
		from
					(
					SELECT
						a.personnel_deptid,a.personnel_id,a.personnel_name,a.personnel_shortcode,a.personnel_postid,a.personnel_postname,a.personnel_state
					FROM
						pm_personnel a
					UNION
						SELECT
							b.dept_id as personnel_deptid,a.personnel_id,a.personnel_name,a.personnel_shortcode,b.post_id as personnel_postid,a.personnel_postname,a.personnel_state
						FROM
							pm_personnel a,
							sys_concurrent_post b
						WHERE
							a.personnel_id = b.personnel_id
					) a
					left join (
								SELECT
									a.bel_salesman_id_id,
									a.bel_salesman_dept_id,
									sum(ifnull(b.product_account,0)) as product_account,
									sum(ifnull(b.product_account,0)*b.product_deadline/12) as product_account_deal,
									sum((case when ifnull(a.old_date_of_payment,a.date_of_payment) >= #{limit_date} and b.wms_inve_pruduct_category_id in (${new_pros})   then ifnull(b.product_account,0) else 0 end)) as new_product_account,
									sum((case when ifnull(a.old_date_of_payment,a.date_of_payment) >= #{limit_date} and b.wms_inve_pruduct_category_id in (${new_pros})   then ifnull(b.product_account,0) else 0 end)*b.product_deadline/12) as new_product_account_deal
								FROM
									wms_inve_transa a,
									wms_inve_transa_prod b
								WHERE
									a.data_status = '4'
								and exists (select 1 from wms_inve_transa_protocol c where c.wms_inve_transa_id=a.wms_inve_transa_id and c.end_of_date>=DATE_SUB(#{sta_end_date},INTERVAL 1 DAY) LIMIT 1) 	
								and a.date_of_payment &lt; #{sta_end_date}
								and b.wms_inve_pruduct_category_id not in (${reject_proid})
								AND a.wms_inve_transa_id = b.wms_inve_transa_id
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=a.wms_inve_customer_id
										and ifnull(a.old_date_of_payment,a.date_of_payment) &lt; x.end_of_date
										and x.data_type='1'
									)
								group by a.bel_salesman_id_id,a.bel_salesman_dept_id
							) c
			on a.personnel_id=c.bel_salesman_id_id and a.personnel_deptid=c.bel_salesman_dept_id
	</insert>
	<update id="updatePerAllAddData_daySta" parameterType="map">
		update wms_personnel_achievement_daysta a INNER JOIN
		(
			SELECT
				f.bel_salesman_id_id,
				f.bel_salesman_dept_id,
				sum(ifnull(f.all_add,0)) as who_all_add,
				sum(ifnull(f.deal_add,0)) as who_deal_add,
				sum(ifnull(f.per_redeem_base,0)) as per_redeem_base,
				sum(ifnull(f.per_redeem_deal,0)) as per_redeem_deal, 
				sum(per_back_base) as per_back_base, 
				sum(per_back_deal) as per_back_deal, 
				sum(f.clear_add) as who_clear_add,  
				sum(f.mon_deal_who) as who_clear_add_deal, 
				sum(per_back_base_newpro) as per_back_base_newpro, 
				sum(per_back_deal_newpro) as per_back_deal_newpro 
			FROM
				(
					SELECT
						c.bel_salesman_id_id,
						c.bel_salesman_dept_id,
						c.wms_inve_customer_id,
						c.cus_all_inve as all_add,
						c.cus_deal_add as deal_add,
						ifnull(e.sub_am, 0) as per_redeem_base,
						ifnull(e.sub_deal_am, 0) as per_redeem_deal,
						if(c.cus_all_inve>=ifnull(e.back_sub_am, 0),ifnull(e.back_sub_am, 0),c.cus_all_inve) as per_back_base,
						if(c.cus_deal_add>=ifnull(e.back_sub_deal_am, 0),ifnull(e.back_sub_deal_am, 0),c.cus_deal_add) as per_back_deal,
						if(c.cus_all_inve>=ifnull(e.back_newpro_subam, 0),ifnull(e.back_newpro_subam, 0),c.cus_all_inve) as per_back_base_newpro,
						if(c.cus_deal_add>=ifnull(e.back_newpro_subam_deal, 0),ifnull(e.back_newpro_subam_deal, 0),c.cus_deal_add) as per_back_deal_newpro,
						c.cus_all_inve-ifnull(e.sub_am, 0) AS clear_add,
						c.cus_deal_add-ifnull(e.sub_deal_am, 0) as mon_deal_who 
					FROM
						(
							SELECT
								b.bel_salesman_id_id,
								b.bel_salesman_dept_id,
								b.wms_inve_customer_id,
								sum(ifnull(b.act_account, 0)) as cus_all_inve,
								sum(ifnull(b.deal_account,0)) as cus_deal_add
							FROM
								(
									SELECT
										a.bel_salesman_id_id,
										a.bel_salesman_dept_id,
										a.wms_inve_customer_id,
										(w.org_product_account-ifnull(d.no_damage_am,0)) as act_account,
										(w.org_product_account-ifnull(d.no_damage_am,0))*w.product_deadline/12/(if(w.wms_inve_pruduct_category_id in (${specialpro}),4,1)) as deal_account
									FROM
										wms_inve_transa a,
										wms_inve_transa_prod w
										left join 
										(
											select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												AND c.data_status != '7'
												group by b.wms_inve_transa_id
										) d on w.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										a.data_status IN ('4','5','6')
									and w.wms_inve_pruduct_category_id not in (${reject_proid})
									AND a.wms_inve_transa_id = w.wms_inve_transa_id
									AND a.date_of_payment >= #{sta_begin_date}
									AND a.date_of_payment &lt; #{sta_end_date}
									and a.old_wms_inve_transa_id is null
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=a.wms_inve_customer_id
										and ifnull(a.old_date_of_payment,a.date_of_payment) &lt; x.end_of_date
										and x.data_type='1'
									)
								) b
							GROUP BY
								b.bel_salesman_id_id,
								b.wms_inve_customer_id,
								b.bel_salesman_dept_id
						) c LEFT JOIN (
							SELECT
								d.wms_inve_customer_id,
								d.bel_salesman_id_id,
								d.bel_salesman_dept_id,
								sum(ifnull(d.sub_am, 0)) AS sub_am,
								sum(ifnull(d.back_sub_am, 0)) AS back_sub_am,
								sum(ifnull(d.sub_deal_am, 0)) AS sub_deal_am,
								sum(ifnull(d.back_sub_deal_am, 0)) AS back_sub_deal_am,
								sum(ifnull(d.newpro_subam, 0)) AS newpro_subam,
								sum(ifnull(d.back_newpro_subam, 0)) AS back_newpro_subam,
								sum(ifnull(d.newpro_subam_deal, 0)) AS newpro_subam_deal,
								sum(ifnull(d.back_newpro_subam_deal, 0)) AS back_newpro_subam_deal
							FROM
								(
									SELECT
										d.wms_inve_customer_id,
										x.bel_salesman_id_id,
										x.bel_salesman_dept_id,
										v.redeem_amount AS sub_am,
										if(d.is_take_off_damages='0' and d.redeem_company_reason='2' and d.redeem_type in ('1','3'),v.redeem_amount,0) as back_sub_am,
										v.redeem_amount * u.product_deadline / 12 AS sub_deal_am,
										if(d.is_take_off_damages='0' and d.redeem_company_reason='2' and d.redeem_type in ('1','3'),v.redeem_amount,0)* u.product_deadline / 12 as back_sub_deal_am,
										if(u.wms_inve_pruduct_category_id in (${new_pros}),v.redeem_amount,0) as newpro_subam,
										if(d.is_take_off_damages='0' and d.redeem_company_reason='2' and d.redeem_type in ('1','3') and u.wms_inve_pruduct_category_id in (${new_pros}),v.redeem_amount,0) as back_newpro_subam,
										if(u.wms_inve_pruduct_category_id in (${new_pros}),v.redeem_amount * u.product_deadline / 12,0) as newpro_subam_deal,
										if(d.is_take_off_damages='0' and d.redeem_company_reason='2' and d.redeem_type in ('1','3') and u.wms_inve_pruduct_category_id in (${new_pros}),v.redeem_amount,0)* u.product_deadline / 12 as back_newpro_subam_deal
									FROM
										wms_inve_redeem d,
										wms_inve_redeem_detail v,
										wms_inve_transa_prod u,
										wms_inve_transa x
									WHERE
										d.redeem_date >= #{sta_begin_date}
									AND date_format(#{sta_end_date},'%Y-%m-%d') >= d.redeem_date
									AND d.redeem_type not IN ('2')
									AND d.data_status IN ('6')
									and x.data_status in ('4','5','6')
									and (date_format(#{sta_begin_date},'%Y-%m-%d') > x.date_of_payment or (x.date_of_payment>=#{sta_begin_date} and d.is_take_off_damages = '1'))
									AND d.wms_inve_redeem_id = v.wms_inve_redeem_id
									AND v.wms_inve_transa_id = u.wms_inve_transa_id
									AND u.wms_inve_transa_id = x.wms_inve_transa_id
									and u.wms_inve_pruduct_category_id not in (${reject_proid})
									and u.wms_inve_pruduct_category_id not in (${specialpro})
									and not exists (select 1 from wms_inve_customer_remove_his h where h.wms_inve_customer_id=x.wms_inve_customer_id
														and h.end_of_date > ifnull(x.old_date_of_payment,x.date_of_payment)
														and h.data_type='1'
													)
								UNION ALL
									SELECT
										d.wms_inve_customer_id,
										x.bel_salesman_id_id,
										x.bel_salesman_dept_id,
										v.redeem_amount  AS sub_am,
										if(d.is_take_off_damages='0'
											and d.redeem_company_reason='2' 
											and d.redeem_type in ('1','3') 
											and d.redeem_date >= x.date_of_payment
											AND DATE_ADD(x.date_of_payment,INTERVAL 3  MONTH) >= d.redeem_date
											,v.redeem_amount,0) as back_sub_am,
										v.redeem_amount * u.product_deadline / 12 /4 AS sub_deal_am,
										if(d.is_take_off_damages='0' 
											and d.redeem_company_reason='2'
											and d.redeem_type in ('1','3') 
											and d.redeem_date >= x.date_of_payment
											AND DATE_ADD(x.date_of_payment,INTERVAL 3  MONTH) >= d.redeem_date
											,v.redeem_amount,0)* u.product_deadline / 12 /4 as back_sub_deal_am,
										v.redeem_amount as newpro_subam,
										if(d.is_take_off_damages='0' 
											and d.redeem_company_reason='2'
											and d.redeem_type in ('1','3') 
											and d.redeem_date >= x.date_of_payment
											AND DATE_ADD(x.date_of_payment,INTERVAL 3  MONTH) >= d.redeem_date
											,v.redeem_amount,0) as back_newpro_subam,
										v.redeem_amount * u.product_deadline / 12 /4 as newpro_subam_deal,
										if(d.is_take_off_damages='0'
											and d.redeem_company_reason='2' 
											and d.redeem_type in ('1','3') 
											and d.redeem_date >= x.date_of_payment
											AND DATE_ADD(x.date_of_payment,INTERVAL 3  MONTH) >= d.redeem_date
											,v.redeem_amount,0)* u.product_deadline / 12 /4 as back_newpro_subam_deal
									FROM
										wms_inve_redeem d,
										wms_inve_redeem_detail v,
										wms_inve_transa_prod u,
										wms_inve_transa x
									WHERE
										d.redeem_date >= #{sta_begin_date}
									AND date_format(#{sta_end_date},'%Y-%m-%d') >= d.redeem_date
									AND d.redeem_type not IN ('2')
									AND d.data_status IN ('6')
									and x.data_status in ('4','5','6')
									and (date_format(#{sta_begin_date},'%Y-%m-%d')>x.date_of_payment or (x.date_of_payment>=#{sta_begin_date} and d.is_take_off_damages = '1'))
									AND d.wms_inve_redeem_id = v.wms_inve_redeem_id
									AND v.wms_inve_transa_id = u.wms_inve_transa_id
									AND u.wms_inve_transa_id = x.wms_inve_transa_id
									and u.wms_inve_pruduct_category_id in (${specialpro})
									and not exists (select 1 from wms_inve_customer_remove_his h where h.wms_inve_customer_id=x.wms_inve_customer_id
													and h.end_of_date>ifnull(x.old_date_of_payment,x.date_of_payment)
													and h.data_type='1'
												)
								) d
							GROUP BY
								d.wms_inve_customer_id,
								d.bel_salesman_id_id,
								d.bel_salesman_dept_id
						) e ON c.wms_inve_customer_id = e.wms_inve_customer_id and c.bel_salesman_id_id=e.bel_salesman_id_id and c.bel_salesman_dept_id=e.bel_salesman_dept_id
						UNION
							SELECT
								e.bel_salesman_id_id,
								e.bel_salesman_dept_id,
								c.wms_inve_customer_id,
								ifnull(c.cus_all_inve, 0) as all_add,
								ifnull(c.cus_deal_add, 0) as deal_add,
								ifnull(e.sub_am, 0) as per_redeem_base,
								ifnull(e.sub_deal_am, 0) as per_redeem_deal,
								if(ifnull(c.cus_all_inve, 0)>=ifnull(e.back_sub_am, 0),ifnull(e.back_sub_am, 0),ifnull(c.cus_all_inve, 0)) as per_back_base,
								if(ifnull(c.cus_deal_add, 0)>=ifnull(e.back_sub_deal_am, 0),ifnull(e.back_sub_deal_am, 0),ifnull(c.cus_deal_add, 0)) as per_back_deal,
								if(ifnull(c.cus_all_inve, 0)>=ifnull(e.back_newpro_subam, 0),ifnull(e.back_newpro_subam, 0),ifnull(c.cus_all_inve, 0)) as per_back_base_newpro,
								if(ifnull(c.cus_deal_add, 0)>=ifnull(e.back_newpro_subam_deal, 0),ifnull(e.back_newpro_subam_deal, 0),ifnull(c.cus_deal_add, 0)) as per_back_deal_newpro,
								ifnull(c.cus_all_inve, 0)-ifnull(e.sub_am, 0) AS clear_add,
								ifnull(c.cus_deal_add, 0)-ifnull(e.sub_deal_am, 0) as mon_deal_who 
								
							FROM
								(
									SELECT
										d.wms_inve_customer_id,
										d.bel_salesman_id_id,
										d.bel_salesman_dept_id,
										sum(ifnull(d.sub_am, 0)) AS sub_am,
										sum(ifnull(d.back_sub_am, 0)) AS back_sub_am,
										sum(ifnull(d.sub_deal_am, 0)) AS sub_deal_am,
										sum(ifnull(d.back_sub_deal_am, 0)) AS back_sub_deal_am,
										sum(ifnull(d.newpro_subam, 0)) AS newpro_subam,
										sum(ifnull(d.back_newpro_subam, 0)) AS back_newpro_subam,
										sum(ifnull(d.newpro_subam_deal, 0)) AS newpro_subam_deal,
										sum(ifnull(d.back_newpro_subam_deal, 0)) AS back_newpro_subam_deal
									FROM
										(
											SELECT
												d.wms_inve_customer_id,
												x.bel_salesman_id_id,
												x.bel_salesman_dept_id,
												v.redeem_amount AS sub_am,
												if(d.is_take_off_damages='0' and d.redeem_company_reason='2' and d.redeem_type in ('1','3'),v.redeem_amount,0) as back_sub_am,
												v.redeem_amount * u.product_deadline / 12 AS sub_deal_am,
												if(d.is_take_off_damages='0' and d.redeem_company_reason='2' and d.redeem_type in ('1','3'),v.redeem_amount,0)* u.product_deadline / 12 as back_sub_deal_am,
												if(u.wms_inve_pruduct_category_id in (${new_pros}),v.redeem_amount,0) as newpro_subam,
												if(d.is_take_off_damages='0' and d.redeem_company_reason='2' and d.redeem_type in ('1','3') and u.wms_inve_pruduct_category_id in (${new_pros}),v.redeem_amount,0) as back_newpro_subam,
												if(u.wms_inve_pruduct_category_id in (${new_pros}),v.redeem_amount * u.product_deadline / 12,0) as newpro_subam_deal,
												if(d.is_take_off_damages='0' and d.redeem_company_reason='2' and d.redeem_type in ('1','3') and u.wms_inve_pruduct_category_id in (${new_pros}),v.redeem_amount,0)* u.product_deadline / 12 as back_newpro_subam_deal
											FROM
												wms_inve_redeem d,
												wms_inve_redeem_detail v,
												wms_inve_transa_prod u,
												wms_inve_transa x
											WHERE
												d.redeem_date >= #{sta_begin_date}
											AND date_format(#{sta_end_date},'%Y-%m-%d') >= d.redeem_date
											AND d.redeem_type not IN ('2')
											AND d.data_status IN ('6')
											and x.data_status in ('4','5','6')
											and (date_format(#{sta_begin_date},'%Y-%m-%d')>x.date_of_payment or (x.date_of_payment>=#{sta_begin_date} and d.is_take_off_damages = '1'))
											AND d.wms_inve_redeem_id = v.wms_inve_redeem_id
											AND v.wms_inve_transa_id = u.wms_inve_transa_id
											AND u.wms_inve_transa_id = x.wms_inve_transa_id
											and u.wms_inve_pruduct_category_id not in (${reject_proid})
											and u.wms_inve_pruduct_category_id not in (${specialpro})
											and not exists (select 1 from wms_inve_customer_remove_his h where h.wms_inve_customer_id=x.wms_inve_customer_id
																and h.end_of_date>ifnull(x.old_date_of_payment,x.date_of_payment)
																and h.data_type='1'
															)
											UNION ALL
											SELECT
												d.wms_inve_customer_id,
												x.bel_salesman_id_id,
												x.bel_salesman_dept_id,
												v.redeem_amount  AS sub_am,
												if(d.is_take_off_damages='0'
													and d.redeem_company_reason='2' 
													and d.redeem_type in ('1','3') 
													and d.redeem_date >= x.date_of_payment
													AND DATE_ADD(x.date_of_payment,INTERVAL 3  MONTH) >= d.redeem_date
													,v.redeem_amount,0) as back_sub_am,
												v.redeem_amount * u.product_deadline / 12 /4 AS sub_deal_am,
												if(d.is_take_off_damages='0' 
													and d.redeem_company_reason='2'
													and d.redeem_type in ('1','3') 
													and d.redeem_date >= x.date_of_payment
													AND DATE_ADD(x.date_of_payment,INTERVAL 3  MONTH) >= d.redeem_date
													,v.redeem_amount,0)* u.product_deadline / 12 /4 as back_sub_deal_am,
												v.redeem_amount as newpro_subam,
												if(d.is_take_off_damages='0' 
													and d.redeem_company_reason='2'
													and d.redeem_type in ('1','3') 
													and d.redeem_date >= x.date_of_payment
													AND DATE_ADD(x.date_of_payment,INTERVAL 3  MONTH) >= d.redeem_date
													,v.redeem_amount,0) as back_newpro_subam,
												v.redeem_amount * u.product_deadline / 12 /4 as newpro_subam_deal,
												if(d.is_take_off_damages='0' 
													and d.redeem_company_reason='2'
													and d.redeem_type in ('1','3') 
													and d.redeem_date >=x.date_of_payment
													AND DATE_ADD(x.date_of_payment,INTERVAL 3  MONTH) >= d.redeem_date
													,v.redeem_amount,0)* u.product_deadline / 12 /4 as back_newpro_subam_deal
												
											FROM
												wms_inve_redeem d,
												wms_inve_redeem_detail v,
												wms_inve_transa_prod u,
												wms_inve_transa x
											WHERE
												d.redeem_date >= #{sta_begin_date}
											AND date_format(#{sta_end_date},'%Y-%m-%d') >= d.redeem_date
											AND d.redeem_type not IN ('2')
											AND d.data_status IN ('6')
											and x.data_status in ('4','5','6')
											and (date_format(#{sta_begin_date},'%Y-%m-%d')>x.date_of_payment or (x.date_of_payment>=#{sta_begin_date} and d.is_take_off_damages = '1'))
											AND d.wms_inve_redeem_id = v.wms_inve_redeem_id
											AND v.wms_inve_transa_id = u.wms_inve_transa_id
											AND u.wms_inve_transa_id = x.wms_inve_transa_id
											and u.wms_inve_pruduct_category_id in (${specialpro})
											
											and not exists (select 1 from wms_inve_customer_remove_his h where h.wms_inve_customer_id=x.wms_inve_customer_id
															and h.end_of_date>ifnull(x.old_date_of_payment,x.date_of_payment)
															and h.data_type='1'
														)
										) d
									GROUP BY
										d.wms_inve_customer_id,
										d.bel_salesman_id_id,
										d.bel_salesman_dept_id
								) e LEFT JOIN
								(
									SELECT
										b.bel_salesman_id_id,
										b.bel_salesman_dept_id,
										b.wms_inve_customer_id,
										sum(ifnull(b.act_account, 0)) as cus_all_inve,
										sum(ifnull(b.deal_account,0)) as cus_deal_add
									FROM
										(
											SELECT
												a.bel_salesman_id_id,
												a.bel_salesman_dept_id,
												a.wms_inve_customer_id,
												(w.org_product_account-ifnull(d.no_damage_am,0)) as act_account,
												(w.org_product_account-ifnull(d.no_damage_am,0))*w.product_deadline/12/(if(w.wms_inve_pruduct_category_id in (${specialpro}),4,1)) as deal_account
											FROM
												wms_inve_transa a,
												wms_inve_transa_prod w
												left join 
												(
													select 
														b.wms_inve_transa_id,
														sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
													from 
														wms_inve_redeem c,
														wms_inve_redeem_detail b 
													where 
														c.wms_inve_redeem_id=b.wms_inve_redeem_id 
														and c.redeem_date >= #{sta_begin_date}
														AND #{sta_end_date}>c.redeem_date 
														AND c.data_status != '7'
														group by b.wms_inve_transa_id
												) d on w.wms_inve_transa_id=d.wms_inve_transa_id
											WHERE
												a.data_status IN ('4','5','6')
											and w.wms_inve_pruduct_category_id not in (${reject_proid})
											AND a.wms_inve_transa_id = w.wms_inve_transa_id
											AND a.date_of_payment >= #{sta_begin_date}
											and a.old_wms_inve_transa_id is null
											AND date_format(#{sta_end_date},'%Y-%m-%d')>a.date_of_payment
											and not exists (
																select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=a.wms_inve_customer_id
																and x.end_of_date>ifnull(a.old_date_of_payment,a.date_of_payment)
																and x.data_type='1'
															)
											
										) b
									GROUP BY
										b.bel_salesman_id_id,
										b.wms_inve_customer_id,
										b.bel_salesman_dept_id
								) c ON c.wms_inve_customer_id = e.wms_inve_customer_id and c.bel_salesman_id_id=e.bel_salesman_id_id and c.bel_salesman_dept_id=e.bel_salesman_dept_id
				) f
		
			GROUP BY
				f.bel_salesman_id_id,f.bel_salesman_dept_id
		) b on a.personnel_id = b.bel_salesman_id_id and a.dept_id=b.bel_salesman_dept_id
		set 
			a.per_add_base=b.who_all_add,
			a.per_add_deal=b.who_deal_add,
			a.per_redeem_base=b.per_redeem_base,
			a.per_redeem_deal=b.per_redeem_deal,
			a.per_back_base=b.per_back_base,
			a.per_back_deal=b.per_back_deal,
			a.per_clear_add=b.who_clear_add,
			a.per_clear_add_deal=b.who_clear_add_deal,
			a.per_back_base_newpro=b.per_back_base_newpro,
			a.per_back_deal_newpro=b.per_back_deal_newpro
		where a.personnel_name_detail !='冯涛 100006(转)'
		and a.statics_personnel_id=#{statics_personnel_id}
	</update>
	
	<update id="updateTeamDeptStockData_daySta" parameterType="map">
		update wms_personnel_achievement_daysta a inner join (
			SELECT
							a.bel_department_manager_id,
							a.bel_department_manager_dept_id,
							sum(ifnull(w.product_account, 0)) as allpro_stock,
							sum(ifnull(w.product_account*w.product_deadline/12, 0)) as allpro_stock_deal,
							sum(if(ifnull(a.old_date_of_payment,a.date_of_payment)>=#{limit_date} and w.wms_inve_pruduct_category_id in (${new_pros}) ,w.product_account,0)) as newpro_stock,
							sum(if(ifnull(a.old_date_of_payment,a.date_of_payment)>=#{limit_date} and w.wms_inve_pruduct_category_id in (${new_pros}) ,w.product_account*w.product_deadline/12,0)) as newpro_stock_deal
						FROM
							wms_inve_transa a,
							wms_inve_transa_prod w
						WHERE
							a.data_status = '4'
							and exists (select 1 from wms_inve_transa_protocol c where c.wms_inve_transa_id=a.wms_inve_transa_id and c.end_of_date>=DATE_SUB(#{sta_end_date},INTERVAL 1 DAY) LIMIT 1) 
							and #{sta_end_date}>a.date_of_payment
							and a.wms_inve_transa_id=w.wms_inve_transa_id
							and w.wms_inve_pruduct_category_id not in (${reject_proid})
							and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=a.wms_inve_customer_id
										and x.end_of_date>ifnull(a.old_date_of_payment,a.date_of_payment)
										and x.data_type='1'
									)
							group by a.bel_department_manager_id,a.bel_department_manager_dept_id
			) c
			on a.personnel_id=c.bel_department_manager_id and a.dept_id=c.bel_department_manager_dept_id
			set 
				a.team_stock_all=c.allpro_stock,
				a.team_stock_all_deal=c.allpro_stock_deal,
				a.team_stock_new=c.newpro_stock,
				a.team_stock_new_deal=c.newpro_stock_deal,
				a.is_team_handler='1'
			where a.statics_personnel_id=#{statics_personnel_id}
	</update>
	
	<update id="updateTeamViceStockData_daySta" parameterType="map">
		update wms_personnel_achievement_daysta a inner join (
			SELECT
							a.bel_vice_general_manager_id,
							a.bel_vice_general_manager_dept_id,
							sum(ifnull(w.product_account, 0)) as allpro_stock,
							sum(ifnull(w.product_account*w.product_deadline/12, 0)) as allpro_stock_deal,
							sum(if(ifnull(a.old_date_of_payment,a.date_of_payment)>=#{limit_date} and w.wms_inve_pruduct_category_id in (${new_pros}) ,w.product_account,0)) as newpro_stock,
							sum(if(ifnull(a.old_date_of_payment,a.date_of_payment)>=#{limit_date} and w.wms_inve_pruduct_category_id in (${new_pros}) ,w.product_account*w.product_deadline/12,0)) as newpro_stock_deal
						FROM
							wms_inve_transa a,
							wms_inve_transa_prod w
						WHERE
							a.data_status = '4'
							and exists (select 1 from wms_inve_transa_protocol c where c.wms_inve_transa_id=a.wms_inve_transa_id and c.end_of_date>=DATE_SUB(#{sta_end_date},INTERVAL 1 DAY) LIMIT 1) 
							and #{sta_end_date}>a.date_of_payment
							and a.wms_inve_transa_id=w.wms_inve_transa_id
							and w.wms_inve_pruduct_category_id not in (${reject_proid})
							and a.bel_center_manager_id is null
							group by a.bel_vice_general_manager_id,a.bel_vice_general_manager_dept_id
			) c
			on a.personnel_id=c.bel_vice_general_manager_id and a.dept_id=c.bel_vice_general_manager_dept_id
			set a.team_stock_all=c.allpro_stock,
				a.team_stock_all_deal=c.allpro_stock_deal,
				a.team_stock_new=c.newpro_stock,
				a.team_stock_new_deal=c.newpro_stock_deal
			where a.statics_personnel_id=#{statics_personnel_id}
	</update>
	
	<update id="updateTeamCenterStockData_daySta" parameterType="map">
		update wms_personnel_achievement_daysta a inner join (
			SELECT
							a.bel_center_manager_id,
							a.bel_center_manager_dept_id,
							sum(ifnull(w.product_account, 0)) as allpro_stock,
							sum(ifnull(w.product_account*w.product_deadline/12, 0)) as allpro_stock_deal,
							sum(if(ifnull(a.old_date_of_payment,a.date_of_payment)>=#{limit_date} and w.wms_inve_pruduct_category_id in (${new_pros}) ,w.product_account,0)) as newpro_stock,
							sum(if(ifnull(a.old_date_of_payment,a.date_of_payment)>=#{limit_date} and w.wms_inve_pruduct_category_id in (${new_pros}) ,w.product_account*w.product_deadline/12,0)) as newpro_stock_deal
						FROM
							wms_inve_transa a,
							wms_inve_transa_prod w
						WHERE
							a.data_status = '4'
							and exists (select 1 from wms_inve_transa_protocol c where c.wms_inve_transa_id=a.wms_inve_transa_id and c.end_of_date>=DATE_SUB(#{sta_end_date},INTERVAL 1 DAY) LIMIT 1) 
							and #{sta_end_date}>a.date_of_payment
							and a.wms_inve_transa_id=w.wms_inve_transa_id
							and w.wms_inve_pruduct_category_id not in (${reject_proid})
							
							group by a.bel_center_manager_id,a.bel_center_manager_dept_id
			) c
			on a.personnel_id=c.bel_center_manager_id and a.dept_id=c.bel_center_manager_dept_id
			set a.team_stock_all=c.allpro_stock,
				a.team_stock_all_deal=c.allpro_stock_deal,
				a.team_stock_new=c.newpro_stock,
				a.team_stock_new_deal=c.newpro_stock_deal
			where a.statics_personnel_id=#{statics_personnel_id}
	</update>
	
	<update id="updateTeamDeptAddData_daySta" parameterType="map">
		update wms_personnel_achievement_daysta a inner join (
			select 
				f.bel_department_manager_dept_id,
				f.all_add,
				f.redeem_all,
				f.cle_add,
				f.deal_pro_add,
				redeem_all_deal,
				cle_add_deal
			from (
				SELECT
								a.bel_department_manager_dept_id,
								a.all_pro_acc as all_add,
								ifnull(c.redeem_all, 0) as redeem_all,
								a.all_pro_acc - ifnull(c.redeem_all, 0) as cle_add,
								a.deal_pro_add,
								ifnull(c.redeem_all_deal, 0) as redeem_all_deal,
								a.deal_pro_add-ifnull(c.redeem_all_deal, 0) as cle_add_deal
							FROM
								(
									SELECT
										g.bel_department_manager_dept_id,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))) as all_pro_acc,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))*h.product_deadline/12/(if(h.wms_inve_pruduct_category_id in (${specialpro}),4,1))) as deal_pro_add
									FROM
										wms_inve_transa g,
										wms_inve_transa_prod h
										left join
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												AND c.data_status != '7'
												group by b.wms_inve_transa_id
												)
												d
												on h.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										g.wms_inve_transa_id = h.wms_inve_transa_id
									AND g.data_status in ('4','5','6')
									and h.wms_inve_pruduct_category_id not in (${reject_proid})
									AND g.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>g.date_of_payment
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=g.wms_inve_customer_id
										and x.end_of_date>ifnull(g.old_date_of_payment,g.date_of_payment)
										and x.data_type='1'
									)
									group by g.bel_department_manager_dept_id
								) a
							LEFT JOIN (
								SELECT
									n.bel_department_manager_dept_id,
									sum(ifnull(v.redeem_amount,0)) AS redeem_all,
									sum(ifnull(v.redeem_amount,0)*x.product_deadline/12/(if(x.wms_inve_pruduct_category_id in (${specialpro}),4,1))) AS redeem_all_deal
								FROM
									wms_inve_redeem b,
									wms_inve_redeem_detail v,
									wms_inve_transa_prod x,
									wms_inve_transa n LEFT JOIN wms_inve_comm_team_set t on n.bel_department_manager_dept_id=t.dept_id	and t.enable_flag='1'
								WHERE
									b.redeem_date >= #{sta_begin_date}
								AND #{sta_end_date}>b.redeem_date
								and b.data_status in ('6')
								and n.data_status in ('4','5','6')
								and b.data_status !='7'
								and (#{sta_begin_date}>n.date_of_payment or (n.date_of_payment>=#{sta_begin_date} and b.is_take_off_damages = '1')) 
								and n.date_of_payment>=ifnull(t.begin_date,'1999-01-01')
								and x.wms_inve_pruduct_category_id not in (${reject_proid})
								AND b.wms_inve_redeem_id = v.wms_inve_redeem_id
								AND v.wms_inve_transa_id = x.wms_inve_transa_id
								and n.wms_inve_transa_id=x.wms_inve_transa_id
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=n.wms_inve_customer_id
										and x.end_of_date>ifnull(n.old_date_of_payment,n.date_of_payment)
										and x.data_type='1'
									)
								group by n.bel_department_manager_dept_id
							) c ON a.bel_department_manager_dept_id = c.bel_department_manager_dept_id 
				UNION
				SELECT
								c.bel_department_manager_dept_id,
								ifnull(a.all_pro_acc,0) as all_add,
								ifnull(c.redeem_all, 0) as redeem_all,
								ifnull(a.all_pro_acc,0) - ifnull(c.redeem_all, 0) as cle_add,
								ifnull(a.deal_pro_add,0) as deal_pro_add,
								ifnull(c.redeem_all_deal, 0) as redeem_all_deal,
								ifnull(a.deal_pro_add,0)-ifnull(c.redeem_all_deal, 0) as cle_add_deal
								
								
							FROM
				(
								SELECT
									n.bel_department_manager_dept_id,
									sum(ifnull(v.redeem_amount,0)) AS redeem_all,
									sum(ifnull(v.redeem_amount,0)*x.product_deadline/12/(if(x.wms_inve_pruduct_category_id in (${specialpro}),4,1))) AS redeem_all_deal
								FROM
									wms_inve_redeem b,
									wms_inve_redeem_detail v,
									wms_inve_transa_prod x,
									wms_inve_transa n LEFT JOIN wms_inve_comm_team_set t on n.bel_department_manager_dept_id=t.dept_id	and t.enable_flag='1'	
								WHERE
									b.redeem_date >= #{sta_begin_date}
								AND #{sta_end_date}>b.redeem_date
								and b.data_status in ('6')
								and b.redeem_type not IN ('3','5')
								and n.data_status in ('4','5','6')
								and b.data_status !='7'
								and (#{sta_begin_date}>n.date_of_payment or (n.date_of_payment>=#{sta_begin_date} and b.is_take_off_damages = '1')) 
								and n.date_of_payment>=ifnull(t.begin_date,'1999-01-01')
								and x.wms_inve_pruduct_category_id not in (${reject_proid})
								AND b.wms_inve_redeem_id = v.wms_inve_redeem_id
								AND v.wms_inve_transa_id = x.wms_inve_transa_id
								and n.wms_inve_transa_id=x.wms_inve_transa_id
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=n.wms_inve_customer_id
										and x.end_of_date>ifnull(n.old_date_of_payment,n.date_of_payment)
										and x.data_type='1'
									)
								group by n.bel_department_manager_dept_id
							) c 
				LEFT JOIN
				(
									SELECT
										g.bel_department_manager_dept_id,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))) as all_pro_acc,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))*h.product_deadline/12/(if(h.wms_inve_pruduct_category_id in (${specialpro}),4,1))) as deal_pro_add
									FROM
										wms_inve_transa g,
										wms_inve_transa_prod h
										left join
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												AND c.data_status != '7'
												group by b.wms_inve_transa_id
												)
												d
												on h.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										g.wms_inve_transa_id = h.wms_inve_transa_id
									AND g.data_status in ('4','5','6')
									and h.wms_inve_pruduct_category_id not in (${reject_proid})
									AND g.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>g.date_of_payment
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=g.wms_inve_customer_id
										and x.end_of_date>ifnull(g.old_date_of_payment,g.date_of_payment)
										and x.data_type='1'
									)
									group by g.bel_department_manager_dept_id
								) a
				ON a.bel_department_manager_dept_id=c.bel_department_manager_dept_id
				) f
		) c
		on a.dept_id=c.bel_department_manager_dept_id
		set 
			a.team_add_base=c.all_add,
			a.team_add_deal=c.deal_pro_add,
			a.team_redeem_all_base=c.redeem_all,
			a.team_redeem_all_deal=c.redeem_all_deal,
			a.team_clear_add=c.cle_add,
			a.team_clear_add_deal=c.cle_add_deal
		where a.statics_personnel_id=#{statics_personnel_id}
		and a.is_team_handler='1'
	</update>
	
	<update id="updateTeamViceAddData_daySta" parameterType="map">
		update wms_personnel_achievement_daysta a inner join (
			select 
				f.bel_vice_general_manager_id,
				f.bel_vice_general_manager_dept_id,
				f.all_add,
				f.redeem_all,
				f.cle_add,
				f.deal_pro_add,
				redeem_all_deal,
				cle_add_deal
			from (
				SELECT
								a.bel_vice_general_manager_id,
								a.bel_vice_general_manager_dept_id,
								a.all_pro_acc as all_add,
								ifnull(c.redeem_all, 0) as redeem_all,
								a.all_pro_acc - ifnull(c.redeem_all, 0) as cle_add,
								a.deal_pro_add,
								ifnull(c.redeem_all_deal, 0) as redeem_all_deal,
								a.deal_pro_add-ifnull(c.redeem_all_deal, 0) as cle_add_deal
							FROM
								(
									SELECT
										g.bel_vice_general_manager_id,
										g.bel_vice_general_manager_dept_id,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))) as all_pro_acc,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))*h.product_deadline/12/(if(h.wms_inve_pruduct_category_id in (${specialpro}),4,1))) as deal_pro_add
									FROM
										wms_inve_transa g,
										wms_inve_transa_prod h
										left join
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												AND c.data_status != '7'
												group by b.wms_inve_transa_id
												)
												d
												on h.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										g.wms_inve_transa_id = h.wms_inve_transa_id
									and g.bel_center_manager_id is null
									AND g.data_status in ('4','5','6')
									and h.wms_inve_pruduct_category_id not in (${reject_proid})
									AND g.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>g.date_of_payment
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=g.wms_inve_customer_id
										and x.end_of_date>ifnull(g.old_date_of_payment,g.date_of_payment)
										and x.data_type='1'
									)
									group by g.bel_vice_general_manager_id,g.bel_vice_general_manager_dept_id
								) a
							LEFT JOIN (
								SELECT
									n.bel_vice_general_manager_id,
									n.bel_vice_general_manager_dept_id,
									sum(ifnull(v.redeem_amount,0)) AS redeem_all,
									sum(ifnull(v.redeem_amount,0)*x.product_deadline/12/(if(x.wms_inve_pruduct_category_id in (${specialpro}),4,1))) AS redeem_all_deal
								FROM
									wms_inve_redeem b,
									wms_inve_redeem_detail v,
									wms_inve_transa_prod x,
									wms_inve_transa n
								WHERE
									b.redeem_date >= #{sta_begin_date}
								AND #{sta_end_date}>b.redeem_date
								and b.data_status in ('6')
								and n.data_status in ('4','5','6')
								and b.data_status !='7'
								and (#{sta_begin_date}>n.date_of_payment or (n.date_of_payment>=#{sta_begin_date} and b.is_take_off_damages = '1')) 
								and x.wms_inve_pruduct_category_id not in (${reject_proid})
								AND b.wms_inve_redeem_id = v.wms_inve_redeem_id
								and n.bel_center_manager_id is null
								AND v.wms_inve_transa_id = x.wms_inve_transa_id
								and n.wms_inve_transa_id=x.wms_inve_transa_id
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=n.wms_inve_customer_id
										and x.end_of_date>ifnull(n.old_date_of_payment,n.date_of_payment)
										and x.data_type='1'
									)
								group by n.bel_vice_general_manager_id,n.bel_vice_general_manager_dept_id
							) c ON a.bel_vice_general_manager_id = c.bel_vice_general_manager_id and a.bel_vice_general_manager_dept_id=c.bel_vice_general_manager_dept_id
				UNION
				SELECT
								c.bel_vice_general_manager_id,
								c.bel_vice_general_manager_dept_id,
								ifnull(a.all_pro_acc,0) as all_add,
								ifnull(c.redeem_all, 0) as redeem_all,
								ifnull(a.all_pro_acc,0) - ifnull(c.redeem_all, 0) as cle_add,
								ifnull(a.deal_pro_add,0) as deal_pro_add,
								ifnull(c.redeem_all_deal, 0) as redeem_all_deal,
								ifnull(a.deal_pro_add,0)-ifnull(c.redeem_all_deal, 0) as cle_add_deal
								
								
							FROM
				(
								SELECT
									n.bel_vice_general_manager_id,
									n.bel_vice_general_manager_dept_id,
									sum(ifnull(v.redeem_amount,0)) AS redeem_all,
									sum(ifnull(v.redeem_amount,0)*x.product_deadline/12/(if(x.wms_inve_pruduct_category_id in (${specialpro}),4,1))) AS redeem_all_deal
								FROM
									wms_inve_redeem b,
									wms_inve_redeem_detail v,
									wms_inve_transa_prod x,
									wms_inve_transa n
								WHERE
									b.redeem_date >= #{sta_begin_date}
								AND #{sta_end_date}>b.redeem_date
								and b.data_status in ('6')
								and b.redeem_type not IN ('3','5')
								and n.data_status in ('4','5','6')
								and b.data_status !='7'
								and (#{sta_begin_date}>n.date_of_payment or (n.date_of_payment>=#{sta_begin_date} and b.is_take_off_damages = '1')) 
								and x.wms_inve_pruduct_category_id not in (${reject_proid})
								AND b.wms_inve_redeem_id = v.wms_inve_redeem_id
								and n.bel_center_manager_id is null
								AND v.wms_inve_transa_id = x.wms_inve_transa_id
								and n.wms_inve_transa_id=x.wms_inve_transa_id
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=n.wms_inve_customer_id
										and x.end_of_date>ifnull(n.old_date_of_payment,n.date_of_payment)
										and x.data_type='1'
									)
								group by n.bel_vice_general_manager_id,n.bel_vice_general_manager_dept_id
							) c 
				LEFT JOIN
				(
									SELECT
										g.bel_vice_general_manager_id,
										g.bel_vice_general_manager_dept_id,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))) as all_pro_acc,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))*h.product_deadline/12/(if(h.wms_inve_pruduct_category_id in (${specialpro}),4,1))) as deal_pro_add
									FROM
										wms_inve_transa g,
										wms_inve_transa_prod h
										left join
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												AND c.data_status != '7'
												group by b.wms_inve_transa_id
												)
												d
												on h.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										g.wms_inve_transa_id = h.wms_inve_transa_id
									AND g.data_status in ('4','5','6')
									and h.wms_inve_pruduct_category_id not in (${reject_proid})
									AND g.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>g.date_of_payment
									and g.bel_center_manager_id is null
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=g.wms_inve_customer_id
										and x.end_of_date>ifnull(g.old_date_of_payment,g.date_of_payment)
										and x.data_type='1'
									)
									group by g.bel_vice_general_manager_id,g.bel_vice_general_manager_dept_id
								) a
				ON a.bel_vice_general_manager_id = c.bel_vice_general_manager_id and a.bel_vice_general_manager_dept_id=c.bel_vice_general_manager_dept_id
				) f
		) c
		on a.personnel_id=c.bel_vice_general_manager_id and a.dept_id=c.bel_vice_general_manager_dept_id
		set 
			a.team_add_base=c.all_add,
			a.team_add_deal=c.deal_pro_add,
			a.team_redeem_all_base=c.redeem_all,
			a.team_redeem_all_deal=c.redeem_all_deal,
			a.team_clear_add=c.cle_add,
			a.team_clear_add_deal=c.cle_add_deal
		where a.statics_personnel_id=#{statics_personnel_id}
	</update>
	
	<update id="updateTeamCenterAddData_daySta" parameterType="map">
		update wms_personnel_achievement_daysta a inner join (
			select 
				f.bel_center_manager_id,
				f.bel_center_manager_dept_id,
				f.all_add,
				f.redeem_all,
				f.cle_add,
				f.deal_pro_add,
				redeem_all_deal,
				cle_add_deal
			from (
				SELECT
								a.bel_center_manager_id,
								a.bel_center_manager_dept_id,
								a.all_pro_acc as all_add,
								ifnull(c.redeem_all, 0) as redeem_all,
								a.all_pro_acc - ifnull(c.redeem_all, 0) as cle_add,
								a.deal_pro_add,
								ifnull(c.redeem_all_deal, 0) as redeem_all_deal,
								a.deal_pro_add-ifnull(c.redeem_all_deal, 0) as cle_add_deal
							FROM
								(
									SELECT
										g.bel_center_manager_id,
										g.bel_center_manager_dept_id,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))) as all_pro_acc,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))*h.product_deadline/12/(if(h.wms_inve_pruduct_category_id in (${specialpro}),4,1))) as deal_pro_add
									FROM
										wms_inve_transa g,
										wms_inve_transa_prod h
										left join
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												AND c.data_status != '7'
												group by b.wms_inve_transa_id
												)
												d
												on h.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										g.wms_inve_transa_id = h.wms_inve_transa_id
									AND g.data_status in ('4','5','6')
									and h.wms_inve_pruduct_category_id not in (${reject_proid})
									AND g.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>g.date_of_payment
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=g.wms_inve_customer_id
										and x.end_of_date>ifnull(g.old_date_of_payment,g.date_of_payment)
										and x.data_type='1'
									)
									group by g.bel_center_manager_id,g.bel_center_manager_dept_id
								) a
							LEFT JOIN (
								SELECT
									n.bel_center_manager_id,
									n.bel_center_manager_dept_id,
									sum(ifnull(v.redeem_amount,0)) AS redeem_all,
									sum(ifnull(v.redeem_amount,0)*x.product_deadline/12/(if(x.wms_inve_pruduct_category_id in (${specialpro}),4,1))) AS redeem_all_deal
								FROM
									wms_inve_redeem b,
									wms_inve_redeem_detail v,
									wms_inve_transa_prod x,
									wms_inve_transa n
								WHERE
									b.redeem_date >= #{sta_begin_date}
								AND #{sta_end_date}>b.redeem_date
								and b.data_status in ('6')
								and n.data_status in ('4','5','6')
								and b.data_status !='7'
								and (#{sta_begin_date}>n.date_of_payment or (n.date_of_payment>=#{sta_begin_date} and b.is_take_off_damages = '1')) 
								and x.wms_inve_pruduct_category_id not in (${reject_proid})
								AND b.wms_inve_redeem_id = v.wms_inve_redeem_id
								AND v.wms_inve_transa_id = x.wms_inve_transa_id
								and n.wms_inve_transa_id=x.wms_inve_transa_id
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=n.wms_inve_customer_id
										and x.end_of_date>ifnull(n.old_date_of_payment,n.date_of_payment)
										and x.data_type='1'
									)
								group by n.bel_center_manager_id,n.bel_center_manager_dept_id
							) c ON a.bel_center_manager_id = c.bel_center_manager_id and a.bel_center_manager_dept_id=c.bel_center_manager_dept_id
				UNION
				SELECT
								c.bel_center_manager_id,
								c.bel_center_manager_dept_id,
								ifnull(a.all_pro_acc,0) as all_add,
								ifnull(c.redeem_all, 0) as redeem_all,
								ifnull(a.all_pro_acc,0) - ifnull(c.redeem_all, 0) as cle_add,
								ifnull(a.deal_pro_add,0) as deal_pro_add,
								ifnull(c.redeem_all_deal, 0) as redeem_all_deal,
								ifnull(a.deal_pro_add,0)-ifnull(c.redeem_all_deal, 0) as cle_add_deal
								
								
							FROM
				(
								SELECT
									n.bel_center_manager_id,
									n.bel_center_manager_dept_id,
									sum(ifnull(v.redeem_amount,0)) AS redeem_all,
									sum(ifnull(v.redeem_amount,0)*x.product_deadline/12/(if(x.wms_inve_pruduct_category_id in (${specialpro}),4,1))) AS redeem_all_deal
								FROM
									wms_inve_redeem b,
									wms_inve_redeem_detail v,
									wms_inve_transa_prod x,
									wms_inve_transa n
								WHERE
									b.redeem_date >= #{sta_begin_date}
								AND #{sta_end_date}>b.redeem_date
								and b.data_status in ('6')
								and b.redeem_type not IN ('3','5')
								and n.data_status in ('4','5','6')
								and b.data_status !='7'
								and (#{sta_begin_date}>n.date_of_payment or (n.date_of_payment>=#{sta_begin_date} and b.is_take_off_damages = '1')) 
								and x.wms_inve_pruduct_category_id not in (${reject_proid})
								AND b.wms_inve_redeem_id = v.wms_inve_redeem_id
								AND v.wms_inve_transa_id = x.wms_inve_transa_id
								and n.wms_inve_transa_id=x.wms_inve_transa_id
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=n.wms_inve_customer_id
										and x.end_of_date>ifnull(n.old_date_of_payment,n.date_of_payment)
										and x.data_type='1'
									)
								group by n.bel_center_manager_id,n.bel_center_manager_dept_id
							) c 
				LEFT JOIN
				(
									SELECT
										g.bel_center_manager_id,
										g.bel_center_manager_dept_id,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))) as all_pro_acc,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))*h.product_deadline/12/(if(h.wms_inve_pruduct_category_id in (${specialpro}),4,1))) as deal_pro_add
									FROM
										wms_inve_transa g,
										wms_inve_transa_prod h
										left join
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												AND c.data_status != '7'
												group by b.wms_inve_transa_id
												)
												d
												on h.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										g.wms_inve_transa_id = h.wms_inve_transa_id
									AND g.data_status in ('4','5','6')
									and h.wms_inve_pruduct_category_id not in (${reject_proid})
									AND g.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>g.date_of_payment
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=g.wms_inve_customer_id
										and x.end_of_date>ifnull(g.old_date_of_payment,g.date_of_payment)
										and x.data_type='1'
									)
									group by g.bel_center_manager_id,g.bel_center_manager_dept_id
								) a
				ON a.bel_center_manager_id = c.bel_center_manager_id and a.bel_center_manager_dept_id=c.bel_center_manager_dept_id
				) f
		) c
		on a.personnel_id=c.bel_center_manager_id and a.dept_id=c.bel_center_manager_dept_id
		set 
			a.team_add_base=c.all_add,
			a.team_add_deal=c.deal_pro_add,
			a.team_redeem_all_base=c.redeem_all,
			a.team_redeem_all_deal=c.redeem_all_deal,
			a.team_clear_add=c.cle_add,
			a.team_clear_add_deal=c.cle_add_deal
		where a.statics_personnel_id=#{statics_personnel_id}
	</update>
	
	<update id="updateTeamGelStockData_daySta" parameterType="map">
		update wms_personnel_achievement_daysta a inner join (
			SELECT
							a.bel_general_manager_id,
							a.bel_general_manager_dept_id,
							sum(ifnull(w.product_account, 0)) as allpro_stock,
							sum(ifnull(w.product_account*w.product_deadline/12, 0)) as allpro_stock_deal,
							sum(if(ifnull(a.old_date_of_payment,a.date_of_payment)>=#{limit_date} and w.wms_inve_pruduct_category_id in (${new_pros}) ,w.product_account,0)) as newpro_stock,
							sum(if(ifnull(a.old_date_of_payment,a.date_of_payment)>=#{limit_date} and w.wms_inve_pruduct_category_id in (${new_pros}) ,w.product_account*w.product_deadline/12,0)) as newpro_stock_deal
						FROM
							wms_inve_transa a,
							wms_inve_transa_prod w
						WHERE
							a.data_status = '4'
							and exists (select 1 from wms_inve_transa_protocol c where c.wms_inve_transa_id=a.wms_inve_transa_id and c.end_of_date>=DATE_SUB(#{sta_end_date},INTERVAL 1 DAY) LIMIT 1) 
							and #{sta_end_date}>a.date_of_payment
							and a.wms_inve_transa_id=w.wms_inve_transa_id
							and w.wms_inve_pruduct_category_id not in (${reject_proid})
							and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=a.wms_inve_customer_id
										and x.end_of_date>ifnull(a.old_date_of_payment,a.date_of_payment)
										and x.data_type='1'
									)
							group by a.bel_general_manager_id,a.bel_general_manager_dept_id
			) c
			on a.personnel_id=c.bel_general_manager_id and a.dept_id=c.bel_general_manager_dept_id
			set a.team_stock_all=c.allpro_stock,
				a.team_stock_all_deal=c.allpro_stock_deal,
				a.team_stock_new=c.newpro_stock,
				a.team_stock_new_deal=c.newpro_stock_deal
			where a.statics_personnel_id=#{statics_personnel_id}
			and a.personnel_name_detail !='冯涛 100006(转)'
			
	</update>
	<update id="updateTeamGelAddData_daySta" parameterType="map">
		update wms_personnel_achievement_daysta a inner join (
			select 
				f.bel_general_manager_id,
				f.bel_general_manager_dept_id,
				f.all_add,
				f.redeem_all,
				f.cle_add,
				f.deal_pro_add,
				redeem_all_deal,
				cle_add_deal
			from (
				SELECT
								a.bel_general_manager_id,
								a.bel_general_manager_dept_id,
								a.all_pro_acc as all_add,
								ifnull(c.redeem_all, 0) as redeem_all,
								a.all_pro_acc - ifnull(c.redeem_all, 0) as cle_add,
								a.deal_pro_add,
								ifnull(c.redeem_all_deal, 0) as redeem_all_deal,
								a.deal_pro_add-ifnull(c.redeem_all_deal, 0) as cle_add_deal
							FROM
								(
									SELECT
										g.bel_general_manager_id,
										g.bel_general_manager_dept_id,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))) as all_pro_acc,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))*h.product_deadline/12/(if(h.wms_inve_pruduct_category_id in (${specialpro}),4,1))) as deal_pro_add
									FROM
										wms_inve_transa g,
										wms_inve_transa_prod h
										left join
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												AND c.data_status != '7'
												group by b.wms_inve_transa_id
												)
												d
												on h.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										g.wms_inve_transa_id = h.wms_inve_transa_id
									and g.bel_center_manager_id is null
									and g.bel_vice_general_manager_id is null
									and g.bel_department_manager_id is null
									AND g.data_status in ('4','5','6')
									and h.wms_inve_pruduct_category_id not in (${reject_proid})
									AND g.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>g.date_of_payment
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=g.wms_inve_customer_id
										and x.end_of_date>ifnull(g.old_date_of_payment,g.date_of_payment)
										and x.data_type='1'
									)
									group by g.bel_general_manager_id,g.bel_general_manager_dept_id
								) a
							LEFT JOIN (
								SELECT
									n.bel_general_manager_id,
									n.bel_general_manager_dept_id,
									sum(ifnull(v.redeem_amount,0)) AS redeem_all,
									sum(ifnull(v.redeem_amount,0)*x.product_deadline/12/(if(x.wms_inve_pruduct_category_id in (${specialpro}),4,1))) AS redeem_all_deal
								FROM
									wms_inve_redeem b,
									wms_inve_redeem_detail v,
									wms_inve_transa_prod x,
									wms_inve_transa n
								WHERE
									b.redeem_date >= #{sta_begin_date}
								AND #{sta_end_date}>b.redeem_date
								and b.data_status in ('6')
								and n.data_status in ('4','5','6')
								and b.data_status !='7'
								and (#{sta_begin_date}>n.date_of_payment or (n.date_of_payment>=#{sta_begin_date} and b.is_take_off_damages = '1')) 
								and x.wms_inve_pruduct_category_id not in (${reject_proid})
								AND b.wms_inve_redeem_id = v.wms_inve_redeem_id
								and n.bel_center_manager_id is null
								and n.bel_vice_general_manager_id is null
								and n.bel_department_manager_id is null
								AND v.wms_inve_transa_id = x.wms_inve_transa_id
								and n.wms_inve_transa_id=x.wms_inve_transa_id
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=n.wms_inve_customer_id
										and x.end_of_date>ifnull(n.old_date_of_payment,n.date_of_payment)
										and x.data_type='1'
									)
								group by n.bel_general_manager_id,n.bel_general_manager_dept_id
							) c ON a.bel_general_manager_id = c.bel_general_manager_id and a.bel_general_manager_dept_id=c.bel_general_manager_dept_id
				UNION
				SELECT
								c.bel_general_manager_id,
								c.bel_general_manager_dept_id,
								ifnull(a.all_pro_acc,0) as all_add,
								ifnull(c.redeem_all, 0) as redeem_all,
								ifnull(a.all_pro_acc,0) - ifnull(c.redeem_all, 0) as cle_add,
								ifnull(a.deal_pro_add,0) as deal_pro_add,
								ifnull(c.redeem_all_deal, 0) as redeem_all_deal,
								ifnull(a.deal_pro_add,0)-ifnull(c.redeem_all_deal, 0) as cle_add_deal
								
								
							FROM
				(
								SELECT
									n.bel_general_manager_id,
									n.bel_general_manager_dept_id,
									sum(ifnull(v.redeem_amount,0)) AS redeem_all,
									sum(ifnull(v.redeem_amount,0)*x.product_deadline/12/(if(x.wms_inve_pruduct_category_id in (${specialpro}),4,1))) AS redeem_all_deal
								FROM
									wms_inve_redeem b,
									wms_inve_redeem_detail v,
									wms_inve_transa_prod x,
									wms_inve_transa n
								WHERE
									b.redeem_date >= #{sta_begin_date}
								AND #{sta_end_date}>b.redeem_date
								and b.data_status in ('6')
								and b.redeem_type not IN ('3','5')
								and n.data_status in ('4','5','6')
								and b.data_status !='7'
								and (#{sta_begin_date}>n.date_of_payment or (n.date_of_payment>=#{sta_begin_date} and b.is_take_off_damages = '1')) 
								and x.wms_inve_pruduct_category_id not in (${reject_proid})
								AND b.wms_inve_redeem_id = v.wms_inve_redeem_id
								and n.bel_center_manager_id is null
								and n.bel_vice_general_manager_id is null
								and n.bel_department_manager_id is null
								AND v.wms_inve_transa_id = x.wms_inve_transa_id
								and n.wms_inve_transa_id=x.wms_inve_transa_id
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=n.wms_inve_customer_id
										and x.end_of_date>ifnull(n.old_date_of_payment,n.date_of_payment)
										and x.data_type='1'
									)
								group by n.bel_general_manager_id,n.bel_general_manager_dept_id
							) c 
				LEFT JOIN
				(
									SELECT
										g.bel_general_manager_id,
										g.bel_general_manager_dept_id,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))) as all_pro_acc,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))*h.product_deadline/12/(if(h.wms_inve_pruduct_category_id in (${specialpro}),4,1))) as deal_pro_add
									FROM
										wms_inve_transa g,
										wms_inve_transa_prod h
										left join
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												AND c.data_status != '7'
												group by b.wms_inve_transa_id
												)
												d
												on h.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										g.wms_inve_transa_id = h.wms_inve_transa_id
									AND g.data_status in ('4','5','6')
									and h.wms_inve_pruduct_category_id not in (${reject_proid})
									AND g.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>g.date_of_payment
									and g.bel_center_manager_id is null
									and g.bel_vice_general_manager_id is null
									and g.bel_department_manager_id is null
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=g.wms_inve_customer_id
										and x.end_of_date>ifnull(g.old_date_of_payment,g.date_of_payment)
										and x.data_type='1'
									)
									group by g.bel_general_manager_id,g.bel_general_manager_dept_id
								) a
				ON a.bel_general_manager_id = c.bel_general_manager_id and a.bel_general_manager_dept_id=c.bel_general_manager_dept_id
				) f
		) c
		on a.personnel_id=c.bel_general_manager_id and a.dept_id=c.bel_general_manager_dept_id
		set 
			a.team_add_base=c.all_add,
			a.team_add_deal=c.deal_pro_add,
			a.team_redeem_all_base=c.redeem_all,
			a.team_redeem_all_deal=c.redeem_all_deal,
			a.team_clear_add=c.cle_add,
			a.team_clear_add_deal=c.cle_add_deal
		where a.statics_personnel_id=#{statics_personnel_id}
		and a.personnel_name_detail !='冯涛 100006(转)'
		</update>
		<update id="updateTeamGelAddData_daySta_com" parameterType="map">
			update wms_personnel_achievement_daysta a inner join (
			select 
				f.bel_general_manager_id,
				f.bel_general_manager_dept_id,
				f.all_add,
				f.redeem_all,
				f.cle_add,
				f.deal_pro_add,
				redeem_all_deal,
				cle_add_deal
			from (
				SELECT
								a.bel_general_manager_id,
								a.bel_general_manager_dept_id,
								a.all_pro_acc as all_add,
								ifnull(c.redeem_all, 0) as redeem_all,
								a.all_pro_acc - ifnull(c.redeem_all, 0) as cle_add,
								a.deal_pro_add,
								ifnull(c.redeem_all_deal, 0) as redeem_all_deal,
								a.deal_pro_add-ifnull(c.redeem_all_deal, 0) as cle_add_deal
							FROM
								(
									SELECT
										g.bel_general_manager_id,
										g.bel_general_manager_dept_id,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))) as all_pro_acc,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))*h.product_deadline/12/(if(h.wms_inve_pruduct_category_id in (${specialpro}),4,1))) as deal_pro_add
									FROM
										wms_inve_transa g,
										wms_inve_transa_prod h
										left join
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												AND c.data_status != '7'
												group by b.wms_inve_transa_id
												)
												d
												on h.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										g.wms_inve_transa_id = h.wms_inve_transa_id
									and g.bel_center_manager_id is null
									and g.bel_vice_general_manager_id is null
									and g.bel_department_manager_id is null
									AND g.data_status in ('4','5','6')
									and h.wms_inve_pruduct_category_id not in (${reject_proid})
									AND g.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>g.date_of_payment
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=g.wms_inve_customer_id
										and x.end_of_date>ifnull(g.old_date_of_payment,g.date_of_payment)
										and x.data_type='1'
									)
									group by g.bel_general_manager_id,g.bel_general_manager_dept_id
								) a
							LEFT JOIN (
								SELECT
									n.bel_general_manager_id,
									n.bel_general_manager_dept_id,
									sum(ifnull(v.redeem_amount,0)) AS redeem_all,
									sum(ifnull(v.redeem_amount,0)*x.product_deadline/12/(if(x.wms_inve_pruduct_category_id in (${specialpro}),4,1))) AS redeem_all_deal
								FROM
									wms_inve_redeem b,
									wms_inve_redeem_detail v,
									wms_inve_transa_prod x,
									wms_inve_transa n
								WHERE
									b.redeem_date >= #{sta_begin_date}
								AND #{sta_end_date}>b.redeem_date
								and b.data_status in ('6')
								and n.data_status in ('4','5','6')
								and b.data_status !='7'
								and (#{sta_begin_date}>n.date_of_payment or (n.date_of_payment>=#{sta_begin_date} and b.is_take_off_damages = '1')) 
								and x.wms_inve_pruduct_category_id not in (${reject_proid})
								AND b.wms_inve_redeem_id = v.wms_inve_redeem_id
								and n.bel_center_manager_id is null
								and n.bel_vice_general_manager_id is null
								and n.bel_department_manager_id is null
								AND v.wms_inve_transa_id = x.wms_inve_transa_id
								and n.wms_inve_transa_id=x.wms_inve_transa_id
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=n.wms_inve_customer_id
										and x.end_of_date>ifnull(n.old_date_of_payment,n.date_of_payment)
										and x.data_type='1'
									)
								group by n.bel_general_manager_id,n.bel_general_manager_dept_id
							) c ON a.bel_general_manager_id = c.bel_general_manager_id and a.bel_general_manager_dept_id=c.bel_general_manager_dept_id
				UNION
				SELECT
								c.bel_general_manager_id,
								c.bel_general_manager_dept_id,
								ifnull(a.all_pro_acc,0) as all_add,
								ifnull(c.redeem_all, 0) as redeem_all,
								ifnull(a.all_pro_acc,0) - ifnull(c.redeem_all, 0) as cle_add,
								ifnull(a.deal_pro_add,0) as deal_pro_add,
								ifnull(c.redeem_all_deal, 0) as redeem_all_deal,
								ifnull(a.deal_pro_add,0)-ifnull(c.redeem_all_deal, 0) as cle_add_deal
								
								
							FROM
				(
								SELECT
									n.bel_general_manager_id,
									n.bel_general_manager_dept_id,
									sum(ifnull(v.redeem_amount,0)) AS redeem_all,
									sum(ifnull(v.redeem_amount,0)*x.product_deadline/12/(if(x.wms_inve_pruduct_category_id in (${specialpro}),4,1))) AS redeem_all_deal
								FROM
									wms_inve_redeem b,
									wms_inve_redeem_detail v,
									wms_inve_transa_prod x,
									wms_inve_transa n
								WHERE
									b.redeem_date >= #{sta_begin_date}
								AND #{sta_end_date}>b.redeem_date
								and b.data_status in ('6')
								and b.redeem_type not IN ('3','5')
								and n.data_status in ('4','5','6')
								and b.data_status !='7'
								and (#{sta_begin_date}>n.date_of_payment or (n.date_of_payment>=#{sta_begin_date} and b.is_take_off_damages = '1')) 
								and x.wms_inve_pruduct_category_id not in (${reject_proid})
								AND b.wms_inve_redeem_id = v.wms_inve_redeem_id
								and n.bel_center_manager_id is null
								and n.bel_vice_general_manager_id is null
								and n.bel_department_manager_id is null
								AND v.wms_inve_transa_id = x.wms_inve_transa_id
								and n.wms_inve_transa_id=x.wms_inve_transa_id
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=n.wms_inve_customer_id
										and x.end_of_date>ifnull(n.old_date_of_payment,n.date_of_payment)
										and x.data_type='1'
									)
								group by n.bel_general_manager_id,n.bel_general_manager_dept_id
							) c 
				LEFT JOIN
				(
									SELECT
										g.bel_general_manager_id,
										g.bel_general_manager_dept_id,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))) as all_pro_acc,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))*h.product_deadline/12/(if(h.wms_inve_pruduct_category_id in (${specialpro}),4,1))) as deal_pro_add
									FROM
										wms_inve_transa g,
										wms_inve_transa_prod h
										left join
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												AND c.data_status != '7'
												group by b.wms_inve_transa_id
												)
												d
												on h.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										g.wms_inve_transa_id = h.wms_inve_transa_id
									AND g.data_status in ('4','5','6')
									and h.wms_inve_pruduct_category_id not in (${reject_proid})
									AND g.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>g.date_of_payment
									and g.bel_center_manager_id is null
									and g.bel_vice_general_manager_id is null
									and g.bel_department_manager_id is null
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=g.wms_inve_customer_id
										and x.end_of_date>ifnull(g.old_date_of_payment,g.date_of_payment)
										and x.data_type='1'
									)
									group by g.bel_general_manager_id,g.bel_general_manager_dept_id
								) a
				ON a.bel_general_manager_id = c.bel_general_manager_id and a.bel_general_manager_dept_id=c.bel_general_manager_dept_id
				) f
		) c
		on a.personnel_id=c.bel_general_manager_id and a.dept_id=c.bel_general_manager_dept_id
		set 
			a.team_add_base=c.all_add,
			a.team_add_deal=c.deal_pro_add,
			a.team_redeem_all_base=c.redeem_all,
			a.team_redeem_all_deal=c.redeem_all_deal,
			a.team_clear_add=c.cle_add,
			a.team_clear_add_deal=c.cle_add_deal
		where a.statics_personnel_id=#{statics_personnel_id}
		and a.personnel_name_detail ='冯涛 100006(转)'
		</update>
		<update id="updateTeamDeptAddData_withoutRenInve_daySta" parameterType="map">
			update wms_personnel_achievement_daysta a inner join (
			select 
				f.bel_department_manager_dept_id,
				f.all_add,
				f.redeem_all,
				f.cle_add,
				f.deal_pro_add,
				redeem_all_deal,
				cle_add_deal
			from (
				SELECT
								a.bel_department_manager_dept_id,
								a.all_pro_acc as all_add,
								ifnull(c.redeem_all, 0) as redeem_all,
								a.all_pro_acc - ifnull(c.redeem_all, 0) as cle_add,
								a.deal_pro_add,
								ifnull(c.redeem_all_deal, 0) as redeem_all_deal,
								a.deal_pro_add-ifnull(c.redeem_all_deal, 0) as cle_add_deal
							FROM
								(
									SELECT
										g.bel_department_manager_dept_id,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))) as all_pro_acc,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))*h.product_deadline/12/(if(h.wms_inve_pruduct_category_id in (${specialpro}),4,1))) as deal_pro_add
									FROM
										wms_inve_transa g,
										wms_inve_transa_prod h
										left join
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												AND c.data_status != '7'
												group by b.wms_inve_transa_id
												)
												d
												on h.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										g.wms_inve_transa_id = h.wms_inve_transa_id
									AND g.data_status in ('4','5','6')
									and g.old_wms_inve_transa_id is null
									and h.wms_inve_pruduct_category_id not in (${reject_proid})
									AND g.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>g.date_of_payment
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=g.wms_inve_customer_id
										and x.end_of_date>ifnull(g.old_date_of_payment,g.date_of_payment)
										and x.data_type='1'
									)
									group by g.bel_department_manager_dept_id
								) a
							LEFT JOIN (
								SELECT
									n.bel_department_manager_dept_id,
									sum(ifnull(v.redeem_amount,0)) AS redeem_all,
									sum(ifnull(v.redeem_amount,0)*x.product_deadline/12/(if(x.wms_inve_pruduct_category_id in (${specialpro}),4,1))) AS redeem_all_deal
								FROM
									wms_inve_redeem b,
									wms_inve_redeem_detail v,
									wms_inve_transa_prod x,
									wms_inve_transa n LEFT JOIN wms_inve_comm_team_set t on n.bel_department_manager_dept_id=t.dept_id	and t.enable_flag='1'	
								WHERE
									b.redeem_date >= #{sta_begin_date}
								AND #{sta_end_date}>b.redeem_date
								and b.data_status in ('6')
								and n.data_status in ('4','5','6')
								and b.data_status !='7'
								and b.redeem_type !='2'
								and n.date_of_payment>=ifnull(t.begin_date,'1999-01-01')
								and (#{sta_begin_date}>n.date_of_payment or (n.date_of_payment>=#{sta_begin_date} and b.is_take_off_damages = '1')) 
								and x.wms_inve_pruduct_category_id not in (${reject_proid})
								AND b.wms_inve_redeem_id = v.wms_inve_redeem_id
								AND v.wms_inve_transa_id = x.wms_inve_transa_id
								and n.wms_inve_transa_id=x.wms_inve_transa_id
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=n.wms_inve_customer_id
										and x.end_of_date>ifnull(n.old_date_of_payment,n.date_of_payment)
										and x.data_type='1'
									)
								group by n.bel_department_manager_dept_id
							) c ON a.bel_department_manager_dept_id = c.bel_department_manager_dept_id 
				UNION
				SELECT
								c.bel_department_manager_dept_id,
								ifnull(a.all_pro_acc,0) as all_add,
								ifnull(c.redeem_all, 0) as redeem_all,
								ifnull(a.all_pro_acc,0) - ifnull(c.redeem_all, 0) as cle_add,
								ifnull(a.deal_pro_add,0) as deal_pro_add,
								ifnull(c.redeem_all_deal, 0) as redeem_all_deal,
								ifnull(a.deal_pro_add,0)-ifnull(c.redeem_all_deal, 0) as cle_add_deal
								
								
							FROM
				(
								SELECT
									n.bel_department_manager_dept_id,
									sum(ifnull(v.redeem_amount,0)) AS redeem_all,
									sum(ifnull(v.redeem_amount,0)*x.product_deadline/12/(if(x.wms_inve_pruduct_category_id in (${specialpro}),4,1))) AS redeem_all_deal
								FROM
									wms_inve_redeem b,
									wms_inve_redeem_detail v,
									wms_inve_transa_prod x,
									wms_inve_transa n  LEFT JOIN wms_inve_comm_team_set t on n.bel_department_manager_dept_id=t.dept_id	and t.enable_flag='1'
								WHERE
									b.redeem_date >= #{sta_begin_date}
								AND #{sta_end_date}>b.redeem_date
								and b.data_status in ('6')
								and b.redeem_type not IN ('3','5')
								and n.data_status in ('4','5','6')
								and b.data_status !='7'
								and b.redeem_type !='2'
								and n.date_of_payment>=ifnull(t.begin_date,'1999-01-01')
								and (#{sta_begin_date}>n.date_of_payment or (n.date_of_payment>=#{sta_begin_date} and b.is_take_off_damages = '1')) 
								and x.wms_inve_pruduct_category_id not in (${reject_proid})
								AND b.wms_inve_redeem_id = v.wms_inve_redeem_id
								AND v.wms_inve_transa_id = x.wms_inve_transa_id
								and n.wms_inve_transa_id=x.wms_inve_transa_id
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=n.wms_inve_customer_id
										and x.end_of_date>ifnull(n.old_date_of_payment,n.date_of_payment)
										and x.data_type='1'
									)
								group by n.bel_department_manager_dept_id
							) c 
				LEFT JOIN
				(
									SELECT
										g.bel_department_manager_dept_id,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))) as all_pro_acc,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))*h.product_deadline/12/(if(h.wms_inve_pruduct_category_id in (${specialpro}),4,1))) as deal_pro_add
									FROM
										wms_inve_transa g,
										wms_inve_transa_prod h
										left join
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												AND c.data_status != '7'
												group by b.wms_inve_transa_id
												)
												d
												on h.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										g.wms_inve_transa_id = h.wms_inve_transa_id
									AND g.data_status in ('4','5','6')
									and h.wms_inve_pruduct_category_id not in (${reject_proid})
									AND g.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>g.date_of_payment
									and g.old_wms_inve_transa_id is null
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=g.wms_inve_customer_id
										and x.end_of_date>ifnull(g.old_date_of_payment,g.date_of_payment)
										and x.data_type='1'
									)
									group by g.bel_department_manager_dept_id
								) a
				ON a.bel_department_manager_dept_id=c.bel_department_manager_dept_id
				) f
		) c
		on a.dept_id=c.bel_department_manager_dept_id
		set 
			a.team_exc_add_base=c.all_add,
			a.team_exc_add_deal=c.deal_pro_add,
			a.team_exc_redeem_all_base=c.redeem_all,
			a.team_exc_redeem_all_deal=c.redeem_all_deal
		where a.statics_personnel_id=#{statics_personnel_id}
		and a.is_team_handler='1'
		</update>
		<update id="updateTeamViceAddData_withoutRenInve_daySta" parameterType="map">
			update wms_personnel_achievement_daysta a inner join (
			select 
				f.bel_vice_general_manager_id,
				f.bel_vice_general_manager_dept_id,
				f.all_add,
				f.redeem_all,
				f.cle_add,
				f.deal_pro_add,
				redeem_all_deal,
				cle_add_deal
			from (
				SELECT
								a.bel_vice_general_manager_id,
								a.bel_vice_general_manager_dept_id,
								a.all_pro_acc as all_add,
								ifnull(c.redeem_all, 0) as redeem_all,
								a.all_pro_acc - ifnull(c.redeem_all, 0) as cle_add,
								a.deal_pro_add,
								ifnull(c.redeem_all_deal, 0) as redeem_all_deal,
								a.deal_pro_add-ifnull(c.redeem_all_deal, 0) as cle_add_deal
							FROM
								(
									SELECT
										g.bel_vice_general_manager_id,
										g.bel_vice_general_manager_dept_id,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))) as all_pro_acc,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))*h.product_deadline/12/(if(h.wms_inve_pruduct_category_id in (${specialpro}),4,1))) as deal_pro_add
									FROM
										wms_inve_transa g,
										wms_inve_transa_prod h
										left join
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												AND c.data_status != '7'
												group by b.wms_inve_transa_id
												)
												d
												on h.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										g.wms_inve_transa_id = h.wms_inve_transa_id
									and g.bel_center_manager_id is null
									AND g.data_status in ('4','5','6')
									and h.wms_inve_pruduct_category_id not in (${reject_proid})
									AND g.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>g.date_of_payment
									and g.old_wms_inve_transa_id is null
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=g.wms_inve_customer_id
										and x.end_of_date>ifnull(g.old_date_of_payment,g.date_of_payment)
										and x.data_type='1'
									)
									group by g.bel_vice_general_manager_id,g.bel_vice_general_manager_dept_id
								) a
							LEFT JOIN (
								SELECT
									n.bel_vice_general_manager_id,
									n.bel_vice_general_manager_dept_id,
									sum(ifnull(v.redeem_amount,0)) AS redeem_all,
									sum(ifnull(v.redeem_amount,0)*x.product_deadline/12/(if(x.wms_inve_pruduct_category_id in (${specialpro}),4,1))) AS redeem_all_deal
								FROM
									wms_inve_redeem b,
									wms_inve_redeem_detail v,
									wms_inve_transa_prod x,
									wms_inve_transa n
								WHERE
									b.redeem_date >= #{sta_begin_date}
								AND #{sta_end_date}>b.redeem_date
								and b.data_status in ('6')
								and n.data_status in ('4','5','6')
								and b.data_status !='7'
								and b.redeem_type !='2'
								and (#{sta_begin_date}>n.date_of_payment or (n.date_of_payment>=#{sta_begin_date} and b.is_take_off_damages = '1')) 
								and x.wms_inve_pruduct_category_id not in (${reject_proid})
								AND b.wms_inve_redeem_id = v.wms_inve_redeem_id
								and n.bel_center_manager_id is null
								AND v.wms_inve_transa_id = x.wms_inve_transa_id
								and n.wms_inve_transa_id=x.wms_inve_transa_id
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=n.wms_inve_customer_id
										and x.end_of_date>ifnull(n.old_date_of_payment,n.date_of_payment)
										and x.data_type='1'
									)
								group by n.bel_vice_general_manager_id,n.bel_vice_general_manager_dept_id
							) c ON a.bel_vice_general_manager_id = c.bel_vice_general_manager_id and a.bel_vice_general_manager_dept_id=c.bel_vice_general_manager_dept_id
				UNION
				SELECT
								c.bel_vice_general_manager_id,
								c.bel_vice_general_manager_dept_id,
								ifnull(a.all_pro_acc,0) as all_add,
								ifnull(c.redeem_all, 0) as redeem_all,
								ifnull(a.all_pro_acc,0) - ifnull(c.redeem_all, 0) as cle_add,
								ifnull(a.deal_pro_add,0) as deal_pro_add,
								ifnull(c.redeem_all_deal, 0) as redeem_all_deal,
								ifnull(a.deal_pro_add,0)-ifnull(c.redeem_all_deal, 0) as cle_add_deal
								
								
							FROM
				(
								SELECT
									n.bel_vice_general_manager_id,
									n.bel_vice_general_manager_dept_id,
									sum(ifnull(v.redeem_amount,0)) AS redeem_all,
									sum(ifnull(v.redeem_amount,0)*x.product_deadline/12/(if(x.wms_inve_pruduct_category_id in (${specialpro}),4,1))) AS redeem_all_deal
								FROM
									wms_inve_redeem b,
									wms_inve_redeem_detail v,
									wms_inve_transa_prod x,
									wms_inve_transa n
								WHERE
									b.redeem_date >= #{sta_begin_date}
								AND #{sta_end_date}>b.redeem_date
								and b.data_status in ('6')
								and b.redeem_type not IN ('3','5')
								and n.data_status in ('4','5','6')
								and b.data_status !='7'
								and b.redeem_type !='2'
								and (#{sta_begin_date}>n.date_of_payment or (n.date_of_payment>=#{sta_begin_date} and b.is_take_off_damages = '1')) 
								and x.wms_inve_pruduct_category_id not in (${reject_proid})
								AND b.wms_inve_redeem_id = v.wms_inve_redeem_id
								and n.bel_center_manager_id is null
								AND v.wms_inve_transa_id = x.wms_inve_transa_id
								and n.wms_inve_transa_id=x.wms_inve_transa_id
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=n.wms_inve_customer_id
										and x.end_of_date>ifnull(n.old_date_of_payment,n.date_of_payment)
										and x.data_type='1'
									)
								group by n.bel_vice_general_manager_id,n.bel_vice_general_manager_dept_id
							) c 
				LEFT JOIN
				(
									SELECT
										g.bel_vice_general_manager_id,
										g.bel_vice_general_manager_dept_id,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))) as all_pro_acc,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))*h.product_deadline/12/(if(h.wms_inve_pruduct_category_id in (${specialpro}),4,1))) as deal_pro_add
									FROM
										wms_inve_transa g,
										wms_inve_transa_prod h
										left join
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												AND c.data_status != '7'
												group by b.wms_inve_transa_id
												)
												d
												on h.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										g.wms_inve_transa_id = h.wms_inve_transa_id
									AND g.data_status in ('4','5','6')
									and h.wms_inve_pruduct_category_id not in (${reject_proid})
									AND g.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>g.date_of_payment
									and g.old_wms_inve_transa_id is null
									and g.bel_center_manager_id is null
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=g.wms_inve_customer_id
										and x.end_of_date>ifnull(g.old_date_of_payment,g.date_of_payment)
										and x.data_type='1'
									)
									group by g.bel_vice_general_manager_id,g.bel_vice_general_manager_dept_id
								) a
				ON a.bel_vice_general_manager_id = c.bel_vice_general_manager_id and a.bel_vice_general_manager_dept_id=c.bel_vice_general_manager_dept_id
				) f
		) c
		on a.personnel_id=c.bel_vice_general_manager_id and a.dept_id=c.bel_vice_general_manager_dept_id
		set 
			a.team_exc_add_base=c.all_add,
			a.team_exc_add_deal=c.deal_pro_add,
			a.team_exc_redeem_all_base=c.redeem_all,
			a.team_exc_redeem_all_deal=c.redeem_all_deal
		where a.statics_personnel_id=#{statics_personnel_id}
		</update>
		<update id="updateTeamCenterAddData_withoutRenInve_daySta" parameterType="map">
			update wms_personnel_achievement_daysta a inner join (
			select 
				f.bel_center_manager_id,
				f.bel_center_manager_dept_id,
				f.all_add,
				f.redeem_all,
				f.cle_add,
				f.deal_pro_add,
				redeem_all_deal,
				cle_add_deal
			from (
				SELECT
								a.bel_center_manager_id,
								a.bel_center_manager_dept_id,
								a.all_pro_acc as all_add,
								ifnull(c.redeem_all, 0) as redeem_all,
								a.all_pro_acc - ifnull(c.redeem_all, 0) as cle_add,
								a.deal_pro_add,
								ifnull(c.redeem_all_deal, 0) as redeem_all_deal,
								a.deal_pro_add-ifnull(c.redeem_all_deal, 0) as cle_add_deal
							FROM
								(
									SELECT
										g.bel_center_manager_id,
										g.bel_center_manager_dept_id,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))) as all_pro_acc,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))*h.product_deadline/12/(if(h.wms_inve_pruduct_category_id in (${specialpro}),4,1))) as deal_pro_add
									FROM
										wms_inve_transa g,
										wms_inve_transa_prod h
										left join
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												AND c.data_status != '7'
												group by b.wms_inve_transa_id
												)
												d
												on h.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										g.wms_inve_transa_id = h.wms_inve_transa_id
									AND g.data_status in ('4','5','6')
									and h.wms_inve_pruduct_category_id not in (${reject_proid})
									AND g.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>g.date_of_payment
									and g.old_wms_inve_transa_id is null
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=g.wms_inve_customer_id
										and x.end_of_date>ifnull(g.old_date_of_payment,g.date_of_payment)
										and x.data_type='1'
									)
									group by g.bel_center_manager_id,g.bel_center_manager_dept_id
								) a
							LEFT JOIN (
								SELECT
									n.bel_center_manager_id,
									n.bel_center_manager_dept_id,
									sum(ifnull(v.redeem_amount,0)) AS redeem_all,
									sum(ifnull(v.redeem_amount,0)*x.product_deadline/12/(if(x.wms_inve_pruduct_category_id in (${specialpro}),4,1))) AS redeem_all_deal
								FROM
									wms_inve_redeem b,
									wms_inve_redeem_detail v,
									wms_inve_transa_prod x,
									wms_inve_transa n
								WHERE
									b.redeem_date >= #{sta_begin_date}
								AND #{sta_end_date}>b.redeem_date
								and b.data_status in ('6')
								and n.data_status in ('4','5','6')
								and b.data_status !='7'
								and b.redeem_type !='2'
								and (#{sta_begin_date}>n.date_of_payment or (n.date_of_payment>=#{sta_begin_date} and b.is_take_off_damages = '1')) 
								and x.wms_inve_pruduct_category_id not in (${reject_proid})
								AND b.wms_inve_redeem_id = v.wms_inve_redeem_id
								AND v.wms_inve_transa_id = x.wms_inve_transa_id
								and n.wms_inve_transa_id=x.wms_inve_transa_id
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=n.wms_inve_customer_id
										and x.end_of_date>ifnull(n.old_date_of_payment,n.date_of_payment)
										and x.data_type='1'
									)
								group by n.bel_center_manager_id,n.bel_center_manager_dept_id
							) c ON a.bel_center_manager_id = c.bel_center_manager_id and a.bel_center_manager_dept_id=c.bel_center_manager_dept_id
				UNION
				SELECT
								c.bel_center_manager_id,
								c.bel_center_manager_dept_id,
								ifnull(a.all_pro_acc,0) as all_add,
								ifnull(c.redeem_all, 0) as redeem_all,
								ifnull(a.all_pro_acc,0) - ifnull(c.redeem_all, 0) as cle_add,
								ifnull(a.deal_pro_add,0) as deal_pro_add,
								ifnull(c.redeem_all_deal, 0) as redeem_all_deal,
								ifnull(a.deal_pro_add,0)-ifnull(c.redeem_all_deal, 0) as cle_add_deal
								
								
							FROM
				(
								SELECT
									n.bel_center_manager_id,
									n.bel_center_manager_dept_id,
									sum(ifnull(v.redeem_amount,0)) AS redeem_all,
									sum(ifnull(v.redeem_amount,0)*x.product_deadline/12/(if(x.wms_inve_pruduct_category_id in (${specialpro}),4,1))) AS redeem_all_deal
								FROM
									wms_inve_redeem b,
									wms_inve_redeem_detail v,
									wms_inve_transa_prod x,
									wms_inve_transa n
								WHERE
									b.redeem_date >= #{sta_begin_date}
								AND #{sta_end_date}>b.redeem_date
								and b.data_status in ('6')
								and b.redeem_type not IN ('3','5')
								and n.data_status in ('4','5','6')
								and b.data_status !='7'
								and b.redeem_type !='2'
								and (#{sta_begin_date}>n.date_of_payment or (n.date_of_payment>=#{sta_begin_date} and b.is_take_off_damages = '1')) 
								and x.wms_inve_pruduct_category_id not in (${reject_proid})
								AND b.wms_inve_redeem_id = v.wms_inve_redeem_id
								AND v.wms_inve_transa_id = x.wms_inve_transa_id
								and n.wms_inve_transa_id=x.wms_inve_transa_id
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=n.wms_inve_customer_id
										and x.end_of_date>ifnull(n.old_date_of_payment,n.date_of_payment)
										and x.data_type='1'
									)
								group by n.bel_center_manager_id,n.bel_center_manager_dept_id
							) c 
				LEFT JOIN
				(
									SELECT
										g.bel_center_manager_id,
										g.bel_center_manager_dept_id,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))) as all_pro_acc,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))*h.product_deadline/12/(if(h.wms_inve_pruduct_category_id in (${specialpro}),4,1))) as deal_pro_add
									FROM
										wms_inve_transa g,
										wms_inve_transa_prod h
										left join
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												AND c.data_status != '7'
												group by b.wms_inve_transa_id
												)
												d
												on h.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										g.wms_inve_transa_id = h.wms_inve_transa_id
									AND g.data_status in ('4','5','6')
									and h.wms_inve_pruduct_category_id not in (${reject_proid})
									AND g.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>g.date_of_payment
									and g.old_wms_inve_transa_id is null
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=g.wms_inve_customer_id
										and x.end_of_date>ifnull(g.old_date_of_payment,g.date_of_payment)
										and x.data_type='1'
									)
									group by g.bel_center_manager_id,g.bel_center_manager_dept_id
								) a
				ON a.bel_center_manager_id = c.bel_center_manager_id and a.bel_center_manager_dept_id=c.bel_center_manager_dept_id
				) f
		) c
		on a.personnel_id=c.bel_center_manager_id and a.dept_id=c.bel_center_manager_dept_id
		set 
			a.team_exc_add_base=c.all_add,
			a.team_exc_add_deal=c.deal_pro_add,
			a.team_exc_redeem_all_base=c.redeem_all,
			a.team_exc_redeem_all_deal=c.redeem_all_deal
		where a.statics_personnel_id=#{statics_personnel_id}
		</update>
		<update id="updateTeamGelAddData_withoutRenInve_daySta" parameterType="map">
			update wms_personnel_achievement_daysta a inner join (
			select 
				f.bel_general_manager_id,
				f.bel_general_manager_dept_id,
				f.all_add,
				f.redeem_all,
				f.cle_add,
				f.deal_pro_add,
				redeem_all_deal,
				cle_add_deal
			from (
				SELECT
								a.bel_general_manager_id,
								a.bel_general_manager_dept_id,
								a.all_pro_acc as all_add,
								ifnull(c.redeem_all, 0) as redeem_all,
								a.all_pro_acc - ifnull(c.redeem_all, 0) as cle_add,
								a.deal_pro_add,
								ifnull(c.redeem_all_deal, 0) as redeem_all_deal,
								a.deal_pro_add-ifnull(c.redeem_all_deal, 0) as cle_add_deal
							FROM
								(
									SELECT
										g.bel_general_manager_id,
										g.bel_general_manager_dept_id,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))) as all_pro_acc,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))*h.product_deadline/12/(if(h.wms_inve_pruduct_category_id in (${specialpro}),4,1))) as deal_pro_add
									FROM
										wms_inve_transa g,
										wms_inve_transa_prod h
										left join
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												AND c.data_status != '7'
												group by b.wms_inve_transa_id
												)
												d
												on h.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										g.wms_inve_transa_id = h.wms_inve_transa_id
									and g.bel_center_manager_id is null
									and g.bel_vice_general_manager_id is null
									and g.bel_department_manager_id is null
									AND g.data_status in ('4','5','6')
									and h.wms_inve_pruduct_category_id not in (${reject_proid})
									AND g.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>g.date_of_payment
									and g.old_wms_inve_transa_id is null
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=g.wms_inve_customer_id
										and x.end_of_date>ifnull(g.old_date_of_payment,g.date_of_payment)
										and x.data_type='1'
									)
									group by g.bel_general_manager_id,g.bel_general_manager_dept_id
								) a
							LEFT JOIN (
								SELECT
									n.bel_general_manager_id,
									n.bel_general_manager_dept_id,
									sum(ifnull(v.redeem_amount,0)) AS redeem_all,
									sum(ifnull(v.redeem_amount,0)*x.product_deadline/12/(if(x.wms_inve_pruduct_category_id in (${specialpro}),4,1))) AS redeem_all_deal
								FROM
									wms_inve_redeem b,
									wms_inve_redeem_detail v,
									wms_inve_transa_prod x,
									wms_inve_transa n
								WHERE
									b.redeem_date >= #{sta_begin_date}
								AND #{sta_end_date}>b.redeem_date
								and b.data_status in ('6')
								and n.data_status in ('4','5','6')
								and b.data_status !='7'
								and b.redeem_type !='2'
								and (#{sta_begin_date}>n.date_of_payment or (n.date_of_payment>=#{sta_begin_date} and b.is_take_off_damages = '1')) 
								and x.wms_inve_pruduct_category_id not in (${reject_proid})
								AND b.wms_inve_redeem_id = v.wms_inve_redeem_id
								and n.bel_center_manager_id is null
								and n.bel_vice_general_manager_id is null
								and n.bel_department_manager_id is null
								AND v.wms_inve_transa_id = x.wms_inve_transa_id
								and n.wms_inve_transa_id=x.wms_inve_transa_id
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=n.wms_inve_customer_id
										and x.end_of_date>ifnull(n.old_date_of_payment,n.date_of_payment)
										and x.data_type='1'
									)
								group by n.bel_general_manager_id,n.bel_general_manager_dept_id
							) c ON a.bel_general_manager_id = c.bel_general_manager_id and a.bel_general_manager_dept_id=c.bel_general_manager_dept_id
				UNION
				SELECT
								c.bel_general_manager_id,
								c.bel_general_manager_dept_id,
								ifnull(a.all_pro_acc,0) as all_add,
								ifnull(c.redeem_all, 0) as redeem_all,
								ifnull(a.all_pro_acc,0) - ifnull(c.redeem_all, 0) as cle_add,
								ifnull(a.deal_pro_add,0) as deal_pro_add,
								ifnull(c.redeem_all_deal, 0) as redeem_all_deal,
								ifnull(a.deal_pro_add,0)-ifnull(c.redeem_all_deal, 0) as cle_add_deal
								
								
							FROM
				(
								SELECT
									n.bel_general_manager_id,
									n.bel_general_manager_dept_id,
									sum(ifnull(v.redeem_amount,0)) AS redeem_all,
									sum(ifnull(v.redeem_amount,0)*x.product_deadline/12/(if(x.wms_inve_pruduct_category_id in (${specialpro}),4,1))) AS redeem_all_deal
								FROM
									wms_inve_redeem b,
									wms_inve_redeem_detail v,
									wms_inve_transa_prod x,
									wms_inve_transa n
								WHERE
									b.redeem_date >= #{sta_begin_date}
								AND #{sta_end_date}>b.redeem_date
								and b.data_status in ('6')
								and b.redeem_type not IN ('3','5')
								and n.data_status in ('4','5','6')
								and b.data_status !='7'
								and b.redeem_type !='2'
								and (#{sta_begin_date}>n.date_of_payment or (n.date_of_payment>=#{sta_begin_date} and b.is_take_off_damages = '1')) 
								and x.wms_inve_pruduct_category_id not in (${reject_proid})
								AND b.wms_inve_redeem_id = v.wms_inve_redeem_id
								and n.bel_center_manager_id is null
								and n.bel_vice_general_manager_id is null
								and n.bel_department_manager_id is null
								AND v.wms_inve_transa_id = x.wms_inve_transa_id
								and n.wms_inve_transa_id=x.wms_inve_transa_id
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=n.wms_inve_customer_id
										and x.end_of_date>ifnull(n.old_date_of_payment,n.date_of_payment)
										and x.data_type='1'
									)
								group by n.bel_general_manager_id,n.bel_general_manager_dept_id
							) c 
				LEFT JOIN
				(
									SELECT
										g.bel_general_manager_id,
										g.bel_general_manager_dept_id,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))) as all_pro_acc,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))*h.product_deadline/12/(if(h.wms_inve_pruduct_category_id in (${specialpro}),4,1))) as deal_pro_add
									FROM
										wms_inve_transa g,
										wms_inve_transa_prod h
										left join
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												AND c.data_status != '7'
												group by b.wms_inve_transa_id
												)
												d
												on h.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										g.wms_inve_transa_id = h.wms_inve_transa_id
									AND g.data_status in ('4','5','6')
									and h.wms_inve_pruduct_category_id not in (${reject_proid})
									AND g.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>g.date_of_payment
									and g.old_wms_inve_transa_id is null
									and g.bel_center_manager_id is null
									and g.bel_vice_general_manager_id is null
									and g.bel_department_manager_id is null
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=g.wms_inve_customer_id
										and x.end_of_date>ifnull(g.old_date_of_payment,g.date_of_payment)
										and x.data_type='1'
									)
									group by g.bel_general_manager_id,g.bel_general_manager_dept_id
								) a
				ON a.bel_general_manager_id = c.bel_general_manager_id and a.bel_general_manager_dept_id=c.bel_general_manager_dept_id
				) f
		) c
		on a.personnel_id=c.bel_general_manager_id and a.dept_id=c.bel_general_manager_dept_id
		set 
			a.team_exc_add_base=c.all_add,
			a.team_exc_add_deal=c.deal_pro_add,
			a.team_exc_redeem_all_base=c.redeem_all,
			a.team_exc_redeem_all_deal=c.redeem_all_deal
		where a.statics_personnel_id=#{statics_personnel_id}
		and a.personnel_name_detail !='冯涛 100006(转)'
		</update>
		<update id="updateTeamGelAddData_com_withoutRenInve_daySta" parameterType="map">
			update wms_personnel_achievement_daysta a inner join (
			select 
				f.bel_general_manager_id,
				f.bel_general_manager_dept_id,
				f.all_add,
				f.redeem_all,
				f.cle_add,
				f.deal_pro_add,
				redeem_all_deal,
				cle_add_deal
			from (
				SELECT
								a.bel_general_manager_id,
								a.bel_general_manager_dept_id,
								a.all_pro_acc as all_add,
								ifnull(c.redeem_all, 0) as redeem_all,
								a.all_pro_acc - ifnull(c.redeem_all, 0) as cle_add,
								a.deal_pro_add,
								ifnull(c.redeem_all_deal, 0) as redeem_all_deal,
								a.deal_pro_add-ifnull(c.redeem_all_deal, 0) as cle_add_deal
							FROM
								(
									SELECT
										g.bel_general_manager_id,
										g.bel_general_manager_dept_id,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))) as all_pro_acc,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))*h.product_deadline/12/(if(h.wms_inve_pruduct_category_id in (${specialpro}),4,1))) as deal_pro_add
									FROM
										wms_inve_transa g,
										wms_inve_transa_prod h
										left join
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												AND c.data_status != '7'
												group by b.wms_inve_transa_id
												)
												d
												on h.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										g.wms_inve_transa_id = h.wms_inve_transa_id
									and g.bel_center_manager_id is null
									and g.bel_vice_general_manager_id is null
									and g.bel_department_manager_id is null
									AND g.data_status in ('4','5','6')
									and h.wms_inve_pruduct_category_id not in (${reject_proid})
									AND g.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>g.date_of_payment
									and g.old_wms_inve_transa_id is null
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=g.wms_inve_customer_id
										and x.end_of_date>ifnull(g.old_date_of_payment,g.date_of_payment)
										and x.data_type='1'
									)
									group by g.bel_general_manager_id,g.bel_general_manager_dept_id
								) a
							LEFT JOIN (
								SELECT
									n.bel_general_manager_id,
									n.bel_general_manager_dept_id,
									sum(ifnull(v.redeem_amount,0)) AS redeem_all,
									sum(ifnull(v.redeem_amount,0)*x.product_deadline/12/(if(x.wms_inve_pruduct_category_id in (${specialpro}),4,1))) AS redeem_all_deal
								FROM
									wms_inve_redeem b,
									wms_inve_redeem_detail v,
									wms_inve_transa_prod x,
									wms_inve_transa n
								WHERE
									b.redeem_date >= #{sta_begin_date}
								AND #{sta_end_date}>b.redeem_date
								and b.data_status in ('6')
								and n.data_status in ('4','5','6')
								and b.data_status !='7'
								and b.redeem_type !='2'
								and (#{sta_begin_date}>n.date_of_payment or (n.date_of_payment>=#{sta_begin_date} and b.is_take_off_damages = '1')) 
								and x.wms_inve_pruduct_category_id not in (${reject_proid})
								AND b.wms_inve_redeem_id = v.wms_inve_redeem_id
								and n.bel_center_manager_id is null
								and n.bel_vice_general_manager_id is null
								and n.bel_department_manager_id is null
								AND v.wms_inve_transa_id = x.wms_inve_transa_id
								and n.wms_inve_transa_id=x.wms_inve_transa_id
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=n.wms_inve_customer_id
										and x.end_of_date>ifnull(n.old_date_of_payment,n.date_of_payment)
										and x.data_type='1'
									)
								group by n.bel_general_manager_id,n.bel_general_manager_dept_id
							) c ON a.bel_general_manager_id = c.bel_general_manager_id and a.bel_general_manager_dept_id=c.bel_general_manager_dept_id
				UNION
				SELECT
								c.bel_general_manager_id,
								c.bel_general_manager_dept_id,
								ifnull(a.all_pro_acc,0) as all_add,
								ifnull(c.redeem_all, 0) as redeem_all,
								ifnull(a.all_pro_acc,0) - ifnull(c.redeem_all, 0) as cle_add,
								ifnull(a.deal_pro_add,0) as deal_pro_add,
								ifnull(c.redeem_all_deal, 0) as redeem_all_deal,
								ifnull(a.deal_pro_add,0)-ifnull(c.redeem_all_deal, 0) as cle_add_deal
								
								
							FROM
				(
								SELECT
									n.bel_general_manager_id,
									n.bel_general_manager_dept_id,
									sum(ifnull(v.redeem_amount,0)) AS redeem_all,
									sum(ifnull(v.redeem_amount,0)*x.product_deadline/12/(if(x.wms_inve_pruduct_category_id in (${specialpro}),4,1))) AS redeem_all_deal
								FROM
									wms_inve_redeem b,
									wms_inve_redeem_detail v,
									wms_inve_transa_prod x,
									wms_inve_transa n
								WHERE
									b.redeem_date >= #{sta_begin_date}
								AND #{sta_end_date}>b.redeem_date
								and b.data_status in ('6')
								and b.redeem_type not IN ('3','5')
								and n.data_status in ('4','5','6')
								and b.data_status !='7'
								and b.redeem_type !='2'
								and (#{sta_begin_date}>n.date_of_payment or (n.date_of_payment>=#{sta_begin_date} and b.is_take_off_damages = '1')) 
								and x.wms_inve_pruduct_category_id not in (${reject_proid})
								AND b.wms_inve_redeem_id = v.wms_inve_redeem_id
								and n.bel_center_manager_id is null
								and n.bel_vice_general_manager_id is null
								and n.bel_department_manager_id is null
								AND v.wms_inve_transa_id = x.wms_inve_transa_id
								and n.wms_inve_transa_id=x.wms_inve_transa_id
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=n.wms_inve_customer_id
										and x.end_of_date>ifnull(n.old_date_of_payment,n.date_of_payment)
										and x.data_type='1'
									)
								group by n.bel_general_manager_id,n.bel_general_manager_dept_id
							) c 
				LEFT JOIN
				(
									SELECT
										g.bel_general_manager_id,
										g.bel_general_manager_dept_id,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))) as all_pro_acc,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))*h.product_deadline/12/(if(h.wms_inve_pruduct_category_id in (${specialpro}),4,1))) as deal_pro_add
									FROM
										wms_inve_transa g,
										wms_inve_transa_prod h
										left join
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												AND c.data_status != '7'
												group by b.wms_inve_transa_id
												)
												d
												on h.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										g.wms_inve_transa_id = h.wms_inve_transa_id
									AND g.data_status in ('4','5','6')
									and h.wms_inve_pruduct_category_id not in (${reject_proid})
									AND g.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>g.date_of_payment
									and g.old_wms_inve_transa_id is null
									and g.bel_center_manager_id is null
									and g.bel_vice_general_manager_id is null
									and g.bel_department_manager_id is null
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=g.wms_inve_customer_id
										and x.end_of_date>ifnull(g.old_date_of_payment,g.date_of_payment)
										and x.data_type='1'
									)
									group by g.bel_general_manager_id,g.bel_general_manager_dept_id
								) a
				ON a.bel_general_manager_id = c.bel_general_manager_id and a.bel_general_manager_dept_id=c.bel_general_manager_dept_id
				) f
		) c
		on a.personnel_id=c.bel_general_manager_id and a.dept_id=c.bel_general_manager_dept_id
		set 
			a.team_exc_add_base=c.all_add,
			a.team_exc_add_deal=c.deal_pro_add,
			a.team_exc_redeem_all_base=c.redeem_all,
			a.team_exc_redeem_all_deal=c.redeem_all_deal
		where a.statics_personnel_id=#{statics_personnel_id}
		and a.personnel_name_detail ='冯涛 100006(转)'
		</update>
		<update id="updateTeamDeptAddData_withoutRenInve_op_daySta" parameterType="map">
			update wms_personnel_achievement_daysta a inner join (
			select 
				f.bel_department_manager_id,
				f.bel_department_manager_dept_id,
				f.all_add,
				f.redeem_all,
				f.cle_add,
				f.deal_pro_add,
				redeem_all_deal,
				cle_add_deal
			from (
				SELECT
								a.bel_department_manager_id,
								a.bel_department_manager_dept_id,
								a.all_pro_acc as all_add,
								ifnull(c.redeem_all, 0) as redeem_all,
								a.all_pro_acc - ifnull(c.redeem_all, 0) as cle_add,
								a.deal_pro_add,
								ifnull(c.redeem_all_deal, 0) as redeem_all_deal,
								a.deal_pro_add-ifnull(c.redeem_all_deal, 0) as cle_add_deal
							FROM
								(
									SELECT
										g.bel_department_manager_id,
										g.bel_department_manager_dept_id,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))) as all_pro_acc,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))*h.product_deadline/12/(if(h.wms_inve_pruduct_category_id in (${specialpro}),4,1))) as deal_pro_add
									FROM
										wms_inve_transa g,
										wms_inve_transa_prod h
										left join
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												group by b.wms_inve_transa_id
												)
												d
												on h.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										g.wms_inve_transa_id = h.wms_inve_transa_id
									AND g.data_status in ('4','5','6')
									and g.old_wms_inve_transa_id is null
									and h.wms_inve_pruduct_category_id not in (${reject_proid})
									AND g.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>g.date_of_payment
									and exists (select 1 from pm_personnel e where g.bel_salesman_id_id=e.personnel_id and e.personnel_state!='7')
									
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=g.wms_inve_customer_id
										and x.end_of_date>ifnull(g.old_date_of_payment,g.date_of_payment)
										and x.data_type='1'
									)
									group by g.bel_department_manager_id,g.bel_department_manager_dept_id
								) a
							LEFT JOIN (
								SELECT
									n.bel_department_manager_id,
									n.bel_department_manager_dept_id,
									sum(ifnull(v.redeem_amount,0)) AS redeem_all,
									sum(ifnull(v.redeem_amount,0)*x.product_deadline/12/(if(x.wms_inve_pruduct_category_id in (${specialpro}),4,1))) AS redeem_all_deal
								FROM
									wms_inve_redeem b,
									wms_inve_redeem_detail v,
									wms_inve_transa_prod x,
									wms_inve_transa n
								WHERE
									b.redeem_date >= #{sta_begin_date}
								AND #{sta_end_date}>b.redeem_date
								and b.data_status in ('6')
								and n.data_status in ('4','5','6')
								and b.data_status !='7'
								and b.redeem_type !='2'
								and (#{sta_begin_date}>n.date_of_payment or (n.date_of_payment>=#{sta_begin_date} and b.is_take_off_damages = '1')) 
								and x.wms_inve_pruduct_category_id not in (${reject_proid})
								AND b.wms_inve_redeem_id = v.wms_inve_redeem_id
								AND v.wms_inve_transa_id = x.wms_inve_transa_id
								and n.wms_inve_transa_id=x.wms_inve_transa_id
								and exists (select 1 from pm_personnel e where n.bel_salesman_id_id=e.personnel_id and e.personnel_state!='7')
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=n.wms_inve_customer_id
										and x.end_of_date>ifnull(n.old_date_of_payment,n.date_of_payment)
										and x.data_type='1'
									)
								group by n.bel_department_manager_id,n.bel_department_manager_dept_id
							) c ON a.bel_department_manager_dept_id = c.bel_department_manager_dept_id and a.bel_department_manager_id=c.bel_department_manager_id
				UNION
				SELECT
								c.bel_department_manager_id,
								c.bel_department_manager_dept_id,
								ifnull(a.all_pro_acc,0) as all_add,
								ifnull(c.redeem_all, 0) as redeem_all,
								ifnull(a.all_pro_acc,0) - ifnull(c.redeem_all, 0) as cle_add,
								ifnull(a.deal_pro_add,0) as deal_pro_add,
								ifnull(c.redeem_all_deal, 0) as redeem_all_deal,
								ifnull(a.deal_pro_add,0)-ifnull(c.redeem_all_deal, 0) as cle_add_deal
								
								
							FROM
				(
								SELECT
									n.bel_department_manager_id,
									n.bel_department_manager_dept_id,
									sum(ifnull(v.redeem_amount,0)) AS redeem_all,
									sum(ifnull(v.redeem_amount,0)*x.product_deadline/12/(if(x.wms_inve_pruduct_category_id in (${specialpro}),4,1))) AS redeem_all_deal
								FROM
									wms_inve_redeem b,
									wms_inve_redeem_detail v,
									wms_inve_transa_prod x,
									wms_inve_transa n
								WHERE
									b.redeem_date >= #{sta_begin_date}
								AND #{sta_end_date}>b.redeem_date
								and b.data_status in ('6')
								and b.redeem_type not IN ('3','5')
								and n.data_status in ('4','5','6')
								and b.data_status !='7'
								and b.redeem_type !='2'
								and (#{sta_begin_date}>n.date_of_payment or (n.date_of_payment>=#{sta_begin_date} and b.is_take_off_damages = '1')) 
								and x.wms_inve_pruduct_category_id not in (${reject_proid})
								AND b.wms_inve_redeem_id = v.wms_inve_redeem_id
								AND v.wms_inve_transa_id = x.wms_inve_transa_id
								and n.wms_inve_transa_id=x.wms_inve_transa_id
								and exists (select 1 from pm_personnel e where n.bel_salesman_id_id=e.personnel_id and e.personnel_state!='7')
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=n.wms_inve_customer_id
										and x.end_of_date>ifnull(n.old_date_of_payment,n.date_of_payment)
										and x.data_type='1'
									)
								group by n.bel_department_manager_id,n.bel_department_manager_dept_id
							) c 
				LEFT JOIN
				(
									SELECT
										g.bel_department_manager_id,
										g.bel_department_manager_dept_id,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))) as all_pro_acc,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))*h.product_deadline/12/(if(h.wms_inve_pruduct_category_id in (${specialpro}),4,1))) as deal_pro_add
									FROM
										wms_inve_transa g,
										wms_inve_transa_prod h
										left join
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												group by b.wms_inve_transa_id
												)
												d
												on h.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										g.wms_inve_transa_id = h.wms_inve_transa_id
									AND g.data_status in ('4','5','6')
									and h.wms_inve_pruduct_category_id not in (${reject_proid})
									AND g.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>g.date_of_payment
									and g.old_wms_inve_transa_id is null
									and exists (select 1 from pm_personnel e where g.bel_salesman_id_id=e.personnel_id and e.personnel_state!='7')
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=g.wms_inve_customer_id
										and x.end_of_date>ifnull(g.old_date_of_payment,g.date_of_payment)
										and x.data_type='1'
									)
									group by g.bel_department_manager_id,g.bel_department_manager_dept_id
								) a
				ON a.bel_department_manager_id = c.bel_department_manager_id and a.bel_department_manager_dept_id=c.bel_department_manager_dept_id
				) f
		) c
		on a.personnel_id=c.bel_department_manager_id and a.dept_id=c.bel_department_manager_dept_id
		set 
			a.team_exc_add_base_op=c.all_add,
			a.team_exc_add_deal_op=c.deal_pro_add,
			a.team_exc_redeem_all_base_op=c.redeem_all,
			a.team_exc_redeem_all_deal_op=c.redeem_all_deal,
			a.team_clear_add_op=c.cle_add,
			a.team_clear_add_op_deal=c.cle_add_deal
		where a.statics_personnel_id=#{statics_personnel_id}
		</update>
		<update id="updateTeamViceAddData_withoutRenInve_op_daySta" parameterType="map">
			update wms_personnel_achievement_daysta a inner join (
			select 
				f.bel_vice_general_manager_id,
				f.bel_vice_general_manager_dept_id,
				f.all_add,
				f.redeem_all,
				f.cle_add,
				f.deal_pro_add,
				redeem_all_deal,
				cle_add_deal
			from (
				SELECT
								a.bel_vice_general_manager_id,
								a.bel_vice_general_manager_dept_id,
								a.all_pro_acc as all_add,
								ifnull(c.redeem_all, 0) as redeem_all,
								a.all_pro_acc - ifnull(c.redeem_all, 0) as cle_add,
								a.deal_pro_add,
								ifnull(c.redeem_all_deal, 0) as redeem_all_deal,
								a.deal_pro_add-ifnull(c.redeem_all_deal, 0) as cle_add_deal
							FROM
								(
									SELECT
										g.bel_vice_general_manager_id,
										g.bel_vice_general_manager_dept_id,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))) as all_pro_acc,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))*h.product_deadline/12/(if(h.wms_inve_pruduct_category_id in (${specialpro}),4,1))) as deal_pro_add
									FROM
										wms_inve_transa g,
										wms_inve_transa_prod h
										left join
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												group by b.wms_inve_transa_id
												)
												d
												on h.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										g.wms_inve_transa_id = h.wms_inve_transa_id
									and g.bel_center_manager_id is null
									AND g.data_status in ('4','5','6')
									and h.wms_inve_pruduct_category_id not in (${reject_proid})
									AND g.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>g.date_of_payment
									and g.old_wms_inve_transa_id is null
									and exists (select 1 from pm_personnel e where g.bel_salesman_id_id=e.personnel_id and e.personnel_state!='7')
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=g.wms_inve_customer_id
										and x.end_of_date>ifnull(g.old_date_of_payment,g.date_of_payment)
										and x.data_type='1'
									)
									group by g.bel_vice_general_manager_id,g.bel_vice_general_manager_dept_id
								) a
							LEFT JOIN (
								SELECT
									n.bel_vice_general_manager_id,
									n.bel_vice_general_manager_dept_id,
									sum(ifnull(v.redeem_amount,0)) AS redeem_all,
									sum(ifnull(v.redeem_amount,0)*x.product_deadline/12/(if(x.wms_inve_pruduct_category_id in (${specialpro}),4,1))) AS redeem_all_deal
								FROM
									wms_inve_redeem b,
									wms_inve_redeem_detail v,
									wms_inve_transa_prod x,
									wms_inve_transa n
								WHERE
									b.redeem_date >= #{sta_begin_date}
								AND #{sta_end_date}>b.redeem_date
								and b.data_status in ('6')
								and n.data_status in ('4','5','6')
								and b.data_status !='7'
								and b.redeem_type !='2'
								and (#{sta_begin_date}>n.date_of_payment or (n.date_of_payment>=#{sta_begin_date} and b.is_take_off_damages = '1')) 
								and x.wms_inve_pruduct_category_id not in (${reject_proid})
								AND b.wms_inve_redeem_id = v.wms_inve_redeem_id
								and n.bel_center_manager_id is null
								AND v.wms_inve_transa_id = x.wms_inve_transa_id
								and n.wms_inve_transa_id=x.wms_inve_transa_id
								and exists (select 1 from pm_personnel e where n.bel_salesman_id_id=e.personnel_id and e.personnel_state!='7')
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=n.wms_inve_customer_id
										and x.end_of_date>ifnull(n.old_date_of_payment,n.date_of_payment)
										and x.data_type='1'
									)
								group by n.bel_vice_general_manager_id,n.bel_vice_general_manager_dept_id
							) c ON a.bel_vice_general_manager_id = c.bel_vice_general_manager_id and a.bel_vice_general_manager_dept_id=c.bel_vice_general_manager_dept_id
				UNION
				SELECT
								c.bel_vice_general_manager_id,
								c.bel_vice_general_manager_dept_id,
								ifnull(a.all_pro_acc,0) as all_add,
								ifnull(c.redeem_all, 0) as redeem_all,
								ifnull(a.all_pro_acc,0) - ifnull(c.redeem_all, 0) as cle_add,
								ifnull(a.deal_pro_add,0) as deal_pro_add,
								ifnull(c.redeem_all_deal, 0) as redeem_all_deal,
								ifnull(a.deal_pro_add,0)-ifnull(c.redeem_all_deal, 0) as cle_add_deal
								
								
							FROM
				(
								SELECT
									n.bel_vice_general_manager_id,
									n.bel_vice_general_manager_dept_id,
									sum(ifnull(v.redeem_amount,0)) AS redeem_all,
									sum(ifnull(v.redeem_amount,0)*x.product_deadline/12/(if(x.wms_inve_pruduct_category_id in (${specialpro}),4,1))) AS redeem_all_deal
								FROM
									wms_inve_redeem b,
									wms_inve_redeem_detail v,
									wms_inve_transa_prod x,
									wms_inve_transa n
								WHERE
									b.redeem_date >= #{sta_begin_date}
								AND #{sta_end_date}>b.redeem_date
								and b.data_status in ('6')
								and b.redeem_type not IN ('3','5')
								and n.data_status in ('4','5','6')
								and b.data_status !='7'
								and b.redeem_type !='2'
								and (#{sta_begin_date}>n.date_of_payment or (n.date_of_payment>=#{sta_begin_date} and b.is_take_off_damages = '1')) 
								and x.wms_inve_pruduct_category_id not in (${reject_proid})
								AND b.wms_inve_redeem_id = v.wms_inve_redeem_id
								and n.bel_center_manager_id is null
								AND v.wms_inve_transa_id = x.wms_inve_transa_id
								and n.wms_inve_transa_id=x.wms_inve_transa_id
								and exists (select 1 from pm_personnel e where n.bel_salesman_id_id=e.personnel_id and e.personnel_state!='7')
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=n.wms_inve_customer_id
										and x.end_of_date>ifnull(n.old_date_of_payment,n.date_of_payment)
										and x.data_type='1'
									)
								group by n.bel_vice_general_manager_id,n.bel_vice_general_manager_dept_id
							) c 
				LEFT JOIN
				(
									SELECT
										g.bel_vice_general_manager_id,
										g.bel_vice_general_manager_dept_id,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))) as all_pro_acc,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))*h.product_deadline/12/(if(h.wms_inve_pruduct_category_id in (${specialpro}),4,1))) as deal_pro_add
									FROM
										wms_inve_transa g,
										wms_inve_transa_prod h
										left join
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												group by b.wms_inve_transa_id
												)
												d
												on h.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										g.wms_inve_transa_id = h.wms_inve_transa_id
									AND g.data_status in ('4','5','6')
									and h.wms_inve_pruduct_category_id not in (${reject_proid})
									AND g.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>g.date_of_payment
									and g.old_wms_inve_transa_id is null
									and g.bel_center_manager_id is null
									and exists (select 1 from pm_personnel e where g.bel_salesman_id_id=e.personnel_id and e.personnel_state!='7')
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=g.wms_inve_customer_id
										and x.end_of_date>ifnull(g.old_date_of_payment,g.date_of_payment)
										and x.data_type='1'
									)
									group by g.bel_vice_general_manager_id,g.bel_vice_general_manager_dept_id
								) a
				ON a.bel_vice_general_manager_id = c.bel_vice_general_manager_id and a.bel_vice_general_manager_dept_id=c.bel_vice_general_manager_dept_id
				) f
		) c
		on a.personnel_id=c.bel_vice_general_manager_id and a.dept_id=c.bel_vice_general_manager_dept_id
		set 
			a.team_exc_add_base_op=c.all_add,
			a.team_exc_add_deal_op=c.deal_pro_add,
			a.team_exc_redeem_all_base_op=c.redeem_all,
			a.team_exc_redeem_all_deal_op=c.redeem_all_deal,
			a.team_clear_add_op=c.cle_add,
			a.team_clear_add_op_deal=c.cle_add_deal
			
		where a.statics_personnel_id=#{statics_personnel_id}
		</update>
		<update id="updateTeamCenterAddData_withoutRenInve_op_daySta" parameterType="map">
			update wms_personnel_achievement_daysta a inner join (
			select 
				f.bel_center_manager_id,
				f.bel_center_manager_dept_id,
				f.all_add,
				f.redeem_all,
				f.cle_add,
				f.deal_pro_add,
				redeem_all_deal,
				cle_add_deal
			from (
				SELECT
								a.bel_center_manager_id,
								a.bel_center_manager_dept_id,
								a.all_pro_acc as all_add,
								ifnull(c.redeem_all, 0) as redeem_all,
								a.all_pro_acc - ifnull(c.redeem_all, 0) as cle_add,
								a.deal_pro_add,
								ifnull(c.redeem_all_deal, 0) as redeem_all_deal,
								a.deal_pro_add-ifnull(c.redeem_all_deal, 0) as cle_add_deal
							FROM
								(
									SELECT
										g.bel_center_manager_id,
										g.bel_center_manager_dept_id,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))) as all_pro_acc,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))*h.product_deadline/12/(if(h.wms_inve_pruduct_category_id in (${specialpro}),4,1))) as deal_pro_add
									FROM
										wms_inve_transa g,
										wms_inve_transa_prod h
										left join
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												group by b.wms_inve_transa_id
												)
												d
												on h.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										g.wms_inve_transa_id = h.wms_inve_transa_id
									AND g.data_status in ('4','5','6')
									and h.wms_inve_pruduct_category_id not in (${reject_proid})
									AND g.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>g.date_of_payment
									and g.old_wms_inve_transa_id is null
									and exists (select 1 from pm_personnel e where g.bel_salesman_id_id=e.personnel_id and e.personnel_state!='7')
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=g.wms_inve_customer_id
										and x.end_of_date>ifnull(g.old_date_of_payment,g.date_of_payment)
										and x.data_type='1'
									)
									group by g.bel_center_manager_id,g.bel_center_manager_dept_id
								) a
							LEFT JOIN (
								SELECT
									n.bel_center_manager_id,
									n.bel_center_manager_dept_id,
									sum(ifnull(v.redeem_amount,0)) AS redeem_all,
									sum(ifnull(v.redeem_amount,0)*x.product_deadline/12/(if(x.wms_inve_pruduct_category_id in (${specialpro}),4,1))) AS redeem_all_deal
								FROM
									wms_inve_redeem b,
									wms_inve_redeem_detail v,
									wms_inve_transa_prod x,
									wms_inve_transa n
								WHERE
									b.redeem_date >= #{sta_begin_date}
								AND #{sta_end_date}>b.redeem_date
								and b.data_status in ('6')
								and n.data_status in ('4','5','6')
								and b.data_status !='7'
								and b.redeem_type !='2'
								and (#{sta_begin_date}>n.date_of_payment or (n.date_of_payment>=#{sta_begin_date} and b.is_take_off_damages = '1')) 
								and x.wms_inve_pruduct_category_id not in (${reject_proid})
								AND b.wms_inve_redeem_id = v.wms_inve_redeem_id
								AND v.wms_inve_transa_id = x.wms_inve_transa_id
								and n.wms_inve_transa_id=x.wms_inve_transa_id
								and exists (select 1 from pm_personnel e where n.bel_salesman_id_id=e.personnel_id and e.personnel_state!='7')
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=n.wms_inve_customer_id
										and x.end_of_date>ifnull(n.old_date_of_payment,n.date_of_payment)
										and x.data_type='1'
									)
								group by n.bel_center_manager_id,n.bel_center_manager_dept_id
							) c ON a.bel_center_manager_id = c.bel_center_manager_id and a.bel_center_manager_dept_id=c.bel_center_manager_dept_id
				UNION
				SELECT
								c.bel_center_manager_id,
								c.bel_center_manager_dept_id,
								ifnull(a.all_pro_acc,0) as all_add,
								ifnull(c.redeem_all, 0) as redeem_all,
								ifnull(a.all_pro_acc,0) - ifnull(c.redeem_all, 0) as cle_add,
								ifnull(a.deal_pro_add,0) as deal_pro_add,
								ifnull(c.redeem_all_deal, 0) as redeem_all_deal,
								ifnull(a.deal_pro_add,0)-ifnull(c.redeem_all_deal, 0) as cle_add_deal
								
								
							FROM
				(
								SELECT
									n.bel_center_manager_id,
									n.bel_center_manager_dept_id,
									sum(ifnull(v.redeem_amount,0)) AS redeem_all,
									sum(ifnull(v.redeem_amount,0)*x.product_deadline/12/(if(x.wms_inve_pruduct_category_id in (${specialpro}),4,1))) AS redeem_all_deal
								FROM
									wms_inve_redeem b,
									wms_inve_redeem_detail v,
									wms_inve_transa_prod x,
									wms_inve_transa n
								WHERE
									b.redeem_date >= #{sta_begin_date}
								AND #{sta_end_date}>b.redeem_date
								and b.data_status in ('6')
								and b.redeem_type not IN ('3','5')
								and n.data_status in ('4','5','6')
								and b.data_status !='7'
								and b.redeem_type !='2'
								and (#{sta_begin_date}>n.date_of_payment or (n.date_of_payment>=#{sta_begin_date} and b.is_take_off_damages = '1')) 
								and x.wms_inve_pruduct_category_id not in (${reject_proid})
								AND b.wms_inve_redeem_id = v.wms_inve_redeem_id
								AND v.wms_inve_transa_id = x.wms_inve_transa_id
								and n.wms_inve_transa_id=x.wms_inve_transa_id
								and exists (select 1 from pm_personnel e where n.bel_salesman_id_id=e.personnel_id and e.personnel_state!='7')
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=n.wms_inve_customer_id
										and x.end_of_date>ifnull(n.old_date_of_payment,n.date_of_payment)
										and x.data_type='1'
									)
								group by n.bel_center_manager_id,n.bel_center_manager_dept_id
							) c 
				LEFT JOIN
				(
									SELECT
										g.bel_center_manager_id,
										g.bel_center_manager_dept_id,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))) as all_pro_acc,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))*h.product_deadline/12/(if(h.wms_inve_pruduct_category_id in (${specialpro}),4,1))) as deal_pro_add
									FROM
										wms_inve_transa g,
										wms_inve_transa_prod h
										left join
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												group by b.wms_inve_transa_id
												)
												d
												on h.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										g.wms_inve_transa_id = h.wms_inve_transa_id
									AND g.data_status in ('4','5','6')
									and h.wms_inve_pruduct_category_id not in (${reject_proid})
									AND g.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>g.date_of_payment
									and g.old_wms_inve_transa_id is null
									and exists (select 1 from pm_personnel e where g.bel_salesman_id_id=e.personnel_id and e.personnel_state!='7')
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=g.wms_inve_customer_id
										and x.end_of_date>ifnull(g.old_date_of_payment,g.date_of_payment)
										and x.data_type='1'
									)
									group by g.bel_center_manager_id,g.bel_center_manager_dept_id
								) a
				ON a.bel_center_manager_id = c.bel_center_manager_id and a.bel_center_manager_dept_id=c.bel_center_manager_dept_id
				) f
		) c
		on a.personnel_id=c.bel_center_manager_id and a.dept_id=c.bel_center_manager_dept_id
		set 
			a.team_exc_add_base_op=c.all_add,
			a.team_exc_add_deal_op=c.deal_pro_add,
			a.team_exc_redeem_all_base_op=c.redeem_all,
			a.team_exc_redeem_all_deal_op=c.redeem_all_deal,
			a.team_clear_add_op=c.cle_add,
			a.team_clear_add_op_deal=c.cle_add_deal
		where a.statics_personnel_id=#{statics_personnel_id}
		</update>
		<update id="updateTeamGelAddData_withoutRenInve_op_daySta" parameterType="map">
			update wms_personnel_achievement_daysta a inner join (
			select 
				f.bel_general_manager_id,
				f.bel_general_manager_dept_id,
				f.all_add,
				f.redeem_all,
				f.cle_add,
				f.deal_pro_add,
				redeem_all_deal,
				cle_add_deal
			from (
				SELECT
								a.bel_general_manager_id,
								a.bel_general_manager_dept_id,
								a.all_pro_acc as all_add,
								ifnull(c.redeem_all, 0) as redeem_all,
								a.all_pro_acc - ifnull(c.redeem_all, 0) as cle_add,
								a.deal_pro_add,
								ifnull(c.redeem_all_deal, 0) as redeem_all_deal,
								a.deal_pro_add-ifnull(c.redeem_all_deal, 0) as cle_add_deal
							FROM
								(
									SELECT
										g.bel_general_manager_id,
										g.bel_general_manager_dept_id,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))) as all_pro_acc,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))*h.product_deadline/12/(if(h.wms_inve_pruduct_category_id in (${specialpro}),4,1))) as deal_pro_add
									FROM
										wms_inve_transa g,
										wms_inve_transa_prod h
										left join
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												group by b.wms_inve_transa_id
												)
												d
												on h.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										g.wms_inve_transa_id = h.wms_inve_transa_id
									and g.bel_center_manager_id is null
									and g.bel_vice_general_manager_id is null
									and g.bel_department_manager_id is null
									AND g.data_status in ('4','5','6')
									and h.wms_inve_pruduct_category_id not in (${reject_proid})
									AND g.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>g.date_of_payment
									and g.old_wms_inve_transa_id is null
									and exists (select 1 from pm_personnel e where g.bel_salesman_id_id=e.personnel_id and e.personnel_state!='7')
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=g.wms_inve_customer_id
										and x.end_of_date>ifnull(g.old_date_of_payment,g.date_of_payment)
										and x.data_type='1'
									)
									group by g.bel_general_manager_id,g.bel_general_manager_dept_id
								) a
							LEFT JOIN (
								SELECT
									n.bel_general_manager_id,
									n.bel_general_manager_dept_id,
									sum(ifnull(v.redeem_amount,0)) AS redeem_all,
									sum(ifnull(v.redeem_amount,0)*x.product_deadline/12/(if(x.wms_inve_pruduct_category_id in (${specialpro}),4,1))) AS redeem_all_deal
								FROM
									wms_inve_redeem b,
									wms_inve_redeem_detail v,
									wms_inve_transa_prod x,
									wms_inve_transa n
								WHERE
									b.redeem_date >= #{sta_begin_date}
								AND #{sta_end_date}>b.redeem_date
								and b.data_status in ('6')
								and n.data_status in ('4','5','6')
								and b.data_status !='7'
								and b.redeem_type !='2'
								and (#{sta_begin_date}>n.date_of_payment or (n.date_of_payment>=#{sta_begin_date} and b.is_take_off_damages = '1')) 
								and x.wms_inve_pruduct_category_id not in (${reject_proid})
								AND b.wms_inve_redeem_id = v.wms_inve_redeem_id
								and n.bel_center_manager_id is null
								and n.bel_vice_general_manager_id is null
								and n.bel_department_manager_id is null
								AND v.wms_inve_transa_id = x.wms_inve_transa_id
								and n.wms_inve_transa_id=x.wms_inve_transa_id
								and exists (select 1 from pm_personnel e where n.bel_salesman_id_id=e.personnel_id and e.personnel_state!='7')
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=n.wms_inve_customer_id
										and x.end_of_date>ifnull(n.old_date_of_payment,n.date_of_payment)
										and x.data_type='1'
									)
								group by n.bel_general_manager_id,n.bel_general_manager_dept_id
							) c ON a.bel_general_manager_id = c.bel_general_manager_id and a.bel_general_manager_dept_id=c.bel_general_manager_dept_id
				UNION
				SELECT
								c.bel_general_manager_id,
								c.bel_general_manager_dept_id,
								ifnull(a.all_pro_acc,0) as all_add,
								ifnull(c.redeem_all, 0) as redeem_all,
								ifnull(a.all_pro_acc,0) - ifnull(c.redeem_all, 0) as cle_add,
								ifnull(a.deal_pro_add,0) as deal_pro_add,
								ifnull(c.redeem_all_deal, 0) as redeem_all_deal,
								ifnull(a.deal_pro_add,0)-ifnull(c.redeem_all_deal, 0) as cle_add_deal
								
								
							FROM
				(
								SELECT
									n.bel_general_manager_id,
									n.bel_general_manager_dept_id,
									sum(ifnull(v.redeem_amount,0)) AS redeem_all,
									sum(ifnull(v.redeem_amount,0)*x.product_deadline/12/(if(x.wms_inve_pruduct_category_id in (${specialpro}),4,1))) AS redeem_all_deal
								FROM
									wms_inve_redeem b,
									wms_inve_redeem_detail v,
									wms_inve_transa_prod x,
									wms_inve_transa n
								WHERE
									b.redeem_date >= #{sta_begin_date}
								AND #{sta_end_date}>b.redeem_date
								and b.data_status in ('6')
								and b.redeem_type not IN ('3','5')
								and n.data_status in ('4','5','6')
								and b.data_status !='7'
								and b.redeem_type !='2'
								and (#{sta_begin_date}>n.date_of_payment or (n.date_of_payment>=#{sta_begin_date} and b.is_take_off_damages = '1')) 
								and x.wms_inve_pruduct_category_id not in (${reject_proid})
								AND b.wms_inve_redeem_id = v.wms_inve_redeem_id
								and n.bel_center_manager_id is null
								and n.bel_vice_general_manager_id is null
								and n.bel_department_manager_id is null
								AND v.wms_inve_transa_id = x.wms_inve_transa_id
								and n.wms_inve_transa_id=x.wms_inve_transa_id
								and exists (select 1 from pm_personnel e where n.bel_salesman_id_id=e.personnel_id and e.personnel_state!='7')
								and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=n.wms_inve_customer_id
										and x.end_of_date>ifnull(n.old_date_of_payment,n.date_of_payment)
										and x.data_type='1'
									)
								group by n.bel_general_manager_id,n.bel_general_manager_dept_id
							) c 
				LEFT JOIN
				(
									SELECT
										g.bel_general_manager_id,
										g.bel_general_manager_dept_id,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))) as all_pro_acc,
										sum((h.org_product_account-ifnull(d.no_damage_am,0))*h.product_deadline/12/(if(h.wms_inve_pruduct_category_id in (${specialpro}),4,1))) as deal_pro_add
									FROM
										wms_inve_transa g,
										wms_inve_transa_prod h
										left join
										(select 
												b.wms_inve_transa_id,
												sum(if(c.is_take_off_damages ='0',b.redeem_amount,0)) as no_damage_am
											from 
												wms_inve_redeem c,
												wms_inve_redeem_detail b 
											where 
												c.wms_inve_redeem_id=b.wms_inve_redeem_id 
												and c.redeem_date >= #{sta_begin_date}
												AND #{sta_end_date}>c.redeem_date 
												group by b.wms_inve_transa_id
												)
												d
												on h.wms_inve_transa_id=d.wms_inve_transa_id
									WHERE
										g.wms_inve_transa_id = h.wms_inve_transa_id
									AND g.data_status in ('4','5','6')
									and h.wms_inve_pruduct_category_id not in (${reject_proid})
									AND g.date_of_payment >= #{sta_begin_date}
									AND #{sta_end_date}>g.date_of_payment
									and g.old_wms_inve_transa_id is null
									and g.bel_center_manager_id is null
									and g.bel_vice_general_manager_id is null
									and g.bel_department_manager_id is null
									and exists (select 1 from pm_personnel e where g.bel_salesman_id_id=e.personnel_id and e.personnel_state!='7')
									and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=g.wms_inve_customer_id
										and x.end_of_date>ifnull(g.old_date_of_payment,g.date_of_payment)
										and x.data_type='1'
									)
									group by g.bel_general_manager_id,g.bel_general_manager_dept_id
								) a
				ON a.bel_general_manager_id = c.bel_general_manager_id and a.bel_general_manager_dept_id=c.bel_general_manager_dept_id
				) f
		) c
		on a.personnel_id=c.bel_general_manager_id and a.dept_id=c.bel_general_manager_dept_id
		set 
			a.team_exc_add_base_op=c.all_add,
			a.team_exc_add_deal_op=c.deal_pro_add,
			a.team_exc_redeem_all_base_op=c.redeem_all,
			a.team_exc_redeem_all_deal_op=c.redeem_all_deal,
			a.team_clear_add_op=c.cle_add,
			a.team_clear_add_op_deal=c.cle_add_deal
		where a.statics_personnel_id=#{statics_personnel_id}
		and a.personnel_name_detail !='冯涛 100006(转)'
		</update>
		
		<update id="updateTeamClearAdd_TeamStuffData_daySta" parameterType="map">
			update wms_personnel_achievement_daysta a INNER JOIN (
			select b.personnel_deptid,count(1) as deptStuCou from pm_personnel b where b.personnel_state not in ('3','7') group by b.personnel_deptid
		) c on a.dept_id=c.personnel_deptid
		set a.team_staff_num=c.deptStuCou,a.team_per_increase=ifnull(a.team_clear_add_op,0)/ifnull(c.deptStuCou,1)
		where a.statics_personnel_id=#{statics_personnel_id}
		and exists (select 1 from sys_post d where a.post_number=d.post_id and (d.post_number like '%PCFBMJL%' or  d.post_number like '%PCFJXBMJL%'))
		</update>
		<update id="updateTeamChangeStateNum_daySta"  parameterType="map">
		update wms_personnel_achievement_daysta a INNER JOIN (
			select b.personnel_deptid,count(1) as deptStuCou 
			from 
				pm_personnel b 
			where b.personnel_state='1'  and b.personnel_positiveTime >= #{sta_begin_date} and #{sta_end_date}> b.personnel_positiveTime   group by b.personnel_deptid
		) c on a.dept_id=c.personnel_deptid
		set a.team_staff_num_regular=c.deptStuCou
		where a.statics_personnel_id=#{statics_personnel_id}
		and exists (select 1 from sys_post d where a.post_number=d.post_id and (d.post_number like '%PCFBMJL%' or  d.post_number like '%PCFJXBMJL%'))
		</update>
		<select id="findPerCount_currmonth" parameterType="map" resultType="int">
			select 
				count(1)
		from wms_personnel_achievement_daysta c,
		(
					SELECT
						a.personnel_deptid,a.personnel_id,a.personnel_name,a.personnel_shortcode,a.personnel_postid,a.personnel_postname,a.personnel_state
					FROM
						pm_personnel a
					UNION
						SELECT
							b.dept_id as personnel_deptid,a.personnel_id,a.personnel_name,a.personnel_shortcode,b.post_id as personnel_postid,a.personnel_postname,a.personnel_state
						FROM
							pm_personnel a,
							sys_concurrent_post b
						WHERE
							a.personnel_id = b.personnel_id
					)  a
		 where
		 	c.statics_personnel_id=#{statics_personnel_id}
		 and c.personnel_id=a.personnel_id
		 and c.dept_id=a.personnel_deptid
		  <if test="deptNameList != null and deptNameList.size > 0">
			AND ( 1=2
			<foreach collection="deptNameList" item="dept_name">
				OR c.dept_name like CONCAT('%',#{dept_name },'%')
			</foreach>
			)
		</if>
		  
			<if test="personnel_info != null and personnel_info != ''">
				and (a.personnel_name like '%${personnel_info}%' or a.personnel_shortCode like  '%${personnel_info}%')
			</if>
			
		  <if test="personnel_state == 1">
				and a.personnel_state not in ('3','7')
			</if>
			<if test="personnel_state == 2">
				and a.personnel_state in ('7')
			</if>
			
			 <if test="per_sum_add_deal_low != null and per_sum_add_deal_low != ''">
				and truncate(ifnull(c.per_add_deal,0)-ifnull(c.per_back_deal,0)+ifnull(c.per_special_add,0),0) >= #{per_sum_add_deal_low} 
			</if>
			 <if test="per_sum_add_deal_up != null and per_sum_add_deal_up != ''">
				and #{per_sum_add_deal_up} > truncate(ifnull(c.per_add_deal,0)-ifnull(c.per_back_deal,0)+ifnull(c.per_special_add,0),0) 
			</if>
			<if test="per_clear_add_low != null and per_clear_add_low != ''">
				and truncate(ifnull(c.per_clear_add,0),0) >= #{per_clear_add_low}
			</if>
			
			<if test="per_clear_add_up != null and per_clear_add_up != ''">
				and #{per_clear_add_up} > truncate(ifnull(c.per_clear_add,0),0) 
			</if>
			
			<if test="per_stock_all_low != null and per_stock_all_low != ''">
				and truncate(ifnull(c.per_stock_all,0),0) >= #{per_stock_all_low}
			</if>
			
			<if test="per_stock_all_up != null and per_stock_all_up != ''">
				and #{per_stock_all_up} > truncate(ifnull(c.per_stock_all,0),0) 
			</if>
			
			<if test="per_stock_new_deal_low != null and per_stock_new_deal_low != ''">
				and truncate(ifnull(c.per_stock_new_deal,0),0) >= #{per_stock_new_deal_low}
			</if>
			
			<if test="per_stock_new_deal_up != null and per_stock_new_deal_up != ''">
				and #{per_stock_new_deal_up} > truncate(ifnull(c.per_stock_new_deal,0),0) 
			</if>
			
		</select>
		<select id="searchBaseAchievementTeamList_currmonth" parameterType="map" resultType="java.util.HashMap">
			select 
			c.company_name,
			c.dept_id,
			c.dept_name,
			c.personnel_id,
			c.personnel_name_detail,
			c.post_name,
			truncate(ifnull(c.team_add_base,0),0) as team_add_base,
			truncate(ifnull(c.team_redeem_all_base,0),0) as team_redeem_all_base,
			truncate(ifnull(c.team_exc_add_base,0),0) as team_exc_add_base,
			truncate(ifnull(c.team_exc_redeem_all_base,0),0) as team_exc_redeem_all_base,
			truncate(ifnull(c.team_clear_add,0),0) as team_clear_add,
			truncate(ifnull(c.team_exc_add_base_op,0),0) as team_exc_add_base_op,
			truncate(ifnull(c.team_exc_redeem_all_base_op,0),0) as team_exc_redeem_all_base_op,
			truncate(ifnull(c.team_clear_add_op,0),0) as team_clear_add_op,
			truncate(ifnull(c.team_staff_num,0),0) as team_staff_num,
			truncate(ifnull(c.team_per_increase,0),0) as team_per_increase,
			truncate(ifnull(c.team_stock_all,0),0) as team_stock_all,
			truncate(ifnull(c.team_stock_all_deal,0),0) as team_stock_all_deal,
			truncate(ifnull(c.team_stock_new,0),0) as team_stock_new,
			truncate(ifnull(c.team_stock_new_deal,0),0) as team_stock_new_deal,
			'0' as team_sea_clear_add,
			'0' as team_sea_staff_num,
			'0' as team_sea_per_increase,
			'0' as team_sea_staff_num_regular,
			case when c.personnel_state='3' then '离职' when c.personnel_state ='7' then '兼职' 
					when c.personnel_state ='0' then '试用'  
					when c.personnel_state ='2' then '实习'
					when c.personnel_state ='1' then '在职'   else '' end as personnel_state,
			truncate(ifnull(c.team_reinve_mon,0),0) as team_reinve_mon,
			'0' as team_gsalary_stock_all,
			'0' as lastmonth_team_gsalary_stock_all,
			'0' as team_month_clear_stock
			
		from 
		wms_personnel_achievement_daysta c
		 where
		  c.statics_personnel_id=#{statics_personnel_id}
		 and c.team_stock_all is not null
		<if test="deptNameList != null and deptNameList.size > 0">
			AND ( 1=2
			<foreach collection="deptNameList" item="dept_name">
				OR c.dept_name like CONCAT('%',#{dept_name },'%')
			</foreach>
			)
		</if>
			<if test="personnel_info != null and personnel_info != ''">
				and c.personnel_name_detail like '%${personnel_info}%'
			</if>
		   <if test="personnel_state == 1">
				and c.personnel_state not in ('3','7')
			</if>
			<if test="personnel_state == 2">
				and c.personnel_state in ('7')
			</if>
			
			<if test="team_clear_add_low != null and team_clear_add_low != ''">
				and truncate(ifnull(c.team_clear_add,0),0)  >= #{team_clear_add_low} 
			</if>
			
			<if test="team_clear_add_up != null and team_clear_add_up != ''">
				and #{team_clear_add_up} >= truncate(ifnull(c.team_clear_add,0),0)
			</if>
			
			<if test="team_stock_all_low != null and team_stock_all_low != ''">
				and truncate(ifnull(c.team_stock_all,0),0)  >= #{team_stock_all_low} 
			</if>
			
			<if test="team_stock_all_up != null and team_stock_all_up != ''">
				and #{team_stock_all_up} >= truncate(ifnull(c.team_stock_all,0),0)
			</if>
			
		
		<if test="sortname != '' and sortorder !=''">
			ORDER BY ${sortname} ${sortorder}
		</if>
		<if test="offset != null and pagesize !=null">
			LIMIT ${offset} , ${pagesize}
		</if>
		</select>
		
		<select id="findteamCount_currmonth" parameterType="map" resultType="int">
			select 
				count(1)
		from wms_personnel_achievement_daysta c
		 where
		  c.statics_personnel_id=#{statics_personnel_id}
		  and c.team_stock_all is not null
		  <if test="deptNameList != null and deptNameList.size > 0">
			AND ( 1=2
			<foreach collection="deptNameList" item="dept_name">
				OR c.dept_name like CONCAT('%',#{dept_name },'%')
			</foreach>
			)
		</if>
			<if test="personnel_info != null and personnel_info != ''">
				and c.personnel_name_detail like '%${personnel_info}%'
			</if>
		   <if test="personnel_state == 1">
				and c.personnel_state not in ('3','7')
			</if>
			<if test="personnel_state == 2">
				and c.personnel_state in ('7')
			</if>
			
			<if test="team_clear_add_low != null and team_clear_add_low != ''">
				and truncate(ifnull(c.team_clear_add,0),0)  >= #{team_clear_add_low} 
			</if>
			
			<if test="team_clear_add_up != null and team_clear_add_up != ''">
				and #{team_clear_add_up} >= truncate(ifnull(c.team_clear_add,0),0)
			</if>
			
			<if test="team_stock_all_low != null and team_stock_all_low != ''">
				and truncate(ifnull(c.team_stock_all,0),0)  >= #{team_stock_all_low} 
			</if>
			
			<if test="team_stock_all_up != null and team_stock_all_up != ''">
				and #{team_stock_all_up} >= truncate(ifnull(c.team_stock_all,0),0)
			</if>
		</select>
		<select id="getNewProListByRule"  parameterType="int" resultType="map">
			select wms_inve_pruduct_category_ids from wms_inve_comm_rule where wms_inve_comm_item_id=#{RULEMODULE_ADD}
		</select>
		
		<insert id="batchInsertShareHolderCommission" parameterType="java.util.List" >
			insert into wms_inve_commission_shareholder_special
			(
				wms_inve_transa_id,
				comm_rate,
				wms_inve_comm_item_id,
				create_user_id,
				create_datetime,
				enable_flag
			)
			values
			<foreach collection="list" index="index" item="item" separator=",">
				(
					#{item.wms_inve_transa_id },
					#{item.comm_rate },
					#{item.wms_inve_comm_item_id },
					#{item.create_user_id },
					#{item.create_datetime },
					#{item.enable_flag }
				)
			</foreach>
		</insert>
		
		<update id="updateSpecialProPerSta_daySta" parameterType="map">
		update wms_personnel_achievement_daysta a inner join (
			SELECT
				a.bel_salesman_id_id,
				a.bel_salesman_dept_id,
				sum(w.org_product_account * w.product_deadline / 12 / 4) AS act_account
			FROM
				wms_inve_transa a,
				wms_inve_transa_prod w,
				wms_inve_comm_release_mode f
			WHERE
				a.data_status IN ('4')
			AND #{sta_begin_date}>a.date_of_payment
			AND a.wms_inve_transa_id = w.wms_inve_transa_id
			and w.wms_inve_pruduct_category_id in (${specialpro})
			AND f.wms_inve_pruduct_category_ids = w.wms_inve_pruduct_category_id
			AND #{statics_month_sp} = DATE_FORMAT(
				DATE_ADD(
					a.date_of_payment,
					INTERVAL f.release_month - 1 MONTH
				),
				'%Y-%m'
			)
			and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=a.wms_inve_customer_id
				and x.end_of_date>ifnull(a.old_date_of_payment,a.date_of_payment)
				and x.data_type='1'
			)
			group by a.bel_salesman_id_id,a.bel_salesman_dept_id
		) b
		on a.personnel_id = b.bel_salesman_id_id and a.dept_id=b.bel_salesman_dept_id
		set 
			a.per_special_add=b.act_account
		where a.statics_personnel_id=#{statics_personnel_id}
		and a.personnel_name_detail !='冯涛 100006(转)'
	</update>
	<update id="updateSpecialProPerSta_daySta_com" parameterType="map">
		update wms_personnel_achievement_daysta a inner join (
			SELECT
				a.bel_salesman_id_id,
				a.bel_salesman_dept_id,
				sum(w.org_product_account * w.product_deadline / 12 / 4) AS act_account
			FROM
				wms_inve_transa a,
				wms_inve_transa_prod w,
				wms_inve_comm_release_mode f
			WHERE
				a.data_status IN ('4')
			AND #{sta_begin_date}>a.date_of_payment
			AND a.wms_inve_transa_id = w.wms_inve_transa_id
			and w.wms_inve_pruduct_category_id in (${specialpro})
			AND f.wms_inve_pruduct_category_ids = w.wms_inve_pruduct_category_id
			AND #{statics_month_sp} = DATE_FORMAT(
				DATE_ADD(
					a.date_of_payment,
					INTERVAL f.release_month - 1 MONTH
				),
				'%Y-%m'
			)
			and exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=a.wms_inve_customer_id
				and x.end_of_date>ifnull(a.old_date_of_payment,a.date_of_payment)
				and x.data_type='1'
			)
			group by a.bel_salesman_id_id,a.bel_salesman_dept_id
		) b
		on a.personnel_id = b.bel_salesman_id_id and a.dept_id=b.bel_salesman_dept_id
		set 
			a.per_special_add=b.act_account
		where a.statics_personnel_id=#{statics_personnel_id}
		and a.personnel_name_detail ='冯涛 100006(转)'
	</update>
	<update id="updatePersonnelReinveMon" parameterType="map">
		update wms_personnel_achievement_daysta a inner join (
			select 
				a.bel_salesman_id_id,
				a.bel_salesman_dept_id,
				sum(ifnull(b.act_account,0)) as reinve_mon
			from 
				wms_inve_transa a,
				wms_inve_transa_card b,
				wms_inve_transa_prod c
			where 
				a.wms_inve_transa_id=b.wms_inve_transa_id 
			and a.data_status in ('4','6')
			and b.pay_type='3'
			and a.date_of_payment>=#{sta_begin_date}
			and #{sta_end_date}>a.date_of_payment
			and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=a.wms_inve_customer_id
										and x.end_of_date>ifnull(a.old_date_of_payment,a.date_of_payment)
										and x.data_type='1'
										and x.change_date&lt;=(select t1.job_date from wms_inve_job_time t1 where t1.job_month=#{statics_month} and t1.job_type='1')
									)
			and a.wms_inve_transa_id=c.wms_inve_transa_id
			and c.wms_inve_pruduct_category_id not in (${reject_proid})
			and b.enable_flag='1' 
			group by a.bel_salesman_id_id,a.bel_salesman_dept_id
		) b on a.personnel_id = b.bel_salesman_id_id and a.dept_id=b.bel_salesman_dept_id
		set a.reinve_mon=b.reinve_mon
		where a.statics_personnel_id=#{statics_personnel_id}
		and a.personnel_name_detail !='冯涛 100006(转)'
	</update>
	<update id="updatePersonnelReinveMon_com" parameterType="map">
		update wms_personnel_achievement_daysta a inner join (
			select 
				a.bel_salesman_id_id,
				a.bel_salesman_dept_id,
				sum(ifnull(b.act_account,0)) as reinve_mon
			from 
				wms_inve_transa a,
				wms_inve_transa_card b,
				wms_inve_transa_prod c
			where 
				a.wms_inve_transa_id=b.wms_inve_transa_id 
			and a.data_status in ('4','6')
			and b.pay_type='3'
			and a.date_of_payment>=#{sta_begin_date}
			and #{sta_end_date}>a.date_of_payment
			and a.wms_inve_transa_id=c.wms_inve_transa_id
			and c.wms_inve_pruduct_category_id not in (${reject_proid})
			and b.enable_flag='1' 
			and exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=a.wms_inve_customer_id
										and x.end_of_date>ifnull(a.old_date_of_payment,a.date_of_payment)
										and x.data_type='1'
										and x.change_date&lt;=(select t1.job_date from wms_inve_job_time t1 where t1.job_month=#{statics_month} and t1.job_type='1')
									)
			group by a.bel_salesman_id_id,a.bel_salesman_dept_id
		) b on a.personnel_id = b.bel_salesman_id_id and a.dept_id=b.bel_salesman_dept_id
		set a.reinve_mon=b.reinve_mon
		where a.statics_personnel_id=#{statics_personnel_id}
		and a.personnel_name_detail ='冯涛 100006(转)'
	</update>
	<update id="updateTeamReinveMon" parameterType="map">
		update wms_personnel_achievement_daysta a inner join (
			select 
				a.bel_department_manager_dept_id,
				sum(ifnull(b.act_account,0)) as reinve_mon
			from 
				wms_inve_transa a,
				wms_inve_transa_card b,
				wms_inve_transa_prod c
			where 
				a.wms_inve_transa_id=b.wms_inve_transa_id 
			and a.data_status in ('4','6')
			and b.pay_type='3'
			and a.date_of_payment>=#{sta_begin_date}
			and #{sta_end_date}>a.date_of_payment
			and a.wms_inve_transa_id=c.wms_inve_transa_id
			and c.wms_inve_pruduct_category_id not in (${reject_proid})
			and b.enable_flag='1' 
			group by a.bel_department_manager_dept_id
		) b on a.dept_id=b.bel_department_manager_dept_id
		set a.team_reinve_mon=b.reinve_mon
		where a.statics_personnel_id=#{statics_personnel_id}
		and a.is_team_handler='1'
		
	</update>
	<update id="updateCenterReinveMon" parameterType="map">
		update wms_personnel_achievement_daysta a inner join (
			select 
				a.bel_center_manager_id,
				a.bel_center_manager_dept_id,
				sum(ifnull(b.act_account,0)) as reinve_mon
			from 
				wms_inve_transa a,
				wms_inve_transa_card b,
				wms_inve_transa_prod c
			where 
				a.wms_inve_transa_id=b.wms_inve_transa_id 
			and a.data_status in ('4','6')
			and b.pay_type='3'
			and a.wms_inve_transa_id=c.wms_inve_transa_id
			and c.wms_inve_pruduct_category_id not in (${reject_proid})
			and b.enable_flag='1' 
			and a.date_of_payment>=#{sta_begin_date}
			and #{sta_end_date}>a.date_of_payment
			group by a.bel_center_manager_id,a.bel_center_manager_dept_id
		) b on a.personnel_id = b.bel_center_manager_id and a.dept_id=b.bel_center_manager_dept_id
		set a.team_reinve_mon=b.reinve_mon
		where a.statics_personnel_id=#{statics_personnel_id}
	</update>
	
	<update id="updateViceReinveMon" parameterType="map">
		update wms_personnel_achievement_daysta a inner join (
			select 
				a.bel_vice_general_manager_id,
				a.bel_vice_general_manager_dept_id,
				sum(ifnull(b.act_account,0)) as reinve_mon
			from 
				wms_inve_transa a,
				wms_inve_transa_card b,
				wms_inve_transa_prod c
			where 
				a.wms_inve_transa_id=b.wms_inve_transa_id 
			and a.data_status in ('4','6')
			and b.pay_type='3'
			and a.wms_inve_transa_id=c.wms_inve_transa_id
			and c.wms_inve_pruduct_category_id not in (${reject_proid})
			and b.enable_flag='1' 
			and a.date_of_payment>=#{sta_begin_date}
			and #{sta_end_date}>a.date_of_payment
			and a.bel_center_manager_id is null
			group by a.bel_vice_general_manager_id,a.bel_vice_general_manager_dept_id
		) b on a.personnel_id = b.bel_vice_general_manager_id and a.dept_id=b.bel_vice_general_manager_dept_id
		set a.team_reinve_mon=b.reinve_mon
		where a.statics_personnel_id=#{statics_personnel_id}
	</update>
	<insert id="insertTeamDeptStockData_noManagerId_daySta" parameterType="map">
		insert into wms_personnel_achievement_daysta
		(
			statics_personnel_id,
			company_id,
			company_name,
			dept_id,
			dept_name,
			team_stock_all,
			team_stock_all_deal,
			team_stock_new,
			team_stock_new_deal,
			is_team_handler
		)
		
		SELECT
							#{statics_personnel_id},
							getParentDeptIdByDeptId(a.bel_department_manager_dept_id),
							getParenetDeptNameByDeptId(a.bel_department_manager_dept_id),
							a.bel_department_manager_dept_id,
							(select x.dept_name from sys_dept x where x.dept_id=a.bel_department_manager_dept_id ),
							sum(ifnull(w.product_account, 0)) as allpro_stock,
							sum(ifnull(w.product_account*w.product_deadline/12, 0)) as allpro_stock_deal,
							sum(if(ifnull(a.old_date_of_payment,a.date_of_payment)>=#{limit_date} and w.wms_inve_pruduct_category_id in (${new_pros}),w.product_account,0)) as newpro_stock,
							sum(if(ifnull(a.old_date_of_payment,a.date_of_payment)>=#{limit_date} and w.wms_inve_pruduct_category_id in (${new_pros}),w.product_account*w.product_deadline/12,0)) as newpro_stock_deal,
							'1'
						FROM
							wms_inve_transa a,
							wms_inve_transa_prod w
							
						WHERE
							a.data_status = '4'
							and exists (select 1 from wms_inve_transa_protocol c where c.wms_inve_transa_id=a.wms_inve_transa_id and c.end_of_date>=DATE_SUB(#{sta_end_date},INTERVAL 1 DAY) LIMIT 1) 
							and #{sta_end_date}>a.date_of_payment
							and a.wms_inve_transa_id=w.wms_inve_transa_id
							and w.wms_inve_pruduct_category_id not in (${reject_proid})
							and a.bel_department_manager_id is null
							and a.bel_department_manager_dept_id is not null
							and not exists (select 1 from wms_inve_customer_remove_his x where x.wms_inve_customer_id=a.wms_inve_customer_id
										and x.end_of_date>ifnull(a.old_date_of_payment,a.date_of_payment)
										and x.data_type='1'
										and x.change_date&lt;=(select t1.job_date from wms_inve_job_time t1 where t1.job_month=#{statics_month} and t1.job_type='1')
									)
							group by a.bel_department_manager_dept_id
	</insert>
</mapper> 
