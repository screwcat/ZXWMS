<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>贷款申请</title>
<link href="../../css/app.css" type="text/css" rel="stylesheet" />
<link href="../../css/zx-all.css" rel="stylesheet" type="text/css" />
<script src="../../js/zx-all.js" type="text/javascript"></script>
<style type="text/css">
.textright{
text-align:right;
}
.textleft{
text-align:left;
}
/*input_tb css*/
.input_tb_new{
/*border:1px solid #dfdfdf;*/
width:100%;
margin-bottom:10px;
}
.input_tb_new a{
color:#056aff;
text-decoration:none;
font-weight:normal;
}
.input_tb_new td{
height:35px;
line-height:25px;
/*border-bottom:1px dashed #d5d5d5;*/
padding-top:3px;
}
.input_tb_new .tr_title td{
background-color:#f5f8ff;
padding-left:16px;
font-weight:bold;
height:30px;
line-height:30px;
/*border-bottom:1px solid #dfdfdf;*/
}
.input_tb_new .tr_last td{
border-bottom:0;
}
.input_tb_new .title{
text-align:right;
}
.input_tb_new .subtitle{
text-align:left;
background-color:#d2e1fd;
border-top:1px solid #fff;
/*border-left:1px solid #fff;*/
}

.input_tb_new .tr_btn_input td{
background-color:#fbfbfb;
/*border-top:1px solid #dbdbdb;*/
/*height:40px;*/

}

.title_tb{
background-color:#f5f8ff;
padding-left:16px;
font-weight:bold;
height:30px;
line-height:30px;
/*border:1px solid #dfdfdf;8/
border-bottom:0;
}
.title_tb .title_txt{
float:left;
}
.title_tb .title_btn{
float:right;
margin-top:2px;
font-weight:normal;
}
.input_tb_new td {
    /*border-bottom: 1px dashed #D5D5D5;*/
    height: 35px;
    line-height: 25px;
    padding-top: 3px;
}

.data_tb td{
height:30px;
line-height:24px;
padding-left:10px;
border-bottom:1px dashed #e3e4e6;
text-align:left;
}
</style>

<script type="text/javascript">
	var grid, toolbar, params, dialog, columns;
	var checkedCustomerAll;
	var griddata = {};
	var modifyJsonCus = new Array(); //modifyCreCustorm.html 客户信息修改页面 json数据  用于保存页面修改前修改后的数据。
	var nwid;//添加客户后生成的主键
	var enabledEditFlag=true;
	var isCommit = false;//是否已经按过了提交按钮
	var isZanCun = false;//是否已经按过了暂存按钮
	var scrollFinish=false;
	griddata.Rows = [];
	var wms_cre_credit_head_id;//贷款信息的主表id
	var fileArr = [];//上传附件列表
	var linkManPhone=[];//联系人电话
	$(function() {	
	
		//globalUtil.clearLigerWhenScroll('waicengdiv');
		/*
		$('#waicengdiv').scroll(function(){ 
			clearLigerTip("dkinfo");
			globalUtil.clearAllCombo();
		});*/
		//------------------------------------------------获取贷款主表id进行数据的显示------------------------------------
		wms_cre_credit_head_id=$.query.get('wms_cre_credit_head_id');
		nwid=$.query.get('nwid');
		if(wms_cre_credit_head_id){
			enabledEditFlag=false;
			document.getElementById("tjbtn").style.display='none';
			document.getElementById("zcbtn").style.display='none';
			initGrid();
			addLinkTab();
			init_LinkManTab();
			var url =globalUtil.getTimestampUrl('/cremanage/wmscrecreditheadinfobypk.do');
			$.getJSON(
				url,
				{'wms_cre_credit_head_id':wms_cre_credit_head_id},
				function (json){
					setCreditVal(json);//设置显示信息的方法
					search();
					init_cre_loan_type(json);//加载信用贷款产品类型
					init_enter_file_way(json);//进件方式
					init_payroll_payment_way(json);//发薪方式
					init_profession_type(json);//职业类型
					init_reference_type(json);//类型
					//当获取贷款表id的时候，说明是查看，这时候只要显示上传的附件内容即可。
					init_attr();//获取表单上传附件内容
			 		init_arr();//获取面签上传附件信息内容
					lookpage();
				});
			 $("#plswpic").html("<a href='javascript:void(0)' onclick=showAllPic()>批量查看图片</a>");
		}else{
			addLinkTab();
			//只有进行申请贷款的时候，才可以显示初始化附件上传界面
			initGrid();
			var toolbarItemData = [];
			toolbarItemData.push({
				text : '选择贷款客户',
				click: searchCustomer,
				icon : 'chooseLcus'
			});
			toolbarItemData.push({
				line : true
			});
			toolbarItemData.push({
				text : '修改',
				click: modify,
				icon : 'modify'
			});
			toolbarItemData.push({
				line : true
			});
			toolbarItemData.push({
				text : '删除',
				click: deleteSelectedRow,
				icon : 'delete'
			});
			toolbarItemData.push({
				line : true
			});
			$("#centertoolbar").ligerToolBar({
				items : toolbarItemData
			});
			
			init_cre_loan_type();//加载信用贷款产品类型
			init_enter_file_way();//初始化进件方式
			init_payroll_payment_way();//初始化发薪方式
			init_profession_type();//职业类型
			init_reference_type();//初始化类型
			init_att();//初始化附件上传页面
			document.getElementById("cancelBtnId").style.display='none';
		}
		//判断是否循环贷
		$('#is_cycles').change(function(){
			if($('#is_cycles').val()!=''&&$('#is_cycles').val()=='0'){//说明不是循环贷
				$("input[name=lending_rates_execution_cycles]").attr({"disabled":"disabled"});
				$("input[name=lending_rates_execution_cycles]").val("");
				$("input[name=lending_rates_execution_cycles]").removeAttr("isRequired");
			}else if($('#is_cycles').val()!='' && $('#is_cycles').val()=='1'){//说明是循环贷
				$("input[name=lending_rates_execution_cycles]").removeAttr("disabled");
				//当是循环贷的时候，为必填项校验
				$("input[name=lending_rates_execution_cycles]").attr({"isRequired":"1"});
			}
		});
		});
		
		var updateSltRow;
		var passJSONStr=new Array();
	    //修改用户信息
        var modify=function (){
    	//选择某一行的操作
        var row = grid.getSelectedRow();
    	//判断是否为空    
    	if (row == null) {
            	globalUtil.warnMsg(globalErrorMsg['100000']);//请选择一行记录进行修改
                return;
    	}
    	updateSltRow=row;
    	//可以获取改行的所有字段属性alert(row.status);//0代表暂存  1代表提交
    	if(row.status==0 || row.status==1){
    		//判断是否已经点击过修改功能
    		var url = globalUtil.getHtml("modifyCreCustorm.html?wms_cus_customer_id="+row.wms_cus_customer_id);
    		var len = modifyJsonCus.length;
    		for(var i =len-1; i>=0; i--){
    			var data = modifyJsonCus[i];
    			if(row.wms_cus_customer_id == data.wms_cus_customer_id){
    				passJSONStr=data;
    				url = globalUtil.getHtml("modifyCreCustorm.html?datajson=1");
    				break;
    			}
    		}
        	
        	dialog = $.ligerDialog.open({
		        url: url,
		        title: '修改用户信息',
		        width: 900,
		        height: globalUtil.setDialogHeight(700),
		        onHiddenOrClose: function(){
		    	},
		        isResize: false
	    	});
    	}else{
    		 globalUtil.warnMsg(globalErrorMsg['200200']);
    		 return;
    	}
    };
    
    function passJSON(){
    	return passJSONStr;
    }
    
	//修改客户信息后 更新贷款申请页显示的电话信息
	function changePhn1AndPhn2(ph1,ph2){
		var column1,column2, cellObj1,cellObj2, rowdata;
		column1 = grid.columns[4];//获得电话号码1列
		column2 = grid.columns[5];//获得电话号码2列
		cellObj1 = grid.getCellObj(updateSltRow, column1);
		cellObj2 = grid.getCellObj(updateSltRow, column2);
		grid.updateCell(cellObj1, ph1,updateSltRow);
		grid.updateCell(cellObj2, ph2,updateSltRow);
	}
	
	//修改客户信息后 更新贷款申请页显示的电话信息
    function changeIdCard(idCard,ger){
        var column,columng, cellObj,cellObjg;
        column = grid.columns[3];//获得电话号码1列
        columng = grid.columns[6];//获得电话号码1列
        cellObj = grid.getCellObj(updateSltRow, column);
        cellObjg = grid.getCellObj(updateSltRow, columng);
        grid.updateCell(cellObj,idCard,updateSltRow);
        grid.updateCell(cellObjg,ger,updateSltRow);
    }
	
	function addLinkTab(){
		 tab.initTabSub("allLinkManDiv", 400,-1);
		 tab.tabObj.removeAll();
		 /*
		 $("#allLinkManDiv").ligerTab({
			 onAfterSelectTabItem:function(TabID){
				 $("li[tabid=" + TabID + "]",  $("#allLinkManDiv").ligerGetTabManager().tab.links.ul).attr("class","l-selected");
			 }
		 });
		 */
	}
	 //信用贷款产品类型
	function init_cre_loan_type(json){
		var cre_loan_type_params ={
				dest_url:'/sysmanage/wmssysdictdatabydictidempty.do?isEmpty=true&wms_sys_dict_id=26 ',
				t_col_name:'cre_loan_type',
				valueField:'wms_sys_dict_data_id',   //下拉框value对应的值，默认为id
				textField:'value_meaning',    //下拉框text对应的值，默认为text
				def_val:'first'
				};
		global_ligerui_extend.initCombox("cre_loan_type",null,cre_loan_type_params);
		if(json){
			//把值装载设定
			global_ligerui_extend.syncRequestInitComboxData(json,"cre_loan_type");
			//让其不可编辑
			global_ligerui_extend.disabledCombox("cre_loan_type");
		}else{			
		    global_ligerui_extend.initComboxDefVal("cre_loan_type");
		}
	}
	
	
	/*
	   初始化进件方式
	*/
	function init_enter_file_way(json){
		var enter_file_way_params ={
				dest_url:'/sysmanage/wmssysdictdatabydictid.do?isEmpty=true&wms_sys_dict_id=2',
				t_col_name:'enter_file_way',
				valueField:'wms_sys_dict_data_id',   //下拉框value对应的值，默认为id
				textField:'value_meaning',    //下拉框text对应的值，默认为text
				def_val:'first'
				};
		global_ligerui_extend.initCombox("enter_file_way",null,enter_file_way_params);
		if(json){
			//把值装载设定
			global_ligerui_extend.syncRequestInitComboxData(json,"enter_file_way");
			//让其不可编辑
			global_ligerui_extend.disabledCombox("enter_file_way");
		}else{			
		    global_ligerui_extend.initComboxDefVal("enter_file_way");
		}
	}
	/*
	 初始化发薪方式
	*/
	function init_payroll_payment_way(json){
		var payroll_payment_way_params ={
				dest_url:'/sysmanage/wmssysdictdatabydictid.do?isEmpty=true&wms_sys_dict_id=3',
				t_col_name:'payroll_payment_way',
				valueField:'wms_sys_dict_data_id',   //下拉框value对应的值，默认为id
				textField:'value_meaning',    //下拉框text对应的值，默认为text
				def_val:'first'
				};
		global_ligerui_extend.initCombox("payroll_payment_way",null,payroll_payment_way_params);
		if(json){
			//把值装载设定
			global_ligerui_extend.syncRequestInitComboxData(json,"payroll_payment_way");
			//让其不可编辑
			global_ligerui_extend.disabledCombox("payroll_payment_way");
		}else{
			global_ligerui_extend.initComboxDefVal("payroll_payment_way");
		}
	}
	/*
	 初始化职业类型
	*/
	function init_profession_type(json){
		var profession_type_params ={
				dest_url:'/sysmanage/wmssysdictdatabydictid.do?isEmpty=true&wms_sys_dict_id=17',
				t_col_name:'profession_type',
				valueField:'wms_sys_dict_data_id',   //下拉框value对应的值，默认为id
				textField:'value_meaning',    //下拉框text对应的值，默认为text
				def_val:'first'
				};
		global_ligerui_extend.initCombox("profession_type",null,profession_type_params);
		if(json){
			//把值装载设定
			global_ligerui_extend.syncRequestInitComboxData(json,"profession_type");
			//让其不可编辑
			global_ligerui_extend.disabledCombox("profession_type");
		}else{
			global_ligerui_extend.initComboxDefVal("profession_type");
		}
	}
	/*
	初始化类型
	*/
	function init_reference_type(json){
		var reference_type_params ={
				dest_url:'/sysmanage/wmssysdictdatabydictid.do?isEmpty=true&wms_sys_dict_id=1',
				t_col_name:'reference_type',
				valueField:'wms_sys_dict_data_id',   //下拉框value对应的值，默认为id
				textField:'value_meaning',    //下拉框text对应的值，默认为text
				def_val:'first'
				};
		global_ligerui_extend.initCombox("reference_type",null,reference_type_params);
		if(json){
			global_ligerui_extend.syncRequestInitComboxData(json,"reference_type");
			global_ligerui_extend.disabledCombox("reference_type");
		}else{
			global_ligerui_extend.initComboxDefVal("reference_type");
		}
	}
	/*
	 初始化附件信息
	*/
	function init_att(){
		$.getJSON(globalUtil.getTimestampUrl('/sysmanage/getdictdatatreebean.do?p_wms_sys_dict_id=4&wms_sys_dict_id=5'),
				{},
				function(att_json) {
					for(var i=0;i<att_json.length;i++){
						var data = att_json[i]
						var children = data.children;
						var row = document.getElementById("att_tb").insertRow(document.getElementById("att_tb").rows.length);
						var td1 = row.insertCell(0);
						td1.rowSpan = children.length;
						td1.className = 'title textright';
						td1.style.width = '100px';
						td1.innerHTML = data.text;
						var data0 = children[0];
						
						var td2 = row.insertCell(1);
						td2.className = 'textleft';
						td2.style.width = '100px';
						td2.innerHTML = data0.text;
						
						var td3 = row.insertCell(2);
						td3.className = 'textleft';
						td3.style.width = '30px';
						td3.innerHTML = '<input class="btn-uploadF" onmouseover="this.className=\'btn-uploadF-over\'" onmouseout="this.className=\'btn-uploadF\'" onmousedown="this.className=\'btn-uploadF-down\'" type="button" style="margin-right:7px;" onclick="openAddAttDialog('+data.id+','+data0.id+')" style="display:none"/>';
						//td3.innerHTML = '<a href="#" onclick="openAddAttDialog('+data.id+','+data0.id+')" class="btn" style="display:" style="display:none">上传附件</a>';
						
						var td4 = row.insertCell(3);
						td4.className = 'textleft';
						td4.id = data0.id;
						td4.pid = data.id;
						
						for(var j = 1;j < children.length;j++){
							var row_t = document.getElementById("att_tb").insertRow(document.getElementById("att_tb").rows.length);
							var td1_t = row_t.insertCell(0);
							td1_t.className = 'textleft';
							td1_t.style.width = '100px';
							td1_t.innerHTML = children[j].text;
							
							var td3_t = row_t.insertCell(1);
							td3_t.className = 'textleft';
							td3_t.style.width = '30px';
							td3_t.innerHTML = '<input class="btn-uploadF" onmouseover="this.className=\'btn-uploadF-over\'" onmouseout="this.className=\'btn-uploadF\'" onmousedown="this.className=\'btn-uploadF-down\'" type="button" style="margin-right:7px;" onclick="openAddAttDialog('+data.id+','+children[j].id+')" style="display:none"/>';
							//td3_t.innerHTML = '<a href="#" onclick="openAddAttDialog('+data.id+','+children[j].id+')" class="btn" style="display:">上传附件</a>';
							
							var td4_t = row_t.insertCell(2);
							td4_t.className = 'textleft';
							td4_t.id = children[j].id;
							td4_t.pid = data.id;
						}
					}
				});
	}
	//获取上传附件内容，并且只能查看功能
	function init_attr(){
		$.getJSON(globalUtil.getTimestampUrl('/sysmanage/getdictdatatreebean.do?p_wms_sys_dict_id=4&wms_sys_dict_id=5'),
				{},
				function(att_json) {
						$.getJSON(
						    	globalUtil.getTimestampUrl('/cremanage/wmscrecreditlinecustomerdataattachmentwithoutpaginglist.do?sortName=wms_cre_credit_line_customer_data_attachment_id'),
						    	{'wms_cre_credit_head_id':wms_cre_credit_head_id},
						    	function (json){
					               for(var i=0;i<att_json.length;i++){
					            		var data = att_json[i]
										var children = data.children;
										var row = document.getElementById("att_tb").insertRow(document.getElementById("att_tb").rows.length);
										var td1 = row.insertCell(0);
										td1.rowSpan = children.length;
										td1.className = 'title textright';
										td1.style.width = '100px';
										td1.innerHTML = data.text+":";
										var data0 = children[0];
										
										var td2 = row.insertCell(1);
										td2.className = 'textleft';
										td2.style.width = '100px';
										td2.innerHTML = data0.text+":";
										
										var td3 = row.insertCell(2);
										td3.className = 'textleft';
										td3.style.width = '30px';
										td3.innerHTML = '';
										
										var td4 = row.insertCell(3);
										td4.className = 'textleft';
										td4.id = data0.id;
										td4.pid = data.id;
										td4.innerHTML=getdictAtt(data0.id,json.Rows);
										
										for(var j = 1;j < children.length;j++){
											var row_t = document.getElementById("att_tb").insertRow(document.getElementById("att_tb").rows.length);
											var td1_t = row_t.insertCell(0);
											td1_t.className = 'textleft';
											td1_t.style.width = '100px';
											td1_t.innerHTML = children[j].text+':';
											
											var td3_t = row_t.insertCell(1);
											td3_t.className = 'textleft';
											td3_t.style.width = '30px';
											td3_t.innerHTML = ''
											
											var td4_t = row_t.insertCell(2);
											td4_t.className = 'textleft';
											td4_t.id = children[j].id;
											td4_t.pid = data.id;
											td4_t.innerHTML=getdictAtt(children[j].id,json.Rows);
										}
									}
						    	}
						    );
				});
				
	}
	//获取面签上传附件信息
	function init_arr(){
		//获取面签上传附件信息
		$.getJSON(globalUtil.getTimestampUrl('/cremanage/wmscrecreditattinfobyfk.do'),
				{
					'wms_cre_credit_head_id':wms_cre_credit_head_id,
					'data_type':'5'
				},
				function(jsonarr){
					$("#mqfjpic").html(getdictAttr(jsonarr));
				});
	}
	
	var allFaceSignPicIDs=[];//面签所有附件
	function getdictAttr(jsonarr){
		var htmlstr = "";
		for(var i = 0 ;i < jsonarr.length; i++){
				var data = jsonarr[i];
				if(findPicHZ(data.attachment_type.toLowerCase())==-1){
					htmlstr += '<a  target="_blank"  href="'+global_param.upload_file_url+data.attachment_address+'">'+data.attachment_old_name+'</a>&nbsp;&nbsp;&nbsp;'
				}else{
					//htmlstr += '<input type="checkbox" id=cb'+data.wms_cre_housing_att_id+' class="radio3" onclick=onCheckCB('+data.wms_cre_housing_att_id+') style="width: auto"/>&nbsp;&nbsp;<a  target="_blank"  href="'+global_param.upload_file_url+data.attachment_address+'">'+data.attachment_old_name+'</a>&nbsp;&nbsp;&nbsp;'
					htmlstr += '&diams;<a  target="_blank"  href="'+global_param.upload_file_url+data.attachment_address+'">'+data.attachment_old_name+'</a>&nbsp;&nbsp;&diams;'
				}
				allFaceSignPicIDs.push(data.wms_cre_housing_att_id);
		}
		return htmlstr;
	}
	var allCreditPicIDs=[];//所有图片Id 从上至下
	//读取上传文件显示上传文件名称
	function getdictAtt(code,json){
		var htmlstr = "";
		for(var i = 0 ;i < json.length; i++){
			var data = json[i];
			var data_detail_name = data.data_detail_name;
			if(code == data.data_detail_name){
				if(findPicHZ(data.attachment_type.toLowerCase())==-1){
					htmlstr += '<a  target="_blank"  href="'+global_param.upload_file_url+data.attachment_address+'">'+data.attachment_old_name+'</a>&nbsp;&nbsp;&nbsp;'
				}else{
					htmlstr += '<input type="checkbox" id=cb'+data.wms_cre_credit_line_customer_data_attachment_id+' class="radio3" onclick=onCheckCB('+data.wms_cre_credit_line_customer_data_attachment_id+') style="width: auto"/>&nbsp;&nbsp;<a  target="_blank"  href="'+global_param.upload_file_url+data.attachment_address+'">'+data.attachment_old_name+'</a>&nbsp;&nbsp;&nbsp;'
				}
				allCreditPicIDs.push(data.wms_cre_credit_line_customer_data_attachment_id);
			}
		}
		return htmlstr;
	}
	
	var checkedCreditIDs=[];
	function onCheckCB(id){
		if($("#cb"+id).is(':checked')){
			addCheckedCredit(id)
		}else{
			removeCheckedCredit(id)
		}
	}
	
	 // 向checkedCredit中添加id的方法
    function addCheckedCredit(id) {
    	if (findCheckedCredit(id) == -1) {
    		checkedCreditIDs.push(id);
    	}
    };
    // 从checkedCredit中移除id的方法
    function removeCheckedCredit(id) {
    	var i  = findCheckedCredit(id);
    	if (i == -1) {
    		return;
    	}
    	checkedCreditIDs.splice(i, 1);
    };
    
    // 在checkedCredit中查找是否已存在id的方法
    function findCheckedCredit(id) {
    	for(var i = 0; i < checkedCreditIDs.length; i++) {
    		if(checkedCreditIDs[i] == id) {
    			return i;
    		}
    	}
    	return -1;
    };
    
    var checkedPicNms=['jpg','jpeg','bmp','png','gif','tif'];
    //检查是否为图片格式
    function findPicHZ(name) {
    	for(var i = 0; i < checkedPicNms.length; i++) {
    		if(checkedPicNms[i] == name) {
    			return i;
    		}
    	}
    	return -1;
    };
	
    function showAllPic(){
    	if(checkedCreditIDs.length==0){
    		globalUtil.errorMsg(globalErrorMsg['300108']);
    		return;
    	}
    	var allCheckedCreditPicIDs=[];
    	for (var picIds = 0; picIds < allCreditPicIDs.length; picIds++) {
			for (var picIdsChed = 0; picIdsChed < checkedCreditIDs.length; picIdsChed++) {
				if(allCreditPicIDs[picIds]==checkedCreditIDs[picIdsChed]){
					allCheckedCreditPicIDs.push(allCreditPicIDs[picIds]);
					break;
				}
			}
		}
    	var iTop=(window.screen.availHeight-30-700)/2
    	var iLeft=(window.screen.availWidth-10-1020)/2
    	window.open("../creditManage/showUpldPic.html?idsArr="+allCheckedCreditPicIDs, "查看图片",'height=700,innerHeight=700,width=1020,innerWidth=1000,top='+iTop+',left='+iLeft+',toolbar=no,menubar=no,resizeable=yes,location=no,status=no,fullscreen=no,scrollbars=yes')
    }
	var dialog_att;
	/*
	打开附件上传页面
	*/
	function openAddAttDialog(data_type_name,data_detail_name){
		var url = globalUtil.getHtml("addFileForCre.html?data_type_name="+data_type_name+"&data_detail_name="+data_detail_name);
		dialog_att = $.ligerDialog.open({
	        url: url,
	        title: '上传附件',
	        width: 650,
	        height: globalUtil.setDialogHeight(250),
	        onHiddenOrClose: function(){
	        	//alert('关闭或隐藏都调用的事件!');
	    	},
	        isResize: false
		});
	}
	
	function addAttFile(newfileArr,objid){
		fileArr = fileArr.concat(newfileArr);
		var filehtml = $("#"+objid).html();
		for(var i=0;i<newfileArr.length;i++){
			var nnme=newfileArr[i].attachment_new_name.replace('/','thxg1');
			nnme=nnme.replace('/','thxg2');
			filehtml += '<div id="delUploadDivId'+nnme+'">';
			filehtml += '<a  target="_blank"  href="'+global_param.upload_file_url+newfileArr[i].attachment_address+'">'+newfileArr[i].attachment_old_name+'</a>';
			filehtml += '<img src="../../images/icon/icon-close.gif" onclick="deleteFile(\''+nnme+'\')"/>';
			filehtml += '</div>'
		}
		$("#"+objid).html(filehtml);
	}
	
    function deleteFile(filename){
       	$.ligerDialog.confirm(globalErrorMsg['100016'],
        function(yes) {
        	if (yes) {
        		$("#delUploadDivId"+filename).remove();
        		filename=filename.replace('thxg1','/');
        		filename=filename.replace('thxg2','/');
        		for(var i=0;i<fileArr.length;i++){
        			if(filename == fileArr[i].attachment_new_name){
        				fileArr.splice(i,1);
        				break;
        			}
        		}
	    	}                                            
   		});
    }
    var ismjArr=[{"is_major":'1',"ismjval":"是"},{"is_major":'0',"ismjval":"否"}];
	//表格初始化
	function initGrid() {
		columns = [ {
			display : '客户姓名',
			name : 'customer_name',
			width : 130,
			minWidth : 130,
			//添加超链接的东西
            render: function (rowdata, rowindex, value) { 
                if(rowdata.wms_cre_credit_line_customer_change_head_id){
                //实现根据变更用户主键id 获取其所有修改过后的信息
            	return '<a href="javascript:customerInfo('+rowdata.wms_cre_credit_line_customer_change_head_id+');" style="color:#056AFF;text-decoration: none;">'+value+'</a>';                	
                }else{
                return value;                	
                }
    		}
		}, {
			display: '是否主贷人',
			name: 'is_major',
			width: 100,
			 editor: { 
					type: 'select', // 该列为可编辑状态
					data: ismjArr, 
					valueField: 'is_major', 
					textField: 'ismjval', 
					onChanged:ismajchged,
					ext:{
						onChangeValue: function(value){ // 单元格内容发生变化时的触发事件
							
						}
					}   
				},
			render: function (rowdata, nowRowIndex, value, column) {
					return global_ligerui_extend.gridRenderSelectedValue(rowdata, nowRowIndex, value, column);
			}
		}, {
			display : '身份证号',
			name : 'id_card',
			width : 170,
			minWidth : 170,
		}, {
            display: '电话号码1',
            name: 'mobile_telephone1',
            width: 130,
            minWidth: 130
        },{
            display: '电话号码2',
            name: 'mobile_telephone2',
            width: 130,
            minWidth: 130
        }, {
			display : '性别',
			name : 'gender',
			width : 50,
			minWidth : 50,
			render: function (rowdata,rowindex,value) { // 数据处理方法，不需处理时可去除
				if(value == 1){
					value = "男";
				}else if(value == 0){
					value = "女";
				}
				return value;
			}
		}, {
			display : '录入时间',
			name : 'create_timestamp',
			width : 160,
			minWidth : 160
		} ];

		if(nwid){
			
			var custData = globalUtil.syncGetJson('/cusmanage/wmscuscustomerheadinfovomapbypk.do',{
				'wms_cus_customer_id': nwid // 
                },'GET');
			var ctdtArr=[];
			custData.onCus.is_major='1';
			ctdtArr.push(custData.onCus);
			ctdtArr[0].create_timestamp=(new Date(ctdtArr[0].create_timestamp)).format('yyyy-MM-dd hh:mm:ss')
			var ctdtJH={};
			ctdtJH.Rows=ctdtArr
			grid = $("#grid").ligerGrid({
				data:ctdtJH,
				columns : columns,
				sortOrder:'asc', // 排序方式
				rownumbers : true,
				allowUnSelectRow : true,
				enabledEdit: enabledEditFlag,
				usePager : false,
				width : '100%',
				height : 160,
				heightDiff : -4,
				parms : {
					_filterParms : -1
				}
			});
			var isMaShowStr="主贷人："+ctdtArr[0].customer_name;
			tab.addSubTab(isMaShowStr, 'creditLinkMan.html', ctdtArr[0].wms_cus_customer_id+'linktab', true);
		}else {
			grid = $("#grid").ligerGrid({
				url:global_param.context_name+'/cremanage/wmscrecreditlinecustomerchangeheadwithoutpaginglist.do?wms_cre_credit_head_id='+wms_cre_credit_head_id,
				columns : columns,
				sortOrder:'asc', // 排序方式
				rownumbers : true,
				allowUnSelectRow : true,
				enabledEdit: enabledEditFlag,
				usePager : false,
				width : '100%',
				height : 160,
				heightDiff : -4,
				parms : {
					_filterParms : -1
				}
			});
		}
	}
	
	//是否是主贷人改变后  ry
	//改变主贷人为是时，其他用户的主贷人变为否
	var ismajchged=function(dom,val){
		if(val=="1"){
			var column, cellObj, rowdata;
			var ismaidold='',ismaidnew='';
			column = grid.columns[2];
			var gd=grid.getData();
			for (var i = 0; i < gd.length; i++) {
				cellObj = grid.getCellObj(grid.rows[i], column);
				if(dom!=cellObj){
					if(grid.rows[i].is_major=="1"){
						ismaidold=grid.rows[i].wms_cus_customer_id;
					}
					grid.updateCell(cellObj, '0',gd[i]);
				}else {
					ismaidnew=grid.rows[i].wms_cus_customer_id;
				}
			}
			$("li[tabid=" + ismaidold + "linktab]",  $("#allLinkManDiv").ligerGetTabManager().tab.links.ul).find("a :first").text(function(n,t){
				return t.replace("主贷人","共同贷款人");
			});
			$("li[tabid=" + ismaidnew + "linktab]",  $("#allLinkManDiv").ligerGetTabManager().tab.links.ul).find("a :first").text(function(n,t){
				return t.replace("共同贷款人","主贷人");
			});
			//改变tab位置，将主贷人移至第一个
			moveZDRTabToFirst(ismaidnew+"linktab");
		}else {
		    var tsrow = $(dom).parent();
            var tsrowdata = grid.getRow(tsrow[0]);
			$("li[tabid=" + tsrowdata.wms_cus_customer_id + "linktab]",  $("#allLinkManDiv").ligerGetTabManager().tab.links.ul).find("a :first").text(function(n,t){
				return t.replace("主贷人","共同贷款人");
			});
		}
	}
	
	//将主贷人tab移至第一个
	function moveZDRTabToFirst(zdTabID){
		var newZDRIndex=$("#allLinkManDiv").ligerGetTabManager().tab.links.ul.find(">li[tabid=" + zdTabID +"]").index();
		var lastIndex=$("#allLinkManDiv").ligerGetTabManager().tab.links.ul.find(">li").last().index();
		if(newZDRIndex!=0&&(newZDRIndex!=lastIndex)){
			for (var tabI = newZDRIndex; tabI > 0; tabI--) {
				var to=$("#allLinkManDiv").ligerGetTabManager().tab.links.ul.find(">li").last();
				var from=$("#allLinkManDiv").ligerGetTabManager().tab.links.ul.find(">li").eq(tabI-1);
				to.after(from);
			}
		}else if (newZDRIndex!=0&&(newZDRIndex==lastIndex)) {
			var from=$("#allLinkManDiv").ligerGetTabManager().tab.links.ul.find(">li").last();
			var to=$("#allLinkManDiv").ligerGetTabManager().tab.links.ul.find(">li").eq(0);
			to.before(from);
		}
	}
	
	//查看用户变更后的页面信息
	function customerInfo(wms_cre_credit_line_customer_change_head_id){
		var url = globalUtil.getHtml("checkCreCustorm.html?wms_cre_credit_line_customer_change_head_id="+wms_cre_credit_line_customer_change_head_id+"&cktype=ck");
    	dialog = $.ligerDialog.open({
	        url: url,
	        title: '客户变更信息',
	        width: 900,
	        height: globalUtil.setDialogHeight(450),
	        onHiddenOrClose: function(){
	    	},
	        isResize: false
    	});
	}
	
    function initParams() {
    	params = globalUtil.getFormParam("searchbar");
    }
    //查询
    function search() {
        initParams();
        global_ligerui_extend.search(grid, params);
    }
	//页面切换
	function changeTab(id) {
		var dkinfo = document.getElementById("dkinfo"); //个人资料tab
		var gzinfo = document.getElementById("gzinfo"); //工作信息tab
		var ckinfo = document.getElementById("ckinfo"); //房产信息tab

		if (id == 'khinfo') {
			document.getElementById("tabbody1").className = "tabbody1";
			document.getElementById("tabbody2").className = "tabbody2";
			document.getElementById("tabbody3").className = "tabbody2";
			
			document.getElementById("khinfo_div").className = "tab_step tab_step101";
			document.getElementById("gzinfo_div").className = "tab_step tab_step202";
			document.getElementById("ckinfo_div").className = "tab_step tab_step302";
			
			dkinfo.style.display = '';
			gzinfo.style.display = 'none';
			ckinfo.style.display = 'none';
			//clearLigerTip("gzinfo");//清理贷款信息LigerTip控件
			//clearLigerTip("ckinfo");//清理初审意见LigerTip控件
			if(isCommit){
				globalVali.checkForm("dkinfo",true);				
			}else if(isZanCun){
				globalVali.checkForm("dkinfo", false);
			}
		} else if (id == 'gzinfo') {
			document.getElementById("tabbody1").className = "tabbody2";
			document.getElementById("tabbody2").className = "tabbody1";
			document.getElementById("tabbody3").className = "tabbody2";
			document.getElementById("khinfo_div").className = "tab_step tab_step102";
			document.getElementById("gzinfo_div").className = "tab_step tab_step201";
			document.getElementById("ckinfo_div").className = "tab_step tab_step302";
			
			dkinfo.style.display = 'none';
			gzinfo.style.display = '';
			ckinfo.style.display = 'none';
			//clearLigerTip("dkinfo");//清理贷款信息LigerTip控件
			//clearLigerTip("ckinfo");//清理初审意见LigerTip控件
			if(isCommit){
				globalVali.checkForm("gzinfo",true);
			}else if(isZanCun){
				globalVali.checkForm("gzinfo", false);
			}
		} else if (id == 'ckinfo') {
			document.getElementById("tabbody1").className = "tabbody2";
			document.getElementById("tabbody2").className = "tabbody2";
			document.getElementById("tabbody3").className = "tabbody1";
			document.getElementById("khinfo_div").className = "tab_step tab_step102";
			document.getElementById("gzinfo_div").className = "tab_step tab_step202";
			document.getElementById("ckinfo_div").className = "tab_step tab_step301";
			dkinfo.style.display = 'none';
			gzinfo.style.display = 'none';
			ckinfo.style.display = '';
			//clearLigerTip("dkinfo");//清理贷款信息LigerTip控件
			//clearLigerTip("gzinfo");//清理初审意见LigerTip控件
			if(isCommit){
				globalVali.checkForm("ckinfo",true);
			}else if(isZanCun){
				globalVali.checkForm("ckinfo", false);
			}
		}
	};
	
	//打开选择贷款客户界面
	var scfcDialog;
	function searchCustomer(){
		clearLigerTip('dkinfo');
    	var url = globalUtil.getHtml("searchCustomerForCredit.html");
    	scfcDialog = $.ligerDialog.open({
	        url: url,
	        title: '选择贷款客户',
	        width: 1000,
	        height: globalUtil.setDialogHeight(600),
	        isResize: false
    	});
	};
	var spfcDialog;
	function searchPersonnel(){
		clearLigerTip("ckinfo");
    	var url = globalUtil.getHtml("searchPersonnelForCredit.html");
    	spfcDialog = $.ligerDialog.open({
	        url: url,
	        title: '选择业务员',
	        width: 1000,
	        height: globalUtil.setDialogHeight(600),
	        isResize: false
    	});
	};
	
	// 移除行数据，前台移除，需要选择行，无确认提示（可根据业务增加）
	function deleteSelectedRow() {
	    var row = grid.getSelectedRow();
	    if (!row) {
	        globalUtil.warnMsg(globalErrorMsg['100001']); //请选择一行记录进行删除
	        return;
	    }
	    
	    globalUtil.confirmMsg(globalErrorMsg['100016'],
	    function(yes) { //确认删除
	    	if(yes){
	    		global_ligerui_extend.deleteSelectedRow(grid); // grid-表格对象
	    		var len = modifyJsonCus.length;
        		for(var i =len-1; i>=0; i--){
        			var data = modifyJsonCus[i];
        			if(row.wms_cus_customer_id == data.wms_cus_customer_id){
        				modifyJsonCus.splice(i);
        				break;
        			}
        		}
        		removeOtherTab(row.wms_cus_customer_id+'linktab');
	    	}
	    });
	};
	
    function removeOtherTab(tabId) {
        $("#allLinkManDiv").ligerGetTabManager().removeTabItem(tabId);
    }
	
	var wmsCusCustomerId = new Array();
	
	/*
	选择客户后的回调页面
	*/
	function getCheckedCustomerAll(data){
		var data_all = grid.getData();
		var data_add = [];
		for(var j = 0;j<data.length;j++){
			var ishave = false;
			for(var i=0;i<data_all.length;i++){
	        	if(data_all[i].wms_cus_customer_id == data[j].wms_cus_customer_id){
	        		ishave = true;
	        		break;
	        	}
	        }
			if(!ishave){
				var isMaFlag=false;
				if(data_all.length==0){
					if(j==0){
						data[j]["is_major"]='1';
						isMaFlag=true;
					}else{
						data[j]["is_major"]='0';
					}
				}else {
					data[j]["is_major"]='0';
				}
				data_add.push(data[j]);
				var isMaShowStr='';
				if(isMaFlag){
					isMaShowStr="主贷人："+data[j].customer_name;
				}else{
					isMaShowStr="共同贷款人："+data[j].customer_name;
				}
				tab.addSubTab(isMaShowStr, 'creditLinkMan.html', data[j].wms_cus_customer_id+'linktab', true);
			}
		}
		global_ligerui_extend.addRows(grid, data_add);
	};
	/*
		初始化显示联系人tab页
	*/
	var tabLinkArrAll=[];
	function init_LinkManTab(){
		var data_all = globalUtil.syncGetJson('/cremanage/wmscrecreditlinecustomerchangeheadwithoutpaginglist.do',{
			'wms_cre_credit_head_id':wms_cre_credit_head_id
            },'POST');
		var link_data_all = globalUtil.syncGetJson('/cremanage/wmscrecustomerchangelinecontactwithoutpaginglist.do',{
			'wms_cre_credit_line_customer_change_head_id':wms_cre_credit_head_id,
			'sortname':'wms_cre_credit_head_id'
            },'POST');
		tabLinkArrAll=link_data_all.Rows;
		var isMajorID='';
		for(var i=0;i<data_all.Rows.length;i++){
        	var isMaShowStr='';
			if(data_all.Rows[i]["is_major"]=="1"){
				isMajorID=data_all.Rows[i]['wms_cre_credit_line_customer_change_head_id']+'linktab';
				isMaShowStr="主贷人："+data_all.Rows[i].customer_name;
			}else{
				isMaShowStr="共同贷款人："+data_all.Rows[i].customer_name;
			}
			tab.addSubTab(isMaShowStr, 'creditLinkMan.html?mcclcchid='+data_all.Rows[i]['wms_cre_credit_line_customer_change_head_id'], data_all.Rows[i]['wms_cre_credit_line_customer_change_head_id']+'linktab', true);
        }
		moveZDRTabToFirst(isMajorID);
		$("#allLinkManDiv").ligerGetTabManager().selectTabItem(isMajorID);
	};
	
	
	function forTabSJ(mcclcchid){
		var tabArrCD=[];
		for (var taIndex = 0; taIndex < tabLinkArrAll.length; taIndex++) {
			if(tabLinkArrAll[taIndex]['wms_cre_credit_line_customer_change_head_id']==mcclcchid){
				tabArrCD=tabArrCD.concat(tabLinkArrAll[taIndex]);
			}
		}
		return tabArrCD;
	}
	
	function getCheckedPersonnelAll(data){
		$("#salesman_name").attr("value",data.personnel_name+"/"+data.personnel_shortcode);
		$("#salesman_id").attr("value",data.personnel_id);
		$("#salesman_code").attr("value",data.personnel_code);
		$("#city").attr("value",data.city);
		$("#salesman_city_code").attr("value",data.personnel_regionnumber);
		$("#salesman_dept_id").attr("value",data.personnel_deptid);
	}
	function submitInfo(str){
		var jsonStr;
		var data_all = grid.getData();
		if(str == 1){
			isCommit=true;
			isZanCun = false;//设置未按过暂存按钮
			//当在贷款信息页面时，检查各表单的数据
			if($('#dkinfo').css('display')!='none'){
				globalUtil.clearLigerTip("dkinfo");
				if(globalVali.checkForm("dkinfo", true)){	
					return;				
				}else if(globalVali.checkForm("gzinfo", true)){
					globalUtil.clearLigerTip("dkinfo");
					globalUtil.clearLigerTip("gzinfo");
					$('#tabbody2').trigger('click');
					globalVali.checkForm("gzinfo", true);
					return;
				}else if(globalVali.checkForm("ckinfo", true)){
					globalUtil.clearLigerTip("dkinfo");
					globalUtil.clearLigerTip("ckinfo");
					$('#tabbody3').trigger('click');
					globalVali.checkForm("ckinfo", true);
					return;
				}
			}
			else if($('#gzinfo').css('display')!='none'){
				globalUtil.clearLigerTip("gzinfo");
				if(globalVali.checkForm("dkinfo", true)){
					globalUtil.clearLigerTip("dkinfo");
					$('#tabbody1').trigger('click');
					globalVali.checkForm("dkinfo", true);
					return;
				}else if(globalVali.checkForm("gzinfo", true)){	
					globalUtil.clearLigerTip("dkinfo");
					return;
				}else if(globalVali.checkForm("ckinfo", true)){
					globalUtil.clearLigerTip("dkinfo");
					globalUtil.clearLigerTip("ckinfo");
					$('#tabbody3').trigger('click');
					globalVali.checkForm("ckinfo", true);
					return;
				}
			}
			else if($('#ckinfo').css('display')!='none'){
				globalUtil.clearLigerTip("ckinfo");
				if(globalVali.checkForm("dkinfo", true)){
					globalUtil.clearLigerTip("dkinfo");
					$('#tabbody1').trigger('click');
					globalVali.checkForm("dkinfo", true);
					return;
				}else if(globalVali.checkForm("gzinfo", true)){
					globalUtil.clearLigerTip("dkinfo");
					globalUtil.clearLigerTip("gzinfo");
					$('#tabbody2').trigger('click');
					globalVali.checkForm("gzinfo", true);
					return;
				}else if(globalVali.checkForm("ckinfo", true)){
					globalUtil.clearLigerTip("dkinfo");
					return;
				}
			}

			globalUtil.clearLigerTip("dkinfo");
			jsonStr = globalUtil.getFormParam('main_t');
			globalUtil.getFormParam('gzinfo',jsonStr);
			globalUtil.getFormParam('ckinfo',jsonStr);
			//如果业务员选项不为空进行把值处理存储人jsonStr
			if($("#salesman_name").val()!=''){
				jsonStr.salesman_name=$("#salesman_name").val().split("/")[0];
				jsonStr.salesman_shortcode=$("#salesman_name").val().split("/")[1];
			}
			//是否是循环贷
			jsonStr.is_cycles=$('#is_cycles').val();
			//判断选择的贷款客户信息正确与否
			
			if(data_all.length==0){
				$('#tabbody1').trigger('click');
				globalUtil.errorMsg(globalErrorMsg['300104']);
				return;
			}else {
				var ismjFlag=false;
				var ismjCount=0;
				for(var i=0;i<data_all.length;i++){
					if(data_all[i]["is_major"]=='1'){
						ismjFlag=true;
						ismjCount++;
					}
				}
				if(!ismjFlag){
					$('#tabbody1').trigger('click');
					globalUtil.errorMsg(globalErrorMsg['300106']);
					return;
				}else if (ismjCount>1) {
					$('#tabbody1').trigger('click');
					globalUtil.errorMsg(globalErrorMsg['300105']);
					return;
				}
			}		
			//附件只要选择 就必须要上传附件
			getOtherVal(jsonStr);
		}else {
			//实现暂存功能
			isCommit=false;
			isZanCun = true;//设置未按过暂存按钮
			//当在贷款信息页面时，检查各表单的数据
			if($('#dkinfo').css('display')!='none'){
				globalUtil.clearLigerTip("dkinfo");
				if(globalVali.checkForm("dkinfo", false)){	
					return;				
				}else if(globalVali.checkForm("gzinfo", false)){
					globalUtil.clearLigerTip("dkinfo");
					globalUtil.clearLigerTip("gzinfo");
					$('#tabbody2').trigger('click');
					globalVali.checkForm("gzinfo", false);
					return;
				}else if(globalVali.checkForm("ckinfo", false)){
					globalUtil.clearLigerTip("dkinfo");
					globalUtil.clearLigerTip("ckinfo");
					$('#tabbody3').trigger('click');
					globalVali.checkForm("ckinfo", false);
					return;
				}
			}
			else if($('#gzinfo').css('display')!='none'){
				globalUtil.clearLigerTip("gzinfo");
				if(globalVali.checkForm("dkinfo", false)){
					globalUtil.clearLigerTip("dkinfo");
					$('#tabbody1').trigger('click');
					globalVali.checkForm("dkinfo", false);
					return;
				}else if(globalVali.checkForm("gzinfo", false)){	
					globalUtil.clearLigerTip("dkinfo");
					return;
				}else if(globalVali.checkForm("ckinfo", false)){
					globalUtil.clearLigerTip("dkinfo");
					globalUtil.clearLigerTip("ckinfo");
					$('#tabbody3').trigger('click');
					globalVali.checkForm("ckinfo", false);
					return;
				}
			}
			else if($('#ckinfo').css('display')!='none'){
				globalUtil.clearLigerTip("ckinfo");
				if(globalVali.checkForm("dkinfo", false)){
					globalUtil.clearLigerTip("dkinfo");
					$('#tabbody1').trigger('click');
					globalVali.checkForm("dkinfo", false);
					return;
				}else if(globalVali.checkForm("gzinfo", false)){
					globalUtil.clearLigerTip("dkinfo");
					globalUtil.clearLigerTip("gzinfo");
					$('#tabbody2').trigger('click');
					globalVali.checkForm("gzinfo", false);
					return;
				}else if(globalVali.checkForm("ckinfo", false)){
					globalUtil.clearLigerTip("dkinfo");
					return;
				}
			}
			
			globalUtil.clearLigerTip("dkinfo");
			jsonStr = globalUtil.getFormParam('main_t',null,false);
			globalUtil.getFormParam('gzinfo',jsonStr,false);
			globalUtil.getFormParam('ckinfo',jsonStr,false);
			//如果业务员选项不为空进行把值处理存储人jsonStr
			if($("#salesman_name").val()!=''){
				jsonStr.salesman_name=$("#salesman_name").val().split("/")[0];
				jsonStr.salesman_shortcode=$("#salesman_name").val().split("/")[1];
			}
			//是否是循环贷
			jsonStr.is_cycles=$('#is_cycles').val();
			//判断选择的贷款客户信息正确与否
			
			var ismjFlag=false;
			var ismjCount=0;
			for(var i=0;i<data_all.length;i++){
				if(data_all[i]["is_major"]=='1'){
					ismjFlag=true;
					ismjCount++;
				}
			}
			if (ismjCount>1) {
				$('#tabbody1').trigger('click');
				globalUtil.errorMsg(globalErrorMsg['300105']);
				return;
			}
			//附件只要选择 就必须要上传附件
			getOtherVal(jsonStr);
		}
		//取消检查共贷人亲属、朋友是否重复的校验，改为由业务员线下控制。
		/*var qspyFlag=checkQSAndPY(str);
		if(typeof(qspyFlag) == "string"){
			globalUtil.errorMsg(qspyFlag);
			return;
		}*/
		var linkManAllInfoArr=[];
		for(var gind=0;gind<data_all.length;gind++){
			var mccidone=data_all[gind]['wms_cus_customer_id'];
			var tabWindow=document.getElementById(mccidone+'linktab').contentWindow;
			var tabArr=tabWindow.getlinkmaninfo(mccidone,data_all[gind]['customer_name'],data_all[gind]['is_major'],str);
			if(typeof(tabArr) == "object"){
				linkManAllInfoArr=linkManAllInfoArr.concat(tabArr);
			}else if(typeof(tabArr) == "string"){
				if(tabArr == "phonewrong"){
					globalUtil.errorMsg("客户："+data_all[gind]['customer_name']+" 的联系人电话有错误，请修改！");
				}else if (tabArr == "dhcf") {
					globalUtil.errorMsg("客户："+data_all[gind]['customer_name']+" 的联系人电话有重复，请修改！");
				}
				$("#allLinkManDiv").ligerGetTabManager().selectTabItem (mccidone+'linktab');
				$('#tabbody1').trigger('click');
				return;
			}else if(typeof(tabArr) == 'boolean'){
				globalUtil.errorMsg("客户："+data_all[gind]['customer_name']+" 的联系人信息不完整，请补全！");
				$("#allLinkManDiv").ligerGetTabManager().selectTabItem (mccidone+'linktab');
				$('#tabbody1').trigger('click');
				return;
			}
		}
		jsonStr.linkmaninfo = JSON.stringify(linkManAllInfoArr);//联系人信息
		jsonStr.fileArr = JSON.stringify(fileArr);//附件
		jsonStr.personArr = getPersonInfo();//贷款人
		jsonStr.modifyJsonCus = JSON.stringify(modifyJsonCus);//修改后客户信息的数据
		jsonStr.isComOrZC=str;
		//判断联系人电话与
		//var phoneGridArr=[];
		//var phoneGrid=grid.getData();
		//for (var pi = 0; pi < phoneGrid.length; pi++) {
			//phoneGridArr.push(phoneGrid[pi].mobile_telephone1);
			//phoneGridArr.push(phoneGrid[pi].mobile_telephone2)
		//}
		//var phoneSameFlag=false;
		//for (var pi1 = 0; pi1 < phoneGridArr.length; pi1++) {
			//if(phoneSameFlag){
				//break;
			//}
			//for (var pi2 = 0; pi2 < linkManPhone.length; pi2++) {
				//if(phoneGridArr[pi1]==linkManPhone[pi2]){
					//phoneSameFlag=true;
					//break;
				//}
			//}
		//}
		//if(phoneSameFlag){
			//globalUtil.errorMsg(globalErrorMsg['300114']);
			//changeTab('khinfo')
			//return;
		//}
		
		//var showSSSS='';
		//for(var p in jsonStr){
			//showSSSS+=p+"   :    "+jsonStr[p]+"<br>";
		//}
		//$("#allLinkManDiv").html(showSSSS)
		
		//return;
		
		$("#tb_btn").css("display","none");//隐藏按钮 
		$.post(globalUtil.getTimestampUrl("/cremanage/wmscrecreditheadsave.do"),
				jsonStr, function(data) {
					if (data === 'OK') {
						globalUtil.successMsg(globalErrorMsg['100002'],//保存成功
								function() {
									//刷新页面location.reload(true);
									window.location.href=global_param.context_name+"/resources/html/creditManage/addCredit.html";
								});
					}else if(data === 'temOK'){//暂存成功!提示:在贷款查询中查询并且进行单据修改操作!
						globalUtil.successMsg(globalErrorMsg['100007'],
								function() {
									//刷新页面location.reload(true);
									window.location.href=global_param.context_name+"/resources/html/creditManage/addCredit.html";
								});
					}else {
						globalUtil.errorMsg(globalErrorMsg['100012']); //保存失败
						$("#tb_btn").css("display","");//显示按钮 
					}
				});
				
	};
	
	//检查主贷人和共贷人亲属、朋友重复性
	function checkQSAndPY(str){
		if(str==0){
			return true;
		}
		var data_all = grid.getData();
		var majorArr=[];
		var otherArr=[];
		for(var gind=0;gind<data_all.length;gind++){
			var mccidone=data_all[gind]['wms_cus_customer_id'];
			var tabWindow=document.getElementById(mccidone+'linktab').contentWindow;
			var tabArr=tabWindow.getlinkmaninfo(mccidone,data_all[gind]['customer_name'],data_all[gind]['is_major'],str);
			if(typeof(tabArr) == "object"){
				if(data_all[gind]['is_major']==1){
					majorArr=tabArr;
				}else {
					otherArr.push(tabArr);
				}
			}else {
				return false;
			}
		}
		
		for (var j = 0; j < otherArr.length; j++) {
			var qri=0;//亲人
			var pyi=0;//朋友
			for (var k = 0; k < otherArr[j].length; k++) {
				for (var i = 0; i < majorArr.length; i++) {
					if(majorArr[i].contact_relation_type=='亲属'&&otherArr[j][k].contact_relation_type=='亲属'){
						if(majorArr[i].contact_mobile_phone==otherArr[j][k].contact_mobile_phone){
							qri++;
						}
					}else if (majorArr[i].contact_relation_type=='同事(朋友)'&&otherArr[j][k].contact_relation_type=='同事(朋友)') {
						if(majorArr[i].contact_mobile_phone==otherArr[j][k].contact_mobile_phone){
							pyi++;
						}
					}
				}
			}
			if(qri>1){
				var reStr="主贷人：'"+majorArr[0].customer_name+"' 与 共贷人：'"+otherArr[j][0].customer_name+"' 的亲属最多可以有1人相同！";
				return reStr;
			}
			if(pyi>2){
				var reStr="主贷人：'"+majorArr[0].customer_name+"' 与 共贷人：'"+otherArr[j][0].customer_name+"' 的同事(朋友)最多可以有2人相同！";
				return reStr;
			}
		}
		return true;
	}
	
	//获取贷款客户id列表
	function getPersonInfo(){
		var data_all = grid.getData();
		var data = [];
		for(var i=0;i<data_all.length;i++){
			data.push(data_all[i].wms_cus_customer_id+"@@@"+data_all[i].is_major)
        }
		return data.join();
	}

	function getOtherVal(json){
		json.is_complete = $("input[name='is_complete']:checked").val();
		json.is_other_corporation_done = $("input[name='is_other_corporation_done']:checked").val();
		json.is_to_public_stream = $("input[name='is_to_public_stream']:checked").val();
		json.is_house_certificate_original = $("input[name='is_house_certificate_original']:checked").val();
		json.is_check = $("input[name='is_check']:checked").val();
	}
   
	//实现查看单个表单信息的方法
	function setCreditVal(json){
		//------------------------贷款信息-----------------------------------
 		//借款用途
		$('#credit_purpose').val(json.credit_purpose);
 		//可接收每月最高还款额
		$('#max_repayment_limit_per_month').val(json.max_repayment_limit_per_month);
 		//申请贷款额度
 		$('#credit_limit').val(json.credit_limit);
 		//申请最长还款期限
 		$('#max_repayment_time_limit').val(json.max_repayment_time_limit);
 		//是否循环贷
        $('#is_cycles').val(json.is_cycles);
        //执行利率
        $('#lending_rates_execution_cycles').val(json.lending_rates_execution_cycles);
        
 		//----------------------客户资料明细-----------------------------------
 		//进件方式
 		$('#enter_file_way').val(json.enter_file_way);
 		//发薪方式
 		$('#payroll_payment_way').val(json.payroll_payment_way);
 		//职业类型
 		$('#profession_type').val(json.profession_type);
 		//资料种类
 		//$('#data_type').val(json.data_type);
 		//资料是否齐全
 		$("input[name='is_complete']").each(function() {
			if ($(this).val() == json.is_complete) {
				$(this).attr('checked', 'checked');
				return false;
			}
		});
 		//申请资料
 		//------------------------初审意见------------------------------------
 		//贷款类型
 		$('#reference_type').val(json.reference_type);
 		//是否在其他公司做过贷款
 		$("input[name='is_other_corporation_done']").each(function() {
			if ($(this).val() == json.is_other_corporation_done) {
				$(this).attr('checked', 'checked');
				return false;
			}
		});
 		//是否有对公流水
 		$("input[name='is_to_public_stream']").each(function() {
			if ($(this).val() == json.is_to_public_stream) {
				$(this).attr('checked', 'checked');
				return false;
			}
		});
 		//是否有房产证原件
 		$("input[name='is_house_certificate_original']").each(function() {
			if ($(this).val() == json.is_house_certificate_original) {
				$(this).attr('checked', 'checked');
				return false;
			}
		});
 		//是否有支票
 		$("input[name='is_check']").each(function() {
			if ($(this).val() == json.is_check) {
				$(this).attr('checked', 'checked');
				return false;
			}
		});
 		//是否已核实
 		$('#is_verify').val(json.is_verify);
 		//个人介绍
 		$('#person_condition').val(json.person_condition);
 		//业务员 判断如果业务员名称或者用户名编号存在 显示  否则不显示 
 		if(json.salesman_name !='' || json.salesman_shortcode !=null){
 			$('#salesman_name').val(json.salesman_name+"/"+json.salesman_shortcode); 			
 		}
 		
	}
	//---------------------实现当查看用户贷款数据，不能够编辑的方法------------------------
	function lookpage(){
		var cktype = $.query.get('cktype');
		if(cktype=='ck'){
			//使全部的文本框不可编辑
			$("input[type=text]").attr({
				"disabled" : "disabled"
			});
			//使全部的单选按钮不可编辑
			$("input[type=radio]").attr({
				"disabled" : "disabled"
			});
			//使全部下来框按不可编辑
			$("select").attr({
				"disabled" : "disabled"
			});
			//使所有多选框不可编辑
			$("input[type=checkbox]").attr({
				"disabled" : "disabled"
			});
			//使个人textArea不可编辑
			$('#person_condition').attr({
				"disabled" : "disabled"
			});
			info_l1.style.display='none';
			//info_l2.style.display='none';
			info_l3.style.display='none';
			$('#searchPersonnel_href').css('display','none');
		}
	}
	//清理指定DIV下的所有LigerTip控件
	function clearLigerTip(divId){
		var elementArr = $("#"+divId+" *");
		jQuery.each(elementArr.get(), function(i, element) {
			$(element).ligerHideTip();
		});
	}
	//-----------------------------------------------------------------------------
	function closepage(){
        dialog.close();
      }
	function closeDialog() {
		if(window.parent.dialog===dialog){
			try{
				globalUtil.closeCurrentTab();
			}catch(e){
				try{
					window.close();
				}catch(e){
					
				}
			}
		}else {
			try{
				window.parent.dialog.hide();
			}catch(e){
				try{
					globalUtil.closeCurrentTab();
				}catch(e){
					try{
						window.close();
					}catch(e){
						
					}
				}
			}
		}
	}
	//改变用户信息回调  房贷用  信贷加但暂时不用
	function changeDYFCXXShow(mcclhIDChange){
		//do nothing
	}
	function checkMobile(ele){
		var mobile = $(ele).val();
		if(mobile.length!=0 && !/^\d{11}$/.test(mobile)){
			$(ele).ligerTip({distanceX:-120,width:120,content: "手机号输入不正确！"});				
			$(ele).bind('click',function(){
				$(ele).ligerHideTip();
			});
		}
	}
	
</script>
</head>
<body>
<div>
		<!--查询条件  begin-->
		<div class="tab_titleT">
		<table width="100%" border="0" cellspacing="0" cellpadding="0">
			<tr valign="bottom" id='trtab1'>
				<td class="tabbody1" id="tabbody1" onclick="changeTab('khinfo');" tabname='mytab' style="width:33%"><div align="center" id="khinfo_div" class="tab_step tab_step101">贷款信息</div></td>
				<td class="tabbody2" id="tabbody2" onclick="changeTab('gzinfo');" tabname='mytab' style="width:33%"><div align="center" id="gzinfo_div" class="tab_step tab_step202">客户资料明细</div></td>
				<td class="tabbody3" id="tabbody3" onclick="changeTab('ckinfo');" tabname='mytab' style="width:33%"><div align="center" id="ckinfo_div" class="tab_step tab_step302">初审意见</div></td>
			</tr>
		</table>
		</div>
		<div  class="pop-center overflow-au"  style="top:27px;" id="waicengdiv">
		<!-- ------------------------------------------------------------------贷款信息 begin------------------------------------------------------------------ -->
		<div id="dkinfo" class="pop-formDiv clearfix" style="margin: 5px; margin-top: 5px;">
				<div class="l-panel-search-cond clearfix" id="info_l1">
					<div class="float-l" >        
		                <div class="l-panel-search-item" >
		                    <font >*可以通过<font style="color: red;">选择贷款客户</font>精确选择某一个客户，查询时需输入全部身份证号。选择用户后，需对每个客户添加联系人信息、客户资料明细、初审意见后提交。注：联系人信息，必须填写三个亲属，三位朋友/同事，号码必须真实有效能接通，若为外地号码，请在前加0。</font>
		                </div>
		            </div>
		         </div>
		         <!-- 空白区域 -->
		         <!--  
		          <div class="l-panel-search-cond clearfix" id="info_l2">
					<div class="float-l">        
		                <div class="l-panel-search-item">
		                </div>
		            </div>
		          </div>
		          -->
		          <!-- 添加的虚线 -->
		          <div class="line clearboth" id="info_l3"></div>
				<!--查询条件-->
				<div class="l-panel-search-cond clearfix" id='main_t'>
					<div class="float-l">
						<div class="l-panel-search-title">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;借款用途:</div>
						<div class="l-panel-search-item">
							<input type="text" id="credit_purpose" style="width:695px" isRequired="1"/>
						</div>
					</div>
					<div class="float-l clearboth">
						<div class="l-panel-search-title">&nbsp;&nbsp;&nbsp;是否循环贷:</div>
						<div class="l-panel-search-item">
							<select style="width: 50px;" id="is_cycles" >
								<option  value="0" selected="selected">否</option>
								<option  value="1" >是</option>
							</select>
						</div>
					</div>
					<div class="float-l">
						<div class="l-panel-search-title">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;循环贷执行利率:</div>
						<div class="l-panel-search-item">
							<input type="text" name="lending_rates_execution_cycles" id="lending_rates_execution_cycles" style="width: 95px;"  isFloat="1" minVal="1" maxVal="100" disabled="disabled"/> (%)
						</div>
					</div>
					<div class="float-l">
						<div class="l-panel-search-title">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;信贷产品种类:</div>
						<div class="l-panel-search-item">
							<input type="text" id="cre_loan_type" ligeruiSelectIsRequired="1"/>
						</div>
					</div>
					<div class="float-l clearboth ">
						<div class="l-panel-search-title">申请贷款额度:</div>
						<div class="l-panel-search-item">
							<input type="text" id="credit_limit" style="width:95px" isRequired="1" isFloat="1" minVal="0" maxVal="100000000"/> (万元)
						</div>
					 </div>
					 <div class="float-l ">
						<div class="l-panel-search-title">可接受每月最高还款额:</div>
						<div class="l-panel-search-item">
							<input type="text" id="max_repayment_limit_per_month" style="width:95px" isRequired="1" isFloat="1" minVal="0" maxVal="1000000"/> (元/月)
						</div>
					</div>
					<div class="float-l ">
						<div class="l-panel-search-title">申请最长还款期限:</div>
						<div class="l-panel-search-item">
							<input type="text" id="max_repayment_time_limit" style="width:95px" isRequired="1" isPositiveInteger="1" minVal="1" maxVal="120" scope="a"/> (月)
						</div>
					</div>
				</div>
			<!--查询条件  end-->
			<div class="center-content clearboth" style="min-width:500px;">
       		 <div class="center-title">贷款客户</div>
			<div class="center-txt" style="margin-bottom:5px;">
	            <div id="centertoolbar" class="minwidth400"></div>
	            <div id="grid"></div>
        	</div>
        	</div>
			<!-- 贷款信息 - 1 end-->
			<div id="allLinkManDiv">
				
			</div>
		</div>
	<!-- ------------------------------------------------------------------贷款信息 end------------------------------------------------------------------ -->

	<!-- ------------------------------------------------------------------工作信息 begin------------------------------------------------------------------ -->
		<div id="gzinfo" class="pop-formDiv clearfix" style="margin: 5px; margin-top: 5px; display: none;">
			<div class="l-panel-search-cond clearfix">
				<div class="float-l">
					<div class="l-panel-search-title">进件方式:</div>
					<div class="l-panel-search-item">
						<input type="text" id="enter_file_way" />
					</div>
				</div>
				<div class="float-l">
					<div class="l-panel-search-title">发薪方式:</div>
					<div class="l-panel-search-item">
						<input type="text" id="payroll_payment_way" />
					</div>
				</div>
				<div class="float-l">
					<div class="l-panel-search-title">职业类型:</div>
					<div class="l-panel-search-item">
						<input type="text" id="profession_type" />
					</div>
				</div>
				<div class="float-l">
					<div class="l-panel-search-title">资料齐全:</div>
					<div class="l-panel-search-item">
						<input type="radio"  name="is_complete" checked="checked" value="1" class="radio3"/>是
						<input type="radio"  name="is_complete" class="radio3" value="0"/>否
					</div>
				</div>
			</div>
			
			<div>
			<table cellspacing="1" cellpadding="1" class="input_tb" id="att_tb" >
				<tr >
					<td colspan="3" align="left">申请资料</td>
					<td align="right"><div id='plswpic'></div></td>
				</tr>
			</table>
			<table cellspacing="1" cellpadding="1" class="input_tb">
				<tr >
					<td colspan="3" align="left">面签上传附件</td>
				</tr>
				<tr>
					<td><div id='mqfjpic'></div></td>
				</tr>
			</table>
			</div>
		</div>
		<!-- ------------------------------------------------------------------工作信息 end------------------------------------------------------------------ -->
		
		<!-- ------------------------------------------------------------------参考意见 begin------------------------------------------------------------------ -->
		<div id="ckinfo" class="pop-formDiv clearfix" style="margin: 5px; margin-top: 5px; display: none;">
			<table  cellspacing="1" cellpadding="1" class="input_tb_new" border="0">
				<tr>
					<td width="15%" class="title">类型：</td>
					<td width="35%" style="text-align:left">
						<input id="reference_type" type="text" style="width:133px" ligeruiSelectIsRequired="1"/>
					</td>
					<td width="20%" class="title">是否在其他公司做过贷款：</td>
					<td style="text-align:left">
						<input type="radio" name="is_other_corporation_done" checked="checked" value="1" class="radio3"/>是
						<input type="radio" name="is_other_corporation_done" class="radio3" value="0"/>否</td>
				</tr>
				<tr>
					<td width="15%" class="title">是否有对公流水：</td>
					<td width="35%" style="text-align:left"><input type="radio"  name="is_to_public_stream" checked="checked" value="1"  class="radio3"/>是
					<input type="radio" name="is_to_public_stream" class="radio3" value="0"/>否</td>
					<td width="15%" class="title">是否有房产证原件：</td>
					<td style="text-align:left"><input type="radio" name="is_house_certificate_original" checked="checked" value="1" class="radio3"/>是
					<input type="radio" name="is_house_certificate_original" class="radio3" value="0"/>否</td>
				</tr>
				<tr>
					<td width="15%" class="title">是否有支票：</td>
					<td width="35%" style="text-align:left"><input type="radio" name="is_check" checked="checked" value="1" class="radio3"/>是
					<input type="radio" name="is_check" class="radio3" value="0"/>否</td>
				</tr>
				<tr>
					<td width="15%" class="title">是否已核实：</td>
					<td width="35%" style="text-align:left"><input  id="is_verify" type="text" style="width:250px" maxlength="25" isRequired="1"/></td>
				</tr>
				<tr style="height: 140px">
					<td width="15%" class="title">个人情况：</td>
					<td width="35%"><textarea id="person_condition" style="resize:none;width:180%;height:140px;" isRequired="1" maxLength="500"></textarea></td>
				</tr>
				<tr>
					<td width="15%" class="title">业务员：</td>
					<td width="35%" style="text-align:left"><input  id="salesman_name" type="text" style="width:230px" readonly="readonly" isRequired="1"/><a href="#" onclick="searchPersonnel()" id="searchPersonnel_href">选择</a></td>
					<td style="display: none;">
						<input  id="salesman_id" type="text" style="width:150px"  />
						<input  id="salesman_code" type="text" style="width:150px"  />
						<input  id="city" type="text" style="width:150px" />
						<input  id="salesman_city_code" type="text" style="width:150px" />
						<input  id="salesman_dept_id" type="text" style="width:150px" />
					</td>
				</tr>
			</table>
		</div>
		<!-- ------------------------------------------------------------------参考意见 end------------------------------------------------------------------ -->
	</div>
	</div>
	<!-- 提交功能按钮区 -->
<div class="pop-footer5 clearboth" style="bottom:1px;" id="tb_btn">
	<input id="zcbtn" class="btn-saveZ" onmouseover="this.className='btn-saveZ-over'" onmouseout="this.className='btn-saveZ'" onmousedown="this.className='btn-saveZ-down'" type="button" style="margin-right:7px;" onclick="submitInfo(0)"/>
    <input id="tjbtn" onclick="submitInfo(1);" class="btn-saveT" onmouseover="this.className='btn-saveT-over'" onmouseout="this.className='btn-saveT'" onmousedown="this.className='btn-saveT-down'" type="button" style="margin-right:7px;" />
    <input id="cancelBtnId" class="btn-cancel" onmouseover="this.className='btn-cancel-over'" onmouseout="this.className='btn-cancel'" onmousedown="this.className='btn-cancel-down'" type="button" onclick="closeDialog();"/>
</div>

</body>
</html>
