<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>财富管理系统</title>
<link href="../../css/zx-all.css" rel="stylesheet" type="text/css" />
<script src="../../js/zx-all.js" type="text/javascript"></script>
<style type="text/css">
/*input_tb css*/
.input_tb {
	border: 1px solid #dfdfdf;
	width: 100%;
	margin-bottom: 10px;
}

.input_tb a {
	color: #056aff;
	text-decoration: none;
	font-weight: normal;
}

.input_tb td {
	height: 35px;
	line-height: 25px;
	border-bottom: 1px dashed #d5d5d5;
	padding-top: 3px;
}

.input_tb .tr_title td {
	background-color: #f5f8ff;
	padding-left: 16px;
	font-weight: bold;
	height: 30px;
	line-height: 30px;
	border-bottom: 1px solid #dfdfdf;
}

.input_tb .tr_last td {
	border-bottom: 0;
}

.input_tb .title {
	text-align: right;
}

.input_tb .subtitle {
	text-align: left;
	background-color: #d2e1fd;
	border-top: 1px solid #fff;
	border-left: 1px solid #fff;
}

.input_tb .tr_btn_input td {
	background-color: #fbfbfb;
	/*border-top:1px solid #dbdbdb;*/
	height: 40px;
}
</style>
</head>
<body>
	<div class="tab_titleT">
		<table width="100%" border="0" cellspacing="0" cellpadding="0">
			<tr valign="bottom" id='trtab1'>
				<td class="tabbody1" id="tabbody1" style="width: 50%"
					onclick="changeTab('tqhkjsqdinfo');"><div align="center">提前还款结算清单</div></td>
				<td class="tabbody2" id="tabbody2" style="width: 50%"
					onclick="changeTab('hklsinfo');"><div align="center">还款历史</div></td>
			</tr>
		</table>
	</div>
	<div class="pop-center overflow-au" style="top: 30px;">
		<div id="tqhkjsqdinfo" class="pop-formDiv clearfix"
			style="margin: 5px; margin-top: 25px;">
			<div class="float-l">
				<div class="pop-form-title">客户名称：</div>
				<div class="pop-form-item">
					<input type="text" id="debtor_name" disabled="disabled" />
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">合同编号：</div>
				<div class="pop-form-item">
					<input type="text" id="protocol_code" disabled="disabled" />
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">合同日期：</div>
				<div class="pop-form-item">
					<input type="text" id="protocol_creat_date" disabled="disabled" />
				</div>
			</div>
			<div class="float-l clearboth">
				<div class="pop-form-title">合同金额：</div>
				<div class="pop-form-item">
					<input type="text" id="protocol_amount" style="width: 121px"
						disabled="disabled" />元
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">月还款金额：</div>
				<div class="pop-form-item">
					<input type="text" id="refund_limit_month" style="width: 121px"
						disabled="disabled" />元
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">已还期数：</div>
				<div class="pop-form-item">
					<input type="text" id="repay_period" disabled="disabled" />
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">已还本金：</div>
				<div class="pop-form-item">
					<input type="text" id="repay_principal" style="width: 121px"
						disabled="disabled" />元
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">已还利息：</div>
				<div class="pop-form-item">
					<input type="text" id="repay_interest" style="width: 121px"
						disabled="disabled" />元
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">
					<span class="redstar">*</span>申请还款日期：
				</div>
				<div class="pop-form-item">
					<input id="app_date" isRequired="1" class="Wdate" type="text"
						onclick="WdatePicker({dateFmt:'yyyy-MM-dd',isShowClear:true})"
						style="vertical-align: top;" />
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">未还期数：</div>
				<div class="pop-form-item">
					<input type="text" id="un_pay_period" disabled="disabled" />
				</div>
			</div>

			<div class="float-l">
				<div class="pop-form-title">剩余本金：</div>
				<div class="pop-form-item">
					<input type="text" id="un_pay_principal" disabled="disabled"
						style="width: 121px" />元
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">返利期数：</div>
				<div class="pop-form-item">
					<input type="text" id="back_interest_period" isRequired="1"
						isPositiveInteger="1" minVal="0" maxVal="120" scope="a" />
				</div>
			</div>

			<div class="float-l">
				<div class="pop-form-title">返利金额：</div>
				<div class="pop-form-item">
					<input type="text" id="back_ammont" style="width: 121px"
						onchange="countTotalAmmont()" isRequired="1" isFloat="1"
						minVal="0" maxVal="100000000" scope="a" />元
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">剩余利息：</div>
				<div class="pop-form-item">
					<input type="text" id="un_pay_interest" disabled="disabled"
						style="width: 121px" />元
				</div>
			</div>

			<div class="float-l">
				<div class="pop-form-title">逾期天数：</div>
				<div class="pop-form-item">
					<input type="text" id="cur_overdue_day" style="width: 121px"
						disabled="disabled" />天
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">滞纳金额：</div>
				<div class="pop-form-item">
					<input type="text" id="cur_late_fee" style="width: 121px"
						disabled="disabled" />元
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">减免额：</div>
				<div class="pop-form-item">
					<input type="text" id="derate" style="width: 121px"
						onchange="countTotalAmmont()" />元
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">
					<span class="redstar">*</span>应还款总额：
				</div>
				<div class="pop-form-item">
					<input type="text" id="total_ammont" style="width: 121px"
						isRequired="1" isFloat="1" minVal="0" maxVal="10000000" />元
				</div>
			</div>
			<div class="float-l" style="height: 73px;">
				<div class="pop-form-title">备注：</div>
				<div class="pop-form-item">
					<textarea id="remark" style="width: 647px; height: 60px"></textarea>
				</div>
			</div>

			<div class="line clearboth"></div>
			<div class="float-l">
				<div class="pop-form-title">返利账户名：</div>
				<div class="pop-form-item">
					<input type="text" id="refund_name" />
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">账户号码：</div>
				<div class="pop-form-item">
					<input type="text" id="refund_number" style="width: 390px" />
				</div>
			</div>
		</div>
		<!-- 提前还款结算清单信息结束 -->
		<div id="hklsinfo" class="pop-formDiv clearfix"
			style="margin: 5px; margin-top: 25px; display: none">

			<div class="float-l">
				<div class="pop-form-title">贷款类型：</div>
				<div class="pop-form-item">
					<input type="text" id="cre_type_name" />
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">业务员：</div>
				<div class="pop-form-item">
					<input type="text" id="salesman_name" />
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">客户专员：</div>
				<div class="pop-form-item">
					<input type="text" id="customer_officer_name" />
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">合同签约日期：</div>
				<div class="pop-form-item">
					<input type="text" id="protocol_creat_date" />
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">放款日：</div>
				<div class="pop-form-item">
					<input type="text" id="loan_date" />
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">还款日：</div>
				<div class="pop-form-item">
					<input type="text" id="refund_day" />
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">合同金额：</div>
				<div class="pop-form-item">
					<input type="text" id="protocol_amount" style="width: 121px" />元
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">贷款利率：</div>
				<div class="pop-form-item">
					<input type="text" id="borrow_interest" style="width: 121px" />％
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">贷款期数：</div>
				<div class="pop-form-item">
					<input type="text" id="borrow_deadline" />
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">月还款金额：</div>
				<div class="pop-form-item">
					<input type="text" id="refund_limit_month" style="width: 121px" />元
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">已还期数：</div>
				<div class="pop-form-item">
					<input type="text" id="repay_period" />
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">剩余本金：</div>
				<div class="pop-form-item">
					<input type="text" id="un_pay_principal" style="width: 121px" />元
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">还款状态：</div>
				<div class="pop-form-item">
					<input type="text" id="repay_status_name" />
				</div>
			</div>
			<div class="float-l">
				<div class="pop-form-title">逾期天数：</div>
				<div class="pop-form-item">
					<input type="text" id="cur_overdue_day" style="width: 121px" />天
				</div>
			</div>
			<div class="line clearboth sqrqkdiv"></div>
			<div id="grid"></div>
			<!-- 还款历史信息结束 -->
		</div>
	</div>
	<div class="pop-footer5 clearboth" style="bottom: 1px;">
		<input id="zcbtn" class="btn-saveT"
			onmouseover="this.className='btn-saveT-over'"
			onmouseout="this.className='btn-saveT'"
			onmousedown="this.className='btn-saveT-down'" type="button"
			style="margin-right: 7px;" onclick="save()" /> <input
			id="cancelBtnId" class="btn-cancel"
			onmouseover="this.className='btn-cancel-over'"
			onmouseout="this.className='btn-cancel'"
			onmousedown="this.className='btn-cancel-down'" type="button"
			onclick="closeDialog();" />
	</div>
	<script type="text/javascript">
	var grid;//还款历史表格
	var columns;//还款历史表格列
	var wms_cre_credit_head_id;
	var wms_fina_cre_pay_id;
	var cre_type;
	var isCommit = false;//是否已经按过了提交按钮
	var taskId;
	var isUpdate=false;
	var protocol_type;
	var org_repay_interest;
	$(function() {
		wms_cre_credit_head_id = $.query.get('wms_cre_credit_head_id');
		wms_fina_cre_pay_id = $.query.get('wms_fina_cre_pay_id');
		cre_type = $.query.get('cre_type');
		taskId=$.query.get("taskId");
		initForm();//初始化贷款还款表中的数据
		initGrid();		
		$('#hklsinfo :input').attr("disabled","disabled");
	});
	//关闭对话框
	function closeDialog() {
		window.parent.dialog.hide();
	}
	//初始化返利期数，返利金额，减免额
	function initData(interest_limit_month){		
		$('#derate').val('0');//减免额
		var borrow_deadline = $('#borrow_deadline').val();//贷款期数
		var repay_period = $('#repay_period').val();//已还期数
		if(borrow_deadline<=6){
			$('#back_interest_period').val('0');//返利期数
			$('#back_ammont').val('0');//返利金额
		}else if(repay_period<=6){
			var back_interest_period = parseInt(borrow_deadline)-7;
			$('#back_interest_period').val(back_interest_period);//返利期数
			$('#back_ammont').val(back_interest_period*interest_limit_month);//返利金额
		}else{
			var back_interest_period = parseInt(borrow_deadline)-parseInt(repay_period)-1;
			$('#back_interest_period').val(back_interest_period);//返利期数
			$('#back_ammont').val(back_interest_period*interest_limit_month);//返利金额
		}
	}
	//验证减免额
	function valiZnje(){
		var value = $('#derate').val();
		if(globalUtil.isEmpty(value)){				
	        $('#derate').ligerTip({distanceX:-140,width:80,content: "此项必填！"});	
	        $('#derate').bind('click',function(){
	        	$('#derate').ligerHideTip();
			}); 
	        return true;
		}
		if(!globalUtil.isFloat(value) && !(value>=0 && value<=parseFloat($('#cur_late_fee').val()))){
			result=true;
			$('#derate').ligerTip({distanceX:-140,width:110,content: '减免额为0-'+$('#cur_late_fee').val()+'！'});
			$('#derate').bind('click',function(){
				$('#derate').ligerHideTip();
			});
			return true;
		}
		return false;
	}
	//初始化贷款还款表中的数据
	function initForm(){
		$.getJSON(globalUtil.getTimestampUrl('/loanfina/wmsfinacrerepayinfobypk.do'),
				{
					"wms_fina_cre_pay_id" : wms_fina_cre_pay_id
				},
				function(json) {	
					protocol_type = json.protocol_type;
					globalUtil.setFormVal("tqhkjsqdinfo", json);//初始化提前还款申请信息
					globalUtil.setFormVal("hklsinfo", json);//初始化还款历史表单	
					initData(json.interest_limit_month);//初始化返利期数，返利金额，减免额
					$('#app_date').val(json.current_repay_date);//初始化申请还款日期					
					$.getJSON(globalUtil.getTimestampUrl('/loanpost/wmsfinacreprerepayinfobyentity.do'),
							{
								"wms_cre_credit_head_id" : wms_cre_credit_head_id
							},
							function(json2) {
								if(JSON.stringify(json2).split(",").length!=1){
									for(var item in json2){
										json[item]=json2[item];
									}
									isUpdate=true;									
									globalUtil.setFormVal("tqhkjsqdinfo", json);//初始化提前还款申请信息								
								}								
					});
					if($('#borrow_deadline').val()<=6 || cre_type==2){
						$('#back_interest_period').val('0');
						$('#back_ammont').val('0');
						$('#back_interest_period').attr('readOnly','readOnly');
						$('#back_ammont').attr('readOnly','readOnly');	
					}
					org_repay_interest = json.org_repay_interest;
					countTotalAmmont();
		});
	}
	//提交表单
	function save() {
		isCommit = true;
		globalUtil.clearLigerTip("tqhkjsqdinfo");//清理提前还款结算清单中的LigerTip控件
		//当在提前还款结算清单页面时，检查各表单的数据
		if($('#tqhkjsqdinfo').css('display')!='none' && (globalVali.checkForm("tqhkjsqdinfo",true) | valiZnje())){
			return;
		}else if($('#hklsinfo').css('display')!='none' && (globalVali.checkForm("tqhkjsqdinfo",true) | valiZnje())){//当在还款历史页面时，检查各表单的数据
			globalUtil.clearLigerTip("tqhkjsqdinfo");
			globalUtil.warnMsg(globalErrorMsg['100116']);
			return;
		}
		var paramJson = globalUtil.getFormParam("tqhkjsqdinfo");
		if(taskId=="undefined"){
			var url=globalUtil.getTimestampUrl("/loanpost/wmsfinacreprerepaysave.do?wms_cre_credit_head_id="+wms_cre_credit_head_id);				
		}else{
		    var url=globalUtil.getTimestampUrl("/loanpost/wmsfinacreprerepaysave.do?wms_cre_credit_head_id="+wms_cre_credit_head_id+"&taskId="+taskId);			
		}
		$.post(url, paramJson,
        function(data) {
        	if (data === 'success') {
            	 globalUtil.successMsg(globalErrorMsg['100002'],
            	 function(){            		 		
                		refreshAndClosePage();
            	 });//保存成功            	 
            }else if(data==='error'){
            	globalUtil.errorMsg(globalErrorMsg['700108']);//请刷新页面,您当前审批的单据已经被审批过！
            }else {
                globalUtil.errorMsg(globalErrorMsg['100012']); //保存失败
            }
        });
	}
	//关闭本页并刷新查询页面
    function refreshAndClosePage(){   
    	window.parent.search();
    	window.parent.dialog.hide();
    }

	/**
	 * 切换Tab页
	 */
	function changeTab(id) {
		var tqhkjsqdinfo = document.getElementById("tqhkjsqdinfo"); //提前还款结算清单tab
		var hklsinfo = document.getElementById("hklsinfo"); //还款历史tab		

		if (id == 'tqhkjsqdinfo') {
			tqhkjsqdinfo.style.display = '';
			hklsinfo.style.display = 'none';
			document.getElementById("tabbody1").className = "tabbody1";
			document.getElementById("tabbody2").className = "tabbody2";
			globalUtil.clearLigerTip("tqhkjsqdinfo");
			if(isCommit){
				globalVali.checkForm("tqhkjsqdinfo",true);
				valiZnje();
			}
		} else if (id == 'hklsinfo') {
			tqhkjsqdinfo.style.display = 'none';
			hklsinfo.style.display = '';
			document.getElementById("tabbody1").className = "tabbody2";
			document.getElementById("tabbody2").className = "tabbody1";
			globalUtil.clearLigerTip("tqhkjsqdinfo");
		}
	}
	//表格初始化color: #056AFF;    
    function initGrid() {
    	columns = [{
            display: '还款期数',
            name: 'repay_no',
            width: 50,
            minWidth: 50
        },{
            display: '还款日期',
            name: 'repay_date',
            width: 120,
            minWidth: 120         
        },{
            display: '还款总额（元）',
            name: 'repay_total',
            width: 120,
            minWidth: 120
        },{
            display: '其中，本金（元）',
            name: 'repay_principal',
            width: 120,
            minWidth: 120
        },{
            display: '利息（元）',
            name: 'repay_interest',
            width: 100,
            minWidth: 100
        },{
            display: '滞纳金（元）',
            name: 'cur_late_fee',
            width: 100,
            minWidth: 100	
        },{
            display: '减免额（元）',
            name: 'derate',
            width: 100,
            minWidth: 100
        }];
        grid = $("#grid").ligerGrid({
    		columns: columns,
    		url: global_param.context_name + '/loanpost/wmsfinacreperiodrepaywithoutpaginglist.do?wms_cre_credit_head_id='+wms_cre_credit_head_id,
    		sortName: 'repay_no', // 排序列名
			sortOrder: 'desc', // 排序方式
    		rownumbers: true,
    		allowUnSelectRow: true,
    		usePager: false,
    		width: '100%',
    		//height: '100%',
    		heightDiff: -4
        });
    }      
    //计算应还款总额
    function countTotalAmmont(){
    	var un_pay_principal = $('#un_pay_principal').val();//剩余本金
    	var un_pay_interest = $('#un_pay_interest').val();//剩余利息
    	var cur_late_fee = $('#cur_late_fee').val();//滞纳金额
    	var back_ammont = $('#back_ammont').val();//返利金额
    	var derate = $('#derate').val();//减免额
    	if(!globalUtil.isEmpty(back_ammont) && !globalUtil.isEmpty(derate) && (globalUtil.isNum(back_ammont) || back_ammont==0) && (globalUtil.isNum(derate) || derate==0)){
    		if(protocol_type==1 || protocol_type==2 || protocol_type==6 || protocol_type==7){
    			$('#total_ammont').val(parseFloat(un_pay_principal)+parseFloat(org_repay_interest)+(parseFloat(un_pay_interest)-parseFloat(org_repay_interest))*0.25-parseFloat(derate)+parseFloat(cur_late_fee));
    		}else if(protocol_type==3 || protocol_type==4){
    			$('#total_ammont').val(parseFloat(un_pay_principal)+parseFloat(org_repay_interest)+parseFloat(cur_late_fee)-parseFloat(derate));
    		}else{
    			$('#total_ammont').val(parseFloat(un_pay_principal)+parseFloat(un_pay_interest)+parseFloat(cur_late_fee)-parseFloat(derate));
    		}	
    	}
    }
</script>
</body>
</html>
