<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="../../css/zx-all.css" rel="stylesheet" type="text/css" />
<link href="../../css/app.css" rel="stylesheet" type="text/css" />
<script src="../../js/zx-all.js" type="text/javascript"></script>
<script src="../../js/exportxls.js?v=2"></script>
<script type="text/javascript" charset="utf-8"
	src="../../js/media/js/ZeroClipboard.js"></script>
<title>客户每月收益表</title>
</head>
<body style="overflow-y: hidden;">
	<div class="l-panel-search clearfix centertoolbar-w">
		<div id="searchbar" class="l-searchbar clearfix">
			<!--查询条件-->
			<div class="l-panel-search-cond clearfix">
				<div class="float-l">
					<div class="l-panel-search-title">单据编号:</div>
					<div class="l-panel-search-item">
						<input type="text" id="bill_code"/>
					</div>
				</div>
				
				<div class="float-l">
					<div class="l-panel-search-title" style="margin-left: 16px">客户姓名:</div>
					<div class="l-panel-search-item">
						<input type="text" id="cus_name" />
					</div>
				</div>
				
				<div class="float-l">
					<div class="l-panel-search-title" style="width: 63px;">产品名称:</div>
					<div class="l-panel-search-item">
						<input type="text" id="category_name" style="width: 180px;"/>
					</div>
				</div>
				
				<div class="float-l">
					<div class="l-panel-search-title">合同日期:</div>
					<div class="l-panel-search-item">
						<input id="signing_date_begin" class="Wdate" type="text" onclick="WdatePicker({dateFmt:'yyyy-MM-dd',isShowClear:true})" style="width: 100px; vertical-align: top;" /> 
						至 
						<input id="signing_date_end" class="Wdate" type="text" onclick="WdatePicker({dateFmt:'yyyy-MM-dd',isShowClear:true})" style="width: 100px; vertical-align: top;" />
					</div>
				</div>
			<!-- <div class="float-l">
					<div class="l-panel-search-title">应支付日期:</div>
					<div class="l-panel-search-item">
						<input id="return_date_begin" class="Wdate" type="text"
							onclick="WdatePicker({dateFmt:'yyyy-MM-dd',isShowClear:true})"
							style="width: 100px; vertical-align: top;" /> 至 <input
							id="return_date_end" class="Wdate" type="text"
							onclick="WdatePicker({dateFmt:'yyyy-MM-dd',isShowClear:true})"
							style="width: 100px; vertical-align: top;" />
					</div>
				</div> -->
				<!-- <div class="float-l">
					<div class="l-panel-search-title">应支付月份:</div>
					<div class="l-panel-search-item">
						<input id="return_date" class="Wdate" type="text"
							onclick="WdatePicker({dateFmt:'yyyy-MM',isShowClear:true})"
							style="width: 100px; vertical-align: top;" />
					</div>
				</div> -->
				<div class="float-l">
					<div class="l-panel-search-title">收益月份:</div>
					<div class="l-panel-search-item">
						<input id="return_date" name="return_date" class="Wdate" type="text" onclick="WdatePicker({dateFmt:'yyyy-MM',isShowClear:true, maxDate:'%y-%M'})" style="width: 100px; vertical-align: top;" />
					</div>
				</div>
				<div class="float-l">
					<div class="l-panel-search-title">是否有奖励利率:</div>
					<div class="l-panel-search-item">
						<input type="radio" name="is_bonus_rate" class="radio5" value="1"/><span>是</span> 
						<input type="radio" name="is_bonus_rate" class="radio5" value="2"/><span>否</span>
					</div>
				</div>
				<div class="float-l">
					<div class="l-panel-search-title">是否有公益收益:</div>
					<div class="l-panel-search-item">
						<input type="radio" name="is_extent_rate" class="radio5" value="1"/><span>是</span> 
						<input type="radio" name="is_extent_rate" class="radio5" value="2"/><span>否</span>
					</div>
				</div>
				
				<div class="float-l">
					<div class="l-panel-search-title">单据范围:</div>
					<div class="l-panel-search-item">
						<input type="radio" name="is_query_data_type" class="radio5" value="1" checked="checked"/><span>全部数据</span> 
						<input type="radio" name="is_query_data_type" class="radio5" value="2"/><span>打款数据</span>
					</div>
				</div>
				
				<div class="float-l">
					<div class="l-panel-search-title">支付状态:</div>
					<div class="l-panel-search-item">
						<input type="radio" name="is_query_pay_status" class="radio5" value="1"/><span>已支付</span> 
						<input type="radio" name="is_query_pay_status" class="radio5" value="2"/><span>未支付</span>
					</div>
				</div>
				
			</div>
		</div>
	</div>
	<div id="centertoolbar" class="minwidth400"></div>
	<div>
		<span style="font-size: 15px;">本月应付客户基本收益：</span><span style="color: red;" id="byyfjbsy">0</span>元，&nbsp;&nbsp;
		<span style="font-size: 15px;">本月应付客户奖励收益：</span><span style="color: red;" id="byyfjlsy">0</span>元，&nbsp;&nbsp;
		<span style="font-size: 15px;">本月应付总收益：</span><span style="color: red;" id="byyfzsy">0</span>元
	</div>
	<div id="grid"></div>
	<!-- 导出excel form表单 -->
	<form id="expertFormId" action="/WMS/inve/expertWmsInveTransaIncomeInfo.do" method="post">
		<input type="hidden" id="expert_form_bill_code" name="bill_code"/>
		<input type="hidden" id="expert_form_cus_name" name="cus_name"/>
		<input type="hidden" id="expert_form_category_name" name="category_name"/>
		<input type="hidden" id="expert_form_signing_date_begin" name="signing_date_begin"/>
		<input type="hidden" id="expert_form_signing_date_end" name="signing_date_end"/>
		<input type="hidden" id="expert_form_return_date" name="return_date"/>
		<input type="hidden" id="expert_form_is_bonus_rate" name="is_bonus_rate"/> 
		<input type="hidden" id="expert_form_is_extent_rate" name="is_extent_rate"></input>
		<input type="hidden" id="expert_form_is_query_data_type" name="is_query_data_type"></input>
		<input type="hidden" id="expert_form_is_query_pay_status" name="is_query_pay_status"></input>
	</form>
	<!-- 工具条初始化 -->
	<script type="text/javascript">
        var grid;
		var toolbar;
		var params;
		var dialog;
		var columns;
		var myDate = new Date();
		var myMonth=myDate.getMonth()+1;
		var myFullYear=myDate.getFullYear();
		var adjustmentAmountDialog;
        $(function() {
        	init_return_date();
        	initGrid();
        	var toolbarItemData = [];
             toolbarItemData.push({ 
                 text: '查询',
                 click:search,
                 icon: 'search'
             });
             toolbarItemData.push({
                 line: true
             });
             toolbarItemData.push({
                 text: '清空',
                 click:clear,
                 icon: 'empty'
             });
             toolbarItemData.push({
                 line: true
             });
             toolbarItemData.push({
                 text: '导出Excel',
                 click:exportExcel,
                 icon: 'export'
             });
             toolbarItemData.push({
                 line: true
             });
             toolbarItemData.push({
                 text: '导入Excel',
                 click:importExcel,
                 icon: 'import'
             });
             toolbarItemData.push({
                 line: true
             });
             $("#centertoolbar").ligerToolBar({
                  items: toolbarItemData
        	 });
             //search();
             //registerCsv();
             init_category_name();
        });
        
        //初始化收益月份为当前月份
        function init_return_date(){
        	var date = new Date();
			$("#return_date").val(date.format("yyyy-MM"));
        }
        
        //初始化本月收益
     	function  initbysy(){
     		 //实现显示统计本月应付客户基本收益  应付客户奖励收益  应付总额收益
             var url =globalUtil.getTimestampUrl('/reportmanage/geToalCountInfo.do');
             initParams();
             $.post(url,params,function(json){
            	 if(json){
            		 $("#byyfjbsy").text(json.byyfjbsy);
                	 $("#byyfjlsy").text(json.byyfjlsy);
                	 $("#byyfzsy").text(json.byyfzsy); 
            	 }else{
            		 $("#byyfjbsy").text(0);
                	 $("#byyfjlsy").text(0);
                	 $("#byyfzsy").text(0); 
            	 }
             });
        }
    	 //实现数据导出功能
        function registerCsv(){
        	var moviePath = "../../js/media/swf/copy_csv_xls_pdf.swf";
        	var fileName = '客户'+myFullYear+'年'+myMonth+'月收益表.xls';
        	var titleJson = '';
        	var dataJson = '';
        	var obj = $("div[toolbarid='ToolTables_XLS_2']")[0];//获取菜单对象
        	var getDataFun = function(){
        		var text = {};
        		initParams();
        		//实现导出的时候，规定导出的具体内容
        		text.title={'prot_code':'单据编号','cus_name':'客户姓名','signing_date':'签单日期',
        				    'salesman_name':'业务员/编号', 'product_account':'签单金额（万元）',
        				    'category_name':'产品名称','product_deadline':'产品期限',
							'basic_rate':'基本利率','bonus_rate':'奖励利率',
        				    'days_of_calculation':'计息天数','return_date':'应付日期',
        				    'payable_basic_income':'应付基本收益','payable_reward_income':'应付奖励收益',
        				    'product_interest_account':'应付总收益','remarks':'备注',
        				    'card_no':'银行卡号','bank_of_deposit':'银行','bank_branch':'支行',
        				    'bank_of_deposit_pro':'省份','bank_of_deposit_city':'所属市'
        				    };
        		var json = globalUtil.syncGetJson("/reportmanage/getMapInfoListWithoutPaging.do?sortname=e.wms_inve_transa_income_id",params);//同步获取需要导出的数据内容
        		text.data = json.Rows;
        		return text;
        	};
        	registerXlsFlashBtn(moviePath,fileName,titleJson,dataJson,obj,getDataFun);
        }
        
    	//清空所填写内容
        function clear(){
        	$("#bill_code").val("");
        	$("#category_name").val("请选择");
        	global_ligerui_extend.setComboxVal("category_name","-1");
        	$("#cus_name").val("");
        	$("#signing_date_begin").val("");
        	$("#signing_date_end").val("");
        	
        	//将选中的是否有奖励的单选按钮设置未选中的状态
        	var radioObjs = document.getElementsByName("is_bonus_rate");
        	for(var i = 0 ; i < radioObjs.length; i++){
        		radioObjs[i].checked = false;
        	}
        	
        	//将选中的是否有收益的单选按钮设置未选中的状态
        	var extendObjs = document.getElementsByName("is_extent_rate");
        	for(var i = 0; i < extendObjs.length; i++){
        		extendObjs[i].checked = false;
        	}
        	
        	//根据名称获取查询支付状态单选按钮的集合,并且判断是否呗选中,将选中的值设置到参数对象中
        	var queryPayStatusObjs = document.getElementsByName("is_query_pay_status");  
        	for(var i = 0; i < queryPayStatusObjs.length; i++){
        		if(queryPayStatusObjs[i].checked){
        			queryPayStatusObjs[i].checked = false;
        		}
        	}
        }
        
        //表格初始化
        function initGrid() {
        	
        	columns = [
        	{
                display: '单据编号',
                name: 'bill_code',
                width: 130,
                minWidth: 130,
				render: function (rowdata, nowRowIndex, value, column) {
					return '<a href="javascript:inveInfo('+rowdata.wms_inve_transa_id+','+rowdata.wms_inve_transa_prod_id+','+rowdata.user_id+','+rowdata.inkey+');" style="color:#056AFF;text-decoration: none;">'+value+'</a>';
				}
            },{
                display: '客户姓名',
                name: 'cus_name',
                width: 130,
                minWidth: 130
            },{
            	display:'合同日期',
            	name:'signing_date',
            	width:130,
            	minWidth:130
            },{
            	display:'业务员',
            	name:'salesman_name',
            	width:100,
            	minWidth:100
            },{
            	display:'签单金额（万元）',
            	name:'product_account',
            	width:100,
            	minWidth:100
            },{
            	display:'产品名称',
            	name:'category_name',
            	width:100,
            	minWidth:100
            },{
            	display:'产品期限',
            	name:'category_deadline',
            	width:100,
            	minWidth:100
            },{
            	display:'单据状态',
            	name:'data_status',
            	width:100,
            	minWidth:100
            },{
            	display:'合同内计息天数',
            	name:'days_of_calculation',
            	width:100,
            	minWidth:100
            },{
            	display:'基本利率(%)',
            	name:'income_rate',
            	width:80,
            	minWidth:80
            },{
            	display:'应付基本收益(元)',
            	name:'payable_basic_income',
            	width:100,
            	minWidth:100
            },{
            	display:'奖励利率(%)',
            	name:'bonus_rate',
            	width:100,
            	minWidth:100
            },{
            	display:'应付奖励收益(元)',
            	name:'payable_reward_income',
            	width:100,
            	minWidth:100
            },{
            	display:'公益计息天数',
            	name:'days_extend_income',
            	width:100,
            	minWidth:100
            },{
            	display:'公益收益(元)',
            	name:'extend_income',
            	width:100,
            	minWidth:100
            },{
            	display:'应付日期',
            	name:'return_date',
            	width:100,
            	minWidth:100
            },{
            	display:'调整金额(元)',
            	name:'adjust_amount',
            	width:100,
            	minWidth:100,
				render: function (rowdata, nowRowIndex, value, column) {
					//当前行的应付日期与当前日期是否相同, 调整金额只允许调整当前月份的数据
					//如果当前日期与应付日期相同则可以点击超链接否则不可以点击 
					value = value==0?"0":value;
					var valueStr = "<a href='javascript:openSetAdjustAmountPage("+JSON.stringify(rowdata)+")'>"+value+"</a>";
					if(rowdata.pay_status == "未支付")
					{
						return valueStr;
					}
					else
					{
						return value;
					}
				}
            },{
            	display:'应付总收益(元)',
            	name:'product_interest_account',
            	width:100,
            	minWidth:100
            },{
            	display:'支付状态',
            	name:'pay_status',
            	width:100,
            	minWidth:100,
            	render: function (rowdata, nowRowIndex, value, column) {
            		return value;
            	}
            }
            ];
            grid = $("#grid").ligerGrid({
        		columns: columns,
        		url: global_param.context_name + '/reportmanage/getInveCustomerMonthlyIncomeListInfo.do',
        		sortName: 'w2.date_of_payment', // 排序列名
        		sortOrder: 'desc', // 排序方式
        		rownumbers: true,
        		allowUnSelectRow: true,
        		usePager: true,
        		width: '100%',
        		height: '95%',
        		heightDiff: -4,
        		rowAttrRender: function(rowdata, rowindex) {
    				
        		},
        		parms: {
        			_filterParms: -1
        		}/* ,
        		detail: { onShowDetail: f_showOrder,height:'auto' } */
            });
        }
        
        /*
         *弹出调整金额的输入信息页面
         *@param rowDataStr 列表中所选中的行数据
         */
        function openSetAdjustAmountPage(rowDataStr){
       		var url = globalUtil.getHtml("../reportmanage/adjustmentAmount.html?rowdata="+JSON.stringify(rowDataStr));
       		adjustmentAmountDialog=$.ligerDialog.open({
	       		url:url,
	       		title: '调整金额情况',
	            	width: 850,
	            	height: globalUtil.setDialogHeight(500),
	            	onHiddenOrClose: function(){
	        	 	},
	            	isResize: false
       	 	});
        }
        
        function f_showOrder(row, detailPanel,callback){
        	var gridmx = document.createElement('div'); 
            $(detailPanel).append(gridmx);
            $(gridmx).css('margin',10).ligerGrid({
            	columns:[
            	          { display: '银行卡号', name: 'card_no'},
            	          { display: '银行', name: 'bank_of_deposit'},
            	          { display: '支行', name: 'bank_branch'},
                          { display: '省份', name: 'bank_of_deposit_pro'},
                          { display: '所属市', name: 'bank_of_deposit_city'}
                         ],
                 isScroll: false,
                 showToggleColBtn: false,
                 width: '52%',
             	 url: global_param.context_name + '/reportmanage/getInveCustomerMonthlyIncomeListDetailInfo.do?wms_inve_transa_prod_id='+row.wms_inve_transa_prod_id,
        		 sortName: 'p.wms_inve_transa_prod_id',//排序列名
				 sortOrder: 'desc',//排序方式
                 showTitle: false,
                 columnWidth: 160,
                 rownumbers: false,
                 onAfterShowData: callback,
                 frozen:false,
                 usePager: false
            });
        }
        
        //初始化检索条件
        function initParams() {
        	params = globalUtil.getFormParam("searchbar");
        	//根据名称获取是否有奖励利率所选中的值
        	var radioObjs = document.getElementsByName("is_bonus_rate");
        	for(var i = 0 ; i < radioObjs.length; i++){
        		if(radioObjs[i].checked){
        			params.is_bonus_rate = radioObjs[i].value;
        		}
        	}
        	//根据名称获取单选按钮的集合,并判断是否被选中,将选中的值设置到参数中
        	var extendObjs = document.getElementsByName("is_extent_rate");
        	for(var i = 0; i < extendObjs.length; i++){
        		if(extendObjs[i].checked){
        			params.is_extent_rate = extendObjs[i].value;
        		}
        	}
			//根据名称获取查询范围单选按钮的集合,并判断是否被选中,将选中的值设置到参数对象中        	
        	var queryTypeObjs = document.getElementsByName("is_query_data_type");  
        	for(var i = 0; i < queryTypeObjs.length; i++){
        		if(queryTypeObjs[i].checked){
        			params.is_query_data_type = queryTypeObjs[i].value;
        		}
        	}
        	//根据名称获取查询支付状态单选按钮的集合,并且判断是否呗选中,将选中的值设置到参数对象中
        	var queryPayStatusObjs = document.getElementsByName("is_query_pay_status");  
        	for(var i = 0; i < queryPayStatusObjs.length; i++){
        		if(queryPayStatusObjs[i].checked){
        			params.is_query_pay_status = queryPayStatusObjs[i].value;
        		}
        	}
        	
        }
        
        //查询
        var search= function() {
            initParams();
            initbysy();
            global_ligerui_extend.search(grid, params);
        }
       	//初始化页面产品名称所有信息
      	function  init_category_name(json){
      		var category_name_params ={
	    				dest_url:'/sysmanage/getAllInvePruductCategory.do',
	    				t_col_name:'category_name',
	    				valueField:'wms_inve_pruduct_category_id',   //下拉框value对应的值，默认为id
	    				textField:'category_name',    //下拉框text对应的值，默认为text
	    				input_width:150,
	    				def_val:'first'
				};
      		global_ligerui_extend.initCombox("category_name",null,category_name_params);
      		if(json){
    			//把值装载设定
    			global_ligerui_extend.syncRequestInitComboxData(json,"category_name");
    			//让其不可编辑
    			global_ligerui_extend.disabledCombox("category_name");
    		}else{			
    		    global_ligerui_extend.initComboxDefVal("category_name");
    		}
      	}
      	
      	/*
      	 *导出excel客户收益报表,采用的是提交form表单的形式调用
      	 *先将定义的form表单中的各个字段赋值然后提交form表单
      	 */
      	function exportExcel(){
      		$("#expert_form_bill_code").val($("#bill_code").val());
      		$("#expert_form_cus_name").val($("#cus_name").val());
      		$("#expert_form_category_name").val($("#category_name").ligerComboBox("getValue"));
      		$("#expert_form_signing_date_begin").val($("#signing_date_begin").val());
      		$("#expert_form_signing_date_end").val($("#signing_date_end").val());
      		$("#expert_form_return_date").val($("#return_date").val());
      		
      		var radioObjs = document.getElementsByName("is_bonus_rate");
        	for(var i = 0 ; i < radioObjs.length; i++){
        		if(radioObjs[i].checked){
        			$("#expert_form_is_bonus_rate").val(radioObjs[i].value);
        		}
        	}
        	
        	var extendObjs = document.getElementsByName("is_extent_rate");
        	for(var i = 0; i < extendObjs.length; i++){
        		if(extendObjs[i].checked){
        			$("#expert_form_is_extent_rate").val(extendObjs[i].value);
        		}
        	}
        	
        	var queryTypeObjs = document.getElementsByName("is_query_data_type");  
        	for(var i = 0; i < queryTypeObjs.length; i++){
        		if(queryTypeObjs[i].checked){
        			$("#expert_form_is_query_data_type").val(queryTypeObjs[i].value);
        		}
        	}
        	
        	var queryPayStatusObjs = document.getElementsByName("is_query_pay_status");  
        	for(var i = 0; i < queryPayStatusObjs.length; i++){
        		if(queryPayStatusObjs[i].checked){
        			$("#expert_form_is_query_pay_status").val(queryPayStatusObjs[i].value);
        		}
        	}
        		
        	$("#expertFormId").submit();
        	
      	}
      	
    
      	//导入客户收益报表
      	function importExcel(){
      		var url = globalUtil.getHtml("excelUploadForMonthlyIncome.html");
       		dialog = $.ligerDialog.open({
       		    url: url,
       			title: '导入数据',
		        width: 500,
		        height: globalUtil.setDialogHeight(220),
		        onHiddenOrClose: function() {
		    	},
		        isResize: false
       		});      	
      	}
      	
      	/**
      	  * 点击单据编号跳转页面到单据详细信息页面
      	  */
      	function inveInfo(wms_inve_transa_id,wms_inve_transa_prod_id,user_id,inkey){
      		var status;
      		$.post(globalUtil.getTimestampUrl('/inve/wmsinvetransadSearchStatus.do'), 
     				{'wms_inve_transa_id': wms_inve_transa_id},
     		function(data) {
     			status = data;
     			if(status == "1" || status == "2" || status == "7" || status == "9" || status == "10"){
            		var url = globalUtil.getHtml("inve/addFinancialManagement.html?&user_id="+user_id+"&wms_inve_transa_id="+wms_inve_transa_id+"&wms_inve_transa_prod_id="+wms_inve_transa_prod_id+"&cktype=ck"+"&inkey="+inkey);
            	}else{
            		var url = globalUtil.getHtml("inve/addFinancialManagement.html?&zftype=zf&user_id="+user_id+"&wms_inve_transa_id="+wms_inve_transa_id+"&wms_inve_transa_prod_id="+wms_inve_transa_prod_id+"&cktype=ck"+"&inkey="+inkey);
            	}
     			globalUtil.openTab(10001, "理财详细信息", url, false);
     		});
      	}
        </script>
</body>
</html>