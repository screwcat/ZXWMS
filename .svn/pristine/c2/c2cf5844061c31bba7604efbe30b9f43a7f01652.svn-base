<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>房贷申请</title>
<link href="../../css/app.css" type="text/css" rel="stylesheet" />
<link href="../../css/zx-all.css" rel="stylesheet" type="text/css" />
<script src="../../js/zx-all.js" type="text/javascript"></script>
<style type="text/css">
.textright {
    text-align: right;
}

.textleft {
    text-align: left;
}
/*input_tb css*/
.input_tb_new {
    /*border:1px solid #dfdfdf;*/
    width: 100%;
    margin-bottom: 10px;
}

.input_tb_new a {
    color: #056aff;
    text-decoration: none;
    font-weight: normal;
}

.input_tb_new td {
    height: 35px;
    line-height: 25px;
    /*border-bottom:1px dashed #d5d5d5;*/
    padding-top: 3px;
}

.input_tb_new .tr_title td {
    background-color: #f5f8ff;
    padding-left: 16px;
    font-weight: bold;
    height: 30px;
    line-height: 30px;
    /*border-bottom:1px solid #dfdfdf;*/
}

.input_tb_new .tr_last td {
    border-bottom: 0;
}

.input_tb_new .title {
    text-align: right;
}

.input_tb_new .subtitle {
    text-align: left;
    background-color: #d2e1fd;
    border-top: 1px solid #fff;
    /*border-left:1px solid #fff;*/
}

.input_tb_new .tr_btn_input td {
    background-color: #fbfbfb;
    /*border-top:1px solid #dbdbdb;*/
    /*height:40px;*/
}

.title_tb {
    background-color: #f5f8ff;
    padding-left: 16px;
    font-weight: bold;
    height: 30px;
    line-height: 30px;
    /*border:1px solid #dfdfdf;8/
border-bottom:0;
}
.title_tb .title_txt{
float:left;
}
.title_tb .title_btn{
float:right;
margin-top:2px;
font-weight:normal;
}
.input_tb_new td {
    /*border-bottom: 1px dashed #D5D5D5;*/
    height: 35px;
    line-height: 25px;
    padding-top: 3px;
}

.data_tb td {
    height: 30px;
    line-height: 24px;
    padding-left: 10px;
    border-bottom: 1px dashed #e3e4e6;
    text-align: left;
}
</style>

<script type="text/javascript">
    var grid, toolbar, dialog, columns,griddyfc,columnsdyfc;//待人表格、工具栏、弹出子窗口
    var checkedCustomerAll;//所有的贷款人
    var griddata = {};
    var modifyJsonCus = new Array(); //modifyCreCustorm.html 客户信息修改页面 json数据  用于保存页面修改前修改后的数据。
    var nwid;//添加客户后生成的主键
    var nwidArr;//添加的客户的信息
    var enabledEditFlag=true;
    var isCommit = false;//是否已经按过了提交按钮
    var isZanCun = false;//是否已经按过了暂存按钮
    var grid_dyfc_data={};
    grid_dyfc_data.Rows=[{'house_use':'','house_no':'','house_vol_no':'','house_buy_date':'','house_buy_money':'','house_building_area':'','house_address':''}];
    var mcclhid='';//房产信息id
    var zdrID='';//记录主贷人
    griddata.Rows = [];
    var fileArr = [];//上传附件列表
    var fileArrkh = [];//上传客户信息附件列表
    var linkManPhone=[];//联系人电话
    var cshFlag=false;
    var infoCount = "0";//客户房贷单子数量
    var disabledCss = "disabledCss";
    var appro_limit;
    var p_wms_sys_dict_id = 91;
    var wms_sys_dict_id =  92;
    var wms_cre_credit_head_id=$.query.get('wms_cre_credit_head_id');
    //贷款信息的主表id
    $(function() {
        //globalUtil.clearLigerWhenScroll('waicengdiv');
        //判断是否是手机上传图片过来的单据 初始化业务员 baisong
        if(wms_cre_credit_head_id!=null&&wms_cre_credit_head_id!=""&&wms_cre_credit_head_id!="undefind"){
            initSalesman();
        }
        //------------------------------------------------获取贷款主表id进行数据的显示------------------------------------
        cshFlag=true;
        nwid=$.query.get('nwid');
        initGrid();
        init_att(); //初始化上传控件
        //客户信息toolbar
        var toolbarItemData = [];
        toolbarItemData.push({
            text : '新增',
            click: searchCustomer,
            icon : 'add'
        });
        toolbarItemData.push({
            line : true
        });
        toolbarItemData.push({
            text : '修改',
            click: modify,
            icon : 'modify'
        });
        toolbarItemData.push({
            line : true
        });
        toolbarItemData.push({
            text : '删除',
            click: deleteSelectedRow,
            icon : 'delete'
        });
        toolbarItemData.push({
            line : true
        });
        $("#centertoolbar").ligerToolBar({
            items : toolbarItemData
        });
        //抵押房产信息toolbar
        var toolbarItemDataDY = [];
        toolbarItemDataDY.push({
            text : '选择抵押房产信息',
            click: checkHouseForDY,
            icon : 'add'
        });
        $("#centertoolbardyfc").ligerToolBar({
            items : toolbarItemDataDY
        });
        
        var toolbarItemData2 = [];
        toolbarItemData2.push({
            text : '新增',
            click: addlinkmanbtn,
            icon : 'add'
        });
        $("#centertoolbar2").ligerToolBar({
            items : toolbarItemData2
        });
        init_dyfcgrid();
        init_cre_loan_type();//加载房产贷款产品类型
        addLinkTab();
        //初始化表格
        if(nwid){
            if(nwidArr&&grid){
                var isMaShowStr="主贷人："+nwidArr[0].customer_name;
                tab.addSubTab(isMaShowStr, 'houseCreditLinkMan.html', nwidArr[0].wms_cus_customer_id+'linktab', true);
            }
        }

    });
    
    function addLinkTab(){
         tab.initTabSub("allLinkManDiv", 400, -1);
         tab.tabObj.removeAll();
    }
    //初始化业务员信息
    function initSalesman(){
        $.get(globalUtil.getTimestampUrl('/loancheck/getHeadSalesman.do?wms_cre_credit_head_id='+wms_cre_credit_head_id), 
                null,
                  function(data) {
                    if(data){
                        $("#salesman_id").val(data.salesman_id);//业务员id
                        $("#salesman_code").val(data.salesman_code);//业务员工号
                        $("#salesman_name").val(data.salesman_name);//业务员姓名
                        $("#city").val(data.city);//城市
                        $("#salesman_shortcode").val(data.salesman_shortcode);//短工号
                        $("#salesman_city_code").val(data.salesman_city_code);//城市编码
                        $("#salesman_dept_id").val(data.salesman_dept_id);//部门id'
                    }
                });
    }
    var updateSltRow;
    var passJSONStr=new Array();
        //修改用户信息
     var modify=function (){
        //选择某一行的操作
        var row = grid.getSelectedRow();
        //判断是否为空    
        if (row == null) {
                globalUtil.warnMsg(globalErrorMsg['100000']);//请选择一行记录进行修改
                return;
        }
        updateSltRow=row;
        //可以获取改行的所有字段属性alert(row.status);//0代表暂存  1代表提交
        if(row.status==0 || row.status==1){
            //判断是否已经点击过修改功能
            var url = globalUtil.getHtml("modifyCreCustorm.html?wms_cus_customer_id="+row.wms_cus_customer_id+"&isma="+row.is_major);
            var len = modifyJsonCus.length;
            for(var i =len-1; i>=0; i--){
                var data = modifyJsonCus[i];
                if(row.wms_cus_customer_id == data.wms_cus_customer_id){
                    passJSONStr=data;
                    url = globalUtil.getHtml("modifyCreCustorm.html?datajson=1&isma="+row.is_major);
                    break;
                }
            }
            
            dialog = $.ligerDialog.open({
                url: url,
                title: '修改用户信息',
                width: 900,
                height: globalUtil.setDialogHeight(700),
                onHiddenOrClose: function(){
                },
                isResize: false
            });
        }else{
             globalUtil.warnMsg(globalErrorMsg['200200']);
             return;
        }
    };
    
    function passJSON(){
        return passJSONStr;
    }
    
    function addlinkmanbtn(){
        addlinkman(false);
    }
    
    //房屋贷款产品种类
    function init_cre_loan_type(json){
        var cre_loan_type_params ={
                dest_url:'/sysmanage/wmssysdictdatabydictidempty.do?isEmpty=true&wms_sys_dict_id=102',
                t_col_name:'cre_loan_type',
                valueField:'value_code',   //下拉框value对应的值，默认为id
                textField:'value_meaning',    //下拉框text对应的值，默认为text
                def_val:'first'
                };
        global_ligerui_extend.initCombox("cre_loan_type",null,cre_loan_type_params);
        if(json){
            //把值装载设定
            global_ligerui_extend.syncRequestInitComboxData(json,"cre_loan_type");
            //让其不可编辑
            global_ligerui_extend.disabledCombox("cre_loan_type");
            
        }else{          
            global_ligerui_extend.initComboxDefVal("cre_loan_type");
        }
    }
    
    
    
    function reCreType(){
        var cltstr=$("#cre_loan_type").val();
        var reStr='';
        if(cltstr=='房贷1号'||cltstr=='房贷2号'){
            reStr = '1';
        }else {
            reStr = '2';
        }
        return reStr;
    }   
    
    var ismjArr=[{"is_major":'1',"ismjval":"是"},{"is_major":'0',"ismjval":"否"}];
    //贷款客户表格初始化
    function initGrid() {
        columns = [ {
            display : '客户姓名',
            name : 'customer_name',
            width : 110,
            minWidth : 110,
            //添加超链接的东西
            render: function (rowdata, rowindex, value) { 
                if(rowdata.wms_cre_credit_line_customer_change_head_id){
                //实现根据变更用户主键id 获取其所有修改过后的信息
                return '<a href="javascript:customerInfo('+rowdata.wms_cre_credit_line_customer_change_head_id+');" style="color:#056AFF;text-decoration: none;">'+value+'</a>';                    
                }else{
                return value;                   
                }
            }
        }, {
            display : '身份证号',
            name : 'id_card',
            width : 160,
            minWidth : 160,
        }, {
            display: '是否主贷人',
            name: 'is_major',
            width: 90,
             editor: { 
                    type: 'select', // 该列为可编辑状态
                    data: ismjArr, 
                    valueField: 'is_major', 
                    textField: 'ismjval',
                    onChanged:ismajchged,
                    ext:{
                        onChangeValue: function(value){ // 单元格内容发生变化时的触发事件
                            
                        }
                    }   
                },
            render: function (rowdata, nowRowIndex, value, column) {
                    return global_ligerui_extend.gridRenderSelectedValue(rowdata, nowRowIndex, value, column);
            }
        }, {
            display: '电话号码1',
            name: 'mobile_telephone1',
            width: 130,
            minWidth: 130
        },{
            display: '电话号码2',
            name: 'mobile_telephone2',
            width: 130,
            minWidth: 130
        }, {
            display : '性别',
            name : 'gender',
            width : 40,
            minWidth : 40,
            render: function (rowdata,rowindex,value) { // 数据处理方法，不需处理时可去除
                if(value == 1){
                    value = "男";
                }else if(value == 0){
                    value = "女";
                }
                return value;
            }
        }, {
            display : '录入时间',
            name : 'create_timestamp',
            width : 160,
            minWidth : 160
        } ];

        if(nwid){
            zdrID=nwid;//主贷人ID
            var custData = globalUtil.syncGetJson('/cusmanage/wmscuscustomerheadinfovomapbypk.do',{
                'wms_cus_customer_id': nwid // 
                },'GET');
            var ctdtArr=[];
            custData.onCus.is_major='1';
            ctdtArr.push(custData.onCus);
            ctdtArr[0].create_timestamp=(new Date(ctdtArr[0].create_timestamp)).format('yyyy-MM-dd hh:mm:ss')
            var ctdtJH={};
            ctdtJH.Rows=ctdtArr
            grid = $("#grid").ligerGrid({
                data:ctdtJH,
                columns : columns,
                sortOrder:'asc', // 排序方式
                rownumbers : true,
                allowUnSelectRow : true,
                enabledEdit: enabledEditFlag,
                usePager : false,
                width : '100%',
                height : 160,
                heightDiff : -4,
                parms : {
                    _filterParms : -1
                }
            });
            nwidArr=ctdtArr;
        }else {
            grid = $("#grid").ligerGrid({
                columns : columns,
                sortOrder:'asc', // 排序方式
                rownumbers : true,
                allowUnSelectRow : true,
                enabledEdit: enabledEditFlag,
                usePager : false,
                width : '100%',
                height : 160,
                heightDiff : -4,
                parms : {
                    _filterParms : -1
                }
            });
        }
    }
    //修改客户信息后 更新贷款申请页显示的电话信息
    function changePhn1AndPhn2(ph1,ph2){
        var column1,column2, cellObj1,cellObj2, rowdata;
        column1 = grid.columns[4];//获得电话号码1列
        column2 = grid.columns[5];//获得电话号码2列
        cellObj1 = grid.getCellObj(updateSltRow, column1);
        cellObj2 = grid.getCellObj(updateSltRow, column2);
        grid.updateCell(cellObj1, ph1,updateSltRow);
        grid.updateCell(cellObj2, ph2,updateSltRow);
    }
    //修改客户信息后 更新贷款申请页显示的电话信息
    function changeIdCard(idCard,ger){
        var column,columng, cellObj,cellObjg;
        column = grid.columns[2];//获得电话号码1列
        columng = grid.columns[6];//获得电话号码1列
        cellObj = grid.getCellObj(updateSltRow, column);
        cellObjg = grid.getCellObj(updateSltRow, columng);
        grid.updateCell(cellObj,idCard,updateSltRow);
        grid.updateCell(cellObjg,ger,updateSltRow);
    }
    //是否是主贷人改变后  ry
    //改变主贷人为是时，其他用户的主贷人变为否
    var ismajchged=function(dom,val){
        var column, cellObj, rowdata;
        var ismaidold='',ismaidnew='';
        if(val=="1"){
            column = grid.columns[3];//获得主贷人列
            var gd=grid.getData();//获得grid数据
            for (var i = 0; i < gd.length; i++) {
                cellObj = grid.getCellObj(grid.rows[i], column);
                if(dom!=cellObj){
                    if(grid.rows[i].is_major=="1"){
                        ismaidold=grid.rows[i].wms_cus_customer_id;
                    }
                    grid.updateCell(cellObj, '0',gd[i]);//将其他的都变为不是主贷人
                }else {
                    ismaidnew=grid.rows[i].wms_cus_customer_id;
                }
            }
            $("li[tabid=" + ismaidold + "linktab]",  $("#allLinkManDiv").ligerGetTabManager().tab.links.ul).find("a :first").text(function(n,t){
                return t.replace("主贷人","共同贷款人");
            });
            $("li[tabid=" + ismaidnew + "linktab]",  $("#allLinkManDiv").ligerGetTabManager().tab.links.ul).find("a :first").text(function(n,t){
                return t.replace("共同贷款人","主贷人");
            });
            //改变tab位置，将主贷人移至第一个
            moveZDRTabToFirst(ismaidnew+"linktab");
            zdrID=grid.getRow($(dom).parent()[0]).wms_cus_customer_id;//改变主贷人Id
            checkHouseInfoWhIsmajChanged(zdrID);//更改主贷人，调用更改抵押房产信息
        }else {
            var allflsFlag=false;
            column = grid.columns[3];//获得主贷人列
            var gd=grid.getData();//获得grid数据
            for (var i = 0; i < gd.length; i++) {
                if(grid.getRow(i).is_major=="1"){
                    allflsFlag=true;
                    break;
                }
            }
            if(!allflsFlag){
                zdrID='';
                checkHouseInfoWhIsmajChanged('');
            }
            var tsrow = $(dom).parent();
            var tsrowdata = grid.getRow(tsrow[0]);
            $("li[tabid=" + tsrowdata.wms_cus_customer_id + "linktab]",  $("#allLinkManDiv").ligerGetTabManager().tab.links.ul).find("a :first").text(function(n,t){
                return t.replace("主贷人","共同贷款人");
            });
        }
        
        getWmsCreCreditHeadInfo(grid.getData());
    }
    
    //将主贷人tab移至第一个
    function moveZDRTabToFirst(zdTabID){
        var newZDRIndex=$("#allLinkManDiv").ligerGetTabManager().tab.links.ul.find(">li[tabid=" + zdTabID +"]").index();
        var lastIndex=$("#allLinkManDiv").ligerGetTabManager().tab.links.ul.find(">li").last().index();
        if(newZDRIndex!=0&&(newZDRIndex!=lastIndex)){
            for (var tabI = newZDRIndex; tabI > 0; tabI--) {
                var to=$("#allLinkManDiv").ligerGetTabManager().tab.links.ul.find(">li").last();
                var from=$("#allLinkManDiv").ligerGetTabManager().tab.links.ul.find(">li").eq(tabI-1);
                to.after(from);
            }
        }else if (newZDRIndex!=0&&(newZDRIndex==lastIndex)) {
            var from=$("#allLinkManDiv").ligerGetTabManager().tab.links.ul.find(">li").last();
            var to=$("#allLinkManDiv").ligerGetTabManager().tab.links.ul.find(">li").eq(0);
            to.before(from);
        }
    }
    
    //更改主贷人时，查询房产信息
    function checkHouseInfoWhIsmajChanged(mccidnwchged){
        //现将抵押房产信息grid第一行更新
        griddyfc.updateRow(0,{'house_use':'','house_no':'','house_vol_no':'','house_buy_date':'','house_buy_money':'','house_building_area':'','house_address':''});
        if(mccidnwchged!=''){
            var len = modifyJsonCus.length;//得到手动更改的客户信息的数量
            var isInModJsonStr=false;//标记主贷人是否在手动更改的客户信息里
            //如果有更改的客户信息
            if(len>0){
                for(var i =len-1; i>=0; i--){
                    var data = modifyJsonCus[i];
                    if(mccidnwchged == data.wms_cus_customer_id){
                        isInModJsonStr=true;
                        var harr=JSON.parse(data.housestr)
                        //如果在 并且只有一条房产信息 则更新抵押房产信息
                        if(harr.length==1){
                            mcclhid=harr[0].wms_cus_customer_line_houseinfo_id;
                            harr[0].house_address=harr[0].house_address_province+"省  "+harr[0].house_address_city+"市  "+harr[0].house_address_district+"区  "+harr[0].house_address_more;
                            griddyfc.updateRow(0,harr[0]); 
                        }else {
                            mcclhid='';
                        }
                        break;
                    }
                }
                //如果不在，则查询数据库中该客户的房产信息
                if(!isInModJsonStr){
                    var queryHSData = globalUtil.syncGetJson('/cusmanage/wmscuscustomerlinehouseinfowithoutpaginglist.do',{
                        'wms_cus_customer_id': mccidnwchged // 
                        },'GET');
                    if(queryHSData.Rows.length==1){
                        mcclhid=queryHSData.Rows[0].wms_cus_customer_line_houseinfo_id;
                        queryHSData.Rows[0].house_address=queryHSData.Rows[0].house_address_province+"省 "+queryHSData.Rows[0].house_address_city+"市  "+queryHSData.Rows[0].house_address_district+"区   "+queryHSData.Rows[0].house_address_more;
                        griddyfc.updateRow(0,queryHSData.Rows[0]); 
                    }else {
                        mcclhid='';
                    }
                }
            }else {
                //如果没有修改过的客户，则查询数据库中的记录
                var queryHSData = globalUtil.syncGetJson('/cusmanage/wmscuscustomerlinehouseinfowithoutpaginglist.do',{
                    'wms_cus_customer_id': mccidnwchged // 
                    },'GET');
                if(queryHSData.Rows.length==1){
                    mcclhid=queryHSData.Rows[0].wms_cus_customer_line_houseinfo_id;
                    queryHSData.Rows[0].house_address=queryHSData.Rows[0].house_address_province+"省 "+queryHSData.Rows[0].house_address_city+"市  "+queryHSData.Rows[0].house_address_district+"区   "+queryHSData.Rows[0].house_address_more;
                    griddyfc.updateRow(0,queryHSData.Rows[0]); 
                }else {
                    mcclhid='';
                }
            }
        }else {
            mcclhid='';
        }
        
    }
    
    //更改抵押房产信息grid显示数据
    function changeDYFCXXShow(mcclhIDChange){
        //如果参数是string类型的
        if(typeof (mcclhIDChange) == "string"){
            mcclhid=mcclhIDChange;//更改房产信息ID
            //更新抵押房产信息
            griddyfc.updateRow(0,{'house_no':'','house_vol_no':'','house_buy_date':'','house_buy_money':'','house_building_area':'','house_address':''});
            var len = modifyJsonCus.length;
            //判断修改过的客户信息数量
            if(len>0){
                var isInModifyJson=false;
                for(var i =len-1; i>=0; i--){
                    var data = modifyJsonCus[i];
                    //如果有  并且有主贷人的
                    if(zdrID == data.wms_cus_customer_id){
                        isInModifyJson=true;
                        var harr=JSON.parse(data.housestr)
                        for (var j = 0; j < harr.length; j++) {
                            //判断是否修改该房产信息
                            if(harr[j].wms_cus_customer_line_houseinfo_id==mcclhIDChange){
                                harr[j].house_address=harr[j].house_address_province+"省 "+harr[j].house_address_city+"市  "+harr[j].house_address_district+"区   "+harr[j].house_address_more;
                                griddyfc.updateRow(0,harr[j]);
                                break;
                            }
                        }
                        break;
                    }
                }
                if(!isInModifyJson){
                    //如果没有则查询数据库中的记录
                    var queryHSData = globalUtil.syncGetJson('/cusmanage/wmscuscustomerlinehouseinfowithoutpaginglist.do',{
                        'wms_cus_customer_line_houseinfo_id': mcclhIDChange // 
                        },'GET');
                    for (var j = 0; j < queryHSData.Rows.length; j++) {
                        if(queryHSData.Rows[j].wms_cus_customer_line_houseinfo_id==mcclhIDChange){
                            //更新抵押房产信息
                            queryHSData.Rows[j].house_address=queryHSData.Rows[j].house_address_province+"省 "+queryHSData.Rows[j].house_address_city+"市  "+queryHSData.Rows[j].house_address_district+"区   "+queryHSData.Rows[j].house_address_more;
                            griddyfc.updateRow(0,queryHSData.Rows[j]);
                            break;
                        }
                    }
                }
            }else {
                //如果没有则查询数据库中的记录
                var queryHSData = globalUtil.syncGetJson('/cusmanage/wmscuscustomerlinehouseinfowithoutpaginglist.do',{
                    'wms_cus_customer_line_houseinfo_id': mcclhIDChange // 
                    },'GET');
                for (var j = 0; j < queryHSData.Rows.length; j++) {
                    if(queryHSData.Rows[j].wms_cus_customer_line_houseinfo_id==mcclhIDChange){
                        //更新抵押房产信息
                        queryHSData.Rows[j].house_address=queryHSData.Rows[j].house_address_province+"省 "+queryHSData.Rows[j].house_address_city+"市  "+queryHSData.Rows[j].house_address_district+"区   "+queryHSData.Rows[j].house_address_more;
                        griddyfc.updateRow(0,queryHSData.Rows[j]);
                        break;
                    }
                }
            }
        } else if (typeof (mcclhIDChange) == "object"){
            //如果参数是object，则是修改用户信息回调
            var objchagFlag=false;//标记是否删除该房产信息
            if(mcclhIDChange.length>0){
                if(mcclhid!=''){
                    for (var j = 0; j < mcclhIDChange.length; j++) {
                        if(mcclhIDChange[j].wms_cus_customer_line_houseinfo_id==mcclhid){
                            objchagFlag=true;
                            griddyfc.updateRow(0,{'house_no':'','house_vol_no':'','house_buy_date':'','house_buy_money':'','house_building_area':'','house_address':''});
                            mcclhIDChange[j].house_address=mcclhIDChange[j].house_address_province+"省 "+mcclhIDChange[j].house_address_city+"市  "+mcclhIDChange[j].house_address_district+"区   "+mcclhIDChange[j].house_address_more;
                            griddyfc.updateRow(0,mcclhIDChange[j]);
                            break;
                        }
                    }
                }else {
                    if(mcclhIDChange.length==1){
                        objchagFlag=true;
                        mcclhid=mcclhIDChange[0].wms_cus_customer_line_houseinfo_id;
                        griddyfc.updateRow(0,{'house_no':'','house_vol_no':'','house_buy_date':'','house_buy_money':'','house_building_area':'','house_address':''});
                        mcclhIDChange[0].house_address=mcclhIDChange[0].house_address_province+"省 "+mcclhIDChange[0].house_address_city+"市  "+mcclhIDChange[0].house_address_district+"区   "+mcclhIDChange[0].house_address_more;
                        griddyfc.updateRow(0,mcclhIDChange[0]);
                    }
                }
            }else {
                //如果都删除了，则更新抵押房产信息为空
                mcclhid='';
                griddyfc.updateRow(0,{'house_use':'','house_no':'','house_vol_no':'','house_buy_date':'','house_buy_money':'','house_building_area':'','house_address':''});
            }
            if(!objchagFlag){
                //如果该条房产删除了，则更新抵押房产信息为空
                mcclhid='';
                griddyfc.updateRow(0,{'house_use':'','house_no':'','house_vol_no':'','house_buy_date':'','house_buy_money':'','house_building_area':'','house_address':''});
            }
        } 
    }
    function changeDYCCXXShow(){}
    
    //抵押房产信息初始化
    function init_dyfcgrid(){
        columnsdyfc = [{
            display: '抵押房产用途',
            name: 'house_use',
            align: 'left', // 默认居中
            width: 200,
            minWidth: 200,
            editor: { type: 'text',maxlength:250 }
        },{
            display: '房产证号',
            name: 'house_no',
            align: 'left', // 默认居中
            width: 100,
            minWidth: 100
        },{
            display: '房产卷号',
            name: 'house_vol_no',
            align: 'left', // 默认居中
            width: 100,
            minWidth: 100
        },{
            display: '购买时间',
            name: 'house_buy_date',
            align: 'left', // 默认居中
            width: 100,
            minWidth: 100,
            type: 'date', 
            format: 'yyyy-MM-dd'
        },{
            display: '购买金额（万元）',
            name: 'house_buy_money',
            align: 'left', // 默认居中
            width: 110,
            minWidth:100
        },{
            display: '建筑面积（平方米）',
            name: 'house_building_area',
            align: 'left', // 默认居中
            width: 110,
            minWidth: 110
        },{
            display: '详细地址',
            name: 'house_address',
            align: 'left', // 默认居中
            width: 200,
            minWidth: 200
        }];
        
        griddyfc = $("#griddyfc").ligerGrid({ // maingrid为表格div所在id
            data:grid_dyfc_data,
            columns: columnsdyfc,
            allowAdjustColWidth:false,
            allowUnSelectRow: true, // 是否允许反选列，可编辑表格不可反选，查询可反选（如上下表格联动时），默认为false
            usePager: false, // 是否分页支持，默认为true
            rownumbers: true,
            width: '100%',
            height:100,
            heightDiff: -4,
            enabledEdit: true
        });
        if(nwid){
            checkHouseInfoWhIsmajChanged(nwid);
        }
    }
    
    //选择抵押房产信息
    var checkHouseForDY=function(){
        var url = globalUtil.getHtml("checkDYHouseForCredit.html?zdrId="+zdrID+"&mcclhid="+mcclhid);
        var len = modifyJsonCus.length;
        for(var i =len-1; i>=0; i--){
            var data = modifyJsonCus[i];
            if(zdrID == data.wms_cus_customer_id){
                url = globalUtil.getHtml("checkDYHouseForCredit.html?datajson="+JSON.stringify(data)+"&mcclhid="+mcclhid);
                break;
            }
        }
        //打开房产信息选择页面
        dialog = $.ligerDialog.open({
            url: url,
            title: '房产信息',
            width: 850,
            height: globalUtil.setDialogHeight(350),
            isResize: false
        });
    }
    
    //查看用户变更后的页面信息
    function customerInfo(wms_cre_credit_line_customer_change_head_id){
        var url = globalUtil.getHtml("checkCreCustorm.html?wms_cre_credit_line_customer_change_head_id="+wms_cre_credit_line_customer_change_head_id+"&cktype=ck");
        dialog = $.ligerDialog.open({
            url: url,
            title: '客户变更信息',
            width: 900,
            height: globalUtil.setDialogHeight(450),
            onHiddenOrClose: function(){
            },
            isResize: false
        });
    }
    
    //打开选择贷款客户界面
    var scfcDialog;
    function searchCustomer(){
        clearLigerTip('dkinfo');
        var url = globalUtil.getHtml("searchCustomerForCredit.html");
        scfcDialog = $.ligerDialog.open({
            url: url,
            title: '选择贷款客户',
            width: 1000,
            height: globalUtil.setDialogHeight(600),
            isResize: false
        });
    };
    // 移除行数据，前台移除，需要选择行，无确认提示（可根据业务增加）
    function deleteSelectedRow() {
        var row = grid.getSelectedRow();
        if (!row) {
            globalUtil.warnMsg(globalErrorMsg['100001']); //请选择一行记录进行删除
            return;
        }
        
        globalUtil.confirmMsg(globalErrorMsg['100016'],
        function(yes) { //确认删除
            if(yes){
                global_ligerui_extend.deleteSelectedRow(grid); // grid-表格对象
                if(row['is_major']=='1'){
                    $("#is_xudai").val("0");
                    xudaiChange();
                    zdrID='';
                    checkHouseInfoWhIsmajChanged(zdrID);
                }
                var len = modifyJsonCus.length;
                for(var i =len-1; i>=0; i--){
                    var data = modifyJsonCus[i];
                    if(row.wms_cus_customer_id == data.wms_cus_customer_id){
                        modifyJsonCus.splice(i);
                        break;
                    }
                }
                removeOtherTab(row.wms_cus_customer_id+'linktab');
            }
        });
        
    };
    
    function removeOtherTab(tabId) {
        $("#allLinkManDiv").ligerGetTabManager().removeTabItem(tabId);
    }
    
    var wmsCusCustomerId = new Array();
    
    /*
    选择客户后的回调页面
    */
    function getCheckedCustomerAll(data){
        var data_all = grid.getData();
        var data_add = [];
        for(var j = 0;j<data.length;j++){
            var ishave = false;
            for(var i=0;i<data_all.length;i++){
                if(data_all[i].wms_cus_customer_id == data[j].wms_cus_customer_id){
                    ishave = true;
                    break;
                }
            }
            if(!ishave){
                var isMaFlag=false;
                if(data_all.length==0){
                    if(j==0){
                        data[j]["is_major"]='1';
                        isMaFlag=true;
                        zdrID=data[j]['wms_cus_customer_id'];
                        checkHouseInfoWhIsmajChanged(zdrID);
                    }else
                        data[j]["is_major"]='0';
                }else {
                    data[j]["is_major"]='0';
                }
                data_add.push(data[j]);
                var isMaShowStr='';
                if(isMaFlag){
                    isMaShowStr="主贷人："+data[j].customer_name;
                }else{
                    isMaShowStr="共同贷款人："+data[j].customer_name;
                }
                tab.addSubTab(isMaShowStr, 'houseCreditLinkMan.html', data[j].wms_cus_customer_id+'linktab', true);
            }
            //志刚说不管怎么添加默认tab页都为主贷人的
            $("#allLinkManDiv").ligerGetTabManager().selectTabItem (zdrID + 'linktab');
        }
        global_ligerui_extend.addRows(grid, data_add);
        
        getWmsCreCreditHeadInfo(grid.getData());
        
    };
    
    //客户变更（主贷人变更），是否续贷变更
    function getWmsCreCreditHeadInfo(data) {
        var hasMajor = false;
        appro_limit = "";
        if($("#is_xudai").val() == "1") {
            $.each(data, function(i, n) {
                if(n.is_major == "1") {//主贷人
                    hasMajor = true;
                    var wmsCusCustomerInfo = globalUtil.syncGetJson('/cremanage/getwmscrecreditheadinfobycusid.do',{
                        'wms_cus_customer_id': n.wms_cus_customer_id 
                        },'POST');
                    if(wmsCusCustomerInfo != null) {
                        $("#main_t").find("input").each(function(i, n) {
                            var datakey = $(this).attr("id");
                            if(wmsCusCustomerInfo[datakey] != null) {
                                if(datakey == "salesman_name") {//业务员
                                    var salesmanName = wmsCusCustomerInfo[datakey]+"/"+wmsCusCustomerInfo["salesman_shortcode"];
                                    $(this).val(salesmanName);
                                } else if(datakey == "cre_loan_type") {//下拉框单独处理
                                    global_ligerui_extend.setComboxVal("cre_loan_type",wmsCusCustomerInfo[datakey]);
                                    //global_ligerui_extend.disabledCombox("cre_loan_type");
                                } else {
                                    $(this).val(wmsCusCustomerInfo[datakey]);
                                }
                            } 
                            
                            if(wmsCusCustomerInfo["appro_limit"] != null) {
                                appro_limit = wmsCusCustomerInfo["appro_limit"];
                            }
                        });
                        //cre_loan_type处理可能导致费率根据onchange事件变更，这里单独做处理。如果费率等不为空，则重新赋值
                        if(wmsCusCustomerInfo["loan_interest_rate"] != null || wmsCusCustomerInfo["commission_rate"] != null || 
                                wmsCusCustomerInfo["commission_fee"] != null || wmsCusCustomerInfo["commission_fee"] != "0") {
                            $("#loan_interest_rate").val(wmsCusCustomerInfo["loan_interest_rate"]);
                            $("#commission_rate").val(wmsCusCustomerInfo["commission_rate"]);
                            $("#commission_fee").val(wmsCusCustomerInfo["commission_fee"]);
                        } 
                        
                        infoCount = wmsCusCustomerInfo.info_count;
                        //如果客户房贷单据大于1，可手动修改；如果客户房贷单据等于1，不可手动修改，并且默认不给appro_limit赋值
                        if(infoCount == "1") {
                            $("#main_t").find("input:not(:disabled)").addClass(disabledCss);
                            $("."+disabledCss).attr("disabled","disabled");
                            $("#searchPersonnelId").hide();
                        } else {
                            appro_limit = "";
                        }
                    } else {
                        //用户无房贷产品，是否续贷请选择否
                        globalUtil.errorMsg(globalErrorMsg['300119']);
                        $("#is_xudai").val("0");
                        $("#commission_rate").val("");
                        $("#commission_fee").val("");
                        /* $("#main_t").find("input").val("");
                        $("#cre_loan_type").val("'请选择'");
                        global_ligerui_extend.setComboxVal("cre_loan_type","-1"); */
                        $("."+disabledCss).removeAttr("disabled");
                        $("#main_t").find("input").removeClass(disabledCss);
                        $("#searchPersonnelId").show();
                    }
                } 
            });
            if(!hasMajor) {//没有主贷人
                globalUtil.errorMsg(globalErrorMsg['300120']);
                $("#is_xudai").val("0");
                $("#commission_rate").val("");
                $("#commission_fee").val("");
                //清空带出的数据
                $("."+disabledCss).removeAttr("disabled");
                $("#main_t").find("input").removeClass(disabledCss);
                $("#searchPersonnelId").show();
                /* $("#main_t").find("input").val("");
                $("#cre_loan_type").val("'请选择'");
                global_ligerui_extend.setComboxVal("cre_loan_type","-1"); */
            }
        } 
    }
    
    //判断是否是续贷
    function isXuDai() {
        if($("#is_xudai").val() == "1") {
            return true;
        } else {
            return false;
        }
    }
    
    //清空费率
    function resetRate() {
        $("#loan_interest_rate").val("");
        $("#commission_rate").val("");
        $("#commission_fee").val("");
    }
    
    //计算金额
    function sumMoney() {
        var creLoanType = $("#cre_loan_type_hidden").val();
        //var data = globalUtil.syncGetJson('/sysmanage/wmssysgetajaxrequest.do',{
    	var data = {};
    	var max_repayment_time_limit=$("#max_repayment_time_limit").val();//贷款期数
    	var credit_limit=$("#credit_limit").val();//贷款金额
        if(globalUtil.getCreType(creLoanType)) {//creLoanType
        	data =globalUtil.syncGetJson('/loanappro/getprotocolProperty.do',{  
                'cre_loan_type': creLoanType,
                'borrow_deadline': max_repayment_time_limit,
                'credit_limit': credit_limit
                },'GET');
        	 if(!$.isEmptyObject(data)&&!$.isEmptyObject(data["newFD"])) {        	
                 var obj =data["newFD"];
                 //贷款利率
                 if(obj["borrow_interest"]!=null&&obj["borrow_interest"]!=''&&obj["borrow_interest"]!=undefined){
                	 $("#loan_interest_rate").val(Math.round(obj["borrow_interest"]*100)/100);
                 }
                 if(isXuDai()) {
                	 //手续费利率
                     if(!$.isEmptyObject(obj["protocol_fees"])){
                    	 $("#commission_rate").val(Math.round(obj["protocol_fees"]*100)/100);
                     }
                     //手续费
                     if(!$.isEmptyObject(obj["protocol_fees"])&&!$.isEmptyObject($("#credit_limit").val())){
                    	 $("#commission_fee").val(Math.round(obj["protocol_fees"]*$("#credit_limit").val()*10000)/100);
                     }
                 } else {
                     $("#commission_rate").val("");//手续费率
                     $("#commission_fee").val("");//手续费
                 }
             } else {
                 resetRate();
             }
            //绑定还款期限事件（只能绑定一次）
            $("#max_repayment_time_limit").die().live("focusout", function() {
            	sumMoney()
            });
            
            
        } else {
     			data = globalUtil.syncGetJson('/sysmanage/wmssysgetajaxrequest.do',{
                 'cre_loan_type': creLoanType
                },'GET');
            //取消绑定
            $("#max_repayment_time_limit").die();
            
            if(!$.isEmptyObject(data)) {
                $("#loan_interest_rate").val(Math.round(data["FD_DKLL"]*100*100)/100);
                if(isXuDai()) {
                    $("#commission_rate").val(Math.round(data["FD_PTFL"]*100*100)/100);
                    $("#commission_fee").val(Math.round(data["FD_PTFL"]*100*$("#credit_limit").val()*10000)/100);
                } else {
                    $("#commission_rate").val("");
                    $("#commission_fee").val("");
                }
            } else {
                resetRate();
            }
        }
    }
    
    //产品变更
    function creTypeChange(){
        
        if($("#cre_loan_type_hidden").val() == "785" || $("#cre_loan_type_hidden").val() == "786") {
            resetRate();
        }
        sumMoney();
    }
    
    //是否续贷变更
    function xudaiChange() {
        var xudaiVal = $("#is_xudai").val();
        if(xudaiVal == "1") {
            //将带出的数据传入:1条并设置成不可修改，多条并设置成可修改并在提交的时候提示
            getWmsCreCreditHeadInfo(grid.getData());
            sumMoney();
        } else if(xudaiVal == "0") {
            //清空带出的数据
            $("."+disabledCss).removeAttr("disabled");
            $("#main_t").find("input").removeClass(disabledCss);
            $("#searchPersonnelId").show();
            $("#main_t").find("input").val("");
            $("#cre_loan_type").val("'请选择'");
            global_ligerui_extend.setComboxVal("cre_loan_type","-1");
            appro_limit = "";
        }
    }
    
    function forTabSJ(mcclcchid){
        var tabArrCD=[];
        for (var taIndex = 0; taIndex < tabLinkArrAll.length; taIndex++) {
            if(tabLinkArrAll[taIndex]['wms_cre_credit_line_customer_change_head_id']==mcclcchid){
                tabArrCD=tabArrCD.concat(tabLinkArrAll[taIndex]);
            }
        }
        return tabArrCD;
    }
    
    //提交房贷信息
    function submitInfo(str){
        var jsonStr;
        grid.endEdit();
        var data_all = grid.getData();
        griddyfc.endEdit();
        var data_all_house = griddyfc.getData();
        if(str == 1){
            isCommit=true;
            isZanCun = false;//设置未按过暂存按钮
            if($('#dkinfo').css('display')!='none'){
                globalUtil.clearLigerTip("dkinfo");
                if(globalVali.checkForm("dkinfo", true)){   
                    return;             
                }
            }
            else if($('#cspginfo').css('display')!='none'){
                globalUtil.clearLigerTip("cspginfo");
                if(globalVali.checkForm("dkinfo", true)){
                    globalUtil.clearLigerTip("dkinfo");
                    $('#tabbody1').trigger('click');
                    globalVali.checkForm("dkinfo", true);
                    return;
                }
            }
            globalUtil.clearLigerTip("dkinfo");
            /*
            if(fileArr.length==0){
                $('#tabbody2').trigger('click');
                globalUtil.errorMsg(globalErrorMsg['300112']);
                return;
            }
            */
            jsonStr = globalUtil.getFormParam('main_t');//input text 取值
            //如果业务员选项不为空进行把值处理存储人jsonStr
            if($("#salesman_name").val()!=''){
                jsonStr.salesman_name=$("#salesman_name").val().split("/")[0];
                jsonStr.salesman_shortcode=$("#salesman_name").val().split("/")[1];
            }
            //判断选择的贷款客户信息正确与否
            
            if(data_all.length==0){
                $('#tabbody1').trigger('click');
                globalUtil.errorMsg(globalErrorMsg['300104']);
                return;
            }else {
                var ismjFlag=false;
                var ismjCount=0;
                for(var i=0;i<data_all.length;i++){
                    if(data_all[i]["is_major"]=='1'){
                        ismjFlag=true;
                        ismjCount++;
                    }
                }
                if(!ismjFlag){
                    $('#tabbody1').trigger('click');
                    globalUtil.errorMsg(globalErrorMsg['300106']);
                    return;
                }else if (ismjCount>1) {
                    $('#tabbody1').trigger('click');
                    globalUtil.errorMsg(globalErrorMsg['300105']);
                    return;
                }
            }
            //判断抵押房产信息填写全否
            
            if(data_all_house[0].house_use==''){
                $('#tabbody1').trigger('click');
                globalUtil.errorMsg(globalErrorMsg['300110']);
                return;
            }
            if(mcclhid==''){
                $('#tabbody1').trigger('click');
                globalUtil.errorMsg(globalErrorMsg['300110']);
                return;
            }
            jsonStr.mcclhid=mcclhid;//房产信息id
            jsonStr.zdrID=zdrID;
            jsonStr.house_use=data_all_house[0].house_use;
        }else if(str == 0) {
            isCommit=false;
            isZanCun = true;//设置未按过暂存按钮
            if($('#dkinfo').css('display')!='none'){
                globalUtil.clearLigerTip("dkinfo");
                if(globalVali.checkForm("dkinfo", false)){  
                    return;             
                }
            }
            else if($('#cspginfo').css('display')!='none'){
                globalUtil.clearLigerTip("cspginfo");
                if(globalVali.checkForm("dkinfo", false)){
                    globalUtil.clearLigerTip("dkinfo");
                    $('#tabbody1').trigger('click');
                    globalVali.checkForm("dkinfo", false);
                    return;
                }
            }
            globalUtil.clearLigerTip("dkinfo");
            /*
            if(fileArr.length==0){
                $('#tabbody2').trigger('click');
                globalUtil.errorMsg(globalErrorMsg['300112']);
                return;
            }
            */
            jsonStr = globalUtil.getFormParam('main_t');//input text 取值
            //如果业务员选项不为空进行把值处理存储人jsonStr
            if($("#salesman_name").val()!=''){
                jsonStr.salesman_name=$("#salesman_name").val().split("/")[0];
                jsonStr.salesman_shortcode=$("#salesman_name").val().split("/")[1];
            }
            //判断选择的贷款客户信息正确与否
            
            var ismjFlag=false;
            var ismjCount=0;
            for(var i=0;i<data_all.length;i++){
                if(data_all[i]["is_major"]=='1'){
                    ismjFlag=true;
                    ismjCount++;
                }
            }
            if (ismjCount>1) {
                $('#tabbody1').trigger('click');
                globalUtil.errorMsg(globalErrorMsg['300105']);
                return;
            }
            jsonStr.mcclhid=mcclhid;//房产信息id
            jsonStr.zdrID=zdrID;
            jsonStr.house_use=data_all_house[0].house_use;
        }else if(str == 2) {// 2016-4-5 因为贷款必填项需求变更 现在需要去除不必要的必填项 贷款基本信息 是必填 房产信息是非必填 联系人非必填
            isCommit=true;
            isZanCun = false;//设置未按过暂存按钮
            if($('#dkinfo').css('display')!='none'){
                globalUtil.clearLigerTip("dkinfo");
                if(globalVali.checkForm("dkinfo", true)){   
                    return;             
                }
            }
            else if($('#cspginfo').css('display')!='none'){
                globalUtil.clearLigerTip("cspginfo");
                if(globalVali.checkForm("dkinfo", true)){
                    globalUtil.clearLigerTip("dkinfo");
                    $('#tabbody1').trigger('click');
                    globalVali.checkForm("dkinfo", true);
                    return;
                }
            }
            globalUtil.clearLigerTip("dkinfo");
            /*
            if(fileArr.length==0){
                $('#tabbody2').trigger('click');
                globalUtil.errorMsg(globalErrorMsg['300112']);
                return;
            }
            */
            jsonStr = globalUtil.getFormParam('main_t');//input text 取值
            //如果业务员选项不为空进行把值处理存储人jsonStr
            if($("#salesman_name").val()!=''){
                jsonStr.salesman_name=$("#salesman_name").val().split("/")[0];
                jsonStr.salesman_shortcode=$("#salesman_name").val().split("/")[1];
            }
            //判断选择的贷款客户信息正确与否
            
            if(data_all.length==0){
                $('#tabbody1').trigger('click');
                globalUtil.errorMsg(globalErrorMsg['300104']);
                return;
            }else {
                var ismjFlag=false;
                var ismjCount=0;
                for(var i=0;i<data_all.length;i++){
                    if(data_all[i]["is_major"]=='1'){
                        ismjFlag=true;
                        ismjCount++;
                    }
                }
                if(!ismjFlag){
                    $('#tabbody1').trigger('click');
                    globalUtil.errorMsg(globalErrorMsg['300106']);
                    return;
                }else if (ismjCount>1) {
                    $('#tabbody1').trigger('click');
                    globalUtil.errorMsg(globalErrorMsg['300105']);
                    return;
                }
            }
            jsonStr.mcclhid=mcclhid;//房产信息id
            jsonStr.zdrID=zdrID;
            jsonStr.house_use=data_all_house[0].house_use;
        }
        //取消检查共贷人亲属、朋友是否重复的校验，改为由业务员线下控制。
        /*var qspyFlag=checkQSAndPY(str);
        if(typeof(qspyFlag) == "string"){
            globalUtil.errorMsg(qspyFlag);
            return;
        }*/
        var linkManAllInfoArr=[];
        for(var gind=0;gind<data_all.length;gind++){
            var mccidone=data_all[gind]['wms_cus_customer_id'];
            var tabWindow=document.getElementById(mccidone+'linktab').contentWindow;
            var tabArr=tabWindow.getlinkmaninfo(mccidone,data_all[gind]['customer_name'],data_all[gind]['is_major'],str);
            if(typeof(tabArr) == "object"){
                linkManAllInfoArr=linkManAllInfoArr.concat(tabArr);
            }else if(typeof(tabArr) == "string"){
                if(tabArr == "phonewrong"){
                    globalUtil.errorMsg("客户："+data_all[gind]['customer_name']+" 的联系人电话有错误，请修改！");
                }else if (tabArr == "dhcf") {
                    globalUtil.errorMsg("客户："+data_all[gind]['customer_name']+" 的联系人电话有重复，请修改！");
                }
                $("#allLinkManDiv").ligerGetTabManager().selectTabItem (mccidone+'linktab');
                $('#tabbody1').trigger('click');
                return;
            }else if(typeof(tabArr) == 'boolean'){
                globalUtil.errorMsg("客户："+data_all[gind]['customer_name']+" 的联系人信息不完整，请补全！");
                $("#allLinkManDiv").ligerGetTabManager().selectTabItem (mccidone+'linktab');
                $('#tabbody1').trigger('click');
                return;
            }
        }
        jsonStr.linkmaninfo = JSON.stringify(linkManAllInfoArr);//联系人信息
        jsonStr.personArr = getPersonInfo();//贷款人
        jsonStr.modifyJsonCus = JSON.stringify(modifyJsonCus);//修改后客户信息的数据
        jsonStr.fileArr = JSON.stringify(fileArr);//附件
        jsonStr.fileArrkh = JSON.stringify(fileArrkh);//客户信息附件
        if(str=='1'||str=='2'){
            jsonStr.isComOrZC=1;
        }else{
            jsonStr.isComOrZC=str;
        }
        jsonStr.is_xudai = $("#is_xudai").val();
        jsonStr.wms_cre_credit_head_id=wms_cre_credit_head_id;//贷款主表主键
        if(appro_limit != null && appro_limit != "") {
            jsonStr.appro_limit = appro_limit;
        }
        
        $("#tb_btn").css("display","none");//隐藏按钮 
        
         if((str == 1||str == 2 )&& parseInt(infoCount) > 1) {
            $.ligerDialog.confirm(globalErrorMsg['300121'],
                    function(yes) {
                        if (yes) {
                            $("#tjbtn").hide();
                            
                            $.ajax({ 
                                type: "POST", 
                                url: global_param.context_name + "/cremanage/wmscrecreditheadhousecresave.do",
                                async: false,
                                dataType: "json",
                                data: jsonStr, 
                                traditional: true,
                                success: function(data) {
                                	$("#tjbtn").show();
                                    if (data === 'OK') {
                                        globalUtil.successMsg(globalErrorMsg['100002'],//保存成功
                                            function() {
                                                //刷新页面location.reload(true);
                                                if(wms_cre_credit_head_id !=null && wms_cre_credit_head_id !="" &&wms_cre_credit_head_id != 'undefind') {
                                                    closeTabAndRes();
                                                } else {
                                                    window.location.href = global_param.context_name + "/resources/html/creditManage/addHouseCredit.html";
                                                }
                                            }
                                        );
                                    } else if(data === 'temOK') {//暂存成功!提示:在贷款查询中查询并且进行单据修改操作!
                                        globalUtil.successMsg(globalErrorMsg['100007'],
                                            function() {
                                                //刷新页面location.reload(true);
                                                if(wms_cre_credit_head_id != null && wms_cre_credit_head_id !="" &&wms_cre_credit_head_id != 'undefind') {
                                                    closeTabAndRes();
                                                }else{
                                                    window.location.href=global_param.context_name + "/resources/html/creditManage/addHouseCredit.html";
                                                }
                                            }
                                        );
                                    } else {
                                        globalUtil.errorMsg(globalErrorMsg['100012']); //保存失败
                                        $("#tb_btn").css("display", "");//显示按钮 
                                    }
                                }
                            });
                        }                                            
                    });
        } else {
            $("#tjbtn").hide();
            
            $.ajax({ 
                type: "POST", 
                url: global_param.context_name + "/cremanage/wmscrecreditheadhousecresave.do",
                async: false,
                dataType: "json",
                data: jsonStr, 
                traditional: true,
                success: function(data) {
                	$("#tjbtn").show();
                    if (data === 'OK') {
                        globalUtil.successMsg(globalErrorMsg['100002'],//保存成功
                         function() {
                             //刷新页面location.reload(true);
                             if(wms_cre_credit_head_id != null && wms_cre_credit_head_id !="" &&wms_cre_credit_head_id != 'undefind') {
                                 closeTabAndRes();
                             } else {
                                 window.location.href=global_param.context_name + "/resources/html/creditManage/addHouseCredit.html";
                             }
                         }
                        );
                    } else if(data === 'temOK') {//暂存成功!提示:在贷款查询中查询并且进行单据修改操作!
                        globalUtil.successMsg(globalErrorMsg['100007'],
                         function() {
                             //刷新页面location.reload(true);
                             if(wms_cre_credit_head_id !=null && wms_cre_credit_head_id !="" && wms_cre_credit_head_id != 'undefind') {
                                 closeTabAndRes();
                             } else {
                                 window.location.href=global_param.context_name + "/resources/html/creditManage/addHouseCredit.html";
                             }
                         }
                        );
                    } else {
                        globalUtil.errorMsg(globalErrorMsg['100012']); //保存失败
                        $("#tb_btn").css("display", "");//显示按钮 
                    }
                }
            });
            
        }
    }; 
    
    //检查主贷人和共贷人亲属、朋友重复性
    function checkQSAndPY(str){
        if(str==0){
            return true;
        }
        var data_all = grid.getData();
        var majorArr=[];
        var otherArr=[];
        for(var gind=0;gind<data_all.length;gind++){
            var mccidone=data_all[gind]['wms_cus_customer_id'];
            var tabWindow=document.getElementById(mccidone+'linktab').contentWindow;
            var tabArr=tabWindow.getlinkmaninfo(mccidone,data_all[gind]['customer_name'],data_all[gind]['is_major'],str);
            if(typeof(tabArr) == "object"){
                if(data_all[gind]['is_major']==1){
                    majorArr=tabArr;
                }else {
                    otherArr.push(tabArr);
                }
            }else {
                return false;
            }
        }
        
        for (var j = 0; j < otherArr.length; j++) {
            var qri=0;//亲人
            var pyi=0;//朋友
            for (var k = 0; k < otherArr[j].length; k++) {
                for (var i = 0; i < majorArr.length; i++) {
                    if(majorArr[i].contact_relation_type=='亲属'&&otherArr[j][k].contact_relation_type=='亲属'){
                        if(majorArr[i].contact_mobile_phone==otherArr[j][k].contact_mobile_phone){
                            qri++;
                        }
                    }else if (majorArr[i].contact_relation_type=='同事(朋友)'&&otherArr[j][k].contact_relation_type=='同事(朋友)') {
                        if(majorArr[i].contact_mobile_phone==otherArr[j][k].contact_mobile_phone){
                            pyi++;
                        }
                    }
                }
            }
            if(qri>1){
                var reStr="主贷人：'"+majorArr[0].customer_name+"' 与 共贷人：'"+otherArr[j][0].customer_name+"' 的亲属最多可以有1人相同！";
                return reStr;
            }
            if(pyi>2){
                var reStr="主贷人：'"+majorArr[0].customer_name+"' 与 共贷人：'"+otherArr[j][0].customer_name+"' 的同事(朋友)最多可以有2人相同！";
                return reStr;
            }
        }
        return true;
    }
    
    //获取贷款客户id列表
    function getPersonInfo(){
        var data_all = grid.getData();
        var data = [];
        for(var i=0;i<data_all.length;i++){
            data.push(data_all[i].wms_cus_customer_id+"@@@"+data_all[i].is_major)
        }
        return data.join();
    }

    //清理指定DIV下的所有LigerTip控件
    function clearLigerTip(divId){
        var elementArr = $("#"+divId+" *");
        jQuery.each(elementArr.get(), function(i, element) {
            $(element).ligerHideTip();
        });
    }
    //-----------------------------------------------------------------------------
    function closepage(){
        dialog.close();
    }
    //控件失去焦点时，验证手机号
    function checkMobile(ele){
        var mobile = $(ele).val();
        if(mobile.length!=0 && !/^\d{11}$/.test(mobile)){
            $(ele).ligerTip({distanceX:-120,width:120,content: "手机号输入不正确！"});               
            $(ele).bind('click',function(){
                $(ele).ligerHideTip();
            });
        }
    }

    function changeTab(id) {
        var dkinfo = document.getElementById("dkinfo"); //贷款信息tab
        var cspginfo = document.getElementById("cspginfo"); //初审评估表tab
        var khinfo = document.getElementById("khinfo"); //客户信息tab
        
        if (id == 'dkinfo') {
            document.getElementById("tabbody1").className = "tabbody1";
            document.getElementById("tabbody2").className = "tabbody2";
            document.getElementById("tabbody3").className = "tabbody2";
            dkinfo.style.display = '';
            cspginfo.style.display = 'none';
            khinfo.style.display = 'none';
            if(isCommit){
                globalVali.checkForm("dkinfo",true);    
            }
        } else if (id == 'cspginfo') {
            document.getElementById("tabbody1").className = "tabbody2";
            document.getElementById("tabbody2").className = "tabbody2";
            document.getElementById("tabbody3").className = "tabbody1";
            dkinfo.style.display = 'none';
            cspginfo.style.display = '';
            khinfo.style.display = 'none';
            clearLigerTip("dkinfo");//清理贷款信息LigerTip控件
        } else if (id == 'khinfo'){
            document.getElementById("tabbody1").className = "tabbody2";
            document.getElementById("tabbody2").className = "tabbody1";
            document.getElementById("tabbody3").className = "tabbody2";
            dkinfo.style.display = 'none';
            cspginfo.style.display = 'none';
            khinfo.style.display = '';
        }
    };
    var dialog_att;
    /*
    打开附件上传页面
    */
    function openAddAttDialog(data_type_name,data_detail_name){
        var url = globalUtil.getHtml("addFileForCre.html?data_type_name="+data_type_name+"&data_detail_name="+data_detail_name);
        dialog_att = $.ligerDialog.open({
            url: url,
            title: '上传附件',
            width: 650,
            height: globalUtil.setDialogHeight(250),
            onHiddenOrClose: function(){
                //alert('关闭或隐藏都调用的事件!');
            },
            isResize: false
        });
    }
    //添加上传文件的信息链接
    function addAttFile(newfileArr,objid){
        if(objid != 'tdshowPic') {
            fileArrkh = fileArrkh.concat(newfileArr);
            var filehtml = $("#"+objid).html();
            for(var i=0;i<newfileArr.length;i++){
                var nnme=newfileArr[i].attachment_new_name.replace('/','thxg1');
                nnme=nnme.replace('/','thxg2');
                filehtml += '<div id="delUploadDivId'+nnme+'">';
                filehtml += '<a  target="_blank"  href="'+global_param.upload_file_url+newfileArr[i].attachment_address+'">'+newfileArr[i].attachment_old_name+'</a>';
                filehtml += '<img src="../../images/icon/icon-close.gif" onclick="deleteFilekh(\''+nnme+'\')"/>';
                filehtml += '</div>'
            }
            $("#"+objid).html(filehtml);
        }else {
            fileArr = fileArr.concat(newfileArr);
            var filehtml = $("#"+objid).html();
            for(var i=0;i<newfileArr.length;i++){
                var nnme=newfileArr[i].attachment_new_name.replace('/','thxg1');
                nnme=nnme.replace('/','thxg2');
                filehtml += '<div id="delUploadDivId'+nnme+'">';
                filehtml += '<a  target="_blank"  href="'+global_param.upload_file_url+newfileArr[i].attachment_address+'">'+newfileArr[i].attachment_old_name+'</a>';
                filehtml += '<img src="../../images/icon/icon-close.gif" onclick="deleteFile(\''+nnme+'\')"/>';
                filehtml += '</div>'
            }
            $("#"+objid).html(filehtml);
        }
    }
    //业务员选择
    var spfcDialog;
    function searchPersonnel(){
        clearLigerTip("dkinfo");
        var url = globalUtil.getHtml("searchPersonnelForCredit.html");
        spfcDialog = $.ligerDialog.open({
            url: url,
            title: '选择业务员',
            width: 1000,
            height: globalUtil.setDialogHeight(600),
            isResize: false
        });
    };
    
    function getCheckedPersonnelAll(data){
        $("#salesman_name").attr("value",data.personnel_name+"/"+data.personnel_shortcode);
        $("#salesman_id").attr("value",data.personnel_id);
        $("#salesman_code").attr("value",data.personnel_code);
        $("#city").attr("value",data.city);
        $("#salesman_city_code").attr("value",data.personnel_regionnumber);
        $("#salesman_dept_id").attr("value",data.personnel_deptid);
    }
    
     //删除上传文件的信息链接
     function deleteFile(filename){
            $.ligerDialog.confirm(globalErrorMsg['100016'],
            function(yes) {
                if (yes) {
                    $("#delUploadDivId"+filename).remove();
                    filename=filename.replace('thxg1','/');
                    filename=filename.replace('thxg2','/');
                    for(var i=0;i<fileArr.length;i++){
                        if(filename == fileArr[i].attachment_new_name){
                            fileArr.splice(i,1);
                            break;
                        }
                    }
                }                                            
            });
        }
     
     /*
     初始化附件信息
     */
     function init_att(){
        $.getJSON(globalUtil.getTimestampUrl('/sysmanage/getdictdatatreebean.do?p_wms_sys_dict_id='+p_wms_sys_dict_id+'&wms_sys_dict_id='+wms_sys_dict_id),
                {},
                function(att_json) {
                    for(var i=0;i<att_json.length;i++){
                        var data = att_json[i]
                        var children = data.children;
                        var row = document.getElementById("att_tb").insertRow(document.getElementById("att_tb").rows.length);
                        var td1 = row.insertCell(0);
                        td1.rowSpan = children.length;
                        td1.className = 'title textright';
                        td1.style.width = '100px';
                        SCtitle.innerHTML = data.text;
                        var data0 = children[0];
                        
                        var td2 = row.insertCell(1);
                        td2.className = 'textleft';
                        td2.style.width = '400px';
                        td2.innerHTML = data0.text;
                        
                        var td3 = row.insertCell(2);
                        td3.className = 'textleft';
                        td3.style.width = '100px';
                        td3.style.height = '100px';
//                      if(cktype != 'ck'){
                            td3.innerHTML = '<input class="btn-uploadF" onmouseover="this.className=\'btn-uploadF-over\'" onmouseout="this.className=\'btn-uploadF\'" onmousedown="this.className=\'btn-uploadF-down\'" type="button" style="margin-right:7px;" onclick="openAddAttDialog('+data.id+','+data0.id+')" style="display:none"/>';
//                      }
                        //td3.innerHTML = '<a href="#" onclick="openAddAttDialog('+data.id+','+data0.id+')" class="btn" style="display:" style="display:none">上传附件</a>';
                        
                        var td4 = row.insertCell(3);
                        td4.className = 'textleft';
                        td4.id = data0.id;
                        td4.pid = data.id;
//                      document.getElementById("textleft").style.height = '100px';
                        for(var j = 1;j < children.length;j++){
                            var row_t = document.getElementById("att_tb").insertRow(document.getElementById("att_tb").rows.length);
                            var td1_t = row_t.insertCell(0);
                            td1_t.className = 'textleft';
                            td1_t.style.width = '100px';
                            td1_t.innerHTML = children[j].text;
                            
                            var td3_t = row_t.insertCell(1);
                            td3_t.className = 'textleft';
                            td3_t.style.width = '30px';
//                          if(cktype != 'ck'){
                                td3_t.innerHTML = '<input class="btn-uploadF" onmouseover="this.className=\'btn-uploadF-over\'" onmouseout="this.className=\'btn-uploadF\'" onmousedown="this.className=\'btn-uploadF-down\'" type="button" style="margin-right:7px;" onclick="openAddAttDialog('+data.id+','+children[j].id+')" style="display:none"/>';
//                          }
                            //td3_t.innerHTML = '<a href="#" onclick="openAddAttDialog('+data.id+','+children[j].id+')" class="btn" style="display:">上传附件</a>';
                            td3_t.style.height = '100px';
                            var td4_t = row_t.insertCell(2);
                            td4_t.className = 'textleft';
                            td4_t.id = children[j].id;
                            td4_t.pid = data.id;
                        }
                    }
                });
     }

        //删除上传文件的信息链接
        function deleteFilekh(filename){
            $.ligerDialog.confirm(globalErrorMsg['100016'],
            function(yes) {
                if (yes) {   
                    $("#delUploadDivId"+filename).remove();
                    filename=filename.replace('thxg1','/');
                    filename=filename.replace('thxg2','/');
                    for(var i=0;i<fileArryf.length;i++){
                        if(filename == fileArryf[i].attachment_new_name){
                            fileArrkh.splice(i,1);
                            break;
                        }
                    }
                }                                            
            });
        }
        //刷新关闭
        function closeTabAndRes(){
            parent.window.search();
            closeDialog();
        }
        /**
         *关闭窗口
         */
        function closeDialog() {
          window.parent.dialog.hide();
        }
</script>
</head>
<body>
    <div class="tab_titleT">
        <table width="100%" border="0" cellspacing="0" cellpadding="0">
            <tr valign="bottom" id='trtab1'>
                <td width="33%" class="tabbody1" id="tabbody1"
                    onclick="changeTab('dkinfo');" tabname='mytab'><div
                        align="center">贷款信息</div></td>
                <td width="33%" class="tabbody2" id="tabbody2"
                    onclick="changeTab('khinfo');" tabname='mytab'><div
                        align="center">客户信息</div></td>
                <td width="33%" class="tabbody3" id="tabbody3"
                    onclick="changeTab('cspginfo');" tabname='mytab'><div
                        align="center">初审评估信息</div></td>
            </tr>
        </table>
    </div>
    <div class="pop-center overflow-au" style="top: 30px;" id="waicengdiv">
        <!-- ------------------------------------------------------------------贷款信息 begin------------------------------------------------------------------ -->
        <div id="dkinfo" class="pop-formDiv clearfix"
            style="margin: 5px; margin-top: 5px;">
            <div class="l-panel-search-cond clearfix" id="info_l1">
                <div class="float-l">
                    <div class="l-panel-search-item">
                        <font>*可以通过新增<font style="color: red;">贷款客户</font>精确选择客户，通过新增抵押房产信息精确选择抵押房产，选择之后，需添加联系人信息、抵押房产用途，之后提交。
                            <br />
                        <font style="color: blue;">注：联系人信息必须填写三个亲属、一位担保人信息，且确保号码真实有效并能打通，外地号码前加“0”。</font></font>
                    </div>
                </div>
            </div>
            <!-- 空白区域 -->
            <div class="l-panel-search-cond clearfix" id="info_l2">
                <div class="float-l">
                    <div class="l-panel-search-item"></div>
                </div>
            </div>
            <!-- 添加的虚线 -->
            <div class="line clearboth" id="info_l3"></div>
            <div class="l-panel-search-cond clearfix" id='main_t'>
                <div class="float-l">
                    <div class="l-panel-search-title">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;借款用途:</div>
                    <div class="l-panel-search-item">
<!--                            isRequired="1"  2016/03/08去掉必填项 jiaodelong-->
                        <input type="text" id="credit_purpose" style="width: 450px"
                            maxlength="25" />
                    </div>
                </div>
                <div class="float-l ">
                    <div class="l-panel-search-title">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;房贷产品种类:</div>
                    <div class="l-panel-search-item">
                        <input type="text" id="cre_loan_type" ligeruiSelectIsRequired="1"
                            onchange="creTypeChange()" />
                    </div>
                </div>
                <div class="float-l clearboth">
                    <div class="l-panel-search-title">申请最长还款期限:</div>
                    <div class="l-panel-search-item">
                        <input type="text" id="max_repayment_time_limit"
                            style="width: 95px" isRequired="1" isPositiveInteger="1"
                            minVal="1" maxVal="120" scope="a" /> (月)
                    </div>
                </div>
                <div class="float-l ">
                    <div class="l-panel-search-title">&nbsp;可接受每月最高还款额:</div>
                    <div class="l-panel-search-item">
<!--                            isRequired="1"  2016/03/08去掉必填项 jiaodelong-->
                        <input type="text" id="max_repayment_limit_per_month"
                            style="width: 95px" isFloat="1" minVal="0"
                            maxVal="1000000" /> (元/月)
                    </div>

                </div>
                <div class="float-l">
                    <div class="l-panel-search-title">&nbsp;&nbsp;申请贷款额度:</div>
                    <div class="l-panel-search-item">
                        <input type="text" id="credit_limit" style="width: 95px" onblur="sumMoney();"
                            isRequired="1" isFloat="1" minVal="0" maxVal="100000000" /> (万元)
                    </div>
                </div>
                <div class="float-l ">
                    <div class="l-panel-search-title">贷款利率:</div>
                    <div class="l-panel-search-item">
                        <input type="text" id="loan_interest_rate" style="width:95px"  
                            minVal="0" maxVal="100"/> %
                    </div>
                </div>
                
                <div class="float-l clearboth">
                    <div class="l-panel-search-title">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;是否续贷:</div>
                    <div class="l-panel-search-item">
                        <select style="width: 50px;" id="is_xudai" onchange="xudaiChange();">
                            <option value="0" selected="selected">否</option>
                            <option value="1">是</option>
                        </select>
                    </div>
                </div>
                <div class="float-l">
                    <div class="l-panel-search-title">手续费率:</div>
                    <div class="l-panel-search-item">
                        <input type="text" id="commission_rate" style="width: 95px;"
                            minVal="1" maxVal="100" disabled="disabled" /> (%)
                    </div>
                </div>
                <div class="float-l">
                    <div class="l-panel-search-title">手续费:</div>
                    <div class="l-panel-search-item">
                        <input type="text" id="commission_fee" style="width: 95px;"
                            minVal="1" maxVal="100" disabled="disabled" /> (元)
                    </div>
                </div>
                <div class="float-l">
                    <div class="l-panel-search-title">&nbsp;&nbsp;&nbsp;&nbsp;业务员:</div>
                    <div class="l-panel-search-item">
                        <input type="text" id="salesman_name" style="width: 95px"
                            readonly="readonly" isRequired="1" scope="a" /><a href="#" id="searchPersonnelId"
                            onclick="searchPersonnel()">选择</a>
                    </div>
                    <div style="display: none;">
                        <input id="salesman_id" type="text" style="width: 150px" />
                    </div>
                    <div style="display: none;">
                        <input id="salesman_code" type="text" style="width: 150px" />
                    </div>
                    <div style="display: none;">
                        <input id="city" type="text" style="width: 150px" />
                    </div>
                    <div style="display: none;">
                        <input id="salesman_city_code" type="text" style="width: 150px" />
                    </div>
                    <div style="display: none;">
                        <input id="salesman_dept_id" type="text" style="width: 150px" />
                    </div>
                </div>
            </div>
            <!-- 贷款客户-->
            <div class="center-content clearboth" style="min-width: 500px;">
                <div class="center-title">贷款客户</div>
                <div class="center-txt" style="margin-bottom: 5px;">
                    <div id="centertoolbar" class="minwidth400"></div>
                    <div id="grid"></div>
                </div>
            </div>
            <!-- 贷款客户 -->
            <!-- 抵押房产信息 -->
            <div class="center-content clearboth" style="min-width: 500px;">
                <div class="center-title">抵押房产信息</div>
                <div class="center-txt" style="margin-bottom: 5px;">
                    <div id="centertoolbardyfc" class="minwidth400"></div>
                    <div id="griddyfc"></div>
                </div>
            </div>
            <!-- 抵押房产信息 end -->
            <div id="allLinkManDiv"></div>
        </div>
        <!-- ------------------------------------------------------------------客户资料------------------------------------------------------------------ -->
        <div id="khinfo" style="margin-left: 300px; margin-top: 60px;display: none;">
            <table cellspacing="1" cellpadding="1" class="input_tb" id="att_tb" style="margin-left: -155px">
                <tr >
                    <td colspan="3" align="left" id="SCtitle">客户资料上传：</td>
                    <td align="right"><div id='khzlscatt'></div></td>
                </tr>
            </table>
        </div>
        
        <div id="cspginfo" class="pop-formDiv clearfix"
            style="margin: 5px; margin-top: 5px; display: none">
            <div>
                <table cellspacing="1" cellpadding="1" class="input_tb" id="att_tb">
                    <tr>
                        <td colspan="2" align="left">初审评估</td>
                        <td align="right"><div id='plswpic'></div></td>
                    </tr>
                    <tr>
                        <td align="left"><span style="color: #333333;">初审评估表：</span></td>
                        <td id="tdshowPic"></td>
                        <td id="tdupdPicBtn" class="textleft" align="left"><input
                            class="btn-uploadF"
                            onmouseover="this.className='btn-uploadF-over'"
                            onmouseout="this.className='btn-uploadF'"
                            onmousedown="this.className='btn-uploadF-down'" type="button"
                            style="margin-right: 7px;"
                            onclick="openAddAttDialog('none','tdshowPic')"
                            style="display:none" /></td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <!-- 提交功能按钮区 -->
    <div class="pop-footer5 clearboth" style="bottom: 1px;" id="tb_btn">
        <input id="zcbtn" class="btn-saveZ"
            onmouseover="this.className='btn-saveZ-over'"
            onmouseout="this.className='btn-saveZ'"
            onmousedown="this.className='btn-saveZ-down'" type="button"
            style="margin-right: 7px;" onclick="submitInfo(0)" /> <input
            id="tjbtn" onclick="submitInfo(2);" class="btn-saveT"
            onmouseover="this.className='btn-saveT-over'"
            onmouseout="this.className='btn-saveT'"
            onmousedown="this.className='btn-saveT-down'" type="button"
            style="margin-right: 7px;" />
    </div>
</body>
</html>
