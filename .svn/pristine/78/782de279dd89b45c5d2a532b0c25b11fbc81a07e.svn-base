<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-

transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="../../css/zx-all.css" rel="stylesheet" type="text/css" />
<link href="../../css/app.css" rel="stylesheet" type="text/css" />
<link href="../../css/ligerui-main.css" rel="stylesheet" type="text/css" />
<script src="../../js/zx-all.js" type="text/javascript"></script>
<title>佣金奖励规则配置</title>
<style type="text/css">
.td_title {
	background: none repeat scroll 0 0 #EAF0FB;
}

.tb_input TD {
	background: none repeat scroll 0 0 #FFFFFF;
	padding: 3px 1px 1px 4px;
}

table td {
	border-color: #BFBFBF;
}
</style>

</head>
<body>
	<!-- 页面加载的时候，审批流程为显示 -->
	<hr />
	<div class="float-l clearboth" style="height: 10px;"></div>
	<div id="getinfo" class="center-content clearboth"
		style="min-width: 600px; margin-top: 0px">
		<div class="float-l clearboth">
				<div id="category_over_time"></div>
		</div>
		<div class="float-l">
				<div class="l-panel-search-title"><span style="color: red;" name="ck"></span></div>
				<div class="l-panel-search-item">
					<input type="radio"  name="commission_reward_type"
						class="radio5" value="1" checked="checked" onclick="setDisabled(1)"/>根据排名奖励
				</div>
		</div>
		<div class="float-l clearboth" style="margin-left:30px;">
				<div class="l-panel-search-title"></div>
				<div class="l-panel-search-item">
					<input type="radio"  name="reward_method"
						class="radio5" value="1" checked="checked"  onclick="changeWay()"/>按照佣金比例奖励 <input
						type="radio"   name="reward_method" class="radio5"
						value="0" onclick="changeWay()"/>奖金奖励
				</div>
		</div>
		<div class="float-l commonstyle clearboth">
				<table id="lcsqxxtable" border="1" bordercolor="#BFBFBF"
							style="text-align: center; margin-left: 55px; margin-bottom: 5px; margin-top: 3px">
							<tr class="lcsqxxtr" style="background-color: #676b73; color: white; height: 35px" >
								<td width="190px" class="title"><span class="redstar"></span></td>
								<td width="190px" class="title">团队净增</td>
								<td width="190px" class="title">团队存量</td>
								<td width="190px" class="title">本月新增</td>
							</tr>
							<tr class="reward_type" style="height: 35px">
								<td width="190px" class="title"><span name="rank_num" style="display:none">1</span>第一名</td>
								<td width="190px" class="title"><input type="text" name="team_net_growth" style="width: 108px;" onkeyup="valiFloat(this)"/><span name="zhuanhuan">%</span></td>
								<td width="190px" class="title"><input type="text" name="team_stock" style="width: 108px;"onkeyup="valiFloat(this)"/><span name="zhuanhuan">%</span></td>
								<td width="190px" class="title"><input type="text" name="monthly_added" style="width: 108px;"onkeyup="valiFloat(this)"/><span name="zhuanhuan">%</span></td>
							</tr>
							<tr class="reward_type" style="height: 35px">
								<td width="190px" class="title"><span name="rank_num" style="display:none">2</span>第二名</td>
								<td width="190px" class="title"><input type="text" name="team_net_growth" style="width: 108px;" onkeyup="valiFloat(this)"/><span name="zhuanhuan">%</span></td>
								<td width="190px" class="title"><input type="text" name="team_stock" style="width: 108px;"onkeyup="valiFloat(this)"/><span name="zhuanhuan">%</span></td>
								<td width="190px" class="title"><input type="text" name="monthly_added" style="width: 108px;"onkeyup="valiFloat(this)"/><span name="zhuanhuan">%</span></td>
							</tr>
							<tr class="reward_type" style="height: 35px">
								<td width="190px" class="title"><span name="rank_num" style="display:none">3</span>第三名</td>
								<td width="190px" class="title"><input type="text" name="team_net_growth" style="width: 108px;"onkeyup="valiFloat(this)"/><span name="zhuanhuan">%</span></td>
								<td width="190px" class="title"><input type="text" name="team_stock" style="width: 108px;"onkeyup="valiFloat(this)"/><span name="zhuanhuan">%</span></td>
								<td width="190px" class="title"><input type="text" name="monthly_added" style="width: 108px;"onkeyup="valiFloat(this)"/><span name="zhuanhuan">%</span></td>
							</tr>
				</table>
			</div>
			<div class="float-l clearboth">
				<div class="l-panel-search-title"></div>
				<div class="l-panel-search-item"></div>
				
			</div>
				<div class="float-l clearboth">
				<div class="l-panel-search-title"></div>
				<div class="l-panel-search-item"></div>
			</div>
			<div class="float-l clearboth">
				<div class="l-panel-search-title"></div>
				<div class="l-panel-search-item">
					<input type="radio"  name="commission_reward_type" 
						class="radio5" value="2" onclick="setDisabled(0)"/>根据人员奖励 
			</div>
			<div class="float-l clearboth" style="margin-left:50px;">
				<div class="l-panel-search-title">奖励有效期：</div>
				<div class="l-panel-search-item">
					<input type="text" class="Wdate" id="reward_validity_period"
							onclick="WdatePicker({dateFmt:'yyyy-MM-dd',isShowClear:true})"
							style="width: 133px; vertical-align: top;" />
				</div>
			</div>
			<div class="float-l clearboth" style="margin-left:-15px;" id="newAdd">
				<div class="l-panel-search-title"></div>
				<div class="l-panel-search-item">
				<div style="float: left; margin-left:60px;"><a href="#" onclick="addNewkh()" class="btn" >新增</a></div>
				</div>
			</div>
			<div class="float-l commonstyle clearboth">
				<table id="lcsqxxtableperson" border="1" bordercolor="#BFBFBF"
							style="text-align: center; margin-left: 55px; margin-bottom: 5px; margin-top: 3px">
							<tr class="lcsqxxtr" style="background-color: #676b73; color: white; height: 35px" >
								<td width="180px" class="title">奖励模式</td>
								<td width="180px" class="title"></td>
								<td width="400px" class="title">奖励人员</td>
							</tr>
				</table>
			</div>
		</div>
	</div>
			<div style="display:none">
				<table id="cloneModelkh" border="1" style="text-align: center; margin-left: 55px; margin-bottom: 5px; margin-top: 3px">
							<tr class="person_way" style="height: 35px">
								<td width="180px" class="title">
											<select name="reward_model" onchange="changeWayJLMS(this)">
												<option selected="selected" value="-1" >请选择</option>
												<option  value="0">佣金比例</option>
												<option  value="1">奖金奖励</option>
											</select></td>
								<td width="180px" class="title"><input type="text" name="reward_method" style="width: 108px;"onkeyup="valiFloat(this)"/><span name="jlms">%</span></td>
								<td width="400px" class="title">
									<!-- <input type="text" name="specialpulespt" style="dispaly:none"/>-->
									<span class="personnel_name"></span>
									<input type="hidden" name="personnel_name_str" />
									<input type="hidden" name="personnel_id_str" />
									<span style="float: right"><a href="#" onclick="showPersonnels(this)">选择</a>|<a href="#" onclick="deleteRow(this)">删除</a></span>
								</td>
							</tr>					
				</table>
			</div>
	<div class="pop-footer5 clearboth" style="bottom: 1px;">
		<input id="tjbtn" class="btn-saveT"
			onmouseover="this.className='btn-saveT-over'"
			onmouseout="this.className='btn-saveT'"
			onmousedown="this.className='btn-saveT-down'" type="button"
			style="margin-right: 7px;" onclick="save()" /> <input
			id="cancelBtnId" class="btn-cancel"
			onmouseover="this.className='btn-cancel-over'"
			onmouseout="this.className='btn-cancel'"
			onmousedown="this.className='btn-cancel-down'" type="button"
			onclick="closeTab();" />
	</div>
	<!-- 工具条初始化 -->
	<script type="text/javascript">
		var category_over_time=$.query.get("category_over_time");
		$(function() {
			getinfo();//初始化信息
		});
		//新增理财规则--客户
		function addNewkh(){
			$("#cloneModelkh tr").find("[name=reward_method]").removeAttr("disabled");
			$("#lcsqxxtableperson").find(".lcsqxxtr").after($("#cloneModelkh tr").clone(true));
		}
		//新增理财规则--客户
		function deleteRow(obj){
			$(obj).closest("tr").remove();
		}
		//初始化信息
		function getinfo(){
			$.getJSON(globalUtil.getTimestampUrl('/inve/wmsinvecommissionrewardheadrulesinfo.do'),
	    		function(json) {
	    			if(json){
	    				init_reward_method(json);
	    				//console.log(json);
	    				if(json.rewardheadrules.commission_reward_type=="1"){//获取根据那种类型计算奖励  1代表 根据排名奖励 2代表 根据人员奖励
	    					$("#newAdd").css("display","none");
	    					$("#lcsqxxtableperson").find(".person_way").remove();
	    					setDisabled("1");
	    					var rank_num_val={};//根据排名获取信息
	    					$(".reward_type").each(function(i){//
	    						for(var j=0;j<json.listRules.length;j++){
		    						if($(this).find('[name=rank_num]').text()==json.listRules[j].rank_num){//排名序号
		    							rank_num_val=json.listRules[j];//记录当前有效信息
		    						}
	    						}
	    						$(this).find('[name=team_net_growth]').val(rank_num_val.team_net_growth);//团队净增
	    						$(this).find('[name=team_stock]').val(rank_num_val.team_stock);//团队存量
	    						$(this).find('[name=monthly_added]').val(rank_num_val.monthly_added);//本月新增
	    					});
	    					changeWay();
	    				}else if(json.rewardheadrules.commission_reward_type=="2"){
	    					$("#lcsqxxtableperson").find(".person_way").remove();
	    					$.each(json.listPersonnel,function (){
	    						addNewkh();
	    					});
	    					setDisabled("0");
	    					$("#lcsqxxtableperson").find(".person_way").each(function(i){
	    						$(this).find('[name=reward_model]').val(json.listPersonnel[i].reward_model);//奖励模式
	    						if(json.listPersonnel[i].reward_model=="1"){
	    							$(this).find('[name=reward_model]').parent().next().find('[name=jlms]').text("元");	
	    						}else if(json.listPersonnel[i].reward_model=="0"){
	    							$(this).find('[name=reward_model]').parent().next().find('[name=jlms]').text("%");
	    						}
	    						$(this).find('[name=reward_method]').val(json.listPersonnel[i].reward_method);//奖励方式
	    						//$(this).find('[name=specialpulespt]').val(json.listPersonnel[i].specialpulespt);//人员信息
	    						//初始化选择的人员信息
	    						var pts = handlePersonnels(json.personList[i]);
	    						$(this).find("span.personnel_name").html(pts.names);
	    						$(this).find("input[name='personnel_name_str']").val(pts.names);
	    						$(this).find("input[name='personnel_id_str']").val(pts.ids);
	    					});
	    				}
	    			}
	    		});
		}
		//根据用户选择来改变是否可填写
		function  setDisabled(val){
			if(val=="0"){// 人员
				$("#newAdd").css("display","");
				$("[name=reward_method]").attr("disabled","disabled");
				$("#lcsqxxtable").find("input").attr("disabled","disabled");
				
				$("#reward_validity_period").removeAttr("disabled");
				$("#lcsqxxtableperson").find("input,select").removeAttr("disabled","disabled");
				$("#lcsqxxtableperson").find("a").css("display","");
				//清空填写空
				$("[name=reward_method]").each(function() {
					if ($(this).val() == "1") {
						$(this).attr('checked', 'checked');
						return false;
					}
				});
				$("#lcsqxxtable").find("input").val("");
			}else if(val=="1"){// 排名
				$("#newAdd").css("display","none");
				$("#lcsqxxtableperson").find(".person_way").remove();
				$("#reward_validity_period").attr("disabled","disabled");
				$("#lcsqxxtableperson").find("input,select").attr("disabled","disabled");
				$("#lcsqxxtableperson").find("a").css("display","none");
				
				$("[name=reward_method]").removeAttr("disabled");
				$("#lcsqxxtable").find("input").removeAttr("disabled");
				//清空填写空
				$("#reward_validity_period").val("");
				$("#lcsqxxtableperson").find("input,select").val("");
				$("#lcsqxxtableperson").find(".personnel_name").text("");
			}
		}	
		//初始化单选框
		function init_reward_method(json){
			$("[name=commission_reward_type]").each(function() {//奖励方式 人员-排名
				if ($(this).val() == json.rewardheadrules.commission_reward_type) {
					$(this).attr('checked', 'checked');
					return false;
				}
			});
			if(json.rewardheadrules.commission_reward_type=="1"){//排名 --佣金commission_reward_type
				$("[name=reward_method]").each(function() {
					if ($(this).val() == json.rewardheadrules.reward_method) {
						$(this).attr('checked', 'checked');
						return false;
					}
				});
			}else if(json.rewardheadrules.commission_reward_type=="2"){//人员--日期
				$("#reward_validity_period").val(json.rewardheadrules.reward_validity_period);
			}
		}
		//点击按照佣金比例奖励或者是点击奖金奖励
		function changeWay(){
			$("input[name='reward_method']").each(function (){
				if ($(this).is(':checked')) {
					if($(this).val()=="0"){
						$("span[name=zhuanhuan]").text("元");
					}else if($(this).val()=="1"){//按照佣金比例奖励
						$("span[name=zhuanhuan]").text("%");
					}
				}
			})
		}
		//根据用户选择来显示%或者是元	 
		function changeWayJLMS(obj){
			if($(obj).val()=="1"){
				$(obj).parent().next().find('[name=jlms]').text("元");	
			}else if($(obj).val()=="0"){
				$(obj).parent().next().find('[name=jlms]').text("%");
			}
		}
		//验证正小数，用于onkeyup事件
		 function valiFloat(ele){
		 	var val = $(ele).val();
		 	if(val!='' && !(globalUtil.isFloat(val) || (globalUtil.isNum(val.substring(0,val.length-2))||val.substring(0,val.length-2)==0) && val.substring(val.length-1)=='.')){
		 		$(ele).val('');
		 		$(ele).focus();
		 		globalUtil.warnMsg(globalErrorMsg['400107'],function(ele){
		 			toIncomeManageFeeClear(ele);
		 		});
		 	}
		 }
		//保存审批结果
		function save(){									
			var paramJson = {};
			var paramlist = [];
			getRewardVal(paramJson);//获取根据那种类型计算奖励  排名1或者是人员0	
			if(paramJson.commission_reward_type=="1"){
				getOtherVal(paramJson);
				//佣金奖励规则-百分比还是 固定金额 按照佣金比例奖励 奖金奖励
				$(".reward_type").each(function(i){
					var paramVal  = {};
					paramVal.team_net_growth=$(this).find('[name=team_net_growth]').val();//团队净增
					paramVal.team_stock=$(this).find('[name=team_stock]').val();//团队存量
					paramVal.monthly_added=$(this).find('[name=monthly_added]').val();//本月新增
					paramVal.rank_num=$(this).find('[name=rank_num]').text();//排名序号
					paramlist.push(paramVal);
				});
				paramJson.ranking_reward=JSON.stringify(paramlist);//排名信息
				if(valiRequiredRank(paramlist)){
					return;
				}
			}else if(paramJson.commission_reward_type=="2"){
				paramJson.reward_validity_period=$("#reward_validity_period").val();
				if(paramJson.reward_validity_period==null||paramJson.reward_validity_period==""){//期限
					globalUtil.warnMsg(globalErrorMsg['910057']);
					return ;
				}
				$("#lcsqxxtableperson").find(".person_way").each(function(i){
					var paramVal  = {};
					paramVal.reward_model=$(this).find('[name=reward_model]').val();//奖励模式
					paramVal.reward_method=$(this).find('[name=reward_method]').val();//奖励方式
					paramVal.personnel_name_str=$(this).find('[name=personnel_name_str]').val();//人员信息--姓名+短工号
					paramVal.personnel_id_str=$(this).find('[name=personnel_id_str]').val();//人员信息--id
					//paramVal.specialpulespt=$(this).find('[name=specialpulespt]').val();//人员信息
					paramlist.push(paramVal);
				});
				paramJson.person_way=JSON.stringify(paramlist);//人员信息
				if(valiRequiredPerson(paramlist)){
					return;
				}
			}
			//必填校验
			$.post(globalUtil.getTimestampUrl("/inve/wmsinvecommissionrewardheadrulessaveall.do"), paramJson,
			   		function(data) {
			    	if (data === 'success') {
			        	 globalUtil.successMsg(globalErrorMsg['100002'], function(){
			        		 getinfo();//初始化信息
			        	 });
			         } else if(data === 'errorid'){
			             globalUtil.warnMsg(globalErrorMsg['910058']); //人员id重复
			         } else {
			             globalUtil.errorMsg(globalErrorMsg['100012']); //保存失败
			         }
			    });
		}
		//验证提交时必填项
		function  valiRequiredPerson(param){
			for(var i=0;i<param.length;i++){
				if(param[i].reward_model==null||param[i].reward_model=="-1"){//奖励模式
					globalUtil.warnMsg(globalErrorMsg['910054']);
					return true;
				}
				if(param[i].reward_method==null||param[i].reward_method	==""){//奖励方式
					globalUtil.warnMsg(globalErrorMsg['910055']);
					return true;
				}
				if(param[i].personnel_id_str==null||param[i].personnel_id_str==""){//人员
					globalUtil.warnMsg(globalErrorMsg['910056']);
					return true;
				}
			}
		}
		//验证提交时必填项
		function valiRequiredRank(param){
			for(var i=0;i<param.length;i++){
				if(param[i].team_net_growth==null||param[i].team_net_growth==""){//团队净增
					globalUtil.warnMsg(globalErrorMsg['910051']);
					return true;
				}
				if(param[i].team_stock==null||param[i].team_stock==""){//团队存量
					globalUtil.warnMsg(globalErrorMsg['910052']);
					return true;
				}
				if(param[i].monthly_added==null||param[i].monthly_added==""){//本月新增
					globalUtil.warnMsg(globalErrorMsg['910053']);
					return true;
				}
			}
		}
		//拥金方式
		function getOtherVal(jsonStr) {
			$("input[name='reward_method']").each(function() {
				if ($(this).is(':checked')) {
					jsonStr.reward_method = $(this).val();
					return false;//退出each循环
				}
			});						
		}
		//奖励方式  人员或者是排名
		function getRewardVal(jsonStr){
			$("input[name='commission_reward_type']").each(function() {
				if ($(this).is(':checked')) {
					jsonStr.commission_reward_type = $(this).val();
					return false;//退出each循环
				}
			});
		}
		//显示人员
		function showPersonnels(obj) {
			var index = $(obj).closest("tr").index();
			var vals = $(obj).closest("tr").find("input[name='personnel_id_str']").val();
			var url = globalUtil.getHtml("personnelSelect.html?vals=" + vals + "&index=" + index +"&post_val=true");
	    	dialog = $.ligerDialog.open({
		        url: url,
		        title: '人员选择',
		        width: 1000,
		        height: globalUtil.setDialogHeight(700),
		        onHiddenOrClose: function(){
		    	},
		        isResize: false
	    	});
		}
		
		//人员选择给人赋值
		function setPersonnel(index, personnels) {
			var $tr = $("#lcsqxxtableperson").find("tr:eq("+index+")");
			
			var pts = handlePersonnels(personnels);
			$tr.find("span.personnel_name").html(pts.names);
			$tr.find("input[name='personnel_name_str']").val(pts.names);
			$tr.find("input[name='personnel_id_str']").val(pts.ids);
		}
		//处理personnels数据
		function handlePersonnels(personnels) {
			var pts = {};
			var names = "";
			var ids = "";
			$.each(personnels, function(i, obj) {
				ids += obj.personnel_id + ",";
				names += " " + obj.personnel_name + "/" + obj.personnel_shortcode + ",";
			});
			
			ids = ids.substring(0, ids.length-1);
			names = names.substring(0, names.length-1);
			pts["ids"] = ids;
			pts["names"] = names;
			
			return pts;
		}
		//关闭本页
		function closeTab(){
			globalUtil.closeCurrentTab();//关闭当前TAB页面	
		}
	</script>
</body>
</html>
