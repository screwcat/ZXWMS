<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>正常还款确认</title>
<link href="../../css/app.css" type="text/css" rel="stylesheet" />
<link href="../../css/zx-all.css" rel="stylesheet" type="text/css" />
<script language="Javascript" src="../../js/zx-all.js"> </script>

<style type="text/css">
.textright {
	text-align: right;
}

.textleft {
	text-align: left;
}
/*input_tb css*/
.input_tb_new {
	/*border:1px solid #dfdfdf;*/
	width: 100%;
	margin-bottom: 10px;
}

.input_tb_new a {
	color: #056aff;
	text-decoration: none;
	font-weight: normal;
}

.input_tb_new td {
	height: 35px;
	line-height: 25px;
	/*border-bottom:1px dashed #d5d5d5;*/
	padding-top: 3px;
}

.input_tb_new .tr_title td {
	background-color: #f5f8ff;
	padding-left: 16px;
	font-weight: bold;
	height: 30px;
	line-height: 30px;
	/*border-bottom:1px solid #dfdfdf;*/
}

.input_tb_new .tr_last td {
	border-bottom: 0;
}

.input_tb_new .title {
	text-align: right;
}

.input_tb_new .subtitle {
	text-align: left;
	background-color: #d2e1fd;
	border-top: 1px solid #fff;
	/*border-left:1px solid #fff;*/
}

.input_tb_new .tr_btn_input td {
	background-color: #fbfbfb;
	/*border-top:1px solid #dbdbdb;*/
	/*height:40px;*/
}

.title_tb {
	background-color: #f5f8ff;
	padding-left: 16px;
	font-weight: bold;
	height: 30px;
	line-height: 30px;
	height: 35px;
	line-height: 25px;
	padding-top: 3px;
}

.data_tb td {
	height: 30px;
	line-height: 24px;
	padding-left: 10px;
	border-bottom: 1px dashed #e3e4e6;
	text-align: left;
}

#huankuan {
	text-align: left;
}
</style>
</head>
<body>
		<!--查询条件  begin-->
	    <div class="tab_titleT" id="tab_titleT">
			<table width="100%" border="0" cellspacing="0" cellpadding="0">
				<tr valign="bottom" id='trtab1'>
					<td class="tabbody1" id="tabbody1" onclick="changeTab('arbdocument');" tabname='mytab' style="width: 25%">
						<div align="center">正常还款结算清单</div>
					</td>
					<td class="tabbody2" id="tabbody2" onclick="changeTab('mortgagelist');" tabname='mytab' style="width: 25%">
						<div align="center">抵押物清单</div>
					</td>
					<td class="tabbody2" id="tabbody3" onclick="changeTab('repaymentdetails');" tabname='mytab' style="width: 25%">
						<div align="center">还款明细</div>
					</td>
					<td class="tabbody2" id="tabbody4" onclick="changeTab('repaymenthistory');" tabname='mytab' style="width: 25%">
						<div align="center">还款历史</div>
					</td>
				</tr>
			</table>
		</div>
		<!-- tab页面内容显示 -->
		<div class="pop-center" style="top: 30px;" id="change_tab">
			<div class="center-content" style="min-width: 600px;">
			    <div class="pop-center overflow-au" style="height: 660px;">
					<div class="center-content clearboth" style="min-width: 700px;">
						<!-- -----------------------------------------------------------------客户信息 begin------------------------------------------------------------------ -->
						<div id="arbdocument" class="pop-formDiv clearfix" style="margin: 5px; margin-top: 5px;">
							<div id="hk_base_repay_info">
								<div class="float-l">
									<div class="pop-form-title">客户名称:</div>
									<div class="pop-form-item">
										<input type="text" id="debtor_name" maxlength="50" readonly="readonly" />
									</div>
								</div>
								<div class="float-l" style="margin-left: 14px;">
									<div class="pop-form-title">合同编号:</div>
									<div class="pop-form-item">
										<input type="text" id="protocol_code" maxlength="50" readonly="readonly" />
									</div>
								</div>
								<div class="float-l" style="margin-left: 12px;">
									<div class="pop-form-title">合同日期:</div>
									<div class="pop-form-item">
										<input type="text" id="protocol_creat_date" maxlength="50" readonly="readonly"/>
									</div>
								</div>
								<div class="float-l clearboth">
									<div class="pop-form-title">合同金额:</div>
									<div class="pop-form-item">
										<input type="text" id="protocol_amount" maxlength="50" readonly="readonly" />元
									</div>
								</div>
								<div class="float-l">
									<div class="pop-form-title">月还款金额:</div>
									<div class="pop-form-item">
										<input type="text" id="refund_limit_month" maxlength="50" readonly="readonly" />元
									</div>
								</div>
								<div class="float-l">
									<div class="pop-form-title">已还期数:</div>
									<div class="pop-form-item">
										<input type="text" id="repay_period" maxlength="50" readonly="readonly" />
									</div>
								</div>
				
								<div class="float-l clearboth">
									<div class="pop-form-title">已还本金:</div>
									<div class="pop-form-item">
										<input type="text" id="repay_principal" maxlength="50" readonly="readonly" />元
									</div>
								</div>
								<div class="float-l">
									<div class="pop-form-title">已还利息:</div>
									<div class="pop-form-item">
										<input type="text" id="repay_interest" maxlength="50" readonly="readonly" />元
									</div>
								</div>
								<div class="float-l">
									<div class="pop-form-title">未还期数:</div>
									<div class="pop-form-item">
										<input type="text" id="un_pay_period" maxlength="50" readonly="readonly" />
									</div>
								</div>
								<div class="float-l clearboth">
									<div class="pop-form-title">剩余本金:</div>
									<div class="pop-form-item">
										<input type="text" id="un_pay_principal" maxlength="50" readonly="readonly" />元
									</div>
								</div>
								<div class="float-l">
									<div class="pop-form-title">剩余利息:</div>
									<div class="pop-form-item">
										<input type="text" id="un_pay_interest" maxlength="50" readonly="readonly" />元
									</div>
								</div>
								<div class="float-l">
									<div class="pop-form-title">逾期天数:</div>
									<div class="pop-form-item">
										<input type="text" id="cur_overdue_day" maxlength="50" readonly="readonly" />天
									</div>
								</div>
								<div class="float-l clearboth">
									<div class="pop-form-title">滞纳金额:</div>
									<div class="pop-form-item">
										<input type="text" id="cur_late_fee" maxlength="50" readonly="readonly" />元
									</div>
								</div>
								<div class="float-l">
									<div class="pop-form-title">历史减免额:</div>
									<div class="pop-form-item">
										<input type="text" id="total_derate" maxlength="50" readonly="readonly" />元
									</div>
									<div class="float-l">
										<div class="pop-form-title">贷后专员</div>
										<div class="pop-form-item">
											<input type="text" id="dunning_name" maxlength="50" readonly="readonly" />
										</div>
									</div>
								</div>
								<div class="float-l clearboth">
									<div class="pop-form-title">历史滞纳金额:</div>
									<div class="pop-form-item">
										<input type="text" id="total_late_fee1" maxlength="50" readonly="readonly" />元
									</div>
								</div>
							</div>
							<!-- ------------------------------------------------------------------客户信息 end------------------------------------------------------------------ -->
							<!-- ------------------------------------------------------------------本期应还款明细 begin------------------------------------------------------------------ -->
							<!-- 添加的虚线 -->
							<div class="line clearboth" id="info_l3"></div>
							<br />
							<div id="hk_bq_repay_info">
							<div class="float-l  clearboth">
								<div class="pop-form-title">本期应还款总额:</div>
								<div class="pop-form-item">
									&nbsp;&nbsp;&nbsp;
									<span id="total_repayment"></span>
									&nbsp;&nbsp;(&nbsp;已还&nbsp;
									<a href="javascript:void(0)" onclick="getRepaymentHistory();">
										<span id="is_total_repayment"></span>
									</a>
									&nbsp;差&nbsp;
									<span id="un_total_repayment"></span>
									&nbsp;) 元
								</div>
							</div>
							<div class="float-l">
								<div class="pop-form-title">上期调整额:</div>
								<div class="pop-form-item">
									&nbsp;&nbsp;&nbsp;
									<span class="adjustment_amount"></span>&nbsp;元
								</div>
							</div>
							<div class="float-l clearboth" style="margin-left: 8px;">
								<div class="pop-form-title">其中,本金:</div>
								<div class="pop-form-item">
									<span id="org_repay_principal1"></span>
									&nbsp;(&nbsp;已还&nbsp;
										<a href="javascript:void(0)" onclick="getRepaymentHistory();">
									<span id="repay_principal1"></span>
									</a>)&nbsp;元
								</div>
							</div>
							<div class="float-l">
								<div class="pop-form-title">利息:</div>
								<div class="pop-form-item">
								    <span id="org_repay_interest1"></span>
								    &nbsp;(&nbsp;已还&nbsp;
							    	<a href="javascript:void(0)" onclick="getRepaymentHistory();">
								    	<span id="repay_interest1"></span>
								    </a>)&nbsp;元
								</div>
							</div>
							<div class="float-l">
								<div class="pop-form-title">滞纳金:</div>
								<div class="pop-form-item">
									&nbsp;&nbsp;&nbsp;
									<span id="bq_cur_late_fee"></span>&nbsp;元
								</div>
							</div>
							<div class="float-l">
								<div class="pop-form-title">历史减免额:</div>
								<div class="pop-form-item">
									&nbsp;&nbsp;&nbsp;
									<span id="total_derate1"></span>&nbsp;元
								</div>
							</div>
							<div class="float-l" style="left: 50px;" align="right">
								<div class="pop-form-item" align="right">
									<a href="javascript:overdueHistory();">逾期历史</a>
								</div>
							</div>
						</div>	
						<!-- ------------------------------------------------------------------本期应还款明细 end------------------------------------------------------------------ -->
						<!-- ------------------------------------------------------------------本次实际还款 begin------------------------------------------------------------------ -->
						<!-- 添加的虚线 -->
						<div class="line clearboth" id="info_l3"></div>
						<br />
						<div id="kh_bc_repay_info">
							<div class="float-l clearboth " style="margin-left: 19px;">
								<div class="pop-form-title">
									<span class="redstar">*</span>本次收款金额:
								</div>
								<div class="pop-form-item">
									<input type="text" id="bcsk_total_repayment" value="0" onblur="getFPPrice();" style="border:solid blue 1px;"/>元
								</div>
							</div>
							<div class="float-l">
								<div class="pop-form-title">减免额:</div>
								<div class="pop-form-item">
									<input type="text" id="this_amount_relief" value="0" style="border:solid blue 1px;" />元
								</div>
							</div>
							<div class="float-l">
								<div class="pop-form-title">抵款额:</div>
								<div class="pop-form-item">
									<input type="text" id="this_mortgage" value="0" onclick="getMortgageListInfo();" readonly="readonly" style="border:solid blue 1px;" />元
									<input type="hidden" id="this_collateral_ids"/>
									<input type="hidden" id="whether_mortgage"/>
								</div>
							</div>
							<div class="float-l" style="margin-left: 19px;">
								<div class="pop-form-title">上期调整额:</div>
								<div class="pop-form-item">
									&nbsp;&nbsp;&nbsp;
									<span id="adjustment_amount"></span>&nbsp;&nbsp;元
								</div>
							</div>
							<div class="float-l clearboth" style="margin-left: 19px;">
								<div class="pop-form-title">收款POS:</div>
								<div class="pop-form-item">
									<input type="text" id="wms_fina_cre_pos_id" value="" onchange="getPosBankCard();" style="border:solid blue 1px;" />
								</div>
							</div>
							<div class="float-l" style="margin-left: 12px;">
								<div class="pop-form-title">收款卡号:</div>
								<div class="pop-form-item">
									<input type="text" id="pos_bank_card" value="" readonly="readonly" />
								</div>
							</div>
							<div class="float-l clearboth ">
								<div class="pop-form-title">
									<span class="redstar">*</span>本次实际还款总额:
								</div>
								<div class="pop-form-item">
									&nbsp;&nbsp;&nbsp;&nbsp;
									<input type="text" id="this_total_repayment" readonly="readonly" value="0" />元
								</div>
							</div>
							<div class="float-l">
								<div class="pop-form-title">其中(本金:</div>
								<div class="pop-form-item">
									&nbsp;&nbsp;
									<span id="this_principal">0</span>
									&nbsp;&nbsp;&nbsp;元
								</div>
							</div>
							<div class="float-l">
								<div class="pop-form-title">利息:</div>
								<div class="pop-form-item">
									&nbsp;&nbsp;
									<span id="this_interest">0</span>
									&nbsp;&nbsp;&nbsp;元
								</div>
							</div>
							<div class="float-l">
								<div class="pop-form-title">滞纳金:</div>
								<div class="pop-form-item">
									&nbsp;&nbsp;
									<span id="this_late_fees">0</span>元
								</div>
							</div>
							<div class="float-l">
								<div class="pop-form-title">调整额:</div>
								<div class="pop-form-item">
									&nbsp;&nbsp;<span id="adjustment_amount1">0</span>元)
									<!--<input type="text" id="this_late_fees" value="0"/>元-->
								</div>
							</div>
							<div class="float-l clearboth">
								<div class="pop-form-title">备注:</div>
								<div class="pop-form-item">
									<textarea rows="" cols="" id="this_repayment_remark" style="resize: none;width: 680px;height: 90px;"></textarea>
								</div>
							</div>
						</div>
					<!-- ------------------------------------------------------------------本次实际还款 end------------------------------------------------------------------ -->
					</div>
					<!-- ------------------------------------------------------------------抵押物详情 begin------------------------------------------------------------------->
					<div id="mortgagelist" class="pop-formDiv clearfix" style="margin: 5px; margin-top: 5px;display: none;">
						<div class="center-content clearboth" style="min-width: 500px;">
							<div class="center-title3 position-re">
								抵押物清单<div name="suofang" class="show-hide l-icon-hide"></div>
							</div>
							<div class="l-panel-search clearfix centertoolbar-w">
									<div id="searchbar" class="l-searchbar clearfix">
										<!--查询条件-->
										<div class="l-panel-search-cond clearfix">
											<div class="float-l">
												<div class="pop-form-title">抵押物日期查询:</div>
												<div class="pop-form-item">
													&nbsp;&nbsp;&nbsp;
													<input id="create_timestamp" class="Wdate" type="text" 
														onclick="WdatePicker({dateFmt:'yyyy-MM-dd',isShowClear:true})"
														style="width: 100px; vertical-align: top;" />
													&nbsp;至&nbsp;&nbsp;&nbsp;
													<input id="create_timestamp" class="Wdate" type="text"
														onclick="WdatePicker({dateFmt:'yyyy-MM-dd',isShowClear:true})"
														style="width: 100px; vertical-align: top;" />
												</div>
											</div>
										</div>
									</div>
							</div>
							<div id="mortgagelisttoolbar" class="minwidth400"></div>
							<div id="grid_mortgagelist"></div>
						</div>
					</div>
					<!-- ------------------------------------------------------------------抵押物详情 end------------------------------------------------------------------ -->
					<!-- ------------------------------------------------------------------还款明细 begin------------------------------------------------------------------->
					<div id="repaymentdetails" class="pop-formDiv clearfix" style="margin: 5px; margin-top: 5px;display: none;">
						<div class="center-content clearboth" style="min-width: 500px;">
							<div class="center-title3 position-re">
								还款明细<div name="suofang" class="show-hide l-icon-hide"></div>
							</div>
							<div class="l-panel-search clearfix centertoolbar-w">
								<div id="search_repaymentdetailsbar" class="l-searchbar clearfix">
									<!--查询条件-->
									<div class="l-panel-search-cond clearfix">
										<div class="float-l">
											<div class="pop-form-title">还款明细日期查询:</div>
											<div class="pop-form-item">
												&nbsp;&nbsp;&nbsp;
												<input id="repayment_date_begin" class="Wdate" type="text"
													onclick="WdatePicker({dateFmt:'yyyy-MM-dd',isShowClear:true})"
													style="width: 100px; vertical-align: top;" />
												&nbsp;至&nbsp;&nbsp;&nbsp;
												<input id="repayment_date_end" class="Wdate" type="text"
													onclick="WdatePicker({dateFmt:'yyyy-MM-dd',isShowClear:true})"
													style="width: 100px; vertical-align: top;" />
											</div>
										</div>
									</div>
								</div>
							</div>
							<div id="repaymentdetails_centertoolbar" class="minwidth400"></div>
							<div id="grid_repaymentdetails"></div>
						</div>
					</div>
					<!-- ------------------------------------------------------------------还款明细 end------------------------------------------------------------------ -->
					<!-- ------------------------------------------------------------------还款历史 begin------------------------------------------------------------------->
					<div id="repaymenthistory" class="pop-formDiv clearfix" style="margin: 5px; margin-top: 5px; display: none;">
						<div class="center-content clearboth" style="min-width: 500px;">
							<div class="center-title3 position-re">
								还款历史<div name="suofang" class="show-hide l-icon-hide"></div>
							</div>
							<div class="center-txt" style="margin-bottom: 1px;">
								<div id="grid-top"></div>
							</div>
						</div>
					<!-- ------------------------------------------------------------------还款历史 end------------------------------------------------------------------ -->		
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- 提交功能按钮区 -->
	<div class="pop-footer5 clearboth" style="bottom: 1px;" id="tb_btn">
		<input id="tjbtn" onclick="save();" class="btn-saveT"
			onmouseover="this.className='btn-saveT-over'"
			onmouseout="this.className='btn-saveT'"
			onmousedown="this.className='btn-saveT-down'" type="button"
			style="margin-right: 7px;" />
		<input id="cancelBtnId" onclick="closeDialog();" class="btn-cancel"
			onmouseover="this.className='btn-cancel-over'"
			onmouseout="this.className='btn-cancel'"
			onmousedown="this.className='btn-cancel-down'" type="button" />
	</div>
	<script type="text/javascript">
		var wms_cre_credit_head_id = $.query.get("wms_cre_credit_head_id");//wms_cre_credit_head_id 为选择审批的记录id
		var wms_fina_cre_pay_id = $.query.get('wms_fina_cre_pay_id');//贷款还款表
		var payment_contract_type = $.query.get('payment_contract_type');//还款类型
		var wms_cre_appro_id = $.query.get("wms_cre_appro_id");//合同表主键
		var wms_cre_credit_group_id = $.query.get('wms_cre_credit_group_id');//组合贷主键
		var repay_period1;//本期期数
		var grid_top;
		var grid_mortgagelist;
		var grid_mortgagelist_data = {};
		var grid_repaymentdetails;
		var sum;//计算本期应还
		var wms_fina_cre_realrepay_info_id;//应还款信息表主键
		var repaymentdetails_params;//还款明细参数搜索条件
		var columns_repdetails;
		
		$(function() {
			if(wms_cre_credit_group_id != '') {
				//获取所有组合贷单据
				$.ajax({ 
		            type: "POST", 
		            url: global_param.context_name + "/cremanage/getWmsCreCreditHeadList.do",
		            async: false,
		            dataType: "json",
		            data: {
		            	"wms_cre_credit_head_id" : wms_cre_credit_head_id,
		            	"same_status" : 1,
		            	"wms_cre_credit_group_id" : wms_cre_credit_group_id,
		            	"cre_type" : '2',
		            	"repay_status_in" : '1,2',
		            	"sortname" : 't2.repay_status',
		            	"sortorder" : 'asc'
		            }, 
		            traditional: true,
		            success: function(json) {
		            	var addHTML = '<div class="l-tab-links-sub">' +
		            				      '<ul id="combine_loan" style="margin-top: 5px;">' +
		            				  	      '<li style="color:black; background-color: white; background: url();">组合贷单号：</li>';
		                var list = json.list;
		                $(list).each(function(i, o) {
		                	if(i == 0) {
		                		addHTML +=
	                				'<li class="l-selected-sub" style="' + (o.repay_status == 1 ? 'cursor: pointer;' : 'cursor: default;') + '">' +
										'<a>' + o.bill_code + (o.repay_status == 1 ? '（正常）' : '（逾期）') + '</a>' +
										'<div class="l-tab-links-item-left-sub"></div>' +
						                '<div class="l-tab-links-item-right-sub"></div>' +
										'<input type="hidden" name="wms_cre_credit_head_id" value="' + o.wms_cre_credit_head_id + '" />' +
										'<input type="hidden" name="repay_status" value="' + o.repay_status + '" />' +
									'</li>';
								initAllData(true);
		                	} else {
		                		addHTML += 
	                				'<li class="l-unselected-sub" style="' + (o.repay_status == 1 ? 'cursor: pointer;' : 'cursor: default;') + '">' +
										'<a>' + o.bill_code + (o.repay_status == 1 ? '（正常）' : '（逾期）') + '</a>' +
										'<div class="l-tab-links-item-left-sub"></div>' +
						                '<div class="l-tab-links-item-right-sub"></div>' +
										'<input type="hidden" name="wms_cre_credit_head_id" value="' + o.wms_cre_credit_head_id + '" />' +
										'<input type="hidden" name="repay_status" value="' + o.repay_status + '" />' +
									'</li>';
		                	}
		                });
						addHTML += '</ul></div>';
						$('#tab_titleT').prepend(addHTML);
						$('#change_tab').css('top', parseInt($('#change_tab').css('top')) + parseInt($('#combine_loan').css('height')) + 25 + 'px');
		            }
				});
			} else {
				initAllData(true);
			}
		});
		
		function initAllData() {
			$('#change_tab').startLoading();
			//获取客户基本信息
			$.getJSON(globalUtil.getTimestampUrl('/loanfina/wmsfinacrerepayinfobyfkfornor.do'),
				{"wms_cre_credit_head_id" : wms_cre_credit_head_id},
				function(json) {	
					if(json != null) {
						//正常还款基本情况赋值
						globalUtil.setFormVal("hk_base_repay_info", json);
						$("#total_late_fee1").val(parseFloat(json.total_late_fee) - parseFloat(json.cur_late_fee));
						//获取根据记录中期数和贷款ID,获取上期的调整，显示：本期应还款总额 和 本次收款情况
						$.getJSON(globalUtil.getTimestampUrl('/loanfina/wmsfinacrerealrepayInfoByNOw.do'),
							{'wms_cre_credit_head_id': wms_cre_credit_head_id, 'repay_no': json.repay_period},
							function(jsonadj) {
								$(".adjustment_amount").text(jsonadj.adjustment_amount || 0);//显示
								$("#adjustment_amount").text(jsonadj.adjustment_amount || 0);//显示后做后期运算
							}
						);	
						//获取根据本期期数和贷款ID,获取应还款信息
						$.getJSON(globalUtil.getTimestampUrl('/loanfina/wmsfinacrerealrepayInfoByNOw.do'),
							{'wms_cre_credit_head_id': wms_cre_credit_head_id, 'repay_no': json.repay_period + 1},
							function(jsonrealy) {
								init_realrepay_info(jsonrealy);//本期应还款情况赋值
								wms_fina_cre_realrepay_info_id = jsonrealy.wms_fina_cre_realrepay_info_id;
								repay_period1 = json.repay_period + 1;
							}
						);
					}
				}
			);
			//还款历史
			init_top_grid();
			//初始化抵押清单
			init_mortgagelist_grid();
			//初始换还款明细
			init_grid_repaymentdetails();
			//初始化POS机信息
			init_cre_pos();
			//查询抵押物详单信息
			searchRows();
			if(arguments[0]) {
				init_toolbar_morg();
				//初始化还款信息工具条
				init_repaymentdetail_toolbar();
				//查询还款明细
				search_repaymentdetails();
			} else {
				searchRows();
				//查询还款明细
				search_repaymentdetails();
			}
			$("#bcsk_total_repayment").val(0);
			$("#this_total_repayment").val(0);
			$('#change_tab').stopLoading();
		}
		
		//********************************************************************************************初始化应还款信息**********************************************************
		function init_realrepay_info(jsonrealy) {
			$("#total_repayment").text(jsonrealy.total_repayment || 0);//本期应还总额
			$("#is_total_repayment").text(parseFloat(jsonrealy.is_total_repayment || 0));//本期已还总额
			$("#un_total_repayment").text(parseFloat(jsonrealy.un_total_repayment || 0));//本期未还总额
			$("#org_repay_principal1").text(parseFloat(jsonrealy.org_repay_principal || 0));//本期应还本金
			$("#org_repay_interest1").text(parseFloat(jsonrealy.org_repay_interest || 0));//本期应还利息
			$("#repay_principal1").text(parseFloat(jsonrealy.repay_principal || 0));//已还本金
			$("#repay_interest1").text(parseFloat(jsonrealy.repay_interest || 0));//已还利息
			$("#bq_cur_late_fee").text(parseFloat(jsonrealy.bq_cur_late_fee || 0));//本期应还滞纳金
			$("#total_derate1").text(parseFloat(jsonrealy.total_derate || 0));//历史减免额		
		}
		//*****************************************************************************按照事先定义好的规则进行分配本次实际还款总额**********************************************
		 function getFPPrice() {
			 //计算总共收款金额=本次收款金额+本次减免金额+上期调整额
			 $("#this_total_repayment").val(parseFloat($("#bcsk_total_repayment").val() || 0) + parseFloat($("#this_mortgage").val() || 0) + parseFloat($("#adjustment_amount").text() || 0));
			 var parmInfo = {};		
			 parmInfo.wms_cre_credit_head_id = wms_cre_credit_head_id;//贷款单据ID
			 parmInfo.wms_fina_cre_pay_id = wms_fina_cre_pay_id;//还款信息表主键
			 parmInfo.repay_no = $("#repay_period").val();//本期应还期数
			 parmInfo.this_total_repayment = parseFloat($("#bcsk_total_repayment").val() || 0) + parseFloat($("#this_mortgage").val() || 0) + parseFloat($("#adjustment_amount").text() || 0);
			 parmInfo.this_amount_relief = parseFloat($("#this_amount_relief").val()||0);//减免额
			 $.getJSON(globalUtil.getTimestampUrl('/loanfina/getFPPrive.do'),
			     parmInfo,
				 function(json) {
					 $("#this_principal").text(json.repay_principal || 0);//匹配后的本金
					 $("#this_interest").text(json.repay_interest || 0);//匹配后的利息
					 $("#this_late_fees").text(json.bq_cur_late_fee || 0);//匹配后的滞纳金
					 $("#adjustment_amount1").text(json.adjustment_amount || 0);//匹配后的调整额
			 	}
			 );
		 }
	     //*******************************************************************************设置text文本 radio 为不可编辑模式******************************************************
		 function lookpage() {			
		     $("input[type=text]").attr({
			     "disabled" : "disabled"
			 });
			 $("input[type=radio]").attr({
				"disabled" : "disabled"
			 });
			 //设置文本域不可编辑
			 $("textarea[name='overdue_status']").attr({
				"disabled" : "disabled"
			 });
			 //设置文本域不可编辑
			 $("textarea[name='info_update']").attr({
				"disabled" : "disabled"
			 });
		 }
	     //*******************************************获取财务POS机信息
	     function init_cre_pos() {
		     var init_cre_pos_params = {
			     dest_url: '/loanfina/getIDByEmpty.do?isEmpty=true',
				 t_col_name: "wms_fina_cre_pos_id",
				 valueField: 'wms_fina_cre_pos_id',   //下拉框value对应的值，默认为id
				 textField: 'pos_code',    //下拉框text对应的值，默认为text
				 def_val: 'first',
				 input_width: '135'
			 };
			 global_ligerui_extend.initCombox("wms_fina_cre_pos_id", null, init_cre_pos_params);
			 global_ligerui_extend.initComboxDefVal("wms_fina_cre_pos_id");	
	     }
	     //获取相应的卡号
	     function getPosBankCard() {
		     var value = global_ligerui_extend.getComboxVal("wms_fina_cre_pos_id");
			 $.getJSON(globalUtil.getTimestampUrl('/loanfina/wmsfinacreposinfobypk.do'),//根据配置Pos机主键获取相应信息
			     {
				     "wms_fina_cre_pos_id" : value
				 },
				 function(json) {
				     if(json == null) {
			   	  	     $("#pos_bank_card").val("");
					 } else {
						 $("#pos_bank_card").val(json.pos_bank_card);
					 }
				 }
			 );
	     }
	   
		 //*******************************************************************************************初始化抵押物工具条*******************************************
		 //抵押物清单--抵押物编号
		 function getFinaDYCode() {
		     var json = globalUtil.syncGetJson("/loanfina/getFinaDYCode.do");//同步获取需要导出的数据内容
			 return json;
		 }
		 
		 function init_toolbar_morg() {
			 var toolbarItemData = [];
			 toolbarItemData.push({
		         text: '新增',
		         click: addRows,
		         icon: 'add'
		     });
	         toolbarItemData.push({
	             line: true
	         }); 
	   	     toolbarItemData.push({
	             text: '查询',
	             click: searchRows,
	             icon: 'search'
	         });
	         toolbarItemData.push({
	             line: true
	         });
	   		 $("#mortgagelisttoolbar").ligerToolBar({
	       		 items: toolbarItemData
	   		 });
		 }
		 
		 var real_mortgage_price = "";//实际价值
		 var d_value_new = "";//差值
		 var status_val = [];//标记是否改变过抵押形式
		 
		 //初始化加载抵押物信息
		 function init_mortgagelist_grid() {
			 var isEnableArr = [{"mortgage_status": "1", "mortgage_status_val": '已抵押'}, {"mortgage_status": "0", "mortgage_status_val": '未抵押'}];
			 var isPass=[{"auditor_result": "1", "auditor_result_val": '通过'},{"auditor_result": "0", "auditor_result_val": '未通过'}];
			 var auditorPerson = searchPerson();
			 var columns_mortgagelist = [{
			 	display: '抵押物编号',
			 	name: 'mortgage_code',
			 	resizable: false,
			 	width: 125,
			 	minWidth: 125
			 }, {
			 	display: '抵押物名称',
			 	name: 'mortgage_name',
			 	resizable: false,
			 	width: 100,
			 	minWidth: 100,
			 	editor: {
			 		type: 'text'
			 	}
			 }, {
			 	display: '抵押时间',
			     name: 'mortgage_date',
		         type: 'date', //日期类型必备
		         format: "yyyy-MM-dd",//日期类型必备
		         resizable: false,
		         width: 100,
		         minWidth: 100,
		         editor: { 
			 		type: 'date', // 该列为日期类型
		         }  
			 }, {
			 	display: '抵押数量',
			 	name: 'mortgage_count',
			 	resizable: false,
			 	width: 60,
			 	minWidth:60,
			 	editor: {
			 		type: 'text'
			 	}
			 }, {
			 	display: '预估价值(元)',
			 	name: 'should_mortgage_price',
			 	resizable: false,
			 	width: 100,
			 	minWidth: 100,
			 	editor: {
			 		type: 'text',
			 		ext: {
			 			onChangeValue: function(value) { 
			 				var textObj = this;
			 				var d_value = 0;
			 				var real_mortgage_price = global_ligerui_extend.getCellValue(grid_mortgagelist, textObj, 'real_mortgage_price');
			 				if(value != "" && value != null && globalUtil.isNum(value)) {
			 					if(value != "" &&value !=null && globalUtil.isNum(real_mortgage_price)) {
			 						d_value = parseInt(value) - parseInt(real_mortgage_price);
			 						global_ligerui_extend.updateCell(grid_mortgagelist, textObj, 'd_value', d_value);
			 					}
			 				}
			 			}
			 		} 
			 	}
			 }, {
			 	display: '实际价值(元)',
			 	name: 'real_mortgage_price',
			 	resizable: false,
			 	width: 100,
			 	minWidth: 100,
			 	editor: {
			 		type: 'text',
			 		ext:{
			 			onChangeValue: function(value){ 
			 				var textObj = this;
			 				var d_value=0;
			 				var should_mortgage_price = global_ligerui_extend.getCellValue(grid_mortgagelist, textObj, 'should_mortgage_price'); // 获取同行有无固定期限的值
			 				if(should_mortgage_price !="" && should_mortgage_price != null && globalUtil.isNum(should_mortgage_price)) {
			 					if(value != "" && value != null && globalUtil.isNum(value)) {
			 						d_value = parseInt(should_mortgage_price) - parseInt(value);
			 						global_ligerui_extend.updateCell(grid_mortgagelist, textObj, 'd_value', d_value);
			 						global_ligerui_extend.updateCell(grid_mortgagelist, textObj, 'real_mortgage_price', value);
			 						real_mortgage_price = value;
			 						d_value_new = d_value;
			 					}
			 				}
			 			}
			 		}  
			 	},
			 }, {
			 	display: '差值',
			 	name: 'd_value',
			 	resizable: false,
			 	width: 80,
			 	minWidth: 80,
			 	editor: {
			 		type: 'text'
			 	}
			 }, {
			 	display: '审核人',
			 	name: 'auditor_name',//auditorPerson
			 	resizable: false,
			 	width: 70,
			 	minWidth: 70,
			 	editor: {
			 		type: 'select', // 该列为可编辑状态
			 		data: auditorPerson, 
			 		valueField: 'auditor_name', 
			 		textField: 'person_name' 
			 	},
			 	render: function (rowdata, nowRowIndex, value, column) {
			 			return global_ligerui_extend.gridRenderSelectedValue(rowdata, nowRowIndex, value, column);	
			 	}
			 }, {
			 	display: '审核结果',
			 	name: 'auditor_result',
			 	resizable: false,
			 	width: 80,
			 	minWidth:80,
			 	editor: { 
			 		type: 'select', // 该列为可编辑状态
			 		data: isPass, 
			 		valueField: 'auditor_result', 
			 		textField: 'auditor_result_val' 
			 	},
			 	render: function (rowdata, nowRowIndex, value, column) {
			 			return global_ligerui_extend.gridRenderSelectedValue(rowdata, nowRowIndex, value, column);	
			 	}
			 }, {
			 	display: '审核时间',
			     name: 'auditor_datetime_str',
		         type: 'date', //日期类型必备
		         format: "yyyy-MM-dd hh:mm",//日期类型必备
		         resizable: false,
		         width: 130,
		         minWidth:130,
		         editor: { 
			 		type: 'date', // 该列为日期类型
			 		showTime: true
		         } 
			 }, {
			 	display: '抵押形式',
			 	name: 'mortgage_status',
			 	resizable: false,
			 	width: 90,
			 	minWidth: 90,
			 	editor: { 
			 		type: 'select', // 该列为可编辑状态
			 		data: isEnableArr, 
			 		valueField: 'mortgage_status', 
			 		textField: 'mortgage_status_val',
			 		ext:{
			 			onSelected: function(value) { 
			 				var textObj = this;
			 				var nowRowIndex = textObj.options.nowRowindex;//获取当前行
			 				if(value == "1") {
			 					status_val[nowRowIndex] = "1";
			 				} else {
			 					status_val[nowRowIndex] = "0";
			 				}
			 			}
			 		}  
			 	},
			 	render: function (rowdata, nowRowIndex, value, column) {
			 		return global_ligerui_extend.gridRenderSelectedValue(rowdata, nowRowIndex, value, column);	
			 	}
			 }, {
			     display: '操作',
			 	 name: '',
			 	 resizable: false,
			 	 width: 100,
			 	 minWidth: 100,
			 	 isSort: false,
			 	 render: function (rowdata, rowindex, value) {
			 	     var h = "";
	                 if (!rowdata._editing) {
	                     var mortgage_status = rowdata.mortgage_status;
	                 	 if(mortgage_status == "" || mortgage_status == null) {
	                 	     mortgage_status = "0";
	                 	 }
	                     h += "<a href='javascript:beginEdit(" + rowindex + "," + mortgage_status + ")'>修改</a>";
	                     if(rowdata.mortgage_status == 0) {//如果已经抵押不能删除只能修改实际价值
	                     	 h += "<a href='javascript:deleteRow(" + rowindex + "," + rowdata.wms_fina_cre_mortgage_list_id + ")'>删除</a>"; 
	                     }
	                 } else {
	                     h += "<a href='javascript:endEdit(" + rowindex + ")'>提交</a>";
	                     h += "<a href='javascript:cancelEdit(" + rowindex + ")'>取消</a>"; 
	                 }
	                 return h;
			 	 }
			 }];
			 grid_mortgagelist = $("#grid_mortgagelist").ligerGrid({
			 	columns: columns_mortgagelist,
	    	 	url: global_param.context_name +'/loanfina/WmsFinaCreMortgageListgetListByEntity.do?wms_cre_credit_head_id=' + wms_cre_credit_head_id,
	    	 	sortName: 'mortgage_date', // 排序列名
			 	sortOrder: 'desc', // 排序方式
	    	 	rownumbers: true,
	    	 	allowUnSelectRow: true,
	    	 	enabledEdit: true,
	    	 	usePager: true,
	    	 	width: '100%',
			 	height:'450',
	    	 	heightDiff: -4,
	    	 	parms: {
	    	 		_filterParms: -1
	    	 	},
			 	clickToEdit:false
			 });
		}
		//添加grid行
		function addRows() {
			var manager = $("#grid_mortgagelist").ligerGetGridManager();   
			manager.endEdit();
			manager.addRow({
				'mortgage_code':getFinaDYCode(),
				'mortgage_name':'',
				'mortgage_date':'',
				'mortgage_count':'',
				'should_mortgage_price':'',
				'real_mortgage_price':'',
				'd_value':'',
				'auditor_name':'',
				'auditor_result':'',
				'auditor_datetime':'',
				'mortgage_status':''
			});
		}
		
		//删除新增grid行
		function delRow() {
			//选择某一行的操作
	        var manager = $("#grid_mortgagelist").ligerGetGridManager();   
	        manager.deleteSelectedRow();
		}
		
		//保存新增的数据
		function saveRow() {
			
		}
		
		//查询时间范围内所有的抵押物信息
		function searchRows() {
			var param = {};
			param.mortgage_date_start = $("#mortgage_date_start").val();
			param.mortgage_date_end = $("#mortgage_date_end").val();
	        global_ligerui_extend.search(grid_mortgagelist, param);
		}
		
		//初始化抵押列表审批人列表选项
		function searchPerson() {
			//获取抵押物清单-中的审批人
			wmsfinaauditorperson = globalUtil.syncGetJson("/loanfina/wmsfinaauditorpersongetListByEntity.do");//同步获取需要导出的数据内容
			return wmsfinaauditorperson;
		}
		
		function beginEdit(rowid,val) { 
			var manager = $("#grid_mortgagelist").ligerGetGridManager(); 
			if(val == 0) {
	       	    manager.beginEdit(rowid);
			} else {
				manager.beginEdit(rowid);
				cancelEditNew(manager,rowid);
			}
	    }
		
	    function cancelEdit(rowid) { 
	        var manager = $("#grid_mortgagelist").ligerGetGridManager();   
	        manager.cancelEdit(rowid);
	    }
	    
	    //提交操作抵押物信息操作
	    function endEdit(rowid) {
	    	var param = getGrid(grid_mortgagelist)[rowid];
	    	if(ischeck(param)) {
				return;
			}
	        saveUpdateMortgage(param,rowid);//保存或者更改抵押物
	    }
	    
	    //获取审核人姓名
	    function getName(id) {
	    	var auditor_name = "";
	    	for(var i = 0; i < wmsfinaauditorperson.length; i++) {
	    		if(wmsfinaauditorperson[i].auditor_name == id) {
	    			auditor_name = wmsfinaauditorperson[i].person_name;
	    		}
	    	}
	    	return auditor_name;
	    }
	    
	    //保存抵押物详情
	    function saveUpdateMortgage(param,rowid) {
	    	//抵押物已抵押,未冲账
	        if(param.mortgage_status == "1" && strike_balance_status == "0") {
	    	    var paramNew = {};
	    		paramNew.wms_fina_cre_mortgage_list_id = param.wms_fina_cre_mortgage_list_id;//主键
	    		paramNew.wms_cre_credit_head_id = wms_cre_credit_head_id;
	        	paramNew.real_mortgage_price = real_mortgage_price;//实际价值
	        	paramNew.d_value = d_value_new;//差值
	        	param = paramNew;
	    	} else if(param.mortgage_status=="1" && strike_balance_status == "1") {//抵押物已抵押,已冲账
	    		
	    	} else {
	    		param.wms_cre_credit_head_id = wms_cre_credit_head_id;
		    	param.wms_fina_cre_pay_id = wms_fina_cre_pay_id;
		    	param.wms_cre_appro_id = wms_cre_appro_id;
		    	param.auditor_datetime = param.auditor_datetime_str;
		    	delete param.last_update_datetime;
		    	delete param.last_update_datetime_str;
		    	param.auditor_id = param.auditor_name;
		    	param.auditor_name = getName(param.auditor_name);
		    	if(param.strike_balance_status != 1) {
		    		param.strike_balance_status = "0";//冲账状态
		    	}	
		    	param.mortgage_code = mortgage_code;
	    	}
			$.post(globalUtil.getTimestampUrl("/loanfina/wmsfinacremortgagelistsaveUpdateMortgage.do"), param,
			function(data) {
	        	if (data === 'success') {
	                globalUtil.successMsg(globalErrorMsg['100002']);//保存成功 
	            	searchRows();
	            } else {
	                globalUtil.errorMsg(globalErrorMsg['100012']); //保存失败
	            }
	        });
	    }
	    
	    //检查用户录入抵押物信息
	    function ischeck(param) {
			if(param.mortgage_count != "" && param.mortgage_count != null && !globalUtil.isNum(param.mortgage_count)) {
				globalUtil.warnMsg(globalErrorMsg['900160']);//抵押数量
				return true;
			}
			if(param.should_mortgage_price != "" && param.should_mortgage_price != null&& !globalUtil.isNum(param.should_mortgage_price)) {
				globalUtil.warnMsg(globalErrorMsg['900161']);//预估价值
				return true;
			}
			if(param.real_mortgage_price != "" && param.real_mortgage_price != null && !globalUtil.isNum(param.real_mortgage_price)) {
				globalUtil.warnMsg(globalErrorMsg['900162']);//实际价值
				return true;
			}
			if(param.d_value != "" && param.d_value != null && !globalUtil.isNum(param.d_value)) {
				globalUtil.warnMsg(globalErrorMsg['900163']);//d_value
				return true;
			}
	    }
	    
	    //删除选择的行
	    function deleteRow(rowid,wms_fina_cre_mortgage_list_id) {
		    globalUtil.confirmMsg(globalErrorMsg['100016'],
		   	    function(yes) { //确认删除
		   	    	if(yes) {
		   	    		if(wms_fina_cre_mortgage_list_id != "" && 
		   	    				wms_fina_cre_mortgage_list_id != null && 
		   	    				wms_fina_cre_mortgage_list_id != "undefined") {
		   	        	    deleteMortgage(wms_fina_cre_mortgage_list_id);
		   	        	} else {
		   	        		var manager = $("#grid_mortgagelist").ligerGetGridManager();
		   	         		manager.deleteSelectedRow();
		   	        	}
		   	    	}
		   	    }
		    );
	   	}
	    
	    //删除抵押物详情
	    function deleteMortgage(wms_fina_cre_mortgage_list_id) {
	    	var param = {};
	    	param.wms_fina_cre_mortgage_list_id = wms_fina_cre_mortgage_list_id;
	    	param.enable_flag = "0";
	    	$.post(globalUtil.getTimestampUrl("/loanfina/wmsfinacremortgagelistupdate.do"), param,
				function(data) {
		        	if (data === 'success') {
		                searchRows();
		            } else {
		                globalUtil.errorMsg(globalErrorMsg['900158']); //操作失败
		            }
		        }
	    	);
	    }
	    
	    //获取选择抵押信息
	    function getMortgageListInfo() {
	    	var url = globalUtil.getHtml("mortgageList.html?wms_cre_credit_head_id=" + wms_cre_credit_head_id);
	    	dialog = $.ligerDialog.open({
		        url: url,
		        title: '选择抵押物清单',
		        width: 1000,
		        height: globalUtil.setDialogHeight(450),
		        onHiddenOrClose: function() {
		    	},
		        isResize: false
	    	});
	    }
	    
	    //选择相应的抵押物，返回相应的数据
	    function getCheckedMortgageAll(data) {
			var mortgageIds = [];//记录已经抵押的物品的ID
			var this_mortgage_all = 0;//记录已经抵押物合计总值
	    	for(var j = 0; j < data.length; j++) {
	    	    mortgageIds.push(data[j].wms_fina_cre_mortgage_list_id);
	    		if(data[j].real_mortgage_price == undefined) {
	    			this_mortgage_all = this_mortgage_all + parseFloat(data[j].should_mortgage_price);    
	    		} else {
	    		    this_mortgage_all = this_mortgage_all + parseFloat(data[j].real_mortgage_price);    			
	    		}
			}
	    	if(data.length>0) {
				$("#whether_mortgage").val(1);//是否有抵款    		
	    	}
			$("#this_mortgage").val(this_mortgage_all);//抵款额
			$("#this_collateral_ids").val(mortgageIds);//抵押物ID
			//如果有抵款额，需要重新匹配一遍
			getFPPrice();
	    }
	    
		//*************************************************************************************还款明细列表********************************************************************************
		//初始化还款明细表工具条
		function init_repaymentdetail_toolbar() {
		    var toolbarItemData = [];
		   	toolbarItemData.push({
	            text: '查询',
	            click: search_repaymentdetails,
	            icon: 'search'
	        });
	        toolbarItemData.push({
	            line: true
	        }); 
		    toolbarItemData.push({
	            text: '清空',
	            click: clear_repaymentdetail,
	            icon: 'empty'
		    });
	        toolbarItemData.push({
	            line: true
	        }); 
		    $("#repaymentdetails_centertoolbar").ligerToolBar({
		        items: toolbarItemData
		   	});
		}
		
		//初始化还款明细数据grid
		function init_grid_repaymentdetails() {
			columns_repdetails = [{
				display: '还款流水号',
		        name: 'repayment_history_code',
		        resizable: false,
		        width: 180,
		        minWidth: 180
		    }, {
		        display: '还款日期',
		        name: 'repayment_date',
		        resizable: false,
		        width: 150,
		        minWidth: 150	
		    }, {
		        display: '还款项类型',
		        name: 'repayment_style',
		        resizable: false,
		        width: 120,
		        minWidth: 120
		    }, {
		        display: '还款金额(元)',
		        name: 'repayment_price',
		        resizable: false,
		        width: 120,
		        minWidth: 120
		    }, {
		        display: '还款期数',
		        name: 'repay_no',
		        resizable: false,
		        width: 21,
		        minWidth: 120
		    }, {
		        display: '备注',
		        name: 'this_repayment_remark',
		        resizable: false,
		        width: 180,
		        minWidth: 180
		    }, {
	            display: '附件',
	            name: '',
	            width: 160,
	            minWidth: 160,
	            render: function (rowdata, rowindex, value) {
	                return "<div class='pop-form-item clearfix' id='" + rowdata.wms_fina_cre_repayment_details_id + "' style='height: auto'></div>" +
	                	   "<a class='btn' href='#' style='margin-right: 37px;' onclick='openAddAttDialog(" + rowdata.wms_fina_cre_repayment_details_id + ")' >上传</a>";
				}
		    }];
			
			grid_repaymentdetails = $("#grid_repaymentdetails").ligerGrid({
		    	columns: columns_repdetails,
		    	url: global_param.context_name + '/loanfina/getListByEntity.do?wms_cre_credit_head_id=' + wms_cre_credit_head_id,
		    	sortName: 'repayment_date', // 排序列名
				sortOrder: 'asc', // 排序方式
				rownumbers: true,
	    		allowUnSelectRow: true,
	    		usePager: true,
	    		width: '100%',
	    		height:400,
	    		heightDiff: -4,
	    		onAfterShowData: function(currentData) {
	    			$.each(currentData.Rows, function(i, n) {
	    				$.each(n.listAtt, function(j, obj) {
	        				fileArr.push(obj)
	        			});
	    				detailIds.push(n.wms_fina_cre_repayment_details_id);
	    				init_attr(n.listAtt, n.wms_fina_cre_repayment_details_id)
	    			});
	    		},
	    		parms: {
	    		    _filterParms: -1
	    		}
		    });
		}
		
		////上传附件********/////
		var dialog_att;
		//上传附件列表
	 	var fileArr = [];
		//还款明细id
		var detailIds = [];
		
		//打开附件上传页面
		function openAddAttDialog(data_detail_name) {
			var url = globalUtil.getHtml("../creditManage/addFileForCre.html?data_detail_name=" + data_detail_name);
			dialog_att = $.ligerDialog.open({
		        url: url,
		        title: '上传附件',
		        width: 650,
		        height: globalUtil.setDialogHeight(250),
		        onHiddenOrClose: function() {
		        	//alert('关闭或隐藏都调用的事件!');
		    	},
		        isResize: false
			});
		}
		
		//添加上传文件的信息链接
		function addAttFile(newfileArr, objid) {
			fileArr = fileArr.concat(newfileArr);
			var filehtml = $("#" + objid).html();
			for(var i = 0; i < newfileArr.length; i++) {
				var nnme = newfileArr[i].attachment_new_name.replace('/', 'thxg1');
				nnme = nnme.replace('/','thxg2');
				filehtml += '<div id="delUploadDivId' + nnme + '">';
				filehtml += '<a target="_blank" href="' + global_param.upload_file_url + newfileArr[i].attachment_address + '">' + newfileArr[i].attachment_old_name + '</a>';
				filehtml += '<img src="../../images/icon/icon-close.gif" onclick="deleteFile(\'' + nnme + '\')"/>';
				filehtml += '</div>';
			}		
			$("#" + objid).html(filehtml);
		}
		
		//删除上传文件的信息链接
		function deleteFile(filename) {
		   	$.ligerDialog.confirm(globalErrorMsg['100016'],
		    function(yes) {
		    	if (yes) {
		    		$("#delUploadDivId" + filename).remove();
		    		filename = filename.replace('thxg1','/');
		    		filename = filename.replace('thxg2','/');
		    		for(var i = 0; i < fileArr.length; i++) {
		    			if(filename == fileArr[i].attachment_new_name) {
		    				fileArr.splice(i, 1);
		    				break;
		    			}
		    		}
		    	}                                            
			});
		}
		
		//获取上传附件内容，可以删除查看功能
		function init_attr(param, objid) {
			var filehtml = $("#" + objid).html();
			for(var i = 0; i < param.length; i++) {
				var nnme = param[i].attachment_new_name.replace('/','thxg1');
				nnme = nnme.replace('/','thxg2');
				filehtml += '<div id="delUploadDivId' + nnme + '">';
				filehtml += '<a target="_blank" href="' + global_param.upload_file_url + param[i].attachment_address + '">' + param[i].attachment_old_name + '</a>';
				filehtml += '<img src="../../images/icon/icon-close.gif" onclick="deleteFile(\'' + nnme + '\')"/>';
				filehtml += '</div>';
			}		
			$("#" + objid).html(filehtml); 
		}
		
		//初始化搜索参数
	    function init_repaymentdetails_Params() {
	    	repaymentdetails_params = globalUtil.getFormParam("search_repaymentdetailsbar");
	    }
		
	    //查询
	    function search_repaymentdetails() {
	    	init_repaymentdetails_Params();
	        global_ligerui_extend.search(grid_repaymentdetails, repaymentdetails_params);
	    }
	    
	    //清空还款明细查询数据
	    function clear_repaymentdetail() {
	    	$("#repayment_date_begin").val("");
	    	$("#repayment_date_end").val("");
	    }
	    //*****************************************************************************************************************************************************************
		//还款历史
		function init_top_grid() {
			var columns = [{
				display: '还款流水号',
		        name: 'repayment_history_code',
		        resizable: false,
		        width: 150,
		        minWidth: 150
		    }, {
		        display: '还款日期',
		        name: 'repayment_date_str',
		        resizable: false,
		        width: 150,
		        minWidth: 150	
		    }, {
		        display: '还款总额（元）',
		        name: 'this_total_repayment',
		        resizable: false,
		        width: 120,
		        minWidth: 120
		    }, {
		        display: '其中，本金（元）',
		        name: 'this_principal',
		        resizable: false,
		        width: 120,
		        minWidth: 120
		    }, {
		        display: '利息（元）',
		        name: 'this_interest',
		        resizable: false,
		        width:120,
		        minWidth: 120
		    }, {
		        display: '滞纳金（元）',
		        name: 'this_late_fees',
		        resizable: false,
		        width: 120,
		        minWidth: 120
		    }, {
	        	display: '减免额（元）',
	            name: 'this_amount_relief',
	            width: 120,
	            minWidth: 120
	        }, {
	        	display: '操作人',
	            name: 'create_user_name',
	            width: 140,
	            minWidth: 140
	        }];
			
		    grid_top = $("#grid-top").ligerGrid({
		    	columns: columns,
		    	url: global_param.context_name + '/loanfina/wmsfinacrerepaymenthistoryinfobyhk.do?wms_cre_credit_head_id=' + wms_cre_credit_head_id,
	    		rownumbers: true,
	    		allowUnSelectRow: true,
	    		usePager: false,
	    		width: '100%',
	    		height:'70%',
	    		heightDiff: -4
		    });
		}
	    //************************************************************点击超链接弹出对应的还款历史数据*********************************************
	    function getRepaymentHistory() {
	    	var repay_period = repay_period1;
	    	var url = globalUtil.getHtml("repaymenthistory.html?wms_cre_credit_head_id=" + wms_cre_credit_head_id + "&repay_period=" + repay_period);
	    	dialog = $.ligerDialog.open({
		        url: url,
		        title: '本期还款历史清单',
		        width: 1000,
		        height: globalUtil.setDialogHeight(450),
		        onHiddenOrClose: function() {
		    	},
		        isResize: false
	    	});
	    }
		//*************************************************************正常还款确认***************************************************************
	    function save() {
	    	var parmCtinfo = {};
	    	var parmCtinfo = globalUtil.getFormParam("kh_bc_repay_info");//客户本次提交的信息
	    	//校验收款POS机是否选择
	    	//如果减免额等于0 做校验
	    	if(parmCtinfo.this_amount_relief == 0) {
	    		if(parmCtinfo.wms_fina_cre_pos_id == -1) {
	        		globalUtil.warnMsg(globalErrorMsg['600107']);//请选择还款POS机
	        		return;
	        	}
	    	}
	    	parmCtinfo.this_principal = parseFloat($("#this_principal").text());//本次分配的本金
	    	parmCtinfo.this_interest = parseFloat($("#this_interest").text());//本次分配的利息
	    	parmCtinfo.this_late_fees = parseFloat($("#this_late_fees").text());//本次分配的滞纳金
	    	parmCtinfo.adjustment_amount = parseFloat($("#adjustment_amount1").text());//本次分配的调整额
	    	parmCtinfo.repay_no = $("#repay_period").val();
	    	parmCtinfo.wms_cre_credit_head_id = wms_cre_credit_head_id;
	    	parmCtinfo.wms_cre_appro_id = wms_cre_appro_id;
	    	parmCtinfo.wms_fina_cre_pay_id = wms_fina_cre_pay_id;
	    	parmCtinfo.wms_fina_cre_realrepay_info_id = wms_fina_cre_realrepay_info_id;
	    	if($("#whether_mortgage").val() == 1) {//说明有抵款
	    		parmCtinfo.whether_mortgage = $("#whether_mortgage").val();
				parmCtinfo.this_mortgage = $("#this_mortgage").val();//抵款额
		    	parmCtinfo.this_collateral_ids = $("#this_collateral_ids").val();//抵押物主键IDS
	    	} else {
	    		parmCtinfo.whether_mortgage = 0;//无抵款额
	    	}
	    	//附件上传信息
	    	$.each(fileArr, function(i, n) {
	    		if(n.wms_fina_cre_repayment_details_id == null || n.wms_fina_cre_repayment_details_id == "") {
	    			n.wms_fina_cre_repayment_details_id = n.data_detail_name;
	    		}
	    	});
	    	parmCtinfo.beanJSON = JSON.stringify(fileArr);
	    	parmCtinfo.detailIds = JSON.stringify(detailIds);
			$.post(globalUtil.getTimestampUrl("/loanfina/wmsfinacrerepaymenthistorysave.do"), parmCtinfo,
				function(data) {
					if (data === 'success') {
		            	 globalUtil.successMsg(globalErrorMsg['100002'],
		            	     function() {
		            		 	$('#combine_loan .l-selected-sub').remove();
		            			//查询剩余还款状态为正常的li条数
		            	    	var length = 0;
		            	    	$('#combine_loan .l-unselected-sub').each(function(i, o) {
		            	    		if($(o).find('input[name=repay_status]').val() == 1) {
		            	    			length++;
		            	    		}
		            	    	});
		            	    	if(length > 0) {
			 						$('#combine_loan .l-unselected-sub:eq(0)').removeClass('l-unselected-sub').addClass('l-selected-sub');
			 						wms_cre_credit_head_id = $('#combine_loan .l-selected-sub:eq(0)').find('input[name=wms_cre_credit_head_id]').val();
			 				    	initAllData();//重新加载数据
			 				    	refreshAndClosePage(false);
		            	    	} else {
			                	    refreshAndClosePage(true);
			 					}
		            	     }
		            	 );//保存成功
		            } else {
		                globalUtil.errorMsg(globalErrorMsg['100012']); //保存失败
		            }
		        }
			);
	    }
		//****************************去掉空数据 并格式化日期****************************
		function getGrid(grid) {
	        grid.endEdit();
			var data_all = grid.getData();
			var griddata = [];
			for(var i = 0; i < data_all.length; i++) {
			    var data = data_all[i];
			 	var isEmpty = true;
			 	if(data) {
				    for(var key in data) {
						if($.trim(key) == '' || $.trim(key) == '__status') {continue;}
						if(!globalUtil.isEmpty(data[key])) {
							if(data[key] instanceof Date) {
								data[key] = data[key].format('yyyy-MM-dd');//格式化日期类型数据
							}
						    isEmpty = false;
						}
					}
				}
				if(!isEmpty) {
					griddata.push(data);
				}
			}
		    return griddata;
		}
		
	    //@param  {rowParm} rowindex或者rowdata
	    function cancelEditNew(manager,rowParm) {
	        var g = manager;
	        var rowdata = g.getRow(rowParm);
	        if (!g.editors[rowdata['__id']]) return;
	        if (g.trigger('cancelEdit', { record: rowdata, rowindex: rowdata['__index'] }) == false) return;
	        for (var columnid in g.editors[rowdata['__id']]) {
	            var o = g.editors[rowdata['__id']][columnid];
	            if(columnid!="c107") {
	         	    if (o.editor.destroy) o.editor.destroy(o.input, o.editParm); 
	            }
	        }
	        delete g.editors[rowdata['__id']];
	        reRenderNew(manager,{rowdata: rowdata});
	    }
	
	 	function reRenderNew(ob, e) {
	        var g = ob, p = ob.options;
	        e = e || {};
	        var rowdata = e.rowdata, column = e.column;
	        if (column && (column.isdetail || column.ischeckbox)) return;
	        if (rowdata && rowdata[p.statusName] == "delete") return;
	        if (rowdata && column) {
	            var cell = g.getCellObj(rowdata, column);
	            $(cell).html(g._getCellHtml(rowdata, column));
	            if (!column.issystem) {
	                g.setCellEditing(rowdata, column, false);
	            }
	        }
	        else if (rowdata) {
	           $(g.columns).each(function(i) { 
		           if( i!= 6) {
		               reRenderNew(ob, {rowdata: rowdata, column: this});  
		           }  
		       });
	        }
	    }
		/*******************************************************实现tab页面切换*******************************************************/
		
		//切换组合贷单据tab页
		$(document).on('click', '.l-unselected-sub', function() {
			if($(this).find('input[name=repay_status]').val() == 1) {//还款状态为正常的单据才可以点击切换
				$(this).removeClass('l-unselected-sub').addClass('l-selected-sub').
	    	    siblings('li:gt(0)').removeClass('l-selected-sub').addClass('l-unselected-sub');
		    	wms_cre_credit_head_id = $(this).find('input[name=wms_cre_credit_head_id]').val();
		    	initAllData();//重新加载数据
			}
	    });
		
		function changeTab(id) {
		    var arbdocument = document.getElementById("arbdocument"); //正常还款结算清单
			var mortgagelist = document.getElementById("mortgagelist"); //抵押物详情
			var repaymentdetails = document.getElementById("repaymentdetails"); //还款明细
			var repaymenthistory = document.getElementById("repaymenthistory"); //还款历史
			if (id == 'arbdocument') {
	    	    document.getElementById("tabbody1").className = "tabbody1";
	    	    document.getElementById("tabbody2").className = "tabbody2";
	    	    document.getElementById("tabbody3").className = "tabbody2";
	    	    document.getElementById("tabbody4").className = "tabbody2";
	    	    arbdocument.style.display = '';
	    	    mortgagelist.style.display = 'none';
	    	    repaymentdetails.style.display = 'none';
	    	    repaymenthistory.style.display = 'none';
			} else if(id =='mortgagelist') {
			    document.getElementById("tabbody1").className = "tabbody2";
			    document.getElementById("tabbody2").className = "tabbody1";
			    document.getElementById("tabbody3").className = "tabbody2";
			    document.getElementById("tabbody4").className = "tabbody2";
			    arbdocument.style.display = 'none';
			    mortgagelist.style.display = '';
			    repaymentdetails.style.display = 'none';
			    repaymenthistory.style.display = 'none';
			} else if(id =='repaymentdetails') {
			    document.getElementById("tabbody1").className = "tabbody2";
			    document.getElementById("tabbody2").className = "tabbody2";
			    document.getElementById("tabbody3").className = "tabbody1";
			    document.getElementById("tabbody4").className = "tabbody2";
			    arbdocument.style.display = 'none';
			    mortgagelist.style.display = 'none';
			    repaymentdetails.style.display = '';
			    repaymenthistory.style.display = 'none';
			} else if (id == 'repaymenthistory') {
			    document.getElementById("tabbody1").className = "tabbody2";
			    document.getElementById("tabbody2").className = "tabbody2";
			    document.getElementById("tabbody3").className = "tabbody2";
			    document.getElementById("tabbody4").className = "tabbody1";
			    arbdocument.style.display = 'none';
			    mortgagelist.style.display = 'none';
			    repaymentdetails.style.display = 'none';
			    repaymenthistory.style.display = '';	
		    }
	    }
		/***********************************************************逾期历史********************************************************/
		function overdueHistory() {
		    var url = globalUtil.getHtml("overdueHistory.html?wms_cre_credit_head_id=" + wms_cre_credit_head_id);	
			dialog = $.ligerDialog.open({
		        url: url,
		        title: '逾期历史',
		        width: 1000,
		        height: globalUtil.setDialogHeight(600),
		        onHiddenOrClose: function() {
		    	},
		        isResize: false
			});
		}
		/*******************************************************实现子页面关闭刷新*******************************************************/
		function refreshAndClosePage(flag) {   
			window.parent.search();
			if(flag) {
				closePage();
			}
		}
		/*******************************************************实现关闭页面*******************************************************/
		function closePage() {
			window.parent.dialog.hide();
		}
		function closeDialog() {
			window.parent.dialog.hide();
		}
	</script>
</body>
</html>
