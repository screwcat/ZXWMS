<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- namespace必须指向Dao接口 -->
<mapper namespace="com.zx.emanage.inve.persist.WmsInveRedeemDao">
	<!-- get entity by pk -->
	<select id="get" parameterType="int" resultType="WmsInveRedeem">
		select
		wms_inve_redeem_id,
		wms_inve_customer_id,
		bill_code,
		data_status,
		(select value_meaning from wms_sys_dict_data where wms_sys_dict_id=60 and value_code=data_status) as data_status_name,
		id_card,
		cus_name,
		total_invest_amount,
		redeem_reason,
		date_format(redeem_date,'%Y-%m-%d') as redeem_date_str,
		redeem_date,
		supervisor_advice,
		supervisor_result,
		date_format(supervisor_date,'%Y-%m-%d') as supervisor_date_str,
		supervisor_date,
		submanager_advice,
		submanager_result,
		date_format(submanager_date,'%Y-%m-%d') as submanager_date_str,
		submanager_date,
		manager_advice,
		manager_result,
		date_format(manager_date,'%Y-%m-%d') as manager_date_str,
		manager_date,
		is_special_approval,
		special_approval_operator_id,
		date_format(special_approval_date,'%Y-%m-%d') as special_approval_date_str,
		special_approval_date,
		special_approval_leader_id,
		special_approval_leader_name,
		special_approval_advice,
		special_approval_result,
		redeem_payback_card_name,
		redeem_payback_card_no,
		redeem_apply_total_amount,
		total_due_income,
		total_management_fee,
		redeem_reality_total_amount,
		date_format(payback_date,'%Y-%m-%d') as payback_date_str,
		payback_date,
		payback_operator_id,
		is_finish,
		is_fully_redeemed,
		create_user_id,
		create_user_name,
		create_user_dept_id,
		date_format(create_timestamp,'%Y-%m-%d %H:%i:%s') as create_timestamp_str,
		create_timestamp,
		last_update_user_id,
		date_format(last_update_timestamp,'%Y-%m-%d %H:%i:%s') as last_update_timestamp_str,
		last_update_timestamp,
		enable_flag,
		is_protocol_finish,
		salesman_id,
		salesman_dept_id,
		is_payback,
		total_deduct_tax_point,
		redeem_company_reason,
        is_take_off_damages,
        redeem_type,
        redeem_type_detail,
		total_deduct_money,
		is_order_redeem
		from
		wms_inve_redeem
		where
		wms_inve_redeem_id = #{wms_inve_redeem_id}
	</select>

	<!-- count num -->
	<select id="findCount" parameterType="map" resultType="int">
		select count(wms_inve_redeem_id) as count
		from wms_inve_redeem
		<where>
             enable_flag =1
           and  data_status in(1,2,3)
           and special_approval_leader_id is null
			<if test="idList !=null">
				and wms_inve_redeem_id in
				<foreach collection="idList" item="wms_inve_redeem_id"
					index="index" open="(" separator="," close=")">
					#{wms_inve_redeem_id}
				</foreach>
			</if>
			<if test="cus_name != null">
				and cus_name like #{cus_name}
			</if>
			<if test="id_card != null">
				and id_card like #{id_card}
			</if>
		</where>
	</select>
	<!-- count num -->
	<select id="selectRedeemListCount" parameterType="map"
		resultType="int">
		select count(wms_inve_redeem_id) as count
		from wms_inve_redeem
		<where>
		      enable_flag =1
           and  data_status in(1,2,3,5)
			<if test="idList !=null">
				and wms_inve_redeem_id in
				<foreach collection="idList" item="wms_inve_redeem_id"
					index="index" open="(" separator="," close=")">
					#{wms_inve_redeem_id}
				</foreach>
			</if>
		</where>
	</select>
	<!-- list -->
	<select id="search" parameterType="map" resultType="java.util.HashMap">
		select
		r.wms_inve_redeem_id,
		d.wms_inve_transa_id,
		d.wms_inve_redeem_detail_id,
		r.wms_inve_customer_id,
		r.bill_code,
		r.data_status,
		(select value_meaning from wms_sys_dict_data where wms_sys_dict_id=60 and value_code=data_status) as data_status_name,
		r.id_card,
		r.cus_name,
		r.total_invest_amount,
		r.redeem_reason,
		date_format(r.redeem_date,'%Y-%m-%d') as redeem_date_str,
		r.redeem_date,
		r.supervisor_advice,
		r.supervisor_result,
		date_format(r.supervisor_date,'%Y-%m-%d') as supervisor_date_str,
		r.supervisor_date,
		r.submanager_advice,
		r.submanager_result,
		date_format(r.submanager_date,'%Y-%m-%d') as submanager_date_str,
		r.submanager_date,
		r.manager_advice,
		r.manager_result,
		date_format(r.manager_date,'%Y-%m-%d') as manager_date_str,
		r.manager_date,
		r.is_special_approval,
		r.special_approval_operator_id,
		date_format(r.special_approval_date,'%Y-%m-%d') as special_approval_date_str,
		r.special_approval_date,
		r.special_approval_leader_id,
		r.special_approval_leader_name,
        r.special_approval_result,
		r.special_approval_advice,
		r.redeem_payback_card_name,
		r.redeem_payback_card_no,
		r.redeem_apply_total_amount,
		r.total_due_income,
		r.total_management_fee,
		r.redeem_reality_total_amount,
		date_format(r.payback_date,'%Y-%m-%d') as payback_date_str,
		r.payback_date,
		r.payback_operator_id,
		r.is_finish,
		r.is_fully_redeemed,
		r.create_user_id,
		r.create_user_name,
		r.create_user_dept_id,
		date_format(r.create_timestamp,'%Y-%m-%d %H:%i:%s') as create_timestamp_str,
		r.create_timestamp,
		r.last_update_user_id,
		date_format(r.last_update_timestamp,'%Y-%m-%d %H:%i:%s') as last_update_timestamp_str,
		r.last_update_timestamp,
		r.enable_flag,
		r.is_protocol_finish,
		r.salesman_id,
		r.salesman_dept_id,
		r.is_payback,
		r.total_deduct_tax_point,
		r.redeem_company_reason,
        r.is_take_off_damages,
        r.redeem_type,
		r.total_deduct_money
		from wms_inve_redeem r,wms_inve_redeem_detail d
		<where>
			r.wms_inve_redeem_id =d.wms_inve_redeem_id		
			and	r.enable_flag=1
			and r.data_status in(1,2,3)
			and r.special_approval_leader_id is null
			<if test="cus_name != null">
				and r.cus_name like #{cus_name}
			</if>
			<if test="id_card != null">
				and r.id_card like #{id_card}
			</if>
			<if test="idList !=null">
				and r.wms_inve_redeem_id in
				<foreach collection="idList" item="wms_inve_redeem_id"
					index="index" open="(" separator="," close=")">
					#{wms_inve_redeem_id}
				</foreach>
			</if>
		</where>
		<if test="sortname != '' and sortorder !=''">
			ORDER BY ${sortname} ${sortorder}
		</if>
		<if test="offset != null and pagesize !=null">
			LIMIT ${offset} , ${pagesize}
		</if>
	</select>
	<!-- 赎回查询数据列表 -->
	<select id="searchForQuerySH" parameterType="map" resultType="java.util.HashMap">
		select
		r.wms_inve_redeem_id,
		r.wms_inve_customer_id,
		t.wms_inve_transa_id,
		r.bill_code,
		r.data_status,
		(select value_meaning from wms_sys_dict_data where wms_sys_dict_id=60 and value_code=r.data_status) as data_status_name,
		r.id_card,
		r.cus_name,
		r.total_invest_amount,
		r.redeem_reason,
		date_format(r.redeem_date,'%Y-%m-%d') as redeem_date_str,
		r.redeem_date,
		r.supervisor_advice,
		r.supervisor_result,
		date_format(r.supervisor_date,'%Y-%m-%d') as supervisor_date_str,
		r.supervisor_date,
		r.submanager_advice,
		r.submanager_result,
		date_format(r.submanager_date,'%Y-%m-%d') as submanager_date_str,
		r.submanager_date,
		r.manager_advice,
		r.manager_result,
		date_format(r.manager_date,'%Y-%m-%d') as manager_date_str,
		r.manager_date,
		r.is_special_approval,
		r.special_approval_operator_id,
		date_format(r.special_approval_date,'%Y-%m-%d') as special_approval_date_str,
		r.special_approval_date,
		r.special_approval_leader_id,
		r.special_approval_leader_name,
        r.special_approval_result,
		r.special_approval_advice,
		r.redeem_payback_card_name,
		r.redeem_payback_card_no,
		r.redeem_apply_total_amount,
		r.total_due_income,
		r.total_management_fee,
		r.redeem_reality_total_amount,
		date_format(r.payback_date,'%Y-%m-%d') as payback_date_str,
		r.payback_date,
		r.payback_operator_id,
		r.is_finish,
		r.is_fully_redeemed,
		r.create_user_id,
		CONCAT(r.create_user_name,"/",(select personnel_shortCode from pm_personnel where personnel_id=r.create_user_id)) as create_user_name,
		r.create_user_dept_id,
		date_format(r.create_timestamp,'%Y-%m-%d %H:%i:%s') as create_timestamp_str,
		r.create_timestamp,
		r.last_update_user_id,
		date_format(r.last_update_timestamp,'%Y-%m-%d %H:%i:%s') as last_update_timestamp_str,
		r.last_update_timestamp,
		r.enable_flag,
		r.is_protocol_finish,
		r.salesman_id,
		CONCAT((select personnel_name from pm_personnel where personnel_id=r.salesman_id),"/",(select personnel_shortCode from pm_personnel where personnel_id=r.salesman_id)) as salesman_name,
		r.salesman_dept_id,
		r.is_payback,
		r.total_deduct_tax_point,
		r.redeem_company_reason,
        r.is_take_off_damages,
        r.redeem_type,
        ifnull(r.org_wms_inve_redeem_id,r.wms_inve_redeem_id) as process_id,
		r.total_deduct_money
		from wms_inve_redeem r , wms_inve_redeem_detail d, wms_inve_transa t, pm_personnel p1
		<where>
			1=1
			and r.wms_inve_redeem_id = d.wms_inve_redeem_id
			and d.wms_inve_transa_id = t.wms_inve_transa_id
			and t.bel_salesman_id_id = p1.personnel_id
			and r.redeem_type in ('1','4')
			and (2>(SELECT COUNT(DISTINCT(p.group_info)) from wms_inve_transa_user t,wms_inve_transa_pruduct_user p where t.enable_flag=1 and p.enable_flag=1 and t.personnel_id in(r.create_user_id,#{userid}) and t.wms_inve_transa_pruduct_user_id=p.wms_inve_transa_pruduct_user_id) 
			or 1=(SELECT p.group_info from wms_inve_transa_user t,wms_inve_transa_pruduct_user p where t.enable_flag=1 and p.enable_flag=1 and t.personnel_id =#{userid} and t.wms_inve_transa_pruduct_user_id=p.wms_inve_transa_pruduct_user_id))
			and (1=2
			<if test="create_user_id !=null">
				or r.create_user_id = #{create_user_id}
			</if>

			<if test="create_user_dept_id !=null">
				or r.create_user_dept_id = #{create_user_dept_id}
			</if>

			<if test="salesman_id !=null">
				or r.salesman_id = #{salesman_id}
			</if>

			<if test="salesman_dept_id !=null">
				or r.salesman_dept_id = #{salesman_dept_id}
			</if>

			<if test="deptIds !=null">
				or r.salesman_dept_id in
				<foreach collection="deptIds" item="dept_id" index="index"
					open="(" separator="," close=")">
					#{dept_id}
				</foreach>
			</if>
			
			<if test="deptIds_user_id !=null">
				or FIND_IN_SET(r.salesman_dept_id,getMenuData(#{deptIds_user_id},#{deptIds_menu}))
			</if>

			<if test="financial_services !=null">
				or 1= #{financial_services}
			</if>

			<if test="super_user !=null">
				or 1 = #{super_user}
			</if>
			)
			<if test="cus_name != null">
				and r.cus_name like #{cus_name}
			</if>
			<if test="id_card != null">
				and r.id_card  like #{id_card}
			</if>
			<if test="redeem_date_begin != null">
				and r.redeem_date &gt;=#{redeem_date_begin}
			</if>
			<if test="redeem_date_end != null">
				and r.redeem_date &lt;=#{redeem_date_end}
			</if>
			<if test="is_special_approval != null">
				and r.is_special_approval =#{is_special_approval}
			</if>
			<if test="special_approval_leader_id != null">
				and r.special_approval_leader_id=#{special_approval_leader_id}
			</if>
			<if test="data_status_name != null">
				and r.data_status =#{data_status_name}
			</if>
			<if test="data_status_name == null">
				and r.data_status != '8'
			</if>
			<if test="create_user_name != null">
				and (r.create_user_name =#{create_user_name} or r.create_user_name=(select personnel_name from pm_personnel where personnel_shortCode=#{create_user_name}))
			</if>
			<if test="salesman_name != null">
			    and (r.salesman_id =(select personnel_id from pm_personnel where personnel_name=#{salesman_name}) or r.salesman_id=(select personnel_id from pm_personnel where personnel_shortCode=#{salesman_name}))
			</if>
			<if test="bel_salesman_id_id != null">
			    and (p1.personnel_name =#{bel_salesman_id_id} or p1.personnel_shortCode=#{bel_salesman_id_id})
			</if>
		</where>
		<if test="sortname != '' and sortorder !=''">
			ORDER BY ${sortname} ${sortorder}
		</if>
		<if test="offset != null and pagesize !=null">
			LIMIT ${offset} , ${pagesize}
		</if>
	</select>
	<!-- 赎回查询符合条件数据数 -->
	<select id="findCountForQuerySH" parameterType="map" resultType="int">
		select count(r.wms_inve_redeem_id) as count
		from wms_inve_redeem r, wms_inve_redeem_detail d, wms_inve_transa t, pm_personnel p1
		<where>
			1=1
			and r.wms_inve_redeem_id = d.wms_inve_redeem_id
			and d.wms_inve_transa_id = t.wms_inve_transa_id
			and t.bel_salesman_id_id = p1.personnel_id
			and r.redeem_type in ('1','4')
			and (2>(SELECT COUNT(DISTINCT(p.group_info)) from wms_inve_transa_user t,wms_inve_transa_pruduct_user p where t.enable_flag=1 and p.enable_flag=1 and t.personnel_id in(r.create_user_id,#{userid}) and t.wms_inve_transa_pruduct_user_id=p.wms_inve_transa_pruduct_user_id) 
			or 1=(SELECT p.group_info from wms_inve_transa_user t,wms_inve_transa_pruduct_user p where t.enable_flag=1 and p.enable_flag=1 and t.personnel_id =#{userid} and t.wms_inve_transa_pruduct_user_id=p.wms_inve_transa_pruduct_user_id))
			and (1=2
			<if test="create_user_id !=null">
				or r.create_user_id = #{create_user_id}
			</if>

			<if test="create_user_dept_id !=null">
				or r.create_user_dept_id = #{create_user_dept_id}
			</if>

			<if test="salesman_id !=null">
				or r.salesman_id = #{salesman_id}
			</if>

			<if test="salesman_dept_id !=null">
				or r.salesman_dept_id = #{salesman_dept_id}
			</if>

			<if test="deptIds !=null">
				or r.salesman_dept_id in
				<foreach collection="deptIds" item="dept_id" index="index"
					open="(" separator="," close=")">
					#{dept_id}
				</foreach>
			</if>
			<if test="deptIds_user_id !=null">
				or FIND_IN_SET(r.salesman_dept_id,getMenuData(#{deptIds_user_id},#{deptIds_menu}))
			</if>

			<if test="financial_services !=null">
				or 1= #{financial_services}
			</if>

			<if test="super_user !=null">
				or 1 = #{super_user}
			</if>
			)
			<if test="cus_name != null">
				and r.cus_name like #{cus_name}
			</if>
			<if test="id_card != null">
				and r.id_card  like #{id_card}
			</if>
			<if test="redeem_date_begin != null">
				and r.redeem_date &gt;=#{redeem_date_begin}
			</if>
			<if test="redeem_date_end != null">
				and r.redeem_date &lt;=#{redeem_date_end}
			</if>
			<if test="is_special_approval != null">
				and r.is_special_approval =#{is_special_approval}
			</if>
			<if test="special_approval_leader_id != null">
				and r.special_approval_leader_id=#{special_approval_leader_id}
			</if>
			<if test="data_status_name != null">
				and r.data_status =#{data_status_name}
			</if>
			<if test="data_status_name == null">
				and r.data_status != '8'
			</if>
			<if test="create_user_name != null">
				and (r.create_user_name =#{create_user_name} or r.create_user_name=(select personnel_name from pm_personnel where personnel_shortCode=#{create_user_name}))
			</if>
			<if test="salesman_name != null">
			    and (r.salesman_id =(select personnel_id from pm_personnel where personnel_name=#{salesman_name}) or r.salesman_id=(select personnel_id from pm_personnel where personnel_shortCode=#{salesman_name}))
			</if>
			<if test="bel_salesman_id_id != null">
			    and (p1.personnel_name =#{bel_salesman_id_id} or p1.personnel_shortCode=#{bel_salesman_id_id})
			</if>
		</where>
	</select>

	<select id="selectRedeemList" parameterType="map" resultType="java.util.HashMap">
		select
		r.wms_inve_redeem_id,
		r.wms_inve_customer_id,
		r.bill_code,
		r.data_status,
		(select value_meaning from wms_sys_dict_data where value_code = r.data_status
			and wms_sys_dict_id = 60) as data_status_name,
		r.id_card,
		r.cus_name,
		r.total_invest_amount,
		r.redeem_reason,
		date_format(r.redeem_date,'%Y-%m-%d') as redeem_date_str,
		r.redeem_date,
		r.supervisor_advice,
		(select value_meaning from wms_sys_dict_data where value_code =
			supervisor_result and wms_sys_dict_id = 61)as supervisor_result,
		date_format(r.supervisor_date,'%Y-%m-%d') as supervisor_date_str,
		r.supervisor_date,
		r.submanager_advice,
		(select value_meaning from wms_sys_dict_data where value_code =
			submanager_result and wms_sys_dict_id = 61)as submanager_result,
		date_format(submanager_date,'%Y-%m-%d') as submanager_date_str,
		r.submanager_date,
		r.manager_advice,
		(select value_meaning from wms_sys_dict_data where value_code =
			manager_result and wms_sys_dict_id = 61)as manager_result,
		date_format(r.manager_date,'%Y-%m-%d') as manager_date_str,
		r.manager_date,
		r.is_special_approval,
		r.special_approval_operator_id,
		date_format(r.special_approval_date,'%Y-%m-%d') as special_approval_date_str,
		r.special_approval_date,
		r.special_approval_leader_id,
		r.special_approval_leader_name,
		r.special_approval_advice,
        r.special_approval_result,
		r.redeem_payback_card_name,
		r.redeem_payback_card_no,
		r.redeem_apply_total_amount,
		r.total_due_income,
		r.total_management_fee,
		r.redeem_reality_total_amount,
		date_format(r.payback_date,'%Y-%m-%d') as payback_date_str,
		r.payback_date,
		r.payback_operator_id,
		r.is_finish,
		r.is_fully_redeemed,
		r.create_user_id,
		r.create_user_name,
		r.create_user_dept_id,
		date_format(r.create_timestamp,'%Y-%m-%d %H:%i:%s') as create_timestamp_str,
		r.create_timestamp,
		r.last_update_user_id,
		date_format(r.last_update_timestamp,'%Y-%m-%d %H:%i:%s') as last_update_timestamp_str,
		r.last_update_timestamp,
		r.enable_flag,
		r.is_protocol_finish,
		r.salesman_id,
		r.salesman_dept_id,
		r.is_payback,
		r.total_deduct_tax_point,
		r.redeem_company_reason,
        r.is_take_off_damages,
        r.redeem_type,
		r.total_deduct_money,
		d.wms_inve_redeem_detail_id,
		d.wms_inve_transa_id,		
		d.wms_inve_transa_prod_id	
		from wms_inve_redeem r,wms_inve_redeem_detail d,wms_inve_transa t			
		<where>
			 r.wms_inve_redeem_id=d.wms_inve_redeem_id
			 and d.wms_inve_transa_id = t.wms_inve_transa_id
		     and r.enable_flag =1
		     and r.data_status in (1,2,3,5)
		     and IFNULL(t.is_order_redeem,'0') != '1'
			<if test="idList !=null">
				and r.wms_inve_redeem_id in
				<foreach collection="idList" item="wms_inve_redeem_id"
					index="index" open="(" separator="," close=")">
					#{wms_inve_redeem_id}
				</foreach>
			</if>
			<if test="cus_name != null">
				and r.cus_name like #{cus_name}
			</if>
			<if test="id_card != null">
				and r.id_card like #{id_card}
			</if>
			<if test="is_finish != null">
				and r.is_finish = #{is_finish}
			</if>
		</where>
		<if test="sortname != '' and sortorder !=''">
			ORDER BY ${sortname} ${sortorder}
		</if>
		<if test="offset != null and pagesize !=null">
			LIMIT ${offset} , ${pagesize}
		</if>
	</select>

	<!-- save -->
	<insert id="save" parameterType="WmsInveRedeem"
		useGeneratedKeys="true" keyProperty="wms_inve_redeem_id">
		INSERT INTO wms_inve_redeem
		(
		wms_inve_redeem_id,

		wms_inve_customer_id,

		bill_code,

		data_status,

		id_card,

		cus_name,

		total_invest_amount,

		redeem_reason,

		redeem_date,

		supervisor_advice,

		supervisor_result,

		supervisor_date,

		submanager_advice,

		submanager_result,

		submanager_date,

		manager_advice,

		manager_result,

		manager_date,

		is_special_approval,

		special_approval_operator_id,

		special_approval_date,

		special_approval_leader_id,

		special_approval_leader_name,

        special_approval_result,

		special_approval_advice,

		redeem_payback_card_name,

		redeem_payback_card_no,

		redeem_apply_total_amount,

		total_due_income,

		total_management_fee,

		redeem_reality_total_amount,

		payback_date,

		payback_operator_id,

		is_finish,

		is_fully_redeemed,

		create_user_id,

		create_user_name,

		create_user_dept_id,

		create_timestamp,

		last_update_user_id,

		last_update_timestamp,

		enable_flag,

		is_protocol_finish,

		salesman_id,

		salesman_dept_id,

		is_payback,
		
		total_deduct_tax_point,
		
		total_deduct_money,
		
		redeem_company_reason,
        
        is_take_off_damages,
        
        redeem_type_detail,
        
        redeem_type,
        
        redeem_reality_total_amount_upper,
        
        org_wms_inve_redeem_id,
        
        is_order_redeem,
        
        get_credit_type		
		)
		VALUES
		(
		#{wms_inve_redeem_id},
		#{wms_inve_customer_id},
		#{bill_code},
		#{data_status},
		#{id_card},
		#{cus_name},
		#{total_invest_amount},
		#{redeem_reason},
		#{redeem_date},
		#{supervisor_advice},
		#{supervisor_result},
		#{supervisor_date},
		#{submanager_advice},
		#{submanager_result},
		#{submanager_date},
		#{manager_advice},
		#{manager_result},
		#{manager_date},
		#{is_special_approval},
		#{special_approval_operator_id},
		#{special_approval_date},
		#{special_approval_leader_id},
		#{special_approval_leader_name},
		#{special_approval_result},
		#{special_approval_advice},
		#{redeem_payback_card_name},
		#{redeem_payback_card_no},
		#{redeem_apply_total_amount},
		#{total_due_income},
		#{total_management_fee},
		#{redeem_reality_total_amount},
		#{payback_date},
		#{payback_operator_id},
		#{is_finish},
		#{is_fully_redeemed},
		#{create_user_id},
		#{create_user_name},
		#{create_user_dept_id},
		#{create_timestamp},
		#{last_update_user_id},
		#{last_update_timestamp},
		#{enable_flag},
		#{is_protocol_finish},
		#{salesman_id},
		#{salesman_dept_id},
		#{is_payback},
		#{total_deduct_tax_point},
		#{total_deduct_money},
		#{redeem_company_reason},
        #{is_take_off_damages},
        #{redeem_type_detail},
        #{redeem_type},
        #{redeem_reality_total_amount_upper},        
        #{org_wms_inve_redeem_id },
        #{is_order_redeem},
        #{get_credit_type}   
		);
	</insert>

	<!-- 更新用户 -->
	<update id="update" parameterType="WmsInveRedeem">
		update wms_inve_redeem
		<set>
			<if test="wms_inve_redeem_id != null">
				wms_inve_redeem_id = #{wms_inve_redeem_id},
			</if>
			<if test="wms_inve_customer_id != null">
				wms_inve_customer_id = #{wms_inve_customer_id},
			</if>
			<if test="bill_code != null">
				bill_code = #{bill_code},
			</if>
			<if test="data_status != null">
				data_status = #{data_status},
			</if>
			<if test="id_card != null">
				id_card = #{id_card},
			</if>
			<if test="cus_name != null">
				cus_name = #{cus_name},
			</if>
			<if test="total_invest_amount != null">
				total_invest_amount = #{total_invest_amount},
			</if>
			<if test="redeem_reason != null">
				redeem_reason = #{redeem_reason},
			</if>
			<if test="redeem_date != null">
				redeem_date = #{redeem_date},
			</if>
			<if test="supervisor_advice != null">
				supervisor_advice = #{supervisor_advice},
			</if>
			<if test="supervisor_result != null">
				supervisor_result = #{supervisor_result},
			</if>
			<if test="supervisor_date != null">
				supervisor_date = #{supervisor_date},
			</if>
			<if test="submanager_advice != null">
				submanager_advice = #{submanager_advice},
			</if>
			<if test="submanager_result != null">
				submanager_result = #{submanager_result},
			</if>
			<if test="submanager_date != null">
				submanager_date = #{submanager_date},
			</if>
			<if test="manager_advice != null">
				manager_advice = #{manager_advice},
			</if>
			<if test="manager_result != null">
				manager_result = #{manager_result},
			</if>
			<if test="manager_date != null">
				manager_date = #{manager_date},
			</if>
			<if test="is_special_approval != null">
				is_special_approval = #{is_special_approval},
			</if>
			<if test="special_approval_operator_id != null">
				special_approval_operator_id = #{special_approval_operator_id},
			</if>
			<if test="special_approval_date != null">
				special_approval_date = #{special_approval_date},
			</if>
			<if test="special_approval_leader_id != null">
				special_approval_leader_id = #{special_approval_leader_id},
			</if>
			<if test="special_approval_leader_name != null">
				special_approval_leader_name = #{special_approval_leader_name},
			</if>
			<if test="special_approval_result != null">
				special_approval_result = #{special_approval_result},
			</if>
			<if test="special_approval_advice != null">
				special_approval_advice = #{special_approval_advice},
			</if>
			<if test="redeem_payback_card_name != null">
				redeem_payback_card_name = #{redeem_payback_card_name},
			</if>
			<if test="redeem_payback_card_no != null">
				redeem_payback_card_no = #{redeem_payback_card_no},
			</if>
			<if test="redeem_apply_total_amount != null">
				redeem_apply_total_amount = #{redeem_apply_total_amount},
			</if>
			<if test="total_due_income != null">
				total_due_income = #{total_due_income},
			</if>
			<if test="total_management_fee != null">
				total_management_fee = #{total_management_fee},
			</if>
			<if test="redeem_reality_total_amount != null">
				redeem_reality_total_amount = #{redeem_reality_total_amount},
			</if>
			<if test="payback_date != null">
				payback_date = #{payback_date},
			</if>
			<if test="payback_operator_id != null">
				payback_operator_id = #{payback_operator_id},
			</if>
			<if test="is_finish != null">
				is_finish = #{is_finish},
			</if>
			<if test="is_fully_redeemed != null">
				is_fully_redeemed = #{is_fully_redeemed},
			</if>
			<if test="create_user_id != null">
				create_user_id = #{create_user_id},
			</if>
			<if test="create_user_name != null">
				create_user_name = #{create_user_name},
			</if>
			<if test="create_user_dept_id != null">
				create_user_dept_id = #{create_user_dept_id},
			</if>
			<if test="create_timestamp != null">
				create_timestamp = #{create_timestamp},
			</if>
			<if test="last_update_user_id != null">
				last_update_user_id = #{last_update_user_id},
			</if>
			<if test="last_update_timestamp != null">
				last_update_timestamp = #{last_update_timestamp},
			</if>
			<if test="enable_flag != null">
				enable_flag = #{enable_flag},
			</if>
			<if test="is_protocol_finish != null">
				is_protocol_finish = #{is_protocol_finish},
			</if>
			<if test="is_payback != null">
				is_payback = #{is_payback},
			</if>
			<if test="total_deduct_tax_point != null">
			    total_deduct_tax_point = #{total_deduct_tax_point},
			</if>
			<if test="total_deduct_money != null">
				total_deduct_money = #{total_deduct_money},
			</if>
			<if test="redeem_company_reason != null">
				redeem_company_reason = #{redeem_company_reason},
			</if>
			<if test="is_take_off_damages != null">
			    is_take_off_damages = #{is_take_off_damages},
			</if>
			<if test="redeem_type != null">
				redeem_type = #{redeem_type},
			</if>
			<if test="redeem_reality_total_amount_upper != null">
				redeem_reality_total_amount_upper = #{redeem_reality_total_amount_upper},
			</if>
		</set>
		where
		wms_inve_redeem_id = #{wms_inve_redeem_id}
	</update>
		<!-- 更新 赎回修订-->
	<update id="updateToNull" parameterType="WmsInveRedeem">
		update wms_inve_redeem
		<set>
				supervisor_advice = null,
				supervisor_result = null,
				supervisor_date = null,
				submanager_advice = null,
				submanager_result = null,
				submanager_date = null,
				manager_advice = null,
				manager_result = null,
				manager_date = null,
		</set>
		where
		wms_inve_redeem_id = #{wms_inve_redeem_id}
	</update>
	<select id="getListByEntity" parameterType="WmsInveRedeem"
		resultType="WmsInveRedeem">
		select
		wms_inve_redeem_id,
		wms_inve_customer_id,
		bill_code,
		data_status,
		(select value_meaning from wms_sys_dict_data where wms_sys_dict_id=60 and value_code=data_status) as data_status_name,
		id_card,
		cus_name,
		total_invest_amount,
		redeem_reason,
		date_format(redeem_date,'%Y-%m-%d') as redeem_date_str,
		redeem_date,
		supervisor_advice,
		supervisor_result,
		date_format(supervisor_date,'%Y-%m-%d') as supervisor_date_str,
		supervisor_date,
		submanager_advice,
		submanager_result,
		date_format(submanager_date,'%Y-%m-%d') as submanager_date_str,
		submanager_date,
		manager_advice,
		manager_result,
		date_format(manager_date,'%Y-%m-%d') as manager_date_str,
		manager_date,
		is_special_approval,
		special_approval_operator_id,
		date_format(special_approval_date,'%Y-%m-%d') as special_approval_date_str,
		special_approval_date,
		special_approval_leader_id,
		special_approval_leader_name,
        special_approval_result,
		special_approval_advice,
		redeem_payback_card_name,
		redeem_payback_card_no,
		redeem_apply_total_amount,
		total_due_income,
		total_management_fee,
		redeem_reality_total_amount,
		date_format(payback_date,'%Y-%m-%d') as payback_date_str,
		payback_date,
		payback_operator_id,
		is_finish,
		is_fully_redeemed,
		create_user_id,
		create_user_name,
		create_user_dept_id,
		date_format(create_timestamp,'%Y-%m-%d %H:%i:%s') as create_timestamp_str,
		create_timestamp,
		last_update_user_id,
		date_format(last_update_timestamp,'%Y-%m-%d %H:%i:%s') as last_update_timestamp_str,
		last_update_timestamp,
		enable_flag,
		is_protocol_finish,
		is_payback,
		total_deduct_tax_point,
		redeem_company_reason,
        is_take_off_damages,
        redeem_type,
		total_deduct_money
		from
		wms_inve_redeem
		<where>
			<if test="wms_inve_redeem_id != null">
				and wms_inve_redeem_id = #{wms_inve_redeem_id}
			</if>
			<if test="wms_inve_customer_id != null">
				and wms_inve_customer_id = #{wms_inve_customer_id}
			</if>
			<if test="bill_code != null">
				and bill_code = #{bill_code}
			</if>
			<if test="data_status != null">
				and data_status = #{data_status}
			</if>
			<if test="id_card != null">
				and id_card = #{id_card}
			</if>
			<if test="cus_name != null">
				and cus_name = #{cus_name}
			</if>
			<if test="total_invest_amount != null">
				and total_invest_amount = #{total_invest_amount}
			</if>
			<if test="redeem_reason != null">
				and redeem_reason = #{redeem_reason}
			</if>
			<if test="redeem_date != null">
				and redeem_date = #{redeem_date}
			</if>
			<if test="supervisor_advice != null">
				and supervisor_advice = #{supervisor_advice}
			</if>
			<if test="supervisor_result != null">
				and supervisor_result = #{supervisor_result}
			</if>
			<if test="supervisor_date != null">
				and supervisor_date = #{supervisor_date}
			</if>
			<if test="submanager_advice != null">
				and submanager_advice = #{submanager_advice}
			</if>
			<if test="submanager_result != null">
				and submanager_result = #{submanager_result}
			</if>
			<if test="submanager_date != null">
				and submanager_date = #{submanager_date}
			</if>
			<if test="manager_advice != null">
				and manager_advice = #{manager_advice}
			</if>
			<if test="manager_result != null">
				and manager_result = #{manager_result}
			</if>
			<if test="manager_date != null">
				and manager_date = #{manager_date}
			</if>
			<if test="is_special_approval != null">
				and is_special_approval = #{is_special_approval}
			</if>
			<if test="special_approval_operator_id != null">
				and special_approval_operator_id = #{special_approval_operator_id}
			</if>
			<if test="special_approval_date != null">
				and special_approval_date = #{special_approval_date}
			</if>
			<if test="special_approval_leader_id != null">
				and special_approval_leader_id = #{special_approval_leader_id}
			</if>
			<if test="special_approval_leader_name != null">
				and special_approval_leader_name = #{special_approval_leader_name}
			</if>
			<if test="special_approval_result != null">
				and special_approval_result  = #{special_approval_result}
			</if>
			<if test="special_approval_advice != null">
				and special_approval_advice = #{special_approval_advice}
			</if>
			<if test="redeem_payback_card_name != null">
				and redeem_payback_card_name = #{redeem_payback_card_name}
			</if>
			<if test="redeem_payback_card_no != null">
				and redeem_payback_card_no = #{redeem_payback_card_no}
			</if>
			<if test="redeem_apply_total_amount != null">
				and redeem_apply_total_amount = #{redeem_apply_total_amount}
			</if>
			<if test="total_due_income != null">
				and total_due_income = #{total_due_income}
			</if>
			<if test="total_management_fee != null">
				and total_management_fee = #{total_management_fee}
			</if>
			<if test="redeem_reality_total_amount != null">
				and redeem_reality_total_amount = #{redeem_reality_total_amount}
			</if>
			<if test="payback_date != null">
				and payback_date = #{payback_date}
			</if>
			<if test="payback_operator_id != null">
				and payback_operator_id = #{payback_operator_id}
			</if>
			<if test="is_finish != null">
				and is_finish = #{is_finish}
			</if>
			<if test="is_fully_redeemed != null">
				and is_fully_redeemed = #{is_fully_redeemed}
			</if>
			<if test="create_user_id != null">
				and create_user_id = #{create_user_id}
			</if>
			<if test="create_user_name != null">
				and create_user_name = #{create_user_name}
			</if>
			<if test="create_user_dept_id != null">
				and create_user_dept_id = #{create_user_dept_id}
			</if>
			<if test="create_timestamp != null">
				and create_timestamp = #{create_timestamp}
			</if>
			<if test="last_update_user_id != null">
				and last_update_user_id = #{last_update_user_id}
			</if>
			<if test="last_update_timestamp != null">
				and last_update_timestamp = #{last_update_timestamp}
			</if>
			<if test="enable_flag != null">
				and enable_flag = #{enable_flag}
			</if>
			<if test="is_protocol_finish != null">
				and is_protocol_finish = #{is_protocol_finish}
			</if>
			<if test="salesman_id != null">
				and salesman_id = #{salesman_id}
			</if>
			<if test="salesman_dept_id != null">
				and salesman_dept_id = #{salesman_dept_id}
			</if>
			<if test="is_payback != null">
				and is_payback = #{is_payback}
			</if>
			<if test="total_deduct_tax_point != null">
				and total_deduct_tax_point = #{total_deduct_tax_point}
			</if>
			<if test="total_deduct_money != null">
				and total_deduct_money = #{total_deduct_money}
			</if>
			<if test="isExcludePKFlag != null and isExcludePKFlag == true">
				and wms_inve_redeem_id != #{wms_inve_redeem_id}
			</if>
			<if test="redeem_company_reason != null">
				redeem_company_reason = #{redeem_company_reason},
			</if>
			<if test="is_take_off_damages != null">
			    is_take_off_damages = #{is_take_off_damages},
			</if>
			<if test="redeem_type != null">
				redeem_type = #{redeem_type},
			</if>
		</where>
	</select>
	<!-- 更新数据表状态 -->
	<update id="updateRecord" parameterType="map">
		update wms_inve_redeem
		<set>
			<if test="wms_inve_redeem_id != null">
				wms_inve_redeem_id = #{wms_inve_redeem_id},
			</if>
			<if test="wms_inve_customer_id != null">
				wms_inve_customer_id = #{wms_inve_customer_id},
			</if>
			<if test="bill_code != null">
				bill_code = #{bill_code},
			</if>
			<if test="data_status != null">
				data_status = #{data_status},
			</if>
			<if test="id_card != null">
				id_card = #{id_card},
			</if>
			<if test="cus_name != null">
				cus_name = #{cus_name},
			</if>
			<if test="total_invest_amount != null">
				total_invest_amount = #{total_invest_amount},
			</if>
			<if test="redeem_reason != null">
				redeem_reason = #{redeem_reason},
			</if>
			<if test="redeem_date != null">
				redeem_date = #{redeem_date},
			</if>
			<if test="supervisor_advice != null">
				supervisor_advice = #{supervisor_advice},
			</if>
			<if test="supervisor_result != null">
				supervisor_result = #{supervisor_result},
			</if>
			<if test="supervisor_date != null">
				supervisor_date = #{supervisor_date},
			</if>
			<if test="submanager_advice != null">
				submanager_advice = #{submanager_advice},
			</if>
			<if test="submanager_result != null">
				submanager_result = #{submanager_result},
			</if>
			<if test="submanager_date != null">
				submanager_date = #{submanager_date},
			</if>
			<if test="manager_advice != null">
				manager_advice = #{manager_advice},
			</if>
			<if test="manager_result != null">
				manager_result = #{manager_result},
			</if>
			<if test="manager_date != null">
				manager_date = #{manager_date},
			</if>
			<if test="is_special_approval != null">
				is_special_approval = #{is_special_approval},
			</if>
			<if test="special_approval_operator_id != null">
				special_approval_operator_id = #{special_approval_operator_id},
			</if>
			<if test="special_approval_date != null">
				special_approval_date = #{special_approval_date},
			</if>
			<if test="special_approval_leader_id != null">
				special_approval_leader_id = #{special_approval_leader_id},
			</if>
			<if test="special_approval_leader_name != null">
				special_approval_leader_name = #{special_approval_leader_name},
			</if>
			<if test="special_approval_result != null">
				special_approval_result  = #{special_approval_result},
			</if>
			<if test="special_approval_advice != null">
				special_approval_advice = #{special_approval_advice},
			</if>
			<if test="redeem_payback_card_name != null">
				redeem_payback_card_name = #{redeem_payback_card_name},
			</if>
			<if test="redeem_payback_card_no != null">
				redeem_payback_card_no = #{redeem_payback_card_no},
			</if>
			<if test="redeem_apply_total_amount != null">
				redeem_apply_total_amount = #{redeem_apply_total_amount},
			</if>
			<if test="total_due_income != null">
				total_due_income = #{total_due_income},
			</if>
			<if test="total_management_fee != null">
				total_management_fee = #{total_management_fee},
			</if>
			<if test="redeem_reality_total_amount != null">
				redeem_reality_total_amount = #{redeem_reality_total_amount},
			</if>
			<if test="payback_date != null">
				payback_date = #{payback_date},
			</if>
			<if test="payback_operator_id != null">
				payback_operator_id = #{payback_operator_id},
			</if>
			<if test="is_finish != null">
				is_finish = #{is_finish},
			</if>
			<if test="is_fully_redeemed != null">
				is_fully_redeemed = #{is_fully_redeemed},
			</if>
			<if test="create_user_id != null">
				create_user_id = #{create_user_id},
			</if>
			<if test="create_user_name != null">
				create_user_name = #{create_user_name},
			</if>
			<if test="create_user_dept_id != null">
				create_user_dept_id = #{create_user_dept_id},
			</if>
			<if test="create_timestamp != null">
				create_timestamp = #{create_timestamp},
			</if>
			<if test="last_update_user_id != null">
				last_update_user_id = #{last_update_user_id},
			</if>
			<if test="last_update_timestamp != null">
				last_update_timestamp = #{last_update_timestamp},
			</if>
			<if test="enable_flag != null">
				enable_flag = #{enable_flag},
			</if>
			<if test="is_protocol_finish != null">
				is_protocol_finish = #{is_protocol_finish},
			</if>
			<if test="is_payback != null">
				is_payback = #{is_payback},
			</if>
			<if test="total_deduct_tax_point != null">
			   total_deduct_tax_point  = #{total_deduct_tax_point},
			</if>
			<if test="total_deduct_money != null">
				total_deduct_money = #{total_deduct_money}，
			</if>
			<if test="redeem_company_reason != null">
				redeem_company_reason = #{redeem_company_reason},
			</if>
			<if test="is_take_off_damages != null">
			    is_take_off_damages = #{is_take_off_damages},
			</if>
			<if test="redeem_type != null">
				redeem_type = #{redeem_type},
			</if>
		</set>
		where wms_inve_redeem_id = #{wms_inve_redeem_id};
	</update>
	<!-- 赎回修订列表   产品变更退回-->
	<select id="checkReturnList" parameterType="map" resultType="java.util.HashMap">
		select
		t1.wms_inve_redeem_id,
		t2.wms_inve_transa_id,
		t1.wms_inve_customer_id,
		t1.bill_code,
		t1.data_status,
		(select value_meaning from wms_sys_dict_data where wms_sys_dict_id=60 and value_code=t1.data_status) as data_status_name,
		t1.id_card,
		t1.cus_name,
		t1.total_invest_amount,
		t1.redeem_reason,
		date_format(t1.redeem_date,'%Y-%m-%d') as redeem_date_str,
		t1.redeem_date,
		t1.supervisor_advice,
		t1.supervisor_result,
		date_format(t1.supervisor_date,'%Y-%m-%d') as supervisor_date_str,
		t1.supervisor_date,
		t1.submanager_advice,
		t1.submanager_result,
		date_format(t1.submanager_date,'%Y-%m-%d') as submanager_date_str,
		t1.submanager_date,
		t1.manager_advice,
		t1.manager_result,
		date_format(t1.manager_date,'%Y-%m-%d') as manager_date_str,
		t1.manager_date,
		t1.is_special_approval,
		t1.special_approval_operator_id,
		date_format(t1.special_approval_date,'%Y-%m-%d') as special_approval_date_str,
		t1.special_approval_date,
		t1.special_approval_leader_id,
		t1.special_approval_leader_name,
        t1.special_approval_result,
		t1.special_approval_advice,
		t1.redeem_payback_card_name,
		t1.redeem_payback_card_no,
		t1.redeem_apply_total_amount,
		t1.total_due_income,
		t1.total_management_fee,
		t1.redeem_reality_total_amount,
		date_format(t1.payback_date,'%Y-%m-%d') as payback_date_str,
		t1.payback_date,
		t1.payback_operator_id,
		t1.is_finish,
		t1.is_fully_redeemed,
		t1.create_user_id,
		t1.create_user_name,
		t1.create_user_dept_id,
		date_format(t1.create_timestamp,'%Y-%m-%d %H:%i:%s') as create_timestamp_str,
		t1.create_timestamp,
		t1.last_update_user_id,
		date_format(t1.last_update_timestamp,'%Y-%m-%d %H:%i:%s') as last_update_timestamp_str,
		t1.last_update_timestamp,
		t1.enable_flag,
		t1.is_protocol_finish,
		t1.salesman_id,
		t1.salesman_dept_id,
		t1.is_payback,
		t1.total_deduct_tax_point,
		t1.redeem_company_reason,
        t1.is_take_off_damages,
        t1.redeem_type,
		t1.total_deduct_money,
		t5.bill_source,
		<!-- date_format(t5.old_date_of_payment,'%Y-%m-%d') as old_date_of_payment_str -->
		IFNULL(t5.old_date_of_payment,t5.date_of_payment) as old_date_of_payment
		
		from wms_inve_redeem t1,
			wms_inve_redeem_detail t2,
			wms_inve_transa t5
		<where>
			t1.wms_inve_redeem_id = t2.wms_inve_redeem_id
			and t2.wms_inve_transa_id=t5.wms_inve_transa_id
			and t1.data_status = 4
			<if test="cus_name != null">
				and t1.cus_name like #{cus_name}
			</if>
			<if test="id_card != null">
				and t1.id_card like #{id_card}
			</if>
			<if test="idList !=null">
				and t1.wms_inve_redeem_id in
				<foreach collection="idList" item="wms_inve_redeem_id"
					index="index" open="(" separator="," close=")">
					#{wms_inve_redeem_id}
				</foreach>
			</if>
		</where>
		<if test="sortname != '' and sortorder !=''">
			ORDER BY t1.${sortname} ${sortorder}
		</if>
		<if test="offset != null and pagesize !=null">
			LIMIT ${offset} , ${pagesize}
		</if>
	</select>
	<!-- 赎回修订记录数   产品变更退回 -->
	<select id="findCountCheckReturn" parameterType="map"
		resultType="int">
		select count(wms_inve_redeem_id) as count
		from wms_inve_redeem
		<where>
			data_status = 4
			<if test="idList !=null">
				and wms_inve_redeem_id in
				<foreach collection="idList" item="wms_inve_redeem_id"
					index="index" open="(" separator="," close=")">
					#{wms_inve_redeem_id}
				</foreach>
			</if>
			<if test="cus_name != null">
				and cus_name like #{cus_name}
			</if>
			<if test="id_card != null">
				and id_card like #{id_card}
			</if>
		</where>
	</select>

	<update id="updateSJSH" parameterType="WmsInveRedeem">
		update wms_inve_redeem
		<set>
			redeem_reality_total_amount = redeem_apply_total_amount
		</set>
		<where>
			wms_inve_redeem_id = #{wms_inve_redeem_id}
		</where>
	</update>


	<select id="selectRedeemListforExcel" parameterType="map" resultType="java.util.HashMap">
		SELECT
			w4.card_no,
			case when w4.bank_of_deposit = '中国民生银行' then '民生银行' else w4.bank_of_deposit end as bank_of_deposit,
			w4.bank_branch,
			(SELECT CASE WHEN RIGHT(value_meaning,1)='省' THEN LEFT(value_meaning,CHAR_LENGTH(value_meaning) - 1) ELSE value_meaning END  FROM wms_sys_dict_data WHERE wms_sys_dict_id=72 AND value_code = w4.bank_of_deposit_pro) as bank_of_deposit_pro,
			(SELECT CASE WHEN RIGHT(value_meaning,1)='市' THEN LEFT(value_meaning,CHAR_LENGTH(value_meaning) - 1) ELSE value_meaning END  FROM wms_sys_dict_data WHERE wms_sys_dict_id=73 AND value_code = w4.bank_of_deposit_city) as bank_of_deposit_city,
			w3.cus_name,
			w3.bill_code,
			w1.data_status,
			(IFNULL(w1.redeem_reality_total_amount,0) - IFNULL(w2.payable_reward_income,0)) as pay_income,
			SUBSTRING_INDEX(w2.remark,',',1) as remarks
		FROM
			wms_inve_redeem w1,
			wms_inve_redeem_detail w2,
			wms_inve_transa w3,
			wms_inve_transa_prod w4
		WHERE w1.wms_inve_redeem_id = w2.wms_inve_redeem_id
		AND w2.wms_inve_transa_id = w3.wms_inve_transa_id
		AND w2.wms_inve_transa_prod_id = w4.wms_inve_transa_prod_id
		AND w1.data_status = 5
		<if test="idList !=null">
			AND w1.wms_inve_redeem_id in
			<foreach collection="idList" item="wms_inve_redeem_id" index="index" open="(" separator="," close=")">
				#{wms_inve_redeem_id}
			</foreach>
		</if>
		<if test="cus_name != null">AND w1.cus_name like #{cus_name}</if>
		<if test="id_card != null">AND w1.id_card like #{id_card}</if>
		<if test="is_finish != null">AND w1.is_finish =#{is_finish}</if>
		
		UNION ALL

		SELECT
			w4.card_no,
			case when w4.bank_of_deposit = '中国民生银行' then '民生银行' else w4.bank_of_deposit end as bank_of_deposit,
			w4.bank_branch,
			(SELECT CASE WHEN RIGHT(value_meaning,1)='省' THEN LEFT(value_meaning,CHAR_LENGTH(value_meaning) - 1) ELSE value_meaning END  FROM wms_sys_dict_data WHERE wms_sys_dict_id=72 AND value_code = w4.bank_of_deposit_pro) as bank_of_deposit_pro,
			(SELECT CASE WHEN RIGHT(value_meaning,1)='市' THEN LEFT(value_meaning,CHAR_LENGTH(value_meaning) - 1) ELSE value_meaning END  FROM wms_sys_dict_data WHERE wms_sys_dict_id=73 AND value_code = w4.bank_of_deposit_city) as bank_of_deposit_city,
			w3.cus_name,
			w3.bill_code,
			w1.data_status,
			IFNULL(w2.payable_reward_income,0) as pay_income,
			SUBSTRING_INDEX(w2.remark,',',-1) as remarks
		FROM
			wms_inve_redeem w1,
			wms_inve_redeem_detail w2,
			wms_inve_transa w3,
			wms_inve_transa_prod w4
		WHERE w1.wms_inve_redeem_id = w2.wms_inve_redeem_id
		AND w2.wms_inve_transa_id = w3.wms_inve_transa_id
		AND w2.wms_inve_transa_prod_id = w4.wms_inve_transa_prod_id
		AND w1.data_status = 5
		AND IFNULL(w2.payable_reward_income,0) != 0
		<!-- case when IFNULL(w2.payable_reward_income,0) != 0 then
		          
		     else
		     	  IFNULL(w2.reward_income_rate,0) != 0
		     end -->
		<if test="idList !=null">
			AND w1.wms_inve_redeem_id in
			<foreach collection="idList" item="wms_inve_redeem_id" index="index" open="(" separator="," close=")">
				#{wms_inve_redeem_id}
			</foreach>
		</if>
		<if test="cus_name != null">AND w1.cus_name like #{cus_name}</if>
		<if test="id_card != null">AND w1.id_card like #{id_card}</if>
		<if test="is_finish != null">AND w1.is_finish = #{is_finish}</if>
	</select>
	<!-- 根据提供的部门ID,起始和终点 查询该部门ID是否符合在某一个架构中 -->
	<select id="checkReDept" parameterType="map" resultType="java.lang.String">
		select getCompayInfo(#{id},#{pid})
	</select>
	<!-- list -->
	<select id="searchforphone" parameterType="map" resultType="java.util.HashMap">
		select
		r.wms_inve_redeem_id,
		r.bill_code,
		r.data_status,
		(select value_meaning from wms_sys_dict_data where wms_sys_dict_id=60 and value_code=r.data_status) as data_status_name,
		r.id_card,
		r.cus_name,
		r.total_invest_amount,
		r.redeem_reason,
		date_format(r.redeem_date,'%Y-%m-%d') as redeem_date_str,
		r.redeem_date,
		r.supervisor_advice,
		r.supervisor_result,
		date_format(r.supervisor_date,'%Y-%m-%d') as supervisor_date_str,
		date_format(r.manager_date,'%Y-%m-%d') as manager_date_str,
		r.manager_date,
		r.salesman_id,
		(SELECT personnel_name from pm_personnel where personnel_id=r.salesman_id) as salesman_name,
		d.wms_inve_redeem_detail_id,
		d.wms_inve_transa_prod_id,
		d.wms_inve_transa_id,
		ROUND(d.redeem_amount/10000) as redeem_amount,
		d.due_income,
		d.category_name,
		d.product_account,
		d.is_deduct_money,
		d.is_deduct_tax_point,
		d.deduct_money,
		r.redeem_company_reason,
        r.is_take_off_damages,
        r.redeem_type,
		d.deduct_tax_point
		from wms_inve_redeem r,wms_inve_redeem_detail d
		<where>
			r.enable_flag=1 and d.enable_flag=1
		and  r.wms_inve_redeem_id =d.wms_inve_redeem_id
		<!-- and ((r.special_approval_leader_id is null and r.data_status in(1,2,3)) or (r.special_approval_leader_id=#{user_id} and r.data_status=3)) -->
			<if test="searchInfo != null">
				and (r.cus_name like #{searchInfo} 
				or (SELECT salesman_name from  wms_inve_transa where wms_inve_transa_id=d.wms_inve_transa_id) like #{searchInfo}
				or (SELECT salesman_shortcode from  wms_inve_transa where wms_inve_transa_id=d.wms_inve_transa_id) like #{searchInfo})
			</if>
			<if test="user_id != null">
				and r.special_approval_leader_id=#{user_id} 
				and r.data_status=3
			</if>
			<if test="user_id == null">
				and r.special_approval_leader_id is null 
				and r.data_status in(1,2,3)
			</if>
			<if test="idList !=null">
				and r.wms_inve_redeem_id in
				<foreach collection="idList" item="wms_inve_redeem_id"
					index="index" open="(" separator="," close=")">
					#{wms_inve_redeem_id}
				</foreach>
			</if>
		</where>
		<if test="sortname != '' and sortorder !=''">
			ORDER BY ${sortname} ${sortorder}
		</if>
	</select>
	
	<!-- list -->
	<select id="searchforphone_ys" parameterType="map" resultType="java.util.HashMap">
		select
		r.wms_inve_redeem_id,
		r.bill_code,
		r.data_status,
		(select value_meaning from wms_sys_dict_data where wms_sys_dict_id=60 and value_code=r.data_status) as data_status_name,
		r.id_card,
		r.cus_name,
		r.total_invest_amount,
		r.redeem_reason,
		date_format(r.redeem_date,'%Y-%m-%d') as redeem_date_str,
		r.redeem_date,
		r.supervisor_advice,
		r.supervisor_result,
		date_format(r.supervisor_date,'%Y-%m-%d') as supervisor_date_str,
		date_format(r.manager_date,'%Y-%m-%d') as manager_date_str,
		r.manager_date,
		r.salesman_id,
		(SELECT personnel_name from pm_personnel where personnel_id=r.salesman_id) as salesman_name,
		d.wms_inve_redeem_detail_id,
		d.wms_inve_transa_prod_id,
		d.wms_inve_transa_id,
		ROUND(d.redeem_amount/10000) as redeem_amount,
		d.due_income,
		d.category_name,
		d.product_account,
		d.is_deduct_money,
		d.is_deduct_tax_point,
		d.deduct_money,
		r.redeem_company_reason,
        r.is_take_off_damages,
        r.redeem_type,
		d.deduct_tax_point,
		'ok' as is_aprro
		from wms_inve_redeem r,wms_inve_redeem_detail d,wms_inve_transa t3
		<where>
			r.enable_flag=1 and d.enable_flag=1
			and  r.wms_inve_redeem_id =d.wms_inve_redeem_id
			and d.wms_inve_transa_id=t3.wms_inve_transa_id
			and r.data_status != '8'
			and (
	 			(r.supervisor_date = #{qry_date} and t3.bel_department_manager_id=#{user_id})
				or (r.submanager_date = #{qry_date} and t3.bel_vice_general_manager_id=#{user_id}) 
				or (r.manager_date = #{qry_date} and t3.bel_general_manager_id=#{user_id}) 
				or (r.special_approval_date = #{qry_date} and t3.bel_general_manager_id=#{user_id})
			)
			<if test="searchInfo != null">
				and (r.cus_name like #{searchInfo} 
				or (SELECT salesman_name from  wms_inve_transa where wms_inve_transa_id=d.wms_inve_transa_id) like #{searchInfo}
				or (SELECT salesman_shortcode from  wms_inve_transa where wms_inve_transa_id=d.wms_inve_transa_id) like #{searchInfo})
			</if>
		</where>
		<if test="sortname != '' and sortorder !=''">
			ORDER BY ${sortname} ${sortorder}
		</if>
	</select>
	<!-- list -->
	<select id="getforphone" parameterType="int" resultType="java.util.HashMap">
		select
		max(t1.wms_inve_transa_protocol_id) as wms_inve_transa_protocol_id,
		r.wms_inve_redeem_id,
		r.wms_inve_customer_id,
		r.bill_code,
		r.data_status,
		(select value_meaning from wms_sys_dict_data where wms_sys_dict_id=60 and value_code=r.data_status) as data_status_name,
		r.cus_name,
		r.total_invest_amount,
		r.redeem_reason,
		date_format(r.redeem_date,'%Y-%m-%d') as redeem_date_str,
		r.redeem_date,
		r.supervisor_advice,
		r.supervisor_result,
		date_format(r.supervisor_date,'%Y-%m-%d') as supervisor_date_str,
		r.supervisor_date,
		r.submanager_advice,
		r.submanager_result,
		date_format(r.submanager_date,'%Y-%m-%d') as submanager_date_str,
		r.submanager_date,
		r.manager_advice,
		r.manager_result,
		date_format(r.manager_date,'%Y-%m-%d') as manager_date_str,
		r.manager_date,
		r.is_special_approval,
		r.special_approval_operator_id,
		date_format(r.special_approval_date,'%Y-%m-%d') as special_approval_date_str,
		r.special_approval_date,
		r.special_approval_leader_id,
		r.special_approval_leader_name,
		r.special_approval_advice,
		r.special_approval_result,
		r.redeem_payback_card_name,
		r.redeem_payback_card_no,
		r.redeem_apply_total_amount,
		r.total_due_income,
		r.total_management_fee,
		r.redeem_reality_total_amount,
		date_format(r.payback_date,'%Y-%m-%d') as payback_date_str,
		r.payback_date,
		r.payback_operator_id,
		r.is_finish,
		r.is_fully_redeemed,
		r.create_user_id,
		r.create_user_name,
		r.create_user_dept_id,
		date_format(r.create_timestamp,'%Y-%m-%d %H:%i:%s') as create_timestamp_str,
		r.create_timestamp,
		r.last_update_user_id,
		date_format(r.last_update_timestamp,'%Y-%m-%d %H:%i:%s') as last_update_timestamp_str,
		r.last_update_timestamp,
		r.enable_flag,
		r.is_protocol_finish,
		r.salesman_id,
		r.salesman_dept_id,
		r.is_payback,
		r.total_deduct_tax_point,
		r.total_deduct_money,
		(SELECT category_name from wms_inve_transa_prod where wms_inve_transa_prod_id=d.wms_inve_transa_prod_id) as category_name,
		(select value_meaning from wms_sys_dict_data where wms_sys_dict_id=60 and value_code=r.data_status) as data_status_name,
		(SELECT CONCAT(personnel_name,personnel_shortCode) from pm_personnel where personnel_id=r.salesman_id) as salesman_name,
		d.redeem_amount,
		d.wms_inve_redeem_detail_id,
		d.wms_inve_transa_prod_id,
		d.wms_inve_transa_id,
		d.wms_inve_redeem_id,
		d.due_income,
		d.management_fee,
		d.redeem_type,
		d.redeem_product_interest,
		d.management_fee_rate,
		d.is_fully_redeemed,
		d.remain_interest_days,
		d.create_user_id,
		date_format(d.create_timestamp,'%Y-%m-%d %H:%i:%s') as create_timestamp_str,
		d.create_timestamp,
		d.last_update_user_id,
		date_format(d.last_update_timestamp,'%Y-%m-%d %H:%i:%s') as last_update_timestamp_str,
		d.last_update_timestamp,
		d.enable_flag,
		d.create_user_dept_id,
		d.protocol_create_timestamp,
		d.category_name,
		d.is_deduct_money,
		d.is_deduct_tax_point,
		d.deduct_money,
		r.redeem_company_reason,
    	r.is_take_off_damages,
		d.deduct_tax_point,
		date_format(t1.end_of_date,'%Y-%m-%d') as end_of_date,
		FORMAT(d.product_account,2) AS product_account,		
		date_format(t2.date_of_payment,'%Y-%m-%d') as date_of_payment,
		IFNULL(d.extend_income,0) as extend_income,
		IFNULL(d.paid_income,0) as paid_income,
		ifnull(r.org_wms_inve_redeem_id,r.wms_inve_redeem_id) as workflow_id,
		(select IFNULL(sum(t4.principal_amount),0) from wms_inve_redeem_principal_detail t4 where t4.wms_inve_redeem_detail_id=d.wms_inve_redeem_detail_id and t4.principal_type=1) as redeem_amount_back,
		(select IFNULL(sum(t4.principal_amount),0) from wms_inve_redeem_principal_detail t4 where t4.wms_inve_redeem_detail_id=d.wms_inve_redeem_detail_id and t4.principal_type=2) as redeem_amount_no_back,
		CONCAT(LEFT(t1.b_id_card,4),'**********',RIGHT(t1.b_id_card,4)) as id_card
		
		from wms_inve_redeem r,wms_inve_redeem_detail d,wms_inve_transa_protocol t1,wms_inve_transa t2,wms_inve_transa_prod t3
		where
			r.enable_flag=1 and d.enable_flag=1
		and d.wms_inve_transa_id=t1.wms_inve_transa_id
		and t2.wms_inve_transa_id=t3.wms_inve_transa_id
		and d.wms_inve_transa_prod_id=t3.wms_inve_transa_prod_id
		and  r.wms_inve_redeem_id=d.wms_inve_redeem_id
		and  r.wms_inve_redeem_id=#{wms_inve_redeem_id}
	</select>
	<!-- 赎回特批列表显示 -->
	<select id="searchSpecialRedemptionList" parameterType="map" resultType="java.util.HashMap">
		select
		r.wms_inve_redeem_id,
		d.wms_inve_transa_id,
		d.wms_inve_redeem_detail_id,
		r.wms_inve_customer_id,
		r.bill_code,
		r.data_status,
		(select value_meaning from wms_sys_dict_data where wms_sys_dict_id=60 and value_code=data_status) as data_status_name,
		r.id_card,
		r.cus_name,
		r.total_invest_amount,
		r.redeem_reason,
		date_format(r.redeem_date,'%Y-%m-%d') as redeem_date_str,
		r.redeem_date,
		r.supervisor_advice,
		r.supervisor_result,
		date_format(r.supervisor_date,'%Y-%m-%d') as supervisor_date_str,
		r.supervisor_date,
		r.submanager_advice,
		r.submanager_result,
		date_format(r.submanager_date,'%Y-%m-%d') as submanager_date_str,
		r.submanager_date,
		r.manager_advice,
		r.manager_result,
		date_format(r.manager_date,'%Y-%m-%d') as manager_date_str,
		r.manager_date,
		r.is_special_approval,
		r.special_approval_operator_id,
		date_format(r.special_approval_date,'%Y-%m-%d') as special_approval_date_str,
		r.special_approval_date,
		r.special_approval_leader_id,
		r.special_approval_leader_name,
        r.special_approval_result,
		r.special_approval_advice,
		r.redeem_payback_card_name,
		r.redeem_payback_card_no,
		r.redeem_apply_total_amount,
		r.total_due_income,
		r.total_management_fee,
		r.redeem_reality_total_amount,
		date_format(r.payback_date,'%Y-%m-%d') as payback_date_str,
		r.payback_date,
		r.payback_operator_id,
		r.is_finish,
		r.is_fully_redeemed,
		r.create_user_id,
		r.create_user_name,
		r.create_user_dept_id,
		date_format(r.create_timestamp,'%Y-%m-%d %H:%i:%s') as create_timestamp_str,
		r.create_timestamp,
		r.last_update_user_id,
		date_format(r.last_update_timestamp,'%Y-%m-%d %H:%i:%s') as last_update_timestamp_str,
		r.last_update_timestamp,
		r.enable_flag,
		r.is_protocol_finish,
		r.salesman_id,
		r.salesman_dept_id,
		r.is_payback,
		r.total_deduct_tax_point,
		r.redeem_company_reason,
       	r.is_take_off_damages,
        r.redeem_type,
		r.total_deduct_money
		from wms_inve_redeem r,wms_inve_redeem_detail d
		<where>
			r.wms_inve_redeem_id=d.wms_inve_redeem_id		
			<if test="cus_name != null">
				and r.cus_name like #{cus_name}
			</if>
			<if test="id_card != null">
				and r.id_card like #{id_card}
			</if>
			<if test="idList !=null">
				and r.wms_inve_redeem_id in
				<foreach collection="idList" item="wms_inve_redeem_id"
					index="index" open="(" separator="," close=")">
					#{wms_inve_redeem_id}
				</foreach>
			</if>
			<if test="userid != null">
			    and r.special_approval_leader_id =#{userid}
			    and r.data_status = 3
			</if>
		</where>
		<if test="sortname != '' and sortorder !=''">
			ORDER BY ${sortname} ${sortorder}
		</if>
		<if test="offset != null and pagesize !=null">
			LIMIT ${offset} , ${pagesize}
		</if>
	</select>
<!-- 	赎回特批显示列表数量 -->
	<select id="searchSpecialRedemptionCount" parameterType="map" resultType="int">
		select count(wms_inve_redeem_id) as count
		
		from wms_inve_redeem
		<where>
			<if test="cus_name != null">
				cus_name like #{cus_name}
			</if>
			<if test="id_card != null">
				and id_card like #{id_card}
			</if>
			<if test="idList !=null">
				and wms_inve_redeem_id in
				<foreach collection="idList" item="wms_inve_redeem_id"
					index="index" open="(" separator="," close=")">
					#{wms_inve_redeem_id}
				</foreach>
			</if>
			<if test="userid != null">
			    and special_approval_leader_id =#{userid}
			    and data_status = 3
			</if>
		</where>
		<if test="sortname != '' and sortorder !=''">
			ORDER BY ${sortname} ${sortorder}
		</if>
		<if test="offset != null and pagesize !=null">
			LIMIT ${offset} , ${pagesize}
		</if>
	</select>
	
	<select id="getRedeemInfoDetailList" parameterType="int" resultType="java.util.HashMap">
		select
			r.wms_inve_redeem_id,
			r.wms_inve_customer_id,
			r.redeem_reason,
			date_format(r.redeem_date,'%Y-%m-%d') as redeem_date_str,
			r.redeem_date,
			r.redeem_payback_card_name,
			r.redeem_payback_card_no,
			r.redeem_apply_total_amount,
			r.total_due_income,
			r.total_management_fee,
			r.redeem_reality_total_amount,
			r.is_finish,
			r.is_fully_redeemed,
			r.is_protocol_finish,
			r.total_deduct_tax_point,
			r.total_deduct_money,
			r.redeem_type,
			r.is_order_redeem,
			r.redeem_reality_total_amount_upper,
			d.wms_inve_redeem_detail_id,
			d.wms_inve_transa_prod_id,			
			d.redeem_amount,
			d.due_income,
			d.management_fee,
			d.redeem_product_interest,
			d.management_fee_rate,
			d.category_name,
			d.product_account,
			d.is_deduct_money,
			d.is_deduct_tax_point,
			d.deduct_money,
			r.redeem_company_reason,
	        r.is_take_off_damages,
			d.deduct_tax_point,
			d.is_handle_self,
			d.paid_income,
			d.redeem_sms_code,
			IFNULL(d.payable_reward_income,0) as payable_reward_income,
			IFNULL(d.payable_basic_income,0) as payable_basic_income,			
			d.extend_income,
			ifnull(d.current_income,0) as current_income,
			ifnull(d.current_income_rate,0) as current_income_rate,
			ifnull(d.days_current_income,0) as days_current_income
		from wms_inve_redeem r,wms_inve_redeem_detail d
		where
			r.enable_flag=1 and d.enable_flag=1
			and  r.wms_inve_redeem_id=d.wms_inve_redeem_id
			and  r.wms_inve_redeem_id=#{wms_inve_redeem_id}
	</select>
	
	<select id="queryRedeemByBillCode" parameterType="map" resultType="map">
		select r.wms_inve_redeem_id,r.redeem_date from wms_inve_redeem r where r.bill_code = #{bill_code}
	</select>
	
	<select id="getRedeemInfoDetailListMoa" parameterType="int" resultType="java.util.HashMap">
		select
			r.wms_inve_redeem_id,
			r.wms_inve_customer_id,
			d.wms_inve_redeem_detail_id,
			d.wms_inve_transa_prod_id,
			d.wms_inve_transa_id,
			r.cus_name,
			r.data_status,
			(SELECT category_name from wms_inve_transa_prod where wms_inve_transa_prod_id=d.wms_inve_transa_prod_id) as category_name,
			FORMAT(d.product_account,2) AS product_account,
			FORMAT(ifnull((select sum(p1.principal_amount) from wms_inve_redeem_principal_detail p1 where p1.wms_inve_redeem_detail_id = d.wms_inve_redeem_detail_id and p1.principal_type=1),0),2) as total_basic_income,
			FORMAT(ifnull((select sum(p2.principal_amount) from wms_inve_redeem_principal_detail p2 where p2.wms_inve_redeem_detail_id = d.wms_inve_redeem_detail_id and p2.principal_type=2),0),2) as total_reward_income,
			date_format(t2.date_of_payment,'%Y-%m-%d') as date_of_payment,
			(SELECT CONCAT(personnel_name,' ',personnel_shortCode) from pm_personnel where personnel_id=r.salesman_id) as salesman_name,									
			(SELECT CONCAT(personnel_name,' ',personnel_shortCode) from pm_personnel where personnel_id=t2.bel_department_manager_id) as bel_department_manager_name,
			(SELECT dept_name from sys_dept d where d.dept_id= t2.bel_department_manager_dept_id) as bel_department_manager_dept_name,
			(SELECT personnel_postName from pm_personnel where personnel_id=t2.bel_department_manager_id) as bel_department_manager_postName,			
			(SELECT CONCAT(personnel_name,' ',personnel_shortCode) from pm_personnel where personnel_id=t2.bel_vice_general_manager_id) as bel_vice_general_manager_name,
			(SELECT dept_name from sys_dept d where d.dept_id= t2.bel_vice_general_manager_dept_id) as bel_vice_general_manager_dept_name,	
			(SELECT personnel_postName from pm_personnel where personnel_id=t2.bel_vice_general_manager_id) as bel_vice_general_manager_postName,				
			(SELECT CONCAT(personnel_name,' ',personnel_shortCode) from pm_personnel where personnel_id=t2.bel_general_manager_id) as bel_general_manager_name,
			(SELECT dept_name from sys_dept d where d.dept_id= t2.bel_general_manager_dept_id) as bel_general_manager_dept_name,
			(SELECT personnel_postName from pm_personnel where personnel_id=t2.bel_general_manager_id) as bel_general_manager_postName,			
			date_format(r.redeem_date,'%Y-%m-%d') as redeem_date_str,
			r.redeem_date,
			FORMAT(d.redeem_amount,2) as redeem_amount,
			FORMAT((IFNULL(d.payable_reward_income,0)+IFNULL(d.payable_basic_income,0)),2) as due_pay_income,
			FORMAT(IFNULL(d.paid_income,0),2) as paid_income,
			FORMAT(IFNULL(d.extend_income,0)+IFNULL(d.current_income,0),2) as extend_income,			
			FORMAT(IFNULL(d.management_fee,0),2) as management_fee,
			FORMAT(IFNULL(d.deduct_tax_point,0),2) as deduct_tax_point,
			FORMAT(r.redeem_reality_total_amount,2) as redeem_reality_total_amount,
			r.redeem_reason,
			case when r.redeem_company_reason = 1 and d.management_fee > 0 
						  	  then '公司原因 |收取服务费'
					   when r.redeem_company_reason = 1 and d.management_fee = 0 
									then '公司原因 |不收取服务费'
						 when r.redeem_company_reason = 2 and d.management_fee > 0 
									then '个人原因 |收取服务费'
						when r.redeem_company_reason = 2 and d.management_fee = 0 
									then '个人原因 |不收取服务费'
						when r.redeem_company_reason = 3
									then '协议到期 |不收取服务费'
				end as redeem_company_reason,
			ifnull(r.org_wms_inve_redeem_id,r.wms_inve_redeem_id) as workflow_id,
			r.is_take_off_damages,
			case when r.redeem_type = 1 then '赎回申请单(未到期)'
		         when r.redeem_type = 4 then '赎回申请单(到期/超期)'
		  	end as bill_title,
		  	case when r.is_take_off_damages = 0 then '本单转让手续费已免，请慎重审核！'
		  	end as reminder_msg,
		  	t2.bel_department_manager_id,
		  	t2.bel_vice_general_manager_id,
		  	t2.bel_general_manager_id
		from wms_inve_redeem r,wms_inve_redeem_detail d,wms_inve_transa t2,wms_inve_transa_prod t3
		where
			r.enable_flag=1 and d.enable_flag=1
		and t2.wms_inve_transa_id=t3.wms_inve_transa_id
		and d.wms_inve_transa_prod_id=t3.wms_inve_transa_prod_id
		and  r.wms_inve_redeem_id=d.wms_inve_redeem_id
		and  r.wms_inve_redeem_id=#{wms_inve_redeem_id}
	</select>
	
	<!-- app端根据查询条件进行查询赎回单据信息 -->
	<!-- 
		query_type分别为001、002、003、004、005、006分别代表的意思是全部、待我审批、与我相关、审批中、已完成、已撤销(已终止);
		roleType分别为1、2、3、4分别代表的意思是部门经理、副总、总、其他的角色;
		此sql分别查询全部、与我相关、已完成、已撤销、审批中的数据信息
		查询全部、已完成、已撤销遵守的是数据权限进行查询
		查询与我相关是query_type == 003收益中的单据并且判断角色为副总、总的,副总的可以查看部门经理审批;总的查看副总和部门经理审批
		查询审批中query_type == 004 收益中的单据并且对应的角色审批意见不为空的
	 -->
	<select id="phoneGetRedeemByQueryInfo" parameterType="map" resultType="map">
		select
			t.bill_type_code,
			case WHEN t.bill_type_code = '002' THEN '待我审批'
				 WHEN t.bill_type_code = '003' THEN '与我相关'
				 WHEN t.bill_type_code = '004' THEN '审批中'
				 WHEN t.bill_type_code = '005' THEN '已完成'
				 WHEN t.bill_type_code = '006' THEN '已撤销'
			end
			as bill_msg,
			'wms' as system_name,
			case when t.redeem_type = 1 then '赎回申请单(未到期)'
			     when t.redeem_type = 4 then '赎回申请单(到期/超期)'
			end
			as bill_title,
			CONCAT(t.personnel_name,' ',t.personnel_shortCode,'的客户',t.cus_name,'申请赎回',t.redeem_amount,'万元') as bill_content,
			t.redeem_date_str,
			t.is_take_off_damages,
			t.wms_inve_redeem_id
		from
		(
			select
				r.wms_inve_redeem_id,
				r.wms_inve_customer_id,
				t.wms_inve_transa_id,
				r.bill_code,
				r.data_status,
				(select value_meaning from wms_sys_dict_data where wms_sys_dict_id=60 and value_code=r.data_status) as data_status_name,
				r.id_card,
				r.cus_name,
				r.total_invest_amount,
				r.redeem_reason,
				date_format(r.redeem_date,'%Y-%m-%d') as redeem_date_str,
				r.redeem_date,
				r.supervisor_advice,
				r.supervisor_result,
				date_format(r.supervisor_date,'%Y-%m-%d') as supervisor_date_str,
				r.supervisor_date,
				r.submanager_advice,
				r.submanager_result,
				date_format(r.submanager_date,'%Y-%m-%d') as submanager_date_str,
				r.submanager_date,
				r.manager_advice,
				r.manager_result,
				date_format(r.manager_date,'%Y-%m-%d') as manager_date_str,
				r.manager_date,
				r.is_special_approval,
				r.special_approval_operator_id,
				date_format(r.special_approval_date,'%Y-%m-%d') as special_approval_date_str,
				r.special_approval_date,
				r.special_approval_leader_id,
				r.special_approval_leader_name,
		        r.special_approval_result,
				r.special_approval_advice,
				r.redeem_payback_card_name,
				r.redeem_payback_card_no,
				r.redeem_apply_total_amount,
				r.total_due_income,
				r.total_management_fee,
				r.redeem_reality_total_amount,
				date_format(r.payback_date,'%Y-%m-%d') as payback_date_str,
				r.payback_date,
				r.payback_operator_id,
				r.is_finish,
				r.is_fully_redeemed,
				r.create_user_id,
				CONCAT(r.create_user_name,"/",(select personnel_shortCode from pm_personnel where personnel_id=r.create_user_id)) as create_user_name,
				r.create_user_dept_id,
				date_format(r.create_timestamp,'%Y-%m-%d %H:%i:%s') as create_timestamp_str,
				r.create_timestamp,
				r.last_update_user_id,
				date_format(r.last_update_timestamp,'%Y-%m-%d %H:%i:%s') as last_update_timestamp_str,
				r.last_update_timestamp,
				r.enable_flag,
				r.is_protocol_finish,
				r.salesman_id,
				CONCAT((select personnel_name from pm_personnel where personnel_id=r.salesman_id),"/",(select personnel_shortCode from pm_personnel where personnel_id=r.salesman_id)) as salesman_name,
				r.salesman_dept_id,
				r.is_payback,
				r.total_deduct_tax_point,
				r.redeem_company_reason,
		        r.is_take_off_damages,
		        r.redeem_type,
		        ifnull(r.org_wms_inve_redeem_id,r.wms_inve_redeem_id) as process_id,
				r.total_deduct_money,
				CASE WHEN 1=#{roleType} 
							  THEN 
		                          CASE 
		                               WHEN r.data_status = 6 THEN '005'
									   WHEN r.data_status = 7 THEN '006'
		                               WHEN r.data_status = 2 OR r.data_status = 3 OR r.data_status = 5 THEN '004'
		                               WHEN r.data_status = 1 THEN '002'
		                          END
		                 WHEN 2=#{roleType}
		                      THEN 
								  CASE 
									  WHEN r.data_status = 3 OR r.data_status = 5 THEN '004'
		                              WHEN r.data_status = 2 THEN '002'
		                              WHEN r.data_status = 1 THEN '003'
		                              WHEN r.data_status = 6 then '005'
		                              WHEN r.data_status = 7 THEN '006'
		                          END
		                 WHEN 3=#{roleType}
		                      THEN
				                  CASE 
				                      WHEN r.data_status = 3 THEN '002'
				                      WHEN r.data_status = 1 OR r.data_status = 2 THEN '003'
				                      WHEN r.data_status = 5 THEN '004'
				                      WHEN r.data_status = 6 then '005'
				                      WHEN r.data_status = 7 THEN '006'
					              END
				         WHEN 4=#{roleType}
				              THEN
				                  CASE 
				                       WHEN r.data_status = 6 THEN '005'   
				                       WHEN r.data_status = 7 THEN '006'
				                       ELSE '004'
				                  END
				   END
		           AS bill_type_code,
		           p1.personnel_name,
		           p1.personnel_shortCode,
		           ROUND(d.redeem_amount/10000) as redeem_amount
			from wms_inve_redeem r , wms_inve_redeem_detail d, wms_inve_transa t, pm_personnel p1
			<where>
				1=1
				and r.wms_inve_redeem_id = d.wms_inve_redeem_id
				and d.wms_inve_transa_id = t.wms_inve_transa_id
				and t.bel_salesman_id_id = p1.personnel_id
				and r.redeem_type in ('1','4')
				and (2>(SELECT COUNT(DISTINCT(p.group_info)) from wms_inve_transa_user t,wms_inve_transa_pruduct_user p where t.enable_flag=1 and p.enable_flag=1 and t.personnel_id in(r.create_user_id,#{userid}) and t.wms_inve_transa_pruduct_user_id=p.wms_inve_transa_pruduct_user_id) 
				or 1=(SELECT p.group_info from wms_inve_transa_user t,wms_inve_transa_pruduct_user p where t.enable_flag=1 and p.enable_flag=1 and t.personnel_id =#{userid} and t.wms_inve_transa_pruduct_user_id=p.wms_inve_transa_pruduct_user_id))
				and (1=2
				<if test="create_user_id !=null">or r.create_user_id = #{create_user_id}</if>
				<if test="create_user_dept_id !=null">or r.create_user_dept_id = #{create_user_dept_id}</if>
				<if test="salesman_id !=null">or t.bel_salesman_id_id = #{salesman_id}</if>
				<if test="salesman_dept_id !=null">or t.bel_salesman_dept_id = #{salesman_dept_id}</if>
				<if test="deptIds !=null">
					or t.bel_salesman_dept_id in
					<foreach collection="deptIds" item="dept_id" index="index"
						open="(" separator="," close=")">
						#{dept_id}
					</foreach>
				</if>
				<if test="deptIds_user_id !=null">or FIND_IN_SET(t.bel_salesman_dept_id,getMenuData(#{deptIds_user_id},#{deptIds_menu}))</if>
				<if test="financial_services !=null">or 1= #{financial_services}</if>
				<if test="super_user !=null">or 1 = #{super_user}</if>
				)
				<if test="searchInfo != null">
					and (r.cus_name like '%${searchInfo}%'
					OR	p1.personnel_name like '%${searchInfo}%'
					OR p1.personnel_shortCode like '%${searchInfo}%'
					)
				</if>
				<if test="query_type == null">
					<if test="data_status != null">
						AND r.data_status = #{data_status}
					</if>
				</if>
				<if test="query_type != null and query_type == 004">
					AND r.data_status in (1,2,3,5)
					<if test="roleType != null and roleType == 1">
						AND r.supervisor_result is not null
					</if>
					<if test="roleType != null and roleType == 2">
						AND r.submanager_result is not null
					</if>
					<if test="roleType != null and roleType == 3">
						AND r.manager_result is not null
					</if>
				</if>
				<if test="query_type != null and query_type == 003">
					<if test="roleType != null and roleType == 1">
					and 1=2
					</if>
					AND r.data_status in (1,2,3,5)
					<if test="roleType != null and roleType == 2">
						AND r.data_status = 1
					</if>
					<if test="roleType != null and roleType == 3">
						AND r.data_status in(1,2)
					</if>
				</if>
				AND r.data_status not in (4,8)
			</where>
		) t
		order by t.redeem_date desc, t.wms_inve_redeem_id desc
		<if test="offset != null and pagesize !=null">
			LIMIT ${offset} , ${pagesize}
		</if>
	</select>
	
	<!-- 待我审批查询sql -->
	<select id="searchForPhoneAppData" parameterType="map" resultType="map">
		select
			t.wms_inve_redeem_id,
		    t.is_take_off_damages,
			t.redeem_date_str,
			t.bill_type_code,
			case WHEN t.bill_type_code = '001' THEN '全部'
				 WHEN t.bill_type_code = '002' THEN '待我审批'
				 WHEN t.bill_type_code = '003' THEN '与我相关'
				 WHEN t.bill_type_code = '004' THEN '审批中'
				 WHEN t.bill_type_code = '005' THEN '已完成'
				 WHEN t.bill_type_code = '006' THEN '已撤销'
		    end
		    as bill_msg,
		    'wms' as system_name,
		    case when t.redeem_type = 1 then '赎回申请单(未到期)'
		         when t.redeem_type = 4 then '赎回申请单(到期/超期)'
		    end
		    as bill_title,
		    CONCAT(t.salesman_name,' ',t.salesman_shortcode,'的客户',t.cus_name,'申请赎回',t.redeem_amount,'万元') as bill_content
		from
		(
			select
				r.wms_inve_redeem_id,
				r.bill_code,
				r.data_status,
				(select value_meaning from wms_sys_dict_data where wms_sys_dict_id=60 and value_code=r.data_status) as data_status_name,
				r.id_card,
				r.cus_name,
				r.total_invest_amount,
				r.redeem_reason,
				date_format(r.redeem_date,'%Y-%m-%d') as redeem_date_str,
				r.redeem_date,
				r.supervisor_advice,
				r.supervisor_result,
				date_format(r.supervisor_date,'%Y-%m-%d') as supervisor_date_str,
				date_format(r.manager_date,'%Y-%m-%d') as manager_date_str,
				r.manager_date,
				r.salesman_id,
				(SELECT personnel_name from pm_personnel where personnel_id=r.salesman_id) as salesman_name,
				(SELECT personnel_shortCode from pm_personnel where personnel_id=r.salesman_id) as salesman_shortcode,
				d.wms_inve_redeem_detail_id,
				d.wms_inve_transa_prod_id,
				d.wms_inve_transa_id,
				ROUND(d.redeem_amount/10000) as redeem_amount,
				d.due_income,
				d.category_name,
				d.product_account,
				d.is_deduct_money,
				d.is_deduct_tax_point,
				d.deduct_money,
				r.redeem_company_reason,
		        r.is_take_off_damages,
		        r.redeem_type,
				d.deduct_tax_point,
				CASE WHEN 1=#{roleType} 
						  THEN 
	                          CASE 
	                               WHEN r.data_status = 6 THEN '005'
								   WHEN r.data_status = 7 THEN '006'
	                               WHEN r.data_status = 2 OR r.data_status = 3 OR r.data_status = 5 THEN '004'
	                               WHEN r.data_status = 1 THEN '002'
	                          END
	                 WHEN 2=#{roleType}
	                      THEN 
							  CASE 
								  WHEN r.data_status = 3 OR r.data_status = 5 THEN '004'
	                              WHEN r.data_status = 2 THEN '002'
	                              WHEN r.data_status = 1 THEN '003'
	                          END
	                 WHEN 3=#{roleType}
	                      THEN
			                  CASE 
			                      WHEN r.data_status = 3 THEN '002'
			                      WHEN r.data_status = 1 OR r.data_status = 2 THEN '003'
			                      WHEN r.data_status = 5 THEN '004'
				              END
			         WHEN 4=#{roleType}
			              THEN
			                  CASE 
			                       WHEN r.data_status = 6 THEN '005'   
			                       WHEN r.data_status = 7 THEN '006'
			                       ELSE '004'
			                  END
			   END
	           AS bill_type_code
			from wms_inve_redeem r,wms_inve_redeem_detail d
			<where>
				r.enable_flag=1 and d.enable_flag=1
			and r.wms_inve_redeem_id = d.wms_inve_redeem_id
			<!-- and ((r.special_approval_leader_id is null and r.data_status in(1,2,3)) or (r.special_approval_leader_id=#{user_id} and r.data_status=3)) -->
				<if test="searchInfo != null">
					and (r.cus_name like '%${searchInfo}%' 
					or (SELECT salesman_name from  wms_inve_transa where wms_inve_transa_id=d.wms_inve_transa_id) like '%${searchInfo}%'
					or (SELECT salesman_shortcode from  wms_inve_transa where wms_inve_transa_id=d.wms_inve_transa_id) like '%${searchInfo}%')
				</if>
				<if test="user_id != null">
					and r.special_approval_leader_id=#{user_id} 
					and r.data_status=3
				</if>
				<if test="user_id == null">
					and r.special_approval_leader_id is null 
					and r.data_status in(1,2,3)
				</if>
				<if test="idList !=null">
					and r.wms_inve_redeem_id in
					<foreach collection="idList" item="wms_inve_redeem_id"
						index="index" open="(" separator="," close=")">
						#{wms_inve_redeem_id}
					</foreach>
				</if>
			</where>
		) t
		order by t.redeem_date desc, t.wms_inve_redeem_id desc
<!-- 		<if test="sortname != '' and sortorder !=''"> -->
<!-- 			ORDER BY ${sortname} ${sortorder} -->
<!-- 		</if> -->
	</select>
	
	
	<select id="searchForPhoneAppYsData" parameterType="map" resultType="map">
		select
			t.wms_inve_redeem_id,
		    t.is_take_off_damages,
			t.redeem_date_str,
			t.bill_type_code,
			case when t.bill_type_code = '001' then '全部'
				 when t.bill_type_code = '002' then '待我审批'
				 when t.bill_type_code = '003' then '与我相关'
				 when t.bill_type_code = '004' then '审批中'
				 when t.bill_type_code = '005' then '已完成'
				 when t.bill_type_code = '006' then '已撤销'
		    end
		    as bill_msg,
		    'wms' as system_name,
		    case when t.redeem_type = 1 then '赎回申请单(未到期)'
		         when t.redeem_type = 4 then '赎回申请单(到期/超期)'
		    end
		    as bill_title,
		    CONCAT(t.salesman_name,' ',t.salesman_shortcode,'的客户',t.cus_name,'申请赎回',t.redeem_amount,'万元') as bill_content,
		    'ok' as is_aprro
		from
		(
			select
				r.wms_inve_redeem_id,
				r.bill_code,
				r.data_status,
				(select value_meaning from wms_sys_dict_data where wms_sys_dict_id=60 and value_code=r.data_status) as data_status_name,
				r.id_card,
				r.cus_name,
				r.total_invest_amount,
				r.redeem_reason,
				date_format(r.redeem_date,'%Y-%m-%d') as redeem_date_str,
				r.redeem_date,
				r.supervisor_advice,
				r.supervisor_result,
				date_format(r.supervisor_date,'%Y-%m-%d') as supervisor_date_str,
				date_format(r.manager_date,'%Y-%m-%d') as manager_date_str,
				r.manager_date,
				r.salesman_id,
				(SELECT personnel_name from pm_personnel where personnel_id=r.salesman_id) as salesman_name,
				(SELECT personnel_shortCode from pm_personnel where personnel_id=r.salesman_id) as salesman_shortcode,
				d.wms_inve_redeem_detail_id,
				d.wms_inve_transa_prod_id,
				d.wms_inve_transa_id,
				ROUND(d.redeem_amount/10000) as redeem_amount,
				d.due_income,
				d.category_name,
				d.product_account,
				d.is_deduct_money,
				d.is_deduct_tax_point,
				d.deduct_money,
				r.redeem_company_reason,
		        r.is_take_off_damages,
		        r.redeem_type,
				d.deduct_tax_point,
				'ok' as is_aprro,
				CASE WHEN 1=#{roleType} 
							  THEN 
		                          CASE 
		                               WHEN r.data_status = 6 THEN '005'
									   WHEN r.data_status = 7 THEN '006'
		                               WHEN r.data_status = 2 OR r.data_status = 3 OR r.data_status = 5 THEN '004'
		                               WHEN r.data_status = 1 THEN '002'
		                          END
		                 WHEN 2=#{roleType}
		                      THEN 
								  CASE 
									  WHEN r.data_status = 3 OR r.data_status = 5 THEN '004'
		                              WHEN r.data_status = 2 THEN '002'
		                              WHEN r.data_status = 1 THEN '003'
		                              WHEN r.data_status = 6 THEN '005'
		                              WHEN r.data_status = 7 THEN '006'
		                          END
		                 WHEN 3=#{roleType}
		                      THEN
				                  CASE 
				                      WHEN r.data_status = 3 THEN '002'
				                      WHEN r.data_status = 1 OR r.data_status = 2 THEN '003'
				                      WHEN r.data_status = 5 THEN '004'
				                      WHEN r.data_status = 6 THEN '005'
		                              WHEN r.data_status = 7 THEN '006'
					              END
				         WHEN 4=#{roleType}
				              THEN
				                  CASE 
				                       WHEN r.data_status = 6 THEN '005'   
				                       WHEN r.data_status = 7 THEN '006'
				                       ELSE '004'
				                  END
				   END
		           AS bill_type_code
			from wms_inve_redeem r,wms_inve_redeem_detail d,wms_inve_transa t3
			<where>
				r.enable_flag=1 and d.enable_flag=1
				and  r.wms_inve_redeem_id =d.wms_inve_redeem_id
				and d.wms_inve_transa_id=t3.wms_inve_transa_id
				and r.data_status not in (4,8)
				and (
		 			(r.supervisor_date = #{qry_date} and t3.bel_department_manager_id=#{user_id})
					or (r.submanager_date = #{qry_date} and t3.bel_vice_general_manager_id=#{user_id}) 
					or (r.manager_date = #{qry_date} and t3.bel_general_manager_id=#{user_id}) 
					or (r.special_approval_date = #{qry_date} and t3.bel_general_manager_id=#{user_id})
				)
				<if test="searchInfo != null">
					and (r.cus_name like '%${searchInfo}%' 
					or (SELECT salesman_name from  wms_inve_transa where wms_inve_transa_id=d.wms_inve_transa_id) like '%${searchInfo}%'
					or (SELECT salesman_shortcode from  wms_inve_transa where wms_inve_transa_id=d.wms_inve_transa_id) like '%${searchInfo}%')
				</if>
			</where>
		) t
		order by t.redeem_date desc, t.wms_inve_redeem_id desc
<!-- 		<if test="sortname != '' and sortorder !=''"> -->
<!-- 			ORDER BY ${sortname} ${sortorder} -->
<!-- 		</if> -->
	</select>
	
	<select id="getRedeemInfo" parameterType="map" resultType="map">
		 SELECT
			wr.wms_inve_redeem_id,
			wr.wms_inve_customer_id,
			wr.bill_code,
			wr.data_status,
			wr.id_card,
			wr.cus_name,
			wr.total_invest_amount,
			wr.redeem_reason,
			wr.redeem_date,
			wr.supervisor_advice,
			wr.supervisor_result,
			wr.supervisor_date,
			wr.submanager_advice,
			wr.submanager_result,
			wr.submanager_date,
			wr.manager_advice,
			wr.manager_result,
			wr.manager_date,
			wr.is_special_approval,
			wr.special_approval_operator_id,
			wr.special_approval_date,
			wr.special_approval_leader_id,
			wr.special_approval_leader_name,
			wr.special_approval_advice,
			wr.redeem_payback_card_name,
			wr.redeem_payback_card_no,
			wr.redeem_apply_total_amount,
			wr.total_due_income,
			wr.total_management_fee,
			wr.redeem_reality_total_amount,
			wr.payback_date,
			wr.payback_operator_id,
			wr.is_finish,
			wr.is_fully_redeemed,
			wr.create_user_id,
			wr.create_user_name,
			wr.create_user_dept_id,
			wr.create_timestamp,
			wr.last_update_user_id,
			wr.last_update_timestamp,
			wr.enable_flag,
			wr.is_protocol_finish,
			wr.salesman_id,
			wr.salesman_dept_id,
			wr.is_payback,
			wr.special_approval_result,
			wr.total_deduct_tax_point,
			wr.total_deduct_money,
			wr.redeem_company_reason,
			wr.is_take_off_damages,
			wr.redeem_type,
			wr.redeem_type_detail,
			wr.redeem_reality_total_amount_upper,
			wr.org_wms_inve_redeem_id,
			wt.bel_salesman_id_id,
			wt.bel_vice_general_manager_id,
			wt.bel_department_manager_id,
			wt.bel_general_manager_id,
			ROUND(wd.redeem_amount / 10000) as redeem_amount,
			(SELECT personnel_shortCode FROM pm_personnel WHERE personnel_id = wt.bel_salesman_id_id AND enable_flag = 1) AS salesman_ishortCode,
			(SELECT personnel_name FROM pm_personnel WHERE personnel_id = wt.bel_salesman_id_id AND enable_flag = 1) AS salesman_name,
			(SELECT personnel_shortCode FROM pm_personnel WHERE personnel_id = wt.bel_vice_general_manager_id AND enable_flag = 1) AS vice_general_manager_code,
			(SELECT personnel_name FROM pm_personnel WHERE personnel_id = wt.bel_vice_general_manager_id AND enable_flag = 1) AS vice_general_manager_name,
			(SELECT personnel_shortCode FROM pm_personnel WHERE personnel_id = wt.bel_department_manager_id AND enable_flag = 1) AS department_manager_code,
			(SELECT personnel_name FROM pm_personnel WHERE personnel_id = wt.bel_department_manager_id AND enable_flag = 1) AS department_manager_name,
			(SELECT personnel_shortCode FROM pm_personnel WHERE personnel_id = wt.bel_general_manager_id AND enable_flag = 1) AS general_manager_code,
			(SELECT personnel_name FROM pm_personnel WHERE personnel_id = wt.bel_general_manager_id AND enable_flag = 1) AS general_manager_name,
			case when wr.redeem_type = 1 then '赎回申请单(未到期)'
		         when wr.redeem_type = 4 then '赎回申请单(到期/超期)'
		    end
		    as bill_title
		FROM
			wms_inve_redeem wr,
			wms_inve_redeem_detail wd,
			wms_inve_transa wt
		WHERE wr.wms_inve_redeem_id = wd.wms_inve_redeem_id
		AND wd.wms_inve_transa_id = wt.wms_inve_transa_id
		AND wr.wms_inve_redeem_id = #{wms_inve_redeem_id}
	</select>

	<!-- 根据赎回详细信息表主键获取对应的赎回信息 -->
	<select id="getWmsInveRedeemInfoByWmsInveRedeemDetailId" parameterType="int" resultType="map">
		SELECT
			t1.redeem_amount,
			t1.wms_inve_redeem_id
		FROM
			wms_inve_redeem_detail t1
		WHERE
			wms_inve_redeem_detail_id = #{wmsInveRedeemDetailId}
	</select>
	
	<select id="searchFinancialRedeemListForExport" parameterType="map" resultType="map">
		SELECT
			r.bill_code,
			case when c.bel_personnel_id is not null then CONCAT((select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=t.bel_salesman_id_id),'(转)') 
			else (select CONCAT(x.personnel_name,' ',x.personnel_shortCode) from pm_personnel x where x.personnel_id=t.bel_salesman_id_id) end as salesman_name,
			t.cus_name,
			tp.category_name,
			IFNULL(t.financial_bill_code,'--') as financial_bill_code,
			tp.org_product_account / 10000 as org_product_account,
			r.redeem_apply_total_amount / 10000 as redeem_amount,
			IFNULL(r.total_management_fee,0) as total_management_fee,
			IFNULL(r.redeem_reality_total_amount,0) as redeem_reality_total_amount,
			DATE_FORMAT(r.redeem_date,'%Y/%m/%d') as redeem_date,
			IF(t.data_status = 1, '待经理审核', IF(t.data_status = 2, '待副总经理审核', IF(t.data_status = 3, '待总经理审核', IF(t.data_status = 5, '待回款', '已完成')))) as data_status
		FROM
			wms_inve_transa t
			LEFT JOIN (
				SELECT
					wms_inve_customer_id,
					bel_personnel_id,
					max(end_of_date) AS end_date
				FROM
					wms_inve_customer_remove_his
				WHERE
					data_type = '1'
				GROUP BY
					wms_inve_customer_id,
					bel_personnel_id
			) c ON t.wms_inve_customer_id = c.wms_inve_customer_id,
		 wms_inve_transa_prod tp,
		 wms_inve_redeem r,
		 wms_inve_redeem_detail d
		WHERE
			t.wms_inve_transa_id = tp.wms_inve_transa_id
		AND t.wms_inve_transa_id = d.wms_inve_transa_id
		AND d.wms_inve_redeem_id = r.wms_inve_redeem_id
		AND r.data_status IN (1,2,3,5,6,8)
		AND r.org_wms_inve_redeem_id IS NULL
		<if test="cus_name != null">
			and t.cus_name like #{cus_name}
		</if>
		<if test="id_card != null">
			and t.id_card  like #{id_card}
		</if>
		<if test="redeem_date_begin != null">
			and r.redeem_date &gt;=#{redeem_date_begin}
		</if>
		<if test="redeem_date_end != null">
			and r.redeem_date &lt;=#{redeem_date_end}
		</if>
		<if test="is_special_approval != null">
			and r.is_special_approval =#{is_special_approval}
		</if>
		<if test="special_approval_leader_id != null">
			and r.special_approval_leader_id=#{special_approval_leader_id}
		</if>
		<if test="data_status_name != null">
			and r.data_status =#{data_status_name}
		</if>
		<if test="create_user_name != null">
			and (r.create_user_name =#{create_user_name} or r.create_user_name=(select personnel_name from pm_personnel where personnel_shortCode=#{create_user_name}))
		</if>
		<if test="salesman_name != null">
		    and (r.salesman_id =(select personnel_id from pm_personnel where personnel_name=#{salesman_name}) or r.salesman_id=(select personnel_id from pm_personnel where personnel_shortCode=#{salesman_name}))
		</if>
		<if test="bel_salesman_id_id != null">
		    and (p1.personnel_name =#{bel_salesman_id_id} or p1.personnel_shortCode=#{bel_salesman_id_id})
		</if>
	</select>
</mapper> 
