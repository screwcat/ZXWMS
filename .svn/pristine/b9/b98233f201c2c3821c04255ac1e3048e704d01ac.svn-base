<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>理财产品&gt;产品新增</title>
<link href="../../css/app.css" type="text/css" rel="stylesheet" />
<link href="../../css/zx-all.css" rel="stylesheet" type="text/css" />
<script src="../../js/zx-all.js" type="text/javascript"></script>
<style type="text/css">
.textright {
	text-align: right;
}

.textleft {
	text-align: left;
}
/*input_tb css*/
.input_tb_new {
	/*border:1px solid #dfdfdf;*/
	width: 100%;
	margin-bottom: 10px;
}

.input_tb_new a {
	color: #056aff;
	text-decoration: none;
	font-weight: normal;
}

.input_tb_new td {
	height: 35px;
	line-height: 25px;
	/*border-bottom:1px dashed #d5d5d5;*/
	padding-top: 3px;
}

.input_tb_new .tr_title td {
	background-color: #f5f8ff;
	padding-left: 16px;
	font-weight: bold;
	height: 30px;
	line-height: 30px;
	/*border-bottom:1px solid #dfdfdf;*/
}

.input_tb_new .tr_last td {
	border-bottom: 0;
}

.input_tb_new .title {
	text-align: right;
}

.input_tb_new .subtitle {
	text-align: left;
	background-color: #d2e1fd;
	border-top: 1px solid #fff;
	/*border-left:1px solid #fff;*/
}

.input_tb_new .tr_btn_input td {
	background-color: #fbfbfb;
	/*border-top:1px solid #dbdbdb;*/
	/*height:40px;*/
}

.title_tb {
	background-color: #f5f8ff;
	padding-left: 16px;
	font-weight: bold;
	height: 30px;
	line-height: 30px;
    /*border:1px solid #dfdfdf;8/
    border-bottom:0;
}

.title_tb .title_txt{
float:left;
}

.title_tb .title_btn{
float:right;
margin-top:2px;
font-weight:normal;
}

.input_tb_new td {
    /*border-bottom: 1px dashed #D5D5D5;*/
	height: 35px;
	line-height: 25px;
	padding-top: 3px;
}

.data_tb td {
	height: 30px;
	line-height: 24px;
	padding-left: 10px;
	border-bottom: 1px dashed #e3e4e6;
	text-align: left;
}
</style>

<script type="text/javascript">
	var grid_basic, toolbar, params, dialog, columns,grid_limit;
	var wms_inve_pruduct_category_id = $.query.get('wms_inve_pruduct_category_id');
	var cktype = $.query.get('cktype');
	var flaga=false;
	$(function() {
		//产品利率设置--累计月份
		var toolbarItemData1 = [];
		toolbarItemData1.push({
			text : '新增',
			click: addRows1,
			icon : 'add'
		});
		toolbarItemData1.push({
			line : true
		});			
		toolbarItemData1.push({
			text : '删除',
			click: deleteRow1,
			icon : 'delete'
		});
		toolbarItemData1.push({
			line : true
		});
		//--产品限制信息
		var toolbarItemData2 = [];
		toolbarItemData2.push({
			text : '新增',
			click: addRows2,
			icon : 'add'
		});
		toolbarItemData2.push({
			line : true
		});			
		toolbarItemData2.push({
			text : '删除',
			click: deleteRow2,
			icon : 'delete'
		});
		toolbarItemData2.push({
			line : true
		});
		//产品利率设置--累计存量
		var toolbarItemData3 = [];
		toolbarItemData3.push({
			text : '新增',
			click: addRows3,
			icon : 'add'
		});
		toolbarItemData3.push({
			line : true
		});			
		toolbarItemData3.push({
			text : '删除',
			click: deleteRow3,
			icon : 'delete'
		});
		toolbarItemData3.push({
			line : true
		});
		$("#centertoolbar1").ligerToolBar({
			items : toolbarItemData1
		});
		$("#centertoolbar2").ligerToolBar({
			items : toolbarItemData2
		});
		//产品利率设置--累计存量
		$("#centertoolbar3").ligerToolBar({
			items : toolbarItemData3
		});
		$("select").attr({
			"disabled" : "disabled"
		});
		init_Grid_Limit();//初始化产品限制信息
		init_info();
	});
	
	//初始化产品信息
	function init_info(){
		$.getJSON(globalUtil.getTimestampUrl('/inve/wmsinvepruductcategoryinfobypk.do'),////初始化数据
			{
				"wms_inve_pruduct_category_id": wms_inve_pruduct_category_id
			},
			function(jsonForSys) {
				delete jsonForSys.category_code;
				//初始化赋值
				if(jsonForSys.category_over_time=="9999-01-01"){
					jsonForSys.category_over_time="";
				}
				globalUtil.setFormValByid("dkinfo", jsonForSys);
				getLCCode();//获取产品编号
				$("#basic_monthly_rate").val(jsonForSys.basic_monthly_rate);//基础月付利率
				$("#category_over_time").val(jsonForSys.category_over_time);//产品结束日期(针对产品使用日期最长期限)
				$("#category_maximum_amount").val(jsonForSys.category_maximum_amount);//产品最大金额(针对产品使用最大金额期限)
				$("#category_remak").val(jsonForSys.category_remak);//备注
				init_category_type(jsonForSys);//产品类型
				//初始化平台系统
				var setPlatform_user =jsonForSys.platform_user;
				if (setPlatform_user != null && setPlatform_user.length > 0) {
					var compindsarr = setPlatform_user.split(",");
					$("input[name='platform_user']").each(function() {
						if (checkArr(compindsarr, $(this).val())) {
							$(this).attr('checked', 'checked');
						} else {
							$(this).removeAttr('checked');
						}
					});
				}
				
				//初始化购买条件  满多少个月可购买
				$("#buy_month_limit").val(jsonForSys.buy_month_limit);
				//初始化 是否提供纸质合同项
				if(jsonForSys.has_paper_protocol !=null){
					$("[name=has_paper_protocol]").each(function() {
						if ($(this).val() == jsonForSys.has_paper_protocol) {
							$(this).attr('checked', 'checked');
							return false;
						}
					});
				}	
						
				if(jsonForSys.category_interest_pay_method !=null){
					$("[name=category_interest_pay_method]").each(function() {
						if ($(this).val() == jsonForSys.category_interest_pay_method) {
							$(this).attr('checked', 'checked');
							return false;
						}
					});
				}	
				if(jsonForSys.category_interest_pay_method==2){//付息方式付息方式:  1 月付  2 年付
				  $("#nfll").css("display","");
				  $("#yfll").css("display","none");
				  $("#centertoolbar3").css("display","none");
				  $("#grid_basic2").css("display","none");
				  $("#centertoolbar1").css("display","none");
				  $("#grid_basic").css("display","none");
				  $.getJSON(globalUtil.getTimestampUrl('/inve/wmsinvepruductyearpayspecialinfobyck.do'),////获取年付特
							{
								"wms_inve_pruduct_category_id": wms_inve_pruduct_category_id
							},
							function(jsonForSys) {
								if(jsonForSys){
									//初始化赋值
									$("#first_year_interest_rate").val(jsonForSys.first_year_interest_rate);//第一年付利率
									$("#second_year_interest_rate").val(jsonForSys.second_year_interest_rate);//第二年付利率
								}
							});
					
				}else{//返利方式返利方式 1满 月数  2 累计存量
				   if(jsonForSys.category_rebate_way !=null){
					$("[name=category_rebate_way]").each(function() {
						if ($(this).val() == jsonForSys.category_rebate_way) {
							$(this).attr('checked', 'checked');
							return false;
						}
					});
				   }
				  $("#nfll").css("display","none"); 
				  $("#yfll").css("display","");
				  if(jsonForSys.category_rebate_way==1){////返利方式:  1 月付  2 累计存量
					  $("#centertoolbar1").css("display","");
					  $("#grid_basic").css("display","");
					  $("#centertoolbar3").css("display","none");
					  $("#grid_basic2").css("display","none");		
				  }else{  
					  $("#centertoolbar1").css("display","none");
				 	  $("#grid_basic").css("display","none");
					  $("#centertoolbar3").css("display","");
					  $("#grid_basic2").css("display","");
				  }
				}
				initGrid();//初始化产品利率设置--满月
				initGrid2();//初始化产品利率设置--；累计存量
			});		
	}
	//获取理财产品编号
	function getLCCode(){
		$.getJSON(globalUtil.getTimestampUrl('/inve/getLCCode.do'),////初始化数据
				function(jsonForSys) {	
					$("#category_code").val(jsonForSys);//产品编号
		});
	}
	function checkArr(commarr, val) {
		for (var i = 0; i < commarr.length; i++) {
			if (val == commarr[i]) {
				return true;
			}
		}
		return false;
	}
	//添加grid行--//产品利率设置--累计月份
	function addRows1() {
		var manager = $("#grid_basic").ligerGetGridManager();   
		manager.endEdit();
		manager.addRow({'full_month':'','bonus_rate':''});
	}
	//添加grid行--产品限制信息
	function addRows2() {
		var manager = $("#grid_limit").ligerGetGridManager();   
		manager.endEdit();
		manager.addRow({'deadline_begin_date':'','deadline_end_date':'','management_fee':'','product_interest':''});
		updateStartDate(manager);
	}
	//添加grid行--产品利率设置--累计存量
	function addRows3() {
		var manager = $("#grid_basic2").ligerGetGridManager();   
		manager.endEdit();
		manager.addRow({'customer_stock_begin':'','customer_stock_end':'','full_month':'','bonus_rate':''});
	}
	//删除grid选中行--//产品利率设置--累计月份
	function deleteRow1() {
	 	var manager = $("#grid_basic").ligerGetGridManager();
	    var row = manager.getSelectedRow();
	    if (!row) {
	        globalUtil.warnMsg(globalErrorMsg['100001']); //请选择一行记录进行删除
	        return;
	    }
	    globalUtil.confirmMsg(globalErrorMsg['100016'],
	    function(yes) { //确认删除
	    	if(yes){
	    		global_ligerui_extend.deleteSelectedRow(manager);
	    		flaga=true;
	    	}
	    });
	}
	//删除grid选中行--产品限制信息
	function deleteRow2() {
	 	var manager = $("#grid_limit").ligerGetGridManager();
	    var row = manager.getSelectedRow();
	    if (!row) {
	        globalUtil.warnMsg(globalErrorMsg['100001']); //请选择一行记录进行删除
	        return;
	    }
	    
	    globalUtil.confirmMsg(globalErrorMsg['100016'],
	    function(yes) { //确认删除
	    	if(yes){
	    		global_ligerui_extend.deleteSelectedRow(manager);
	    	}
	    });
	}
	//删除grid选中行--产品利率设置--累计存量
	function deleteRow3() {
	 	var manager = $("#grid_basic2").ligerGetGridManager();
	    var row = manager.getSelectedRow();
	    if (!row) {
	        globalUtil.warnMsg(globalErrorMsg['100001']); //请选择一行记录进行删除
	        return;
	    }
	    globalUtil.confirmMsg(globalErrorMsg['100016'],
	    function(yes) { //确认删除
	    	if(yes){
	    		global_ligerui_extend.deleteSelectedRow(manager);
	    		flaga=true;
	    	}
	    });
	}
    //表格初始化--产品利率设置--月付
    function initGrid() {
    	var columns_grid = [{
        	display:'',
        	name:'',
            width: 50,
            minWidth: 50,
            render: function (rowdata, nowRowIndex, value, column) {
				return "满";
			}
        },{
            display: '时间（月）',
            name: 'full_month',
            width: 80,
            minWidth: 80,
            editor: { 
				type: 'text', 
				maxlength:50,
				ext:{
					onChangeValue: function(value){ 
						var textObj = this;
						if(!globalUtil.isNum(value)){
							textObj.setValue('');
							globalUtil.warnMsg(globalErrorMsg['901128']);//提示信息 您输入的不是整数	
						}
					}
				}       							
       		}
	    							
        },{
        	display:'',
        	name:'',
            width: 50,
            minWidth: 50,
            render: function (rowdata, nowRowIndex, value, column) {
				return "+";
			}
        },{
        	display:'奖励利率%',
        	name:'bonus_rate',
            width: 80,
            minWidth: 80,
            editor: { 
				type: 'text', 
				maxlength:100,
				ext:{
					onChangeValue: function(value){ 
						var textObj = this;
						if(!globalUtil.isFloat(value)){
							textObj.setValue('');
							globalUtil.warnMsg(globalErrorMsg['901129']);//提示信息 您输入的不是整数	
						}
					}
				}       							
       		}
        }];
    	grid_basic = $("#grid_basic").ligerGrid({
    		columns: columns_grid,
    		url: global_param.context_name + '/inve/wmsinvepruductrebatewaywithoutpaginglist.do?wms_inve_pruduct_category_id=' + wms_inve_pruduct_category_id +"&category_rebate_way=1",//返利方式 1满 月数  2 累计存量
    		rownumbers: true,
    		allowUnSelectRow: true,
    		width: '100%',
            height: 120,
            heightDiff: -4,
    		usePager: false,
			enabledEdit: true,
        });
    }
    //表格初始化---产品利率设置--年付
    function initGrid2() {
    	var columns_grid = [{
            display: '客户存量（万）',
            name: '',
            width: 180,
            minWidth: 180,
       		columns :[{
		            	display:'',
		            	name:'',
		                width: 100,
		                minWidth: 100,
		                render: function (rowdata, nowRowIndex, value, column) {
		    				return "客户存量满";
		    			}
		            },{
							display: '起始金额（万）',
							name: 'customer_stock_begin',
							width: 120,
							minWidth: 120,
							editor: { 
								type: 'text', 
								maxlength:50,
								ext:{
									onChangeValue: function(value){ 
										var textObj = this;
										if(!globalUtil.isNum(value)){
											textObj.setValue('');
											globalUtil.warnMsg(globalErrorMsg['901130']);//提示信息 
										}
									}
								}       							
							}
       					},{
							display: '截止金额（万）',
							name: 'customer_stock_end',
							width: 120,
							minWidth: 120,
							editor: { 
								type: 'text', 
								maxlength:50,
								ext:{
									onChangeValue: function(value){ 
										var textObj = this;
										if(!globalUtil.isNum(value)){
											textObj.setValue('');
											globalUtil.warnMsg(globalErrorMsg['901131']);//提示信息 	
										}
									}
								}       							
							}
						}]					
        },{
        	display:'',
        	name:'',
            width: 50,
            minWidth: 50,
            render: function (rowdata, nowRowIndex, value, column) {
				return "满";
			}
        },{
            display: '时间（月）',
            name: 'full_month',
            width: 80,
            minWidth: 80,
            editor: { 
				type: 'text', 
				maxlength:50,
				ext:{
					onChangeValue: function(value){ 
						var textObj = this;
						if(!globalUtil.isNum(value)){
							textObj.setValue('');
							globalUtil.warnMsg(globalErrorMsg['901128']);//提示信息 	
						}
					}
				}       							
       		}
	    							
        },{
        	display:'',
        	name:'',
            width: 50,
            minWidth: 50,
            render: function (rowdata, nowRowIndex, value, column) {
				return "+";
			}
        },{
        	display:'返利利率%',
        	name:'bonus_rate',
            width: 80,
            minWidth: 80,
            editor: { 
				type: 'text', 
				maxlength:100,
				ext:{
					onChangeValue: function(value){ 
						var textObj = this;
						if(!globalUtil.isNum(value)){
							textObj.setValue('');
							globalUtil.warnMsg(globalErrorMsg['901129']);//提示信息 	
						}
					}
				}       							
       		}
        }];
    	grid_basic2 = $("#grid_basic2").ligerGrid({
    		columns: columns_grid,
    		url: global_param.context_name + '/inve/wmsinvepruductrebatewaywithoutpaginglist.do?wms_inve_pruduct_category_id=' + wms_inve_pruduct_category_id +"&category_rebate_way=2",//返利方式 1满 月数  2 累计存量
    		rownumbers: true,
    		allowUnSelectRow: true,
    		width: '100%',
            height: 120,
            heightDiff: -4,
    		usePager: false,
			enabledEdit: true,
        });
    }

    //表格初始化--限制表
    function init_Grid_Limit() {
    	columns_val = [{
            display: '<span style="color: red;">*</span>起始天数（天）',
            name: 'bill_code',
            width: 200,
            minWidth: 200,
            columns:
            	[{
    				display:'<span style="color: red;">*</span>起始天数（天）',
    	        	name:'deadline_begin_date',
    	            width: 170,
    	            minWidth: 170,
    	            editor: { 
    					type: 'text', 
    					maxlength:10,
    					ext:{
    						onChangeValue: function(value){ 
    							var textObj = this;
    							if(!globalUtil.isNum(value)){
    								textObj.setValue('');
    								globalUtil.warnMsg(globalErrorMsg['901132']);//提示信息 	
    							}
    						}
    					}       							
    	       		}
    			},{
    				display : '<span style="color: red;">*</span>截止天数（天）',
    				name : 'deadline_end_date',
    				width : 170,
    				minWidth : 170,
    				editor: { 
    					type: 'text', 
    					maxlength:10,
    					ext:{
    						onChangeValue: function(value){ 
    							var textObj = this;
    							if(!globalUtil.isNum(value)){
    								textObj.setValue('');
    								globalUtil.warnMsg(globalErrorMsg['901133']);//提示信息 	
    							}
    						}
    					}       							
    	       		}
    			}]
        },{
        	display:'<span style="color: red;">*</span>管理费率（%）',
        	name:'management_fee',
        	width:150,
        	minWidth:150,
        	 editor: { 
					type: 'text', 
					maxlength:10,
					ext:{
						onChangeValue: function(value){ 
							var textObj = this;
							if(!globalUtil.isFloat(value)){
								textObj.setValue('');
								globalUtil.warnMsg(globalErrorMsg['901134']);//提示信息 	
							}
						}
					}       							
	       		}
        },{
            display: '<span style="color: red;">*</span>结算年化利率（%）',
            name: 'product_interest',
            width: 200,
            minWidth: 200,
            editor: { 
				type: 'text', 
				maxlength:10,
				ext:{
					onChangeValue: function(value){ 
						var textObj = this;
						if(!globalUtil.isFloat(value)){
							textObj.setValue('');
							globalUtil.warnMsg(globalErrorMsg['901135']);//提示信息 	
						}
					} 
				} 
       		}
        }];
    	
    	grid_limit = $("#grid_limit").ligerGrid({
    		columns: columns_val,
    		url: global_param.context_name + '/inve/wmsinvepruductreturngetlist.do?wms_inve_pruduct_category_id=' + wms_inve_pruduct_category_id,
    		rownumbers: true,
    		allowUnSelectRow: false,
    		sortName: 'bill_code', // 排序列名
			sortOrder: 'desc', // 排序方式
    		width: '100%',
            height: 120,
            heightDiff: -4,
    		usePager: false,
			enabledEdit: true
        });
    }  
    //处理产品限制表
    function updateStartDate(manager){
		var data_val= grid_limit.getData()[parseInt(manager.rows.length)-2]["deadline_end_date"];
		if(data_val==null||data_val==""){
			grid_limit.updateCell("deadline_begin_date", "", parseInt(manager.rows.length)-1);
		}else{
			grid_limit.updateCell("deadline_begin_date", parseInt(data_val)+1, parseInt(manager.rows.length)-1);
		}
    }
    function  setnull(rowindex){
    	 grid_basic.updateCell("product_deadline", "", rowindex);
    }
  //当用户点击付息方式中--月付 --年付 时改变第一年付利率的输入框
 function clickChange(flag){
	 
	  if(flag==1){//年付
		  $("#nfll").css("display","");
		  $("#yfll").css("display","none");
		  $("#centertoolbar3").css("display","none");
		  $("#grid_basic2").css("display","none");
		  $("#centertoolbar1").css("display","none");
		  $("#grid_basic").css("display","none");
		  
		  //$("#basic_monthly_rate").val("");//基础月付利率
	  }else{
		  $("#nfll").css("display","none"); 
		  $("#yfll").css("display","");
		  var jsonval={};
		  is_Category_rebate_way(jsonval);//付息方式:  1 月付  2 年付
		  if(jsonval.category_rebate_way==1){
			  $("#centertoolbar1").css("display","");
			  $("#grid_basic").css("display","");
			  $("#centertoolbar3").css("display","none");
			  $("#grid_basic2").css("display","none");
		  }else{  
			  $("#centertoolbar1").css("display","none");
		 	  $("#grid_basic").css("display","none");
			  $("#centertoolbar3").css("display","");
			  $("#grid_basic2").css("display","");
		  }
		 /*$("#first_year_interest_rate").val("");//第一年付利率
		  $("#second_year_interest_rate").val("");//第二年付利率*/
	  }
 }
  //当用户点击月付利率或者是累计存量时候改变显示
 function clickDisplay(flag){
	 if(flag==1){//累计存量
		  $("#centertoolbar3").css("display","");
		  $("#grid_basic2").css("display","");
		  $("#centertoolbar1").css("display","none");
		  $("#grid_basic").css("display","none");
	  }else{//满月份
		  $("#centertoolbar1").css("display","");
		  $("#grid_basic").css("display","");
		  $("#centertoolbar3").css("display","none");
		  $("#grid_basic2").css("display","none");
	  }
 }
	//贷款产品种类
	function init_category_type(json){
		var cre_loan_type_params ={
				dest_url:'/sysmanage/wmssysdictdatabydictidempty.do?isEmpty=true&wms_sys_dict_id=79',
				t_col_name:'category_type',
				valueField:'value_code',   //下拉框value对应的值，默认为id
				textField:'value_meaning',    //下拉框text对应的值，默认为text
				def_val:'first'
				};
		global_ligerui_extend.initCombox("category_type",null,cre_loan_type_params);
		if(json){
			//把值装载设定
			global_ligerui_extend.syncRequestInitComboxData(json,"category_type");
			//让其不可编辑
			//global_ligerui_extend.disabledCombox("category_type");
		}else{			
		    global_ligerui_extend.initComboxDefVal("category_type");
		}
	}
/*
	获取表格数据，去除全部为空的记录
*/
function getGridData(grid){
	 grid.endEdit();
	 var data_all = grid.getData();
	 var griddata = [];
	 
  for(var i=0;i<data_all.length;i++){
		var data = data_all[i];
		var isEmpty = true;
	 		if(data){
				for(var key in data){
					if($.trim(key) == '' || $.trim(key) == '__status'){continue;}
					if(!globalUtil.isEmpty(data[key])){
						if(data[key] instanceof Date){
							data[key]= data[key].format('yyyy-MM-dd');//格式化日期类型数据
						}
						isEmpty = false;
					}
				}
			}
			if(!isEmpty){
				griddata.push(data);
			}
		}
	return griddata;
}
//关闭本页并刷新查询页面
function refreshAndClosePage(){   
	window.parent.location.reload();
	closePage();
}
//关闭页面
function closePage(){
	window.parent.dialog.hide();
}
//检查产品名是否重复
function ischeck(){
	$.post(globalUtil.getTimestampUrl('/inve/categoryisCheck.do'),////初始化数据
		{
			"category_name": $("#category_name").val()
		},
		function(jsonForSys) {
			if(jsonForSys=="exist"){
		   	 globalUtil.confirmMsg(globalErrorMsg['900112'],
   	       	    function(yes) { //确认删除
   	       	    	if(yes){
   	       	    		save();	
   	       	    	}
   	       	    });
			}else{
				save();	
			}	
		})
}
function save(){
	if(globalVali.checkForm("dkinfo", true)){
		return;
	}
	var gridLimitVal = getGridData(grid_limit);//产品限制表
	for(var m =0;m<gridLimitVal.length;m++){
			if(m!=0){
				if(gridLimitVal[m].deadline_begin_date === null||gridLimitVal[m].deadline_begin_date ===""){
	   		 		globalUtil.warnMsg(globalErrorMsg['900104']);//起始天数
	   		 		return;
				}	
				//校验是否为整数或者是小数
				if(!globalUtil.isNum(gridLimitVal[m].deadline_begin_date)){
		 			  globalUtil.warnMsg(globalErrorMsg['900113']);//请输入整数
			    	  return;
				 }
			}
			if(m!=gridLimitVal.length-1){
				if(gridLimitVal[m].deadline_end_date === null||gridLimitVal[m].deadline_end_date === ""){
	   		 		globalUtil.warnMsg(globalErrorMsg['900105']);//结束天数
	   		 		return;
				}	
				if(!globalUtil.isNum(gridLimitVal[m].deadline_end_date)){
		 			globalUtil.warnMsg(globalErrorMsg['900114']);//请输入整数
			    	return;
				}
			}
			if(gridLimitVal[m].management_fee ===null||gridLimitVal[m].management_fee ===""){
	  		 		globalUtil.warnMsg(globalErrorMsg['900106']);//管理费
	  		 		return;
			}
			if(gridLimitVal[m].product_interest === null||gridLimitVal[m].product_interest === ""){
	  		 		globalUtil.warnMsg(globalErrorMsg['900107']);//强制年化利率
	  		 		return;
			}
			//校验是否为整数或者是小数
			if(!globalUtil.isFloat(gridLimitVal[m].management_fee)){
		 			globalUtil.warnMsg(globalErrorMsg['900115']);//请输入整数
			    	return;
			}
			if(!globalUtil.isFloat(gridLimitVal[m].product_interest)){
		 			globalUtil.warnMsg(globalErrorMsg['900116']);//请输入整数
			    	return;
			}
		if(m>0){
			if(parseInt(gridLimitVal[m].deadline_begin_date)<=parseInt(gridLimitVal[m-1].deadline_end_date)){
				globalUtil.warnMsg(globalErrorMsg['900124']);//您输入的限制期限有重复
		    	return;
			}
			if(parseInt(gridLimitVal[m].deadline_begin_date)>=parseInt(gridLimitVal[m].deadline_end_date)){
				globalUtil.warnMsg(globalErrorMsg['900125']);//您输入的起始时间大于截止时间
		    	return;
			}
		}
	}
	var param  = globalUtil.getFormParam("dkinfo");
	is_Category_rebate_way(param);//单选框获取值--返利方式
	is_Category_interest_pay_method(param);//单选框获取值--付息方式
	if(param.category_investment_money_max!==""&&param.category_investment_money_min!==""){
		if(parseFloat(param.category_investment_money_max)<parseFloat(param.category_investment_money_min)){
			globalUtil.warnMsg(globalErrorMsg['900121']);//最大上单金额不能小于最小上单金额！
			return;
		}
	}
	if(param.category_additional_monery_max!==""&&param.category_additional_monery_min!==""){
		if(parseFloat(param.category_additional_monery_max)<parseFloat(param.category_additional_monery_min)){
			globalUtil.warnMsg(globalErrorMsg['900122']);//最大追单金额不能小于最小追单金额！
			return;
		}
	}
	if(param.category_additional_monery_max!==""&&param.maximum_holding_amount!==""){
		if(parseFloat(param.maximum_holding_amount)<parseFloat(param.category_additional_monery_max)){
			globalUtil.warnMsg(globalErrorMsg['901123']);//最大追单金额不能大于最大持有金额！
			return;
		}
	}
	if(param.category_investment_money_max!==""&&param.maximum_holding_amount!==""){
		if(parseFloat(param.maximum_holding_amount)<parseFloat(param.category_investment_money_max)){
			globalUtil.warnMsg(globalErrorMsg['901124']);//最大上单金额不能大于最大持有金额！
			return;
		}
	}
	param.category_over_time=$("#category_over_time").val();//产品结束日期(针对产品使用日期最长期限)
	if(param.category_over_time==null||param.category_over_time==""){
		param.category_over_time="9999-01-01";
	}
	param.category_maximum_amount=$("#category_maximum_amount").val();//产品最大金额(针对产品使用最大金额期限)
	if(param.maximum_holding_amount!==""&&param.category_maximum_amount!==""){
		if(parseFloat(param.category_maximum_amount)<parseFloat(param.maximum_holding_amount)){
			globalUtil.warnMsg(globalErrorMsg['901125']);//最大持有金额不能大于产品最大金额！
			return;
		}
	}
	param.category_remak=$("#category_remak").val();//备注
	var gridBasicVal = [];
	if(param.category_interest_pay_method==1){//付息方式:  1 月付  2 年付
		param.basic_monthly_rate=$("#basic_monthly_rate").val();//基础月付利率
		if(param.category_rebate_way==1){//返利方式 1满 月数  2 累计存量
			gridBasicVal= getGridData(grid_basic);//产品利率设置表--累计月份
		}else{
			gridBasicVal = getGridData(grid_basic2);//产品利率设置表--累计存量
		}
		if(param.basic_monthly_rate==null||param.basic_monthly_rate==""){//基础月付利率
			globalUtil.warnMsg(globalErrorMsg['901127']);//请填写基础月利率！
			return;
		}
	}else{
		param.first_year_interest_rate=$("#first_year_interest_rate").val();//第一年付利率
		param.second_year_interest_rate=$("#second_year_interest_rate").val();//第二年付利率
	}
	param.gridBasicVal = JSON.stringify(gridBasicVal);//产品利率设置
	param.gridLimitVal = JSON.stringify(gridLimitVal);//限制表
	if(param.category_type=="-1"||param.category_type==""||param.category_type==null){
		globalUtil.warnMsg(globalErrorMsg['901126']);//请选择产品类型
		return;
	}
	if(param.category_return_rate==""||param.category_return_rate==null){
		globalUtil.warnMsg(globalErrorMsg['901128']);//年收益率(%)
		return;
	}
	
	var platform_users = [];
	$("input[name='platform_user']").each(function() {
		if ($(this).is(':checked')) {
			platform_users.push($(this).val());
		}
	});
	param.platform_user = platform_users.join(",");
	if(ischeck && param.platform_user == ''){
		globalUtil.warnMsg(globalErrorMsg['901140']);//请填写产品发布平台
		return;
	}
	
	//购买产品满多少个月可购买
	param.buy_month_limit=$("#buy_month_limit").val();
	if(!globalUtil.isNum(param.buy_month_limit)){
			globalUtil.warnMsg("购买产品限制月份数必须为整数");//请输入整数
    	return;
	}
	
	//是否提供纸质合同
	param.has_paper_protocol = $('[name=has_paper_protocol]:checked').val();

	$.post(globalUtil.getTimestampUrl("/inve/wmsinvepruductcategorysaveall.do"), param,
   		function(data) {
    	if (data === 'success') {
        	 globalUtil.successMsg(globalErrorMsg['100002'], function(){            		 		
         		refreshAndClosePage();//保存成功
        	 });
         } else if(data === 'exist'){
             globalUtil.warnMsg(globalErrorMsg['900112']); //
         } else{
             globalUtil.errorMsg(globalErrorMsg['100012']); //保存失败
         }
    });
}
//单选框获取值--付息方式
function is_Category_interest_pay_method(jsonStr) {
	$("input[name='category_interest_pay_method']").each(function() {
		if ($(this).is(':checked')) {
			jsonStr.category_interest_pay_method = $(this).val();
			return false;//退出each循环
		}
	});			
}
//单选框获取值--返利方式
function is_Category_rebate_way(jsonStr) {
	$("input[name='category_rebate_way']").each(function() {
		if ($(this).is(':checked')) {
			jsonStr.category_rebate_way = $(this).val();
			return false;//退出each循环
		}
	});			
}
//计算基础月付佣金
function count_rate(obj){//parseFloat() 函数
	if($(obj).val()==null||$(obj).val()==""){
	$("#basic_monthly_rate").val('');
		return;
	}
	var category_return_rate=parseFloat($(obj).val())*10000;
	var basic_monthly_rate= Math.ceil(category_return_rate/12);
	$("#basic_monthly_rate").val(basic_monthly_rate/10000);
}
</script>
</head>
<body>
<div class="pop-center overflow-au">
	<div id="dkinfo" class="pop-formDiv clearfix" style="margin: 5px;">
		<div class="center-txt clearfix"
			style="margin-bottom: 10px; padding: 0px; border: 1px solid #BFBFBF; height: auto;">
			<div class="center-title">
				产品基本信息(<span style="color: red;">*为必填项</span>)
			</div>
			<!-- 添加的虚线 
		          <div class="line clearboth" id="info_l3"></div>-->

			<div class="center-content" style="min-width: 500px;">
				<!--查询条件-->

				<!--  <div class="l-panel-search-cond clearfix" id='main_t' style="padding-top:8px; height:36px;">-->
				<div class="float-l">
					<div class="l-panel-search-title">
						&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: red;">*</span>产品名称:
					</div>
					<div class="l-panel-search-item">
						<input type="text" id="category_name" style="width: 133px"
							isRequired="1" maxlength="15" />
					</div>
				</div>
				<div class="float-l">
					<div class="l-panel-search-title">
						&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;产品编号:
					</div>
					<div class="l-panel-search-item">
						<input type="text" id="category_code" style="width: 133px"
						readonly="readonly"/>
					</div>
				</div>
				<div class="float-l ">
					<div class="l-panel-search-title">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: red;">*</span>产品类型:</div>
					<div class="l-panel-search-item">
						<input type="text"  id="category_type" style="width: 133px; vertical-align: top;" />
					</div>
				</div>
				<div class="float-l clearboth">
					<div class="l-panel-search-title">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;产品期限&nbsp;:</div>
					<div class="l-panel-search-item">
						<input type="text" id="category_deadline" style="width: 108px" isPositiveInteger="1" maxVal="999"
							minVal="0"/>个月
					</div>
				</div>
				<div class="float-l">
					<div class="l-panel-search-title">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;付息方式:</div>
					<div class="l-panel-search-item">
						<input type="radio"
							name="category_interest_pay_method" class="radio5" value="1"
							checked="checked" onclick="clickChange(0)"/><span >月付 </span> <input type="radio"
							name="category_interest_pay_method" class="radio5" value="2" onclick="clickChange(1)"/><span
							>年付</span>
					</div>
					&nbsp;&nbsp;&nbsp;&nbsp;
				</div>
					<div class="float-l">
					<div class="l-panel-search-title">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: red;">*</span>年收益率:</div>
					<div class="l-panel-search-item">
						<input type="text" id="category_return_rate" style="width: 123px" isFloat="1" maxVal="100" minVal="0" scope="a" onchange="count_rate(this)"/>%
					</div>
				</div>
				<div class="float-l clearboth">
					<div class="l-panel-search-title">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;产品封闭期:</div>
					<div class="l-panel-search-item">
						<input type="text" id="category_closure_period" style="width: 108px" isPositiveInteger="1" maxVal="999"
							minVal="0" scope="a"/>个月
					</div>
				</div>
				<div class="float-l">
					<div class="l-panel-search-title"></div>
					<div class="l-panel-search-item">
						<span style="color: red;">说明：封闭期内不允许赎回，如若赎回需特批并扣除服务费</span>
					</div>
				</div>
				<div class="float-l clearboth">
					<div class="l-panel-search-title">&nbsp;&nbsp;最大上单金额:</div>
					<div class="l-panel-search-item">
						<input type="text" id="category_investment_money_max"
							style="width: 108px;" isPositiveInteger="1" maxVal="9999"
							minVal="0" /> 万元
					</div>
				</div>
				<div class="float-l ">
					<div class="l-panel-search-title">最大追单金额:</div>
					<div class="l-panel-search-item">
						<input type="text" id="category_additional_monery_max"
							style="width: 108px;" isPositiveInteger="1" maxVal="9999"
							minVal="0" /> 万元
					</div>
				</div>
				<div class="float-l ">
					<div class="l-panel-search-title">最大持有金额:</div>
					<div class="l-panel-search-item">
						<input type="text" id="maximum_holding_amount"
							style="width: 108px;" isPositiveInteger="1" maxVal="9999"
							minVal="0" /> 万元
					</div>
				</div>
				<div class="float-l clearboth">
					<div class="l-panel-search-title">&nbsp;&nbsp;最小上单金额:</div>
					<div class="l-panel-search-item">
						<input type="text" id="category_investment_money_min"
							style="width: 108px;" isPositiveInteger="1" maxVal="9999"
							minVal="0" /> 万元
					</div>
				</div>
				<div class="float-l ">
					<div class="l-panel-search-title">最小追单金额:</div>
					<div class="l-panel-search-item">
						<input type="text" id="category_additional_monery_min"
							style="width: 108px;" isPositiveInteger="1" maxVal="9999"
							minVal="0" /> 万元
					</div>
				</div>
				<div class="float-l ">
					<div class="l-panel-search-title">产品发布平台:</div>
					<div class="l-panel-search-item">
						<input type="checkbox" id="pto1" name="platform_user" value="PTP" class="radio3"/>PTP
						<input type="checkbox" id="ptco2" name="platform_user" value="WMS"  class="radio3" />WMS
					</div>
				</div>
				
				<div class="float-l clearboth">
					<div class="l-panel-search-title">
						&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: red;">*</span>购买产品满
					</div>
					<div class="l-panel-search-item">
						<input type="text" id="buy_month_limit" style="width: 70px" isRequired="1"/>
						<span style="position:relative;top:-1px;" >个月可购买</span>						
					</div>				  					 
				</div>
			
				<div class="float-l ">
					<div class="l-panel-search-title">是否提供纸质合同:</div>
					<div class="l-panel-search-item">
	
						<input type="radio" name="has_paper_protocol" class="radio5" value="1" checked="checked"/><span >是 </span> 
						<input type="radio" name="has_paper_protocol" class="radio5" value="0"/><span>否</span>
					</div>
				</div>
			</div>
		</div>
	</div>	
	<div class="center-txt clearfix"
		style="margin-bottom: 10px; padding: 0px; border: 1px solid #BFBFBF; height: auto;">
		<div class="center-title clearboth">
			产品利率设置
		</div>
		<div id="yfll">
			&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: red;">*</span>基础月付&nbsp;<input type="text" id="basic_monthly_rate" style="width: 92px;" isFloat="1" maxVal="100" minVal="0" scope="a"/>%
			&nbsp;&nbsp;&nbsp;&nbsp; 返利方式：<input type="radio"
			name="category_rebate_way" class="radio5" value="1"
			checked="checked"  onclick="clickDisplay(0)"/><span >月付利率</span> <input type="radio"
			name="category_rebate_way" class="radio5" value="2" onclick="clickDisplay(1)"/><span
			>累计存量</span>
		</div>
		<div id="centertoolbar1" class="minwidth400"></div>
		<div id="grid_basic"></div>
		<div id="centertoolbar3"style="display:none" class="minwidth400"></div>
		<div id="grid_basic2" style="display:none"></div>
		<div id="nfll" style="display:none">
			<div class="float-l">
				<div class="l-panel-search-title">
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第一年付利率:
				</div>
				<div class="l-panel-search-item">
					<input type="text" id="first_year_interest_rate" style="width: 92px;"
						 isFloat="1" maxVal="100" minVal="0" scope="a" />%
				</div>
			</div>
			<div class="float-l ">
				<div class="l-panel-search-title"></div>
				<div class="l-panel-search-item">
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第二年付利率：<input
						type="text" id="second_year_interest_rate" style="width: 92px;"
						isFloat="1" maxVal="100" minVal="0" scope="a" />%
				</div>
			</div>
		</div>
	</div>
	<div class="center-txt clearfix"
		style="margin-bottom: 10px; padding: 0px; border: 1px solid #BFBFBF; height: auto;">
		<div class="center-title clearboth">
			产品有效期设置
		</div>
		<div class="float-l">
			<div class="l-panel-search-title">
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;产品结束日期:
			</div>
			<div class="l-panel-search-item">
				<input type="text" class="Wdate" id="category_over_time"
							onclick="WdatePicker({dateFmt:'yyyy-MM-dd',isShowClear:true})"
							style="width: 133px; vertical-align: top;" />
			</div>
		</div>
		<div class="float-l ">
			<div class="l-panel-search-title"></div>
			<div class="l-panel-search-item">
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;产品最大金额：<input
					type="text" id="category_maximum_amount" style="width: 133px;"
					isPositiveInteger="1" maxVal="9999"
							minVal="0" />万元
			</div>
		</div>
	</div>
	<div class="center-txt clearfix"
		style="margin-bottom: 10px; padding: 0px; border: 1px solid #BFBFBF; height: auto;">
		<div class="center-title clearboth">
			产品限制信息(<span style="color: red;">*为必填项</span>)
		</div>
		<div class="center-txt" style="border: none;">
			<div id="centertoolbar2" class="minwidth400"></div>
			<div id="grid_limit"></div>
		</div>
	</div>
	<!-- 添加的虚线 -->
	<div class="line clearboth" id="info_l3"></div>
	<div class="float-l clearboth">
		<div class="pop-form-title">备注：</div>
		<div class="pop-form-item">
			<textarea id="category_remak"  rows="20" cols="110"
				style="width: 800px; height: 80px;" maxlength="250" >理财产品到期后10日内办理赎回业务按照年化收益8%计算收益；10日内未办理赎回业务将自动购买原产品，若原产品停售，视为新购买”卓月宝”产品，按照年化收益12%计算收益。</textarea>
		</div>
	</div>
	<div class="float-l clearboth">
		<div class="l-panel-search-title"></div>
		<div class="l-panel-search-item">
		</div>
	</div>
		<div class="float-l clearboth">
		<div class="l-panel-search-title"></div>
		<div class="l-panel-search-item">
		</div>
	</div>
		<div class="float-l clearboth">
		<div class="l-panel-search-title"></div>
		<div class="l-panel-search-item">
		</div>
	</div>
	<!-- 添加的虚线 -->
	<div class="line clearboth" id="info_l3"></div>
</div>
	<!-- 提交功能按钮区 -->
	<div class="pop-footer5 clearboth" style="bottom: 1px;" id="tb_btn">
		<input id="tjbtn" onclick="ischeck();" class="btn-saveT"
			onmouseover="this.className='btn-saveT-over'"
			onmouseout="this.className='btn-saveT'"
			onmousedown="this.className='btn-saveT-down'" type="button"
			style="margin-right: 7px;" /> 
	    <input id="cancelBtnId"
			class="btn-cancel" onmouseover="this.className='btn-cancel-over'"
			onmouseout="this.className='btn-cancel'"
			onmousedown="this.className='btn-cancel-down'" type="button"
			onclick="closePage();" />
	</div>
</body>
</html>
